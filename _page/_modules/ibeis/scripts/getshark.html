

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.scripts.getshark &mdash; ibeis 1.9.0.vulcan documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.9.0.vulcan
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ibeis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
        
      <li>ibeis.scripts.getshark</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.scripts.getshark</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">commonprefix</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;[getshark]&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="sync_wildbook"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.sync_wildbook">[docs]</a><span class="k">def</span> <span class="nf">sync_wildbook</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MAIN ENTRY POINT</span>

<span class="sd">    Syncronizes our ibeis database with a wildbook database like whaleshark.org</span>

<span class="sd">    #cd ~/work/WS_ALL</span>
<span class="sd">    python -m ibeis.scripts.getshark</span>

<span class="sd">    cd /media/raid/raw/WhaleSharks_WB/</span>

<span class="sd">    &gt;&gt;&gt; from ibeis.scripts.getshark import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>

    <span class="c1"># Prepare the output directory for writing, if it doesn&#39;t exist</span>

    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Read ALL data from whaleshark.org</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">parse_whaleshark_org</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;WS_ALL&#39;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_shark&#39;</span>
        <span class="c1"># images_url = &#39;http://www.whaleshark.org/listImages.jsp&#39;</span>
        <span class="c1"># keyword_url = &#39;http://www.whaleshark.org/getKeywordImages.jsp&#39;</span>
        <span class="n">download_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;/media/raid/raw/Wildbook/&#39;</span><span class="p">,</span> <span class="s1">&#39;sharkimages&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Read ALL data from whaleshark.org</span>
        <span class="n">images_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.mantamatcher.org/listImages.jsp&#39;</span>
        <span class="n">keyword_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;Mantas&#39;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;manta_ray&#39;</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_wildbook</span><span class="p">(</span><span class="n">images_url</span><span class="p">,</span> <span class="n">keyword_url</span><span class="p">)</span>
        <span class="n">download_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;/media/raid/raw/Wildbook/&#39;</span><span class="p">,</span> <span class="s1">&#39;mantas&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Read ALL data from whaleshark.org</span>
        <span class="n">images_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.mantamatcher.org/listMatcherImages.jsp&#39;</span>
        <span class="n">keyword_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;MantaMatcher&#39;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;manta_ray&#39;</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_wildbook</span><span class="p">(</span><span class="n">images_url</span><span class="p">,</span> <span class="n">keyword_url</span><span class="p">)</span>
        <span class="n">download_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;/media/raid/raw/Wildbook/&#39;</span><span class="p">,</span> <span class="s1">&#39;MantaMatcher&#39;</span><span class="p">)</span>

    <span class="n">DRY</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">DRY</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_filenames</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_extfilter</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_tags_build</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_tags_filter</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

    <span class="c1"># Download images that we dont have yet</span>
    <span class="n">getshark</span><span class="o">.</span><span class="n">download_missing_images</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;fname_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_fname&#39;</span><span class="p">])</span>

    <span class="c1"># Change variable name to info now that we downloaded</span>
    <span class="n">parsed_dl</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">parsed_dl</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_corrupted</span><span class="p">(</span><span class="n">parsed_dl</span><span class="p">)</span>
    <span class="n">parsed_dl</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_uuids</span><span class="p">(</span><span class="n">parsed_dl</span><span class="p">)</span>

    <span class="c1"># Name change again after time intensive step</span>
    <span class="n">unmerged</span> <span class="o">=</span> <span class="n">parsed_dl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Squash duplicate images</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">postprocess_rectify_duplicates</span><span class="p">(</span><span class="n">unmerged</span><span class="p">)</span>

    <span class="c1"># Check these images against what currently exists in WS_ALL</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">all_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">()</span>

    <span class="n">num_ia_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_images</span><span class="o">.</span><span class="n">uuids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]))</span>

    <span class="c1"># TODO: Check that all the UUIDs in the IA database are indeed ok</span>

    <span class="c1"># Determine which items are in the database</span>
    <span class="n">info_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
    <span class="n">is_hit</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_not_None_items</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)</span>
    <span class="n">is_miss</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)</span>
    <span class="n">hit_info</span>  <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_hit</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="n">miss_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_miss</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The IA database has </span><span class="si">%r</span><span class="s1"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_images</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The IA database has </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> images not from this downloaded set&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">num_ia_unique</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_images</span><span class="p">),))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Have </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> parsed images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hit_info</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> parsed images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">miss_info</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)))</span>

    <span class="c1"># Add new info</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miss_info</span><span class="p">):</span>
            <span class="n">add_new_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">miss_info</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>

    <span class="c1"># REFIND Existing</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Redoing exist check&#39;</span><span class="p">)</span>
    <span class="n">info_gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
    <span class="n">is_hit</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_not_None_items</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)</span>
    <span class="n">is_miss</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)</span>
    <span class="n">hit_info</span>  <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_hit</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="n">miss_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_miss</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The IA database has </span><span class="si">%r</span><span class="s1"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_images</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The IA database has </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> images not from this downloaded set&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">num_ia_unique</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_images</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Have </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> parsed images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hit_info</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> parsed images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">miss_info</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_gid_list</span><span class="p">)))</span>

    <span class="c1"># Sync existing info</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">sync_existing_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">hit_info</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">DRY</span><span class="p">)</span></div>


<div class="viewcode-block" id="sync_existing_images"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.sync_existing_images">[docs]</a><span class="k">def</span> <span class="nf">sync_existing_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">hit_info</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">DRY</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Syncing existing images&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="c1"># Get info for items already in database</span>
    <span class="n">hit_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_gids_from_uuid</span><span class="p">(</span><span class="n">hit_info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
    <span class="n">hit_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">hit_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>

    <span class="c1"># Sync original_uris</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking uris_original&#39;</span><span class="p">)</span>
    <span class="n">ia_prop_list</span> <span class="o">=</span> <span class="n">hit_images</span><span class="o">.</span><span class="n">uris_original</span>
    <span class="n">wb_prop_list</span> <span class="o">=</span> <span class="n">hit_info</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]</span>
    <span class="n">dirty_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ia_prop</span><span class="p">,</span> <span class="n">wb_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ia_prop_list</span><span class="p">,</span> <span class="n">wb_prop_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">ia_prop</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">wb_prop</span><span class="p">):</span>
            <span class="c1"># wb had ambigous values, things are ok if we hit at least one</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">ia_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wb_prop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">ia_prop</span> <span class="o">!=</span> <span class="n">wb_prop</span>
        <span class="n">dirty_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="c1"># Use the wildbook urls as original uris</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...All </span><span class="si">%d</span><span class="s1"> original uris do not need fixing&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">hit_images</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...There are </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> original uris that need fixing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">)))</span>
        <span class="n">dirty_info</span> <span class="o">=</span> <span class="n">hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">)</span>
        <span class="n">dirty_gids</span> <span class="o">=</span> <span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span>
        <span class="n">dirty_wb_props</span> <span class="o">=</span> <span class="n">dirty_info</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...Fixing </span><span class="si">%d</span><span class="s1"> original uris&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">),))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris_original</span><span class="p">(</span><span class="n">dirty_gids</span><span class="p">,</span> <span class="n">dirty_wb_props</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dirty_flags</span><span class="p">)</span><span class="o">.</span><span class="n">uris_original</span><span class="p">))</span>
            <span class="n">dirty_info</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;img_url&#39;</span><span class="p">)</span>

    <span class="c1"># Sync info in annotations</span>
    <span class="n">num_annots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hit_images</span><span class="o">.</span><span class="n">num_annotations</span><span class="p">)</span>

    <span class="n">is_empty</span> <span class="o">=</span> <span class="n">num_annots</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">empty_hit_info</span> <span class="o">=</span> <span class="n">hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_empty</span><span class="p">)</span>
    <span class="n">empty_hit_images</span> <span class="o">=</span> <span class="n">hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_empty</span><span class="p">)</span>

    <span class="n">is_single</span> <span class="o">=</span> <span class="n">num_annots</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">single_hit_info</span> <span class="o">=</span> <span class="n">hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_single</span><span class="p">)</span>
    <span class="n">single_hit_images</span> <span class="o">=</span> <span class="n">hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_single</span><span class="p">)</span>

    <span class="n">is_multi</span> <span class="o">=</span> <span class="n">num_annots</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">multi_hit_info</span> <span class="o">=</span> <span class="n">hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_multi</span><span class="p">)</span>
    <span class="n">multi_hit_images</span> <span class="o">=</span> <span class="n">hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_multi</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Syncing annot info in images. Checking annots/per/image&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * is_empty = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">is_empty</span><span class="o">.</span><span class="n">sum</span><span class="p">(),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * is_single = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">is_single</span><span class="o">.</span><span class="n">sum</span><span class="p">(),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * is_multi = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">is_multi</span><span class="o">.</span><span class="n">sum</span><span class="p">(),))</span>

    <span class="c1"># We exepect an image to be empty if it has junk in the notes</span>
    <span class="n">nonjunk_empty</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;junk&#39;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">empty_hit_images</span><span class="o">.</span><span class="n">notes</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;empty_hit_images = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">empty_hit_images</span><span class="o">.</span><span class="n">gids</span><span class="p">,))</span>
    <span class="n">review_empty</span> <span class="o">=</span> <span class="n">empty_hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nonjunk_empty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;need to review </span><span class="si">%r</span><span class="s1"> empty images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">review_empty</span><span class="p">),))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">review_empty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">empty_hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nonjunk_empty</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please manually review empty images </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">review_empty</span><span class="o">.</span><span class="n">gids</span><span class="p">,))</span>

    <span class="c1"># We expect multi images to be tagged with primary / secondary</span>
    <span class="n">multi_annots</span> <span class="o">=</span> <span class="n">multi_hit_images</span><span class="o">.</span><span class="n">_annot_groups</span>
    <span class="n">nontagged</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">has_any</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s1">&#39;secondary&#39;</span><span class="p">]))</span>
                 <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">multi_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nontagged</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reviewing untagged multi images&#39;</span><span class="p">)</span>
        <span class="n">review_multi</span> <span class="o">=</span> <span class="n">multi_hit_images</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nontagged</span><span class="p">)</span>
        <span class="n">review_annots</span> <span class="o">=</span> <span class="n">review_multi</span><span class="o">.</span><span class="n">_annot_groups</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;review_multi = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">review_multi</span><span class="o">.</span><span class="n">gids</span><span class="p">,))</span>
        <span class="n">multi_hit_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nontagged</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;fname_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fname&#39;</span><span class="p">])</span>
        <span class="c1"># Determine the primary annotation</span>
        <span class="c1"># Check if any are the entire image</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attempting to handle automatically&#39;</span><span class="p">)</span>
        <span class="n">img_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">review_multi</span><span class="o">.</span><span class="n">sizes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bbox_area_rat</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span> <span class="k">for</span> <span class="n">areas</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">review_annots</span><span class="o">.</span><span class="n">bbox_area</span><span class="p">,</span> <span class="n">img_areas</span><span class="p">)]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">areas</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bbox_area_rat</span><span class="p">,</span> <span class="n">review_multi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">areas</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PLEASE CHECK image </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,))</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">,</span> <span class="s1">&#39;need to remove bad annots or change code&#39;</span>
        <span class="c1">#assert False, &#39;Need to finish/review this code. Stopped in development&#39;</span>
        <span class="n">primary_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">areas</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">areas</span> <span class="ow">in</span> <span class="n">bbox_area_rat</span><span class="p">]</span>
        <span class="n">nonprimary_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">areas</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">areas</span> <span class="ow">in</span> <span class="n">bbox_area_rat</span><span class="p">]</span>
        <span class="n">multi_primary_annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">review_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">primary_idxs</span><span class="p">)))</span>
        <span class="n">multi_secondary_annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">review_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">nonprimary_idxs</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
            <span class="n">multi_primary_annots</span><span class="o">.</span><span class="n">append_tags</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
            <span class="n">multi_secondary_annots</span><span class="o">.</span><span class="n">append_tags</span><span class="p">(</span><span class="s1">&#39;secondary&#39;</span><span class="p">)</span>
            <span class="c1"># set tags indicating fg/bg status</span>

    <span class="c1"># Take primary annots from multi-images</span>
    <span class="n">isprimary</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">has_any</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;primary&#39;</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">multi_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">isprimary</span><span class="p">),</span> <span class="s1">&#39;should only be one primary&#39;</span>
    <span class="n">primary_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">multi_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">isprimary</span><span class="p">))</span>

    <span class="c1"># Combine primarys and single_hit into single</span>
    <span class="n">single_annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">single_hit_images</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span> <span class="o">+</span> <span class="n">primary_aids</span><span class="p">)</span>
    <span class="n">single_info</span> <span class="o">=</span> <span class="n">single_hit_info</span> <span class="o">+</span> <span class="n">multi_hit_info</span>

    <span class="c1"># Do annot syncing</span>
    <span class="n">sync_annot_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">single_info</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">DRY</span><span class="p">)</span></div>


<div class="viewcode-block" id="sync_annot_info"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.sync_annot_info">[docs]</a><span class="k">def</span> <span class="nf">sync_annot_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">single_info</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">DRY</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sync `info` from wildbook into `annots` from IA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="c1"># single_info._meta[&#39;ignore&#39;] = [&#39;img_url&#39;, &#39;new_fpath&#39;, &#39;uuid&#39;, &#39;encounter&#39;]</span>
    <span class="n">single_info</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">]</span>

    <span class="c1"># Associate single annots and info using aids (lists should correspond)</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">aids</span>

    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># try and set encounter information</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="s1">&#39;encounter&#39;</span>
        <span class="n">prop2</span> <span class="o">=</span> <span class="s1">&#39;static_encounter&#39;</span>
        <span class="n">repl2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;____&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">check_annot_disagree</span><span class="p">(</span><span class="n">single_info</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">prop2</span><span class="p">,</span> <span class="n">repl2</span><span class="p">,</span>
                             <span class="n">is_set</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">)</span>

    <span class="c1"># Fix sharks marked as healthy and injured</span>
    <span class="n">isbadmark</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">,</span>
                                            <span class="n">any_startswith</span><span class="o">=</span><span class="s1">&#39;injur-&#39;</span><span class="p">,</span> <span class="n">has_all</span><span class="o">=</span><span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
                                            <span class="n">logic</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Marked </span><span class="si">%r</span><span class="s1"> as both healthy and injured&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">isbadmark</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">isbadmark</span><span class="p">):</span>
        <span class="n">bad_fixme</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isbadmark</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
            <span class="n">bad_fixme</span><span class="o">.</span><span class="n">remove_tags</span><span class="p">(</span><span class="s1">&#39;healthy&#39;</span><span class="p">)</span>

    <span class="c1">#cleaned_tags = ut.modify_tags(</span>
    <span class="c1">#    single_info[&#39;tags&#39;],</span>
    <span class="c1">#    regex_map=[</span>
    <span class="c1">#        (&#39;view-.*&#39;, None)</span>
    <span class="c1">#    ],</span>
    <span class="c1">#)</span>

    <span class="c1">#info_injur_tags = parse_injury_categories(single_info[&#39;tags&#39;])</span>
    <span class="c1">#annot_injur_tags = parse_injury_categories(single_annots.case_tags)</span>
    <span class="c1">#print(ut.repr4(ut.dict_hist(ut.flatten(cleaned_tags))))</span>

    <span class="c1">#info_injur_tags = [t if len(t) &gt; 0 else [&#39;healthy&#39;] for t in info_injur_tags]</span>
    <span class="c1">#info_injur_tags = [ut.setdiff(t, [&#39;healthy&#39;]) for t in info_injur_tags]</span>
    <span class="c1">#annot_injur_tags = [ut.setdiff(t, [&#39;healthy&#39;]) for t in annot_injur_tags]</span>
    <span class="c1">#info_injur_tags = [ut.setdiff(t, [&#39;injur-other&#39;]) for t in info_injur_tags]</span>
    <span class="c1">#annot_injur_tags = [ut.setdiff(t, [&#39;injur-other&#39;]) for t in annot_injur_tags]</span>

    <span class="c1"># Remove redundant aliases on IA side</span>
    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">modify_tags</span><span class="p">(</span>
        <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">,</span>
        <span class="n">direct_map</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-nicks&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;scar&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-scar&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-trtruunc&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1">#print(ut.repr4(ut.dict_hist(ut.flatten(cleaned_tags))))</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;orig_case_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;clean_case_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">cleaned_tags</span><span class="p">)</span>

    <span class="n">check_annot_disagree</span><span class="p">(</span><span class="n">single_info</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span>
                         <span class="n">key1</span><span class="o">=</span><span class="s1">&#39;clean_case_tags&#39;</span><span class="p">,</span>
                         <span class="n">prop2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repl2</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">is_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">key2</span><span class="o">=</span><span class="s1">&#39;orig_case_tags&#39;</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">)</span>
    <span class="n">isdirty</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;orig_case_tags&#39;</span><span class="p">],</span> <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;clean_case_tags&#39;</span><span class="p">])]</span>
    <span class="n">dirty_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing redundant info from </span><span class="si">%r</span><span class="s1"> annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">),))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="c1">#dirty_info[&#39;orig_case_tags&#39;]</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">overwrite_annot_case_tags</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;clean_case_tags&#39;</span><span class="p">])</span>

    <span class="c1"># Setup injury tags</span>
    <span class="n">info_injur_tags</span> <span class="o">=</span> <span class="n">get_injured_tags</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
    <span class="c1">#annot_injur_tags = get_injured_tags(single_annots.case_tags)</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;injur_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_injur_tags</span>
    <span class="c1">#single_info[&#39;annot_tags&#39;] = annot_injur_tags</span>
    <span class="c1">## Fix injury tags</span>
    <span class="c1">#key1 = &#39;injur_tags&#39;</span>
    <span class="c1">#prop2 = None</span>
    <span class="c1">#key2 = &#39;annot_tags&#39;</span>
    <span class="c1">#repl2 = (None, [])</span>
    <span class="c1">#is_set = True</span>
    <span class="c1">#check_annot_disagree(single_info, single_annots, key1, None, repl2, is_set,</span>
    <span class="c1">#                     key2=key2, DRY=DRY)</span>
    <span class="c1"># We should just be able to do a union on the two sets.</span>
    <span class="n">isdirty</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;injur_tags&#39;</span><span class="p">],</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)]</span>
    <span class="n">new_injurtags</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;injur_tags&#39;</span><span class="p">],</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)]</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_injurtags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_injurtags</span>
    <span class="n">dirty_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new injur tags&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">new_injurtags</span><span class="p">))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unioning new injur tags into </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">isdirty</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">append_annot_case_tags</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;new_injurtags&#39;</span><span class="p">])</span>

    <span class="c1"># Append all other keywords as well</span>
    <span class="n">cleaned_keywords</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">modify_tags</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">],</span> <span class="n">direct_map</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cleaned_keywords</span><span class="p">,</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">isdirty</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_keywords&#39;</span><span class="p">]]</span>
    <span class="n">dirty_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new_keywords&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_keywords&#39;</span><span class="p">]))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unioning new_keywords into </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">append_annot_case_tags</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;new_keywords&#39;</span><span class="p">])</span>

    <span class="c1"># Check if any other tags need appending</span>
    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">modify_tags</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="n">direct_map</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">,</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">isdirty</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_tags&#39;</span><span class="p">]]</span>
    <span class="n">dirty_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isdirty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new_tags&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;new_tags&#39;</span><span class="p">]))))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unioning new_tags into </span><span class="si">%r</span><span class="s1"> annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">),))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">append_annot_case_tags</span><span class="p">(</span><span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">dirty_info</span><span class="p">[</span><span class="s1">&#39;new_tags&#39;</span><span class="p">])</span>

    <span class="c1"># Setup viewpoint</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;view-left&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;view-right&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;view-back&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;viewpoint_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_info</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">yaw_text</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="n">tag_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="n">has_any</span><span class="o">=</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
        <span class="c1"># setup yaw info</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tag_flags</span><span class="p">):</span>
            <span class="n">single_info</span><span class="p">[</span><span class="s1">&#39;viewpoint_code&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">yaw_text</span>
    <span class="c1"># Fix Viewpoint</span>
    <span class="n">key1</span> <span class="o">=</span> <span class="s1">&#39;viewpoint_code&#39;</span>
    <span class="n">prop2</span> <span class="o">=</span> <span class="s1">&#39;viewpoint_code&#39;</span>
    <span class="n">repl2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;____&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">check_annot_disagree</span><span class="p">(</span><span class="n">single_info</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">prop2</span><span class="p">,</span> <span class="n">repl2</span><span class="p">,</span>
                         <span class="n">is_set</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">)</span>

    <span class="c1"># Fix Names</span>
    <span class="n">key1</span> <span class="o">=</span> <span class="s1">&#39;nameid&#39;</span>
    <span class="n">prop2</span> <span class="o">=</span> <span class="s1">&#39;names&#39;</span>
    <span class="n">repl2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;____&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">is_set</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">check_annot_disagree</span><span class="p">(</span><span class="n">single_info</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">prop2</span><span class="p">,</span> <span class="n">repl2</span><span class="p">,</span>
                         <span class="n">is_set</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="n">DRY</span><span class="p">)</span>

    <span class="c1"># Fix Species</span>
    <span class="n">bad_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;____&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">species</span><span class="p">]</span>
    <span class="n">_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bad_flags</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> annots need fixed species&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">bad_flags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_annots</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="n">_annots</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_annots</span><span class="p">)</span>

    <span class="c1"># Move injured/healthy/untagged to appropriate sets</span>
    <span class="n">injur_tags</span> <span class="o">=</span> <span class="n">get_injured_tags</span><span class="p">(</span><span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">,</span> <span class="n">include_healthy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">untagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">injur_tags</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">untagged_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">untagged</span><span class="p">)</span>
    <span class="n">untagged_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">untagged</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> annots have no tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">untagged_annots</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_annots</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags from WB imgnames:&#39;</span> <span class="o">+</span>
          <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">untagged_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))))</span>
    <span class="n">untagged_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">untagged_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>
    <span class="c1"># Add healthy tag to anything without an injured tag</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding healthy tag to sharked not taged as injured&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">append_annot_case_tags</span><span class="p">(</span><span class="n">untagged_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">untagged_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="n">untagged_images</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="s1">&#39;Untagged&#39;</span><span class="p">)</span>

    <span class="n">categories</span> <span class="o">=</span> <span class="n">get_injur_categories</span><span class="p">(</span><span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">)</span>
    <span class="n">healthy_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span>
                                                <span class="n">any_startswith</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;injur-&#39;</span><span class="p">))</span>
    <span class="n">injured_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span><span class="p">,</span>
                                                <span class="n">has_any</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">])</span>
    <span class="n">num_have</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">xor_lists</span><span class="p">(</span><span class="n">healthy_flags</span><span class="p">,</span> <span class="n">injured_flags</span><span class="p">))</span>
    <span class="n">num_miss</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_annots</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_have</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;missing </span><span class="si">%d</span><span class="s1"> annots&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_miss</span><span class="p">,))</span>

    <span class="n">injured_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">healthy_flags</span><span class="p">)</span>
    <span class="n">injured_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">injured_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">))</span>
    <span class="n">healthy_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">injured_flags</span><span class="p">)</span>
    <span class="n">healthy_images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">healthy_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="n">injured_images</span><span class="o">.</span><span class="n">remove_from_imageset</span><span class="p">(</span><span class="s1">&#39;Probably Healthy&#39;</span><span class="p">)</span>
        <span class="n">healthy_images</span><span class="o">.</span><span class="n">remove_from_imageset</span><span class="p">(</span><span class="s1">&#39;Probably Injured&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">injured_images</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="s1">&#39;Probably Injured&#39;</span><span class="p">)</span>
        <span class="n">healthy_images</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="s1">&#39;Probably Healthy&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_annot_disagree"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.check_annot_disagree">[docs]</a><span class="k">def</span> <span class="nf">check_annot_disagree</span><span class="p">(</span><span class="n">single_info</span><span class="p">,</span> <span class="n">single_annots</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">prop2</span><span class="p">,</span> <span class="n">repl2</span><span class="p">,</span>
                         <span class="n">is_set</span><span class="p">,</span> <span class="n">key2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DRY</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">info_prop</span> <span class="o">=</span> <span class="n">single_info</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">key2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key2</span> <span class="o">=</span> <span class="s1">&#39;annot_&#39;</span> <span class="o">+</span> <span class="n">prop2</span>
        <span class="n">annot_prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">single_annots</span><span class="p">,</span> <span class="n">prop2</span><span class="p">)</span>
        <span class="n">annot_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">repl2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">repl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">annot_prop</span><span class="p">]</span>
        <span class="n">single_info</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">annot_prop</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">annot_prop</span> <span class="o">=</span> <span class="n">single_info</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span>
    <span class="n">out_of_sync</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">isnull</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">isnull</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">ia_empty</span> <span class="o">=</span> <span class="p">[</span><span class="n">isnull</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">)]</span>
    <span class="n">wb_empty</span> <span class="o">=</span> <span class="p">[</span><span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnull</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">)]</span>
    <span class="n">disagree</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnull</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="c1"># Like empty, but ia is a pure subset of wb</span>
        <span class="n">ia_is_subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">,</span> <span class="n">disagree</span><span class="p">)]</span>
        <span class="n">wb_is_subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">,</span> <span class="n">disagree</span><span class="p">)]</span>
        <span class="c1"># There may not be a subset, but there is overlap?</span>
        <span class="n">some_isect</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">isect</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span>
                      <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">,</span> <span class="n">disagree</span><span class="p">)]</span>
        <span class="n">some_isect</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">some_isect</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ia_is_subset</span><span class="p">))</span>
        <span class="n">some_isect</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">some_isect</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">wb_is_subset</span><span class="p">))</span>
        <span class="c1"># Absolutely no overlap</span>
        <span class="n">total_disagree</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">isect</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span>
                          <span class="nb">zip</span><span class="p">(</span><span class="n">info_prop</span><span class="p">,</span> <span class="n">annot_prop</span><span class="p">,</span> <span class="n">disagree</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- RECTIFY prop=</span><span class="si">%r</span><span class="s1"> --- &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key1</span><span class="p">,))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prop=</span><span class="si">%r</span><span class="s1"> has </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> out of sync items&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">out_of_sync</span><span class="p">),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">out_of_sync</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WB has populated info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ia_empty</span><span class="p">),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="n">ia_empty</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA has populated info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">wb_empty</span><span class="p">),</span>
                                                  <span class="nb">len</span><span class="p">(</span><span class="n">wb_empty</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA and WB disagree on info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">disagree</span><span class="p">),</span>
                                                       <span class="nb">len</span><span class="p">(</span><span class="n">disagree</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA is subset of WB info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">ia_is_subset</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ia_is_subset</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WB is subset of IA info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">wb_is_subset</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wb_is_subset</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WB and IA partial overlap info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">some_isect</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_isect</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA and WB total disagree on info for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">total_disagree</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_disagree</span><span class="p">),</span> <span class="n">key1</span><span class="p">))</span>

    <span class="n">sub_info</span> <span class="o">=</span> <span class="n">single_info</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span><span class="p">)</span>
    <span class="n">sub_info</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- DISAGREE DETAILS ---&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA POPULATED (updates on IA side?)&#39;</span><span class="p">)</span>
    <span class="c1"># Do nothing about these</span>
    <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">wb_empty</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WB POPULATED: (can give)&#39;</span><span class="p">)</span>
    <span class="c1"># Pull info from wildbook</span>
    <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ia_empty</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IA \subset WB (can give)&#39;</span><span class="p">)</span>
        <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ia_is_subset</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WB \subset IA (updates on IA side?)&#39;</span><span class="p">)</span>
        <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">wb_is_subset</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOME OVERLAP&#39;</span><span class="p">)</span>
        <span class="c1"># Have to manually fix</span>
        <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">some_isect</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TOTAL DISAGREE&#39;</span><span class="p">)</span>
        <span class="c1"># Have to manually fix</span>
        <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">total_disagree</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DISAGREE&#39;</span><span class="p">)</span>
        <span class="c1"># Have to manually fix</span>
        <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">disagree</span><span class="p">)</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="c1"># Get which annots need modification.</span>
    <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">or_lists</span><span class="p">(</span><span class="n">ia_empty</span><span class="p">,</span> <span class="n">ia_is_subset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We can move populated info from wildbook into empty ibeis info</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ia_empty</span>

    <span class="n">new_info</span> <span class="o">=</span> <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="n">old_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_set</span><span class="p">:</span>
        <span class="c1"># Ensure that there is no ambiguity</span>
        <span class="n">isambiguous</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_info</span><span class="p">[</span><span class="n">key1</span><span class="p">]]</span>
        <span class="n">notok</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">isambiguous</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">notok</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> ambiguous properties from wildbook&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notok</span><span class="p">,))</span>
        <span class="n">new_info</span> <span class="o">=</span> <span class="n">new_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isambiguous</span><span class="p">)</span>
        <span class="n">old_annots</span> <span class="o">=</span> <span class="n">old_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isambiguous</span><span class="p">)</span>
        <span class="n">new_info</span> <span class="o">=</span> <span class="n">sub_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">old_annots</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="n">new_prop</span> <span class="o">=</span> <span class="n">new_info</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_set</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_prop</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new prop hist&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">new_prop</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">is_set</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">new_prop</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new prop hist&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">tag_hist</span><span class="p">(</span><span class="n">new_prop</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">DRY</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MODIFYING PROPERTEIS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_annots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_set</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">prop2</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">key1</span> <span class="o">==</span> <span class="s1">&#39;injur_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;hack is invalid. got=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
                <span class="n">old_annots</span><span class="o">.</span><span class="n">append_tags</span><span class="p">(</span><span class="n">new_prop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">old_annots</span><span class="p">,</span> <span class="n">prop2</span><span class="p">,</span> <span class="n">new_prop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dryrun&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_injured_tags"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.get_injured_tags">[docs]</a><span class="k">def</span> <span class="nf">get_injured_tags</span><span class="p">(</span><span class="n">tags_list</span><span class="p">,</span> <span class="n">include_healthy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tags_list = single_info[&#39;tags&#39;]</span>
<span class="sd">    tags_list = single_annots.case_tags</span>
<span class="sd">    info_injur_tags = parse_injury_categories()</span>
<span class="sd">    annot_injur_tags = parse_injury_categories(single_annots.case_tags)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">injur_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;injur-.*&#39;</span><span class="p">,</span> <span class="s1">&#39;trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;bite&#39;</span><span class="p">,</span> <span class="s1">&#39;scar&#39;</span><span class="p">,</span> <span class="s1">&#39;.*damage.*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*scar&#39;</span><span class="p">,</span>
        <span class="s1">&#39;.*bite&#39;</span><span class="p">,</span> <span class="s1">&#39;other_injury&#39;</span><span class="p">,</span> <span class="s1">&#39;injured&#39;</span><span class="p">,</span> <span class="s1">&#39;injur&#39;</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">include_healthy</span><span class="p">:</span>
        <span class="n">injur_patterns</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span>
    <span class="n">flags_list</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">any</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">injur_patterns</span><span class="p">])</span>
                   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span> <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">tags_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="n">only_injur_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">tags_list</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">only_injur_tags</span></div>


<div class="viewcode-block" id="get_injur_categories"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.get_injur_categories">[docs]</a><span class="k">def</span> <span class="nf">get_injur_categories</span><span class="p">(</span><span class="n">single_annots</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#if verbose:</span>
    <span class="c1">#    print(&#39;Original tags&#39;)</span>
    <span class="c1">#    print(ut.repr3(ut.tag_hist(injur_tags)))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">single_annots</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">case_tags</span> <span class="o">=</span> <span class="n">single_annots</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">single_annots</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">case_tags</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">case_tags</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="n">single_annots</span><span class="o">.</span><span class="n">aids</span>

    <span class="n">injur_tags</span> <span class="o">=</span> <span class="n">get_injured_tags</span><span class="p">(</span><span class="n">case_tags</span><span class="p">,</span> <span class="n">include_healthy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cleaned_tags</span><span class="p">,</span> <span class="n">alias_map</span><span class="p">,</span> <span class="n">unmapped</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">modify_tags</span><span class="p">(</span>
        <span class="n">injur_tags</span><span class="p">,</span>
        <span class="n">regex_map</span><span class="o">=</span><span class="p">[</span>
            <span class="c1"># Invalid patterns</span>
            <span class="p">(</span><span class="s1">&#39;^.*&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>

            <span class="c1"># Truncation</span>
            <span class="p">(</span><span class="s1">&#39;injur-trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>

            <span class="c1"># Gill damage</span>
            <span class="p">(</span><span class="s1">&#39;.*gilldamage.*&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-gill&#39;</span><span class="p">),</span>

            <span class="c1"># Other</span>
            <span class="p">(</span><span class="s1">&#39;injur-unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-dead&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;other_injury&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-damage&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injured&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;^injur$&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>

            <span class="c1"># Nicks</span>
            <span class="p">(</span><span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-nicks&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-nicks-.*&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-nicks&#39;</span><span class="p">),</span>

            <span class="p">(</span><span class="s1">&#39;.*bite&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-bite&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;.*scar&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-scar&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">direct_map</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;injur-trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-scar&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-scar&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-other&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-nicks&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;injur-bite&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-bite&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;healthy&#39;</span><span class="p">,</span> <span class="s1">&#39;healthy&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">return_unmapped</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">delete_unmapped</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmapped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fixme </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unmapped</span><span class="p">,)</span>
    <span class="c1"># Remove injur-other if other known injuries are present</span>
    <span class="k">def</span> <span class="nf">fixinjur</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
        <span class="n">injured</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;injur-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">injured</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;healthy&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shark aid=</span><span class="si">%r</span><span class="s1"> labeled as injured and healty </span><span class="si">%r</span><span class="s1">!!!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">tags</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;injur-other&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">injured</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;injur-other&#39;</span><span class="p">]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;injur-gill&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">injured</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;injur-gill&#39;</span><span class="p">]</span>
        <span class="c1">#if len(tags) == 1:</span>
        <span class="c1">#    tags = ut.setdiff(tags, [&#39;healthy&#39;])</span>
        <span class="k">return</span> <span class="n">tags</span>
    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">fixinjur</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">cleaned_tags</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mapping: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">alias_map</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                                    <span class="n">alias_map</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unmapped = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">unmapped</span><span class="p">),))</span>

        <span class="n">given_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">injur_tags</span><span class="p">))</span>
        <span class="n">alias_map_used</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">given_tags</span><span class="p">:</span>
                <span class="n">alias_map_used</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;used_mapping: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">alias_map_used</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                                         <span class="n">alias_map_used</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaned tags&#39;</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">tag_hist</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>

        <span class="c1"># Get tag co-occurrence</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Co-Occurrence Freq&#39;</span><span class="p">)</span>
        <span class="n">co_occur</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">tag_coocurrence</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">co_occur</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Co-Occurrence Percent&#39;</span><span class="p">)</span>
        <span class="n">co_occur_percent</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([(</span><span class="n">keys</span><span class="p">,</span>  <span class="p">[</span><span class="mi">100</span> <span class="o">*</span> <span class="n">val</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span> <span class="k">for</span>
                                     <span class="n">keys</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">co_occur</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">co_occur_percent</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1">#other_annots = single_annots.compress(ut.filterflags_general_tags(cleaned_tags, has_any=[&#39;injur-other&#39;]))</span>
    <span class="c1">#print(&#39;other_annots.case_tags = %s&#39; % (ut.repr4(list(zip(other_annots.gids, other_annots.aids, other_annots.case_tags)), nl=1),))</span>

    <span class="k">return</span> <span class="n">cleaned_tags</span></div>


<div class="viewcode-block" id="add_new_images"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.add_new_images">[docs]</a><span class="k">def</span> <span class="nf">add_new_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">miss_info</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">isambiguous</span> <span class="o">=</span> <span class="n">miss_info</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">isambiguous</span><span class="p">),</span> <span class="s1">&#39;Cannot add ambiguous filenames&#39;</span>

    <span class="c1"># Add images to IA to get a gid</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">])</span>
    <span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gid_list</span>

    <span class="c1"># Check to see if adding any images failed</span>
    <span class="n">failed_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# failed to add </span><span class="si">%s</span><span class="s1"> images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">failed_flags</span><span class="p">)),)</span>

    <span class="n">passed_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">failed_flags</span><span class="p">)</span>
    <span class="n">miss_info</span> <span class="o">=</span> <span class="n">miss_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">passed_flags</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">assert_all_not_None</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="c1">#ibs.get_image_uris_original(clist[&#39;gid&#39;])</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">find_duplicate_items</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
        <span class="s1">&#39;duplicates should have already been sorted out&#39;</span><span class="p">)</span>

    <span class="c1"># Just choose one of the urls if any are ambiguous</span>
    <span class="n">orig_urls</span> <span class="o">=</span> <span class="n">miss_info</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris_original</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">],</span> <span class="n">orig_urls</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Add new images to temporary imagesets&#39;</span><span class="p">)</span>
    <span class="n">images_new</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="n">new_imgsettext</span> <span class="o">=</span> <span class="s1">&#39;New Images &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>
    <span class="n">images_new</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="n">new_imgsettext</span><span class="p">)</span>
    <span class="n">injured_keywords</span> <span class="o">=</span> <span class="n">get_injured_tags</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
    <span class="n">hasinjur_kw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">injured_keywords</span><span class="p">)</span>
    <span class="n">images_new</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">hasinjur_kw</span><span class="p">)</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="n">new_imgsettext</span> <span class="o">+</span> <span class="s1">&#39; Injur&#39;</span><span class="p">)</span>
    <span class="n">images_new</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">hasinjur_kw</span><span class="p">))</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="n">new_imgsettext</span> <span class="o">+</span> <span class="s1">&#39; Healthy&#39;</span><span class="p">)</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">other_keywords</span> <span class="o">=</span> <span class="n">get_injured_tags</span><span class="p">(</span><span class="n">miss_info</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added </span><span class="si">%r</span><span class="s1"> new images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">miss_info</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had injured tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">hasinjur_kw</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had other tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">other_keywords</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had no injured tags&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">miss_info</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">injured_keywords</span><span class="p">))))</span>
        <span class="c1">#injured_keyhist = ut.dict_hist(ut.flatten(injured_keywords), ordered=True)</span>
        <span class="c1">#other_keyhist = ut.dict_hist(ut.flatten(other_keywords), ordered=True)</span>
        <span class="c1">#print(&#39;&#39;)</span>
        <span class="c1">#print(&#39;Injured Keyword histogram:\n&#39; + &#39;, &#39;.join(</span>
        <span class="c1">#    [&#39;*%s*: %s&#39; % (k, v) for k, v in injured_keyhist.items()][::-1]))</span>
        <span class="c1">#print(&#39;&#39;)</span>
        <span class="c1">#print(&#39;Other Keyword histogram:\n&#39; + &#39;, &#39;.join(</span>
        <span class="c1">#    [&#39;*%s*: %s&#39; % (k, v) for k, v in other_keyhist.items()][::-1]))</span>

    <span class="n">is_empty_annots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images_new</span><span class="o">.</span><span class="n">num_annotations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Add anotations to images</span>
    <span class="n">empty_new_info</span> <span class="o">=</span> <span class="n">miss_info</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_empty_annots</span><span class="p">)</span>
    <span class="n">empty_new_images</span> <span class="o">=</span> <span class="n">images_new</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">is_empty_annots</span><span class="p">)</span>

    <span class="c1"># DETECT ANNOTATIONS ON NEW IMAGES</span>
    <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;WS_ALL&#39;</span><span class="p">:</span>
        <span class="c1"># In the best case we have a detector</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;algo&#39;</span>            <span class="p">:</span> <span class="s1">&#39;yolo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sensitivity&#39;</span>     <span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s1">&#39;config_filepath&#39;</span> <span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.cfg&#39;</span><span class="p">),</span>
            <span class="s1">&#39;weight_filepath&#39;</span> <span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.39000.weights&#39;</span><span class="p">),</span>
            <span class="s1">&#39;class_filepath&#39;</span>  <span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.cfg.classes&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">depc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_image</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">empty_new_images</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">compress</span><span class="p">([</span><span class="n">ext_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.gif&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext_</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">exts</span><span class="p">])</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">gids</span>

        <span class="c1"># result is a tuple: (score, bbox_list, theta_list, conf_list, class_list)</span>
        <span class="n">results_list</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;localizations&#39;</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># NOQA</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished running localizations&#39;</span><span class="p">)</span>

        <span class="n">results_list2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">multi_gids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failed_gids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">results_list</span><span class="p">):</span>
            <span class="n">score</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">,</span> <span class="n">class_list</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">failed_gids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">results_list2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gid</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Take only a single annotation per bounding box.</span>
                <span class="n">multi_gids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">conf_list</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">theta_list</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">results_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> have localizations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results_list2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> are missing localizations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> had multiple localizations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multi_gids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">)))</span>

        <span class="c1"># Add these to an imageset for fixing</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">failed_gids</span><span class="p">)</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="s1">&#39;NoLocs&#39;</span> <span class="o">+</span> <span class="n">new_imgsettext</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">multi_gids</span><span class="p">)</span><span class="o">.</span><span class="n">append_to_imageset</span><span class="p">(</span><span class="s1">&#39;MultiLocs&#39;</span> <span class="o">+</span> <span class="n">new_imgsettext</span><span class="p">)</span>

        <span class="c1"># Reorder empty_info to be aligned with results</span>
        <span class="n">localized_imgs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">empty_new_info_</span> <span class="o">=</span> <span class="n">empty_new_info</span><span class="o">.</span><span class="n">loc_by_key</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="n">localized_imgs</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">localized_imgs</span><span class="o">.</span><span class="n">aids</span><span class="p">]),</span> <span class="s1">&#39;no annots should be made yet&#39;</span>

        <span class="c1"># Override old bboxes</span>
        <span class="n">annot_gids</span> <span class="o">=</span> <span class="n">localized_imgs</span><span class="o">.</span><span class="n">gids</span>
        <span class="n">annot_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">annot_thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Fix any ambiguities for name</span>
        <span class="n">annot_names</span> <span class="o">=</span> <span class="n">empty_new_info_</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="s1">&#39;nameid&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">annot_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">annot_names</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
        <span class="c1">#annot_names = empty_new_info_[&#39;nameid&#39;]</span>
        <span class="n">annot_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">localized_imgs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make a single annotation for each image in the worst case</span>
        <span class="n">annot_gids</span> <span class="o">=</span> <span class="n">empty_new_images</span><span class="o">.</span><span class="n">gids</span>
        <span class="n">annot_bboxes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">empty_new_images</span><span class="o">.</span><span class="n">sizes</span><span class="p">]</span>
        <span class="n">annot_thetas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gids</span><span class="p">)</span>
        <span class="n">annot_names</span> <span class="o">=</span> <span class="n">empty_new_info</span><span class="o">.</span><span class="n">loc_by_key</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="n">annot_gids</span><span class="p">)[</span><span class="s1">&#39;nameid&#39;</span><span class="p">]</span>
        <span class="n">annot_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">annot_names</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
        <span class="n">annot_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot_gids</span><span class="p">)</span>

    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_annots</span><span class="p">(</span><span class="n">annot_gids</span><span class="p">,</span> <span class="n">bbox_list</span><span class="o">=</span><span class="n">annot_bboxes</span><span class="p">,</span>
                              <span class="n">theta_list</span><span class="o">=</span><span class="n">annot_thetas</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="n">annot_names</span><span class="p">,</span>
                              <span class="n">species_list</span><span class="o">=</span><span class="n">annot_species</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished adding new info&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_needs_redownload</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">seconds_thresh</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_file_info</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">parse_timestamp</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;last_modified&#39;</span><span class="p">],</span> <span class="n">zone</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">ut</span><span class="o">.</span><span class="n">utcnow_tz</span><span class="p">()</span>
        <span class="n">redownload</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">seconds_thresh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redownload</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">redownload</span>


<div class="viewcode-block" id="parse_whaleshark_org"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_whaleshark_org">[docs]</a><span class="k">def</span> <span class="nf">parse_whaleshark_org</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read list of all images from wildbook</span>

<span class="sd">    Combines old and new</span>

<span class="sd">    &gt;&gt;&gt; from ibeis.scripts.getshark import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>

    <span class="n">parsed1</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">parse_whaleshark_org_old</span><span class="p">()</span>
    <span class="c1"># Also parse using the keyword method</span>
    <span class="n">parsed2</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">parse_whaleshark_org_keywords</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> urls from XML jsp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> urls from keywords&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed2</span><span class="p">),))</span>

    <span class="c1"># Apply keywords to existing images</span>
    <span class="c1">#raise NotImplementedError(&#39;suffix is now unreliable for comparing encounters&#39;)</span>

    <span class="c1"># Use suffix as a key to create a merger mapping between indices</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merging keyword and XML jsp results&#39;</span><span class="p">)</span>
    <span class="n">suffix_to_idx1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">])</span>
    <span class="n">suffix_to_idx2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">])</span>
    <span class="n">idx1_to_idx2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">suffix_to_idx2</span><span class="p">,</span> <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">idx2_to_idx1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">suffix_to_idx1</span><span class="p">,</span> <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Find the items that are unique to each set</span>
    <span class="n">unmatched_idx1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">idx1_to_idx2</span><span class="p">))</span>
    <span class="n">unmatched_idx2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">idx2_to_idx1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> unique entries in the XML results&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unmatched_idx1</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> unique entries in the jsp results&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unmatched_idx2</span><span class="p">),))</span>

    <span class="c1">#nonmatching1 = parsed1.take(unmatched_idx1)</span>
    <span class="c1">#nonmatching2 = parsed2.take(unmatched_idx2)</span>

    <span class="c1"># Find the items that are common between both sets</span>
    <span class="n">match_idx1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">idx2_to_idx1</span><span class="p">)</span>
    <span class="n">match_idx2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">idx1_to_idx2</span><span class="p">)</span>

    <span class="c1">#matching1 = parsed1.take(match_idx1)</span>
    <span class="c1">#matching2 = parsed2.take(match_idx2)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_idx1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_idx2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> items in common&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match_idx1</span><span class="p">),))</span>

    <span class="c1"># Make columns agree between parsed1 and parsed2</span>
    <span class="k">del</span> <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;localid&#39;</span><span class="p">]</span>
    <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">)</span>
    <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">))]</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">parsed2</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">parsed1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">parsed1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">parsed2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed2</span> <span class="o">+</span> <span class="n">parsed1</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">merge_rows</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="n">merge_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span><span class="p">]</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="c1">#nonmatching1[&#39;nameid&#39;] = [None] * len(nonmatching1)</span>
    <span class="c1">#nonmatching1[&#39;localid&#39;] = [None] * len(nonmatching1)</span>
    <span class="c1"># Merge keywords from matching parts in parsed2 into parsed1</span>
    <span class="c1">#parsed1[&#39;keywords&#39;] = [[] for _ in range(len(parsed1))]</span>
    <span class="c1">#for idx1, keys in zip(match_idx1, matching2[&#39;keywords&#39;]):</span>
    <span class="c1">#    parsed1[&#39;keywords&#39;][idx1].extend(keys)</span>

    <span class="c1">#parsed = parsed2 + nonmatching1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> total urls&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="parse_whaleshark_org_old"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_whaleshark_org_old">[docs]</a><span class="k">def</span> <span class="nf">parse_whaleshark_org_old</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;www.whaleshark.org/listImages.jsp&#39;</span>
    <span class="n">parsed1</span> <span class="o">=</span> <span class="n">parse_wildbook_images</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed1</span></div>


<div class="viewcode-block" id="parse_wildbook"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_wildbook">[docs]</a><span class="k">def</span> <span class="nf">parse_wildbook</span><span class="p">(</span><span class="n">images_url</span><span class="p">,</span> <span class="n">keyword_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read list of all images from wildbook</span>

<span class="sd">    Combines old and new</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.scripts.getshark import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; url = images_url = &#39;http://www.mantamatcher.org/listImages.jsp&#39;</span>

<span class="sd">    Example</span>
<span class="sd">        &gt;&gt;&gt; images_url = &#39;http://www.whaleshark.org/listImages.jsp&#39;</span>
<span class="sd">        &gt;&gt;&gt; keyword_url = &#39;http://www.whaleshark.org/getKeywordImages.jsp&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>

    <span class="n">parsed1</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">parse_wildbook_images</span><span class="p">(</span><span class="n">images_url</span><span class="p">)</span>
    <span class="c1"># Also parse using the keyword method</span>
    <span class="c1"># parsed2 = getshark.parse_wildbook_keywords(keyword_url)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> urls from XML jsp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">),))</span>
    <span class="c1"># if keyword_url:</span>
    <span class="c1">#     print(&#39;Parsed %d urls from keywords&#39; % (len(parsed2),))</span>

    <span class="c1"># Apply keywords to existing images</span>
    <span class="c1">#raise NotImplementedError(&#39;suffix is now unreliable for comparing encounters&#39;)</span>

    <span class="c1"># Use suffix as a key to create a merger mapping between indices</span>
    <span class="c1"># print(&#39;Merging keyword and XML jsp results&#39;)</span>
    <span class="c1"># suffix_to_idx1 = ut.make_index_lookup(parsed1[&#39;suffix&#39;])</span>
    <span class="c1"># suffix_to_idx2 = ut.make_index_lookup(parsed2[&#39;suffix&#39;])</span>
    <span class="c1"># idx1_to_idx2 = ut.dict_take(suffix_to_idx2, parsed1[&#39;suffix&#39;], None)</span>
    <span class="c1"># idx2_to_idx1 = ut.dict_take(suffix_to_idx1, parsed2[&#39;suffix&#39;], None)</span>

    <span class="c1"># Find the items that are unique to each set</span>
    <span class="c1"># unmatched_idx1 = ut.where(ut.not_list(idx1_to_idx2))</span>
    <span class="c1"># unmatched_idx2 = ut.where(ut.not_list(idx2_to_idx1))</span>
    <span class="c1"># print(&#39;There are %d unique entries in the XML results&#39; % (len(unmatched_idx1),))</span>
    <span class="c1"># print(&#39;There are %d unique entries in the jsp results&#39; % (len(unmatched_idx2),))</span>

    <span class="c1">#nonmatching1 = parsed1.take(unmatched_idx1)</span>
    <span class="c1">#nonmatching2 = parsed2.take(unmatched_idx2)</span>

    <span class="c1"># Find the items that are common between both sets</span>
    <span class="c1"># match_idx1 = ut.filter_Nones(idx2_to_idx1)</span>
    <span class="c1"># match_idx2 = ut.filter_Nones(idx1_to_idx2)</span>

    <span class="c1"># assert len(match_idx1) == len(match_idx2)</span>
    <span class="c1"># print(&#39;There are %d items in common&#39; % (len(match_idx1),))</span>

    <span class="c1"># Make columns agree between parsed1 and parsed2</span>
    <span class="k">del</span> <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;localid&#39;</span><span class="p">]</span>
    <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">)</span>
    <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed1</span><span class="p">))]</span>

    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed1</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">merge_rows</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="n">merge_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parsed</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span><span class="p">]</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="c1">#nonmatching1[&#39;nameid&#39;] = [None] * len(nonmatching1)</span>
    <span class="c1">#nonmatching1[&#39;localid&#39;] = [None] * len(nonmatching1)</span>
    <span class="c1"># Merge keywords from matching parts in parsed2 into parsed1</span>
    <span class="c1">#parsed1[&#39;keywords&#39;] = [[] for _ in range(len(parsed1))]</span>
    <span class="c1">#for idx1, keys in zip(match_idx1, matching2[&#39;keywords&#39;]):</span>
    <span class="c1">#    parsed1[&#39;keywords&#39;][idx1].extend(keys)</span>

    <span class="c1">#parsed = parsed2 + nonmatching1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> total urls&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="parse_wildbook_images"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_wildbook_images">[docs]</a><span class="k">def</span> <span class="nf">parse_wildbook_images</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; url = &#39;www.whaleshark.org/listImages.jsp&#39;</span>
<span class="sd">        &gt;&gt;&gt; url = images_url = &#39;http://www.mantamatcher.org/listImages.jsp&#39;</span>
<span class="sd">        &gt;&gt;&gt; parse_wildbook_images(url)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="k">import</span> <span class="n">parseString</span>
    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>

    <span class="n">number</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cache_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;utool&#39;</span><span class="p">,</span> <span class="s1">&#39;sharkinfo&#39;</span><span class="p">)</span>
    <span class="n">cache_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">hash_data</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.xml&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cache_fpath = </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">))</span>

    <span class="c1"># redownload every 30 days or so</span>
    <span class="k">if</span> <span class="n">getshark</span><span class="o">.</span><span class="n">_needs_redownload</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">XMLdata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">url_read_text</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">,</span> <span class="n">XMLdata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">XMLdata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">)</span>

    <span class="c1"># Parse attributes out of XML</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">XMLdata</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">number</span><span class="p">:</span>
        <span class="n">maxCount</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">))</span>
    <span class="n">parsed_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading XML information from </span><span class="si">%d</span><span class="s1"> images...&#39;</span> <span class="o">%</span> <span class="n">maxCount</span><span class="p">)</span>
    <span class="n">shark_elements</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;shark&#39;</span><span class="p">)</span>
    <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">shark</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="n">shark_elements</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;parsing shark elements&#39;</span><span class="p">):</span>
        <span class="n">localCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">encounter</span> <span class="ow">in</span> <span class="n">shark</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;encounter&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">encounter</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">):</span>
                <span class="n">localCount</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">img_url</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">img_url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">nameid</span> <span class="o">=</span> <span class="n">shark</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>

                <span class="n">new_fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%i%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">nameid</span><span class="p">,</span> <span class="n">localCount</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

                <span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_url</span><span class="p">)</span>
                <span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;nameid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nameid</span><span class="p">)</span>
                <span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;localid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">localCount</span><span class="p">)</span>
                <span class="c1"># might be different due to prefix</span>
                <span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fname</span><span class="p">)</span>

                <span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;encounter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encounter</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">))</span>

                <span class="c1">#print(&#39;Parsed %i / %i files.&#39; % (len(parsed_info[&#39;orig_fname&#39;]), maxCount))</span>
                <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_info</span><span class="p">[</span><span class="s1">&#39;orig_fname&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">number</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="n">parsed_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ColumnLists</span><span class="p">(</span><span class="n">parsed_info</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsed </span><span class="si">%d</span><span class="s1"> urls from XML jsp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed_</span><span class="p">),))</span>

    <span class="c1"># Fix trivial (all non-keyword entries are the same) duplicates</span>
    <span class="n">parsed_</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;localid&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">parsed_</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">parsed1</span> <span class="o">=</span> <span class="n">parsed_</span><span class="o">.</span><span class="n">merge_rows</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="n">merge_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parsed1</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;localid&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">parsed1</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Check and rectify for duplicate urls</span>

    <span class="c1"># Check and rectify for duplicate urls</span>
    <span class="c1">#unique_urls, idxs = parsed_.group_indicies(&#39;img_url&#39;)</span>
    <span class="c1">#toremove = []</span>
    <span class="c1">#for url, idxs in zip(unique_urls, idxs):</span>
    <span class="c1">#    if len(idxs) == 1:</span>
    <span class="c1">#        continue</span>
    <span class="c1">#    dupinfo = parsed_.take(idxs)</span>
    <span class="c1">#    del dupinfo[[&#39;localid&#39;, &#39;new_fname&#39;, &#39;img_url&#39;]]</span>
    <span class="c1">#    can_fix = True</span>
    <span class="c1">#    for key, vals in dupinfo.asdict().items():</span>
    <span class="c1">#        if not ut.allsame(vals):</span>
    <span class="c1">#            print(dupinfo.to_csv())</span>
    <span class="c1">#            print((&#39;Duplicate items have different values&#39;))</span>
    <span class="c1">#            # May need to fix a case when annoations happen in WB</span>
    <span class="c1">#            assert False, &#39;cant have this happen&#39;</span>
    <span class="c1">#            can_fix = False</span>
    <span class="c1">#    if can_fix:</span>
    <span class="c1">#        toremove += idxs[1:]</span>
    <span class="c1">#print(&#39;Removing %d duplicate urls&#39; % (len(toremove),))</span>
    <span class="c1">#flags = ut.not_list(ut.index_to_boolmask(toremove))</span>
    <span class="c1">#parsed1 = parsed_.compress(flags)</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">commonprefix</span><span class="p">(</span><span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">])</span>
    <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">for</span> <span class="n">url_</span> <span class="ow">in</span> <span class="n">parsed1</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">parsed1</span></div>


<div class="viewcode-block" id="parse_whaleshark_org_keywords"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_whaleshark_org_keywords">[docs]</a><span class="k">def</span> <span class="nf">parse_whaleshark_org_keywords</span><span class="p">():</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[keywords] Parsing whaleshark.org keywords&#39;</span><span class="p">)</span>

    <span class="c1">#if False:</span>
    <span class="c1">#    key_url = &#39;http://www.whaleshark.org/getKeywordImages.jsp?indexName=nofilter&amp;maxSize=2&#39;</span>
    <span class="c1">#    #import requests</span>
    <span class="c1">#    #resp = requests.get(url)</span>
    <span class="c1">#    #resp.json()</span>

    <span class="c1">#    # key_url = &#39;http://www.whaleshark.org/getKeywordImages.jsp?indexName=nofilter&#39;</span>
    <span class="c1">#    # json = cached_json_request(key_url)</span>
    <span class="c1">#    # ut.save_data(&#39;nofilterwbquery.pkl&#39;, json)</span>

    <span class="c1">#    #url = &#39;http://www.whaleshark.org/getKeywordImages.jsp?indexName=truncationleftpec&amp;maxSize=2&#39;</span>
    <span class="c1">#    #import requests</span>
    <span class="c1">#    #resp = requests.get(url)</span>
    <span class="c1">#    #resp.json()</span>

    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.whaleshark.org/getKeywordImages.jsp&#39;</span>

    <span class="n">cache_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;utool&#39;</span><span class="p">,</span> <span class="s1">&#39;sharkinfo3&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cached_json_request</span><span class="p">(</span><span class="n">key_url</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">requests</span>
        <span class="n">cache_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="s1">&#39;req_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">key_url</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">getshark</span><span class="o">.</span><span class="n">_needs_redownload</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3000</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execute request </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_url</span><span class="p">,))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_url</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got Response&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">cache_fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span>

    <span class="c1"># Read all keyywords</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">cached_json_request</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="s1">&#39;indexName&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[keywords] Keyword indexName:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">key_list</span><span class="p">)),</span> <span class="s1">&#39;* &#39;</span><span class="p">))</span>

    <span class="c1"># Request all images belonging to each keyword</span>
    <span class="n">request_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">key_list</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;nofilter&#39;</span><span class="p">],</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;reading index&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">key_url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;?indexName=</span><span class="si">{indexName}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexName</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">request_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_json_request</span><span class="p">(</span><span class="n">key_url</span><span class="p">)</span>

    <span class="n">keyed_images</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">request_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">keyed_images</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>

    <span class="c1"># Flatten nested structure into ColumnList (note this will cause img_url duplicates)</span>
    <span class="n">parsed_info2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">images</span> <span class="ow">in</span> <span class="n">keyed_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">imgdict</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">parsed_info2</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgdict</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
            <span class="n">parsed_info2</span><span class="p">[</span><span class="s1">&#39;encounter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgdict</span><span class="p">[</span><span class="s1">&#39;correspondingEncounterNumber&#39;</span><span class="p">])</span>
            <span class="n">parsed_info2</span><span class="p">[</span><span class="s1">&#39;nameid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;individualID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">parsed_info2</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgdict</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
            <span class="n">parsed_info2</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgdict</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">])</span>
            <span class="c1">#parsed_info2[&#39;keywords&#39;].append([key])</span>
    <span class="n">parsed2_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ColumnLists</span><span class="p">(</span><span class="n">parsed_info2</span><span class="p">)</span>

    <span class="c1"># Fix trivial (all non-keyword entries are the same) duplicates</span>
    <span class="n">parsed2_</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">)</span>
    <span class="n">parsed2</span> <span class="o">=</span> <span class="n">parsed2_</span><span class="o">.</span><span class="n">merge_rows</span><span class="p">(</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="n">merge_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parsed2</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed2</span><span class="o">.</span><span class="n">get_multis</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;uuids must be unique&#39;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">injured_keywords</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">get_injured_tags</span><span class="p">(</span><span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">])</span>
        <span class="n">other_keywords</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">get_injured_tags</span><span class="p">(</span><span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">],</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">injured_keyhist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">injured_keywords</span><span class="p">),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">other_keyhist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">other_keywords</span><span class="p">),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scraped </span><span class="si">%r</span><span class="s1"> images with keywords&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parsed2</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had injured tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">injured_keywords</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had other tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">other_keywords</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Of these, </span><span class="si">%r</span><span class="s1"> images had no injured tags&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">parsed2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">injured_keywords</span><span class="p">))))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Injured Keyword histogram:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">*: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">injured_keyhist</span><span class="o">.</span><span class="n">items</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Other Keyword histogram:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;*</span><span class="si">%s</span><span class="s1">*: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other_keyhist</span><span class="o">.</span><span class="n">items</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Get tag co-occurrence</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Injur Keywords Co-Occurrence Freq&#39;</span><span class="p">)</span>
        <span class="n">co_occur</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">tag_coocurrence</span><span class="p">(</span><span class="n">injured_keywords</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">co_occur</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Num co-occurrences: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">co_occur</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Injur Keywords Co-Occurrence Percent&#39;</span><span class="p">)</span>
        <span class="n">co_occur_percent</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([(</span><span class="n">keys</span><span class="p">,</span>  <span class="p">[</span><span class="mi">100</span> <span class="o">*</span> <span class="n">val</span> <span class="o">/</span> <span class="n">injured_keyhist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span> <span class="k">for</span>
                                     <span class="n">keys</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">co_occur</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">co_occur_percent</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">get_injur_categories</span><span class="p">(</span><span class="n">injured_keywords</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># NOQA</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">commonprefix</span><span class="p">(</span><span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">])</span>
    <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">for</span> <span class="n">url_</span> <span class="ow">in</span> <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]]</span>
    <span class="c1"># Hack off encounters so it aggrees with parsed1</span>
    <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;encounters/&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">url_</span> <span class="ow">in</span> <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]]</span>
    <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">parsed2</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]]</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed2</span><span class="o">.</span><span class="n">get_multis</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;hack invalidated something&#39;</span>
    <span class="k">return</span> <span class="n">parsed2</span></div>


<div class="viewcode-block" id="postprocess_filenames"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_filenames">[docs]</a><span class="k">def</span> <span class="nf">postprocess_filenames</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">commonprefix</span><span class="p">,</span> <span class="n">basename</span>  <span class="c1"># NOQA</span>
    <span class="c1"># Create a new filename</span>
    <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">_fname</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">_fname</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">]]</span>
    <span class="c1"># Remember the original filename</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">commonprefix</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">])</span>
    <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;orig_fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> <span class="k">for</span> <span class="n">url_</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">]]</span>
    <span class="c1"># Parse out the extension</span>
    <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">splitext</span><span class="p">(</span><span class="n">_fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_fname</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;new_fname&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="postprocess_extfilter"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_extfilter">[docs]</a><span class="k">def</span> <span class="nf">postprocess_extfilter</span><span class="p">(</span><span class="n">parsed</span><span class="p">):</span>
    <span class="c1"># Filter based on image type (keep only jpgs)</span>
    <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>
    <span class="c1">#, &#39;.bmp&#39;, &#39;.gif&#39;]</span>
    <span class="n">ext_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext_</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">valid_exts</span> <span class="k">for</span> <span class="n">ext_</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]]</span>

    <span class="n">invalid_exts</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ext_flags</span><span class="p">))[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ext_flags</span><span class="p">)</span>
    <span class="n">num_removed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">ext_flags</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid Extensions: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">invalid_exts</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Valid Extensions: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%d</span><span class="s1"> images based on extensions&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_removed</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="postprocess_tags_build"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_tags_build">[docs]</a><span class="k">def</span> <span class="nf">postprocess_tags_build</span><span class="p">(</span><span class="n">parsed</span><span class="p">):</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;img_url&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;encounter&#39;</span><span class="p">,</span> <span class="s1">&#39;localid&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;nameid&#39;</span><span class="p">]</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;max_lines_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;max_lines_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

        <span class="n">parsed</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;fname_tags&#39;</span><span class="p">],</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="c1"># Filter to only images matching the appropriate tags</span>
    <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">getshark</span>
    <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;fname_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getshark</span><span class="o">.</span><span class="n">parse_shark_fname_tags</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;orig_fname&#39;</span><span class="p">])</span>

    <span class="c1"># Map keyword/fname tags to standard ia tags</span>
    <span class="n">tags_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">zipflat</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;fname_tags&#39;</span><span class="p">],</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">])</span>
    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">modify_tags</span><span class="p">(</span>
        <span class="n">tags_list</span><span class="p">,</span>
        <span class="n">direct_map</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;c429b13e4d232129014d251c74c60011&#39;</span><span class="p">,</span> <span class="s1">&#39;stranding&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">regex_aug</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;other_injury&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-other&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;truncation&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-trunc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-nicks&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;scar&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-scar&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;bite&#39;</span><span class="p">,</span> <span class="s1">&#39;injur-bite&#39;</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="c1">#cleaned_tags = ut.modify_tags(</span>
    <span class="c1">#    cleaned_tags,</span>
    <span class="c1">#    regex_aug=[</span>
    <span class="c1">#        (&#39;injur-&#39;, &#39;injured&#39;),</span>
    <span class="c1">#    ],</span>
    <span class="c1">#)</span>
    <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned_tags</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="postprocess_tags_filter"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_tags_filter">[docs]</a><span class="k">def</span> <span class="nf">postprocess_tags_filter</span><span class="p">(</span><span class="n">parsed</span><span class="p">):</span>
    <span class="n">tag_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span>
        <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
        <span class="c1">#has_any=[&#39;view-left&#39;],</span>
        <span class="c1">#none_match=[&#39;qual.*&#39;, &#39;view-top&#39;, &#39;part-.*&#39;, &#39;cropped&#39;],</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">tag_flags</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags histogram:&#39;</span> <span class="o">+</span>
              <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags before choosing:&#39;</span> <span class="o">+</span>
              <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))))</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">tag_flags</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags after choosing:&#39;</span> <span class="o">+</span>
              <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))))</span>
    <span class="n">num_removed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">tag_flags</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%d</span><span class="s1"> images based on tags&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_removed</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="download_missing_images"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.download_missing_images">[docs]</a><span class="k">def</span> <span class="nf">download_missing_images</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">exist_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">])</span>
    <span class="n">missing_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">exist_flags</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nExist = </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">exist_flags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">exist_flags</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nMissing = </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">missing_flags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">exist_flags</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_flags</span><span class="p">):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">missing_flags</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading missing subset&#39;</span><span class="p">)</span>
        <span class="n">_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">missing</span><span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">],</span> <span class="n">missing</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only downloading </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

        <span class="kn">from</span> <span class="nn">concurrent</span> <span class="k">import</span> <span class="n">futures</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">download_url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">fs</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_iter</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;downloading wildbook images&#39;</span><span class="p">):</span>
            <span class="k">pass</span></div>

        <span class="c1"># import multiprocessing</span>
        <span class="c1"># pool = multiprocessing.Pool(7)</span>
        <span class="c1"># res = pool.map(ut.partial(ut.download_url, new=True, verbose=False), _iter)</span>

        <span class="c1"># gen = ut.util_parallel.generate2(ut.download_url, zip(_iter), new=True, verbose=False)</span>
        <span class="c1"># for _ in gen:</span>
        <span class="c1">#     pass</span>

        <span class="c1"># _prog = ut.ProgPartial(bs=True, freq=1)</span>
        <span class="c1"># count = 0</span>
        <span class="c1"># for img_url, new_fpath in _prog(_iter, lbl=&#39;downloading wildbook images&#39;):</span>
        <span class="c1">#     #url = img_url</span>
        <span class="c1">#     #filename = new_fpath</span>
        <span class="c1">#     #break</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         ut.download_url(img_url, new_fpath, verbose=False, new=True)</span>
        <span class="c1">#         count += 1</span>
        <span class="c1">#         if num is not None and count &gt; num:</span>
        <span class="c1">#             break</span>
        <span class="c1">#     except (ZeroDivisionError, IOError):</span>
        <span class="c1">#         pass</span>


<div class="viewcode-block" id="postprocess_corrupted"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_corrupted">[docs]</a><span class="k">def</span> <span class="nf">postprocess_corrupted</span><span class="p">(</span><span class="n">parsed_dl</span><span class="p">):</span>
    <span class="c1"># Remove corrupted or ill-formatted images</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for corrupted images&#39;</span><span class="p">)</span>
    <span class="n">gpaths</span> <span class="o">=</span> <span class="n">fpaths</span> <span class="o">=</span> <span class="n">parsed_dl</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">]</span>
    <span class="n">valid_flags</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">filterflags_valid_images</span><span class="p">(</span><span class="n">fpaths</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">parsed_dl</span> <span class="o">=</span> <span class="n">parsed_dl</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">valid_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_dl</span></div>


<div class="viewcode-block" id="postprocess_uuids"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_uuids">[docs]</a><span class="k">def</span> <span class="nf">postprocess_uuids</span><span class="p">(</span><span class="n">parsed_dl</span><span class="p">):</span>
    <span class="c1"># Assign uuids based on image content.</span>
    <span class="c1"># Stride of 1 is what IA uses internally</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assigning file based UUID&#39;</span><span class="p">)</span>
    <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parsed_dl</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_file_uuid</span><span class="p">(</span><span class="n">fpath_</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">fpath_</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="n">parsed_dl</span><span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">],</span>
                                             <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;uuid check&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">parsed_dl</span></div>


<div class="viewcode-block" id="postprocess_rectify_duplicates"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.postprocess_rectify_duplicates">[docs]</a><span class="k">def</span> <span class="nf">postprocess_rectify_duplicates</span><span class="p">(</span><span class="n">unmerged</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Rectify duplicate uuid information &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for duplicate information&#39;</span><span class="p">)</span>
    <span class="c1"># Find rows that have unique uuids</span>
    <span class="n">singles</span> <span class="o">=</span> <span class="n">unmerged</span><span class="o">.</span><span class="n">get_singles</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> unique images that appear once&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">singles</span><span class="p">)))</span>

    <span class="c1"># Find rows with duplicate uuid entries</span>
    <span class="n">multis</span> <span class="o">=</span> <span class="n">unmerged</span><span class="o">.</span><span class="n">get_multis</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> images that appear more than once&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multis</span><span class="p">)))</span>
    <span class="c1"># Map other attributes to ordered-sets to join them</span>
    <span class="n">multi_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">unmerged</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
    <span class="n">multis</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="n">multi_keys</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">oset</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
    <span class="c1"># Combine rows with the same uuid. (other attributes are set unioned)</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">multis</span><span class="o">.</span><span class="n">merge_rows</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
    <span class="c1"># Cast sets into lists</span>
    <span class="n">merged</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="n">multi_keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> unique images that have duplicates&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)))</span>

    <span class="c1"># Rectify the duplicate information in the multi columns.</span>
    <span class="c1"># Tags/Keywords are simply unioned, leave them as is</span>
    <span class="n">takeall_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="s1">&#39;fname_tags&#39;</span><span class="p">]</span>
    <span class="c1"># Names/Encounters/etc should only take one value.</span>
    <span class="c1"># Try to fine one, but take multiple if it is ambiguous</span>
    <span class="n">takeone_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">multi_keys</span><span class="p">,</span> <span class="n">takeall_keys</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">takeone_keys</span><span class="p">:</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># We need to at least rectify some of the ambiguous information.</span>
    <span class="c1"># (ie, like where are we going to store the new image?)</span>
    <span class="c1"># For this just take the first item in the ambiguous list</span>
    <span class="n">mustfix_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fname&#39;</span><span class="p">]</span>
    <span class="n">isambiguous</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">or_lists</span><span class="p">(</span><span class="o">*</span><span class="n">merged</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="n">mustfix_keys</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mustfix_keys</span><span class="p">:</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for ambiguous columns&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">takeone_keys</span><span class="p">:</span>
        <span class="n">isambiguous</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">map_column</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">isambiguous</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;X: key=</span><span class="si">%s</span><span class="s1"> has </span><span class="si">%r</span><span class="s1"> ambiguities!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="c1">#merged.compress(isambiguous).print(keys=[key, &#39;suffix&#39;])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;o: key=</span><span class="si">%s</span><span class="s1"> is unambiguous&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="c1"># Take the first item from the columns that should only have one value</span>
    <span class="c1">#merged.cast_column(takeone_keys, lambda v: v[0])</span>
    <span class="c1"># Deal with animals with multiple names</span>
    <span class="c1">#merged.cast_column(&#39;nameid&#39;, lambda v: v if len(v) &lt;= 1 else ut.filter_Nones(v))</span>
    <span class="c1">#merged.cast_column(&#39;nameid&#39;, lambda v: v[0] if len(v) == 1 else v)</span>

    <span class="c1"># print info</span>
    <span class="c1">#del parsed_dl[[&#39;ext&#39;, &#39;localid&#39;, &#39;orig_fname&#39;, &#39;suffix&#39;, &#39;new_fname&#39;, &#39;keywords&#39;]]</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;img_url&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;new_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;ext&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;fname_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span><span class="p">]</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;max_lines_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;max_lines_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

    <span class="c1"># Combine and return the rectifyied information</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">singles</span> <span class="o">+</span> <span class="n">merged</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merged duplicates into </span><span class="si">%d</span><span class="s1"> truely unique images&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">info</span></div>


<div class="viewcode-block" id="parse_shark_fname_tags"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.getshark.parse_shark_fname_tags">[docs]</a><span class="k">def</span> <span class="nf">parse_shark_fname_tags</span><span class="p">(</span><span class="n">orig_fname_list</span><span class="p">,</span> <span class="n">dev</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses potential tags from the filename. If dev mode is on, then it prints</span>
<span class="sd">    out other potential tags you might add.</span>

<span class="sd">    &gt;&gt;&gt; orig_fname_list = parsed[&#39;orig_fname&#39;]</span>
<span class="sd">    &gt;&gt;&gt; dev = True</span>
<span class="sd">    &gt;&gt;&gt; tags = parse_shark_fname_tags(orig_fname_list, dev=dev)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">invalid_tag_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">),</span>
        <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;?</span><span class="se">\\</span><span class="s1">d*&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+-</span><span class="se">\\</span><span class="s1">d+-</span><span class="se">\\</span><span class="s1">d+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+,&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+&#39;</span><span class="p">,</span> <span class="s1">&#39;vi*&#39;</span><span class="p">,</span> <span class="s1">&#39;i*v&#39;</span><span class="p">,</span> <span class="s1">&#39;i+&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+th&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+nd&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d+rd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;remant&#39;</span><span class="p">,</span> <span class="s1">&#39;timnfe&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;sjl&#39;</span><span class="p">,</span> <span class="s1">&#39;disc&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;road&#39;</span><span class="p">,</span> <span class="s1">&#39;easter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;western&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span> <span class="s1">&#39;tn&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*ap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;whaleshark</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span> <span class="s1">&#39;shark</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span> <span class="s1">&#39;whale</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;whalesharking&#39;</span><span class="p">,</span> <span class="s1">&#39;sharking&#39;</span><span class="p">,</span> <span class="s1">&#39;whalesharks&#39;</span><span class="p">,</span> <span class="s1">&#39;whales&#39;</span><span class="p">,</span>
        <span class="s1">&#39;picture&#39;</span><span class="p">,</span>
        <span class="s1">&#39;australien&#39;</span><span class="p">,</span>
        <span class="s1">&#39;australia&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nick&#39;</span><span class="p">,</span> <span class="s1">&#39;tim</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;imageset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;holiday&#39;</span><span class="p">,</span> <span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="s1">&#39;tour&#39;</span><span class="p">,</span> <span class="s1">&#39;trip&#39;</span><span class="p">,</span> <span class="s1">&#39;pec&#39;</span><span class="p">,</span> <span class="s1">&#39;sv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span>
        <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;pic&#39;</span><span class="p">,</span> <span class="s1">&#39;pics&#39;</span><span class="p">,</span> <span class="s1">&#39;leith&#39;</span><span class="p">,</span> <span class="s1">&#39;trips&#39;</span><span class="p">,</span> <span class="s1">&#39;kings&#39;</span><span class="p">,</span> <span class="s1">&#39;photo&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fix&#39;</span><span class="p">,</span> <span class="s1">&#39;feeding&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nrd&#39;</span><span class="p">,</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span> <span class="s1">&#39;gen&#39;</span><span class="p">,</span> <span class="s1">&#39;wa&#39;</span><span class="p">,</span> <span class="s1">&#39;nmp&#39;</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="s1">&#39;kd&#39;</span><span class="p">,</span> <span class="s1">&#39;ow&#39;</span><span class="p">,</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span> <span class="s1">&#39;dsc&#39;</span><span class="p">,</span> <span class="s1">&#39;nwd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;mai&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;stumpy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;oea&#39;</span><span class="p">,</span> <span class="s1">&#39;cbe&#39;</span><span class="p">,</span> <span class="s1">&#39;edc&#39;</span><span class="p">,</span> <span class="s1">&#39;knrt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tiws2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ando&#39;</span><span class="p">,</span> <span class="s1">&#39;adv&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;adventure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;camera&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;ws1&#39;</span><span class="p">,</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gulf&#39;</span><span class="p">,</span> <span class="s1">&#39;wally&#39;</span><span class="p">,</span> <span class="s1">&#39;walhai&#39;</span><span class="p">,</span> <span class="s1">&#39;wags&#39;</span><span class="p">,</span> <span class="s1">&#39;shark[0-9][a-z]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shark&#39;</span><span class="p">,</span> <span class="s1">&#39;sharks&#39;</span><span class="p">,</span> <span class="s1">&#39;reef&#39;</span><span class="p">,</span> <span class="s1">&#39;720x480&#39;</span><span class="p">,</span> <span class="s1">&#39;nb&#39;</span><span class="p">,</span> <span class="s1">&#39;nrdive&#39;</span><span class="p">,</span> <span class="s1">&#39;tiws&#39;</span><span class="p">,</span> <span class="s1">&#39;exmouth&#39;</span><span class="p">,</span> <span class="s1">&#39;nrdive2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ningaloo&#39;</span><span class="p">,</span> <span class="s1">&#39;ti&#39;</span><span class="p">,</span> <span class="s1">&#39;nwss&#39;</span><span class="p">,</span> <span class="s1">&#39;1st&#39;</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;wsnd&#39;</span><span class="p">,</span> <span class="s1">&#39;cba&#39;</span><span class="p">,</span> <span class="s1">&#39;3iwsd&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nwd2&#39;</span><span class="p">,</span> <span class="s1">&#39;s1l1&#39;</span><span class="p">,</span> <span class="s1">&#39;s1r1&#39;</span>
        <span class="s1">&#39;encounter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;the&#39;</span><span class="p">,</span>  <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span>
        <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;ws3&#39;</span><span class="p">,</span> <span class="s1">&#39;s2&#39;</span>
        <span class="s1">&#39;tagged&#39;</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;dive&#39;</span><span class="p">,</span> <span class="s1">&#39;untag&#39;</span><span class="p">,</span> <span class="s1">&#39;tagtrace&#39;</span><span class="p">,</span>
        <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*april&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*may&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*july&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*june&#39;</span><span class="p">,</span> <span class="s1">&#39;apr</span><span class="se">\\</span><span class="s1">d+&#39;</span>
        <span class="s1">&#39;ningaloo&#39;</span><span class="p">,</span> <span class="s1">&#39;ningblue</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span> <span class="s1">&#39;kooling&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">couldbe_tags</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;remnant&#39;</span><span class="p">,</span> <span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span>
        <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;professional&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">,</span>
        <span class="s1">&#39;measure&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span>
        <span class="s1">&#39;encounter&#39;</span>
    <span class="p">]</span>

    <span class="n">invalid_tag_patterns</span> <span class="o">+=</span> <span class="n">couldbe_tags</span>

    <span class="n">valid_tag_level_set</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;view-left&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;lhs&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;leftside&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;view-right&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;rhs&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;rightside&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;view-back&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;view-top&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;sex-male&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;sexm&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;sex-female&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;sex-unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-tail&#39;</span><span class="p">,</span> <span class="s1">&#39;tail&#39;</span><span class="p">,</span> <span class="s1">&#39;caudal&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-flank&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;flank&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-head&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-pectoral&#39;</span><span class="p">,</span> <span class="s1">&#39;pectoral&#39;</span><span class="p">,</span> <span class="s1">&#39;pec&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-dorsal&#39;</span><span class="p">,</span> <span class="s1">&#39;dorsal&#39;</span><span class="p">,</span> <span class="s1">&#39;dorsals&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-claspers&#39;</span><span class="p">,</span> <span class="s1">&#39;claspers&#39;</span><span class="p">,</span> <span class="s1">&#39;clasper&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-fin&#39;</span><span class="p">,</span> <span class="s1">&#39;fin&#39;</span><span class="p">,</span> <span class="s1">&#39;leftpecfin&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-pelvis&#39;</span><span class="p">,</span> <span class="s1">&#39;pelvic&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;part-gill&#39;</span><span class="p">,</span> <span class="s1">&#39;gill&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;cropped&#39;</span><span class="p">,</span> <span class="s1">&#39;crop&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-scar&#39;</span><span class="p">,</span> <span class="s1">&#39;scar&#39;</span><span class="p">,</span> <span class="s1">&#39;scar2&#39;</span><span class="p">,</span> <span class="s1">&#39;scars&#39;</span><span class="p">,</span> <span class="s1">&#39;tailscar&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-bite&#39;</span><span class="p">,</span> <span class="s1">&#39;bite&#39;</span><span class="p">,</span> <span class="s1">&#39;tailbite&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;scratches&#39;</span><span class="p">,</span> <span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;headnick&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-damage&#39;</span><span class="p">,</span> <span class="s1">&#39;damage&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;trunc&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;injur-other&#39;</span><span class="p">,</span> <span class="s1">&#39;injury&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;notch&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;small&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;qual-resize&#39;</span><span class="p">,</span> <span class="s1">&#39;resize&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;qual-stretched&#39;</span><span class="p">,</span> <span class="s1">&#39;stretched&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;pregnant&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;notpregnant&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;closeup&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;mature&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;ventralid&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">cam_tags</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;cam-slr2&#39;</span><span class="p">,</span> <span class="s1">&#39;slr2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;cam-5m&#39;</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;cam-7m&#39;</span><span class="p">,</span> <span class="s1">&#39;7m&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;cam-4m&#39;</span><span class="p">,</span> <span class="s1">&#39;4m&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;copy&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">invalid_tag_patterns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">cam_tags</span><span class="p">)]</span>
    <span class="c1">#valid_tag_level_set += invalid_tag_patterns</span>

    <span class="k">def</span> <span class="nf">apply_enum_regex</span><span class="p">(</span><span class="n">pat_list</span><span class="p">):</span>
        <span class="n">enum_endings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;[a-g]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">d*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;i*&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">expanded_pats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span>
            <span class="p">[</span><span class="n">pat</span> <span class="o">+</span> <span class="n">end</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">enum_endings</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pat</span>  <span class="ow">in</span> <span class="n">pat_list</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">expanded_pats</span>

    <span class="k">def</span> <span class="nf">apply_regex_endings</span><span class="p">(</span><span class="n">pat_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pat_list</span><span class="p">]</span>

    <span class="n">tag_alias_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">level_set</span> <span class="ow">in</span> <span class="n">valid_tag_level_set</span><span class="p">:</span>
        <span class="n">main_key</span> <span class="o">=</span> <span class="n">level_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">level_set</span><span class="p">:</span>
            <span class="n">tag_alias_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_key</span>

    <span class="n">inverse_alias_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">level_set</span> <span class="ow">in</span> <span class="n">valid_tag_level_set</span><span class="p">:</span>
        <span class="n">inverse_alias_map</span><span class="p">[</span><span class="n">level_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">level_set</span>

    <span class="n">regex_alias_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;view-left&#39;</span><span class="p">:</span> <span class="n">apply_regex_endings</span><span class="p">(</span><span class="n">apply_enum_regex</span><span class="p">(</span><span class="n">inverse_alias_map</span><span class="p">[</span><span class="s1">&#39;view-left&#39;</span><span class="p">])),</span>
        <span class="s1">&#39;view-right&#39;</span><span class="p">:</span> <span class="n">apply_regex_endings</span><span class="p">(</span><span class="n">apply_enum_regex</span><span class="p">(</span><span class="n">inverse_alias_map</span><span class="p">[</span><span class="s1">&#39;view-right&#39;</span><span class="p">])),</span>
    <span class="p">}</span>

    <span class="n">valid_tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inverse_alias_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">invalid_tag_patterns</span> <span class="o">=</span> <span class="n">apply_regex_endings</span><span class="p">(</span><span class="n">invalid_tag_patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_all_fname_tags</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">basename</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#base.replace(&#39;(&#39;, &#39;&#39;)</span>
        <span class="c1">#base.replace(&#39;)&#39;, &#39;&#39;)</span>
        <span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">]:</span>
            <span class="n">_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_tags</span><span class="p">])</span>
        <span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_tags</span><span class="p">]</span>
        <span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag_alias_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_tags</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">regex_alias_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_or</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_tags</span><span class="p">]</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_or</span><span class="p">(</span><span class="n">invalid_tag_patterns</span><span class="p">)</span>
        <span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_tags</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>
        <span class="n">_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">(</span><span class="n">_tags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_tags</span>

    <span class="n">all_img_tag_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">parse_all_fname_tags</span><span class="p">,</span> <span class="n">orig_fname_list</span><span class="p">))</span>

    <span class="n">known_img_tag_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">valid_tags</span><span class="p">)))</span>
                          <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">all_img_tag_list</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dev</span><span class="p">:</span>
        <span class="c1"># Help figure out which tags are important</span>
        <span class="n">_parsed_tags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">all_img_tag_list</span><span class="p">)</span>

        <span class="n">taghist</span> <span class="o">=</span>  <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">_parsed_tags</span><span class="p">)</span>
        <span class="n">taghist</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">taghist</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>

        <span class="n">unknown_taghist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">taghist</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_tags</span>
        <span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">known_taghist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
            <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">taghist</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid_tags</span>
        <span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">unknown_taghist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Known&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">known_taghist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">known_img_tag_list</span><span class="p">)),</span>
            <span class="n">key_order_metric</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">))</span>

    <span class="k">return</span> <span class="n">known_img_tag_list</span></div>


<span class="c1">#def main():</span>
<span class="c1">#    try:</span>
<span class="c1">#        opts, args = getopt.getopt(sys.argv[1:], &#39;f:u:n:h&#39;)</span>
<span class="c1">#    except getopt.GetoptError:</span>
<span class="c1">#        usage()</span>
<span class="c1">#        sys.exit(1)</span>

<span class="c1">#    filename = None</span>
<span class="c1">#    url = &#39;www.whaleshark.org/listImages.jsp&#39;</span>
<span class="c1">#    number = 0</span>

<span class="c1">#    # Handle command-line arguments</span>
<span class="c1">#    for opt, arg in opts:</span>
<span class="c1">#        if opt == &#39;-h&#39;:</span>
<span class="c1">#            usage()</span>
<span class="c1">#            sys.exit()</span>
<span class="c1">#        elif opt == &#39;-f&#39;:</span>
<span class="c1">#            filename = arg</span>
<span class="c1">#        elif opt == &#39;-u&#39;:</span>
<span class="c1">#            url = arg</span>
<span class="c1">#        elif opt == &#39;-n&#39;:</span>
<span class="c1">#            try:</span>
<span class="c1">#                number = int(arg)</span>
<span class="c1">#            except ValueError:</span>
<span class="c1">#                usage()</span>
<span class="c1">#                sys.exit()</span>

<span class="c1">#    # Open the XML file and extract its contents as a DOM object</span>
<span class="c1">#    if filename:</span>
<span class="c1">#        XMLdata = ut.readfrom(filename)</span>
<span class="c1">#    else:</span>
<span class="c1">#        XMLdata = ut.url_read(url)</span>
<span class="c1">#        #with open(&#39;XMLData.xml&#39;, &#39;w&#39;) as file_:</span>
<span class="c1">#        #    file_.write(XMLdata)</span>
<span class="c1">#    print(&#39;Downloading&#39;)</span>
<span class="c1">#    download_sharks(XMLdata, number)</span>
<span class="c1">#    #download_sharks(XMLdata, number)</span>


<span class="c1">#def usage():</span>
<span class="c1">#    print(&#39;Fetches a number of images from the ECOCEAN shark database.&#39;)</span>
<span class="c1">#    print(&#39;Options:&#39;)</span>
<span class="c1">#    print(&#39;  -f &lt;FILENAME&gt; - Reads XML data from a file, rather than a URL.&#39;)</span>
<span class="c1">#    print(&#39;  -u &lt;URL&gt; - Reads XML data from the given URL.&#39;)</span>
<span class="c1">#    print(&#39;  -n &lt;NUMBER&gt; - Number of images to read; if omitted, reads all of them.&#39;)</span>
<span class="c1">#    print(&#39;  -h - Prints this help text.&#39;)</span>


<span class="c1">#if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#    main()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Wild Me

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>