

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.init.filter_annots &mdash; ibeis 1.5.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ibeis 1.5.0 documentation" href="../../../index.html"/>
        <link rel="up" title="ibeis" href="../../ibeis.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">ibeis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
      
    <li>ibeis.init.filter_annots</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.init.filter_annots</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO: sort annotations at the end of every step</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">controller_inject</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[main_helpers]&#39;</span><span class="p">)</span>

<span class="n">VERB_TESTDATA</span><span class="p">,</span> <span class="n">VERYVERB_TESTDATA</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_verbflag</span><span class="p">(</span><span class="s">&#39;testdata&#39;</span><span class="p">,</span> <span class="s">&#39;td&#39;</span><span class="p">)</span>

<span class="c"># TODO: Make these configurable</span>
<span class="n">SEED1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SEED2</span> <span class="o">=</span> <span class="mi">42</span>

<span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
    <span class="n">USE_ACFG_CACHE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--nocache-annot&#39;</span><span class="p">,</span> <span class="s">&#39;--nocache-aid&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;--nocache&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">USE_CACHE</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">USE_ACFG_CACHE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">_tup</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">make_ibs_register_decorator</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="n">_tup</span>


<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_annots_general"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.filter_annots_general">[docs]</a><span class="k">def</span> <span class="nf">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>
<span class="sd">        filter_kw (?):</span>

<span class="sd">    KWargs::</span>
<span class="sd">        has_none_annotmatch, any_match_annotmatch, has_all, is_known,</span>
<span class="sd">        any_match_annot, logic_annot, none_match_annotmatch,</span>
<span class="sd">        max_num_annotmatch, any_startswith_annot, has_any, require_quality,</span>
<span class="sd">        species, any_match, view_ext, has_any_annotmatch, view_pername,</span>
<span class="sd">        max_num_annot, min_timedelta, any_startswith, max_numfeat,</span>
<span class="sd">        any_startswith_annotmatch, been_adjusted, any_endswith_annot,</span>
<span class="sd">        require_viewpoint, logic, has_any_annot, min_num_annotmatch, min_num,</span>
<span class="sd">        min_num_annot, has_all_annot, has_none, min_pername,</span>
<span class="sd">        any_endswith_annotmatch, any_endswith, require_timestamp, none_match,</span>
<span class="sd">        contrib_contains, has_all_annotmatch, logic_annotmatch, min_numfeat,</span>
<span class="sd">        none_match_annot, view_ext1, view_ext2, max_num, has_none_annot,</span>
<span class="sd">        minqual, view</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf filter_annots_general</span>
<span class="sd">        python -m ibeis --tf filter_annots_general --db PZ_Master1 \</span>
<span class="sd">                --has_any=[needswork,correctable,mildviewpoint] \</span>
<span class="sd">                --has_none=[viewpoint,photobomb,error:viewpoint,quality] --show</span>

<span class="sd">        python -m ibeis --tf filter_annots_general --db=GZ_Master1  \</span>
<span class="sd">                --max-numfeat=300 --show --minqual=junk --species=None</span>
<span class="sd">        python -m ibeis --tf filter_annots_general --db=lynx \</span>
<span class="sd">                --been_adjusted=True</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = ut.argparse_dict(get_default_annot_filter_form(),</span>
<span class="sd">        &gt;&gt;&gt;                              type_hint=ut.ddict(list, has_any=list,</span>
<span class="sd">        &gt;&gt;&gt;                                                 has_none=list,</span>
<span class="sd">        &gt;&gt;&gt;                                                 logic=str))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;filter_kw = %s&#39; % (ut.dict_str(filter_kw),))</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; #filter_kw = dict(is_known=True, min_num=1, has_any=&#39;viewpoint&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #filter_kw = dict(is_known=True, min_num=1, any_match=&#39;.*error.*&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filter_annots_general(ibs, aid_list, filter_kw)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;len(aid_list_) = %r&#39; % (len(aid_list_),))</span>
<span class="sd">        &gt;&gt;&gt; all_tags = ut.flatten(ibs.get_annot_all_tags(aid_list_))</span>
<span class="sd">        &gt;&gt;&gt; filtered_tag_hist = ut.dict_hist(all_tags)</span>
<span class="sd">        &gt;&gt;&gt; ut.print_dict(filtered_tag_hist, key_order_metric=&#39;val&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.print_dict(ibs.get_annot_stats_dict(aid_list_), &#39;annot_stats&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import ibeis.viz.interact</span>
<span class="sd">        &gt;&gt;&gt; ibeis.viz.interact.interact_chip.interact_multichips(ibs, aid_list_)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">filter_kw_</span> <span class="o">=</span> <span class="n">get_default_annot_filter_form</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">aid_list</span>
    <span class="c">#filter_kw = ut.merge_dicts(get_default_annot_filter_form(), filter_kw)</span>
    <span class="c"># TODO MERGE FILTERFLAGS BY TAGS AND FILTERFLAGS INDEPENDANT</span>
    <span class="c">#aid_list_ = ibs.filterannots_by_tags(aid_list_, filter_kw)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="sample_annots_general"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.sample_annots_general">[docs]</a><span class="k">def</span> <span class="nf">sample_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; filter + sampling &quot;&quot;&quot;</span>
    <span class="c"># hack</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">annotation_configs</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">filter_kw_</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">filter_kw_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">SUBINDEX_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">filter_kw_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">SAMPLE_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">aid_list</span>
    <span class="c">#filter_kw = ut.merge_dicts(get_default_annot_filter_form(), filter_kw)</span>
    <span class="c"># TODO MERGE FILTERFLAGS BY TAGS AND FILTERFLAGS INDEPENDANT</span>
    <span class="c">#aid_list_ = ibs.filterannots_by_tags(aid_list_, filter_kw)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<div class="viewcode-block" id="get_default_annot_filter_form"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.get_default_annot_filter_form">[docs]</a><span class="k">def</span> <span class="nf">get_default_annot_filter_form</span><span class="p">():</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Returns dictionary containing defaults for all valid filter parameters</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf get_default_annot_filter_form</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = get_default_annot_filter_form()</span>
<span class="sd">        &gt;&gt;&gt; print(ut.dict_str(filter_kw, align=True))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;, &#39;.join(filter_kw.keys()))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">annotation_configs</span>
    <span class="n">iden_defaults</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">filter_kw</span> <span class="o">=</span> <span class="n">iden_defaults</span>
    <span class="c">#tag_defaults = get_annot_tag_filterflags(</span>
    <span class="c">#    None, None, {}, request_defaultkw=True)</span>
    <span class="c">#filter_kw = ut.dict_union3(iden_defaults, tag_defaults, combine_op=None)</span>
    <span class="k">return</span> <span class="n">filter_kw</span>

</div>
<span class="nd">@register_ibs_method</span>
<span class="nd">@profile</span>
<div class="viewcode-block" id="get_annot_tag_filterflags"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.get_annot_tag_filterflags">[docs]</a><span class="k">def</span> <span class="nf">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span>
                              <span class="n">request_defaultkw</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Filters annotations by tags including those that is belongs to in a pair</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">tag_funcs</span>

    <span class="c"># Build Filters</span>
    <span class="n">filter_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_kwargs</span><span class="p">(</span><span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">)</span>

    <span class="n">annotmatch_filterkw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">annot_filterkw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">both_filterkw</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">kwreg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">KWReg</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">request_defaultkw</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filter_keys</span><span class="p">:</span>
        <span class="n">annotmatch_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;_annotmatch&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">annot_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>      <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;_annot&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">both_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>       <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">request_defaultkw</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kwreg</span><span class="o">.</span><span class="n">defaultkw</span>

    <span class="c"># Grab Data</span>
    <span class="n">need_annot_tags</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">annot_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">need_annotmatch_tags</span> <span class="o">=</span>  <span class="nb">any</span><span class="p">([</span>
        <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">annotmatch_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">need_both_tags</span> <span class="o">=</span>  <span class="nb">any</span><span class="p">([</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">both_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="k">if</span> <span class="n">need_annot_tags</span> <span class="ow">or</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">annot_tags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_case_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_annotmatch_tags</span> <span class="ow">or</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">annotmatch_tags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_annotmatch_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">both_tags_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique_keep_order</span><span class="p">,</span>
                                  <span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">annot_tags_list</span><span class="p">,</span>
                                                      <span class="n">annotmatch_tags_list</span><span class="p">))))</span>

    <span class="c"># Filter Data</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">need_annot_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span>
            <span class="n">annot_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_filterkw</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_annotmatch_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span>
            <span class="n">annotmatch_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">annotmatch_filterkw</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span>
            <span class="n">both_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">both_filterkw</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flags</span>

</div>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filterannots_by_tags"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.filterannots_by_tags">[docs]</a><span class="k">def</span> <span class="nf">filterannots_by_tags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf filterannots_by_tags</span>
<span class="sd">        utprof.py -m ibeis --tf filterannots_by_tags</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        filter_annotmatch_by_tags</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; has_any = ut.get_argval(&#39;--tags&#39;, type_=list,</span>
<span class="sd">        &gt;&gt;&gt;                         default=[&#39;SceneryMatch&#39;, &#39;Photobomb&#39;])</span>
<span class="sd">        &gt;&gt;&gt; min_num = ut.get_argval(&#39;--min_num&#39;, type_=int, default=1)</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = dict(has_any=has_any, min_num=1)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filterannots_by_tags(ibs, aid_list, filter_kw)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;aid_list_ = %r&#39; % (aid_list_,))</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; pass</span>
<span class="sd">        &gt;&gt;&gt; # TODO: show special annot group in GUI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span>

</div>
<div class="viewcode-block" id="get_acfg_cacheinfo"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.get_acfg_cacheinfo">[docs]</a><span class="k">def</span> <span class="nf">get_acfg_cacheinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns location and name of the ~~annot~~ data cache</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">cfghelpers</span>
    <span class="c"># Make loading aids a big faster for experiments</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span>
        <span class="n">repodir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_module_dir</span><span class="p">(</span><span class="n">ibeis</span><span class="p">))</span>
        <span class="n">acfg_cachedir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">repodir</span><span class="p">,</span> <span class="s">&#39;ACFG_CACHE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">acfg_cachedir</span> <span class="o">=</span> <span class="s">&#39;./localdata/ACFG_CACHE&#39;</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">)</span>
    <span class="n">acfg_cachename</span> <span class="o">=</span> <span class="s">&#39;ACFG_CACHE&#39;</span>

    <span class="n">RESPECT_INTERNAL_CFGS</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">RESPECT_INTERNAL_CFGS</span><span class="p">:</span>
        <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">relevant_aidcfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">[</span><span class="s">&#39;qcfg&#39;</span><span class="p">],</span>
                            <span class="n">cfghelpers</span><span class="o">.</span><span class="n">INTERNAL_CFGKEYS</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">[</span><span class="s">&#39;dcfg&#39;</span><span class="p">],</span>
                            <span class="n">cfghelpers</span><span class="o">.</span><span class="n">INTERNAL_CFGKEYS</span><span class="p">)</span>
        <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">)))</span>
    <span class="n">acfg_cacheinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acfg_cacheinfo</span>

</div>
<div class="viewcode-block" id="expand_single_acfg"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.expand_single_acfg">[docs]</a><span class="k">def</span> <span class="nf">expand_single_acfg</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for main_helpers &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">annotation_configs</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;+=== EXPAND_SINGLE_ACFG ===&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * acfg = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">compress_aidcfg</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">),</span>
                           <span class="n">align</span><span class="o">=</span><span class="bp">True</span><span class="p">),))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;+---------------------&#39;</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">)</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">avail_aids</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;L___ EXPAND_SINGLE_ACFG ___&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aids</span>

</div>
<div class="viewcode-block" id="expand_acfgs_consistently"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.expand_acfgs_consistently">[docs]</a><span class="k">def</span> <span class="nf">expand_acfgs_consistently</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">acfg_combo</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expands a set of configurations such that they are comparable</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf parse_acfg_combo_list  \</span>
<span class="sd">                -a varysize</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_Master1 -a varysize</span>
<span class="sd">        #ibeis --tf get_annotcfg_list --db lynx -a default:hack_imageset=True</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_Master1 -a varysize:qsize=None</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_Master0 --nofilter-dups  -a varysize</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_MTEST -a varysize --nofilter-dups</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_Master0 --verbtd \</span>
<span class="sd">                --nofilter-dups -a varysize</span>
<span class="sd">        ibeis --tf get_annotcfg_list --db PZ_Master1 -a viewpoint_compare \</span>
<span class="sd">                --verbtd --nofilter-dups</span>
<span class="sd">        ibeis --tf get_annotcfg_list -a timectrl --db GZ_Master1 --verbtd \</span>
<span class="sd">                --nofilter-dups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">annotation_configs</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERB_TESTDATA</span>
    <span class="c"># Edit configs so the sample sizes are consistent</span>
    <span class="c"># FIXME: requiers that smallest configs are specified first</span>
    <span class="k">def</span> <span class="nf">tmpmin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
        <span class="k">elif</span> <span class="n">b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Keep track of seen samples</span>
    <span class="n">min_qsize</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">min_dsize</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># HACK: Find out the params being varied and disallow those from being</span>
    <span class="c"># prefiltered due to the lack of heirarchical filters</span>
    <span class="n">nonvaried_dict</span><span class="p">,</span> <span class="n">varied_acfg_list</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">partition_acfg_list</span><span class="p">(</span>
        <span class="n">acfg_combo</span><span class="p">)</span>
    <span class="n">hack_exclude_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">acfg</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
         <span class="k">for</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="n">varied_acfg_list</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">combox</span><span class="p">,</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acfg_combo</span><span class="p">):</span>
        <span class="n">qcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s">&#39;qcfg&#39;</span><span class="p">]</span>
        <span class="n">dcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s">&#39;dcfg&#39;</span><span class="p">]</span>

        <span class="c"># In some cases we may want to clamp these, but others we do not</span>
        <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;force_const_size&#39;</span><span class="p">]:</span>
            <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">min_qsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;force_const_size&#39;</span><span class="p">]:</span>
            <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">min_dsize</span><span class="p">)</span>

        <span class="c"># Expand modified acfgdict</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%d</span><span class="s">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">combox</span><span class="p">,)):</span>
            <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">expand_acfgs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">acfg</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="n">initial_aids</span><span class="p">,</span>
                                         <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                                         <span class="n">hack_exclude_keys</span><span class="o">=</span><span class="n">hack_exclude_keys</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hack_extra&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                <span class="c"># SUCH HACK to get a larger database</span>
                <span class="k">assert</span> <span class="bp">False</span>
                <span class="n">_aidcfg</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">default</span><span class="p">[</span><span class="s">&#39;dcfg&#39;</span><span class="p">]</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;sample_per_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;min_pername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;require_viewpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;exclude_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">_aidcfg</span><span class="p">[</span><span class="s">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;right&#39;</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;hack&#39;</span>
                <span class="n">qaids</span> <span class="o">=</span> <span class="n">expanded_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">daids</span> <span class="o">=</span> <span class="n">expanded_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">_extra_aids</span> <span class="o">=</span>  <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
                <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">remove_groundtrue_aids</span><span class="p">(</span>
                    <span class="n">_extra_aids</span><span class="p">,</span> <span class="p">(</span><span class="n">qaids</span> <span class="o">+</span> <span class="n">daids</span><span class="p">))</span>
                <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">filter_annots_independent</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">_extra_aids</span><span class="p">,</span> <span class="n">_aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
                <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">_extra_aids</span><span class="p">,</span> <span class="n">_aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
                <span class="n">daids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span> <span class="o">+</span> <span class="n">_extra_aids</span><span class="p">)</span>
                <span class="n">expanded_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>

            <span class="n">qsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c"># &lt;hack for float that should not interfere with other hacks</span>
            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qsize</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dsize</span><span class="p">:</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="c"># /--&gt;</span>

            <span class="k">if</span> <span class="n">min_qsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsize</span>
            <span class="k">if</span> <span class="n">min_dsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># UNSURE</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsize</span>

            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qsize</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;_true_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsize</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dsize</span><span class="p">:</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;_true_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsize</span>

            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s">&#39;force_const_size&#39;</span><span class="p">]:</span>
                <span class="n">min_qsize</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">min_qsize</span><span class="p">,</span> <span class="n">qsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s">&#39;force_const_size&#39;</span><span class="p">]:</span>  <span class="c"># UNSURE</span>
                <span class="n">min_dsize</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">min_dsize</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>

            <span class="c"># so hacky</span>
            <span class="c"># this has to be after sample_size assignment, otherwise the filtering</span>
            <span class="c"># is unstable Remove queries that have labeling errors in them.</span>
            <span class="c"># TODO: fix errors AND remove labels</span>
            <span class="c">#REMOVE_LABEL_ERRORS = ut.is_developer() or ut.get_argflag(&#39;--noerrors&#39;)</span>
            <span class="n">REMOVE_LABEL_ERRORS</span> <span class="o">=</span> <span class="n">qcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hackerrors&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="c">#ut.is_developer() or ut.get_argflag(&#39;--noerrors&#39;)</span>
            <span class="k">if</span> <span class="n">REMOVE_LABEL_ERRORS</span><span class="p">:</span>
                <span class="n">qaids_</span><span class="p">,</span> <span class="n">daids_</span> <span class="o">=</span> <span class="n">expanded_aids</span>

                <span class="n">partitioned_sets</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">partition_annots_into_corresponding_groups</span><span class="p">(</span>
                    <span class="n">qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>
                <span class="n">tup</span> <span class="o">=</span> <span class="n">partitioned_sets</span>
                <span class="n">query_group</span><span class="p">,</span> <span class="n">data_group</span><span class="p">,</span> <span class="n">unknown_group</span><span class="p">,</span> <span class="n">distract_group</span> <span class="o">=</span> <span class="n">tup</span>

                <span class="n">unknown_flags</span>  <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_tag_filterflags</span><span class="p">,</span> <span class="n">unknown_group</span><span class="p">,</span>
                    <span class="n">filter_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">none_match</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;.*error.*&#39;</span><span class="p">]))</span>
                <span class="c">#data_flags  = ibs.unflat_map(</span>
                <span class="c">#    ibs.get_annot_tag_filterflags, data_group,</span>
                <span class="c">#    filter_kw=dict(none_match=[&#39;.*error.*&#39;]))</span>
                <span class="n">query_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_tag_filterflags</span><span class="p">,</span> <span class="n">query_group</span><span class="p">,</span>
                    <span class="n">filter_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">none_match</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;.*error.*&#39;</span><span class="p">]))</span>

                <span class="n">query_noterror_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_zipflatten</span><span class="p">(</span>
                    <span class="n">query_flags</span><span class="p">,</span>
                    <span class="c">#data_flags,</span>
                <span class="p">)))</span>
                <span class="n">unknown_noterror_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="n">unknown_flags</span><span class="p">))</span>

                <span class="n">filtered_queries</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">query_group</span><span class="p">,</span> <span class="n">query_noterror_flags</span><span class="p">))</span>
                <span class="n">filtered_unknown</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">unknown_group</span><span class="p">,</span> <span class="n">unknown_noterror_flags</span><span class="p">))</span>

                <span class="n">filtered_qaids_</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered_queries</span> <span class="o">+</span> <span class="n">filtered_unknown</span><span class="p">)</span>

                <span class="n">expanded_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">filtered_qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">filtered_qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;L___ HACKED_EXPAND_ACFGS ___&#39;</span><span class="p">,</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>

        <span class="c">#ibs.print_annotconfig_stats(*expanded_aids)</span>
        <span class="n">expanded_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">)</span>

    <span class="c"># Sample afterwords</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">acfg_combo</span><span class="p">,</span> <span class="n">expanded_aids_list</span><span class="p">))</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="expand_acfgs"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.expand_acfgs">[docs]</a><span class="k">def</span> <span class="nf">expand_acfgs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">hack_exclude_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Main multi-expansion function. Expands an annot config dict into qaids and</span>
<span class="sd">    daids.  New version of this function based on a configuration dictionary</span>
<span class="sd">    built from command line argumetns</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aidcfg (dict): configuration of the annotation filter</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>
<span class="sd">        use_cache (bool):  turns on disk based caching(default = None)</span>
<span class="sd">        hack_exclude_keys (None): (default = None)</span>
<span class="sd">        initial_aids (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: expanded_aids=(qaid_list, daid_list) - expanded list of aids</span>
<span class="sd">            that meet the criteria of the aidcfg filter</span>

<span class="sd">    TODO:</span>
<span class="sd">        The database should be created first in most circumstances, then</span>
<span class="sd">        the queries should be filtered to meet the database restrictions?</span>
<span class="sd">        I&#39;m not sure Sometimes you need to set the query aids constant, but</span>
<span class="sd">        sometimes you need to set the data aids constant. Seems to depend.</span>

<span class="sd">        This function very much needs the idea of filter chains</span>

<span class="sd">        OkNewIdea:</span>
<span class="sd">            3 filters:</span>
<span class="sd">                * Common sampling - takes care of things like min time delta,</span>
<span class="sd">                * species, quality viewpoint etc.</span>
<span class="sd">                * query sampling</span>
<span class="sd">                * database sampling</span>
<span class="sd">            Basic idea is</span>
<span class="sd">                * Sample large pool</span>
<span class="sd">                * Partition pool into query and database</span>
<span class="sd">            Requires:</span>
<span class="sd">                * base sampling params</span>
<span class="sd">                * partition1 params</span>
<span class="sd">                * partition2 params</span>
<span class="sd">                * inter partition params?</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.dev -e print_acfg  -a timectrl:qsize=10,dsize=10  --db PZ_MTEST --veryverbtd --nocache-aid</span>
<span class="sd">        python -m ibeis.dev -e print_acfg  -a timectrl:qminqual=good,qsize=10,dsize=10  --db PZ_MTEST --veryverbtd --nocache-aid</span>

<span class="sd">        python -m ibeis.dev -e print_acfg  -a timectrl --db PZ_MTEST --verbtd --nocache-aid</span>
<span class="sd">        python -m ibeis.dev -e print_acfg  -a timectrl --db PZ_Master1 --verbtd --nocache-aid</span>
<span class="sd">        python -m ibeis.dev -e print_acfg  -a timequalctrl --db PZ_Master1 --verbtd --nocache-aid</span>

<span class="sd">        python -m ibeis.dev -e rank_cdf   -a controlled:qsize=10,dsize=10,dper_name=2 -t default --db PZ_MTEST</span>
<span class="sd">        python -m ibeis.dev -e rank_cdf   -a controlled:qsize=10,dsize=20,dper_name=2 -t default --db PZ_MTEST</span>
<span class="sd">        python -m ibeis.dev -e print      -a controlled:qsize=10,dsize=10             -t default --db PZ_MTEST --verbtd --nocache-aid</span>

<span class="sd">        python -m ibeis.dev -e latexsum -t candinvar -a viewpoint_compare  --db NNP_Master3 --acfginfo</span>
<span class="sd">        utprof.py -m ibeis.dev -e print -t candk -a varysize  --db PZ_MTEST --acfginfo</span>
<span class="sd">        utprof.py -m ibeis.dev -e latexsum -t candk -a controlled  --db PZ_Master0 --acfginfo</span>

<span class="sd">        python -m ibeis --tf get_annotcfg_list:0 --db NNP_Master3 -a viewpoint_compare --nocache-aid --verbtd</span>

<span class="sd">        python -m ibeis --tf get_annotcfg_list  --db PZ_Master1 \</span>
<span class="sd">            -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">            --acfginfo --veryverbtd  --veryverbtd</span>
<span class="sd">        python -m ibeis --tf draw_rank_cdf --db PZ_Master1 --show -t best \</span>
<span class="sd">            -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">            --acfginfo --veryverbtd</span>

<span class="sd">        python -m ibeis --tf get_annotcfg_list  --db Oxford -a default:qhas_any=\(query,\),dpername=2,exclude_reference=True --acfginfo --verbtd  --veryverbtd --nocache-aid</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.init.filter_annots --exec-expand_acfgs --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = copy.deepcopy(annotation_configs.default)</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;qcfg&#39;][&#39;species&#39;] = &#39;primary&#39;</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = None</span>
<span class="sd">        &gt;&gt;&gt; expanded_aids = expand_acfgs(ibs, aidcfg, initial_aids=initial_aids)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr3(expanded_aids, nl=1, nobr=True)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [1, 2, 3, 4, 5, 6],</span>
<span class="sd">        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis.expt</span> <span class="kn">import</span> <span class="n">annotation_configs</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERB_TESTDATA</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s">&#39;type(aidcfg)=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">),)</span>
    <span class="n">aidcfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>

    <span class="c"># Check if this filter has been cached</span>
    <span class="c"># TODO: keep a database state config that augments the cachestr</span>

    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">use_cache</span> <span class="o">=</span> <span class="n">USE_ACFG_CACHE</span>

    <span class="n">save_cache</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">or</span> <span class="n">save_cache</span><span class="p">:</span>
        <span class="n">acfg_cacheinfo</span> <span class="o">=</span> <span class="n">get_acfg_cacheinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">)</span>
        <span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="n">acfg_cacheinfo</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span>
                <span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span>

    <span class="n">comp_acfg</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">compress_aidcfg</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;+=== EXPAND_ACFGS ===&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * acfg = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">comp_acfg</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="bp">True</span><span class="p">),))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="c"># Breakup into common, query, and database configs</span>
    <span class="n">qcfg</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;qcfg&#39;</span><span class="p">]</span>
    <span class="n">dcfg</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;dcfg&#39;</span><span class="p">]</span>
    <span class="n">common_cfg</span> <span class="o">=</span> <span class="n">comp_acfg</span><span class="p">[</span><span class="s">&#39;common&#39;</span><span class="p">]</span>

    <span class="c"># Extract the common independent filtering params</span>
    <span class="n">idenfilt_cfg_default</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span>
    <span class="n">idenfilt_cfg_empty</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">idenfilt_cfg_default</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">idenfilt_cfg_common</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">idenfilt_cfg_empty</span><span class="p">,</span>
                                             <span class="n">common_cfg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hack_exclude_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hack_exclude_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">idenfilt_cfg_common</span><span class="p">:</span>
                <span class="n">idenfilt_cfg_common</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Find the q/d specific filtering flags that were already taken care of in</span>
    <span class="c"># common filtering. Set them all to None, so we dont rerun that filter</span>
    <span class="n">qpredone_iden_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect</span><span class="p">(</span><span class="n">qcfg</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">qpredone_iden_keys</span><span class="p">:</span>
        <span class="n">qcfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">dpredone_iden_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect</span><span class="p">(</span><span class="n">dcfg</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dpredone_iden_keys</span><span class="p">:</span>
        <span class="n">dcfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c">#if aidcfg[&#39;qcfg&#39;][&#39;hack_imageset&#39;] is True:</span>
        <span class="c">#    return ibs.get_imageset_expanded_aids()</span>
        <span class="c"># Hack: Make hierarchical filters to supersede this</span>
        <span class="k">if</span> <span class="n">initial_aids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">initial_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>

        <span class="n">verbflags</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">qfiltflags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span><span class="p">)</span>
        <span class="n">dfiltflags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span><span class="p">)</span>

        <span class="n">default_aids</span> <span class="o">=</span> <span class="n">initial_aids</span>

        <span class="c"># A chain of filters on all of the aids</span>
        <span class="n">global_filter_chain</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">),</span>
            <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c"># Chains of filters individually for each partition</span>
        <span class="n">partition_chains</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
                <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
                <span class="p">(</span><span class="n">sample_annots</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">),</span>
                <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">),</span>
                <span class="c">#(sample_annots_wrt_ref, dcfg),</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="c"># TODO: GENERALIZE GLOBAL FILTER CHAIN</span>
        <span class="k">for</span> <span class="n">filtfn</span><span class="p">,</span> <span class="n">filtcfg</span> <span class="ow">in</span> <span class="n">global_filter_chain</span><span class="p">:</span>
            <span class="n">default_aids</span> <span class="o">=</span> <span class="n">filtfn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">default_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                                  <span class="n">withpre</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span><span class="p">)</span>

        <span class="c"># TODO: GENERALIZE PARTITION FILTER</span>
        <span class="n">default_qaids</span> <span class="o">=</span> <span class="n">default_daids</span> <span class="o">=</span> <span class="n">default_aids</span>
        <span class="n">partition_avail_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_qaids</span><span class="p">,</span> <span class="n">default_daids</span><span class="p">]</span>
        <span class="n">partition_verbflags</span>  <span class="o">=</span> <span class="p">[</span><span class="n">qfiltflags</span><span class="p">,</span> <span class="n">dfiltflags</span><span class="p">]</span>

        <span class="c"># TODO: PARITION FILTER CHAINS</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partition_chains</span><span class="p">)):</span>
            <span class="n">filter_chain</span> <span class="o">=</span> <span class="n">partition_chains</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">_verbflags</span> <span class="o">=</span> <span class="n">partition_verbflags</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">filtfn</span><span class="p">,</span> <span class="n">filtcfg</span> <span class="ow">in</span> <span class="n">filter_chain</span><span class="p">:</span>
                <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">filtfn</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">_verbflags</span><span class="p">)</span>
            <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail_aids</span>

        <span class="c"># TODO: GENERALIZE PARITION REFERENCE SAMPLE?</span>
        <span class="c"># HACK:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">partition_avail_aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_verbflags</span> <span class="o">=</span> <span class="n">partition_verbflags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ref_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">sample_annots_wrt_ref</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">,</span> <span class="n">ref_aids</span><span class="o">=</span><span class="n">ref_aids</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_verbflags</span><span class="p">)</span>
        <span class="n">partition_avail_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail_aids</span>

        <span class="c"># TODO: GENERALIZE SUBINDEX</span>
        <span class="c"># Subindex if requested (typically not done)</span>
        <span class="n">subindex_cfgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">qcfg</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partition_avail_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">_verbflags</span> <span class="o">=</span> <span class="n">partition_verbflags</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">filtcfg</span> <span class="o">=</span> <span class="n">subindex_cfgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">_verbflags</span><span class="p">)</span>
            <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail_aids</span>
        <span class="n">avail_qaids</span><span class="p">,</span> <span class="n">avail_daids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span>

        <span class="c"># Comment out?</span>
        <span class="n">avail_qaids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_qaids</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">qfiltflags</span><span class="p">)</span>
        <span class="n">avail_daids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_daids</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">dfiltflags</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;PRINTING ERROR INFO&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * acfg = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">comp_acfg</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="bp">True</span><span class="p">),))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;Error expanding acfgs&#39;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="n">qaid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_qaids</span><span class="p">)</span>
    <span class="n">daid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_daids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;L___ EXPAND_ACFGS ___&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="c"># Save filter to cache</span>
    <span class="k">if</span> <span class="n">save_cache</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_cache</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span>

</div>
<div class="viewcode-block" id="expand_species"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.expand_species">[docs]</a><span class="k">def</span> <span class="nf">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">avail_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s">&#39;primary&#39;</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_primary_database_species</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">avail_aids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dominant_species</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species</span>

</div>
<span class="nd">@profile</span>
<span class="nd">@register_ibs_method</span>
<div class="viewcode-block" id="filter_annots_independent"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.filter_annots_independent">[docs]</a><span class="k">def</span> <span class="nf">filter_annots_independent</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">,</span> <span class="n">withpre</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot; Filtering that doesn&#39;t have to do with a reference set of aids</span>

<span class="sd">    TODO make filterflags version</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        avail_aids (list):</span>
<span class="sd">        aidcfg (dict):</span>
<span class="sd">        prefix (str): (default = &#39;&#39;)</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: avail_aids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf filter_annots_independent --veryverbtd</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = input_aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = annotation_configs.default[&#39;dcfg&#39;]</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;require_timestamp&#39;] = True</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;require_quality&#39;] = False</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;is_known&#39;] = True</span>
<span class="sd">        &gt;&gt;&gt; prefix = &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = filter_annots_independent(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                                        prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;avail_aids = %s&#39; % (str(avail_aids),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        # Testing tag features</span>
<span class="sd">        python -m ibeis --tf draw_rank_cdf --db PZ_Master1 --show -t best \</span>
<span class="sd">                -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">                ---acfginfo --veryverbtd</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>
    <span class="k">if</span> <span class="n">aidcfg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No annot filter returning&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verbose_context_factory</span><span class="p">(</span>
        <span class="s">&#39;FILTER_INDEPENDENT&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="n">withpre</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;is_known&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;is_known&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_without_name</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;is_known&#39;</span><span class="p">])</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;require_timestamp&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;require_timestamp&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span>
        <span class="n">species</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;species&#39;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_species</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;been_adjusted&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c"># HACK to see if the annotation has been adjusted from the default</span>
        <span class="c"># value set by dbio.ingest_database</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_been_adjusted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;been_adjusted&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contrib_contains&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">contrib_contains</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;contrib_contains&#39;</span><span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">tag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">contrib_contains</span> <span class="ow">in</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;contrib_contains&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;minqual&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;require_quality&#39;</span><span class="p">]:</span>
        <span class="n">minqual</span> <span class="o">=</span> <span class="s">&#39;junk&#39;</span> <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;minqual&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;minqual&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;minqual&#39;</span><span class="p">,</span> <span class="s">&#39;require_quality&#39;</span><span class="p">):</span>
            <span class="c"># Filter quality</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_quality</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;require_quality&#39;</span><span class="p">])</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;max_numfeat&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;min_numfeat&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">max_numfeat</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;max_numfeat&#39;</span><span class="p">]</span>
        <span class="n">min_numfeat</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;min_numfeat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_numfeat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">max_numfeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">min_numfeat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">min_numfeat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">numfeat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">))</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">numfeat_list</span> <span class="o">&gt;=</span> <span class="n">min_numfeat</span><span class="p">,</span>
            <span class="n">numfeat_list</span> <span class="o">&lt;=</span> <span class="n">max_numfeat</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;max_numfeat&#39;</span><span class="p">,</span> <span class="s">&#39;min_numfeat&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;require_viewpoint&#39;</span><span class="p">]:</span>
        <span class="c"># Resolve base viewpoint</span>
        <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;primary&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;primary1&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view&#39;</span><span class="p">]</span>
        <span class="n">view_ext1</span> <span class="o">=</span> <span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext&#39;</span><span class="p">]</span>
                     <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                     <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext1&#39;</span><span class="p">])</span>
        <span class="n">view_ext2</span> <span class="o">=</span> <span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext&#39;</span><span class="p">]</span>
                     <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext2&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                     <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_ext2&#39;</span><span class="p">])</span>
        <span class="n">valid_yaws</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_extended_viewpoints</span><span class="p">(</span>
            <span class="n">view</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="n">view_ext1</span><span class="p">,</span> <span class="n">num2</span><span class="o">=</span><span class="n">view_ext2</span><span class="p">)</span>
        <span class="n">unknown_ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;require_viewpoint&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="s">&#39;require_viewpoint&#39;</span><span class="p">,</span> <span class="s">&#39;view_ext&#39;</span><span class="p">,</span>
                              <span class="s">&#39;view_ext1&#39;</span><span class="p">,</span> <span class="s">&#39;view_ext2&#39;</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="o">=</span><span class="n">valid_yaws</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_viewpoint</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="n">unknown_ok</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;exclude_view&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;view tag resolution of exclude_view&#39;</span><span class="p">)</span>
        <span class="c"># Filter viewpoint</span>
        <span class="c"># TODO need to resolve viewpoints</span>
        <span class="n">exclude_view</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;exclude_view&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;exclude_view&#39;</span><span class="p">,</span> <span class="n">hack</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">remove_aids_of_viewpoint</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">exclude_view</span><span class="p">)</span>

    <span class="c"># FILTER HACK integrating some notion of tag functions</span>
    <span class="c"># TODO: further integrate</span>
    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;has_any&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;has_none&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">filterkw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;has_any&#39;</span><span class="p">,</span> <span class="s">&#39;has_none&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filterkw</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;has_any&#39;</span><span class="p">,</span> <span class="s">&#39;has_none&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="c">#avail_aids = ibs.filter_aids_without_name(</span>
            <span class="c">#    avail_aids, invert=not aidcfg[&#39;is_known&#39;])</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="filter_annots_intragroup"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.filter_annots_intragroup">[docs]</a><span class="k">def</span> <span class="nf">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">,</span> <span class="n">withpre</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    This filters annots using information about the relationships</span>
<span class="sd">    between the annotations in the ``avail_aids`` group. This function is not</span>
<span class="sd">    independent and a second consecutive call may yield new results.</span>
<span class="sd">    Thus, the order in which this filter is applied matters.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_timedelta&#39;] = 60 * 60 * 24</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_pername&#39;] = 3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>

    <span class="k">if</span> <span class="n">aidcfg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;No annot filter returning&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verbose_context_factory</span><span class="p">(</span>
        <span class="s">&#39;FILTER_INTRAGROUP&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="n">withpre</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">],</span> <span class="n">avail_aids</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;same_imageset&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis --tf get_annotcfg_list \</span>
<span class="sd">                -a default:qsame_imageset=True,been_adjusted=True,excluderef=True \</span>
<span class="sd">                --db lynx --veryverbtd --nocache-aid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">same_imageset</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;same_imageset&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">same_imageset</span> <span class="ow">is</span> <span class="bp">True</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_primary_imageset</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">multiprop2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hierarchical_group_items</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">])</span>
        <span class="n">qaid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># TODO: sampling using different enouncters</span>
        <span class="k">for</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">nid2_aids</span> <span class="ow">in</span> <span class="n">multiprop2_aids</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argmax</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
                <span class="n">qaids</span> <span class="o">=</span> <span class="n">aids_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">qaid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;same_imageset&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">qaid_list</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="c"># FIXME: This is NOT an independent filter because it depends on pairwise</span>
    <span class="c"># interactions</span>
    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_pername&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s">&#39;species&#39;</span><span class="p">]</span>
        <span class="c"># This filter removes entire names.  The avaiable aids must be from</span>
        <span class="c"># names with certain viewpoint frequency properties</span>
        <span class="n">prop2_nid2_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_prop_and_name</span><span class="p">(</span>
            <span class="n">avail_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">)</span>

        <span class="n">countstr</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;view_pername&#39;</span><span class="p">]</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">lhs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;primary&#39;</span><span class="p">:</span> <span class="n">primary_viewpoint</span><span class="p">,</span>
            <span class="s">&#39;primary1&#39;</span><span class="p">:</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_extended_viewpoints</span><span class="p">(</span>
                <span class="n">primary_viewpoint</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include_base</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">CountstrParser</span><span class="p">(</span><span class="n">lhs_dict</span><span class="p">,</span> <span class="n">prop2_nid2_aids</span><span class="p">)</span>
        <span class="n">nid2_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_countstr_expr</span><span class="p">(</span><span class="n">countstr</span><span class="p">)</span>
        <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name_dict</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">valid_nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">nid2_flag</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">flag</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;view_pername&#39;</span><span class="p">,</span> <span class="n">countstr</span><span class="o">=</span><span class="n">countstr</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">))</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;min_timedelta&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">min_timedelta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_timedelta</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;min_timedelta&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;min_timedelta&#39;</span><span class="p">,</span> <span class="n">min_timedelta</span><span class="o">=</span><span class="n">min_timedelta</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_using_minimum_timedelta</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">min_timedelta</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="c"># Each aid must have at least this number of other groundtruth aids</span>
    <span class="n">min_pername</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;min_pername&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">min_pername</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span>
                                                 <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;min_pername&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span>
                <span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">grouped_aids_</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_pername</span><span class="p">])</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span>

</div>
<div class="viewcode-block" id="get_reference_preference_order"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.get_reference_preference_order">[docs]</a><span class="k">def</span> <span class="nf">get_reference_preference_order</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gt_ref_grouped_aids</span><span class="p">,</span>
                                   <span class="n">gt_avl_grouped_aids</span><span class="p">,</span> <span class="n">prop_getter</span><span class="p">,</span> <span class="n">cmp_func</span><span class="p">,</span>
                                   <span class="n">aggfn</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Orders preference for sampling based on some metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>
    <span class="n">grouped_reference_unixtimes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">prop_getter</span><span class="p">,</span> <span class="n">gt_ref_grouped_aids</span><span class="p">)</span>
    <span class="n">grouped_available_gt_unixtimes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">prop_getter</span><span class="p">,</span> <span class="n">gt_avl_grouped_aids</span><span class="p">)</span>

    <span class="n">grouped_reference_props</span> <span class="o">=</span> <span class="n">grouped_reference_unixtimes</span>
    <span class="n">grouped_available_gt_props</span> <span class="o">=</span> <span class="n">grouped_available_gt_unixtimes</span>

    <span class="c"># Order the available aids by some aggregation over some metric</span>
    <span class="n">preference_scores</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aggfn</span><span class="p">(</span><span class="n">cmp_func</span><span class="p">(</span><span class="n">ref_prop</span><span class="p">,</span> <span class="n">avl_prop</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ref_prop</span><span class="p">,</span> <span class="n">avl_prop</span> <span class="ow">in</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_reference_props</span><span class="p">,</span> <span class="n">grouped_available_gt_props</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c"># Order by increasing timedelta (metric)</span>
    <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span>
        <span class="n">preference_scores</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gt_preference_idx_list</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="sample_annots_wrt_ref"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.sample_annots_wrt_ref">[docs]</a><span class="k">def</span> <span class="nf">sample_annots_wrt_ref</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">ref_aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sampling when a reference set is given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_per_name</span>     <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_per_name&#39;</span><span class="p">]</span>
    <span class="n">sample_per_ref_name</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_per_ref_name&#39;</span><span class="p">]</span>
    <span class="n">exclude_reference</span>   <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;exclude_reference&#39;</span><span class="p">]</span>
    <span class="n">sample_size</span>         <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
    <span class="n">offset</span>              <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_offset&#39;</span><span class="p">]</span>
    <span class="n">sample_rule_ref</span>     <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_rule_ref&#39;</span><span class="p">]</span>
    <span class="n">sample_rule</span>         <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_rule&#39;</span><span class="p">]</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
    <span class="n">ref_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verbose_context_factory</span><span class="p">(</span>
        <span class="s">&#39;SAMPLE (REF)&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">sample_per_ref_name</span> <span class="o">=</span> <span class="n">sample_per_name</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">exclude_reference</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ref_aids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s">&#39;ref_aids=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ref_aids</span><span class="p">,))</span>
        <span class="c"># VerbosityContext.report_annot_stats(ibs, avail_aids, prefix, &#39;&#39;)</span>
        <span class="c"># VerbosityContext.report_annot_stats(ibs, ref_aids, prefix, &#39;&#39;)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;exclude_reference&#39;</span><span class="p">,</span>
                              <span class="n">num_ref_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">ref_aids</span><span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
            <span class="c"># HACK:</span>
            <span class="c">#also_exclude_overlaps = ibs.get_dbname() == &#39;Oxford&#39;</span>
            <span class="n">also_exclude_overlaps</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">also_exclude_overlaps</span><span class="p">:</span>
                <span class="n">contact_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_contact_aids</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">avail_aids</span><span class="p">)</span>
                <span class="c"># Disallow the same name in the same image</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">,</span> <span class="n">contact_aids_list</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)</span>
                <span class="n">sameimg_samename_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="o">==</span> <span class="n">y0</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contact_aids_list</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)])</span>

            <span class="c">#contact_aids = ut.flatten(contact_aids_list)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">sameimg_samename_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_float</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>
        <span class="c"># A float sample size is a interpolations between full data and small</span>
        <span class="c"># data</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_size</span> <span class="o">+</span>
                                 <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sample_size</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Expanding sample size to: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,))</span>

    <span class="c"># This function first partitions aids into a one set that corresonds with</span>
    <span class="c"># the reference set and another that does not correspond with the reference</span>
    <span class="c"># set. The rest of the filters operate on these sets independently</span>
    <span class="n">partitioned_sets</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">partition_annots_into_corresponding_groups</span><span class="p">(</span>
        <span class="n">ref_aids</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">)</span>
    <span class="c"># items</span>
    <span class="c"># [0], and [1] are corresponding lists of annot groups</span>
    <span class="c"># [2], and [3] are non-corresonding annot groups</span>
    <span class="p">(</span><span class="n">gt_ref_grouped_aids</span><span class="p">,</span> <span class="n">gt_avl_grouped_aids</span><span class="p">,</span>
     <span class="n">gf_ref_grouped_aids</span><span class="p">,</span> <span class="n">gf_avl_grouped_aids</span><span class="p">)</span> <span class="o">=</span> <span class="n">partitioned_sets</span>

    <span class="k">if</span> <span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_rule_ref</span> <span class="o">==</span> <span class="s">&#39;maxtimedelta&#39;</span><span class="p">:</span>
            <span class="c"># Maximize time delta between query and corresponding database</span>
            <span class="c"># annotations</span>
            <span class="n">cmp_func</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">absdiff</span>
            <span class="n">aggfn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
            <span class="n">prop_getter</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span>
            <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="n">get_reference_preference_order</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">gt_ref_grouped_aids</span><span class="p">,</span> <span class="n">gt_avl_grouped_aids</span><span class="p">,</span> <span class="n">prop_getter</span><span class="p">,</span>
                <span class="n">cmp_func</span><span class="p">,</span> <span class="n">aggfn</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sample_rule_ref</span> <span class="o">==</span> <span class="s">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">gt_avl_grouped_aids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown sample_rule_ref = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">sample_rule_ref</span><span class="p">,))</span>
        <span class="n">gt_sample_idxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column_slice</span><span class="p">(</span>
            <span class="n">gt_preference_idx_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_ref_name</span><span class="p">)</span>
        <span class="n">gt_sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">,</span>
                                         <span class="n">gt_sample_idxs_list</span><span class="p">)</span>
        <span class="n">gt_avl_grouped_aids</span> <span class="o">=</span> <span class="n">gt_sample_aids</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;sample_per_ref_name&#39;</span><span class="p">,</span> <span class="s">&#39;sample_rule_ref&#39;</span><span class="p">,</span>
                              <span class="s">&#39;sample_offset&#39;</span><span class="p">,</span>
                              <span class="n">sample_per_ref_name</span><span class="o">=</span><span class="n">sample_per_ref_name</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sample_per_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># sample rule is always random for gf right now</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">gf_preference_idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">gf_avl_grouped_aids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown sample_rule=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_rule</span><span class="p">,))</span>
        <span class="n">gf_sample_idxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column_slice</span><span class="p">(</span>
            <span class="n">gf_preference_idx_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_name</span><span class="p">)</span>
        <span class="n">gf_sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">,</span>
                                         <span class="n">gf_sample_idxs_list</span><span class="p">)</span>
        <span class="n">gf_avl_grouped_aids</span> <span class="o">=</span> <span class="n">gf_sample_aids</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;sample_per_name&#39;</span><span class="p">,</span> <span class="s">&#39;sample_rule&#39;</span><span class="p">,</span>
                              <span class="s">&#39;sample_offset&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">))</span>

    <span class="n">gt_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span>
    <span class="n">gf_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Keep all correct matches to the reference set</span>
        <span class="c"># We have the option of keeping ground false</span>
        <span class="n">num_gt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_avl_aids</span><span class="p">)</span>
        <span class="n">num_gf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gf_avl_aids</span><span class="p">)</span>
        <span class="n">num_keep_gf</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">-</span> <span class="n">num_gt</span>
        <span class="n">num_remove_gf</span> <span class="o">=</span> <span class="n">num_gf</span> <span class="o">-</span> <span class="n">num_keep_gf</span>
        <span class="k">if</span> <span class="n">num_remove_gf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Too few ground false</span>
            <span class="k">print</span><span class="p">((</span><span class="s">&#39;Warning: Cannot meet sample_size=</span><span class="si">%r</span><span class="s">. available_</span><span class="si">%s</span><span class="s">aids &#39;</span>
                   <span class="s">&#39;will be undersized by at least </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">-</span><span class="n">num_remove_gf</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">num_keep_gf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Too many multitons; Can never remove a multiton</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning: Cannot meet sample_size=</span><span class="si">%r</span><span class="s">. available_</span><span class="si">%s</span><span class="s">aids &#39;</span>
                  <span class="s">&#39;will be oversized by at least </span><span class="si">%d</span><span class="s">&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">-</span><span class="n">num_keep_gf</span><span class="p">,))</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="n">gf_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">gf_avl_aids</span><span class="p">,</span> <span class="n">num_keep_gf</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="c"># random ordering makes for bad hashes</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;sample_size&#39;</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
                              <span class="n">num_remove_gf</span><span class="o">=</span><span class="n">num_remove_gf</span><span class="p">,</span>
                              <span class="n">num_keep_gf</span><span class="o">=</span><span class="n">num_keep_gf</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">gt_avl_aids</span> <span class="o">+</span> <span class="n">gf_avl_aids</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gt_avl_aids</span> <span class="o">+</span> <span class="n">gf_avl_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="sample_annots"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.sample_annots">[docs]</a><span class="k">def</span> <span class="nf">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sampling preserves input sample structure and thust does not always return</span>
<span class="sd">    exact values</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis --tf sample_annots --veryverbtd</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = ibeis.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = input_aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = copy.deepcopy(annotation_configs.default[&#39;dcfg&#39;])</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;sample_per_name&#39;] = 3</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;sample_size&#39;] = 10</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_pername&#39;] = 2</span>
<span class="sd">        &gt;&gt;&gt; prefix = &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = filter_annots_independent(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                                        prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = sample_annots(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                            prefix, avail_aids)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;avail_aids = %s&#39; % (str(avail_aids),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="kn">as</span> <span class="nn">vt</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verbose_context_factory</span><span class="p">(</span>
        <span class="s">&#39;SAMPLE (NOREF)&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">()</span>

    <span class="n">sample_rule</span>     <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_rule&#39;</span><span class="p">]</span>
    <span class="n">sample_per_name</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_per_name&#39;</span><span class="p">]</span>
    <span class="n">sample_size</span>     <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_size&#39;</span><span class="p">]</span>
    <span class="n">offset</span>          <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;sample_offset&#39;</span><span class="p">]</span>

    <span class="n">unflat_get_annot_unixtimes</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">sample_per_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># For the query we just choose a single annot per name</span>
        <span class="c"># For the database we have to do something different</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># Order based on some preference (like random)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED1</span><span class="p">)</span>
        <span class="c"># + --- Get nested sample indicies ---</span>
        <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">grouped_aids</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s">&#39;mintime&#39;</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">unflat_get_annot_unixtimes</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span>
                                                     <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s">&#39;maxtime&#39;</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">unflat_get_annot_unixtimes</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span>
                                                     <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown sample_rule=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_rule</span><span class="p">,))</span>
        <span class="c"># L ___</span>
        <span class="n">sample_idxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column_slice</span><span class="p">(</span>
            <span class="n">preference_idxs_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_name</span><span class="p">)</span>
        <span class="n">sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">sample_idxs_list</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;sample_per_name&#39;</span><span class="p">,</span> <span class="s">&#39;sample_rule&#39;</span><span class="p">,</span>
                              <span class="s">&#39;sample_offset&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_aids</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># BUG: Should sample annots while preserving name size</span>
        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="n">avail_aids</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Warning sample size too large&#39;</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>

        <span class="c"># Randomly sample names rather than annotations this makes sampling a</span>
        <span class="c"># knapsack problem. Use a random greedy solution</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># knapsack items values and weights are are num annots per name</span>
        <span class="n">knapsack_items</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">count</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">aids</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)]</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">deterministic_shuffle</span><span class="p">(</span><span class="n">knapsack_items</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">total_value</span><span class="p">,</span> <span class="n">items_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">knapsack_greedy</span><span class="p">(</span><span class="n">knapsack_items</span><span class="p">,</span>
                                                       <span class="n">sample_size</span><span class="p">)</span>
        <span class="n">group_idx_sample</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">items_subset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">subgroup_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">group_idx_sample</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;sample_size&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">subgroup_aids</span><span class="p">)</span>
            <span class="c">#avail_aids = ut.random_sample(avail_aids, sample_size, rng=rng)</span>
        <span class="k">if</span> <span class="n">total_value</span> <span class="o">!=</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Sampling could not get exactly right sample size&#39;</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span>

</div>
<span class="nd">@profile</span>
<div class="viewcode-block" id="subindex_annots"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.subindex_annots">[docs]</a><span class="k">def</span> <span class="nf">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">ref_aids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns exact subindex of annotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verbose_context_factory</span><span class="p">(</span>
        <span class="s">&#39;SUBINDEX&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;shuffle&#39;</span><span class="p">]:</span>
        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;shuffle&#39;</span><span class="p">,</span> <span class="n">SEED2</span><span class="o">=</span><span class="n">SEED2</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">rand_idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;index&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">indicies</span> <span class="o">=</span> <span class="n">ensure_flatlistlike</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s">&#39;index&#39;</span><span class="p">])</span>
        <span class="n">_indexed_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">avail_aids</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">indicies</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="n">subset_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_indexed_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">_indexed_aids</span>

    <span class="c"># Always sort aids to preserve hashes? (Maybe sort the vuuids instead)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">(</span><span class="n">withpost</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avail_aids</span>

</div>
<div class="viewcode-block" id="ensure_flatiterable"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.ensure_flatiterable">[docs]</a><span class="k">def</span> <span class="nf">ensure_flatiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">fuzzy_int</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">input_</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="c">#print(input_)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;cannot ensure </span><span class="si">%r</span><span class="s"> input_=</span><span class="si">%r</span><span class="s"> is iterable&#39;</span><span class="p">,</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">input_</span><span class="p">),</span> <span class="n">input_</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="ensure_flatlistlike"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.ensure_flatlistlike">[docs]</a><span class="k">def</span> <span class="nf">ensure_flatlistlike</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
    <span class="c">#if isinstance(input_, slice):</span>
    <span class="c">#    pass</span>
    <span class="n">iter_</span> <span class="o">=</span> <span class="n">ensure_flatiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_</span><span class="p">)</span>

</div>
<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<div class="viewcode-block" id="CountstrParser"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.CountstrParser">[docs]</a><span class="k">class</span> <span class="nc">CountstrParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">numop</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span>
    <span class="n">compare_op_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;&lt;&#39;</span>  <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
        <span class="s">&#39;&lt;=&#39;</span> <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
        <span class="s">&#39;&gt;&#39;</span>  <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
        <span class="s">&#39;&gt;=&#39;</span> <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
        <span class="s">&#39;=&#39;</span>  <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
        <span class="s">&#39;!=&#39;</span> <span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs_dict</span><span class="p">,</span> <span class="n">prop2_nid2_aids</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs_dict</span> <span class="o">=</span> <span class="n">lhs_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop2_nid2_aids</span> <span class="o">=</span> <span class="n">prop2_nid2_aids</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="CountstrParser.parse_countstr_binop"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.CountstrParser.parse_countstr_binop">[docs]</a>    <span class="k">def</span> <span class="nf">parse_countstr_binop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
        <span class="c"># Parse binary comparison operation</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">regex_or</span><span class="p">((</span><span class="s">&#39;[&lt;&gt;]=?&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">)),</span> <span class="n">part</span><span class="p">)</span>
        <span class="c"># Parse length operation. Get prop_left_nids, prop_left_values</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numop</span><span class="p">):</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="n">left</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numop</span><span class="p">):]</span>
            <span class="c"># Parse varname</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="c"># Apply length operator to each name with the prop</span>
            <span class="n">prop_left_nids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop2_nid2_aids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">valiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop2_nid2_aids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">prop_left_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">valiter</span><span class="p">)))</span>
        <span class="c"># Pares number</span>
        <span class="k">if</span> <span class="n">right</span><span class="p">:</span>
            <span class="n">prop_right_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="c"># Execute comparison</span>
        <span class="n">prop_binary_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_op_map</span><span class="p">[</span><span class="n">op</span><span class="p">](</span>
            <span class="n">prop_left_values</span><span class="p">,</span> <span class="n">prop_right_value</span><span class="p">)</span>
        <span class="n">prop_nid2_result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prop_left_nids</span><span class="p">,</span> <span class="n">prop_binary_result</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">prop_nid2_result</span>
</div>
<div class="viewcode-block" id="CountstrParser.parse_countstr_expr"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.CountstrParser.parse_countstr_expr">[docs]</a>    <span class="k">def</span> <span class="nf">parse_countstr_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">countstr</span><span class="p">):</span>
        <span class="c"># Split over ands for now</span>
        <span class="n">and_parts</span> <span class="o">=</span> <span class="n">countstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)</span>
        <span class="n">prop_nid2_result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">and_parts</span><span class="p">:</span>
            <span class="n">prop_nid2_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_countstr_binop</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="n">prop_nid2_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_nid2_result</span><span class="p">)</span>
        <span class="c"># change to dict_union when parsing ors</span>
        <span class="n">andcombine</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect_combine</span><span class="p">,</span> <span class="n">combine_op</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">)</span>
        <span class="n">expr_nid2_result</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">andcombine</span><span class="p">,</span> <span class="n">prop_nid2_result_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr_nid2_result</span>

</div></div>
<div class="viewcode-block" id="verbose_context_factory"><a class="viewcode-back" href="../../../ibeis.init.html#ibeis.init.filter_annots.verbose_context_factory">[docs]</a><span class="k">def</span> <span class="nf">verbose_context_factory</span><span class="p">(</span><span class="n">filtertype</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; closure helper &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">VerbosityContext</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        very hacky way of printing info so we dont pollute the actual function</span>
<span class="sd">        too much</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name_suffix</span><span class="p">,</span> <span class="n">statskw</span><span class="o">=</span><span class="p">{}):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">]  &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),)):</span>
                    <span class="c"># TODO: helpx on statskw</span>
                    <span class="c">#statskw = dict(per_name_vpedge=None, per_name=None)</span>
                    <span class="n">dict_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;aid_stats&#39;</span> <span class="o">+</span> <span class="n">name_suffix</span>
                    <span class="c">#hashid, per_name, per_qual, per_vp, per_name_vpedge,</span>
                    <span class="c">#per_image, min_name_hourdist</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">print_annot_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">dict_name</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">statskw</span><span class="p">)</span>

        <span class="c">#def report_annotconfig_stats(ref_aids, aids):</span>
        <span class="c">#    with ut.Indenter(&#39;  &#39;):</span>
        <span class="c">#        ibs.print_annotconfig_stats(ref_aids, avail_aids)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] * [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">AIDS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">filtertype</span><span class="p">,</span>
                                              <span class="n">prefix</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">withpre</span><span class="p">:</span>
                    <span class="n">ibs</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;ibs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">aids</span>   <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                                                        <span class="s">&#39;_pre&#39;</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">endfilter</span><span class="p">(</span><span class="n">withpost</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">ibs</span>    <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;ibs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">aids</span>   <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">hashid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_hashid_semantic_uuid</span><span class="p">(</span>
                    <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">withpost</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                                                            <span class="s">&#39;_post&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] * HAHID: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">hashid</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] * [</span><span class="si">%s</span><span class="s">]: len(avail_</span><span class="si">%s</span><span class="s">aids) = </span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">filtertype</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">filterextra</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">dictkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nobraces</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">infostr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">subdict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
                    <span class="n">infostr</span> <span class="o">+=</span> <span class="s">&#39;&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="o">**</span><span class="n">dictkw</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] * Filter by </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">infostr</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">filterextra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">infostr2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">filterextra</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">]      </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">infostr2</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">num_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
                <span class="n">num_removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_before</span> <span class="o">-</span> <span class="n">num_after</span>
                <span class="k">if</span> <span class="n">num_removed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">]   ... removed </span><span class="si">%d</span><span class="s"> annots. </span><span class="si">%d</span><span class="s"> remain&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">num_removed</span><span class="p">,</span> <span class="n">num_after</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">VerbosityContext</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.init.filter_annots</span>
<span class="sd">        python -m ibeis.init.filter_annots --allexamples</span>
<span class="sd">        python -m ibeis.init.filter_annots --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.5.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>