

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.scripts.thesis &mdash; ibeis 1.9.0.vulcan documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.9.0.vulcan
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ibeis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../ibeis.html">ibeis</a> &raquo;</li>
        
      <li>ibeis.scripts.thesis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.scripts.thesis</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>  <span class="c1"># NOQA</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.verif</span> <span class="k">import</span> <span class="n">vsone</span>
<span class="kn">from</span> <span class="nn">ibeis.scripts._thesis_helpers</span> <span class="k">import</span> <span class="n">DBInputs</span>
<span class="kn">from</span> <span class="nn">ibeis.scripts._thesis_helpers</span> <span class="k">import</span> <span class="n">Tabular</span><span class="p">,</span> <span class="n">upper_one</span><span class="p">,</span> <span class="n">ave_str</span>
<span class="kn">from</span> <span class="nn">ibeis.scripts._thesis_helpers</span> <span class="k">import</span> <span class="n">TMP_RC</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">DPI</span>
<span class="kn">import</span> <span class="nn">ibeis.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.graph</span> <span class="k">import</span> <span class="n">nx_utils</span> <span class="k">as</span> <span class="n">nxu</span>
<span class="kn">import</span> <span class="nn">ubelt</span> <span class="k">as</span> <span class="nn">ub</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">exists</span>  <span class="c1"># NOQA</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.graph.state</span> <span class="k">import</span> <span class="n">POSTV</span><span class="p">,</span> <span class="n">NEGTV</span><span class="p">,</span> <span class="n">INCMP</span><span class="p">,</span> <span class="n">UNREV</span>  <span class="c1"># NOQA</span>
<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Chap5"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">Chap5</span><span class="p">(</span><span class="n">DBInputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python -m ibeis Chap5.measure all GZ_Master1</span>
<span class="sd">    python -m ibeis Chap5.measure all PZ_Master1</span>
<span class="sd">    python -m ibeis Chap5.draw all GZ_Master1</span>
<span class="sd">    python -m ibeis Chap5.draw all PZ_Master1 --comp Leviathan</span>

<span class="sd">    python -m ibeis Chap5.draw error_graph_analysis GZ_Master1</span>
<span class="sd">    python -m ibeis Chap5.draw error_graph_analysis PZ_Master1 --comp Leviathan</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/latex/crall-thesis-2017/figures5&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Chap5.measure_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.measure_all">[docs]</a>    <span class="k">def</span> <span class="nf">measure_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_dbstats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_simulation</span><span class="p">()</span></div>

<div class="viewcode-block" id="Chap5.draw_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.draw_all">[docs]</a>    <span class="k">def</span> <span class="nf">draw_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw all GZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.draw error_graph_analysis GZ_Master1</span>

<span class="sd">            python -m ibeis Chap5.draw all PZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.draw error_graph_analysis PZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_simulation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_dbstats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_error_tables</span><span class="p">()</span></div>
        <span class="c1"># python -m ibeis Chap5.draw error_graph_analysis GZ_Master1</span>

    <span class="k">def</span> <span class="nf">_precollect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_Chap5</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">fix_super_reload</span><span class="p">(</span><span class="n">Chap5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">_Chap5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>

        <span class="c1"># Split data into a training and testing test</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">nids</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">321</span><span class="p">)</span>
        <span class="n">train_names</span><span class="p">,</span> <span class="n">test_names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">train_aids</span><span class="p">,</span> <span class="n">test_aids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="p">(</span><span class="n">train_names</span><span class="p">,</span> <span class="n">test_names</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_train</span> <span class="o">=</span> <span class="n">train_aids</span><span class="p">,</span> <span class="n">test_aids</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;PZ_MTEST&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sample_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span> <span class="o">=</span> <span class="n">vsone</span><span class="o">.</span><span class="n">OneVsOneProblem</span><span class="o">.</span><span class="n">from_aids</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">train_aids</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># ut.get_nonconflicting_path(dpath, suffix=&#39;_old&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const_dials</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &#39;oracle_accuracy&#39; : (0.98, 1.0),</span>
            <span class="c1"># &#39;oracle_accuracy&#39; : (0.98, .98),</span>
            <span class="s1">&#39;oracle_accuracy&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="o">.</span><span class="mi">99</span><span class="p">),</span>
            <span class="s1">&#39;k_redun&#39;</span>         <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;max_outer_loops&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="c1"># &#39;max_outer_loops&#39; : 1,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;GZ_Master1&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">0014</span><span class="p">),</span>
                <span class="s1">&#39;rankclf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">001</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;PZ_Master1&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># &#39;graph&#39;: (&#39;fpr&#39;, .03),</span>
                <span class="c1"># &#39;rankclf&#39;: (&#39;fpr&#39;, .01),</span>
                <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">0014</span><span class="p">),</span>
                <span class="s1">&#39;rankclf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">001</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">002</span><span class="p">),</span>
                <span class="s1">&#39;rankclf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const_dials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span><span class="p">)</span>
        <span class="n">cfg_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_aids</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_links</span><span class="p">(</span><span class="n">cfg_prefix</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap5._setup</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; #self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; #self = Chap5(&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._setup()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>
        <span class="n">train_aids</span><span class="p">,</span> <span class="n">test_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_train</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span>

        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_data_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">with_simple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">learn_evaluation_classifiers</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
        <span class="c1"># pblm.report_evaluation()</span>

        <span class="c1"># if False:</span>
        <span class="c1">#     pblm.learn_evaluation_classifiers(task_keys=[&#39;photobomb_state&#39;])</span>
        <span class="c1">#     pb_res = pblm.task_combo_res[&#39;photobomb_state&#39;][clf_key][data_key]</span>
        <span class="c1">#     pb_res  # TODO?</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Remove results that are photobombs for now</span>
            <span class="c1"># res = pblm.task_combo_res[&#39;photobomb_state&#39;][clf_key][data_key]</span>
            <span class="n">pb_task</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="s1">&#39;photobomb_state&#39;</span><span class="p">]</span>
            <span class="kn">import</span> <span class="nn">utool</span>
            <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">pb_task</span><span class="o">.</span><span class="n">indicator_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;notpb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">notpb_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">notpb_res</span>

        <span class="c1"># TODO: need more principled way of selecting thresholds</span>
        <span class="n">graph_thresh</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_pos_threshes</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">rankclf_thresh</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_pos_threshes</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">thresh_targets</span><span class="p">[</span><span class="s1">&#39;rankclf&#39;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- Graph thresholds ---&#39;</span><span class="p">)</span>
        <span class="n">graph_report</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">report_auto_thresholds</span><span class="p">(</span><span class="n">graph_thresh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> --- Ranking thresholds ---&#39;</span><span class="p">)</span>
        <span class="n">rankclf_report</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">report_auto_thresholds</span><span class="p">(</span><span class="n">rankclf_thresh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;thresh_reports.txt&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                       <span class="s1">&#39;============&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Graph report&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;------------&#39;</span><span class="p">,</span>
                       <span class="n">graph_report</span><span class="p">,</span>
                       <span class="s1">&#39;&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;============&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Rank CLF report&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;------------&#39;</span><span class="p">,</span>
                       <span class="n">rankclf_report</span><span class="p">,</span>
                   <span class="p">]))</span>

        <span class="c1"># Load or create the deploy classifiers</span>
        <span class="n">clf_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;clf&#39;</span><span class="p">))</span>
        <span class="n">classifiers</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">ensure_deploy_classifiers</span><span class="p">(</span><span class="n">dpath</span><span class="o">=</span><span class="n">clf_dpath</span><span class="p">)</span>

        <span class="n">sim_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test_aids&#39;</span><span class="p">:</span> <span class="n">test_aids</span><span class="p">,</span>
            <span class="s1">&#39;train_aids&#39;</span><span class="p">:</span> <span class="n">train_aids</span><span class="p">,</span>
            <span class="s1">&#39;classifiers&#39;</span><span class="p">:</span> <span class="n">classifiers</span><span class="p">,</span>
            <span class="s1">&#39;graph_thresh&#39;</span><span class="p">:</span> <span class="n">graph_thresh</span><span class="p">,</span>
            <span class="s1">&#39;rankclf_thresh&#39;</span><span class="p">:</span> <span class="n">rankclf_thresh</span><span class="p">,</span>
            <span class="s1">&#39;const_dials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_dials</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span> <span class="o">=</span> <span class="n">pblm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span> <span class="o">=</span> <span class="n">sim_params</span>
        <span class="k">return</span> <span class="n">sim_params</span>

    <span class="k">def</span> <span class="nf">_thresh_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_setup</span><span class="p">()</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">report_evaluation</span><span class="p">()</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Remove results that are photobombs for now</span>
            <span class="c1"># res = pblm.task_combo_res[&#39;photobomb_state&#39;][clf_key][data_key]</span>
            <span class="n">pb_task</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="s1">&#39;photobomb_state&#39;</span><span class="p">]</span>
            <span class="kn">import</span> <span class="nn">utool</span>
            <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">pb_task</span><span class="o">.</span><span class="n">indicator_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;notpb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">notpb_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">notpb_res</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PLAN:</span>
<span class="sd">            Draw an LNBNN sample.</span>
<span class="sd">            Estimate probabilities on sample.</span>

<span class="sd">            for each fpr on validation,</span>
<span class="sd">                find threshold</span>
<span class="sd">                find fpr at that threshold for the lnbnn sample</span>

<span class="sd">            plot the predicted fpr vs the true fpr to show that this is</span>
<span class="sd">            difficult to predict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">sim_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span>
        <span class="n">classifiers</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;classifiers&#39;</span><span class="p">]</span>
        <span class="n">test_aids</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;test_aids&#39;</span><span class="p">]</span>
        <span class="n">const_dials</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;const_dials&#39;</span><span class="p">]</span>

        <span class="n">graph_thresh</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;graph_thresh&#39;</span><span class="p">]</span>

        <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># ----------</span>
        <span class="c1"># Graph test</span>
        <span class="n">dials1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">const_dials</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span>               <span class="p">:</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_inference&#39;</span>   <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;match_state_thresh&#39;</span> <span class="p">:</span> <span class="n">graph_thresh</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">infr1</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">test_aids</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">estimate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confusions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">target_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">001</span><span class="p">,</span> <span class="o">.</span><span class="mi">0012</span><span class="p">,</span> <span class="o">.</span><span class="mi">0014</span><span class="p">,</span> <span class="o">.</span><span class="mi">0016</span><span class="p">,</span> <span class="o">.</span><span class="mi">002</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">target_values</span><span class="p">:</span>
            <span class="n">match_thresh</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_pos_threshes</span><span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="n">estimate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">thresh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_thresh</span><span class="p">)</span>

            <span class="n">infr1</span><span class="o">.</span><span class="n">enable_auto_prioritize_nonpos</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">init_simulation</span><span class="p">(</span><span class="n">classifiers</span><span class="o">=</span><span class="n">classifiers</span><span class="p">,</span> <span class="o">**</span><span class="n">dials1</span><span class="p">)</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">init_test_mode</span><span class="p">()</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">)</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">task_thresh</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_thresh</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">enable_fixredun</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">infr1</span><span class="o">.</span><span class="n">main_loop</span><span class="p">(</span><span class="n">max_loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># for e in infr1.edges():</span>
            <span class="c1">#     decision = infr1.get_edge_data(e).get(&#39;decision&#39;, UNREV)</span>
            <span class="c1">#     truth = infr1.get_edge_data(e).get(&#39;truth&#39;, None)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">infr1</span><span class="o">.</span><span class="n">test_state</span><span class="p">[</span><span class="s1">&#39;confusion&#39;</span><span class="p">])</span>
            <span class="n">confusions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">actual_fpr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">actual_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">est</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">estimate</span><span class="p">,</span> <span class="n">confusions</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># n_total = c.sum().sum()</span>
            <span class="c1"># n_true = np.diag(c).sum()</span>
            <span class="c1"># n_false = n_total - n_true</span>
            <span class="c1"># tpa = n_true / n_total</span>
            <span class="c1"># fpr = n_false / n_total</span>
            <span class="c1"># pos_fpr = (c.loc[POSTV].sum() - c.loc[POSTV][POSTV]) / c.loc[POSTV].sum()</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># NOQA</span>
            <span class="n">FP</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fpr</span> <span class="o">=</span> <span class="n">FP</span> <span class="o">/</span> <span class="n">N</span>
            <span class="c1"># tpas.append(tpa)</span>
            <span class="n">actual_fpr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>
            <span class="n">actual_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NEGTV</span><span class="p">,</span> <span class="n">POSTV</span><span class="p">]:</span>
            <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresh</span><span class="p">]</span>
            <span class="c1"># class_nums = np.array([n[class_name] for n in actual_nums])</span>
            <span class="n">class_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actual_fpr</span><span class="p">])</span>
            <span class="n">class_est</span> <span class="o">=</span> <span class="n">target_values</span>

            <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">class_est</span><span class="p">,</span> <span class="s1">&#39;x--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;est &#39;</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">class_actual</span><span class="p">,</span> <span class="s1">&#39;o--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;actual &#39;</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<div class="viewcode-block" id="Chap5.measure_simulation"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.measure_simulation">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">measure_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.measure simulation GZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.measure simulation PZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_setup</span><span class="p">()</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">sim_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span>
        <span class="n">classifiers</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;classifiers&#39;</span><span class="p">]</span>
        <span class="n">test_aids</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;test_aids&#39;</span><span class="p">]</span>

        <span class="n">rankclf_thresh</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;rankclf_thresh&#39;</span><span class="p">]</span>
        <span class="n">graph_thresh</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;graph_thresh&#39;</span><span class="p">]</span>

        <span class="n">const_dials</span> <span class="o">=</span> <span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;const_dials&#39;</span><span class="p">]</span>

        <span class="n">sim_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># ----------</span>
        <span class="c1"># Graph test</span>
        <span class="n">dials1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">const_dials</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span>               <span class="p">:</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_inference&#39;</span>   <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;match_state_thresh&#39;</span> <span class="p">:</span> <span class="n">graph_thresh</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">infr1</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">test_aids</span><span class="p">,</span> <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">enable_auto_prioritize_nonpos</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">_refresh_params</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="n">infr1</span><span class="o">.</span><span class="n">init_simulation</span><span class="p">(</span><span class="n">classifiers</span><span class="o">=</span><span class="n">classifiers</span><span class="p">,</span> <span class="o">**</span><span class="n">dials1</span><span class="p">)</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">init_test_mode</span><span class="p">()</span>

        <span class="n">infr1</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">)</span>
        <span class="n">infr1</span><span class="o">.</span><span class="n">main_loop</span><span class="p">()</span>

        <span class="n">sim_results</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_sim_results</span><span class="p">(</span><span class="n">infr1</span><span class="p">,</span> <span class="n">dials1</span><span class="p">)</span>

        <span class="c1"># --------</span>
        <span class="c1"># Rank+CLF</span>
        <span class="n">dials2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">const_dials</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span>               <span class="p">:</span> <span class="s1">&#39;rank+clf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_inference&#39;</span>   <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;match_state_thresh&#39;</span> <span class="p">:</span> <span class="n">rankclf_thresh</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">infr2</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">test_aids</span><span class="p">,</span>
                                     <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">infr2</span><span class="o">.</span><span class="n">init_simulation</span><span class="p">(</span><span class="n">classifiers</span><span class="o">=</span><span class="n">classifiers</span><span class="p">,</span> <span class="o">**</span><span class="n">dials2</span><span class="p">)</span>
        <span class="n">infr2</span><span class="o">.</span><span class="n">init_test_mode</span><span class="p">()</span>
        <span class="n">infr2</span><span class="o">.</span><span class="n">enable_redundancy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">infr2</span><span class="o">.</span><span class="n">enable_autoreview</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">infr2</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">)</span>

        <span class="n">infr2</span><span class="o">.</span><span class="n">main_loop</span><span class="p">(</span><span class="n">max_loops</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">sim_results</span><span class="p">[</span><span class="s1">&#39;rank+clf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_sim_results</span><span class="p">(</span><span class="n">infr2</span><span class="p">,</span> <span class="n">dials2</span><span class="p">)</span>

        <span class="c1"># ------------</span>
        <span class="c1"># Ranking test</span>
        <span class="n">dials3</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">const_dials</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span>               <span class="p">:</span> <span class="s1">&#39;ranking&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_inference&#39;</span>   <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;match_state_thresh&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">infr3</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">test_aids</span><span class="p">,</span>
                                     <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">infr3</span><span class="o">.</span><span class="n">init_simulation</span><span class="p">(</span><span class="n">classifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">dials3</span><span class="p">)</span>
        <span class="n">infr3</span><span class="o">.</span><span class="n">init_test_mode</span><span class="p">()</span>
        <span class="n">infr3</span><span class="o">.</span><span class="n">enable_redundancy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">infr3</span><span class="o">.</span><span class="n">enable_autoreview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">infr3</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;empty&#39;</span><span class="p">)</span>

        <span class="n">infr3</span><span class="o">.</span><span class="n">main_loop</span><span class="p">(</span><span class="n">max_loops</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">sim_results</span><span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_sim_results</span><span class="p">(</span><span class="n">infr3</span><span class="p">,</span> <span class="n">dials3</span><span class="p">)</span>

        <span class="c1"># ------------</span>
        <span class="c1"># Dump experiment output to disk</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;simulation&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">sim_results</span><span class="p">)</span>

        <span class="c1"># metrics_df = pd.DataFrame.from_dict(graph_expt_data[&#39;metrics&#39;])</span>
        <span class="c1"># for user, group in metrics_df.groupby(&#39;user_id&#39;):</span>
        <span class="c1">#     print(&#39;actions of user = %r&#39; % (user,))</span>
        <span class="c1">#     user_actions = group[&#39;test_action&#39;]</span>
        <span class="c1">#     print(ut.repr4(ut.dict_hist(user_actions), stritems=True))</span>

        <span class="c1"># self.draw_simulation()</span>
        <span class="c1"># ut.show_if_requested()</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_collect_sim_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infr</span><span class="p">,</span> <span class="n">dials</span><span class="p">):</span>
        <span class="n">pred_confusion</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">test_state</span><span class="p">[</span><span class="s1">&#39;confusion&#39;</span><span class="p">])</span>
        <span class="n">pred_confusion</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;real&#39;</span>
        <span class="n">pred_confusion</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Edge confusion&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pred_confusion</span><span class="p">)</span>

        <span class="n">expt_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;real_ccs&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">nid_to_gt_cc</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;pred_ccs&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()),</span>
            <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;dials&#39;</span><span class="p">:</span> <span class="n">dials</span><span class="p">,</span>
            <span class="s1">&#39;refresh_thresh&#39;</span><span class="p">:</span> <span class="n">infr</span><span class="o">.</span><span class="n">refresh</span><span class="o">.</span><span class="n">_prob_any_remain_thresh</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">infr</span><span class="o">.</span><span class="n">metrics_list</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">expt_data</span>

<div class="viewcode-block" id="Chap5.measure_dbstats"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.measure_dbstats">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">measure_dbstats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap5.draw dbstats GZ_Master1</span>

<span class="sd">        python -m ibeis Chap5.measure dbstats PZ_Master1</span>
<span class="sd">        python -m ibeis Chap5.draw dbstats PZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_setup</span><span class="p">()</span>
        <span class="n">classifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;classifiers&#39;</span><span class="p">]</span>
        <span class="n">clf_meta</span> <span class="o">=</span> <span class="n">classifiers</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">clf_meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data_info&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">ibs_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">):</span>
            <span class="n">pccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nper_annot</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">pccs</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;n_annots&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span>
                <span class="s1">&#39;n_names&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pccs</span><span class="p">),</span>
                <span class="s1">&#39;annot_size_mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nper_annot</span><span class="p">),</span>
                <span class="s1">&#39;annot_size_std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">nper_annot</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="n">train_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;train_aids&#39;</span><span class="p">]</span>
        <span class="n">test_aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">[</span><span class="s1">&#39;test_aids&#39;</span><span class="p">]</span>
        <span class="n">dbstats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="n">ibs_stats</span><span class="p">(</span><span class="n">test_aids</span><span class="p">),</span>
            <span class="s1">&#39;training&#39;</span><span class="p">:</span> <span class="n">ibs_stats</span><span class="p">(</span><span class="n">train_aids</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">traininfo</span> <span class="o">=</span> <span class="n">dbstats</span><span class="p">[</span><span class="s1">&#39;training&#39;</span><span class="p">]</span>
        <span class="n">traininfo</span><span class="p">[</span><span class="s1">&#39;class_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf_meta</span><span class="p">[</span><span class="s1">&#39;class_hist&#39;</span><span class="p">]</span>
        <span class="n">traininfo</span><span class="p">[</span><span class="s1">&#39;n_training_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">clf_meta</span><span class="p">[</span><span class="s1">&#39;class_hist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">infr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>
        <span class="n">pblm_pccs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">positive_components</span><span class="p">())</span>
        <span class="n">pblm_nper_annot</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">pblm_pccs</span><span class="p">)</span>
        <span class="n">traininfo</span><span class="p">[</span><span class="s1">&#39;pblm_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;n_annots&#39;</span><span class="p">:</span> <span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span>
            <span class="s1">&#39;n_names&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pblm_pccs</span><span class="p">),</span>
            <span class="s1">&#39;annot_size_mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pblm_nper_annot</span><span class="p">),</span>
            <span class="s1">&#39;annot_size_std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pblm_nper_annot</span><span class="p">),</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">textblock</span><span class="p">(</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                if this (the real training data) is different from the parents</span>
<span class="sd">                (ibeis) info, that means the staging database is ahead of</span>
<span class="sd">                annotmatch. Report the ibeis one for clarity. Num annots should</span>
<span class="sd">                always be the same though.</span>
<span class="sd">                &#39;&#39;&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;dbstats&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbstats</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">dbstats</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap5.write_dbstats"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.write_dbstats">[docs]</a>    <span class="k">def</span> <span class="nf">write_dbstats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # TODO: write info about what dataset was used</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.measure dbstats PZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.measure dbstats PZ_Master1</span>

<span class="sd">            python -m ibeis Chap5.measure simulation GZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.draw dbstats --db GZ_Master1 --diskshow</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbstats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;dbstats&#39;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">dbstats</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="n">size_str</span> <span class="o">=</span> <span class="n">ave_str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;annot_size_mean&#39;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;annot_size_std&#39;</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;n_names&#39;</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Annots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;n_annots&#39;</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Annots size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_str</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Training edges&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_training_pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">colfmt</span> <span class="o">=</span> <span class="s1">&#39;numeric&#39;</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_nice</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabular</span><span class="o">.</span><span class="n">as_table</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">())</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;dbstats.tex&#39;</span><span class="p">),</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">tabular</span><span class="o">.</span><span class="n">as_table</span><span class="p">(),</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span>
                                <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;dbstats&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap5.print_error_analysis"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.print_error_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">print_error_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span>
        <span class="n">real_ccs</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;real_ccs&#39;</span><span class="p">]</span>
        <span class="n">pred_ccs</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;pred_ccs&#39;</span><span class="p">]</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grouping_delta</span><span class="p">(</span><span class="n">pred_ccs</span><span class="p">,</span> <span class="n">real_ccs</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;splits&#39;</span><span class="p">]</span>
        <span class="n">merges</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;merges&#39;</span><span class="p">]</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;num_reviews&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;default_priority&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;review_id&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">splits = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">splits</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">merges = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">merges</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">print_edge_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parts</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;truth&#39;</span><span class="p">,</span> <span class="s1">&#39;decision&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_match&#39;</span><span class="p">]</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="n">neworder</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial_order</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">neworder</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">df_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span><span class="p">]</span>
                <span class="n">df_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_multi_regex</span><span class="p">(</span><span class="n">df_str</span><span class="p">,</span> <span class="p">{</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">regex_or</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">regex_word</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">part</span><span class="p">):</span> <span class="n">col</span>
                    <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">cols</span><span class="p">)})</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_str</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merge Row: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edge_df</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">edges</span><span class="p">(),</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
            <span class="n">print_edge_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Split Row: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edge_df</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">edges</span><span class="p">(),</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">)</span>
            <span class="n">print_edge_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap5.draw_error_graph_analysis"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.draw_error_graph_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">draw_error_graph_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw error_graph_analysis GZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.draw error_graph_analysis PZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span>

        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;num_reviews&#39;</span><span class="p">,</span> <span class="s1">&#39;default_priority&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;review_id&#39;</span><span class="p">]</span>

        <span class="n">task_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;match_state&#39;</span><span class="p">,</span>
            <span class="s1">&#39;photobomb_state&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">task_nice_lookup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;match_state&#39;</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">CODE_TO_NICE</span><span class="p">,</span>
            <span class="s1">&#39;photobomb_state&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;pb&#39;</span><span class="p">:</span> <span class="s1">&#39;Photobomb&#39;</span><span class="p">,</span>
                <span class="s1">&#39;notpb&#39;</span><span class="p">:</span> <span class="s1">&#39;Not Photobomb&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="c1"># Load simulation end state with predicted and real PCCs</span>
        <span class="n">real_ccs</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;real_ccs&#39;</span><span class="p">]</span>
        <span class="n">pred_ccs</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;pred_ccs&#39;</span><span class="p">]</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>

        <span class="c1"># Manage data using a read-only inference object</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="o">.</span><span class="n">from_netx</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">)</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">_viz_image_config</span><span class="p">[</span><span class="s1">&#39;thumbsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">700</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">_viz_image_config</span><span class="p">[</span><span class="s1">&#39;grow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">load_latest_classifiers</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;clf&#39;</span><span class="p">))</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">relabel_using_reviews</span><span class="p">(</span><span class="n">rectify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># For each node, mark its real and predicted ids</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">set_node_attrs</span><span class="p">(</span><span class="s1">&#39;real_id&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">aid</span><span class="p">:</span> <span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">real_ccs</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">})</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">set_node_attrs</span><span class="p">(</span><span class="s1">&#39;pred_id&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="n">aid</span><span class="p">:</span> <span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_ccs</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">})</span>

        <span class="c1"># from networkx.utils import arbitrary_element as arbitrary</span>

        <span class="c1"># Gather a sample of error groups</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grouping_delta</span><span class="p">(</span><span class="n">pred_ccs</span><span class="p">,</span> <span class="n">real_ccs</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sampled_errors</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">strided_sample</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="s1">&#39;merges&#39;</span><span class="p">],</span> <span class="n">n</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">strided_sample</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="s1">&#39;splits&#39;</span><span class="p">],</span> <span class="n">n</span><span class="p">))</span>
        <span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sampled_errors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampled </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> cases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">k</span><span class="p">))</span>

        <span class="n">err_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">case_type</span><span class="p">,</span> <span class="n">cases</span> <span class="ow">in</span> <span class="n">sampled_errors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
                <span class="n">case_aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">case</span><span class="p">))</span>
                <span class="c1"># For each case find what edges need fixing</span>
                <span class="k">if</span> <span class="n">case_type</span> <span class="o">==</span> <span class="s1">&#39;merge&#39;</span><span class="p">:</span>
                    <span class="n">error_edges</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">find_pos_augment_edges</span><span class="p">(</span><span class="n">case_aids</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nxu</span><span class="o">.</span><span class="n">edges_between</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">case_aids</span><span class="p">))</span>
                    <span class="n">_df</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">get_edge_dataframe</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">_df</span><span class="o">.</span><span class="n">truth</span> <span class="o">!=</span> <span class="n">_df</span><span class="o">.</span><span class="n">decision</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_df</span><span class="o">.</span><span class="n">truth</span> <span class="o">==</span> <span class="n">NEGTV</span><span class="p">)</span>
                    <span class="n">error_edges</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">error_edges</span><span class="p">:</span>
                    <span class="n">edge</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">e_</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                    <span class="n">err_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">case_type</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">error_edges</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
        <span class="n">err_items_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">err_items</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;case_type&#39;</span><span class="p">,</span> <span class="s1">&#39;case&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;error_edges&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">])</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">err_items_df</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">err_df</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">get_edge_dataframe</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">err_df</span> <span class="o">=</span> <span class="n">err_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">err_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ignore</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Lookup the probs for each state</span>
        <span class="n">task_probs</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_make_task_probs</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">probs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">task_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># NOQA</span>

        <span class="n">dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">))</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span>
            <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">subitems</span> <span class="o">=</span> <span class="n">err_items_df</span>
        <span class="c1"># subitems = err_items_df[err_items_df.case_type == &#39;merge&#39;].iloc[-2:]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">case_type</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">error_edges</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span> <span class="ow">in</span> <span class="n">subitems</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">total_flatten</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">case_type</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
                <span class="n">colorby</span> <span class="o">=</span> <span class="s1">&#39;real_id&#39;</span>
            <span class="k">if</span> <span class="n">case_type</span> <span class="o">==</span> <span class="s1">&#39;merge&#39;</span><span class="p">:</span>
                <span class="n">colorby</span> <span class="o">=</span> <span class="s1">&#39;pred_id&#39;</span>

            <span class="n">infr</span><span class="o">.</span><span class="n">show_error_case</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">error_edges</span><span class="p">,</span> <span class="n">colorby</span><span class="o">=</span><span class="n">colorby</span><span class="p">)</span>

            <span class="n">edge_info</span> <span class="o">=</span> <span class="n">err_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">case_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; case. &#39;</span>
            <span class="n">code_to_nice</span> <span class="o">=</span> <span class="n">task_nice_lookup</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span>
            <span class="n">real_code</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">match_state_gt</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="n">pred_code</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;decision&#39;</span><span class="p">]</span>

            <span class="n">real_nice</span> <span class="o">=</span> <span class="s1">&#39;real=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_to_nice</span><span class="p">[</span><span class="n">real_code</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;auto_clf&#39;</span><span class="p">:</span>
                <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;Reviewed automatically&#39;</span>
            <span class="k">elif</span> <span class="n">edge_info</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;oracle&#39;</span><span class="p">:</span>
                <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;Reviewed manually&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;Edge did not appear in candidate set&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;Edge was a candidate, but not reviewed&#39;</span>

            <span class="k">if</span> <span class="n">pred_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pred_nice</span> <span class="o">=</span> <span class="s1">&#39;pred=None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred_nice</span> <span class="o">=</span> <span class="s1">&#39;pred=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_to_nice</span><span class="p">[</span><span class="n">pred_code</span><span class="p">])</span>
            <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">task_keys</span><span class="p">:</span>
                <span class="n">tprobs</span> <span class="o">=</span> <span class="n">task_probs</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
                <span class="n">_probs</span> <span class="o">=</span> <span class="n">tprobs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">code_to_nice</span> <span class="o">=</span> <span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">_probs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">code_to_nice</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_probs</span><span class="p">)</span>
                <span class="n">probstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strkeys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nobr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">xlabel</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">probstr</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">xlabel</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">itemsep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nobr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">case</span><span class="p">]</span>
            <span class="n">case_id</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">parts</span><span class="p">))))</span>
            <span class="n">case_id</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hash_data</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">case_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">case_id</span> <span class="o">+</span> <span class="s1">&#39;_edge&#39;</span> <span class="o">+</span> <span class="n">eid</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap5.write_error_tables"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.write_error_tables">[docs]</a>    <span class="k">def</span> <span class="nf">write_error_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw error_tables PZ_Master1</span>
<span class="sd">            python -m ibeis Chap5.draw error_tables GZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import _ranking_hist, _ranking_cdf</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">,</span> <span class="s1">&#39;rank+clf&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="c1"># print(&#39;!!!!!!!!!!!!&#39;)</span>
            <span class="c1"># print(&#39;key = %r&#39; % (key,))</span>
            <span class="n">expt_data</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_error_sizes</span><span class="p">(</span><span class="n">expt_data</span><span class="p">,</span> <span class="n">allow_hist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">][</span><span class="s1">&#39;n_pred_pccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">][</span><span class="s1">&#39;size_pred_pccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="n">infos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="n">dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">with_aves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">,</span> <span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                <span class="n">caseinfo</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
                <span class="n">casetable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;pred PCCs&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">caseinfo</span><span class="p">[</span><span class="s1">&#39;n_pred_pccs&#39;</span><span class="p">]</span>
                <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;pred PCC size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="p">[</span><span class="s1">&#39;size_pred_pccs&#39;</span><span class="p">]</span>
                <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;real PCCs&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">caseinfo</span><span class="p">[</span><span class="s1">&#39;n_real_pccs&#39;</span><span class="p">]</span>
                <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;real PCC size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="p">[</span><span class="s1">&#39;size_real_pccs&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">with_aves</span><span class="p">:</span>
                    <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;small size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ave_small&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;large size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ave_large&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">table</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">casetable</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="n">dfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">error_size_text</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_size_text</span><span class="p">)</span>

        <span class="c1"># Inspect error sizes only for the graph</span>
        <span class="n">caseinfo</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">caseinfo</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">casetable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;error groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_errgroups&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;group size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errgroup_size&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;small PCC size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ave_small&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">casetable</span><span class="p">[</span><span class="s1">&#39;large PCC size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ave_large&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">casetable</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">casetable</span><span class="p">)</span>
            <span class="n">table</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">casetable</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">error_group_text</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_group_text</span><span class="p">)</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;error_size_details&#39;</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">error_size_text</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">error_size_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
                        <span class="n">preamb_extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{makecell}</span><span class="s1">&#39;</span><span class="p">])</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;error_group_details&#39;</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">error_group_text</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">error_group_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
                        <span class="n">preamb_extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{makecell}</span><span class="s1">&#39;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_get_error_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expt_data</span><span class="p">,</span> <span class="n">allow_hist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">real_ccs</span> <span class="o">=</span> <span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;real_ccs&#39;</span><span class="p">]</span>
        <span class="n">pred_ccs</span> <span class="o">=</span> <span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;pred_ccs&#39;</span><span class="p">]</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="c1"># delta_df = ut.grouping_delta_stats(pred_ccs, real_ccs)</span>
        <span class="c1"># print(delta_df)</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grouping_delta</span><span class="p">(</span><span class="n">pred_ccs</span><span class="p">,</span> <span class="n">real_ccs</span><span class="p">)</span>
        <span class="n">unchanged</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;unchanged&#39;</span><span class="p">]</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;splits&#39;</span><span class="p">][</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
        <span class="n">merges</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;merges&#39;</span><span class="p">][</span><span class="s1">&#39;old&#39;</span><span class="p">]</span>

        <span class="c1"># hybrids can be done by first splitting and then merging</span>
        <span class="n">hybrid_splits</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;hybrid&#39;</span><span class="p">][</span><span class="s1">&#39;splits&#39;</span><span class="p">]</span>
        <span class="n">hybrid_merges</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="s1">&#39;hybrid&#39;</span><span class="p">][</span><span class="s1">&#39;merges&#39;</span><span class="p">]</span>

        <span class="n">all_merges</span> <span class="o">=</span> <span class="n">merges</span> <span class="o">+</span> <span class="n">hybrid_merges</span>
        <span class="n">all_splits</span> <span class="o">=</span> <span class="n">splits</span> <span class="o">+</span> <span class="n">hybrid_splits</span>

        <span class="k">def</span> <span class="nf">ave_size</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">sets</span><span class="p">))</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">allow_hist</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ave_str</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unchanged_measures</span><span class="p">(</span><span class="n">unchanged</span><span class="p">):</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">true</span> <span class="o">=</span> <span class="n">unchanged</span>
            <span class="n">unchanged_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;n_pred_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_pred_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_real_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_real_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
            <span class="p">])</span>
            <span class="k">return</span> <span class="n">unchanged_info</span>

        <span class="k">def</span> <span class="nf">get_bad_edges</span><span class="p">(</span><span class="n">ccs</span><span class="p">,</span> <span class="n">bad_decision</span><span class="p">,</span> <span class="n">ret_ccs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">ccs</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">cc1</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span>
                <span class="n">cc2</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">cc2</span><span class="p">)</span>
                <span class="n">bad_edges</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cross</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edges_cross</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">cross</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;decision&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bad_decision</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ret_ccs</span><span class="p">:</span>
                            <span class="n">bad_edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">bad_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">bad_edges</span>

        <span class="k">def</span> <span class="nf">split_measures</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
            <span class="c1"># Filter out non-split hybrids</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">splits</span><span class="p">)</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
            <span class="n">baddies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">smalls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">larges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">split</span><span class="p">))</span>
                <span class="n">smalls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">larges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_bad_edges</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">POSTV</span><span class="p">))</span>
                <span class="n">baddies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="n">split_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;n_pred_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_pred_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_real_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_real_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_errgroups&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;errgroup_size&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">splits</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;ave_small&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">smalls</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;ave_large&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">larges</span><span class="p">)),</span>
            <span class="p">])</span>
            <span class="k">return</span> <span class="n">split_info</span>

        <span class="k">def</span> <span class="nf">merge_measures</span><span class="p">(</span><span class="n">merges</span><span class="p">):</span>
            <span class="c1"># Filter out non-merge hybrids</span>
            <span class="n">merges</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">merges</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">merges</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">merges</span><span class="p">)</span>
            <span class="n">baddies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_neg_redun</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_bad_pairs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_bad_pccs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">smalls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">larges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">merge</span> <span class="ow">in</span> <span class="n">merges</span><span class="p">:</span>
                <span class="n">merge</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">merge</span><span class="p">))</span>

                <span class="n">smalls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">merge</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">larges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">merge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_bad_edges</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">NEGTV</span><span class="p">))</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_bad_edges</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">NEGTV</span><span class="p">,</span> <span class="n">ret_ccs</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

                <span class="n">baddies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">bad_neg_redun</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
                <span class="n">n_bad_pairs</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">any</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
                <span class="n">n_bad_pccs</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">b2</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))))</span>
                <span class="k">if</span> <span class="n">bad_neg_redun</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">n_neg_redun</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">merge_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;n_pred_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_pred_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">pred</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_real_pccs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;size_real_pccs&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">true</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_errgroups&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">merges</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;errgroup_size&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">merges</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;ave_incon_edges&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">baddies</span><span class="p">))),</span>
                <span class="p">(</span><span class="s1">&#39;n_bad_pairs&#39;</span><span class="p">,</span> <span class="n">n_bad_pairs</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;n_bad_pccs&#39;</span><span class="p">,</span> <span class="n">n_bad_pccs</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;n_neg_redun&#39;</span><span class="p">,</span> <span class="n">n_neg_redun</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;ave_small&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">smalls</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;ave_large&#39;</span><span class="p">,</span> <span class="n">ave_size</span><span class="p">(</span><span class="n">larges</span><span class="p">)),</span>
            <span class="p">])</span>
            <span class="k">return</span> <span class="n">merge_info</span>

        <span class="c1"># def hybrid_measures(hybrid):</span>
        <span class="c1">#     pred = hybrid[&#39;old&#39;]</span>
        <span class="c1">#     true = hybrid[&#39;new&#39;]</span>
        <span class="c1">#     hybrid_info = ut.odict([</span>
        <span class="c1">#         (&#39;n_pred_pccs&#39;, len(pred)),</span>
        <span class="c1">#         (&#39;size_pred_pccs&#39;, ave_size(pred)),</span>
        <span class="c1">#         (&#39;n_real_pccs&#39;, len(true)),</span>
        <span class="c1">#         (&#39;size_real_pccs&#39;, ave_size(true)),</span>
        <span class="c1">#     ])</span>
        <span class="c1">#     return hybrid_info</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;correct&#39;</span><span class="p">:</span> <span class="n">unchanged_measures</span><span class="p">(</span><span class="n">unchanged</span><span class="p">),</span>
            <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="n">split_measures</span><span class="p">(</span><span class="n">all_splits</span><span class="p">),</span>
            <span class="s1">&#39;merge&#39;</span><span class="p">:</span> <span class="n">merge_measures</span><span class="p">(</span><span class="n">all_merges</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">info</span>

<div class="viewcode-block" id="Chap5.draw_simulation"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.draw_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">draw_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw simulation PZ_MTEST --diskshow</span>
<span class="sd">            python -m ibeis Chap5.draw simulation GZ_Master1 --diskshow</span>
<span class="sd">            python -m ibeis Chap5.draw simulation PZ_Master1 --diskshow</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(&#39;GZ_Master&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">,</span> <span class="s1">&#39;rank+clf&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_metrics</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sim_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">xdatas</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">(</span><span class="s1">&#39;n_manual&#39;</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">xdatas</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">xpad</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.01</span> <span class="o">*</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">-</span> <span class="n">xmax</span>

        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nSubplots</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">())</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">(</span><span class="s1">&#39;merge_remain&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ydatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">xpad</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">xpad</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# manual reviews&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fraction of merges remain&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">())</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">(</span><span class="s1">&#39;n_errors&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ydatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">ydatas</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">xpad</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">xpad</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# manual reviews&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;# errors&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>  <span class="c1"># NOQA</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">75</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">wspace</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;simulation.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--diskshow&#39;</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap5.draw_refresh"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.draw_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">draw_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw refresh GZ_Master1 --diskshow</span>
<span class="sd">            python -m ibeis Chap5.draw refresh PZ_Master1 --diskshow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">,</span> <span class="s1">&#39;rank+clf&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_metrics</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">],</span> <span class="n">col</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sim_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">xdatas</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">(</span><span class="s1">&#39;n_manual&#39;</span><span class="p">)</span>
        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nSubplots</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">())</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">(</span><span class="s1">&#39;pprob_any&#39;</span><span class="p">)</span>

        <span class="c1"># fix the visual inconsistency that doesn&#39;t matter in practice</span>
        <span class="c1"># flags = _metrics(&#39;refresh_support&#39;)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;graph&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ydatas</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;# manual reviews&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(C=1)&#39;</span><span class="p">)</span>
        <span class="c1"># ax.legend()</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;refresh.png&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>  <span class="c1"># NOQA</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap5.draw_simulation2"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap5.draw_simulation2">[docs]</a>    <span class="k">def</span> <span class="nf">draw_simulation2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap5.draw_simulation2 --db PZ_MTEST --show</span>
<span class="sd">            python -m ibeis Chap5.draw_simulation2 --db GZ_Master1 --show</span>
<span class="sd">            python -m ibeis Chap5.draw_simulation2 --db PZ_Master1 --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap5(dbname)</span>
<span class="sd">            &gt;&gt;&gt; self.draw_simulation2()</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">sim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>

        <span class="n">expt_data</span> <span class="o">=</span> <span class="n">sim_results</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span>
        <span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">])</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># NOQA</span>
        <span class="n">overshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;phase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;pred&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;auto&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;real&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;recover&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">]:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_decision&#39;</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;# decisions&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_manual&#39;</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;# manual reviews&#39;</span>

        <span class="k">def</span> <span class="nf">plot_intervals</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_consecutives</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ranges</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">xdata_</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">values</span>

            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">xdata_</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">low</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
                <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xdata_</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">xdata_</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="c1"># if x1 == x2:</span>
                <span class="n">x1</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">x2</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span>
                <span class="n">ys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">])</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdata_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">overlay_actions</span><span class="p">(</span><span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Draws indicators that detail the algorithm state at given</span>
<span class="sd">            timestamps.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">phase</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">is_correct</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;test_action&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;correct&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
            <span class="n">recovering</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;recovering&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">is_auto</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;algo:&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ppos</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;pred_decision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">POSTV</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">rpos</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;true_decision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">POSTV</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># ymax = max(metrics_df[&#39;n_errors&#39;])</span>

            <span class="n">num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">overshow</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ymax</span>
            <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">def</span> <span class="nf">stacked_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="n">plot_intervals</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">high</span><span class="o">=</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                                 <span class="s1">&#39;is_auto(auto=gold,manual=blue)&#39;</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">is_auto</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="o">~</span><span class="n">is_auto</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="s1">&#39;pred_pos&#39;</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">ppos</span><span class="p">,</span> <span class="s1">&#39;aqua&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">high</span><span class="o">=</span><span class="n">steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="c1"># stacked_interval(~ppos, &#39;salmon&#39;, i)</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="s1">&#39;real_pos&#39;</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">rpos</span><span class="p">,</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># stacked_interval(~ppos, &#39;salmon&#39;, i)</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="s1">&#39;is_error&#39;</span><span class="p">)</span>
                <span class="c1"># stacked_interval(is_correct, &#39;blue&#39;, low=steps[i], high=steps[i + 1])</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="o">~</span><span class="n">is_correct</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;recover&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="s1">&#39;is_recovering&#39;</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">recovering</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">overshow</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">absolute_text</span><span class="p">((</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="s1">&#39;phase&#39;</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;ranking&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;posredun&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">stacked_interval</span><span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;negredun&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nSubplots</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">ydatas</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;Graph&#39;</span><span class="p">,</span>  <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;merge_remain&#39;</span><span class="p">]),</span>
        <span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">ydatas</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;fraction of merge remaining&#39;</span><span class="p">,</span>
            <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="c1"># overlay_actions(1)</span>

        <span class="n">ykeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">ykeys</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;# of errors&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">overlay_actions</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]))</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;pprob_any&#39;</span><span class="p">]],</span>
            <span class="n">label_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P(C=1)&#39;</span><span class="p">],</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;refresh criteria&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;refresh_thresh&#39;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)],</span> <span class="p">[</span><span class="n">thresh</span><span class="p">,</span> <span class="n">thresh</span><span class="p">],</span> <span class="s1">&#39;-g&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refresh thresh&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="c1"># overlay_actions(1)</span>

        <span class="n">ykeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_fn&#39;</span><span class="p">,</span> <span class="s1">&#39;n_fp&#39;</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">ykeys</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">label_list</span><span class="o">=</span><span class="n">ykeys</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;# of errors&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">ymax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]),</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">xdata</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_manual&#39;</span><span class="p">]</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;# manual reviews&#39;</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;Graph&#39;</span><span class="p">,</span>  <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;merge_remain&#39;</span><span class="p">]),</span>
        <span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">ydatas</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;fraction of merge remaining&#39;</span><span class="p">,</span>
            <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="c1"># overlay_actions(1)</span>

        <span class="n">ykeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">ykeys</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;# of errors&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">overlay_actions</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]))</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;pprob_any&#39;</span><span class="p">]],</span>
            <span class="n">label_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P(C=1)&#39;</span><span class="p">],</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;refresh criteria&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">expt_data</span><span class="p">[</span><span class="s1">&#39;refresh_thresh&#39;</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)],</span> <span class="p">[</span><span class="n">thresh</span><span class="p">,</span> <span class="n">thresh</span><span class="p">],</span> <span class="s1">&#39;-g&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;refresh thresh&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="c1"># overlay_actions(1)</span>

        <span class="n">ykeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_fn&#39;</span><span class="p">,</span> <span class="s1">&#39;n_fp&#39;</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span> <span class="n">metrics_df</span><span class="p">[</span><span class="n">ykeys</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">label_list</span><span class="o">=</span><span class="n">ykeys</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;# of errors&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
            <span class="n">ymax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;n_errors&#39;</span><span class="p">]),</span>
            <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># fpath = join(self.dpath, expt_name + &#39;2&#39; + &#39;.png&#39;)</span>
        <span class="c1"># fig = pt.gcf()  # NOQA</span>
        <span class="c1"># fig.set_size_inches([W * 1.5, H * 1.1])</span>
        <span class="c1"># vt.imwrite(fpath, pt.render_figure_to_image(fig, dpi=DPI))</span>
        <span class="c1"># if ut.get_argflag(&#39;--diskshow&#39;):</span>
        <span class="c1">#     ut.startfile(fpath)</span>
        <span class="c1"># fig.save_fig</span>

        <span class="c1"># if 1:</span>
        <span class="c1">#     pt.figure(fnum=fnum, pnum=(2, 2, 4))</span>
        <span class="c1">#     overlay_actions(ymax=1)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Chap4"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">Chap4</span><span class="p">(</span><span class="n">DBInputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect data from experiments to visualize</span>

<span class="sd">    TODO: redo save/loading of measurments</span>

<span class="sd">    Ignore:</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">        &gt;&gt;&gt; fpath = ut.glob(ut.truepath(&#39;~/Desktop/mtest_plots&#39;), &#39;*.pkl&#39;)[0]</span>
<span class="sd">        &gt;&gt;&gt; self = ut.load_data(fpath)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/latex/crall-thesis-2017/figures4&#39;</span><span class="p">)</span>

    <span class="n">task_nice_lookup</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;match_state&#39;</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">CODE_TO_NICE</span><span class="p">,</span>
        <span class="s1">&#39;photobomb_state&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;pb&#39;</span><span class="p">:</span> <span class="s1">&#39;Photobomb&#39;</span><span class="p">,</span>
            <span class="s1">&#39;notpb&#39;</span><span class="p">:</span> <span class="s1">&#39;Not Photobomb&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4._setup --db GZ_Master1</span>

<span class="sd">            python -m ibeis Chap4._setup --db PZ_Master1 --eval</span>
<span class="sd">            python -m ibeis Chap4._setup --db PZ_MTEST</span>
<span class="sd">            python -m ibeis Chap4._setup --db PZ_PB_RF_TRAIN</span>

<span class="sd">            python -m ibeis Chap4.measure_all --db PZ_PB_RF_TRAIN</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(dbname)</span>
<span class="sd">            &gt;&gt;&gt; self._setup()</span>

<span class="sd">        Ignore:</span>
<span class="sd">            from ibeis.scripts.thesis import *</span>
<span class="sd">            self = Chap4(&#39;PZ_Master1&#39;)</span>

<span class="sd">            from ibeis.scripts.thesis import *</span>
<span class="sd">            self = Chap4(&#39;PZ_PB_RF_TRAIN&#39;)</span>

<span class="sd">            self.ibs.print_annot_stats(aids, prefix=&#39;P&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>

        <span class="k">if</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span> <span class="o">==</span> <span class="s1">&#39;PZ_Master1&#39;</span><span class="p">:</span>
            <span class="c1"># FIND ALL PHOTOBOMB / INCOMPARABLE CASES</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">infr</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">infr</span><span class="o">.</span><span class="n">reset_feedback</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">status</span><span class="p">()))</span>

                <span class="n">pblm</span> <span class="o">=</span> <span class="n">vsone</span><span class="o">.</span><span class="n">OneVsOneProblem</span><span class="o">.</span><span class="n">from_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">)</span>
                <span class="n">pblm</span><span class="o">.</span><span class="n">load_samples</span><span class="p">()</span>
                <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">print_info</span><span class="p">()</span>

            <span class="n">aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span>

        <span class="n">pblm</span> <span class="o">=</span> <span class="n">vsone</span><span class="o">.</span><span class="n">OneVsOneProblem</span><span class="o">.</span><span class="n">from_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">,</span> <span class="s1">&#39;photobomb_state&#39;</span><span class="p">]</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_data_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_clf_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">clf_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--eval&#39;</span><span class="p">):</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;photobomb_state&#39;</span><span class="p">,</span> <span class="s1">&#39;match_state&#39;</span><span class="p">]</span>
            <span class="c1"># pblm.eval_task_keys = [&#39;match_state&#39;]</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">eval_data_keys</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">evaluate_classifiers</span><span class="p">()</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">eval_data_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">setup_evaluation</span><span class="p">()</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">load_samples</span><span class="p">()</span>

        <span class="c1"># pblm.evaluate_classifiers()</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">print_info</span><span class="p">()</span>

        <span class="n">species_code</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_database_species</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">aids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">species_code</span> <span class="o">==</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;Plains Zebras&#39;</span>
        <span class="k">if</span> <span class="n">species_code</span> <span class="o">==</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;Grvy</span><span class="se">\&#39;</span><span class="s1">s Zebras&#39;</span>
        <span class="n">dbcode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span> <span class="o">=</span> <span class="n">pblm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbcode</span> <span class="o">=</span> <span class="n">dbcode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_task_keys</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_key</span> <span class="o">=</span> <span class="n">data_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf_key</span> <span class="o">=</span> <span class="n">clf_key</span>

        <span class="c1"># config = pblm.hyper_params</span>
        <span class="c1"># self._setup_links(cfg_prefix, config)</span>

        <span class="c1"># RESET DPATH BASED ON SAMPLE?</span>
        <span class="c1"># MAYBE SYMLINK TO NEW DPATH?</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">expanduser</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbcode</span><span class="p">)</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_dpath</span> <span class="o">=</span> <span class="n">dpath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">dpath</span><span class="p">):</span>
                <span class="n">newpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">non_existing_path</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_old&#39;</span><span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">newpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>

<div class="viewcode-block" id="Chap4.measure_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.measure_all">[docs]</a>    <span class="k">def</span> <span class="nf">measure_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.measure_all --db PZ_PB_RF_TRAIN</span>
<span class="sd">            python -m ibeis Chap4.measure_all --db PZ_MTEST</span>
<span class="sd">            python -m ibeis Chap4.measure_all</span>

<span class="sd">            python -m ibeis Chap4.measure_all --db GZ_Master1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; dbnames = ut.get_argval(&#39;--dbs&#39;, type_=list, default=[dbname])</span>
<span class="sd">            &gt;&gt;&gt; for dbname in dbnames:</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;dbname = %r&#39; % (dbname,))</span>
<span class="sd">            &gt;&gt;&gt;     self = Chap4(dbname)</span>
<span class="sd">            &gt;&gt;&gt;     self.measure_all()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;sample_info&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span>
            <span class="s1">&#39;aid_pool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="s1">&#39;pblm_aids&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span>
            <span class="s1">&#39;encoded_labels2d&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">encoded_2d</span><span class="p">(),</span>
            <span class="s1">&#39;subtasks&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">,</span>
            <span class="s1">&#39;multihist&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">make_histogram</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span>

        <span class="n">importance</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">task_key</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="n">task_key</span><span class="o">=</span><span class="n">task_key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span>
        <span class="p">}</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">simple_scores</span><span class="p">[</span><span class="s1">&#39;score_lnbnn_1vM&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">indicator_df</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">default_class_name</span><span class="p">]</span>
        <span class="n">lnbnn_xy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">scores</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;lnbnn_xy&#39;</span><span class="p">:</span> <span class="n">lnbnn_xy</span><span class="p">,</span>
            <span class="s1">&#39;task_combo_res&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">,</span>
            <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance</span><span class="p">,</span>
            <span class="s1">&#39;data_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_key</span><span class="p">,</span>
            <span class="s1">&#39;clf_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf_key</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_hard_cases</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;photobomb_state&#39;</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_hard_cases</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">measure_rerank</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_prune</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--draw&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Chap4.draw_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_all">[docs]</a>    <span class="k">def</span> <span class="nf">draw_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.draw_all --db PZ_MTEST</span>
<span class="sd">            python -m ibeis Chap4.draw_all --db PZ_PB_RF_TRAIN</span>
<span class="sd">            python -m ibeis Chap4.draw_all --db GZ_Master1</span>
<span class="sd">            python -m ibeis Chap4.draw_all --db PZ_Master1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; dbnames = ut.get_argval(&#39;--dbs&#39;, type_=list, default=[dbname])</span>
<span class="sd">            &gt;&gt;&gt; for dbname in dbnames:</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;dbname = %r&#39; % (dbname,))</span>
<span class="sd">            &gt;&gt;&gt;     self = Chap4(dbname)</span>
<span class="sd">            &gt;&gt;&gt;     self.draw_all()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">eval_task_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_sample_info</span><span class="p">()</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;photobomb_state&#39;</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">eval_task_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_importance</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_metrics</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_metrics2</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_roc</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_mcc_thresh</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">eval_task_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_class_score_hist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_roc</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_mcc_thresh</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">draw_wordcloud</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_importance</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_metrics</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">draw_rerank</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--noprune&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_prune</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--nodraw&#39;</span><span class="p">):</span>
            <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
            <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">eval_task_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_hard_cases</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

            <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;photobomb_state&#39;</span>
            <span class="k">if</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">eval_task_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw_hard_cases</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap4.measure_prune"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.measure_prune">[docs]</a>    <span class="k">def</span> <span class="nf">measure_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from sklearn.feature_selection import SelectFromModel</span>
        <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">clf_helpers</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pblm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>
        <span class="n">task_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">primary_task_key</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span>

        <span class="n">featinfo</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">AnnotPairFeatInfo</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">get_infostr</span><span class="p">())</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
        <span class="c1"># X = pblm.samples.X_dict[data_key]</span>

        <span class="n">feat_dims</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">n_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_dims</span><span class="p">)</span>
        <span class="n">n_dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sub_reports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mdis_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">prune_rate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">min_feats</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">n_steps_needed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">n_orig</span> <span class="o">-</span> <span class="n">min_feats</span><span class="p">)</span> <span class="o">/</span> <span class="n">prune_rate</span><span class="p">))</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_steps_needed</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;prune&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">prog</span><span class="p">:</span>
            <span class="n">prog</span><span class="o">.</span><span class="n">ensure_newline</span><span class="p">()</span>
            <span class="n">clf_list</span><span class="p">,</span> <span class="n">res_list</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_train_evaluation_clf</span><span class="p">(</span><span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span>
                                                            <span class="n">clf_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="p">)</span>
            <span class="n">combo_res</span> <span class="o">=</span> <span class="n">clf_helpers</span><span class="o">.</span><span class="n">ClfResult</span><span class="o">.</span><span class="n">combine_results</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">extended_clf_report</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">]</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">combo_res</span><span class="o">.</span><span class="n">extended_clf_report</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Measure mean decrease in impurity</span>
            <span class="n">clf_mdi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">clf_</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="k">for</span> <span class="n">clf_</span> <span class="ow">in</span> <span class="n">clf_list</span><span class="p">])</span>
            <span class="n">mean_mdi</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">feat_dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clf_mdi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Record state</span>
            <span class="n">n_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_dims</span><span class="p">))</span>
            <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
            <span class="n">sub_reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
            <span class="n">mdis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_mdi</span><span class="p">)</span>

            <span class="c1"># remove the worst features</span>
            <span class="n">sorted_featdims</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">mean_mdi</span><span class="p">)</span>
            <span class="n">n_have</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_featdims</span><span class="p">)</span>
            <span class="n">n_remove</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_have</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_have</span> <span class="o">-</span> <span class="n">prune_rate</span><span class="p">,</span> <span class="n">min_feats</span><span class="p">))</span>
            <span class="n">worst_features</span> <span class="o">=</span> <span class="n">sorted_featdims</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_remove</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">worst_features</span><span class="p">:</span>
                <span class="n">feat_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;n_dims&#39;</span><span class="p">:</span> <span class="n">n_dims</span><span class="p">,</span>
            <span class="s1">&#39;reports&#39;</span><span class="p">:</span> <span class="n">reports</span><span class="p">,</span>
            <span class="s1">&#39;sub_reports&#39;</span><span class="p">:</span> <span class="n">sub_reports</span><span class="p">,</span>
            <span class="s1">&#39;mdis_list&#39;</span><span class="p">:</span> <span class="n">mdis_list</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;prune&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap4.measure_rerank"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.measure_rerank">[docs]</a>    <span class="k">def</span> <span class="nf">measure_rerank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; defaultdb = &#39;PZ_Master1&#39;</span>
<span class="sd">            &gt;&gt;&gt; defaultdb = &#39;GZ_Master1&#39;</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(defaultdb)</span>
<span class="sd">            &gt;&gt;&gt; self._setup()</span>
<span class="sd">            &gt;&gt;&gt; self.measure_rerank()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pblm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">ibs</span>

        <span class="c1"># NOTE: this is not the aids_pool for PZ_Master1</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">aids</span>

        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pblm</span><span class="o">.</span><span class="n">hyper_params</span><span class="p">[</span><span class="s1">&#39;vsone_kpts&#39;</span><span class="p">][</span><span class="s1">&#39;augment_orientation&#39;</span><span class="p">]:</span>
            <span class="c1"># HACK</span>
            <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Execute the ranking algorithm</span>
        <span class="n">qaids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
        <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>

        <span class="c1"># Measure LNBNN rank probabilities</span>
        <span class="n">top</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">rerank_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">infr</span><span class="o">.</span><span class="n">e_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">)</span> <span class="k">for</span> <span class="n">daid</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="n">top</span><span class="p">)]</span>
            <span class="n">rerank_pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
        <span class="n">rerank_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rerank_pairs</span><span class="p">))</span>

        <span class="n">verifiers</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">learn_evaluation_verifiers</span><span class="p">()</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">verifiers</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba_df</span><span class="p">(</span><span class="n">rerank_pairs</span><span class="p">)</span>
        <span class="n">pos_probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span>

        <span class="n">clf_name_ranks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lnbnn_name_ranks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">:</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">infr</span><span class="o">.</span><span class="n">e_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">)</span> <span class="k">for</span> <span class="n">daid</span> <span class="ow">in</span> <span class="n">daids</span><span class="p">]</span>
            <span class="n">dnids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">)]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">pos_probs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edges</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">clf_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">==</span> <span class="n">dnids</span><span class="p">[</span><span class="n">sortx</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clf_ranks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">clf_rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clf_rank</span> <span class="o">=</span> <span class="n">clf_ranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lnbnn_rank</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_name_ranks</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">clf_name_ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf_rank</span><span class="p">)</span>
            <span class="n">lnbnn_name_ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lnbnn_rank</span><span class="p">)</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">dnids</span><span class="p">))</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">lnbnn_name_ranks</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lnbnn_cdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">dnids</span><span class="p">))</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">clf_name_ranks</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clf_cdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lnbnn_cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})),</span>
            <span class="p">(</span><span class="n">clf_cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})),</span>
        <span class="p">]</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;rerank&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap4.measure_hard_cases"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.measure_hard_cases">[docs]</a>    <span class="k">def</span> <span class="nf">measure_hard_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find a failure case for each class</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.measure hard_cases GZ_Master1 match_state</span>
<span class="sd">            python -m ibeis Chap4.measure hard_cases GZ_Master1 photobomb_state</span>
<span class="sd">            python -m ibeis Chap4.draw hard_cases GZ_Master1 match_state</span>
<span class="sd">            python -m ibeis Chap4.draw hard_cases GZ_Master1 photobomb_state</span>

<span class="sd">            python -m ibeis Chap4.measure hard_cases PZ_Master1 match_state</span>
<span class="sd">            python -m ibeis Chap4.measure hard_cases PZ_Master1 photobomb_state</span>
<span class="sd">            python -m ibeis Chap4.draw hard_cases PZ_Master1 match_state</span>
<span class="sd">            python -m ibeis Chap4.draw hard_cases PZ_Master1 photobomb_state</span>

<span class="sd">            python -m ibeis Chap4.measure hard_cases PZ_MTEST match_state</span>
<span class="sd">            python -m ibeis Chap4.draw hard_cases PZ_MTEST photobomb_state</span>

<span class="sd">            python -m ibeis Chap4.measure hard_cases MantaMatcher match_state</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;match_state&#39;</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;photobomb_state&#39;</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._setup()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pblm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Need to setup before measuring hard cases&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Measuring hard cases&#39;</span><span class="p">)</span>

        <span class="n">pblm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pblm</span>

        <span class="n">front</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">back</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">clf_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data_key</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;task_key = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">task_key</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="o">==</span> <span class="s1">&#39;photobomb_state&#39;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;max-mcc&#39;</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_thresholds</span><span class="p">(</span><span class="s1">&#39;mcc&#39;</span><span class="p">,</span> <span class="s1">&#39;maximize&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using thresholds: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;argmax&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using argmax&#39;</span><span class="p">)</span>

        <span class="n">case_df</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">hardness_analysis</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="c1"># group = case_df.sort_values([&#39;real_conf&#39;, &#39;easiness&#39;])</span>
        <span class="n">case_df</span> <span class="o">=</span> <span class="n">case_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;easiness&#39;</span><span class="p">])</span>

        <span class="c1"># failure_cases = case_df[(case_df[&#39;real_conf&#39;] &gt; 0) &amp; case_df[&#39;failed&#39;]]</span>
        <span class="n">failure_cases</span> <span class="o">=</span> <span class="n">case_df</span><span class="p">[</span><span class="n">case_df</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failure_cases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No reviewed failures exist. Do pblm.qt_review_hardcases&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">{}</span><span class="s1"> failure cases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">failure_cases</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;With average hardness </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">(</span><span class="n">failure_cases</span><span class="p">[</span><span class="s1">&#39;hardness&#39;</span><span class="p">]),</span> <span class="n">strkeys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">real</span><span class="p">),</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">failure_cases</span><span class="o">.</span><span class="n">groupby</span><span class="p">((</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="s1">&#39;real&#39;</span><span class="p">)):</span>

            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;easiness&#39;</span><span class="p">])</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_percentile_parts</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;easiness&#39;</span><span class="p">],</span> <span class="n">front</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">back</span><span class="p">)</span>
            <span class="n">subgroup</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected </span><span class="si">{}</span><span class="s1"> r(</span><span class="si">{}</span><span class="s1">)-p(</span><span class="si">{}</span><span class="s1">) cases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">subgroup</span><span class="p">),</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">real</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
            <span class="p">))</span>
            <span class="c1"># ut.take_percentile_parts(group[&#39;easiness&#39;], front, mid, back)</span>

            <span class="c1"># Prefer examples we have manually reviewed before</span>
            <span class="c1"># group = group.sort_values([&#39;real_conf&#39;, &#39;easiness&#39;])</span>
            <span class="c1"># subgroup = group[0:num_top]</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">subgroup</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;aid1&#39;</span><span class="p">,</span> <span class="s1">&#39;aid2&#39;</span><span class="p">]))</span>
                <span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="n">edge</span><span class="p">,</span>
                    <span class="s1">&#39;real&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]],</span>
                    <span class="s1">&#39;pred&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]],</span>
                    <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;easiness&#39;</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;easiness&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;real_conf&#39;</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;real_conf&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;probs&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;edge_data&#39;</span><span class="p">:</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span>
                <span class="p">})</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected </span><span class="si">%d</span><span class="s1"> cases in total&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cases</span><span class="p">)))</span>

        <span class="c1"># Augment cases with their one-vs-one matches</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_key</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">feat_extract_info</span><span class="p">[</span><span class="n">data_key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;match_config&#39;</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_exec_pairwise_match</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_prep_annot</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
            <span class="c1"># Load data needed for plot into annot dictionary</span>
            <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span>
            <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>
            <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span>
            <span class="c1"># Cast the lazy dict to a real one</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">annot</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">annot</span><span class="o">.</span><span class="n">evaluated_keys</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">case</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cases</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
            <span class="c1"># store its chip fpath and other required info</span>
            <span class="n">match</span><span class="o">.</span><span class="n">annot1</span> <span class="o">=</span> <span class="n">_prep_annot</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">)</span>
            <span class="n">match</span><span class="o">.</span><span class="n">annot2</span> <span class="o">=</span> <span class="n">_prep_annot</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">)</span>
            <span class="n">case</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">task_key</span> <span class="o">+</span> <span class="s1">&#39;_hard_cases.pkl&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">cases</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hard case space on disk: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_file_nBytes_str</span><span class="p">(</span><span class="n">fpath</span><span class="p">)))</span>

        <span class="c1"># if False:</span>
        <span class="c1">#     ybin_df = res.target_bin_df</span>
        <span class="c1">#     flags = ybin_df[&#39;pb&#39;].values</span>
        <span class="c1">#     pb_edges = ybin_df[flags].index.tolist()</span>

        <span class="c1">#     matches = infr._exec_pairwise_match(pb_edges, config)</span>
        <span class="c1">#     prefix = &#39;training_&#39;</span>

        <span class="c1">#     subdir = &#39;temp_cases_{}&#39;.format(task_key)</span>
        <span class="c1">#     dpath = join(str(self.dpath), subdir)</span>
        <span class="c1">#     ut.ensuredir(dpath)</span>

        <span class="c1">#     tbl = pblm.infr.ibs.db.get_table_as_pandas(&#39;annotmatch&#39;)</span>
        <span class="c1">#     tagged_tbl = tbl[~pd.isnull(tbl[&#39;annotmatch_tag_text&#39;]).values]</span>
        <span class="c1">#     ttext = tagged_tbl[&#39;annotmatch_tag_text&#39;]</span>
        <span class="c1">#     flags = [&#39;photobomb&#39; in t.split(&#39;;&#39;) for t in ttext]</span>
        <span class="c1">#     pb_table = tagged_tbl[flags]</span>
        <span class="c1">#     am_pb_edges = set(</span>
        <span class="c1">#         ut.estarmap(infr.e_, zip(pb_table.annot_rowid1.tolist(),</span>
        <span class="c1">#                                  pb_table.annot_rowid2.tolist())))</span>

        <span class="c1">#     # missing = am_pb_edges - set(pb_edges)</span>
        <span class="c1">#     # matches = infr._exec_pairwise_match(missing, config)</span>
        <span class="c1">#     # prefix = &#39;missing_&#39;</span>

        <span class="c1">#     # infr.relabel_using_reviews()</span>
        <span class="c1">#     # infr.apply_nondynamic_update()</span>

        <span class="c1">#     # infr.verbose = 100</span>
        <span class="c1">#     # for edge in missing:</span>
        <span class="c1">#     #     print(edge[0] in infr.aids)</span>
        <span class="c1">#     #     print(edge[1] in infr.aids)</span>

        <span class="c1">#     # fix = [</span>
        <span class="c1">#     #     (1184, 1185),</span>
        <span class="c1">#     #     (1376, 1378),</span>
        <span class="c1">#     #     (1377, 1378),</span>
        <span class="c1">#     # ]</span>

        <span class="c1">#     #     fb = infr.current_feedback(edge).copy()</span>
        <span class="c1">#     #     fb = ut.dict_subset(fb, [&#39;decision&#39;, &#39;tags&#39;, &#39;confidence&#39;],</span>
        <span class="c1">#     #                         default=None)</span>
        <span class="c1">#     #     fb[&#39;user_id&#39;] = &#39;jon_fixam&#39;</span>
        <span class="c1">#     #     fb[&#39;confidence&#39;] = &#39;pretty_sure&#39;</span>
        <span class="c1">#     #     fb[&#39;tags&#39;] += [&#39;photobomb&#39;]</span>
        <span class="c1">#     #     infr.add_feedback(edge, **fb)</span>

        <span class="c1">#     for c, match in enumerate(ut.ProgIter(matches)):</span>
        <span class="c1">#         edge = match.annot1[&#39;aid&#39;], match.annot2[&#39;aid&#39;]</span>

        <span class="c1">#         fig = pt.figure(fnum=1, clf=True)</span>
        <span class="c1">#         ax = pt.gca()</span>
        <span class="c1">#         # Draw with feature overlay</span>
        <span class="c1">#         match.show(ax, vert=False, heatmask=True, show_lines=True,</span>
        <span class="c1">#                    show_ell=False, show_ori=False, show_eig=False,</span>
        <span class="c1">#                    line_lw=1, line_alpha=.1,</span>
        <span class="c1">#                    modifysize=True)</span>
        <span class="c1">#         fname = prefix + &#39;_&#39;.join(ut.emap(str, edge))</span>
        <span class="c1">#         ax.set_xlabel(fname)</span>
        <span class="c1">#         fpath = join(str(dpath), fname + &#39;.jpg&#39;)</span>
        <span class="c1">#         vt.imwrite(fpath, pt.render_figure_to_image(fig, dpi=DPI))</span>
        <span class="c1">#     # visualize real photobomb cases</span>
        <span class="k">return</span> <span class="n">cases</span></div>

<div class="viewcode-block" id="Chap4.draw_hard_cases"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_hard_cases">[docs]</a>    <span class="k">def</span> <span class="nf">draw_hard_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        draw hard cases with and without overlay</span>

<span class="sd">        python -m ibeis Chap4.draw hard_cases GZ_Master1 match_state</span>
<span class="sd">        python -m ibeis Chap4.draw hard_cases PZ_Master1 match_state</span>
<span class="sd">        python -m ibeis Chap4.draw hard_cases PZ_Master1 photobomb_state</span>
<span class="sd">        python -m ibeis Chap4.draw hard_cases GZ_Master1 photobomb_state</span>



<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;match_state&#39;</span>
<span class="sd">            &gt;&gt;&gt; self.draw_hard_cases(task_key)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">task_key</span> <span class="o">+</span> <span class="s1">&#39;_hard_cases&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> hard cases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cases</span><span class="p">),</span> <span class="n">task_key</span><span class="p">))</span>

        <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;cases_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">subdir</span><span class="p">)</span>
        <span class="c1"># ut.delete(dpath)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">code_to_nice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">pz_gt_errors</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># NOQA</span>
            <span class="c1"># The true state of these pairs are:</span>
            <span class="n">NEGTV</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">239</span><span class="p">,</span> <span class="mi">3745</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">484</span><span class="p">,</span> <span class="mi">519</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">802</span><span class="p">,</span> <span class="mi">803</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">INCMP</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">4652</span><span class="p">,</span> <span class="mi">5245</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4405</span><span class="p">,</span> <span class="mi">5245</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">4109</span><span class="p">,</span> <span class="mi">5245</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">16192</span><span class="p">,</span> <span class="mi">16292</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">POSTV</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">6919</span><span class="p">,</span> <span class="mi">7192</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="n">prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">cases</span><span class="p">,</span> <span class="s1">&#39;draw </span><span class="si">{}</span><span class="s1"> hard case&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">),</span>
                           <span class="n">bs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">prog</span><span class="p">:</span>
            <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">]</span>
            <span class="n">real_name</span><span class="p">,</span> <span class="n">pred_name</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">],</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span>
            <span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">code_to_nice</span><span class="p">,</span> <span class="p">[</span><span class="n">real_name</span><span class="p">,</span> <span class="n">pred_name</span><span class="p">])</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;fail_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_name</span><span class="p">,</span> <span class="n">pred_name</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="c1"># Build x-label</span>
            <span class="n">_probs</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">_probs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">code_to_nice</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_probs</span><span class="p">)</span>
            <span class="n">probstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strkeys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nobr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;real=</span><span class="si">{}</span><span class="s1">, pred=</span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span><span class="p">,</span>
                                                    <span class="n">probstr</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="c1"># Draw with feature overlay</span>
            <span class="n">match</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">heatmask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">show_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="c1"># show_lines=True, line_lw=1, line_alpha=.1,</span>
                       <span class="c1"># ell_alpha=.3,</span>
                       <span class="n">show_ell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_ori</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_eig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">modifysize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="c1"># ax.get_xaxis().get_label().set_fontsize(24)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap4.write_metrics2"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.write_metrics2">[docs]</a>    <span class="k">def</span> <span class="nf">write_metrics2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="o">=</span><span class="s1">&#39;match_state&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.draw metrics PZ_PB_RF_TRAIN match_state</span>
<span class="sd">            python -m ibeis Chap4.draw metrics2 PZ_Master1 photobomb_state</span>
<span class="sd">            python -m ibeis Chap4.draw metrics2 GZ_Master1 photobomb_state</span>

<span class="sd">            python -m ibeis Chap4.draw metrics2 GZ_Master1 photobomb_state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;data_key&#39;</span><span class="p">]</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;clf_key&#39;</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>

        <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">sklearn_utils</span>
        <span class="n">threshes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_thresholds</span><span class="p">(</span><span class="s1">&#39;mcc&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">predict_from_probs</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="p">,</span> <span class="n">threshes</span><span class="p">,</span>
                                                  <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span>

        <span class="c1"># pred_enc = res.clf_probs.argmax(axis=1)</span>
        <span class="c1"># y_pred = pred_enc</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span>
        <span class="n">target_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">classification_report2</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">metric_df</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
        <span class="n">confusion_df</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confusion&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">metric_df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_df</span><span class="p">)</span>

        <span class="c1"># df = self.task_confusion[task_key]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">confusion_df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">colfmt</span> <span class="o">=</span> <span class="s1">&#39;|l|&#39;</span> <span class="o">+</span> <span class="s1">&#39;r&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|l|&#39;</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="n">colfmt</span><span class="p">,</span> <span class="n">hline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">groupxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>

        <span class="n">sum_pred</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sum_real</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">latex_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sum_pred</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sum$ predicted&#39;</span><span class="p">)</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">latex_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sum_real</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sum$ real&#39;</span><span class="p">)</span>
        <span class="n">confusion_tex</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">latex_str</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_tex</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">metric_df</span>
        <span class="c1"># df = self.task_metrics[task_key]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">({</span><span class="s1">&#39;mcc&#39;</span><span class="p">:</span> <span class="s1">&#39;MCC&#39;</span><span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;markedness&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmaker&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">top</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">bot</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_parts</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">newmid</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">newmid</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; -0.00 &#39;</span><span class="p">,</span> <span class="s1">&#39;  0.00 &#39;</span><span class="p">,</span> <span class="n">latex_str</span><span class="p">)</span>
        <span class="n">metrics_tex</span> <span class="o">=</span> <span class="n">latex_str</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">metrics_tex</span><span class="p">)</span>

        <span class="n">dpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">confusion_fname</span> <span class="o">=</span> <span class="s1">&#39;confusion2_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">metrics_fname</span> <span class="o">=</span> <span class="s1">&#39;eval_metrics2_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">confusion_fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">confusion_tex</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">metrics_fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">metrics_tex</span><span class="p">)</span>

        <span class="n">fpath1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">confusion_tex</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">dpath</span><span class="p">,</span>
                                 <span class="n">fname</span><span class="o">=</span><span class="n">confusion_fname</span><span class="p">)</span>
        <span class="n">fpath2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">metrics_tex</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">metrics_fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath1</span><span class="p">,</span> <span class="n">fpath2</span></div>

<div class="viewcode-block" id="Chap4.write_metrics"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.write_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">write_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="o">=</span><span class="s1">&#39;match_state&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.draw metrics PZ_PB_RF_TRAIN match_state</span>
<span class="sd">            python -m ibeis Chap4.draw metrics GZ_Master1 photobomb_state</span>

<span class="sd">            python -m ibeis Chap4.draw metrics PZ_Master1,GZ_Master1 photobomb_state,match_state</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;match_state&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;data_key&#39;</span><span class="p">]</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;clf_key&#39;</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">pred_enc</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pred_enc</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_enc</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span>
        <span class="n">target_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span>

        <span class="kn">from</span> <span class="nn">ibeis.scripts</span> <span class="k">import</span> <span class="n">sklearn_utils</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">classification_report2</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">metric_df</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
        <span class="n">confusion_df</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confusion&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">metric_df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_df</span><span class="p">)</span>

        <span class="c1"># df = self.task_confusion[task_key]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">confusion_df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">colfmt</span> <span class="o">=</span> <span class="s1">&#39;|l|&#39;</span> <span class="o">+</span> <span class="s1">&#39;r&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|l|&#39;</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="n">colfmt</span><span class="p">,</span> <span class="n">hline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">groupxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>

        <span class="n">sum_pred</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sum_real</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">latex_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sum_pred</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sum$ predicted&#39;</span><span class="p">)</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">latex_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sum_real</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sum$ real&#39;</span><span class="p">)</span>
        <span class="n">confusion_tex</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">latex_str</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_tex</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">metric_df</span>
        <span class="c1"># df = self.task_metrics[task_key]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">({</span><span class="s1">&#39;mcc&#39;</span><span class="p">:</span> <span class="s1">&#39;MCC&#39;</span><span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;markedness&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmaker&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">top</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">bot</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_parts</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">mid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">newmid</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">newmid</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; -0.00 &#39;</span><span class="p">,</span> <span class="s1">&#39;  0.00 &#39;</span><span class="p">,</span> <span class="n">latex_str</span><span class="p">)</span>
        <span class="n">metrics_tex</span> <span class="o">=</span> <span class="n">latex_str</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">metrics_tex</span><span class="p">)</span>

        <span class="n">dpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">confusion_fname</span> <span class="o">=</span> <span class="s1">&#39;confusion_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">metrics_fname</span> <span class="o">=</span> <span class="s1">&#39;eval_metrics_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">confusion_fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">confusion_tex</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">metrics_fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">metrics_tex</span><span class="p">)</span>

        <span class="n">fpath1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">confusion_tex</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">dpath</span><span class="p">,</span>
                                 <span class="n">fname</span><span class="o">=</span><span class="n">confusion_fname</span><span class="p">)</span>
        <span class="n">fpath2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">metrics_tex</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">metrics_fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath1</span><span class="p">,</span> <span class="n">fpath2</span></div>

<div class="viewcode-block" id="Chap4.write_sample_info"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.write_sample_info">[docs]</a>    <span class="k">def</span> <span class="nf">write_sample_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap4.draw sample_info GZ_Master1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;sample_info&#39;</span><span class="p">)</span>
        <span class="c1"># results[&#39;aid_pool&#39;]</span>
        <span class="c1"># results[&#39;encoded_labels2d&#39;]</span>
        <span class="c1"># results[&#39;multihist&#39;]</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="o">.</span><span class="n">from_netx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">number_of_components</span><span class="p">(),</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_aids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;pblm_aids&#39;</span><span class="p">]),</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;known_n_incomparable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">incomp_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span>
        <span class="n">subtasks</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;subtasks&#39;</span><span class="p">]</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">subtasks</span><span class="p">[</span><span class="s1">&#39;match_state&#39;</span><span class="p">]</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">encoded_df</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">class_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">INCMP</span><span class="p">))</span>
        <span class="n">incomp_edges</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">encoded_df</span><span class="p">[</span><span class="n">flags</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">nid_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">incomp_edges</span><span class="p">]</span>
        <span class="n">nid_edges</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nid_edges</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">n_true</span> <span class="o">=</span> <span class="n">nid_edges</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nid_edges</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;incomp_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;inside_pcc&#39;</span><span class="p">:</span> <span class="n">n_true</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;betweeen_pcc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">~</span><span class="n">n_true</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">subtasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">info</span><span class="p">[</span><span class="n">task_key</span> <span class="o">+</span> <span class="s1">&#39;_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">make_histogram</span><span class="p">()</span>
        <span class="n">info_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;sample_info.txt&#39;</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">),</span> <span class="n">info_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap4.write_importance"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.write_importance">[docs]</a>    <span class="k">def</span> <span class="nf">write_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap4.draw importance GZ_Master1,PZ_Master1 match_state</span>

<span class="sd">        python -m ibeis Chap4.draw importance GZ_Master1 match_state</span>
<span class="sd">        python -m ibeis Chap4.draw importance PZ_Master1 match_state</span>

<span class="sd">        python -m ibeis Chap4.draw importance GZ_Master1 photobomb_state</span>
<span class="sd">        python -m ibeis Chap4.draw importance PZ_Master1 photobomb_state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Print info for latex table</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">][</span><span class="n">task_key</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">importances</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">importances</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">top_dims</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">vals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_top</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">top_dims</span><span class="p">[:</span><span class="n">num_top</span><span class="p">]:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">feat_alias</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">tt{{</span><span class="si">{}</span><span class="s1">}} &amp; $</span><span class="si">{:.4f}</span><span class="s1">$ </span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;feat_importance_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TOP </span><span class="si">{}</span><span class="s1"> importances for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_top</span><span class="p">,</span> <span class="n">task_key</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# of dimensions: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">latex_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">extra_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            \begin{{table}}[h]</span>
<span class="sd">                \centering</span>
<span class="sd">                \caption{{Top {}/{} dimensions for {}}}</span>
<span class="sd">                \begin{{tabular}}{{lr}}</span>
<span class="sd">                    \toprule</span>
<span class="sd">                    Dimension &amp; Importance \\</span>
<span class="sd">                    \midrule</span>
<span class="sd">                    {}</span>
<span class="sd">                    \bottomrule</span>
<span class="sd">                \end{{tabular}}</span>
<span class="sd">            \end{{table}}</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_top</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">importances</span><span class="p">),</span> <span class="n">task_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="n">latex_str</span><span class="p">)</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">extra_</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">latex_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap4.draw_prune"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_prune">[docs]</a>    <span class="k">def</span> <span class="nf">draw_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap4.draw importance GZ_Master1</span>

<span class="sd">            python -m ibeis Chap4.draw importance PZ_Master1 photobomb_state</span>
<span class="sd">            python -m ibeis Chap4.draw importance PZ_Master1 match_state</span>

<span class="sd">            python -m ibeis Chap4.draw prune GZ_Master1,PZ_Master1</span>
<span class="sd">            python -m ibeis Chap4.draw prune PZ_Master1</span>

<span class="sd">        &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;GZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; self = Chap4(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;prune&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>

        <span class="n">n_dims</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;n_dims&#39;</span><span class="p">]</span>
        <span class="n">mdis_list</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mdis_list&#39;</span><span class="p">]</span>
        <span class="n">sub_reports</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sub_reports&#39;</span><span class="p">]</span>

        <span class="c1"># mccs = [r[&#39;mcc&#39;] for r in reports]</span>
        <span class="c1"># mccs2 = np.array([[r[&#39;mcc&#39;] for r in rs] for rs in sub_reports])</span>
        <span class="c1"># pos_mccs = np.array([[r[&#39;metrics&#39;][&#39;mcc&#39;][POSTV] for r in rs]</span>
        <span class="c1"># for rs in sub_reports])</span>
        <span class="n">ave_mccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;mcc&#39;</span><span class="p">][</span><span class="s1">&#39;ave/sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">sub_reports</span><span class="p">])</span>

        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">doclf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span><span class="n">n_dims</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">ave_mccs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)},</span>
                      <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">force_xticks</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">n_dims</span><span class="p">)],</span>
                      <span class="c1"># num_xticks=5,</span>
                      <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MCC&#39;</span><span class="p">,</span>
                      <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;# feature dimensions&#39;</span><span class="p">,</span>
                      <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">n_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>

        <span class="c1"># Find the point at which accuracy starts to fall</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">ave_mccs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># middle = ut.take_around_percentile(u, .5, len(n_dims) // 2.2)</span>
        <span class="c1"># thresh = middle.mean() - (middle.std() * 6)</span>
        <span class="c1"># print(&#39;thresh = %r&#39; % (thresh,))</span>
        <span class="c1"># idx = np.where(u &lt; thresh)[0][0]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">n_to_mid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">n_dims</span><span class="p">,</span> <span class="n">mdis_list</span><span class="p">)</span>
        <span class="n">pruned_importance</span> <span class="o">=</span> <span class="n">n_to_mid</span><span class="p">[</span><span class="n">n_dims</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">wordcloud</span><span class="p">(</span><span class="n">pruned_importance</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;wc_</span><span class="si">{}</span><span class="s1">_pruned.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">fig_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fig_fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">pruned_importance</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">pruned_importance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">top_dims</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">vals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_top</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">top_dims</span><span class="p">[:</span><span class="n">num_top</span><span class="p">]:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">feat_alias</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">tt{{</span><span class="si">{}</span><span class="s1">}} &amp; $</span><span class="si">{:.4f}</span><span class="s1">$ </span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">latex_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">align_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>

        <span class="n">increase</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">latex_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">extra_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            \begin{{table}}[h]</span>
<span class="sd">                \centering</span>
<span class="sd">                \caption{{Pruned top {}/{} dimensions for {} increases MCC by {:.4f}}}</span>
<span class="sd">                \begin{{tabular}}{{lr}}</span>
<span class="sd">                    \toprule</span>
<span class="sd">                    Dimension &amp; Importance \\</span>
<span class="sd">                    \midrule</span>
<span class="sd">                    {}</span>
<span class="sd">                    \bottomrule</span>
<span class="sd">                \end{{tabular}}</span>
<span class="sd">            \end{{table}}</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_top</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pruned_importance</span><span class="p">),</span> <span class="n">task_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
                 <span class="n">increase</span><span class="p">,</span> <span class="n">latex_str</span><span class="p">)</span>
        <span class="c1"># topinfo = vt.AnnotPairFeatInfo(list(pruned_importance.keys()))</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;pruned_feat_importance_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">extra_</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.tex&#39;</span><span class="p">),</span> <span class="n">latex_str</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">(</span><span class="n">n_to_mid</span><span class="p">[</span><span class="n">n_dims</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span> <span class="s1">&#39;vals&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">(</span><span class="n">n_to_mid</span><span class="p">[</span><span class="n">n_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;vals&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Chap4.measure_thresh"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.measure_thresh">[docs]</a>    <span class="k">def</span> <span class="nf">measure_thresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pblm</span><span class="p">):</span>
        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">clf_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span>

        <span class="n">truth_colors</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_get_truth_colors</span><span class="p">()</span>

        <span class="n">cfms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">POSTV</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">doclf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># NOQA</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cfms</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">cfms</span><span class="o">.</span><span class="n">n_fp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">truth_colors</span><span class="p">[</span><span class="n">POSTV</span><span class="p">])</span>

        <span class="n">cfms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">NEGTV</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cfms</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">cfms</span><span class="o">.</span><span class="n">n_fp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">truth_colors</span><span class="p">[</span><span class="n">NEGTV</span><span class="p">])</span>

        <span class="c1"># cfms = res.confusions(INCMP)</span>
        <span class="c1"># if len(cfms.thresholds) == 1:</span>
        <span class="c1">#     cfms.thresholds = [0, 1]</span>
        <span class="c1">#     cfms.n_fp = np.array(cfms.n_fp.tolist() * 2)</span>
        <span class="c1"># ax.plot(cfms.thresholds, cfms.n_fp, label=&#39;incomparable&#39;,</span>
        <span class="c1">#         color=pt.color_funcs.darken_rgb(truth_colors[INCMP], .15))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;n_fp&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">cfms</span><span class="o">.</span><span class="n">plot_vs</span><span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="s1">&#39;thresholds&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_draw_score_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">fnum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; helper &quot;&quot;&quot;</span>
        <span class="n">bins</span><span class="p">,</span> <span class="n">freq0</span><span class="p">,</span> <span class="n">freq1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="s1">&#39;neg_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_freq&#39;</span><span class="p">])</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">bins</span><span class="p">,</span> <span class="p">(</span><span class="n">freq0</span><span class="p">,</span> <span class="n">freq1</span><span class="p">),</span> <span class="n">label_list</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">),</span>
            <span class="n">color_list</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">FALSE_RED</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">TRUE_BLUE</span><span class="p">),</span>
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ytickformat</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span>
            <span class="c1"># title=&#39;LNBNN positive separation&#39;</span>
        <span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fig</span>

<div class="viewcode-block" id="Chap4.draw_rerank"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_rerank">[docs]</a>    <span class="k">def</span> <span class="nf">draw_rerank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;rerank&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>

        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">lnbnn_cdf</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clf_cdf</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_cmcs</span><span class="p">([</span><span class="n">lnbnn_cdf</span><span class="p">,</span> <span class="n">clf_cdf</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;ranking&#39;</span><span class="p">,</span> <span class="s1">&#39;rank+clf&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--diskshow&#39;</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap4.draw_class_score_hist"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_class_score_hist">[docs]</a>    <span class="k">def</span> <span class="nf">draw_class_score_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plots distribution of positive and negative scores &quot;&quot;&quot;</span>
        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;data_key&#39;</span><span class="p">]</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;clf_key&#39;</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pos_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neg_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="o">~</span><span class="n">y</span><span class="p">],</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_freq</span> <span class="o">=</span> <span class="n">pos_freq</span> <span class="o">/</span> <span class="n">pos_freq</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">neg_freq</span> <span class="o">=</span> <span class="n">neg_freq</span> <span class="o">/</span> <span class="n">neg_freq</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">score_hist_pos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="n">bins</span><span class="p">,</span> <span class="s1">&#39;pos_freq&#39;</span><span class="p">:</span> <span class="n">pos_freq</span><span class="p">,</span> <span class="s1">&#39;neg_freq&#39;</span><span class="p">:</span> <span class="n">neg_freq</span><span class="p">}</span>

        <span class="n">lnbnn_xy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;lnbnn_xy&#39;</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">lnbnn_xy</span><span class="p">[</span><span class="s1">&#39;score_lnbnn_1vM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">lnbnn_xy</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Get 95% of the data at least</span>
        <span class="n">maxbin</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">scores</span><span class="o">.</span><span class="n">argsort</span><span class="p">()][</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">05</span><span class="p">))]</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxbin</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pos_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neg_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="o">~</span><span class="n">y</span><span class="p">],</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_freq</span> <span class="o">=</span> <span class="n">pos_freq</span> <span class="o">/</span> <span class="n">pos_freq</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">neg_freq</span> <span class="o">=</span> <span class="n">neg_freq</span> <span class="o">/</span> <span class="n">neg_freq</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">score_hist_lnbnn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="n">bins</span><span class="p">,</span> <span class="s1">&#39;pos_freq&#39;</span><span class="p">:</span> <span class="n">pos_freq</span><span class="p">,</span> <span class="s1">&#39;neg_freq&#39;</span><span class="p">:</span> <span class="n">neg_freq</span><span class="p">}</span>

        <span class="n">fig1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_score_hist</span><span class="p">(</span><span class="n">score_hist_pos</span><span class="p">,</span> <span class="s1">&#39;positive probability&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_score_hist</span><span class="p">(</span><span class="n">score_hist_lnbnn</span><span class="p">,</span> <span class="s1">&#39;LNBNN score&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;score_hist_pos_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_key</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">),</span>
                   <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;score_hist_lnbnn.png&#39;</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">),</span>
                   <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap4.draw_mcc_thresh"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_mcc_thresh">[docs]</a>    <span class="k">def</span> <span class="nf">draw_mcc_thresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap4.draw mcc_thresh GZ_Master1 match_state</span>
<span class="sd">        python -m ibeis Chap4.draw mcc_thresh PZ_Master1 match_state</span>

<span class="sd">        python -m ibeis Chap4.draw mcc_thresh GZ_Master1 photobomb_state</span>
<span class="sd">        python -m ibeis Chap4.draw mcc_thresh PZ_Master1 photobomb_state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;data_key&#39;</span><span class="p">]</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;clf_key&#39;</span><span class="p">]</span>

        <span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span>

        <span class="n">code_to_nice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">task_key</span> <span class="o">==</span> <span class="s1">&#39;photobomb_state&#39;</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pb&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">task_key</span> <span class="o">==</span> <span class="s1">&#39;match_state&#39;</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">POSTV</span><span class="p">,</span> <span class="n">NEGTV</span><span class="p">,</span> <span class="n">INCMP</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>

        <span class="n">roc_curves</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">class_nice</span> <span class="o">=</span> <span class="n">code_to_nice</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">mcc</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">mcc</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">mcc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">roc_curves</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">class_nice</span> <span class="o">+</span> <span class="s1">&#39;, t=</span><span class="si">{:.2f}</span><span class="s1">, mcc=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mcc</span><span class="p">),</span>
                 <span class="s1">&#39;thresh&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="s1">&#39;mcc&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="o">.</span><span class="n">mcc</span><span class="p">},</span>
            <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># NOQA</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">roc_curves</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mcc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MCC&#39;</span><span class="p">)</span>
        <span class="c1"># ax.set_title(&#39;%s ROC for %s&#39; % (target_class.title(), self.species))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;mcc_thresh_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">fig_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fig_fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--diskshow&#39;</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">fig_fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap4.draw_roc"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_roc">[docs]</a>    <span class="k">def</span> <span class="nf">draw_roc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap4.draw roc GZ_Master1 photobomb_state</span>
<span class="sd">        python -m ibeis Chap4.draw roc GZ_Master1 match_state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;data_key&#39;</span><span class="p">]</span>
        <span class="n">clf_key</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;clf_key&#39;</span><span class="p">]</span>

        <span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;task_combo_res&#39;</span><span class="p">]</span>
        <span class="n">lnbnn_xy</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;lnbnn_xy&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">task_key</span> <span class="o">==</span> <span class="s1">&#39;match_state&#39;</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">lnbnn_xy</span><span class="p">[</span><span class="s1">&#39;score_lnbnn_1vM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">lnbnn_xy</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># task_key = &#39;match_state&#39;</span>
            <span class="n">target_class</span> <span class="o">=</span> <span class="n">POSTV</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ConfusionMetrics</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">target_class</span><span class="p">)</span>
            <span class="n">roc_curves</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;LNBNN&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="o">.</span><span class="n">tpr</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="o">.</span><span class="n">auc</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;learned&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="n">c3</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="n">c3</span><span class="o">.</span><span class="n">tpr</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">c3</span><span class="o">.</span><span class="n">auc</span><span class="p">},</span>
            <span class="p">]</span>

            <span class="n">at_metric</span> <span class="o">=</span> <span class="s1">&#39;tpr&#39;</span>
            <span class="k">for</span> <span class="n">at_value</span> <span class="ow">in</span> <span class="p">[</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">]:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">want_metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="s1">&#39;n_false_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;n_true_pos&#39;</span><span class="p">]:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_@_</span><span class="si">{}</span><span class="s1">=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">want_metric</span><span class="p">,</span> <span class="n">at_metric</span><span class="p">,</span> <span class="n">at_value</span><span class="p">)</span>
                    <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">c3</span><span class="o">.</span><span class="n">get_metric_at_metric</span><span class="p">(</span><span class="n">want_metric</span><span class="p">,</span> <span class="n">at_metric</span><span class="p">,</span> <span class="n">at_value</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_class</span> <span class="o">=</span> <span class="s1">&#39;pb&#39;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">target_class</span><span class="p">)</span>
            <span class="n">roc_curves</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;learned&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="o">.</span><span class="n">tpr</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="o">.</span><span class="n">auc</span><span class="p">},</span>
            <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># NOQA</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">roc_curves</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fpr&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tpr&#39;</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AUC=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;false positive rate&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;true positive rate&#39;</span><span class="p">)</span>
        <span class="c1"># ax.set_title(&#39;%s ROC for %s&#39; % (target_class.title(), self.species))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;roc_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">fig_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fig_fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap4.draw_wordcloud"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_wordcloud">[docs]</a>    <span class="k">def</span> <span class="nf">draw_wordcloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">feat_alias</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">][</span><span class="n">task_key</span><span class="p">])</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">wordcloud</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;wc_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">fig_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fig_fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap4.draw_tagged_pair"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.draw_tagged_pair">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">draw_tagged_pair</span><span class="p">(</span><span class="n">Chap4</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="c1"># ibs = ibeis.opendb(defaultdb=&#39;GZ_Master1&#39;)</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="s1">&#39;PZ_Master1&#39;</span><span class="p">)</span>

        <span class="n">query_tag</span> <span class="o">=</span> <span class="s1">&#39;leftrightface&#39;</span>

        <span class="n">rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_tag_text</span><span class="p">(</span><span class="n">rowids</span><span class="p">)]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">tags</span><span class="p">))))</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">query_tag</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
        <span class="n">filtered_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">rowids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aids</span><span class="p">(</span><span class="n">filtered_rowids</span><span class="p">)</span>

        <span class="c1"># The facematch leftright side example</span>
        <span class="c1"># edge = (5161, 5245)</span>

        <span class="n">edge</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># for edge in ut.InteractiveIter(edges):</span>
        <span class="n">infr</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">AnnotInference</span><span class="p">(</span><span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="n">edge</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">reset_feedback</span><span class="p">(</span><span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_exec_pairwise_match</span><span class="p">([</span><span class="n">edge</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Fix the example tags</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">add_feedback</span><span class="p">(</span>
                <span class="n">edge</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;facematch&#39;</span><span class="p">,</span> <span class="s1">&#39;leftrightface&#39;</span><span class="p">],</span>
                <span class="n">user_id</span><span class="o">=</span><span class="s1">&#39;qt-hack&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="s1">&#39;pretty_sure&#39;</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">write_ibeis_staging_feedback</span><span class="p">()</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">write_ibeis_annotmatch_feedback</span><span class="p">()</span>
            <span class="k">pass</span>

        <span class="c1"># THE DEPCACHE IS BROKEN FOR ANNOTMATCH APPARENTLY! &gt;:(</span>
        <span class="c1"># Redo matches</span>
        <span class="n">feat_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">,</span> <span class="s1">&#39;kpts&#39;</span><span class="p">,</span> <span class="s1">&#39;_feats&#39;</span><span class="p">,</span> <span class="s1">&#39;flann&#39;</span><span class="p">]</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="o">.</span><span class="n">_mutable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="o">.</span><span class="n">_mutable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feat_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">match</span><span class="o">.</span><span class="n">apply_all</span><span class="p">({})</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">heatmask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">show_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_ell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_ori</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_eig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="c1"># ell_alpha=.3,</span>
                   <span class="n">modifysize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># ax.set_xlabel(xlabel)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">Chap4</span><span class="p">()</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;custom_match_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_tag</span><span class="p">,</span> <span class="o">*</span><span class="n">edge</span><span class="p">)</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">))</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div>

<div class="viewcode-block" id="Chap4.custom_single_hard_case"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap4.custom_single_hard_case">[docs]</a>    <span class="k">def</span> <span class="nf">custom_single_hard_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; defaultdb = &#39;PZ_PB_RF_TRAIN&#39;</span>
<span class="sd">            &gt;&gt;&gt; #defaultdb = &#39;GZ_Master1&#39;</span>
<span class="sd">            &gt;&gt;&gt; defaultdb = &#39;PZ_MTEST&#39;</span>
<span class="sd">            &gt;&gt;&gt; self = Chap4.collect(defaultdb)</span>
<span class="sd">            &gt;&gt;&gt; self.dbname = &#39;PZ_PB_RF_TRAIN&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task_key</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="mi">383</span><span class="p">,</span> <span class="mi">503</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_cases</span><span class="p">[</span><span class="n">task_key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">_case</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">_case</span>
                <span class="k">break</span>

        <span class="kn">import</span> <span class="nn">ibeis</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">ibeis</span> <span class="k">import</span> <span class="n">core_annots</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;augment_orientation&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;ratio_thresh&#39;</span><span class="p">:</span> <span class="o">.</span><span class="mi">8</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;checks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sver_xy_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">02</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sver_ori_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Knorm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;symmetric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashdict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
        <span class="n">real_name</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]</span>
        <span class="n">pred_name</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">]</span>
        <span class="n">code_to_nice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_nice_lookup</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
        <span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">code_to_nice</span><span class="p">,</span>
                                       <span class="p">[</span><span class="n">real_name</span><span class="p">,</span> <span class="n">pred_name</span><span class="p">])</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;fail_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span><span class="p">,</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
        <span class="c1"># Draw case</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">case</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">code_to_nice</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setintersect</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">probs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_keys</span><span class="p">(</span><span class="n">code_to_nice</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="n">probstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strkeys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nobr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">key_order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;real=</span><span class="si">{}</span><span class="s1">, pred=</span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">real_nice</span><span class="p">,</span> <span class="n">pred_nice</span><span class="p">,</span>
                                                <span class="n">probstr</span><span class="p">)</span>

        <span class="n">match_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pairwise_match&#39;</span><span class="p">,</span> <span class="p">([</span><span class="n">aid1</span><span class="p">],</span> <span class="p">[</span><span class="n">aid2</span><span class="p">]),</span>
                                       <span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">match_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">configured_lazy_annots</span> <span class="o">=</span> <span class="n">core_annots</span><span class="o">.</span><span class="n">make_configured_annots</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">aid1</span><span class="p">],</span> <span class="p">[</span><span class="n">aid2</span><span class="p">],</span> <span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot1</span> <span class="o">=</span> <span class="n">configured_lazy_annots</span><span class="p">[</span><span class="n">config</span><span class="p">][</span><span class="n">aid1</span><span class="p">]</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot2</span> <span class="o">=</span> <span class="n">configured_lazy_annots</span><span class="p">[</span><span class="n">config</span><span class="p">][</span><span class="n">aid2</span><span class="p">]</span>
        <span class="n">match</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">heatmask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">show_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_ell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_ori</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_eig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="c1"># ell_alpha=.3,</span>
                   <span class="n">modifysize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

        <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;cases_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_key</span><span class="p">)</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">),</span> <span class="n">subdir</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_custom.jpg&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Chap3Measures"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">Chap3Measures</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Chap3Measures.measure_baseline"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_baseline">[docs]</a>    <span class="k">def</span> <span class="nf">measure_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap3(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._precollect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">}))]</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;baseline&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_foregroundness_intra"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_foregroundness_intra">[docs]</a>    <span class="k">def</span> <span class="nf">measure_foregroundness_intra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_intra_enc</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">)</span>
        <span class="c1"># qaids, daids_list, info_list = sample.expand()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">qaids</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">qaids</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">daids</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;qsize&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">),</span> <span class="s1">&#39;dsize&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">daids</span><span class="p">)}</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">all_dict_combinations</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;featweight_enabled&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">_ranking_hist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hist</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;foregroundness_intra&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.draw_foregroundness_intra"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.draw_foregroundness_intra">[docs]</a>    <span class="k">def</span> <span class="nf">draw_foregroundness_intra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap3.measure foregroundness_intra --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        python -m ibeis Chap3.draw foregroundness_intra --dbs=GZ_Master1,PZ_Master1 --diskshow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;foregroundness_intra&#39;</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">hists</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pcfgs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;pcfg&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hists</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fg_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">pcfgs</span><span class="p">,</span> <span class="s1">&#39;featweight_enabled&#39;</span><span class="p">)</span>

        <span class="n">cdfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fg</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">((</span><span class="s1">&#39;fg_on&#39;</span><span class="p">)):</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fg=T&#39;</span> <span class="k">if</span> <span class="n">fg</span> <span class="k">else</span> <span class="s1">&#39;fg=F&#39;</span><span class="p">)</span>
            <span class="n">hists</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">pad_vstack</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;hists&#39;</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">hists</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
            <span class="n">cdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span>
            <span class="n">qsize</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;qsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;dsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;dsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">dsize</span> <span class="o">=</span> <span class="n">ave_str</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{:s}</span><span class="s1">, dsize=</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsize</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_foregroundness"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_foregroundness">[docs]</a>    <span class="k">def</span> <span class="nf">measure_foregroundness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;same_occur&#39;</span>
            <span class="c1"># method=&#39;same_enc&#39;</span>
        <span class="p">)</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cfgdict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fg_on&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict1</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict1</span><span class="p">})))</span>

        <span class="n">cfgdict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fg_on&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict2</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict2</span><span class="p">})))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;foregroundness&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_invar"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_invar">[docs]</a>    <span class="k">def</span> <span class="nf">measure_invar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cfgdict_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span>  <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rotation_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="c1"># {&#39;affine_invariance&#39;:  True, &#39;rotation_invariance&#39;:  True, &#39;query_rotation_heuristic&#39;: False},</span>
            <span class="c1"># {&#39;affine_invariance&#39;: False, &#39;rotation_invariance&#39;:  True, &#39;query_rotation_heuristic&#39;: False},</span>
            <span class="p">{</span><span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;rotation_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span>  <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rotation_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span>  <span class="kc">True</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;rotation_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span>  <span class="kc">True</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">cfgdict_list</span><span class="p">:</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;invar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_smk"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_smk">[docs]</a>    <span class="k">def</span> <span class="nf">measure_smk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap3.measure smk --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        python -m ibeis Chap3.draw smk --dbs=GZ_Master1,PZ_Master1 --diskshow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">ibeis.algo.smk.smk_pipeline</span> <span class="k">import</span> <span class="n">SMKRequest</span>
        <span class="c1"># ibs = ibeis.opendb(&#39;PZ_MTEST&#39;)</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># SMK pipeline</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nAssign&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_words&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="s1">&#39;sv_on&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">qreq_</span> <span class="o">=</span> <span class="n">SMKRequest</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">qreq_</span><span class="o">.</span><span class="n">ensure_data</span><span class="p">()</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
        <span class="n">name_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_name_ranks</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">dnids</span><span class="p">))</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">name_ranks</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">})))</span>

        <span class="c1"># LNBNN pipeline</span>
        <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;smk&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_nsum"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_nsum">[docs]</a>    <span class="k">def</span> <span class="nf">measure_nsum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        python -m ibeis Chap3.measure nsum --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        python -m ibeis Chap3.draw nsum --dbs=GZ_Master1,PZ_Master1 --diskshow</span>

<span class="sd">        from ibeis.scripts.thesis import *</span>
<span class="sd">        self = Chap3(&#39;GZ_Master1&#39;)</span>
<span class="sd">        self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">        self = Chap3(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        self._precollect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">cfgdict1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;score_method&#39;</span><span class="p">:</span> <span class="s1">&#39;nsum&#39;</span><span class="p">,</span> <span class="s1">&#39;prescore_method&#39;</span><span class="p">:</span> <span class="s1">&#39;nsum&#39;</span><span class="p">})</span>
        <span class="n">cfgdict2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;score_method&#39;</span><span class="p">:</span> <span class="s1">&#39;csum&#39;</span><span class="p">,</span> <span class="s1">&#39;prescore_method&#39;</span><span class="p">:</span> <span class="s1">&#39;csum&#39;</span><span class="p">})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cdf1</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf1</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict1</span><span class="p">})))</span>
            <span class="n">cdf2</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict2</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf2</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict2</span><span class="p">})))</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>
            <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
            <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
                <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Check dpername issue</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sv_on&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">cfgdict1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;score_method&#39;</span><span class="p">:</span> <span class="s1">&#39;nsum&#39;</span><span class="p">,</span> <span class="s1">&#39;prescore_method&#39;</span><span class="p">:</span> <span class="s1">&#39;nsum&#39;</span><span class="p">})</span>
            <span class="n">cfgdict2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_union</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;score_method&#39;</span><span class="p">:</span> <span class="s1">&#39;csum&#39;</span><span class="p">,</span> <span class="s1">&#39;prescore_method&#39;</span><span class="p">:</span> <span class="s1">&#39;csum&#39;</span><span class="p">})</span>

            <span class="n">qaids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2491</span><span class="p">]</span>

            <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="n">daids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">nids</span><span class="p">))</span><span class="o">.</span><span class="n">aids</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">qreq1_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict1</span><span class="p">)</span>
                <span class="n">qreq2_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict2</span><span class="p">)</span>
                <span class="n">cm_list1</span> <span class="o">=</span> <span class="n">qreq1_</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">cm_list2</span> <span class="o">=</span> <span class="n">qreq2_</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">cm1</span> <span class="o">=</span> <span class="n">cm_list1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cm2</span> <span class="o">=</span> <span class="n">cm_list2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">cm1</span> <span class="o">==</span> <span class="n">cm2</span><span class="p">)</span>

            <span class="c1"># cm_list1 = [cm.extend_results(qreq1_) for cm in cm_list1]</span>
            <span class="c1"># cm_list2 = [cm.extend_results(qreq2_) for cm in cm_list2]</span>

            <span class="c1"># cm_list1 = [cm.compress_results() for cm in cm_list1]</span>
            <span class="c1"># cm_list2 = [cm.compress_results() for cm in cm_list2]</span>

            <span class="n">name_ranks1</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_name_ranks</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list1</span><span class="p">]</span>
            <span class="n">name_ranks2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_name_ranks</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list2</span><span class="p">]</span>

            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">name_ranks1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">name_ranks2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;idxs = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idxs</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ranks1 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">name_ranks1</span><span class="p">,</span> <span class="n">idxs</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ranks2 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">name_ranks2</span><span class="p">,</span> <span class="n">idxs</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cm1</span> <span class="o">=</span> <span class="n">cm_list1</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># NOQA</span>
                <span class="n">cm2</span> <span class="o">=</span> <span class="n">cm_list2</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># NOQA</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;nsum&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_dbsize"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_dbsize">[docs]</a>    <span class="k">def</span> <span class="nf">measure_dbsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">daids</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;dsize&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_kexpt"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_kexpt">[docs]</a>    <span class="k">def</span> <span class="nf">measure_kexpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_varied_inputs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">cfg_grid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">all_dict_combinations</span><span class="p">(</span><span class="n">cfg_grid</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">daids</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span><span class="p">):</span>
                <span class="n">cdf</span> <span class="o">=</span> <span class="n">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cdf</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_dict</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pcfg&#39;</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">})))</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;kexpt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3Measures.measure_dbstats"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Measures.measure_dbstats">[docs]</a>    <span class="k">def</span> <span class="nf">measure_dbstats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>

        <span class="c1"># self.ibs.print_annot_stats(self.aids_pool)</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">)</span>

        <span class="n">encounters</span> <span class="o">=</span> <span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">encounters</span><span class="p">)</span><span class="o">.</span><span class="n">nids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nid_to_enc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span>

        <span class="n">single_encs</span> <span class="o">=</span> <span class="p">{</span><span class="n">nid</span><span class="p">:</span> <span class="n">e</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">nid_to_enc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">multi_encs</span> <span class="o">=</span> <span class="p">{</span><span class="n">nid</span><span class="p">:</span> <span class="n">e</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">nid_to_enc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">multi_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">multi_encs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="n">enc_deltas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">encs_</span> <span class="ow">in</span> <span class="n">nid_to_enc</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">encs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">image_unixtimes_asfloat</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">times</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">enc_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
        <span class="n">max_enc_timedelta</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">enc_deltas</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max enc timedelta = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_unix_timedelta_str</span><span class="p">(</span><span class="n">max_enc_timedelta</span><span class="p">)))</span>

        <span class="n">multi_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_stats_dict</span><span class="p">(</span><span class="n">multi_aids</span><span class="p">)</span>
        <span class="n">multi_stats</span><span class="p">[</span><span class="s1">&#39;enc_per_name&#39;</span><span class="p">]</span>

        <span class="n">enc_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;species_nice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_nice</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;n_singleton_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_encs</span><span class="p">)</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;n_resighted_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_encs</span><span class="p">)</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;n_encounter_per_resighted_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ave_str</span><span class="p">(</span>
            <span class="o">*</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">multi_stats</span><span class="p">[</span><span class="s1">&#39;enc_per_name&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]),</span>
            <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_annots_per_enc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">encounters</span><span class="p">)</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;n_annots_per_encounter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ave_str</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n_annots_per_enc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">n_annots_per_enc</span><span class="p">),</span>
            <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">enc_info</span><span class="p">[</span><span class="s1">&#39;n_annots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n_annots_per_enc</span><span class="p">)</span>

        <span class="c1"># qual_info = ut.odict()</span>
        <span class="n">qual_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">quality_texts</span><span class="p">)</span>
        <span class="n">qual_info</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qual_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">qual_info</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qual_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">qual_info</span><span class="p">[</span><span class="s1">&#39;species_nice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_nice</span>

        <span class="n">view_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">viewpoint_code</span><span class="p">)</span>
        <span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;species_nice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_nice</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;enc&#39;</span><span class="p">:</span> <span class="n">enc_info</span><span class="p">,</span>
            <span class="s1">&#39;qual&#39;</span><span class="p">:</span> <span class="n">qual_info</span><span class="p">,</span>
            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="n">view_info</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;measure_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;dbstats&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">[</span><span class="n">expt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span></div></div>


<div class="viewcode-block" id="Chap3Draw"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">Chap3Draw</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Chap3Draw.draw_baseline"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_baseline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">baseline_cdf</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">([</span><span class="n">baseline_cdf</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_smk"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_smk">[docs]</a>    <span class="k">def</span> <span class="nf">draw_smk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure smk --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw smk --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;smk&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_foregroundness"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_foregroundness">[docs]</a>    <span class="k">def</span> <span class="nf">draw_foregroundness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure foregroundness --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw foregroundness --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fg=F&#39;</span><span class="p">,</span> <span class="s1">&#39;fg=T&#39;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_invar"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_invar">[docs]</a>    <span class="k">def</span> <span class="nf">draw_invar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure invar --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw invar --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">ALIAS_KEYS</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invert_dict</span><span class="p">({</span>
            <span class="s1">&#39;RI&#39;</span><span class="p">:</span> <span class="s1">&#39;rotation_invariance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AI&#39;</span><span class="p">:</span> <span class="s1">&#39;affine_invariance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;QRH&#39;</span><span class="p">:</span> <span class="s1">&#39;query_rotation_heuristic&#39;</span><span class="p">,</span> <span class="p">})</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span>
                   <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;pcfg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rotation_invariance&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pcfgs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;pcfg&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pcfgs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rotation_invariance&#39;</span><span class="p">]</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_cfg_lbl</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="n">ALIAS_KEYS</span><span class="p">,</span> <span class="n">pcfg</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">pcfg</span> <span class="ow">in</span> <span class="n">pcfgs</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">label_alias</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_nsum"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_nsum">[docs]</a>    <span class="k">def</span> <span class="nf">draw_nsum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure nsum --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw nsum --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="c1"># expt_name = ut.get_stack_frame().f_code.co_name.replace(&#39;draw_&#39;, &#39;&#39;)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="s1">&#39;nsum&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="c1"># pcfgs = ut.take_column(infos, &#39;pcfg&#39;)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nsum&#39;</span><span class="p">:</span> <span class="s1">&#39;fmech&#39;</span><span class="p">,</span>
            <span class="s1">&#39;csum&#39;</span><span class="p">:</span> <span class="s1">&#39;amech&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;pcfg&#39;</span><span class="p">][</span><span class="s1">&#39;score_method&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;,dpername=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;t_dpername&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_nsum_simple"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_nsum_simple">[docs]</a>    <span class="k">def</span> <span class="nf">draw_nsum_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure nsum --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw nsum --dbs=GZ_Master1,PZ_Master1</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;hacked&quot;</span><span class="p">)</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="c1"># expt_name = ut.get_stack_frame().f_code.co_name.replace(&#39;draw_&#39;, &#39;&#39;)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;/home/joncrall/latex/crall-thesis-2017/figures3/PZ_Master1/nsum.pkl&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="c1"># results = self.ensure_results(expt_name)</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="c1"># pcfgs = ut.take_column(infos, &#39;pcfg&#39;)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nsum&#39;</span><span class="p">:</span> <span class="s1">&#39;fmech&#39;</span><span class="p">,</span>
            <span class="s1">&#39;csum&#39;</span><span class="p">:</span> <span class="s1">&#39;amech&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;pcfg&#39;</span><span class="p">][</span><span class="s1">&#39;score_method&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;,dpername=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;t_dpername&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">]</span>
        <span class="c1"># hack</span>
        <span class="n">cdfs</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">qsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">)</span>
        <span class="n">dsizes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">qsizes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">dsizes</span><span class="p">)</span>
        <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="s1">&#39;qsize=</span><span class="si">{}</span><span class="s1">, dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;nsum_simple.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_kexpt"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_kexpt">[docs]</a>    <span class="k">def</span> <span class="nf">draw_kexpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ibeis Chap3.measure kexpt --dbs=GZ_Master1,PZ_Master1</span>
<span class="sd">        ibeis Chap3.draw kexpt --dbs=GZ_Master1,PZ_Master1 --diskshow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">expt_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stack_frame</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;draw_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="n">expt_name</span><span class="p">)</span>
        <span class="c1"># results = self.expt_results[expt_name]</span>
        <span class="n">cdfs</span><span class="p">,</span> <span class="n">infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pcfgs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="s1">&#39;pcfg&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cdfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdfs</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">pcfgs</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="c1"># groups = list(df.groupby((&#39;dsize&#39;, &#39;t_denc_pername&#39;)))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">((</span><span class="s1">&#39;dsize&#39;</span><span class="p">)))</span>
        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nCols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nSubplots</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">df_group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># print(&#39;---&#39;)</span>
            <span class="c1"># print(df_group)</span>
            <span class="n">relevant_df</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;qsize&#39;</span><span class="p">,</span> <span class="s1">&#39;dsize&#39;</span><span class="p">,</span> <span class="s1">&#39;t_dpername&#39;</span><span class="p">]]</span>
            <span class="n">relevant_df</span> <span class="o">=</span> <span class="n">relevant_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;t_dpername&#39;</span><span class="p">:</span> <span class="s1">&#39;dpername&#39;</span><span class="p">})</span>
            <span class="n">relevant_cfgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">order_dict_by</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">relevant_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                             <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">relevant_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)]</span>
            <span class="n">nonvaried_kw</span><span class="p">,</span> <span class="n">varied_kws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partition_varied_cfg_list</span><span class="p">(</span><span class="n">relevant_cfgs</span><span class="p">)</span>
            <span class="n">labels_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_cfg_lbl</span><span class="p">(</span><span class="n">kw</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">varied_kws</span><span class="p">]</span>
            <span class="n">cdfs_</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="s1">&#39;cdfs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs_</span><span class="p">,</span> <span class="n">labels_</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">nonvaried_text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cfg_lbl</span><span class="p">(</span><span class="n">nonvaried_kw</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># ax.set_title(nonvaried_text)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">(</span><span class="s1">&#39;lowerleft&#39;</span><span class="p">,</span> <span class="n">nonvaried_text</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="mf">1.9</span><span class="p">])</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">expt_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Chap3Draw.draw_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_all">[docs]</a>    <span class="k">def</span> <span class="nf">draw_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap3.draw_all --dbs=GZ_Master1,PZ_Master1,GIRM_Master1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; dbnames = ut.get_argval(&#39;--dbs&#39;, type_=list, default=[dbname])</span>
<span class="sd">            &gt;&gt;&gt; for dbname in dbnames:</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;dbname = %r&#39; % (dbname,))</span>
<span class="sd">            &gt;&gt;&gt;     self = Chap3(dbname)</span>
<span class="sd">            &gt;&gt;&gt;     self.draw_all()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">()</span>

        <span class="c1"># if &#39;baseline&#39; in self.expt_results:</span>
        <span class="c1">#     self.draw_baseline()</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;PZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="ow">or</span> <span class="s1">&#39;GZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">):</span>
            <span class="n">expts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foregroundness&#39;</span><span class="p">,</span> <span class="s1">&#39;invar&#39;</span><span class="p">,</span> <span class="s1">&#39;smk&#39;</span><span class="p">,</span> <span class="s1">&#39;nsum&#39;</span><span class="p">,</span> <span class="s1">&#39;kexpt&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">expt_name</span> <span class="ow">in</span> <span class="n">expts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expt_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt_results</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;draw_&#39;</span> <span class="o">+</span> <span class="n">expt_name</span><span class="p">)()</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;measure_&#39;</span> <span class="o">+</span> <span class="n">expt_name</span><span class="p">)()</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;draw_&#39;</span> <span class="o">+</span> <span class="n">expt_name</span><span class="p">)()</span></div>
            <span class="c1"># if &#39;invar&#39; in self.expt_results:</span>
            <span class="c1">#     self.draw_invar()</span>
            <span class="c1"># if &#39;smk&#39; in self.expt_results:</span>
            <span class="c1">#     self.draw_smk()</span>
            <span class="c1"># if &#39;nsum&#39; in self.expt_results:</span>
            <span class="c1">#     self.draw_nsum()</span>
            <span class="c1"># if &#39;kexpt&#39; in self.expt_results:</span>
            <span class="c1">#     self.draw_kexpt()</span>

<div class="viewcode-block" id="Chap3Draw.draw_time_distri"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3Draw.draw_time_distri">[docs]</a>    <span class="k">def</span> <span class="nf">draw_time_distri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap3.draw_time_distri --dbs=GZ_Master1,PZ_Master1,GIRM_MasterV</span>
<span class="sd">            python -m ibeis Chap3.draw_time_distri --dbs=GIRM_Master1</span>
<span class="sd">            python -m ibeis Chap3.draw_time_distri --dbs=GZ_Master1</span>
<span class="sd">            python -m ibeis Chap3.draw_time_distri --dbs=PZ_Master1</span>
<span class="sd">            python -m ibeis Chap3.draw_time_distri --dbs=humpbacks_fb</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; dbname = ut.get_argval(&#39;--db&#39;, default=&#39;PZ_MTEST&#39;)</span>
<span class="sd">            &gt;&gt;&gt; dbnames = ut.get_argval(&#39;--dbs&#39;, type_=list, default=[dbname])</span>
<span class="sd">            &gt;&gt;&gt; for dbname in dbnames:</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;dbname = %r&#39; % (dbname,))</span>
<span class="sd">            &gt;&gt;&gt;     self = Chap3(dbname)</span>
<span class="sd">            &gt;&gt;&gt;     self.draw_time_distri()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aids_pool</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">gids</span><span class="p">))</span>
        <span class="n">unixtimes_</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">unixtime_asfloat</span>
        <span class="n">num_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unixtimes_</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">num_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unixtimes_</span><span class="p">)</span>
        <span class="n">unixtimes</span> <span class="o">=</span> <span class="n">unixtimes_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unixtimes_</span><span class="p">)]</span>

        <span class="n">mintime</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">safe_min</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)</span>
        <span class="n">maxtime</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">safe_max</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">)</span>
        <span class="n">unixtime_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mintime</span><span class="p">,</span> <span class="n">maxtime</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">sklearn.neighbors.kde</span> <span class="k">import</span> <span class="n">KernelDensity</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--bw&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">day</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>
        <span class="k">if</span> <span class="n">bw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="s1">&#39;GIRM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">day</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="s1">&#39;GZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">day</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="k">elif</span> <span class="s1">&#39;PZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">day</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="k">elif</span> <span class="s1">&#39;humpbacks_fb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">day</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">RandomizedSearchCV</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">day</span> <span class="o">*</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="n">space</span><span class="p">}</span>
            <span class="n">searcher</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">RandomizedSearchCV</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching for best bandwidth&#39;</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">searcher</span><span class="p">(</span><span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">),</span> <span class="n">grid_params</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bw = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bw</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bw(days) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bw</span> <span class="o">/</span> <span class="n">day</span><span class="p">,))</span>

        <span class="n">kde</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="n">bw</span><span class="p">)</span>
        <span class="n">kde</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">unixtime_domain</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_density</span><span class="p">)</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># emphasize smaller values</span>
        <span class="n">ydata</span> <span class="o">/=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">unixtime_domain</span>
        <span class="n">xdata_ts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixtime_to_datetimeobj</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span><span class="n">xdata_ts</span><span class="p">,</span> <span class="p">[</span><span class="n">ydata</span><span class="p">],</span> <span class="n">label_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                      <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;# images&#39;</span><span class="p">,</span>
                      <span class="n">num_xticks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">use_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">num_nan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#nan=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_nan</span><span class="p">))</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#total=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_total</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#total=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_total</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">relative_text</span><span class="p">((</span><span class="o">.</span><span class="mi">02</span><span class="p">,</span> <span class="o">.</span><span class="mi">02</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">halign</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">valign</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_database_icon</span><span class="p">()</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">overlay_icon</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bbox_alignment</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">as_artist</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_asize</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="o">.</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;timedist.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fpath</span></div></div>


<div class="viewcode-block" id="Chap3"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">Chap3</span><span class="p">(</span><span class="n">DBInputs</span><span class="p">,</span> <span class="n">Chap3Draw</span><span class="p">,</span> <span class="n">Chap3Measures</span><span class="p">):</span>
    <span class="n">base_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/latex/crall-thesis-2017/figures3&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>

<div class="viewcode-block" id="Chap3.run_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3.run_all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="n">Chap3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap3.run_all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agg_dbnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GIRM_Master1&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;humpbacks_fb&#39;</span><span class="p">]</span>
        <span class="n">agg_dbnames</span> <span class="o">=</span> <span class="n">agg_dbnames</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">agg_dbnames</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">Chap3</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_time_distri</span><span class="p">()</span>

        <span class="n">Chap3</span><span class="o">.</span><span class="n">agg_dbstats</span><span class="p">()</span>
        <span class="n">Chap3</span><span class="o">.</span><span class="n">draw_agg_baseline</span><span class="p">()</span></div>

<div class="viewcode-block" id="Chap3.measure_all"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3.measure_all">[docs]</a>    <span class="k">def</span> <span class="nf">measure_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            from ibeis.scripts.thesis import *</span>
<span class="sd">            self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">            self.measure_all()</span>
<span class="sd">            self = Chap3(&#39;GZ_Master1&#39;)</span>
<span class="sd">            self.measure_all()</span>
<span class="sd">            self = Chap3(&#39;GIRM_Master1&#39;)</span>
<span class="sd">            self.measure_all()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precollect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_baseline</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;PZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GZ_Master1&#39;</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_foregroundness</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_smk</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_nsum</span><span class="p">()</span>
            <span class="c1"># self.measure_dbsize()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_kexpt</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_invar</span><span class="p">()</span></div>

<div class="viewcode-block" id="Chap3.agg_dbstats"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3.agg_dbstats">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">agg_dbstats</span><span class="p">(</span><span class="n">Chap3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap3.agg_dbstats</span>
<span class="sd">            python -m ibeis Chap3.measure_dbstats</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; result = Chap3.agg_dbstats()</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agg_dbnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GIRM_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;humpbacks_fb&#39;</span><span class="p">]</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">agg_dbnames</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">Chap3</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;dbstats&#39;</span><span class="p">)</span>
            <span class="n">infos</span><span class="p">[</span><span class="s1">&#39;enc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;enc&#39;</span><span class="p">])</span>
            <span class="n">infos</span><span class="p">[</span><span class="s1">&#39;qual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;qual&#39;</span><span class="p">])</span>
            <span class="n">infos</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">])</span>
            <span class="c1"># labels.append(self.species_nice.capitalize())</span>

        <span class="n">alias</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;species_nice&#39;</span><span class="p">:</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_singleton_names&#39;</span><span class="p">:</span> <span class="s1">&#39;names (singleton)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_resighted_names&#39;</span><span class="p">:</span> <span class="s1">&#39;names (resighted)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_encounter_per_resighted_name&#39;</span><span class="p">:</span> <span class="s1">&#39;encounters per name (resighted)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_annots_per_encounter&#39;</span><span class="p">:</span> <span class="s1">&#39;annots per encounter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;n_annots&#39;</span><span class="p">:</span> <span class="s1">&#39;annots&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">infos</span><span class="p">[</span><span class="s1">&#39;enc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">tabular</span><span class="o">.</span><span class="n">theadify</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">enc_text</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">enc_text</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">infos</span><span class="p">[</span><span class="s1">&#39;qual&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;species_nice&#39;</span><span class="p">:</span> <span class="s1">&#39;Database&#39;</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">partial_order</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="s1">&#39;excellent&#39;</span><span class="p">,</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;poor&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">qual_text</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">qual_text</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">infos</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;species_nice&#39;</span><span class="p">:</span> <span class="s1">&#39;Database&#39;</span><span class="p">,</span>
            <span class="s1">&#39;back&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
            <span class="s1">&#39;backleft&#39;</span><span class="p">:</span> <span class="s1">&#39;BL&#39;</span><span class="p">,</span> <span class="s1">&#39;backright&#39;</span><span class="p">:</span> <span class="s1">&#39;BR&#39;</span><span class="p">,</span> <span class="s1">&#39;frontright&#39;</span><span class="p">:</span> <span class="s1">&#39;FR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;frontleft&#39;</span><span class="p">:</span> <span class="s1">&#39;FL&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial_order</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="s1">&#39;BL&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;FL&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;FR&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;BR&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">emap</span><span class="p">(</span><span class="n">upper_one</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">tabular</span> <span class="o">=</span> <span class="n">Tabular</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colfmt</span><span class="o">=</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span>
        <span class="n">view_text</span> <span class="o">=</span> <span class="n">tabular</span><span class="o">.</span><span class="n">as_tabular</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">view_text</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">enc_text</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;agg-enc&#39;</span><span class="p">,</span>
                        <span class="n">preamb_extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{makecell}</span><span class="s1">&#39;</span><span class="p">])</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">view_text</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;agg-view&#39;</span><span class="p">,</span>
                        <span class="n">preamb_extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{makecell}</span><span class="s1">&#39;</span><span class="p">])</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">render_latex</span><span class="p">(</span><span class="n">qual_text</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;agg-qual&#39;</span><span class="p">,</span>
                        <span class="n">preamb_extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage</span><span class="si">{makecell}</span><span class="s1">&#39;</span><span class="p">])</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">Chap3</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="s1">&#39;agg-enc.tex&#39;</span><span class="p">),</span> <span class="n">enc_text</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">Chap3</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="s1">&#39;agg-view.tex&#39;</span><span class="p">),</span> <span class="n">view_text</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">Chap3</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="s1">&#39;agg-qual.tex&#39;</span><span class="p">),</span> <span class="n">qual_text</span><span class="p">)</span></div>

<div class="viewcode-block" id="Chap3.draw_agg_baseline"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Chap3.draw_agg_baseline">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">draw_agg_baseline</span><span class="p">(</span><span class="n">Chap3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis Chap3.draw_agg_baseline --diskshow</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; Chap3.draw_agg_baseline()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agg_dbnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;PZ_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;GIRM_Master1&#39;</span><span class="p">,</span> <span class="s1">&#39;humpbacks_fb&#39;</span><span class="p">]</span>
        <span class="n">cdfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">agg_dbnames</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">Chap3</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_results</span><span class="p">(</span><span class="s1">&#39;baseline&#39;</span><span class="p">)</span>
            <span class="n">cdf</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dsize</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dsize&#39;</span><span class="p">]</span>
            <span class="n">qsize</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;t_n_names&#39;</span><span class="p">]</span>
            <span class="n">baseline_cdf</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseline_cdf</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,qsize=</span><span class="si">{}</span><span class="s1">,dsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_nice</span><span class="p">,</span> <span class="n">qsize</span><span class="p">,</span> <span class="n">dsize</span><span class="p">))</span>
            <span class="c1"># labels.append(self.species_nice.capitalize())</span>

        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TMP_RC</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">])</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">Chap3</span><span class="o">.</span><span class="n">base_dpath</span><span class="p">,</span> <span class="s1">&#39;agg-baseline.png&#39;</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">render_figure_to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--diskshow&#39;</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Sampler"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.Sampler">[docs]</a><span class="k">class</span> <span class="nc">Sampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_same_occur_split</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._precollect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="c1"># occurrences = ibs._annot_groups(annots.group(annots.occurrence_text)[1])</span>
        <span class="n">encounters</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nid_to_splits</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># Find the biggest occurrences and pick an annotation from that</span>
        <span class="c1"># occurrence to be sampled</span>
        <span class="n">occur_to_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">encounters</span><span class="o">.</span><span class="n">occurrence_text</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">occur_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">occur_to_encs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">occur_to_encs</span><span class="o">.</span><span class="n">values</span><span class="p">())))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">occur_encs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">:</span>
                <span class="n">sortx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">qualities</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">annot</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="n">sortx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_to_splits</span><span class="p">[</span><span class="n">annot</span><span class="o">.</span><span class="n">nid</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">nid_to_splits</span><span class="p">[</span><span class="n">annot</span><span class="o">.</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annot</span><span class="o">.</span><span class="n">aid</span><span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyrng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">))</span>

        <span class="n">qaids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dname_encs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids_</span> <span class="ow">in</span> <span class="n">nid_to_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">confusor_pool</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pyrng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
                <span class="n">qaids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dname_encs</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">aids_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_intra_enc</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
        <span class="c1"># Make a query / database set for each occurrence</span>
        <span class="c1"># ibs = self.ibs</span>
        <span class="c1"># aids = self.aids_pool</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="c1"># occurrences = ibs._annot_groups(annots.group(annots.occurrence_text)[1])</span>
        <span class="n">encounters</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># rng = ut.ensure_rng(0)</span>
        <span class="c1"># pyrng = random.Random(rng.randint(sys.maxsize))</span>

        <span class="c1"># Find the biggest occurrences and pick an annotation from that</span>
        <span class="c1"># occurrence to be sampled</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">encounters</span><span class="o">.</span><span class="n">occurrence_text</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">,</span> <span class="n">occurrences</span><span class="p">)</span>

        <span class="n">occur_nids</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">encs</span><span class="o">.</span><span class="n">nids</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">occurrences</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Need to find multiple disjoint exact covers of the nids</span>
        <span class="c1"># Greedy solution because this is NP-hard</span>
        <span class="kn">from</span> <span class="nn">ibeis.algo.graph</span> <span class="k">import</span> <span class="n">nx_dynamic_graph</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx_dynamic_graph</span><span class="o">.</span><span class="n">DynConnGraph</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">occur_nids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">occur_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span>
            <span class="n">occur_nids</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">occur_nids</span><span class="o">.</span><span class="n">values</span><span class="p">()))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_combos</span> <span class="o">=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">connected_to</span><span class="p">(</span><span class="n">o1</span><span class="p">)):</span> <span class="n">occur_nids</span><span class="p">[</span><span class="n">o1</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">o1</span> <span class="ow">in</span> <span class="n">occur_ids</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">occur_ids</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">node_label</span><span class="p">(</span><span class="n">o1</span><span class="p">)</span> <span class="o">==</span> <span class="n">G</span><span class="o">.</span><span class="n">node_label</span><span class="p">(</span><span class="n">o2</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cc1</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">connected_to</span><span class="p">(</span><span class="n">o1</span><span class="p">))</span>
            <span class="n">cc2</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">connected_to</span><span class="p">(</span><span class="n">o2</span><span class="p">))</span>
            <span class="n">nids1</span> <span class="o">=</span> <span class="n">current_combos</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
            <span class="n">nids2</span> <span class="o">=</span> <span class="n">current_combos</span><span class="p">[</span><span class="n">cc2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nids1</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">nids2</span><span class="p">):</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">current_combos</span><span class="p">[</span><span class="n">cc1</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">current_combos</span><span class="p">[</span><span class="n">cc2</span><span class="p">]</span>
                <span class="n">current_combos</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">cc1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">cc2</span><span class="p">))]</span> <span class="o">=</span> <span class="n">nids1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">nids2</span><span class="p">)</span>

        <span class="c1"># Pick the top few occurrence groups with the most names</span>
        <span class="n">grouped_occurs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">connected_components</span><span class="p">()))</span>
        <span class="n">group_size</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouped_occurs</span><span class="p">))</span>
        <span class="n">top_groups</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">grouped_occurs</span><span class="p">,</span> <span class="n">group_size</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">os</span> <span class="ow">in</span> <span class="n">top_groups</span><span class="p">:</span>
            <span class="n">encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">occurrences</span><span class="p">[</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">aids</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">os</span><span class="p">)</span>
            <span class="n">encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">,</span> <span class="n">encs</span><span class="p">)</span>
            <span class="n">qaids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">daids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">daids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">daids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span>
                    <span class="n">qaids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">SplitSample</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">samples</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_same_enc_split</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *</span>
<span class="sd">            &gt;&gt;&gt; self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._precollect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="c1"># occurrences = ibs._annot_groups(annots.group(annots.occurrence_text)[1])</span>
        <span class="n">encounters</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyrng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">))</span>

        <span class="n">nid_to_splits</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># Find the biggest occurrences and pick an annotation from that</span>
        <span class="c1"># occurrence to be sampled</span>
        <span class="n">occur_to_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">encounters</span><span class="o">.</span><span class="n">occurrence_text</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">occur_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">occur_to_encs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">occur_to_encs</span><span class="o">.</span><span class="n">values</span><span class="p">())))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">occur_encs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">:</span>
                <span class="n">nid</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">nids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_to_splits</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">chosen</span> <span class="o">=</span> <span class="n">pyrng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">nid_to_splits</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>

        <span class="n">qaids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dname_encs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids_</span> <span class="ow">in</span> <span class="n">nid_to_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">confusor_pool</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pyrng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aids_</span><span class="p">)</span>
                <span class="n">qaids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dname_encs</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">aids_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span>

    <span class="k">def</span> <span class="nf">_rand_splits</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="p">,</span> <span class="n">denc_per_name_</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This can be used for cross validation &quot;&quot;&quot;</span>
        <span class="c1"># Find a split of query/database encounters and confusors</span>
        <span class="kn">from</span> <span class="nn">ibeis.init.filter_annots</span> <span class="k">import</span> <span class="n">encounter_crossval</span>
        <span class="n">enc_splits</span><span class="p">,</span> <span class="n">nid_to_confusors</span> <span class="o">=</span> <span class="n">encounter_crossval</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">denc_per_name</span><span class="o">=</span><span class="n">denc_per_name_</span><span class="p">,</span> <span class="n">rebalance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">early</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">qname_encs</span><span class="p">,</span> <span class="n">dname_encs</span> <span class="o">=</span> <span class="n">enc_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qaids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">qname_encs</span><span class="p">)))</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">nid_to_confusors</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_alt_splits</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="p">,</span> <span class="n">denc_per_name_</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">,</span>
                    <span class="n">viewpoint_aware</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This cannot be used for cross validation</span>

<span class="sd">        Notes:</span>

<span class="sd">            (a) single encounter experiments are structured somewhat like this:</span>
<span class="sd">                (of course this script is more general than this)</span>

<span class="sd">                * For each name with more than one encounter</span>

<span class="sd">                * Choose a random encounter, and select the highest quality</span>
<span class="sd">                annotation as the single query annotation.</span>

<span class="sd">                * For each other encounter the best annotation that is comparable</span>
<span class="sd">                (close to the same viewpoint) to the query. If no other encounter</span>
<span class="sd">                satisfies this then skip this name (dont add a query or database</span>
<span class="sd">                annotation).</span>

<span class="sd">                * Of the remaining encounters choose a random annotation to belong</span>
<span class="sd">                to the database.</span>

<span class="sd">                * For each other name, that was not selected to form a</span>
<span class="sd">                query/database pair, add all annotations to the database as</span>
<span class="sd">                distractors.</span>

<span class="sd">            (b) with multiple exemplars in the database:</span>

<span class="sd">                * Follow the same steps above, but now if there are not at</span>
<span class="sd">                least N valid database encounters, we ignore the query/database</span>
<span class="sd">                pair.</span>

<span class="sd">                * Multiple sets of daids are generated (each with a different</span>
<span class="sd">                number of exempars per query), but the query set remains the</span>
<span class="sd">                same and consistent across different runs of this experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Group annotations by encounter</span>
        <span class="c1"># from ibeis.other import ibsfuncs</span>
        <span class="c1"># primary_view = ibsfuncs.get_primary_species_viewpoint(ibs.get_primary_database_species())</span>

        <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
        <span class="n">encounters</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">enc_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">encounters</span><span class="o">.</span><span class="n">nids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nid_to_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">enc_nids</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pyrng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">))</span>

        <span class="n">n_need</span> <span class="o">=</span> <span class="n">qenc_per_name</span> <span class="o">+</span> <span class="n">denc_per_name_</span>

        <span class="n">confusor_encs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sample_splits</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">choose_best</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num</span><span class="p">:</span>
                <span class="n">sortx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">qualities</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">subenc</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subenc</span> <span class="o">=</span> <span class="n">enc</span>
            <span class="k">return</span> <span class="n">subenc</span>

        <span class="k">def</span> <span class="nf">_only_comparable</span><span class="p">(</span><span class="n">qsubenc</span><span class="p">,</span> <span class="n">avail_dencs</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">vtool</span> <span class="k">import</span> <span class="n">_rhomb_dist</span>
            <span class="n">qviews</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">qsubenc</span><span class="o">.</span><span class="n">viewpoint_code</span><span class="p">))</span>
            <span class="n">comparable_encs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">denc</span> <span class="ow">in</span> <span class="n">avail_dencs</span><span class="p">:</span>
                <span class="n">comparable</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">daid</span><span class="p">,</span> <span class="n">dview</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">denc</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">denc</span><span class="o">.</span><span class="n">viewpoint_code</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">qview</span> <span class="ow">in</span> <span class="n">qviews</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="n">_rhomb_dist</span><span class="o">.</span><span class="n">VIEW_CODE_DIST</span><span class="p">[(</span><span class="n">qview</span><span class="p">,</span> <span class="n">dview</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">comparable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comparable</span><span class="p">:</span>
                    <span class="n">comparable_encs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">comparable</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">comparable_encs</span>

        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">nid_to_encs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_need</span><span class="p">:</span>
                <span class="n">confusor_encs</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">encs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">viewpoint_aware</span><span class="p">:</span>
                    <span class="c1"># Randomly choose queries</span>
                    <span class="n">avail_qxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encs</span><span class="p">)))</span>
                    <span class="n">qencxs</span> <span class="o">=</span> <span class="n">pyrng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">avail_qxs</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="p">)</span>
                    <span class="n">qencs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">encs</span><span class="p">,</span> <span class="n">qencxs</span><span class="p">)</span>
                    <span class="n">qsubenc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">choose_best</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">)</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">qencs</span><span class="p">])</span>

                    <span class="c1"># Ensure the db annots are comparable to at least one query</span>
                    <span class="n">avail_dencs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">encs</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">avail_qxs</span><span class="p">,</span> <span class="n">qencxs</span><span class="p">))</span>
                    <span class="n">comparable_encs</span> <span class="o">=</span> <span class="n">_only_comparable</span><span class="p">(</span><span class="n">qsubenc</span><span class="p">,</span> <span class="n">avail_dencs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparable_encs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">denc_per_name_</span><span class="p">:</span>
                        <span class="c1"># If we still have enough, sample daids</span>
                        <span class="n">dencs</span> <span class="o">=</span> <span class="n">pyrng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">comparable_encs</span><span class="p">,</span> <span class="n">denc_per_name_</span><span class="p">)</span>
                        <span class="n">dsubenc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">choose_best</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">)</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">dencs</span><span class="p">])</span>
                        <span class="n">sample_splits</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qsubenc</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">dsubenc</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If we don&#39;t add to confusors</span>
                        <span class="n">confusor_encs</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">encs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For each name choose a query / database encounter.</span>
                    <span class="n">chosen_encs</span> <span class="o">=</span> <span class="n">pyrng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">encs</span><span class="p">,</span> <span class="n">n_need</span><span class="p">)</span>
                    <span class="c1"># Choose high quality annotations from each encounter</span>
                    <span class="n">best_subencs</span> <span class="o">=</span> <span class="p">[</span><span class="n">choose_best</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">)</span> <span class="k">for</span>
                                    <span class="n">enc</span> <span class="ow">in</span> <span class="n">chosen_encs</span><span class="p">]</span>
                    <span class="c1"># ibs._annot_groups(best_subencs).aids</span>
                    <span class="n">qsubenc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">best_subencs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">qenc_per_name</span><span class="p">])</span>
                    <span class="n">dsubenc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">best_subencs</span><span class="p">[</span><span class="n">qenc_per_name</span><span class="p">:])</span>
                    <span class="n">sample_splits</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qsubenc</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">dsubenc</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span>

        <span class="c1"># if viewpoint_aware:</span>
        <span class="c1">#     for qenc, denc in sample_splits.values():</span>
        <span class="c1">#         q = ibs.annots(ut.flatten(qenc))</span>
        <span class="c1">#         d = ibs.annots(ut.flatten(denc))</span>
        <span class="c1">#         print(q.viewpoint_code, d.viewpoint_code)</span>

        <span class="c1"># make confusor encounters subject to the same constraints</span>
        <span class="n">confusor_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confname_encs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">confusor_encs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># new</span>
            <span class="c1"># chosen_encs = pyrng.sample(encs, min(len(encs), denc_per_name_))</span>
            <span class="c1"># rand_subencs = [pyrng.sample(enc.aids, annots_per_enc)</span>
            <span class="c1">#                 for enc in chosen_encs]</span>
            <span class="c1"># confname_encs.append(rand_subencs)</span>

            <span class="c1"># old</span>
            <span class="n">confusor_pool</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">annots_per_enc</span><span class="p">]</span><span class="o">.</span><span class="n">aids</span> <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">encs</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">qaids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">total_flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">sample_splits</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">dname_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">sample_splits</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_varied_inputs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">denc_per_name</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_dbsize_fracs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="n">viewpoint_aware</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vary num per name and total number of annots</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.scripts.thesis import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; self = Chap3(&#39;PZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; self._precollect()</span>
<span class="sd">            &gt;&gt;&gt; ibs = self.ibs</span>
<span class="sd">            &gt;&gt;&gt; aids = self.aids_pool</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;--------&#39;)</span>
<span class="sd">            &gt;&gt;&gt; qaids, daids_list, info_list = self._varied_inputs(ibs, aids, [1], [1], method=&#39;same_occur&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;qsize = %r&#39; % (len(qaids),))</span>
<span class="sd">            &gt;&gt;&gt; for info in info_list:</span>
<span class="sd">            &gt;&gt;&gt;     print(ut.repr4(info))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;--------&#39;)</span>
<span class="sd">            &gt;&gt;&gt; qaids, daids_list, info_list = self._varied_inputs(ibs, aids, [1], [1], method=&#39;same_enc&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;qsize = %r&#39; % (len(qaids),))</span>
<span class="sd">            &gt;&gt;&gt; for info in info_list:</span>
<span class="sd">            &gt;&gt;&gt;     print(ut.repr4(info))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;--------&#39;)</span>
<span class="sd">            &gt;&gt;&gt; qaids, daids_list, info_list = self._varied_inputs(ibs, aids, [1, 2], [0])</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;qsize = %r&#39; % (len(qaids),))</span>
<span class="sd">            &gt;&gt;&gt; for info in info_list:</span>
<span class="sd">            &gt;&gt;&gt;     print(ut.repr4(info))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;--------&#39;)</span>
<span class="sd">            &gt;&gt;&gt; qaids, daids_list, info_list = self._varied_inputs(ibs, aids, [3], [0, 1])</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;qsize = %r&#39; % (len(qaids),))</span>
<span class="sd">            &gt;&gt;&gt; for info in info_list:</span>
<span class="sd">            &gt;&gt;&gt;     print(ut.repr4(info))</span>

<span class="sd">        Ignore:</span>
<span class="sd">            ibs, aids = self.ibs, self.aids_pool</span>
<span class="sd">            denc_per_name = 1</span>
<span class="sd">            denc_per_name = [1]</span>
<span class="sd">            extra_dbsize_fracs = None</span>

<span class="sd">            extra_dbsize_fracs = [0, .5, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qenc_per_name</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">annots_per_enc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">denc_per_name_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">denc_per_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;alt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">viewpoint_aware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">viewpoint_aware</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_alt_splits</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="p">,</span> <span class="n">denc_per_name_</span><span class="p">,</span> <span class="n">annots_per_enc</span><span class="p">,</span>
                <span class="n">viewpoint_aware</span><span class="o">=</span><span class="n">viewpoint_aware</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;same_occur&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">viewpoint_aware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cannot specify viewpoint_aware here&#39;</span>
            <span class="k">assert</span> <span class="n">denc_per_name_</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">annots_per_enc</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">qenc_per_name</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_same_occur_split</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;same_enc&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">viewpoint_aware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cannot specify viewpoint_aware here&#39;</span>
            <span class="n">qaids</span><span class="p">,</span> <span class="n">dname_encs</span><span class="p">,</span> <span class="n">confusor_pool</span> <span class="o">=</span> <span class="n">Sampler</span><span class="o">.</span><span class="n">_same_enc_split</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="c1"># Vary the number of database encounters in each sample</span>
        <span class="n">target_daids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_info_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">denc_per_name</span><span class="p">:</span>
            <span class="n">dname_encs_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">dname_encs</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
            <span class="n">dnames_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">dname_encs_</span><span class="p">)</span>
            <span class="n">daids_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dnames_</span><span class="p">)</span>
            <span class="n">target_daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daids_</span><span class="p">)</span>
            <span class="n">name_lens</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">dnames_</span><span class="p">)</span>
            <span class="n">dpername</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">name_lens</span><span class="p">)</span> <span class="k">else</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">name_lens</span><span class="p">))</span>
            <span class="n">target_info_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;qsize&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;t_n_names&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dname_encs_</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;t_dpername&#39;</span><span class="p">,</span> <span class="n">dpername</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;t_denc_pername&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;t_dsize&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">daids_</span><span class="p">)),</span>
            <span class="p">]))</span>

        <span class="c1"># confusor_names_matter = True</span>
        <span class="c1"># if confusor_names_matter:</span>
        <span class="c1">#     extra_pools = [</span>
        <span class="c1">#         ut.total_flatten(ut.take_column(confname_encs, slice(0, num)))</span>
        <span class="c1">#         for num in denc_per_name</span>
        <span class="c1">#     ]</span>
        <span class="c1">#     dbsize_list = ut.lmap(len, target_daids_list)</span>
        <span class="c1">#     max_dsize = max(dbsize_list)</span>
        <span class="c1">#     for num, daids_ in zip(denc_per_name, target_daids_list):</span>
        <span class="c1">#         num_take = max_dsize - len(daids_)</span>
        <span class="c1">#         print(&#39;num_take = %r&#39; % (num_take,))</span>

        <span class="c1">#         confname_encs_ = ut.total_flatten(ut.take_column(confname_encs, slice(0, num)))</span>
        <span class="c1">#         confusor_pool_ = ut.total_flatten(confname_encs_)</span>
        <span class="c1">#         if num_take &gt; len(confusor_pool_):</span>
        <span class="c1">#             # we need to siphon off valid queries to use them as</span>
        <span class="c1">#             # confusors</span>
        <span class="c1">#             raise AssertionError(</span>
        <span class="c1">#                 &#39;have={}, need={}, not enough confusors for num={}&#39;.format(</span>
        <span class="c1">#                     len(confusor_pool_), num_take, num</span>
        <span class="c1">#                 ))</span>

        <span class="c1"># Append confusors to maintain a constant dbsize in each base sample</span>
        <span class="n">dbsize_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">target_daids_list</span><span class="p">)</span>
        <span class="n">max_dsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dbsize_list</span><span class="p">)</span>
        <span class="n">n_need</span> <span class="o">=</span> <span class="n">max_dsize</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">dbsize_list</span><span class="p">)</span>
        <span class="n">n_extra_avail</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_need</span>
        <span class="c1"># assert len(confusor_pool) &gt; n_need, &#39;not enough confusors&#39;</span>
        <span class="n">padded_daids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">padded_info_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">daids_</span><span class="p">,</span> <span class="n">info_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">denc_per_name</span><span class="p">,</span> <span class="n">target_daids_list</span><span class="p">,</span>
                                      <span class="n">target_info_list_</span><span class="p">):</span>
            <span class="n">num_take</span> <span class="o">=</span> <span class="n">max_dsize</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">daids_</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">num_take</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">),</span> <span class="s1">&#39;not enough confusors&#39;</span>
            <span class="n">pad_aids</span> <span class="o">=</span> <span class="n">confusor_pool</span><span class="p">[:</span><span class="n">num_take</span><span class="p">]</span>

            <span class="n">new_aids</span> <span class="o">=</span> <span class="n">daids_</span> <span class="o">+</span> <span class="n">pad_aids</span>
            <span class="n">info_</span> <span class="o">=</span> <span class="n">info_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;n_pad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pad_aids</span><span class="p">)</span>
            <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;pad_dsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_aids</span><span class="p">)</span>
            <span class="n">padded_info_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_</span><span class="p">)</span>
            <span class="n">padded_daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_aids</span><span class="p">)</span>

        <span class="c1"># Vary the dbsize by appending extra confusors</span>
        <span class="k">if</span> <span class="n">extra_dbsize_fracs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_dbsize_fracs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
        <span class="n">extra_fracs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extra_dbsize_fracs</span><span class="p">)</span>
        <span class="n">n_extra_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">extra_fracs</span> <span class="o">*</span> <span class="n">n_extra_avail</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">daids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">info_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_extra_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">daids_</span><span class="p">,</span> <span class="n">info_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">padded_daids_list</span><span class="p">,</span> <span class="n">padded_info_list_</span><span class="p">):</span>
                <span class="n">extra_aids</span> <span class="o">=</span> <span class="n">confusor_pool</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">confusor_pool</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">:]</span>
                <span class="n">daids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids_</span> <span class="o">+</span> <span class="n">extra_aids</span><span class="p">)</span>
                <span class="n">daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">info_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_aids</span><span class="p">)</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;dsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
                <span class="n">info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">info_list</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#qaids = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">),))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num_need = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_need</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max_dsize = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_dsize</span><span class="p">,))</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">daids</span> <span class="ow">in</span> <span class="n">daids_list</span><span class="p">:</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">,</span> <span class="n">info_list</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SplitSample"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.SplitSample">[docs]</a><span class="k">class</span> <span class="nc">SplitSample</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">):</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">qaids</span> <span class="o">=</span> <span class="n">qaids</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">daids</span> <span class="o">=</span> <span class="n">daids</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;nQaids=</span><span class="si">{}</span><span class="s1">, nDaids=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">qaids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">daids</span><span class="p">)</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_ranking_hist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">):</span>
    <span class="c1"># Execute the ranking algorithm</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">cm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
    <span class="n">name_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_name_ranks</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
    <span class="c1"># Measure rank probabilities</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">dnids</span><span class="p">))</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">name_ranks</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hist</span>


<span class="k">def</span> <span class="nf">_ranking_cdf</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">):</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">_ranking_hist</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cdf</span>


<div class="viewcode-block" id="label_alias"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.label_alias">[docs]</a><span class="k">def</span> <span class="nf">label_alias</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="feat_alias"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.feat_alias">[docs]</a><span class="k">def</span> <span class="nf">feat_alias</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="c1"># presentation values for feature dimension</span>
    <span class="c1"># k = k.replace(&#39;weighted_&#39;, &#39;wgt_&#39;)</span>
    <span class="c1"># k = k.replace(&#39;norm_x&#39;, &#39;x&#39;)</span>
    <span class="c1"># k = k.replace(&#39;norm_y&#39;, &#39;y&#39;)</span>
    <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="prepare_cdfs"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.prepare_cdfs">[docs]</a><span class="k">def</span> <span class="nf">prepare_cdfs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">cdfs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">pad_vstack</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Sort so the best is on top</span>
    <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">cdfs</span><span class="o">.</span><span class="n">T</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cdfs</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[</span><span class="n">sortx</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="plot_cmcs"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.plot_cmcs">[docs]</a><span class="k">def</span> <span class="nf">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ymin</span><span class="o">=.</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">prepare_cdfs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="c1"># Truncte to 20 ranks</span>
    <span class="n">num_ranks</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cdfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_ranks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cdfs_trunc</span> <span class="o">=</span> <span class="n">cdfs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">num_ranks</span><span class="p">]</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%6.2f%%</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">lbl</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">cdf</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cdfs_trunc</span><span class="p">,</span> <span class="n">labels</span><span class="p">)]</span>

    <span class="c1"># ymin = .4</span>
    <span class="n">num_yticks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ymin</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
        <span class="n">xdata</span><span class="p">,</span> <span class="n">cdfs_trunc</span><span class="p">,</span> <span class="n">label_list</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;match probability&#39;</span><span class="p">,</span>
        <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">num_yticks</span><span class="o">=</span><span class="n">num_yticks</span><span class="p">,</span>
        <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ypad</span><span class="o">=.</span><span class="mi">005</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=.</span><span class="mi">9</span><span class="p">,</span> <span class="n">num_xticks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">xmax</span><span class="o">=</span><span class="n">num_ranks</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
        <span class="n">rcParams</span><span class="o">=</span><span class="n">TMP_RC</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_cmcs2"><a class="viewcode-back" href="../../../ibeis.scripts.html#ibeis.scripts.thesis.plot_cmcs2">[docs]</a><span class="k">def</span> <span class="nf">plot_cmcs2</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
    <span class="n">plot_cmcs</span><span class="p">(</span><span class="n">cdfs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">adjust_subplots</span><span class="p">(</span><span class="n">top</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mi">12</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.scripts.thesis</span>
<span class="sd">        python -m ibeis.scripts.thesis --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Wild Me

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>