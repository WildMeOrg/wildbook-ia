

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ibeis.algo.smk.script_smk &mdash; ibeis 1.9.0.vulcan documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> ibeis
          

          
          </a>

          
            
            
              <div class="version">
                1.9.0.vulcan
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ibeis.html">ibeis package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ibeis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../ibeis.html">ibeis</a> &raquo;</li>
        
          <li><a href="../../algo.html">ibeis.algo</a> &raquo;</li>
        
          <li><a href="../smk.html">ibeis.algo.smk</a> &raquo;</li>
        
      <li>ibeis.algo.smk.script_smk</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ibeis.algo.smk.script_smk</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Results so far without SV / fancyness</span>
<span class="sd">Using standard descriptors / vocabulary</span>

<span class="sd">proot=bow,nWords=1E6 -&gt; .594</span>
<span class="sd">proot=asmk,nWords=1E6 -&gt; .529</span>

<span class="sd">Note:</span>
<span class="sd">    * Results from SMK Oxford Paper (mAP)</span>
<span class="sd">    ASMK nAssign=1, SV=False: .78</span>
<span class="sd">    ASMK nAssign=5, SV=False: .82</span>

<span class="sd">    Philbin with tf-idf ranking SV=False</span>
<span class="sd">    SIFT: .636, RootSIFT: .683 (+.05)</span>

<span class="sd">    Philbin with tf-idf ranking SV=True</span>
<span class="sd">    SIFT: .672, RootSIFT: .720 (+.05)</span>

<span class="sd">    * My Results (WITH BAD QUERY BBOXES)</span>
<span class="sd">    smk:nAssign=1,SV=True,: .58</span>
<span class="sd">    smk:nAssign=1,SV=False,: .38</span>

<span class="sd">    Yesterday I got</span>
<span class="sd">    .22 when I fixed the bounding boxes</span>
<span class="sd">    And now I&#39;m getting</span>
<span class="sd">    .08 and .32 (sv=[F,T]) after deleting and redoing everything (also removing junk images)</span>
<span class="sd">    After fix of normalization I get</span>
<span class="sd">    .38 and .44</span>

<span class="sd">    Using oxford descriptors I get .51ish</span>
<span class="sd">    Then changing to root-sift I</span>
<span class="sd">    smk-bow = get=0.56294936807700813</span>
<span class="sd">    Then using tfidf-bow2=0.56046968275748565</span>
<span class="sd">    asmk-gets 0.54146</span>

<span class="sd">    Going down to 8K words smk-BOW gets .153</span>
<span class="sd">    Going down to 8K words tfidf-BOW gets .128</span>
<span class="sd">    Going down to 8K words smk-asmk gets 0.374</span>

<span class="sd">    Ok the 65K vocab smk-asmk gets mAP=0.461...</span>
<span class="sd">    Ok, after recomputing a new 65K vocab with centered and root-sifted</span>
<span class="sd">        descriptors, using float32 precision (in most places), asmk</span>
<span class="sd">        gets a new map score of:</span>
<span class="sd">        mAP=.5275... :(</span>
<span class="sd">        This is with permissive query kpts and oxford vocab.</span>
<span class="sd">        Next step: ensure everything is float32.</span>
<span class="sd">        Ensured float32</span>
<span class="sd">        mAP=.5279, ... better but indiciative of real error</span>

<span class="sd">    After that try again at Jegou&#39;s data.</span>
<span class="sd">    Ensure there are no smk algo bugs. There must be one.</span>

<span class="sd">    FINALLY!</span>
<span class="sd">    Got Jegou&#39;s data working.</span>
<span class="sd">    With jegou percmopute oxford feats, words, and assignments</span>
<span class="sd">    And float32 version</span>
<span class="sd">    asmk = .78415</span>
<span class="sd">    bow = .545</span>

<span class="sd">    asmk got 0.78415 with float32 version</span>
<span class="sd">    bow got .545</span>
<span class="sd">    bot2 got .551</span>


<span class="sd">    vecs07, root_sift, approx assign, (either jegou or my words)</span>
<span class="sd">    mAP=.673</span>

<span class="sd">    Weird:</span>
<span class="sd">    vecs07, root_sift, exact assign,</span>
<span class="sd">    Maybe jegou words or maybe my words. Can&#39;t quite tell.</span>
<span class="sd">    Might have messed with a config.</span>
<span class="sd">    mAP=0.68487357885738664</span>


<span class="sd">    October 8</span>
<span class="sd">    Still using the same descriptors, but my own vocab with approx assign</span>
<span class="sd">    mAP  = 0.78032</span>

<span class="sd">    my own vocab approx assign, no center</span>
<span class="sd">    map = .793</span>

<span class="sd">    The problem was minibatch params. Need higher batch size and init size.</span>
<span class="sd">    Needed to modify sklearn to handle this requirement.</span>

<span class="sd">    Using my own descriptors I got 0.7460. Seems good.</span>

<span class="sd">    Now, back to the HS pipeline.</span>
<span class="sd">    Getting a 0.638, so there is an inconsistency.</span>
<span class="sd">    Should be getting .7460. Maybe I gotta root_sift it up?</span>


<span class="sd">    Turned off root_sift in script</span>
<span class="sd">    got .769, so there is a problem in system script</span>
<span class="sd">    minibatch  29566/270340... rate=0.86 Hz, eta=0:00:00, total=9:44:35, wall=05:24 EST inertia: mean batch=53730.923812, ewa=53853.439903</span>
<span class="sd">    now need to try turning off float32</span>


<span class="sd">Differences Between this and SMK:</span>
<span class="sd">   * No RootSIFT</span>
<span class="sd">   * No SIFT Centering</span>
<span class="sd">   * No Independent Vocab</span>
<span class="sd">   * Chip RESIZE</span>

<span class="sd">Differences between this and VLAD</span>
<span class="sd">   * residual vectors are normalized</span>
<span class="sd">   * larger default vocabulary size</span>


<span class="sd">Feat Info</span>
<span class="sd">==========</span>
<span class="sd">name     | num_vecs   | n_annots |</span>
<span class="sd">=================================</span>
<span class="sd">Oxford13 | 12,534,635 |          |</span>
<span class="sd">Oxford07 | 16,334,970 |          |</span>
<span class="sd">mine1    |  8,997,955 |          |</span>
<span class="sd">mine2    | 13,516,721 |   5063   |</span>
<span class="sd">mine3    |  8,371,196 |   4728   |</span>
<span class="sd">mine4    |  8,482,137 |   4783   |</span>


<span class="sd">Cluster Algo Config</span>
<span class="sd">===================</span>
<span class="sd">name       | algo             | init      | init_size      |  batch size  |</span>
<span class="sd">==========================================================================|</span>
<span class="sd">minibatch1 | minibatch kmeans | kmeans++  | num_words * 4  | 100          |</span>
<span class="sd">minibatch2 | minibatch kmeans | kmeans++  | num_words * 4  | 1000         |</span>
<span class="sd">given13    | Lloyd?           | kmeans++? | num_words * 8? | nan?         |</span>


<span class="sd">Assign Algo Config</span>
<span class="sd">==================</span>
<span class="sd">name   | algo   | trees | checks     |</span>
<span class="sd">======================================</span>
<span class="sd">approx | kdtree |  8    | 1024       |</span>
<span class="sd">exact  | linear |  nan  | nan        |</span>
<span class="sd">exact  | linear |  nan  | nan        |</span>


<span class="sd">SMK Results</span>
<span class="sd">===========</span>
<span class="sd">  tagid    | mAP   | train_feats | test_feats | center | rootSIFT | assign  | num_words | cluster methods | int | only_xy |</span>
<span class="sd">           =================================================================================================================</span>
<span class="sd">           | 0.38  |  mine1      |   mine1    |        |          | approx  |  64000    | minibatch1      |     |         |</span>
<span class="sd">           | 0.541 |  oxford07   |   oxford07 |        |    X     | approx  |  2 ** 16  | minibatch1      |     |    X    |</span>
<span class="sd">           | 0.673 |  oxford13   |   oxford13 |   X    |    X     | approx  |  2 ** 16  | minibatch1      |     |    X    |</span>
<span class="sd">           | 0.684 |  oxford13   |   oxford13 |   X    |    X     | exact   |  2 ** 16  | minibatch1      |     |    X    |</span>
<span class="sd">           ----------------------------------------------------------------------------------------------------------------</span>
<span class="sd"> mybest    | 0.793 |  oxford13   |   oxford13 |        |    X     | approx  |  2 ** 16  | minibatch2      |     |    X    |</span>
<span class="sd">           | 0.780 |  oxford13   |   oxford13 |   X    |    X     | approx  |  2 ** 16  | minibatch2      |     |    X    |</span>
<span class="sd">           | 0.788 |  paras13    |   oxford13 |   X    |    X     | approx  |  2 ** 16  | given13         |     |    X    |</span>
<span class="sd">  allgiven | 0.784 |  paras13    |   oxford13 |   X    |    X     | given13 |  2 ** 16  | given13         |     |    X    |</span>
<span class="sd">reported13 | 0.781 |  paras13    |   oxford13 |   X    |    X     | given13 |  2 ** 16  | given13         |     |    X    |</span>
<span class="sd">           -----------------------------------------------------------------------------------------------------------------</span>
<span class="sd">  inhouse1 | 0.746 |     mine2   |      mine2 |        |    X     | approx  |  2 ** 16  | minibatch2      |     |    X    |</span>
<span class="sd">  inhouse2 | 0.769 |     mine2   |      mine2 |        |          | approx  |  2 ** 16  | minibatch2      |     |    X    |</span>
<span class="sd">  inhouse3 | 0.769 |     mine2   |      mine2 |        |          | approx  |  2 ** 16  | minibatch2      | X   |    X    |</span>
<span class="sd">  inhouse4 | 0.751 |     mine2   |      mine2 |        |          | approx  |  2 ** 16  | minibatch2      | X   |         |</span>
<span class="sd">sysharn1   | 0.638 |     mine3   |      mine3 |        |          | approx  |  64000    | minibatch2      | X   |         |</span>
<span class="sd">sysharn2   | 0.713 |     mine3   |      mine4 |        |          | approx  |  64000    | minibatch2      | X   |         |</span>


<span class="sd">In the SMK paper they report 0.781 as shown in the table, but they also report a score of 0.820 when increasing</span>
<span class="sd">the number of features to from 12.5M to 19.2M by lowering feature detection thresholds.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.smk</span> <span class="k">import</span> <span class="n">inverted_index</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.smk</span> <span class="k">import</span> <span class="n">smk_funcs</span>
<span class="kn">from</span> <span class="nn">ibeis.algo.smk</span> <span class="k">import</span> <span class="n">smk_pipeline</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">map</span>
<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SMK"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK">[docs]</a><span class="k">class</span> <span class="nc">SMK</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">smk</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">smk</span><span class="o">.</span><span class="n">method</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;asmk&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">smk</span><span class="o">.</span><span class="n">wx_to_weight</span> <span class="o">=</span> <span class="n">wx_to_weight</span>
        <span class="n">smk</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;asmk&#39;</span><span class="p">:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">match_score</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">match_score_agg</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;smk&#39;</span><span class="p">:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">match_score</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">match_score_sep</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bow&#39;</span><span class="p">:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">match_score</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">match_score_bow</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;asmk&#39;</span><span class="p">,</span> <span class="s1">&#39;smk&#39;</span><span class="p">]:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;thresh&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bow2&#39;</span><span class="p">:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">kernel_bow_tfidf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">kernel_smk</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;unexpected kwargs=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">,)</span>

<div class="viewcode-block" id="SMK.gamma"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.gamma">[docs]</a>    <span class="k">def</span> <span class="nf">gamma</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gamma(X) = (M(X, X)) ** (-1/2) &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">match_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">sccw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sccw</span></div>

<div class="viewcode-block" id="SMK.kernel_bow_tfidf"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.kernel_bow_tfidf">[docs]</a>    <span class="k">def</span> <span class="nf">kernel_bow_tfidf</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">bow</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">bow</span><span class="p">)</span></div>

<div class="viewcode-block" id="SMK.kernel_smk"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.kernel_smk">[docs]</a>    <span class="k">def</span> <span class="nf">kernel_smk</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">match_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Y</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">score</span>
        <span class="k">return</span> <span class="n">score</span></div>

<div class="viewcode-block" id="SMK.word_isect"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.word_isect">[docs]</a>    <span class="k">def</span> <span class="nf">word_isect</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">isect_wxs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">wx_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">wx_set</span><span class="p">)</span>
        <span class="n">X_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_to_idx</span><span class="p">,</span> <span class="n">isect_wxs</span><span class="p">)</span>
        <span class="n">Y_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">wx_to_idx</span><span class="p">,</span> <span class="n">isect_wxs</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">smk</span><span class="o">.</span><span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">isect_wxs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_idx</span><span class="p">,</span> <span class="n">Y_idx</span><span class="p">,</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="SMK.match_score_agg"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.match_score_agg">[docs]</a>    <span class="k">def</span> <span class="nf">match_score_agg</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">X_idx</span><span class="p">,</span> <span class="n">Y_idx</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">word_isect</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">PhisX</span><span class="p">,</span> <span class="n">flagsX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">Phis_flags</span><span class="p">(</span><span class="n">X_idx</span><span class="p">)</span>
        <span class="n">PhisY</span><span class="p">,</span> <span class="n">flagsY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Phis_flags</span><span class="p">(</span><span class="n">Y_idx</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">match_scores_agg</span><span class="p">(</span>
            <span class="n">PhisX</span><span class="p">,</span> <span class="n">PhisY</span><span class="p">,</span> <span class="n">flagsX</span><span class="p">,</span> <span class="n">flagsY</span><span class="p">,</span> <span class="n">smk</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">smk</span><span class="o">.</span><span class="n">thresh</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">score</span></div>

<div class="viewcode-block" id="SMK.match_score_sep"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.match_score_sep">[docs]</a>    <span class="k">def</span> <span class="nf">match_score_sep</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">X_idx</span><span class="p">,</span> <span class="n">Y_idx</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">word_isect</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">phisX_list</span><span class="p">,</span> <span class="n">flagsY_list</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">phis_flags_list</span><span class="p">(</span><span class="n">X_idx</span><span class="p">)</span>
        <span class="n">phisY_list</span><span class="p">,</span> <span class="n">flagsX_list</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">phis_flags_list</span><span class="p">(</span><span class="n">Y_idx</span><span class="p">)</span>
        <span class="n">scores_list</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">match_scores_sep</span><span class="p">(</span>
            <span class="n">phisX_list</span><span class="p">,</span> <span class="n">phisY_list</span><span class="p">,</span> <span class="n">flagsX_list</span><span class="p">,</span> <span class="n">flagsY_list</span><span class="p">,</span> <span class="n">smk</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">smk</span><span class="o">.</span><span class="n">thresh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scores</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scores_list</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores_list</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">score</span></div>

<div class="viewcode-block" id="SMK.match_score_bow"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SMK.match_score_bow">[docs]</a>    <span class="k">def</span> <span class="nf">match_score_bow</span><span class="p">(</span><span class="n">smk</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="n">isect_words</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">wx_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">wx_set</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">smk</span><span class="o">.</span><span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">isect_words</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span></div></div>


<div class="viewcode-block" id="SparseVector"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SparseVector">[docs]</a><span class="k">class</span> <span class="nc">SparseVector</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dict</span> <span class="o">=</span> <span class="n">_dict</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> nonzero values&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vals</span>

<div class="viewcode-block" id="SparseVector.dot"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.SparseVector.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">keys1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">keys2</span><span class="p">)</span>
        <span class="n">vals1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keys</span><span class="p">])</span>
        <span class="n">vals2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">keys</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div></div>


<span class="c1"># class StackedLists(object):</span>
<span class="c1">#     def __init__(self, list_, offsets):</span>
<span class="c1">#         self.list_ = list_</span>
<span class="c1">#         self.offsets = offsets</span>
<span class="c1">#     def split(self):</span>
<span class="c1">#         return [self._list_[l:r] for l, r in ut.itertwo(self.offsets)]</span>
<span class="c1">#     stacked_vecs = StackedLists(all_vecs, offset_list)</span>
<span class="c1">#     vecs_list = stacked_vecs.split()</span>


<div class="viewcode-block" id="load_oxford_2007"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.load_oxford_2007">[docs]</a><span class="k">def</span> <span class="nf">load_oxford_2007</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from</span>
<span class="sd">    http://www.robots.ox.ac.uk:5000/~vgg/publications/2007/Philbin07/philbin07.pdf</span>

<span class="sd">    &gt;&gt;&gt; from ibeis.algo.smk.script_smk import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">splitext</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/&#39;</span><span class="p">)</span>
    <span class="n">data_fpath0</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="s1">&#39;data_2007.pkl&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">data_fpath0</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">data_fpath0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">word_dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="s1">&#39;word_oxc1_hesaff_sift_16M_1M&#39;</span><span class="p">)</span>
        <span class="n">_word_fpath_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">word_dpath</span><span class="p">)</span>
        <span class="n">imgid_to_word_fpath</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">word_fpath</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">word_fpath</span>
            <span class="k">for</span> <span class="n">word_fpath</span> <span class="ow">in</span> <span class="n">_word_fpath_list</span>
        <span class="p">}</span>
        <span class="n">readme_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="s1">&#39;README2.txt&#39;</span><span class="p">)</span>
        <span class="n">imgid_order</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="n">readme_fpath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">imgid_order</span> <span class="o">=</span> <span class="n">imgid_order</span>
        <span class="n">data_uri_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;oxc1_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imgid_order</span><span class="p">]</span>

        <span class="n">imgid_to_df</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">imgid</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">imgid_order</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;reading kpts&#39;</span><span class="p">):</span>
            <span class="n">word_fpath</span> <span class="o">=</span> <span class="n">imgid_to_word_fpath</span><span class="p">[</span><span class="n">imgid</span><span class="p">]</span>
            <span class="n">row_gen</span> <span class="o">=</span> <span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">read_lines_from</span><span class="p">(</span><span class="n">word_fpath</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">word_id</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e11</span><span class="p">,</span> <span class="n">e12</span><span class="p">,</span> <span class="n">e22</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">word_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e11</span><span class="p">,</span> <span class="n">e12</span><span class="p">,</span> <span class="n">e22</span><span class="p">)</span> <span class="ow">in</span> <span class="n">row_gen</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;word_id&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;e11&#39;</span><span class="p">,</span> <span class="s1">&#39;e12&#39;</span><span class="p">,</span> <span class="s1">&#39;e22&#39;</span><span class="p">])</span>
            <span class="n">imgid_to_df</span><span class="p">[</span><span class="n">imgid</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">imgid_to_df</span><span class="p">,</span> <span class="n">imgid_order</span><span class="p">)</span>

        <span class="n">nfeat_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_</span><span class="p">)</span> <span class="k">for</span> <span class="n">df_</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">]</span>
        <span class="n">offset_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">nfeat_list</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">128</span><span class="p">)</span>
        <span class="c1">#shape = (16334970, 128)</span>
        <span class="n">sift_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dbdir</span><span class="p">,</span> <span class="s1">&#39;OxfordSIFTDescriptors&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;feat_oxc1_hesaff_sift.bin&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sift_fpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;Reading SIFT binary file&#39;</span><span class="p">):</span>
                <span class="n">nbytes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">file_</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nbytes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">all_vecs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">file_</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">kpts_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;e11&#39;</span><span class="p">,</span> <span class="s1">&#39;e12&#39;</span><span class="p">,</span> <span class="s1">&#39;e22&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
                     <span class="k">for</span> <span class="n">df_</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">]</span>
        <span class="n">wordid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;word_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">df_</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">]</span>
        <span class="n">kpts_Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)</span>
        <span class="n">idx_to_wx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">wordid_list</span><span class="p">)</span>

        <span class="c1"># assert len(np.unique(idx_to_wx)) == 1E6</span>

        <span class="c1"># Reqd standard query order</span>
        <span class="n">query_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dbdir</span> <span class="o">+</span> <span class="s1">&#39;/oxford_groundtruth&#39;</span><span class="p">,</span> <span class="s1">&#39;*_query.txt&#39;</span><span class="p">))</span>
        <span class="n">query_uri_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">qpath</span> <span class="ow">in</span> <span class="n">query_files</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">readfrom</span><span class="p">(</span><span class="n">qpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">query_uri</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;oxc1_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">query_uri_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query_uri</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converting to invV&#39;</span><span class="p">)</span>
        <span class="n">all_kpts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_kptsZ_to_kpts</span><span class="p">(</span><span class="n">kpts_Z</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;offset_list&#39;</span><span class="p">:</span> <span class="n">offset_list</span><span class="p">,</span>
            <span class="s1">&#39;all_kpts&#39;</span><span class="p">:</span> <span class="n">all_kpts</span><span class="p">,</span>
            <span class="s1">&#39;all_vecs&#39;</span><span class="p">:</span> <span class="n">all_vecs</span><span class="p">,</span>
            <span class="s1">&#39;idx_to_wx&#39;</span><span class="p">:</span> <span class="n">idx_to_wx</span><span class="p">,</span>
            <span class="s1">&#39;data_uri_order&#39;</span><span class="p">:</span> <span class="n">data_uri_order</span><span class="p">,</span>
            <span class="s1">&#39;query_uri_order&#39;</span><span class="p">:</span> <span class="n">query_uri_order</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">data_fpath0</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_oxford_2013"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.load_oxford_2013">[docs]</a><span class="k">def</span> <span class="nf">load_oxford_2013</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Found this data in README of SMK publication</span>
<span class="sd">    https://hal.inria.fr/hal-00864684/document</span>
<span class="sd">    http://people.rennes.inria.fr/Herve.Jegou/publications.html</span>
<span class="sd">    with download script</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        # Download oxford13 data</span>
<span class="sd">        cd ~/work/Oxford</span>
<span class="sd">        mkdir -p smk_data_iccv_2013</span>
<span class="sd">        cd smk_data_iccv_2013</span>
<span class="sd">        wget -nH --cut-dirs=4 -r -Pdata/ ftp://ftp.irisa.fr/local/texmex/corpus/iccv2013/</span>

<span class="sd">    This dataset has 5063 images wheras 07 has 5062</span>
<span class="sd">    This dataset seems to contain an extra junk image:</span>
<span class="sd">        ashmolean_000214</span>

<span class="sd">    # Remember that matlab is 1 indexed!</span>
<span class="sd">    # DONT FORGET TO CONVERT TO 0 INDEXING!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">yael.ynumpy</span> <span class="k">import</span> <span class="n">fvecs_read</span>
    <span class="kn">from</span> <span class="nn">yael.yutils</span> <span class="k">import</span> <span class="n">load_ext</span>
    <span class="kn">import</span> <span class="nn">scipy.io</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>

    <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/&#39;</span><span class="p">)</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">dbdir</span> <span class="o">+</span> <span class="s1">&#39;/smk_data_iccv_2013/data/&#39;</span>

    <span class="c1"># we are not retraining, so this is unused</span>
    <span class="c1"># # Training data descriptors for Paris6k dataset</span>
    <span class="c1"># train_sift_fname = join(datadir, &#39;paris_sift.uint8&#39;)  # NOQA</span>
    <span class="c1"># # File storing visual words of Paris6k descriptors used in our ICCV paper</span>
    <span class="c1"># train_vw_fname = join(datadir, &#39;clust_preprocessed/oxford_train_vw.int32&#39;)</span>

    <span class="c1"># Pre-learned quantizer used in ICCV paper (used if docluster=false)</span>
    <span class="n">codebook_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;clust_preprocessed/oxford_codebook.fvecs&#39;</span><span class="p">)</span>

    <span class="c1"># Files storing descriptors/geometry for Oxford5k dataset</span>
    <span class="n">test_sift_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;oxford_sift.uint8&#39;</span><span class="p">)</span>
    <span class="n">test_geom_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;oxford_geom_sift.float&#39;</span><span class="p">)</span>
    <span class="n">test_nf_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;oxford_nsift.uint32&#39;</span><span class="p">)</span>

    <span class="c1"># File storing visual words of Oxford5k descriptors used in our ICCV paper</span>
    <span class="n">test_vw_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span>  <span class="s1">&#39;clust_preprocessed/oxford_vw.int32&#39;</span><span class="p">)</span>
    <span class="c1"># Ground-truth for Oxford dataset</span>
    <span class="n">gnd_fname</span> <span class="o">=</span>  <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span>  <span class="s1">&#39;gnd_oxford.mat&#39;</span><span class="p">)</span>

    <span class="n">oxford_vecs</span>   <span class="o">=</span> <span class="n">load_ext</span><span class="p">(</span><span class="n">test_sift_fname</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">oxford_nfeats</span> <span class="o">=</span> <span class="n">load_ext</span><span class="p">(</span><span class="n">test_nf_fname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">oxford_words</span>  <span class="o">=</span> <span class="n">fvecs_read</span><span class="p">(</span><span class="n">codebook_fname</span><span class="p">)</span>
    <span class="n">oxford_wids</span>   <span class="o">=</span> <span class="n">load_ext</span><span class="p">(</span><span class="n">test_vw_fname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">test_geom_invV_fname</span> <span class="o">=</span> <span class="n">test_geom_fname</span> <span class="o">+</span> <span class="s1">&#39;.invV.pkl&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_kpts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">test_geom_invV_fname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loaded invV keypoints&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">oxford_kptsZ</span>  <span class="o">=</span> <span class="n">load_ext</span><span class="p">(</span><span class="n">test_geom_fname</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converting to invV keypoints&#39;</span><span class="p">)</span>
        <span class="n">all_kpts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_kptsZ_to_kpts</span><span class="p">(</span><span class="n">oxford_kptsZ</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">test_geom_invV_fname</span><span class="p">,</span> <span class="n">all_kpts</span><span class="p">)</span>

    <span class="n">gnd_ox</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">gnd_fname</span><span class="p">)</span>
    <span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gnd_ox</span><span class="p">[</span><span class="s1">&#39;imlist&#39;</span><span class="p">]]</span>
    <span class="n">qx_to_dx</span> <span class="o">=</span> <span class="n">gnd_ox</span><span class="p">[</span><span class="s1">&#39;qidx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">data_uri_order</span> <span class="o">=</span> <span class="n">imlist</span>
    <span class="n">query_uri_order</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_uri_order</span><span class="p">,</span> <span class="n">qx_to_dx</span><span class="p">)</span>

    <span class="n">offset_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">oxford_nfeats</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="c1"># query_gnd = gnd_ox[&#39;gnd&#39;][0][0]</span>
    <span class="c1"># bboxes = query_gnd[0]</span>
    <span class="c1"># qx_to_ok_gtidxs1 = [x[0] for x in query_gnd[1][0]]</span>
    <span class="c1"># qx_to_junk_gtidxs2 = [x[0] for x in query_gnd[2][0]]</span>
    <span class="c1"># # ut.depth_profile(qx_to_gtidxs1)</span>
    <span class="c1"># # ut.depth_profile(qx_to_gtidxs2)</span>

    <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">oxford_nfeats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxford_vecs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">offset_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxford_vecs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxford_wids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxford_vecs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">oxford_wids</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxford_words</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;offset_list&#39;</span><span class="p">:</span> <span class="n">offset_list</span><span class="p">,</span>
        <span class="s1">&#39;all_kpts&#39;</span><span class="p">:</span> <span class="n">all_kpts</span><span class="p">,</span>
        <span class="s1">&#39;all_vecs&#39;</span><span class="p">:</span> <span class="n">oxford_vecs</span><span class="p">,</span>
        <span class="s1">&#39;words&#39;</span><span class="p">:</span> <span class="n">oxford_words</span><span class="p">,</span>
        <span class="s1">&#39;idx_to_wx&#39;</span><span class="p">:</span> <span class="n">oxford_wids</span><span class="p">,</span>
        <span class="s1">&#39;data_uri_order&#39;</span><span class="p">:</span> <span class="n">data_uri_order</span><span class="p">,</span>
        <span class="s1">&#39;query_uri_order&#39;</span><span class="p">:</span> <span class="n">query_uri_order</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_oxford_ibeis"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.load_oxford_ibeis">[docs]</a><span class="k">def</span> <span class="nf">load_oxford_ibeis</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s1">&#39;Oxford&#39;</span><span class="p">)</span>
    <span class="n">dim_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dannots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">has_none</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">),</span>
                          <span class="n">config</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dim_size</span><span class="o">=</span><span class="n">dim_size</span><span class="p">))</span>
    <span class="n">_qannots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">has_any</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">),</span>
                          <span class="n">config</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dim_size</span><span class="o">=</span><span class="n">dim_size</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;reading info&#39;</span><span class="p">):</span>
        <span class="n">vecs_list</span> <span class="o">=</span> <span class="n">_dannots</span><span class="o">.</span><span class="n">vecs</span>
        <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">_dannots</span><span class="o">.</span><span class="n">kpts</span>
        <span class="n">nfeats_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_dannots</span><span class="o">.</span><span class="n">num_feats</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;stacking info&#39;</span><span class="p">):</span>
        <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">vecs_list</span><span class="p">)</span>
        <span class="n">all_kpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">)</span>
        <span class="n">offset_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">nfeats_list</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># data_annots = reorder_annots(_dannots, data_uri_order)</span>

    <span class="n">data_uri_order</span> <span class="o">=</span> <span class="n">get_annots_imgid</span><span class="p">(</span><span class="n">_dannots</span><span class="p">)</span>
    <span class="n">query_uri_order</span> <span class="o">=</span> <span class="n">get_annots_imgid</span><span class="p">(</span><span class="n">_qannots</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;offset_list&#39;</span><span class="p">:</span> <span class="n">offset_list</span><span class="p">,</span>
        <span class="s1">&#39;all_kpts&#39;</span><span class="p">:</span> <span class="n">all_kpts</span><span class="p">,</span>
        <span class="s1">&#39;all_vecs&#39;</span><span class="p">:</span> <span class="n">all_vecs</span><span class="p">,</span>
        <span class="s1">&#39;data_uri_order&#39;</span><span class="p">:</span> <span class="n">data_uri_order</span><span class="p">,</span>
        <span class="s1">&#39;query_uri_order&#39;</span><span class="p">:</span> <span class="n">query_uri_order</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_annots_imgid"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.get_annots_imgid">[docs]</a><span class="k">def</span> <span class="nf">get_annots_imgid</span><span class="p">(</span><span class="n">_annots</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">splitext</span>
    <span class="n">_images</span> <span class="o">=</span> <span class="n">_annots</span><span class="o">.</span><span class="n">_ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>
    <span class="n">intern_uris</span> <span class="o">=</span> <span class="p">[</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">uri</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                   <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">_images</span><span class="o">.</span><span class="n">uris_original</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">intern_uris</span></div>


<div class="viewcode-block" id="load_ordered_annots"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.load_ordered_annots">[docs]</a><span class="k">def</span> <span class="nf">load_ordered_annots</span><span class="p">(</span><span class="n">data_uri_order</span><span class="p">,</span> <span class="n">query_uri_order</span><span class="p">):</span>
    <span class="c1"># Open the ibeis version of oxford</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s1">&#39;Oxford&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reorder_annots</span><span class="p">(</span><span class="n">_annots</span><span class="p">,</span> <span class="n">uri_order</span><span class="p">):</span>
        <span class="n">intern_uris</span> <span class="o">=</span> <span class="n">get_annots_imgid</span><span class="p">(</span><span class="n">_annots</span><span class="p">)</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">intern_uris</span><span class="p">)</span>
        <span class="n">_reordered</span> <span class="o">=</span> <span class="n">_annots</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">uri_order</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_reordered</span>

    <span class="c1"># Load database annotations and reorder them to agree with internals</span>
    <span class="n">_dannots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">has_none</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">))</span>
    <span class="n">data_annots</span> <span class="o">=</span> <span class="n">reorder_annots</span><span class="p">(</span><span class="n">_dannots</span><span class="p">,</span> <span class="n">data_uri_order</span><span class="p">)</span>

    <span class="c1"># Load query annototations and reorder to standard order</span>
    <span class="n">_qannots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_general</span><span class="p">(</span><span class="n">has_any</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">))</span>
    <span class="n">query_annots</span> <span class="o">=</span> <span class="n">reorder_annots</span><span class="p">(</span><span class="n">_qannots</span><span class="p">,</span> <span class="n">query_uri_order</span><span class="p">)</span>

    <span class="c1"># Map each query annot to its corresponding data index</span>
    <span class="n">dgid_to_dx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">data_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>
    <span class="n">qx_to_dx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">dgid_to_dx</span><span class="p">,</span> <span class="n">query_annots</span><span class="o">.</span><span class="n">gids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">query_annots</span><span class="p">,</span> <span class="n">data_annots</span><span class="p">,</span> <span class="n">qx_to_dx</span></div>


<div class="viewcode-block" id="run_asmk_script"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.run_asmk_script">[docs]</a><span class="k">def</span> <span class="nf">run_asmk_script</span><span class="p">():</span>
   <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>  <span class="c1"># NOQA</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from ibeis.algo.smk.script_smk import *</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># NOQA</span>

    <span class="c1"># ==============================================</span>
    <span class="c1"># PREPROCESSING CONFIGURATION</span>
    <span class="c1"># ==============================================</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># &#39;data_year&#39;: 2013,</span>
        <span class="s1">&#39;data_year&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;root_sift&#39;: True,</span>
        <span class="s1">&#39;root_sift&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="c1"># &#39;centering&#39;: True,</span>
        <span class="s1">&#39;centering&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;num_words&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span><span class="p">,</span>
        <span class="c1">#&#39;num_words&#39;: 1E6</span>
        <span class="c1">#&#39;num_words&#39;: 8000,</span>
        <span class="s1">&#39;kmeans_impl&#39;</span><span class="p">:</span> <span class="s1">&#39;sklearn.mini&#39;</span><span class="p">,</span>

        <span class="s1">&#39;extern_words&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;extern_assign&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;assign_algo&#39;</span><span class="p">:</span> <span class="s1">&#39;kdtree&#39;</span><span class="p">,</span>
        <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>

        <span class="s1">&#39;int_rvec&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;only_xy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Define which params are relevant for which operations</span>
    <span class="n">relevance</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">relevance</span><span class="p">[</span><span class="s1">&#39;feats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="s1">&#39;root_sift&#39;</span><span class="p">,</span> <span class="s1">&#39;centering&#39;</span><span class="p">,</span> <span class="s1">&#39;data_year&#39;</span><span class="p">]</span>
    <span class="n">relevance</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relevance</span><span class="p">[</span><span class="s1">&#39;feats&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">,</span> <span class="s1">&#39;extern_words&#39;</span><span class="p">,</span> <span class="s1">&#39;kmeans_impl&#39;</span><span class="p">]</span>
    <span class="n">relevance</span><span class="p">[</span><span class="s1">&#39;assign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relevance</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;extern_assign&#39;</span><span class="p">,</span> <span class="s1">&#39;assign_algo&#39;</span><span class="p">]</span>
    <span class="c1"># relevance[&#39;ydata&#39;] = relevance[&#39;assign&#39;] + [&#39;int_rvec&#39;]</span>
    <span class="c1"># relevance[&#39;xdata&#39;] = relevance[&#39;assign&#39;] + [&#39;only_xy&#39;, &#39;int_rvec&#39;]</span>

    <span class="n">nAssign</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">SMKCacher</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">Cacher</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.cPkl&#39;</span><span class="p">):</span>
            <span class="n">relevant_params</span> <span class="o">=</span> <span class="n">relevance</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
            <span class="n">relevant_cfg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">relevant_params</span><span class="p">)</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cfg_lbl</span><span class="p">(</span><span class="n">relevant_cfg</span><span class="p">)</span>
            <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SMKCacher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">dbdir</span><span class="p">,</span>
                                            <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>

    <span class="c1"># ==============================================</span>
    <span class="c1"># LOAD DATASET, EXTRACT AND POSTPROCESS FEATURES</span>
    <span class="c1"># ==============================================</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2007</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_oxford_2007</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_oxford_2013</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_year&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_oxford_ibeis</span><span class="p">()</span>

    <span class="n">offset_list</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;offset_list&#39;</span><span class="p">]</span>
    <span class="n">all_kpts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;all_kpts&#39;</span><span class="p">]</span>
    <span class="n">raw_vecs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;all_vecs&#39;</span><span class="p">]</span>
    <span class="n">query_uri_order</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;query_uri_order&#39;</span><span class="p">]</span>
    <span class="n">data_uri_order</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_uri_order&#39;</span><span class="p">]</span>
    <span class="c1"># del data</span>

    <span class="c1"># ================</span>
    <span class="c1"># PRE-PROCESS</span>
    <span class="c1"># ================</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="c1"># Alias names to avoid errors in interactive sessions</span>
    <span class="n">proc_vecs</span> <span class="o">=</span> <span class="n">raw_vecs</span>
    <span class="k">del</span> <span class="n">raw_vecs</span>

    <span class="n">feats_cacher</span> <span class="o">=</span> <span class="n">SMKCacher</span><span class="p">(</span><span class="s1">&#39;feats&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">feats_cacher</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">all_vecs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float32&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting vecs to float32&#39;</span><span class="p">)</span>
            <span class="n">proc_vecs</span> <span class="o">=</span> <span class="n">proc_vecs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc_vecs</span> <span class="o">=</span> <span class="n">proc_vecs</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;other dtype&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;root_sift&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;Apply root sift&#39;</span><span class="p">):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">proc_vecs</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">proc_vecs</span><span class="p">)</span>
                <span class="n">vt</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">proc_vecs</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">proc_vecs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;centering&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;Apply centering&#39;</span><span class="p">):</span>
                <span class="n">mean_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">proc_vecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Center and then re-normalize</span>
                <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">proc_vecs</span><span class="p">,</span> <span class="n">mean_vec</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">out</span><span class="o">=</span><span class="n">proc_vecs</span><span class="p">)</span>
                <span class="n">vt</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">proc_vecs</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">proc_vecs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int8&#39;</span><span class="p">:</span>
            <span class="n">smk_funcs</span>

        <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">proc_vecs</span>
        <span class="n">feats_cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">proc_vecs</span>

    <span class="c1"># =====================================</span>
    <span class="c1"># BUILD VISUAL VOCABULARY</span>
    <span class="c1"># =====================================</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extern_words&#39;</span><span class="p">]:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">word_cacher</span> <span class="o">=</span> <span class="n">SMKCacher</span><span class="p">(</span><span class="s1">&#39;words&#39;</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">word_cacher</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;kmeans_impl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sklearn.mini&#39;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">sklearn.cluster</span>
                    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">13421421</span><span class="p">)</span>
                    <span class="c1"># init_size = int(config[&#39;num_words&#39;] * 8)</span>
                    <span class="n">init_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="c1"># converged after 26043 iterations</span>
                    <span class="n">clusterer</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">MiniBatchKMeans</span><span class="p">(</span>
                        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">],</span> <span class="n">init_size</span><span class="o">=</span><span class="n">init_size</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">compute_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">clusterer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">)</span>
                    <span class="n">words</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">cluster_centers_</span>
                <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;kmeans_impl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yael&#39;</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">yael</span> <span class="k">import</span> <span class="n">ynumpy</span>
                    <span class="n">centroids</span><span class="p">,</span> <span class="n">qerr</span><span class="p">,</span> <span class="n">dis</span><span class="p">,</span> <span class="n">assign</span><span class="p">,</span> <span class="n">nassign</span> <span class="o">=</span> <span class="n">ynumpy</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
                        <span class="n">all_vecs</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">],</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;kmeans++&#39;</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                    <span class="n">words</span> <span class="o">=</span> <span class="n">centroids</span>
                <span class="n">word_cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="c1"># =====================================</span>
    <span class="c1"># ASSIGN EACH VECTOR TO ITS NEAREST WORD</span>
    <span class="c1"># =====================================</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extern_assign&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extern_words&#39;</span><span class="p">],</span> <span class="s1">&#39;need extern cluster to extern assign&#39;</span>
        <span class="n">idx_to_wxs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">atleast_nd</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;idx_to_wx&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">idx_to_maws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">idx_to_wxs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">idx_to_wxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx_to_wxs</span><span class="p">)</span>
        <span class="n">idx_to_maws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx_to_maws</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ibeis.algo.smk</span> <span class="k">import</span> <span class="n">vocab_indexer</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab_indexer</span><span class="o">.</span><span class="n">VisualVocab</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="n">dassign_cacher</span> <span class="o">=</span> <span class="n">SMKCacher</span><span class="p">(</span><span class="s1">&#39;assign&#39;</span><span class="p">)</span>
        <span class="n">assign_tup</span> <span class="o">=</span> <span class="n">dassign_cacher</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">assign_tup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vocab</span><span class="o">.</span><span class="n">flann_params</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;assign_algo&#39;</span><span class="p">]</span>
            <span class="n">vocab</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="c1"># Takes 12 minutes to assign jegous vecs to 2**16 vocab</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;assign vocab neighbors&#39;</span><span class="p">):</span>
                <span class="n">_idx_to_wx</span><span class="p">,</span> <span class="n">_idx_to_wdist</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">,</span> <span class="n">nAssign</span><span class="p">,</span>
                                                           <span class="n">checks</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;checks&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">nAssign</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">idx_to_wxs</span><span class="p">,</span> <span class="n">idx_to_maws</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">weight_multi_assigns</span><span class="p">(</span>
                        <span class="n">_idx_to_wx</span><span class="p">,</span> <span class="n">_idx_to_wdist</span><span class="p">,</span> <span class="n">massign_alpha</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">massign_sigma</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>
                        <span class="n">massign_equal_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_to_wxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">_idx_to_wx</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">idx_to_maws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">idx_to_wxs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="n">idx_to_maws</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">idx_to_wxs</span><span class="o">.</span><span class="n">mask</span>
            <span class="n">assign_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_to_wxs</span><span class="p">,</span> <span class="n">idx_to_maws</span><span class="p">)</span>
            <span class="n">dassign_cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">assign_tup</span><span class="p">)</span>

    <span class="n">idx_to_wxs</span><span class="p">,</span> <span class="n">idx_to_maws</span> <span class="o">=</span> <span class="n">assign_tup</span>

    <span class="c1"># Breakup vectors, keypoints, and word assignments by annotation</span>
    <span class="n">wx_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_to_wxs</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)]</span>
    <span class="n">maw_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_to_maws</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)]</span>
    <span class="n">vecs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_vecs</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)]</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_kpts</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)]</span>

    <span class="c1"># =======================</span>
    <span class="c1"># FIND QUERY SUBREGIONS</span>
    <span class="c1"># =======================</span>

    <span class="n">ibs</span><span class="p">,</span> <span class="n">query_annots</span><span class="p">,</span> <span class="n">data_annots</span><span class="p">,</span> <span class="n">qx_to_dx</span> <span class="o">=</span> <span class="n">load_ordered_annots</span><span class="p">(</span>
        <span class="n">data_uri_order</span><span class="p">,</span> <span class="n">query_uri_order</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="n">data_annots</span><span class="o">.</span><span class="n">aids</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="n">query_annots</span><span class="o">.</span><span class="n">aids</span>

    <span class="n">query_super_kpts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">,</span> <span class="n">qx_to_dx</span><span class="p">)</span>
    <span class="n">query_super_vecs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">vecs_list</span><span class="p">,</span> <span class="n">qx_to_dx</span><span class="p">)</span>
    <span class="n">query_super_wxs</span>  <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_lists</span><span class="p">,</span> <span class="n">qx_to_dx</span><span class="p">)</span>
    <span class="n">query_super_maws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">maw_lists</span><span class="p">,</span> <span class="n">qx_to_dx</span><span class="p">)</span>
    <span class="c1"># Mark which keypoints are within the bbox of the query</span>
    <span class="n">query_flags_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">only_xy</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;only_xy&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">kpts_</span><span class="p">,</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">query_super_kpts</span><span class="p">,</span> <span class="n">query_annots</span><span class="o">.</span><span class="n">bboxes</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">kpts_inside_bbox</span><span class="p">(</span><span class="n">kpts_</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">only_xy</span><span class="o">=</span><span class="n">only_xy</span><span class="p">)</span>
        <span class="n">query_flags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Queries are crops of existing database images.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Looking at average percents&#39;</span><span class="p">)</span>
    <span class="n">percent_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flags_</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">flags_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">flags_</span> <span class="ow">in</span> <span class="n">query_flags_list</span><span class="p">]</span>
    <span class="n">percent_stats</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">percent_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;percent_stats = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">percent_stats</span><span class="p">),))</span>

    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="n">query_kpts</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">query_super_kpts</span><span class="p">,</span> <span class="n">query_flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">query_vecs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">query_super_vecs</span><span class="p">,</span> <span class="n">query_flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">query_wxs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">query_super_wxs</span><span class="p">,</span> <span class="n">query_flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">query_maws</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">query_super_maws</span><span class="p">,</span> <span class="n">query_flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># =======================</span>
    <span class="c1"># CONSTRUCT QUERY / DATABASE REPR</span>
    <span class="c1"># =======================</span>

    <span class="c1"># int_rvec = not config[&#39;dtype&#39;].startswith(&#39;float&#39;)</span>
    <span class="n">int_rvec</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;int_rvec&#39;</span><span class="p">]</span>

    <span class="n">X_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new X&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">query_wxs</span><span class="p">,</span>
                                                <span class="n">query_maws</span><span class="p">)):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">new_external_annot</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span><span class="p">,</span> <span class="n">int_rvec</span><span class="p">)</span>
        <span class="n">X_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># ydata_cacher = SMKCacher(&#39;ydata&#39;)</span>
    <span class="c1"># Y_list = ydata_cacher.tryload()</span>
    <span class="c1"># if Y_list is None:</span>
    <span class="n">Y_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">daids</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;new Y&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">daids</span><span class="p">,</span> <span class="n">wx_lists</span><span class="p">,</span> <span class="n">maw_lists</span><span class="p">)):</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">new_external_annot</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span><span class="p">,</span> <span class="n">int_rvec</span><span class="p">)</span>
        <span class="n">Y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="c1"># ydata_cacher.save(Y_list)</span>

    <span class="c1">#======================</span>
    <span class="c1"># Add in some groundtruth</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Add in some groundtruth&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">daids</span><span class="p">)):</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nid</span>

    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">qaids</span><span class="p">)):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nid</span>

    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">qual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">daids</span><span class="p">)):</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">qual</span>

    <span class="c1">#======================</span>
    <span class="c1"># Add in other properties</span>
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">vecs_list</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">):</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">kpts</span> <span class="o">=</span> <span class="n">kpts</span>

    <span class="n">imgdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/oxbuild_images&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">imgid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">data_uri_order</span><span class="p">):</span>
        <span class="n">gpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">imgdir</span><span class="p">,</span>  <span class="n">imgid</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">gpath</span> <span class="o">=</span> <span class="n">gpath</span>

    <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">query_vecs</span><span class="p">,</span> <span class="n">query_kpts</span><span class="p">):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">kpts</span> <span class="o">=</span> <span class="n">kpts</span>
        <span class="n">X</span><span class="o">.</span><span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span>

    <span class="c1">#======================</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building inverted list&#39;</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">aid</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list</span><span class="p">]</span>
    <span class="c1"># wx_list = sorted(ut.list_union(*[Y.wx_list for Y in Y_list]))</span>
    <span class="n">wx_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">wx_set</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="n">daids</span> <span class="o">==</span> <span class="n">data_annots</span><span class="o">.</span><span class="n">aids</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wx_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_words&#39;</span><span class="p">]</span>

    <span class="n">wx_to_aids</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">invert_lists</span><span class="p">(</span>
        <span class="n">daids</span><span class="p">,</span> <span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">wx_list</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list</span><span class="p">],</span> <span class="n">all_wxs</span><span class="o">=</span><span class="n">wx_list</span><span class="p">)</span>

    <span class="c1"># Compute IDF weights</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compute IDF weights&#39;</span><span class="p">)</span>
    <span class="n">ndocs_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
    <span class="c1"># Use only the unique number of words</span>
    <span class="n">ndocs_per_word</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">wx_to_aids</span><span class="p">[</span><span class="n">wx</span><span class="p">]))</span> <span class="k">for</span> <span class="n">wx</span> <span class="ow">in</span> <span class="n">wx_list</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ndocs_perword stats: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">ndocs_per_word</span><span class="p">)))</span>
    <span class="n">idf_per_word</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">inv_doc_freq</span><span class="p">(</span><span class="n">ndocs_total</span><span class="p">,</span> <span class="n">ndocs_per_word</span><span class="p">)</span>
    <span class="n">wx_to_weight</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">wx_list</span><span class="p">,</span> <span class="n">idf_per_word</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;idf stats: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">wx_to_weight</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="c1"># Filter junk</span>
    <span class="n">Y_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">qual</span> <span class="o">!=</span> <span class="s1">&#39;junk&#39;</span><span class="p">]</span>

    <span class="c1"># =======================</span>
    <span class="c1"># CHOOSE QUERY KERNEL</span>
    <span class="c1"># =======================</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;asmk&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
        <span class="s1">&#39;bow&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="s1">&#39;bow2&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="c1"># method = &#39;bow&#39;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;bow2&#39;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;asmk&#39;</span>
    <span class="n">smk</span> <span class="o">=</span> <span class="n">SMK</span><span class="p">(</span><span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>

    <span class="c1"># Specific info for the type of query</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;asmk&#39;</span><span class="p">:</span>
        <span class="c1"># Make residual vectors</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># The stacked way is 50x faster</span>
            <span class="c1"># TODO: extend for multi-assignment and record fxs</span>
            <span class="n">flat_query_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">query_vecs</span><span class="p">)</span>
            <span class="n">flat_query_wxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">query_wxs</span><span class="p">)</span>
            <span class="n">flat_query_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">query_wxs</span><span class="p">)))</span>

            <span class="n">flat_wxs_assign</span> <span class="o">=</span> <span class="n">flat_query_wxs</span>
            <span class="n">flat_offsets</span> <span class="o">=</span>  <span class="n">flat_query_offsets</span>
            <span class="n">flat_vecs</span> <span class="o">=</span> <span class="n">flat_query_vecs</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">compute_stacked_agg_rvecs</span><span class="p">(</span>
                <span class="n">words</span><span class="p">,</span> <span class="n">flat_wxs_assign</span><span class="p">,</span> <span class="n">flat_vecs</span><span class="p">,</span> <span class="n">flat_offsets</span><span class="p">)</span>
            <span class="n">all_agg_vecs</span><span class="p">,</span> <span class="n">all_error_flags</span><span class="p">,</span> <span class="n">agg_offset_list</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="k">if</span> <span class="n">int_rvec</span><span class="p">:</span>
                <span class="n">all_agg_vecs</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">cast_residual_integer</span><span class="p">(</span><span class="n">all_agg_vecs</span><span class="p">)</span>
            <span class="n">agg_rvecs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_agg_vecs</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">agg_offset_list</span><span class="p">)]</span>
            <span class="n">agg_flags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_error_flags</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">agg_offset_list</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">agg_rvecs</span><span class="p">,</span> <span class="n">agg_flags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">agg_rvecs_list</span><span class="p">,</span> <span class="n">agg_flags_list</span><span class="p">):</span>
                <span class="n">X</span><span class="o">.</span><span class="n">agg_rvecs</span> <span class="o">=</span> <span class="n">agg_rvecs</span>
                <span class="n">X</span><span class="o">.</span><span class="n">agg_flags</span> <span class="o">=</span> <span class="n">agg_flags</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

            <span class="n">flat_wxs_assign</span> <span class="o">=</span> <span class="n">idx_to_wxs</span>
            <span class="n">flat_offsets</span> <span class="o">=</span> <span class="n">offset_list</span>
            <span class="n">flat_vecs</span> <span class="o">=</span> <span class="n">all_vecs</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">compute_stacked_agg_rvecs</span><span class="p">(</span>
                <span class="n">words</span><span class="p">,</span> <span class="n">flat_wxs_assign</span><span class="p">,</span> <span class="n">flat_vecs</span><span class="p">,</span> <span class="n">flat_offsets</span><span class="p">)</span>
            <span class="n">all_agg_vecs</span><span class="p">,</span> <span class="n">all_error_flags</span><span class="p">,</span> <span class="n">agg_offset_list</span> <span class="o">=</span> <span class="n">tup</span>
            <span class="k">if</span> <span class="n">int_rvec</span><span class="p">:</span>
                <span class="n">all_agg_vecs</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">cast_residual_integer</span><span class="p">(</span><span class="n">all_agg_vecs</span><span class="p">)</span>

            <span class="n">agg_rvecs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_agg_vecs</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">agg_offset_list</span><span class="p">)]</span>
            <span class="n">agg_flags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_error_flags</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">agg_offset_list</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">agg_rvecs</span><span class="p">,</span> <span class="n">agg_flags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">agg_rvecs_list</span><span class="p">,</span> <span class="n">agg_flags_list</span><span class="p">):</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">agg_rvecs</span> <span class="o">=</span> <span class="n">agg_rvecs</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">agg_flags</span> <span class="o">=</span> <span class="n">agg_flags</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This non-stacked way is about 500x slower</span>
            <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;agg Y rvecs&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="n">Y_list_</span><span class="p">):</span>
                <span class="n">make_agg_vecs</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>

            <span class="n">_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;agg X rvecs&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">_prog</span><span class="p">(</span><span class="n">X_list</span><span class="p">):</span>
                <span class="n">make_agg_vecs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">vecs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;bow2&#39;</span><span class="p">:</span>
        <span class="c1"># Hack for orig tf-idf bow vector</span>
        <span class="n">nwords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;make bow vector&#39;</span><span class="p">):</span>
            <span class="n">ensure_tf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">bow_vector</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">nwords</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">Y_list_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;make bow vector&#39;</span><span class="p">):</span>
            <span class="n">ensure_tf</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="n">bow_vector</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">nwords</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;bow2&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="s1">&#39;compute X gamma&#39;</span><span class="p">):</span>
            <span class="n">X</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">Y_list_</span><span class="p">,</span> <span class="s1">&#39;compute Y gamma&#39;</span><span class="p">):</span>
            <span class="n">Y</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">smk</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Execute matches (could go faster by enumerating candidates)</span>
    <span class="n">scores_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;query </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">smk</span><span class="p">,)):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">smk</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list_</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">scores_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">sklearn.metrics</span>
    <span class="n">avep_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">scores_list</span><span class="p">,</span> <span class="n">X_list</span><span class="p">))</span>
    <span class="n">_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">_iter</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;evaluate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">smk</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">scores</span><span class="p">,</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
        <span class="n">truth</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">nid</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">nid</span> <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list_</span><span class="p">]</span>
        <span class="n">avep</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
        <span class="n">avep_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avep</span><span class="p">)</span>
    <span class="n">avep_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avep_list</span><span class="p">)</span>
    <span class="n">mAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avep_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mAP  = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mAP</span><span class="p">,))</span></div>


<div class="viewcode-block" id="new_external_annot"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.new_external_annot">[docs]</a><span class="k">def</span> <span class="nf">new_external_annot</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span><span class="p">,</span> <span class="n">int_rvec</span><span class="p">):</span>
    <span class="n">wx_to_fxs</span><span class="p">,</span> <span class="n">wx_to_maws</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">invert_assigns</span><span class="p">(</span><span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">inverted_index</span><span class="o">.</span><span class="n">SingleAnnot</span><span class="p">()</span>
    <span class="n">X</span><span class="o">.</span><span class="n">aid</span> <span class="o">=</span> <span class="n">aid</span>
    <span class="c1"># Build Aggregate Residual Vectors</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">wx_to_fxs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_to_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">int_rvec</span> <span class="o">=</span> <span class="n">int_rvec</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="c1"># TODO: maybe use offset list structure instead of heavy nesting</span>
    <span class="n">X</span><span class="o">.</span><span class="n">fxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_fxs</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">maws_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_maws</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="make_agg_vecs"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.make_agg_vecs">[docs]</a><span class="k">def</span> <span class="nf">make_agg_vecs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">fx_to_vecs</span><span class="p">):</span>
    <span class="n">word_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">int_rvec</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">fx_to_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">X</span><span class="o">.</span><span class="n">agg_rvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">),</span> <span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">agg_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fxs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">fxs_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">maws</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">maws_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="n">fx_to_vecs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_rvecs</span><span class="p">,</span> <span class="n">_flags</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">compute_rvec</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
        <span class="n">_agg_rvec</span><span class="p">,</span> <span class="n">_agg_flag</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">aggregate_rvecs</span><span class="p">(</span><span class="n">_rvecs</span><span class="p">,</span> <span class="n">maws</span><span class="p">,</span> <span class="n">_flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">int_rvec</span><span class="p">:</span>
            <span class="n">_agg_rvec</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">cast_residual_integer</span><span class="p">(</span><span class="n">_agg_rvec</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">agg_rvecs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_agg_rvec</span>
        <span class="n">X</span><span class="o">.</span><span class="n">agg_flags</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_agg_flag</span>
    <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="ensure_tf"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.ensure_tf">[docs]</a><span class="k">def</span> <span class="nf">ensure_tf</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">termfreq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="c1"># do what video google does</span>
    <span class="n">termfreq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">),</span> <span class="n">termfreq</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">termfreq</span> <span class="o">=</span> <span class="n">termfreq</span></div>


<div class="viewcode-block" id="bow_vector"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.bow_vector">[docs]</a><span class="k">def</span> <span class="nf">bow_vector</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">nwords</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="n">wxs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_set</span><span class="p">))</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">termfreq</span><span class="p">,</span> <span class="n">wxs</span><span class="p">))</span>
    <span class="n">idf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">wxs</span><span class="p">))</span>
    <span class="n">bow_</span> <span class="o">=</span> <span class="n">tf</span> <span class="o">*</span> <span class="n">idf</span>
    <span class="n">bow_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">bow_</span><span class="p">)</span>
    <span class="n">bow</span> <span class="o">=</span> <span class="n">SparseVector</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">wxs</span><span class="p">,</span> <span class="n">bow_</span><span class="p">)))</span>
    <span class="n">X</span><span class="o">.</span><span class="n">bow</span> <span class="o">=</span> <span class="n">bow</span></div>


<div class="viewcode-block" id="make_temporary_annot"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.make_temporary_annot">[docs]</a><span class="k">def</span> <span class="nf">make_temporary_annot</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">nAssign</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nAssign&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smk_alpha&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smk_thresh&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="c1"># Compute assignments</span>
    <span class="n">fx_to_vecs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">assign_to_words</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">fx_to_vecs</span><span class="p">,</span> <span class="n">nAssign</span><span class="p">)</span>
    <span class="n">wx_to_fxs</span><span class="p">,</span> <span class="n">wx_to_maws</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">invert_assigns</span><span class="p">(</span><span class="n">fx_to_wxs</span><span class="p">,</span> <span class="n">fx_to_maws</span><span class="p">)</span>
    <span class="c1"># Build Aggregate Residual Vectors</span>
    <span class="n">wx_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">wx_to_fxs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">word_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">wx_to_word</span><span class="p">,</span> <span class="n">wx_list</span><span class="p">)</span>
    <span class="n">fxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_fxs</span><span class="p">,</span> <span class="n">wx_list</span><span class="p">)</span>
    <span class="n">maws_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_maws</span><span class="p">,</span> <span class="n">wx_list</span><span class="p">)</span>
    <span class="n">agg_rvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">wx_list</span><span class="p">),</span> <span class="n">fx_to_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">agg_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">wx_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wx_list</span><span class="p">)):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fxs</span> <span class="o">=</span> <span class="n">fxs_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">maws</span> <span class="o">=</span> <span class="n">maws_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="n">fx_to_vecs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">_rvecs</span><span class="p">,</span> <span class="n">_flags</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">compute_rvec</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
        <span class="n">_agg_rvec</span><span class="p">,</span> <span class="n">_agg_flag</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">aggregate_rvecs</span><span class="p">(</span><span class="n">_rvecs</span><span class="p">,</span> <span class="n">maws</span><span class="p">,</span> <span class="n">_flags</span><span class="p">)</span>
        <span class="n">agg_rvecs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_agg_rvec</span>
        <span class="n">agg_flags</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_agg_flag</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">inverted_index</span><span class="o">.</span><span class="n">SingleAnnot</span><span class="p">()</span>
    <span class="n">X</span><span class="o">.</span><span class="n">aid</span> <span class="o">=</span> <span class="n">aid</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_list</span> <span class="o">=</span> <span class="n">wx_list</span>
    <span class="n">X</span><span class="o">.</span><span class="n">fxs_list</span> <span class="o">=</span> <span class="n">fxs_list</span>
    <span class="n">X</span><span class="o">.</span><span class="n">maws_list</span> <span class="o">=</span> <span class="n">maws_list</span>
    <span class="n">X</span><span class="o">.</span><span class="n">agg_rvecs</span> <span class="o">=</span> <span class="n">agg_rvecs</span>
    <span class="n">X</span><span class="o">.</span><span class="n">agg_flags</span> <span class="o">=</span> <span class="n">agg_flags</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_to_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">int_rvec</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">X</span><span class="o">.</span><span class="n">wx_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">wx_list</span><span class="p">)</span>

    <span class="n">weight_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">wx_list</span><span class="p">))</span>
    <span class="n">X</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">smk_funcs</span><span class="o">.</span><span class="n">gamma_agg</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">agg_rvecs</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">agg_flags</span><span class="p">,</span> <span class="n">weight_list</span><span class="p">,</span>
                                  <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span></div>


<div class="viewcode-block" id="verify_score"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.verify_score">[docs]</a><span class="k">def</span> <span class="nf">verify_score</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recompute all SMK things for two annotations and compare scores.</span>

<span class="sd">    &gt;&gt;&gt; from ibeis.algo.smk.script_smk import *  # NOQA</span>

<span class="sd">    cm.print_inspect_str(qreq_)</span>
<span class="sd">    cm.show_single_annotmatch(qreq_, daid1)</span>
<span class="sd">    cm.show_single_annotmatch(qreq_, daid2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qreq_</span><span class="p">,</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">load_internal_data</span><span class="p">()</span>
    <span class="n">qreq_</span><span class="o">.</span><span class="n">ensure_data</span><span class="p">()</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>
    <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
    <span class="n">daid1</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">daid2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">vocab</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc</span><span class="p">[</span><span class="s1">&#39;vocab&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_row_data</span><span class="p">([</span><span class="n">qreq_</span><span class="o">.</span><span class="n">dinva</span><span class="o">.</span><span class="n">vocab_rowid</span><span class="p">],</span> <span class="s1">&#39;words&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wx_to_weight</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">dinva</span><span class="o">.</span><span class="n">wx_to_weight</span>

    <span class="n">aid</span> <span class="o">=</span> <span class="n">qaid</span>  <span class="c1"># NOQA</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smk_alpha&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smk_thresh&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">make_temporary_annot</span><span class="p">(</span><span class="n">qaid</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">smk_pipeline</span><span class="o">.</span><span class="n">match_kernel_agg</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">Y1</span> <span class="o">=</span> <span class="n">make_temporary_annot</span><span class="p">(</span><span class="n">daid1</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">smk_pipeline</span><span class="o">.</span><span class="n">match_kernel_agg</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">([</span><span class="n">daid1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">smk_pipeline</span><span class="o">.</span><span class="n">match_kernel_agg</span><span class="p">(</span><span class="n">Y1</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">Y2</span> <span class="o">=</span> <span class="n">make_temporary_annot</span><span class="p">(</span><span class="n">daid2</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">smk_pipeline</span><span class="o">.</span><span class="n">match_kernel_agg</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y2</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">([</span><span class="n">daid2</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">smk_pipeline</span><span class="o">.</span><span class="n">match_kernel_agg</span><span class="p">(</span><span class="n">Y2</span><span class="p">,</span> <span class="n">Y2</span><span class="p">,</span> <span class="n">wx_to_weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span></div>
    <span class="c1">#Y2 = make_temporary_annot(daid2, vocab, wx_to_weight, ibs, config)</span>


<div class="viewcode-block" id="kpts_inside_bbox"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.kpts_inside_bbox">[docs]</a><span class="k">def</span> <span class="nf">kpts_inside_bbox</span><span class="p">(</span><span class="n">kpts</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">only_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Use keypoint extent to filter out what is in query</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="n">xys</span> <span class="o">=</span> <span class="n">kpts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">only_xy</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">point_inside_bbox</span><span class="p">(</span><span class="n">xys</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bbox</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wh_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_kpts_wh</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">wh_list</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">pts1</span> <span class="o">=</span> <span class="n">xys</span> <span class="o">+</span> <span class="n">radii</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">pts2</span> <span class="o">=</span> <span class="n">xys</span> <span class="o">+</span> <span class="n">radii</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pts3</span> <span class="o">=</span> <span class="n">xys</span> <span class="o">+</span> <span class="n">radii</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pts4</span> <span class="o">=</span> <span class="n">xys</span> <span class="o">+</span> <span class="n">radii</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">point_inside_bbox</span><span class="p">(</span><span class="n">pts1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bbox</span><span class="p">),</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">point_inside_bbox</span><span class="p">(</span><span class="n">pts2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bbox</span><span class="p">),</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">point_inside_bbox</span><span class="p">(</span><span class="n">pts3</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bbox</span><span class="p">),</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">point_inside_bbox</span><span class="p">(</span><span class="n">pts4</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bbox</span><span class="p">),</span>
        <span class="p">])</span>
    <span class="k">return</span> <span class="n">flags</span></div>


<div class="viewcode-block" id="sanity_checks"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.sanity_checks">[docs]</a><span class="k">def</span> <span class="nf">sanity_checks</span><span class="p">(</span><span class="n">offset_list</span><span class="p">,</span> <span class="n">Y_list</span><span class="p">,</span> <span class="n">query_annots</span><span class="p">,</span> <span class="n">ibs</span><span class="p">):</span>
    <span class="n">nfeat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">nfeat</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Y_list</span><span class="p">,</span> <span class="n">nfeat_list</span><span class="p">),</span> <span class="s1">&#39;checking&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">nfeat</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">fxs_list</span><span class="p">))</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Visualize queries</span>
        <span class="c1"># Look at the standard query images here</span>
        <span class="c1"># http://www.robots.ox.ac.uk:5000/~vgg/publications/2007/Philbin07/philbin07.pdf</span>
        <span class="kn">from</span> <span class="nn">ibeis.viz</span> <span class="k">import</span> <span class="n">viz_chip</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">qt4ensure</span><span class="p">()</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">query_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">)</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">query_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">):</span>
            <span class="n">pnum</span> <span class="o">=</span> <span class="n">pnum_</span><span class="p">()</span>
            <span class="n">viz_chip</span><span class="o">.</span><span class="n">show_chip</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">in_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annote</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">notitle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">draw_lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">)</span></div>


<div class="viewcode-block" id="oxford_conic_test"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.oxford_conic_test">[docs]</a><span class="k">def</span> <span class="nf">oxford_conic_test</span><span class="p">():</span>
    <span class="c1"># Test that these are what the readme says</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.016682</span><span class="p">,</span> <span class="mf">0.001693</span><span class="p">,</span> <span class="mf">0.014927</span><span class="p">]</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.010141</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1e-05</span><span class="p">,</span> <span class="mf">0.02863</span><span class="p">]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="p">[</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">]])</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="n">invV</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">decompose_Z_to_invV_2x2</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="n">invV</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">decompose_Z_to_invV_mats2x2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Z</span><span class="p">]))</span>  <span class="c1"># NOQA</span></div>
    <span class="c1"># seems ok</span>
    <span class="c1">#invV = np.linalg.inv(V)</span>


<div class="viewcode-block" id="load_internal_data"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.load_internal_data">[docs]</a><span class="k">def</span> <span class="nf">load_internal_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ibeis TestResult --db Oxford \</span>
<span class="sd">        -p smk:nWords=[64000],nAssign=[1],SV=[False],can_match_sameimg=True,dim_size=None \</span>
<span class="sd">        -a oxford \</span>
<span class="sd">        --dev-mode</span>

<span class="sd">    ibeis TestResult --db GZ_Master1 \</span>
<span class="sd">        -p smk:nWords=[64000],nAssign=[1],SV=[False],fg_on=False \</span>
<span class="sd">        -a ctrl:qmingt=2 \</span>
<span class="sd">        --dev-mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># from ibeis.algo.smk.smk_pipeline import *  # NOQA</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">testdata_qreq_</span><span class="p">(</span>
        <span class="n">defaultdb</span><span class="o">=</span><span class="s1">&#39;Oxford&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s1">&#39;oxford&#39;</span><span class="p">,</span>
        <span class="n">p</span><span class="o">=</span><span class="s1">&#39;smk:nWords=[64000],nAssign=[1],SV=[False],can_match_sameimg=True,dim_size=None&#39;</span><span class="p">)</span>
    <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">ave_precisions</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_annot_ave_precision</span><span class="p">()</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
    <span class="n">mAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ave_precisions</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mAP = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mAP</span><span class="p">,))</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">cm_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">cm</span></div>


<div class="viewcode-block" id="compare_data"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.compare_data">[docs]</a><span class="k">def</span> <span class="nf">compare_data</span><span class="p">(</span><span class="n">Y_list_</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ibeis</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibeis</span><span class="o">.</span><span class="n">testdata_qreq_</span><span class="p">(</span>
        <span class="n">defaultdb</span><span class="o">=</span><span class="s1">&#39;Oxford&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s1">&#39;oxford&#39;</span><span class="p">,</span>
        <span class="n">p</span><span class="o">=</span><span class="s1">&#39;smk:nWords=[64000],nAssign=[1],SV=[False],can_match_sameimg=True,dim_size=None&#39;</span><span class="p">)</span>
    <span class="n">qreq_</span><span class="o">.</span><span class="n">ensure_data</span><span class="p">()</span>

    <span class="n">gamma1s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gamma2s</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_list_</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">daids</span><span class="p">))</span>

    <span class="n">dinva</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">dinva</span>
    <span class="n">bady</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">Y</span> <span class="ow">in</span> <span class="n">Y_list_</span><span class="p">:</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">aid</span>
        <span class="n">gamma1</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">gamma</span>
        <span class="k">if</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">dinva</span><span class="o">.</span><span class="n">aid_to_idx</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">dinva</span><span class="o">.</span><span class="n">aid_to_idx</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span>
            <span class="n">gamma2</span> <span class="o">=</span> <span class="n">dinva</span><span class="o">.</span><span class="n">gamma_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">gamma1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma1</span><span class="p">)</span>
            <span class="n">gamma2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gamma2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bady</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Y</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">nid</span><span class="p">)</span>
            <span class="c1"># print(Y.qual)</span>

    <span class="c1"># ibs = qreq_.ibs</span>
    <span class="c1"># z = ibs.annots([a.aid for a in bady])</span>

    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">qtensure</span><span class="p">()</span>
    <span class="n">gamma1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gamma1s</span><span class="p">)</span>
    <span class="n">gamma2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gamma2s</span><span class="p">)</span>
    <span class="n">sortx</span> <span class="o">=</span> <span class="n">gamma1s</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gamma1s</span><span class="p">[</span><span class="n">sortx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;script&#39;</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gamma2s</span><span class="p">[</span><span class="n">sortx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pipe&#39;</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>


<div class="viewcode-block" id="show_data_image"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.show_data_image">[docs]</a><span class="k">def</span> <span class="nf">show_data_image</span><span class="p">(</span><span class="n">data_uri_order</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset_list</span><span class="p">,</span> <span class="n">all_kpts</span><span class="p">,</span> <span class="n">all_vecs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    i = 12</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
    <span class="n">imgdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/oxbuild_images&#39;</span><span class="p">)</span>
    <span class="n">gpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">imgdir</span><span class="p">,</span>  <span class="n">data_uri_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">qt4ensure</span><span class="p">()</span>
    <span class="c1"># pt.imshow(image)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">offset_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">offset_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">all_kpts</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span>
    <span class="n">vecs</span> <span class="o">=</span> <span class="n">all_vecs</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">interact_keypoints</span><span class="o">.</span><span class="n">ishow_keypoints</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span>
                                          <span class="n">ori</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ell_alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span>
                                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;distinct&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_image_sizes"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.check_image_sizes">[docs]</a><span class="k">def</span> <span class="nf">check_image_sizes</span><span class="p">(</span><span class="n">data_uri_order</span><span class="p">,</span> <span class="n">all_kpts</span><span class="p">,</span> <span class="n">offset_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if any keypoints go out of bounds wrt their associated images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
    <span class="n">imgdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/oxbuild_images&#39;</span><span class="p">)</span>
    <span class="n">gpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">imgdir</span><span class="p">,</span> <span class="n">imgid</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">imgid</span> <span class="ow">in</span> <span class="n">data_uri_order</span><span class="p">]</span>
    <span class="n">imgsize_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">open_image_size</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list</span><span class="p">]</span>
    <span class="n">kpts_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_kpts</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">offset_list</span><span class="p">)]</span>

    <span class="n">kpts_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">get_kpts_image_extent</span><span class="p">(</span><span class="n">kpts</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only_xy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">kpts_list</span><span class="p">,</span> <span class="s1">&#39;kpts extent&#39;</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgsize_list</span><span class="p">,</span> <span class="n">kpts_extent</span><span class="p">)):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">maxx</span><span class="p">)</span> <span class="ow">or</span> <span class="n">maxx</span> <span class="o">&lt;</span> <span class="n">w</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">maxy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">maxy</span> <span class="o">&lt;</span> <span class="n">h</span></div>


<div class="viewcode-block" id="hyrule_vocab_test"><a class="viewcode-back" href="../../../../ibeis.algo.smk.html#ibeis.algo.smk.script_smk.hyrule_vocab_test">[docs]</a><span class="k">def</span> <span class="nf">hyrule_vocab_test</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">yael.yutils</span> <span class="k">import</span> <span class="n">load_ext</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
    <span class="kn">import</span> <span class="nn">sklearn.cluster</span>

    <span class="n">dbdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;/raid/work/Oxford/&#39;</span><span class="p">)</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">dbdir</span> <span class="o">+</span> <span class="s1">&#39;/smk_data_iccv_2013/data/&#39;</span>

    <span class="c1"># Files storing descriptors/geometry for Oxford5k dataset</span>
    <span class="n">test_sift_fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;oxford_sift.uint8&#39;</span><span class="p">)</span>
    <span class="c1"># test_nf_fname = join(datadir, &#39;oxford_nsift.uint32&#39;)</span>
    <span class="n">all_vecs</span> <span class="o">=</span> <span class="n">load_ext</span><span class="p">(</span><span class="n">test_sift_fname</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">print_object_size</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">))</span>
    <span class="c1"># nfeats_list = load_ext(test_nf_fname, verbose=True)</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">13421421</span><span class="p">)</span>
        <span class="c1"># init_size = int(config[&#39;num_words&#39;] * 8)</span>
        <span class="n">num_words</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">init_size</span> <span class="o">=</span> <span class="n">num_words</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="c1"># converged after 26043 iterations</span>
        <span class="n">minibatch_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">n_clusters</span><span class="o">=</span><span class="n">num_words</span><span class="p">,</span>
            <span class="n">init</span><span class="o">=</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span>
            <span class="c1"># init=&#39;random&#39;,</span>
            <span class="n">init_size</span><span class="o">=</span><span class="n">init_size</span><span class="p">,</span>
            <span class="n">n_init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">max_no_improvement</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">reassignment_ratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">clusterer</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">MiniBatchKMeans</span><span class="p">(</span>
            <span class="n">compute_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="o">**</span><span class="n">minibatch_params</span><span class="p">)</span>
        <span class="n">clusterer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">clusterer</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.smk.script_smk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_asmk_script</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Wild Me

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>