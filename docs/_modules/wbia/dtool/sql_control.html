
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.dtool.sql_control &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.dtool.sql_control</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Interface into SQL for the IBEIS Controller</span>

<span class="sd">TODO; need to use some sort of sticky bit so</span>
<span class="sd">sql files are created with reasonable permissions.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">parse</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">deprecated</span> <span class="kn">import</span> <span class="n">deprecated</span>

<span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">sqlite3</span> <span class="k">as</span> <span class="n">lite</span>
<span class="kn">from</span> <span class="nn">wbia.dtool.dump</span> <span class="kn">import</span> <span class="n">dumps</span>


<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<span class="n">READ_ONLY</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--readonly-mode&#39;</span><span class="p">,</span> <span class="s1">&#39;--read-only&#39;</span><span class="p">,</span> <span class="s1">&#39;--readonly&#39;</span><span class="p">))</span>
<span class="n">VERBOSE_SQL</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--print-sql&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose-sql&#39;</span><span class="p">,</span> <span class="s1">&#39;--verb-sql&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbsql&#39;</span><span class="p">))</span>
<span class="n">NOT_QUIET</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">QUIET</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--quiet-sql&#39;</span><span class="p">))</span>

<span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span>
<span class="n">VERYVERBOSE</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERYVERBOSE</span>

<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c1"># Wait for up to 600 seconds for the database to return from a locked state</span>

<span class="n">SQLColumnRichInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;SQLColumnRichInfo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;column_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type_&#39;</span><span class="p">,</span> <span class="s1">&#39;notnull&#39;</span><span class="p">,</span> <span class="s1">&#39;dflt_value&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1"># FIXME (31-Jul-12020) Duplicate definition of wbia.constants.METADATA_TABLE</span>
<span class="c1">#       Use this definition as the authority because it&#39;s within the context of its use.</span>
<span class="n">METADATA_TABLE_NAME</span> <span class="o">=</span> <span class="s1">&#39;metadata&#39;</span>
<span class="c1"># Defines the columns used within the metadata table.</span>
<span class="n">METADATA_TABLE_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Dictionary of metadata column names pair with:</span>
    <span class="c1">#  - is_coded_data: bool showing if the value is a data type (True) or string (False)</span>
    <span class="c1"># &lt;column-name&gt;: &lt;info-dict&gt;</span>
    <span class="s1">&#39;dependson&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;docstr&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="s1">&#39;relates&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;shortname&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;superkeys&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;extern_tables&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;dependsmap&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;primary_superkey&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="s1">&#39;constraint&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_coded_data</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">METADATA_TABLE_COLUMN_NAMES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">METADATA_TABLE_COLUMNS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_unpacker</span><span class="p">(</span><span class="n">results_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; HELPER: Unpacks results if unpack_scalars is True. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;throwing away results! { </span><span class="si">%r</span><span class="s1"> }&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results_</span><span class="p">,)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span>


<div class="viewcode-block" id="tuplize"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.tuplize">[docs]</a><span class="k">def</span> <span class="nf">tuplize</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts each scalar item in a list to a dimension-1 tuple &quot;&quot;&quot;</span>
    <span class="n">tup_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">item</span><span class="p">,)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tup_list</span></div>


<div class="viewcode-block" id="flattenize"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.flattenize">[docs]</a><span class="k">def</span> <span class="nf">flattenize</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    maps flatten to a tuplized list</span>

<span class="sd">    Weird function. DEPRICATE</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; list_ = [[1, 2, 3], [2, 3, [4, 2, 1]], [3, 2], [[1, 2], [3, 4]]]</span>
<span class="sd">        &gt;&gt;&gt; import utool</span>
<span class="sd">        &gt;&gt;&gt; from itertools import zip</span>
<span class="sd">        &gt;&gt;&gt; val_list1 = [(1, 2), (2, 4), (5, 3)]</span>
<span class="sd">        &gt;&gt;&gt; id_list1  = [(1,),     (2,),   (3,)]</span>
<span class="sd">        &gt;&gt;&gt; out_list1 = utool.flattenize(zip(val_list1, id_list1))</span>

<span class="sd">        &gt;&gt;&gt; val_list2 = [1, 4, 5]</span>
<span class="sd">        &gt;&gt;&gt; id_list2  = [(1,),     (2,),   (3,)]</span>
<span class="sd">        &gt;&gt;&gt; out_list2 = utool.flattenize(zip(val_list2, id_list2))</span>

<span class="sd">        &gt;&gt;&gt; val_list3 = [1, 4, 5]</span>
<span class="sd">        &gt;&gt;&gt; id_list3  = [1, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; out_list3 = utool.flattenize(zip(val_list3, id_list3))</span>

<span class="sd">        out_list4 = list(zip(val_list3, id_list3))</span>
<span class="sd">        %timeit utool.flattenize(zip(val_list1, id_list1))</span>
<span class="sd">        %timeit utool.flattenize(zip(val_list2, id_list2))</span>
<span class="sd">        %timeit utool.flattenize(zip(val_list3, id_list3))</span>
<span class="sd">        %timeit list(zip(val_list3, id_list3))</span>

<span class="sd">        100000 loops, best of 3: 14 us per loop</span>
<span class="sd">        100000 loops, best of 3: 16.5 us per loop</span>
<span class="sd">        100000 loops, best of 3: 18 us per loop</span>
<span class="sd">        1000000 loops, best of 3: 1.18 us per loop</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tuplized_iter</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">tuplize</span><span class="p">,</span> <span class="n">list_</span><span class="p">)</span>
    <span class="n">flatenized_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">tuplized_iter</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flatenized_list</span></div>


<span class="c1"># =======================</span>
<span class="c1"># SQL Context Class</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="SQLExecutionContext"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLExecutionContext">[docs]</a><span class="k">class</span> <span class="nc">SQLExecutionContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for transactional database calls</span>

<span class="sd">    FIXME: hash out details. I don&#39;t think anybody who programmed this</span>
<span class="sd">    knows what is going on here. So much for fine grained control.</span>

<span class="sd">    Referencs:</span>
<span class="sd">        http://stackoverflow.com/questions/9573768/understand-sqlite-multi-module-envs</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span>
        <span class="n">db</span><span class="p">,</span>
        <span class="n">operation</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">auto_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">start_transaction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keepwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">,</span>
        <span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">context</span><span class="o">.</span><span class="n">auto_commit</span> <span class="o">=</span> <span class="n">auto_commit</span>
        <span class="n">context</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">context</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>
        <span class="n">context</span><span class="o">.</span><span class="n">nInput</span> <span class="o">=</span> <span class="n">nInput</span>
        <span class="n">context</span><span class="o">.</span><span class="n">start_transaction</span> <span class="o">=</span> <span class="n">start_transaction</span>
        <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span> <span class="o">=</span> <span class="n">get_operation_type</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">context</span><span class="o">.</span><span class="n">is_insert</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">keepwrap</span> <span class="o">=</span> <span class="n">keepwrap</span>
        <span class="n">context</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks to see if the operating will change the database &quot;&quot;&quot;</span>
        <span class="c1"># ut.printif(lambda: &#39;[sql] Callers: &#39; + ut.get_caller_name(range(3, 6)), DEBUG)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">nInput</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">operation_lbl</span> <span class="o">=</span> <span class="s1">&#39;[sql] execute nInput=</span><span class="si">%d</span><span class="s1"> optype=</span><span class="si">%s</span><span class="s1">: &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">nInput</span><span class="p">,</span>
                <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">operation_lbl</span> <span class="o">=</span> <span class="s1">&#39;[sql] executeone optype=</span><span class="si">%s</span><span class="s1">: &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span>
            <span class="p">)</span>
        <span class="c1"># Start SQL Transaction</span>

        <span class="n">context</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># HACK in a new cursor</span>
        <span class="k">except</span> <span class="n">lite</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
            <span class="c1"># Get connection for new thread</span>
            <span class="n">context</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">thread_connection</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># context.cur = context.db.cur  # OR USE DB CURSOR??</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">:</span>
            <span class="c1"># context.cur.execute(&#39;BEGIN&#39;, ())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">lite</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">operation_lbl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] operation=</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
        <span class="c1"># Comment out timeing code</span>
        <span class="c1"># if __debug__:</span>
        <span class="c1">#    if NOT_QUIET and (VERBOSE_SQL or context.verbose):</span>
        <span class="c1">#        context.tt = ut.tic(context.operation_lbl)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="SQLExecutionContext.execute_and_generate_results"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLExecutionContext.execute_and_generate_results">[docs]</a>    <span class="k">def</span> <span class="nf">execute_and_generate_results</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; helper for context statment &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">lite</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reporting SQLite Error&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;params = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;sql.Error&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;probably unsupported type&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;ERR REPORT: given param types = &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">tablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SELECT&#39;</span><span class="p">):</span>
                        <span class="n">tablename</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span>
                            <span class="n">context</span><span class="o">.</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;FROM&#39;</span><span class="p">,</span> <span class="s1">&#39;WHERE&#39;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tablename</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">operation_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tablename</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">tablename</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">coldef_list</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_coldef_list</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;ERR REPORT: expected types = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">coldef_list</span><span class="p">),)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">_results_gen</span><span class="p">()</span></div>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">_results_gen</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; HELPER - Returns as many results as there are.</span>
<span class="sd">        Careful. Overwrites the results once you call it.</span>
<span class="sd">        Basically: Dont call this twice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">is_insert</span><span class="p">:</span>
            <span class="c1"># The sqlite3_last_insert_rowid(D) interface returns the</span>
            <span class="c1"># &lt;b&gt; rowid of the most recent successful INSERT &lt;/b&gt;</span>
            <span class="c1"># into a rowid table in D</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT last_insert_rowid()&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="c1"># Wraping fetchone in a generator for some pretty tight calls.</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">keepwrap</span><span class="p">:</span>
                <span class="c1"># Results are always returned wraped in a tuple</span>
                <span class="k">yield</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Here unpacking is conditional</span>
                <span class="c1"># FIXME: can this if be removed?</span>
                <span class="k">yield</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finalization of an SQLController call &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># An SQLError is a serious offence.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] FATAL ERROR IN QUERY CONTEXT&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] operation=</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] Error in context manager!: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># return a falsey value on error</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Commit the transaction</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">auto_commit</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no commit </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="o">.</span><span class="n">operation_lbl</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_operation_type"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.get_operation_type">[docs]</a><span class="k">def</span> <span class="nf">get_operation_type</span><span class="p">(</span><span class="n">operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the operation_type from an SQL operation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SELECT&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operation_type</span><span class="p">,</span> <span class="s1">&#39;FROM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;INSERT&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operation_type</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DROP&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ALTER&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operation_type</span><span class="p">,</span> <span class="s1">&#39;FROM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operation_type</span><span class="p">,</span> <span class="s1">&#39;FROM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CREATE&#39;</span><span class="p">):</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">str_between</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operation_type</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">operation_args</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">operation_type</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">operation_args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">operation_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span></div>


<div class="viewcode-block" id="sanitize_sql"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.sanitize_sql">[docs]</a><span class="k">def</span> <span class="nf">sanitize_sql</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename_</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sanatizes an sql tablename and column. Use sparingly &quot;&quot;&quot;</span>
    <span class="n">tablename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z_0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tablename_</span><span class="p">)</span>
    <span class="n">valid_tables</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_tables</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tablename_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename_</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;valid_tables = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_tables</span><span class="p">,))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;UNSAFE TABLE: tablename=</span><span class="si">%r</span><span class="s1">. &#39;</span>
            <span class="s1">&#39;Column names and table names should be different&#39;</span> <span class="o">%</span> <span class="n">tablename</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tablename</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_sanitize_sql_helper</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
            <span class="n">column_</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^a-zA-Z_0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="n">valid_columns</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">column_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s1">&#39;UNSAFE COLUMN: must be all lowercase. &#39;</span>
                    <span class="s1">&#39;tablename=</span><span class="si">{}</span><span class="s1">, column=</span><span class="si">{}</span><span class="s1">, valid_columns=</span><span class="si">{}</span><span class="s1"> column_=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">tablename</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">valid_columns</span><span class="p">,</span> <span class="n">column_</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">column_</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">_sanitize_sql_helper</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">columns</span></div>


<div class="viewcode-block" id="dev_test_new_schema_version"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.dev_test_new_schema_version">[docs]</a><span class="k">def</span> <span class="nf">dev_test_new_schema_version</span><span class="p">(</span>
    <span class="n">dbname</span><span class="p">,</span> <span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="p">,</span> <span class="n">version_current</span><span class="p">,</span> <span class="n">version_next</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HACK</span>

<span class="sd">    hacky function to ensure that only developer sees the development schema</span>
<span class="sd">    and only on test databases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TESTING_NEW_SQL_VERSION</span> <span class="o">=</span> <span class="n">version_current</span> <span class="o">!=</span> <span class="n">version_next</span>
    <span class="k">if</span> <span class="n">TESTING_NEW_SQL_VERSION</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] ATTEMPTING TO TEST NEW SQLDB VERSION&#39;</span><span class="p">)</span>
        <span class="n">devdb_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;PZ_MTEST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;testdb1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;testdb2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;testdb_dst2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;emptydatabase&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">testing_newschmea</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">devdb_list</span>
        <span class="c1"># testing_newschmea = False</span>
        <span class="c1"># ut.is_developer() and ibs.get_dbname() in [&#39;PZ_MTEST&#39;, &#39;testdb1&#39;]</span>
        <span class="k">if</span> <span class="n">testing_newschmea</span><span class="p">:</span>
            <span class="c1"># Set to true until the schema module is good then continue tests</span>
            <span class="c1"># with this set to false</span>
            <span class="n">testing_force_fresh</span> <span class="o">=</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--force-fresh&#39;</span><span class="p">)</span>
            <span class="c1"># Work on a fresh schema copy when developing</span>
            <span class="n">dev_sqldb_fname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">augpath</span><span class="p">(</span><span class="n">sqldb_fname</span><span class="p">,</span> <span class="s1">&#39;_develop_schema&#39;</span><span class="p">)</span>
            <span class="n">sqldb_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="p">)</span>
            <span class="n">dev_sqldb_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">sqldb_dpath</span><span class="p">,</span> <span class="n">dev_sqldb_fname</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sqldb_fpath</span><span class="p">,</span> <span class="n">dev_sqldb_fpath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">testing_force_fresh</span><span class="p">)</span>
            <span class="c1"># Set testing schema version</span>
            <span class="c1"># ibs.db_version_expected = &#39;1.3.6&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] TESTING NEW SQLDB VERSION: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version_next</span><span class="p">,))</span>
            <span class="c1"># logger.info(&#39;[sql] ... pass --force-fresh to reload any changes&#39;)</span>
            <span class="k">return</span> <span class="n">version_next</span><span class="p">,</span> <span class="n">dev_sqldb_fname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[ibs] NOT TESTING&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">version_current</span><span class="p">,</span> <span class="n">sqldb_fname</span></div>


<div class="viewcode-block" id="SQLDatabaseController"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SQLDatabaseController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface to an SQL database</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SQLDatabaseController.Metadata"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.Metadata">[docs]</a>    <span class="k">class</span> <span class="nc">Metadata</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata is an attribute of the ``SQLDatabaseController`` that</span>
<span class="sd">        facilitates easy usages by internal and exteral users.</span>
<span class="sd">        Each metadata attributes represents a table (i.e. an instance of ``TableMetadata``).</span>
<span class="sd">        Each ``TableMetadata`` instance has metadata names as attributes.</span>
<span class="sd">        The ``TableMetadata`` can also be adapated to a dictionary for compatability.</span>

<span class="sd">        The the ``database`` attribute is a special case that results</span>
<span class="sd">        in a ``DatabaseMetadata`` instance rather than ``TableMetadata``.</span>
<span class="sd">        This primarily give access to the version and initial UUID,</span>
<span class="sd">        respectively as ``database.version`` and ``database.init_uuid``.</span>

<span class="sd">        Args:</span>
<span class="sd">            ctrlr (SQLDatabaseController): parent controller object</span>

<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SQLDatabaseController.Metadata.DatabaseMetadata"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.Metadata.DatabaseMetadata">[docs]</a>        <span class="k">class</span> <span class="nc">DatabaseMetadata</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Special metadata for database information&quot;&quot;&quot;</span>

            <span class="n">__fields</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;version&#39;</span><span class="p">,</span>
                <span class="s1">&#39;init_uuid&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrlr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span> <span class="o">=</span> <span class="n">ctrlr</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT metadata_value FROM </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> WHERE metadata_key = ?&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;database_version&#39;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># No result</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="nd">@version</span><span class="o">.</span><span class="n">setter</span>
            <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;INSERT OR REPLACE INTO </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> (metadata_key, metadata_value) VALUES (?, ?)&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;database_version&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,),</span>
                <span class="p">)</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">init_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT metadata_value FROM </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> WHERE metadata_key = ?&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;database_init_uuid&#39;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># No result</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="nd">@init_uuid</span><span class="o">.</span><span class="n">setter</span>
            <span class="k">def</span> <span class="nf">init_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;INSERT OR REPLACE INTO </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> (metadata_key, metadata_value) VALUES (?, ?)&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;database_init_uuid&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,),</span>
                <span class="p">)</span>

            <span class="c1"># collections.abc.MutableMapping abstract methods</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; cannot be deleted&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">name</span>

            <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.Metadata.TableMetadata"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.Metadata.TableMetadata">[docs]</a>        <span class="k">class</span> <span class="nc">TableMetadata</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Metadata on a particular SQL table&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrlr</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;ctrlr&#39;</span><span class="p">,</span> <span class="n">ctrlr</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;table_name&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_get_key_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Because keys are `&lt;table-name&gt;_&lt;name&gt;`&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>

<div class="viewcode-block" id="SQLDatabaseController.Metadata.TableMetadata.update"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.Metadata.TableMetadata.update">[docs]</a>            <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Update or insert the value into the metadata table with the given keyword arguments of metadata field names&quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">:</span>
                        <span class="c1"># ignore unknown keywords</span>
                        <span class="k">continue</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

            <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="c1"># Query the database for the value represented as name</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
                <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;SELECT metadata_value &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;FROM </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;WHERE metadata_key = ?&#39;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="c1"># No value for the requested metadata_key</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">METADATA_TABLE_COLUMNS</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;is_coded_data&#39;</span><span class="p">]:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">value</span>

            <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">METADATA_TABLE_COLUMNS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># This prevents setting of any attributes outside of the known names</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span>

                <span class="c1"># Delete the record if given None</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;is_coded_data&#39;</span><span class="p">]:</span>
                    <span class="c1"># Treat the data as code.</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_key_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># Insert or update the record</span>
                <span class="c1"># FIXME postgresql (4-Aug-12020) &#39;insert or replace&#39; is not valid for postgresql</span>
                <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;INSERT OR REPLACE INTO </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;(metadata_key, metadata_value) VALUES (?, ?)&#39;</span>
                <span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">:</span>
                    <span class="c1"># This prevents deleting of any attributes outside of the known names</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span>

                <span class="c1"># Insert or update the record</span>
                <span class="n">statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;DELETE FROM </span><span class="si">{</span><span class="n">METADATA_TABLE_NAME</span><span class="si">}</span><span class="s1"> where metadata_key = ?&#39;</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_key_name</span><span class="p">(</span><span class="n">name</span><span class="p">),)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span>

            <span class="c1"># collections.abc.MutableMapping abstract methods</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">name</span>

            <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">)</span></div>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrlr</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;ctrlr&#39;</span><span class="p">,</span> <span class="n">ctrlr</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1"># If the table exists pass back a ``TableMetadata`` instance</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DatabaseMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;not a valid tablename: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TableMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="c1"># This is inaccessible since any changes</span>
            <span class="c1"># to a TableMetadata instance would make on-demand mutations.</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1"># no-op</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># List all available tables, plus &#39;database&#39;</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="c1"># collections.abc.Mapping abstract methods</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">name</span>
            <span class="k">yield</span> <span class="s1">&#39;database&#39;</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctrlr</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># for &#39;database&#39;</span></div>

<div class="viewcode-block" id="SQLDatabaseController.from_uri"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.from_uri">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a controller instance from a connection URI</span>

<span class="sd">        Args:</span>
<span class="sd">            uri (str): connection string or uri</span>
<span class="sd">            timeout (int): connection timeout in seconds</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; sqldb_dpath = ut.ensure_app_resource_dir(&#39;dtool&#39;)</span>
<span class="sd">            &gt;&gt;&gt; sqldb_fname = u&#39;test_database.sqlite3&#39;</span>
<span class="sd">            &gt;&gt;&gt; path = os.path.join(sqldb_dpath, sqldb_fname)</span>
<span class="sd">            &gt;&gt;&gt; db_uri = &#39;file://{}&#39;.format(os.path.realpath(path))</span>
<span class="sd">            &gt;&gt;&gt; db = SQLDatabaseController.from_uri(db_uri)</span>
<span class="sd">            &gt;&gt;&gt; db.print_schema()</span>
<span class="sd">            &gt;&gt;&gt; print(db)</span>
<span class="sd">            &gt;&gt;&gt; db2 = SQLDatabaseController.from_uri(db_uri, readonly=True)</span>
<span class="sd">            &gt;&gt;&gt; db.add_table(&#39;temptable&#39;, (</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;rowid&#39;,               &#39;INTEGER PRIMARY KEY&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;key&#39;,                 &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;val&#39;,                 &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt; ),</span>
<span class="sd">            &gt;&gt;&gt;     superkeys=[(&#39;key&#39;,)])</span>
<span class="sd">            &gt;&gt;&gt; db2.print_schema()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="n">readonly</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># FIXME (31-Jul-12020) rename to private attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># FIXME (31-Jul-12020) rename to private attribute, no direct access to the connection</span>
        <span class="c1"># Initialize a cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="c1"># Ensure the metadata table is initialized.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_metadata_table</span><span class="p">()</span>

        <span class="c1"># TODO (31-Jul-12020) Move to Operations code.</span>
        <span class="c1">#      Optimization is going to depends on the operational deployment of this codebase.</span>
        <span class="c1"># Optimize the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="SQLDatabaseController.connect"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a connection for the instance or use the existing connection&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">lite</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a connection or reuse the existing connection&quot;&quot;&quot;</span>
        <span class="c1"># TODO (31-Jul-12020) Grab the correct connection for the thread.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_create_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] Initializing new database: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Cannot open a new database in readonly mode&#39;</span><span class="p">)</span>
        <span class="c1"># Open the SQL database connection with support for custom types</span>
        <span class="c1"># lite.enable_callback_tracebacks(True)</span>
        <span class="c1"># self.fpath = &#39;:memory:&#39;</span>

        <span class="c1"># References:</span>
        <span class="c1"># http://stackoverflow.com/questions/10205744/opening-sqlite3-database-from-python-in-read-only-mode</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">+=</span> <span class="s1">&#39;?mode=ro&#39;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">uri</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">lite</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="p">)</span>

        <span class="c1"># Keep track of what thead this was started in</span>
        <span class="n">threadid</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_connections</span><span class="p">[</span><span class="n">threadid</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span>

        <span class="k">return</span> <span class="n">connection</span><span class="p">,</span> <span class="n">uri</span>

<div class="viewcode-block" id="SQLDatabaseController.close"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_connections</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="c1"># def reconnect(db):</span>
    <span class="c1">#     # Call this if we move into a new thread</span>
    <span class="c1">#     assert db.fname != &#39;:memory:&#39;, &#39;cant reconnect to mem&#39;</span>
    <span class="c1">#     connection, uri = db._create_connection()</span>
    <span class="c1">#     db.connection = connection</span>
    <span class="c1">#     db.cur = db.connection.cursor()</span>

<div class="viewcode-block" id="SQLDatabaseController.thread_connection"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.thread_connection">[docs]</a>    <span class="k">def</span> <span class="nf">thread_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">threadid</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">threadid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_connections</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_connections</span><span class="p">[</span><span class="n">threadid</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connection</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connection</span></div>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_ensure_metadata_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the metadata table if it does not exist</span>

<span class="sd">        We need this to be done every time so that the update code works</span>
<span class="sd">        correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orig_table_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">METADATA_TABLE_NAME</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
            <span class="n">orig_table_kw</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">meta_table_kw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;tablename&#39;</span><span class="p">,</span> <span class="n">METADATA_TABLE_NAME</span><span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;coldef_list&#39;</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;metadata_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;docstr&#39;</span><span class="p">,</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                  The table that stores permanently all of the metadata about the</span>
<span class="sd">                  database (tables, etc)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;superkeys&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,)]),</span>
                <span class="p">(</span><span class="s1">&#39;dependson&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">meta_table_kw</span> <span class="o">!=</span> <span class="n">orig_table_kw</span><span class="p">:</span>
            <span class="c1"># Don&#39;t execute a write operation if we don&#39;t have to</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="o">**</span><span class="n">meta_table_kw</span><span class="p">)</span>
        <span class="c1"># METADATA_TABLE_NAME,</span>
        <span class="c1">#    superkeys=[(&#39;metadata_key&#39;,)],</span>
        <span class="c1"># IMPORTANT: Yes, we want this line to be tabbed over for the</span>
        <span class="c1"># schema auto-generation</span>
        <span class="c1"># Ensure that a version number exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">(</span><span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Ensure that an init UUID exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_db_init_uuid</span><span class="p">(</span><span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="SQLDatabaseController.get_db_version"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">version</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ensure</span><span class="p">:</span>
            <span class="n">BASE_DATABASE_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">BASE_DATABASE_VERSION</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_value&#39;</span><span class="p">]</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;database_version&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
            <span class="c1"># We don&#39;t care to find any, because we know there is no version</span>

            <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span>
                <span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_db_init_uuid"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_db_init_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_init_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the database initialization (creation) UUID</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control get_db_init_uuid</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import uuid</span>
<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; # Check random database gets new UUID on init</span>
<span class="sd">            &gt;&gt;&gt; db = SQLDatabaseController.from_uri(&#39;:memory:&#39;)</span>
<span class="sd">            &gt;&gt;&gt; uuid_ = db.get_db_init_uuid()</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;New Database: %r is valid&#39; % (uuid_, ))</span>
<span class="sd">            &gt;&gt;&gt; assert isinstance(uuid_, uuid.UUID)</span>
<span class="sd">            &gt;&gt;&gt; # Check existing database keeps UUID</span>
<span class="sd">            &gt;&gt;&gt; sqldb_dpath = ut.ensure_app_resource_dir(&#39;dtool&#39;)</span>
<span class="sd">            &gt;&gt;&gt; sqldb_fname = u&#39;test_database.sqlite3&#39;</span>
<span class="sd">            &gt;&gt;&gt; path = os.path.join(sqldb_dpath, sqldb_fname)</span>
<span class="sd">            &gt;&gt;&gt; db_uri = &#39;file://{}&#39;.format(os.path.realpath(path))</span>
<span class="sd">            &gt;&gt;&gt; db1 = SQLDatabaseController.from_uri(db_uri)</span>
<span class="sd">            &gt;&gt;&gt; uuid_1 = db1.get_db_init_uuid()</span>
<span class="sd">            &gt;&gt;&gt; db2 = SQLDatabaseController.from_uri(db_uri)</span>
<span class="sd">            &gt;&gt;&gt; uuid_2 = db2.get_db_init_uuid()</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;Existing Database: %r == %r&#39; % (uuid_1, uuid_2, ))</span>
<span class="sd">            &gt;&gt;&gt; assert uuid_1 == uuid_2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_init_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">init_uuid</span>
        <span class="k">if</span> <span class="n">db_init_uuid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ensure</span><span class="p">:</span>
            <span class="n">db_init_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">init_uuid</span> <span class="o">=</span> <span class="n">db_init_uuid</span>
        <span class="k">return</span> <span class="n">db_init_uuid</span></div>

<div class="viewcode-block" id="SQLDatabaseController.reboot"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] reboot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">lite</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLDatabaseController.backup"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        backup_filepath = dst_fpath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a brand new conenction to lock out current thread and any others</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_connection</span><span class="p">()</span>
        <span class="c1"># Start Exclusive transaction, lock out all other writers from making database changes</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="s1">&#39;EXCLUSIVE&#39;</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;BEGIN EXCLUSIVE&#39;</span><span class="p">)</span>
        <span class="c1"># Assert the database file exists, and copy to backup path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">backup_filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s1">&#39;Could not backup the database as the URI does not exist: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="c1"># Commit the transaction, releasing the lock</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># Close the connection</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLDatabaseController.optimize"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html#pragma-cache_size</span>
        <span class="c1"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] running sql pragma optimizions&#39;</span><span class="p">)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA cache_size = 0;&#39;)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA cache_size = 1024;&#39;)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA page_size = 1024;&#39;)</span>
        <span class="c1"># logger.info(&#39;[sql] running sql pragma optimizions&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA cache_size = 10000;&#39;</span><span class="p">)</span>  <span class="c1"># Default: 2000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA temp_store = MEMORY;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA synchronous = OFF;&#39;</span><span class="p">)</span></div>
        <span class="c1"># self.cur.execute(&#39;PRAGMA synchronous = NORMAL;&#39;)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA synchronous = FULL;&#39;)  # Default</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA parser_trace = OFF;&#39;)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA busy_timeout = 1;&#39;)</span>
        <span class="c1"># self.cur.execute(&#39;PRAGMA default_cache_size = 0;&#39;)</span>

<div class="viewcode-block" id="SQLDatabaseController.shrink_memory"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.shrink_memory">[docs]</a>    <span class="k">def</span> <span class="nf">shrink_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] shrink_memory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA shrink_memory;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLDatabaseController.vacuum"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.vacuum">[docs]</a>    <span class="k">def</span> <span class="nf">vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] vaccum&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;VACUUM;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLDatabaseController.integrity"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.integrity">[docs]</a>    <span class="k">def</span> <span class="nf">integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] vaccum&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA integrity_check;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLDatabaseController.squeeze"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.squeeze">[docs]</a>    <span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] squeeze&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shrink_memory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span></div>

    <span class="c1"># ==============</span>
    <span class="c1"># API INTERFACE</span>
    <span class="c1"># ==============</span>

<div class="viewcode-block" id="SQLDatabaseController.get_row_count"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_row_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">):</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*) FROM </span><span class="si">{tblname}</span><span class="s1">&#39;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_all_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;SELECT rowid FROM </span><span class="si">{tblname}</span><span class="s1"> ORDER BY rowid ASC&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_all_col_rows"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_all_col_rows">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_col_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{colname}</span><span class="s1"> FROM </span><span class="si">{tblname}</span><span class="s1"> ORDER BY rowid ASC&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids_where"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_all_rowids_where">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns a list of rowids from a table in ascending order satisfying a</span>
<span class="sd">        condition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;where_clause&#39;</span><span class="p">:</span> <span class="n">where_clause</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT rowid</span>
<span class="s2">        FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">        WHERE </span><span class="si">{where_clause}</span><span class="s2"></span>
<span class="s2">        ORDER BY rowid ASC</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.check_rowid_exists"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.check_rowid_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_rowid_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">rowid_iter</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rowid_list1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rowid&#39;</span><span class="p">,),</span> <span class="n">rowid_iter</span><span class="p">)</span>
        <span class="n">exists_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">exists_list</span></div>

    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ADDER NOTE: use add_cleanly &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;erotemes&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)),</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{tblname}</span><span class="s2">(</span>
<span class="s2">        rowid,</span>
<span class="s2">        </span><span class="si">{params}</span><span class="s2"></span>
<span class="s2">        ) VALUES (NULL, </span><span class="si">{erotemes}</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
            <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

<div class="viewcode-block" id="SQLDatabaseController.add_cleanly"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.add_cleanly">[docs]</a>    <span class="k">def</span> <span class="nf">add_cleanly</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">get_rowid_from_superkey</span><span class="p">,</span>
        <span class="n">superkey_paramx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ADDER Extra input:</span>
<span class="sd">        the first item of params_iter must be a superkey (like a uuid),</span>

<span class="sd">        Does not add None values. Does not add duplicate values.</span>
<span class="sd">        For each None input returns None ouptut.</span>
<span class="sd">        For each duplicate input returns existing rowid</span>

<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to add into</span>

<span class="sd">            colnames (tuple of strs): columns whos values are specified in params_iter</span>

<span class="sd">            params_iter (iterable): an iterable of tuples where each tuple corresonds to a row</span>

<span class="sd">            get_rowid_from_superkey (func): function that tests if a row needs</span>
<span class="sd">                to be added. It should return None for any new rows to be inserted.</span>
<span class="sd">                It should return the existing rowid if one exists</span>

<span class="sd">            superkey_paramx (tuple of ints): indices of tuples in params_iter which</span>
<span class="sd">                correspond to superkeys. defaults to (0,)</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterable: rowid_list_ -- list of newly added or previously added rowids</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = SQLDatabaseController.from_uri(&#39;:memory:&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db.add_table(&#39;dummy_table&#39;, (</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;rowid&#39;,               &#39;INTEGER PRIMARY KEY&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;key&#39;,                 &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;superkey1&#39;,           &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;superkey2&#39;,           &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;val&#39;,                 &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt; ),</span>
<span class="sd">            &gt;&gt;&gt;     superkeys=[(&#39;key&#39;,), (&#39;superkey1&#39;, &#39;superkey2&#39;)],</span>
<span class="sd">            &gt;&gt;&gt;     docstr=&#39;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db.print_schema()</span>
<span class="sd">            &gt;&gt;&gt; tblname = &#39;dummy_table&#39;</span>
<span class="sd">            &gt;&gt;&gt; colnames = (&#39;key&#39;, &#39;val&#39;)</span>
<span class="sd">            &gt;&gt;&gt; params_iter = [(&#39;spam&#39;, &#39;eggs&#39;), (&#39;foo&#39;, &#39;bar&#39;)]</span>
<span class="sd">            &gt;&gt;&gt; # Find a useable superkey</span>
<span class="sd">            &gt;&gt;&gt; superkey_colnames = db.get_table_superkey_colnames(tblname)</span>
<span class="sd">            &gt;&gt;&gt; superkey_paramx = None</span>
<span class="sd">            &gt;&gt;&gt; for superkey in superkey_colnames:</span>
<span class="sd">            &gt;&gt;&gt;    if all(k in colnames for k in superkey):</span>
<span class="sd">            &gt;&gt;&gt;        superkey_paramx = [colnames.index(k) for k in superkey]</span>
<span class="sd">            &gt;&gt;&gt;        superkey_colnames = ut.take(colnames, superkey_paramx)</span>
<span class="sd">            &gt;&gt;&gt;        break</span>
<span class="sd">            &gt;&gt;&gt; def get_rowid_from_superkey(superkeys_list):</span>
<span class="sd">            &gt;&gt;&gt;     return db.get_where_eq(tblname, (&#39;rowid&#39;,), zip(superkeys_list), superkey_colnames)</span>
<span class="sd">            &gt;&gt;&gt; rowid_list_ = db.add_cleanly(</span>
<span class="sd">            &gt;&gt;&gt;     tblname, colnames, params_iter, get_rowid_from_superkey, superkey_paramx)</span>
<span class="sd">            &gt;&gt;&gt; print(rowid_list_)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ADD_CLEANLY_1: PREPROCESS INPUT</span>
        <span class="c1"># eagerly evaluate for superkeys</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="c1"># Extract superkeys from the params list (requires eager eval)</span>
        <span class="n">superkey_lists</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">superkey_paramx</span>
        <span class="p">]</span>
        <span class="c1"># ADD_CLEANLY_2: PREFORM INPUT CHECKS</span>
        <span class="c1"># check which parameters are valid</span>
        <span class="c1"># and not any(ut.flag_None_items(params))</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
        <span class="c1"># Check for duplicate inputs</span>
        <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)))</span>
        <span class="c1"># Check to see if this already exists in the database</span>
        <span class="c1"># superkey_params_iter = list(zip(*superkey_lists))</span>
        <span class="c1"># get_rowid_from_superkey functions take each list separately here</span>
        <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>
        <span class="n">isnew_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list_</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">isunique_list</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[WARNING]: duplicate inputs to db.add_cleanly&#39;</span><span class="p">)</span>
        <span class="c1"># Flag each item that needs to added to the database</span>
        <span class="n">needsadd_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">,</span> <span class="n">isnew_list</span><span class="p">)))</span>
        <span class="c1"># ADD_CLEANLY_3.1: EXIT IF CLEAN</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">needsadd_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rowid_list_</span>  <span class="c1"># There is nothing to add. Return the rowids</span>
        <span class="c1"># ADD_CLEANLY_3.2: PERFORM DIRTY ADDITIONS</span>
        <span class="n">dirty_params</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">params_list</span><span class="p">,</span> <span class="n">needsadd_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[sql] adding </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> new </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_params</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="n">tblname</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Add any unadded parameters to the database</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">)</span>  <span class="c1"># NOQA</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="n">key_list</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">&#39;dirty_params&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;needsadd_list&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;superkey_lists&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nInput&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rowid_list_&#39;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="c1"># TODO: We should only have to preform a subset of adds here</span>
        <span class="c1"># (at the positions where rowid_list was None in the getter check)</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>

        <span class="c1"># ADD_CLEANLY_4: SANITY CHECK AND RETURN</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="s1">&#39;failed sanity check&#39;</span>
        <span class="k">return</span> <span class="n">rowid_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.rows_exist"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.rows_exist">[docs]</a>    <span class="k">def</span> <span class="nf">rows_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">rowids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if rowids exist. Yields True if they do</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;SELECT count(1) FROM </span><span class="si">{tblname}</span><span class="s1"> WHERE rowid=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tblname</span><span class="o">=</span><span class="n">tblname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowids</span><span class="p">:</span>
            <span class="k">yield</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_where_eq"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_where_eq">[docs]</a>    <span class="k">def</span> <span class="nf">get_where_eq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">where_colnames</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">op</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; hacked in function for nicer templates</span>

<span class="sd">        unpack_scalars = True</span>
<span class="sd">        kwargs = {}</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            verbose:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">andwhere_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">where_colnames</span><span class="p">]</span>
        <span class="n">logicop_</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">op</span><span class="p">,)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">logicop_</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">andwhere_clauses</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span>
            <span class="n">tblname</span><span class="p">,</span>
            <span class="n">colnames</span><span class="p">,</span>
            <span class="n">params_iter</span><span class="p">,</span>
            <span class="n">where_clause</span><span class="p">,</span>
            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_where_eq_set"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_where_eq_set">[docs]</a>    <span class="k">def</span> <span class="nf">get_where_eq_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">where_colnames</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">op</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">params_iter_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="n">params_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">tblname</span><span class="p">,</span>
                <span class="n">params_length</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using sql_control.get_where_eq_set() for </span><span class="si">%r</span><span class="s1"> on </span><span class="si">%d</span><span class="s1"> params&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">params_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_colnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">where_colname</span> <span class="o">=</span> <span class="n">where_colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">where_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">params_iter_</span><span class="p">)))</span>

        <span class="n">where_set_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">where_value</span><span class="p">,)</span> <span class="k">for</span> <span class="n">where_value</span> <span class="ow">in</span> <span class="n">where_set</span><span class="p">]</span>

        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT </span><span class="si">{colnames}</span><span class="s2"></span>
<span class="s2">        FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">        WHERE </span><span class="si">{where_colname}</span><span class="s2"> IN ( </span><span class="si">{where_set}</span><span class="s2"> )</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;colnames&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
            <span class="s1">&#39;where_colname&#39;</span><span class="p">:</span> <span class="n">where_colname</span><span class="p">,</span>
            <span class="s1">&#39;where_set&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_set_str</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_where"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_where">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_where</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">where_clause</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s1">&#39;colnames must be a tuple&#39;</span>

        <span class="k">if</span> <span class="n">where_clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{colnames}</span><span class="s2"></span>
<span class="s2">            FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                <span class="s1">&#39;colnames&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{colnames}</span><span class="s2"></span>
<span class="s2">            FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">            WHERE </span><span class="si">{where_clauses}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                <span class="s1">&#39;colnames&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
                <span class="s1">&#39;where_clauses&#39;</span><span class="p">:</span> <span class="n">where_clause</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
                <span class="n">operation_fmt</span><span class="p">,</span>
                <span class="n">fmtdict</span><span class="p">,</span>
                <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
                <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">val_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.exists_where_eq"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.exists_where_eq">[docs]</a>    <span class="k">def</span> <span class="nf">exists_where_eq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">where_colnames</span><span class="p">,</span>
        <span class="n">op</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; hacked in function for nicer templates &quot;&quot;&quot;</span>
        <span class="n">andwhere_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">where_colnames</span><span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">op</span><span class="p">,))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">andwhere_clauses</span><span class="p">)</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;where_clauses&#39;</span><span class="p">:</span> <span class="n">where_clause</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT EXISTS(</span>
<span class="sd">            SELECT 1</span>
<span class="sd">            FROM {tblname}</span>
<span class="sd">            WHERE {where_clauses}</span>
<span class="sd">            LIMIT 1)</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
            <span class="n">operation_fmt</span><span class="p">,</span>
            <span class="n">fmtdict</span><span class="p">,</span>
            <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">val_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_rowid_from_superkey"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_rowid_from_superkey">[docs]</a>    <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">superkey_colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter which uses the constrained superkeys instead of rowids &quot;&quot;&quot;</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">superkey_colnames</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rowid&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">id_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter</span>

<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to get from</span>
<span class="sd">            colnames (tuple of str): column names to grab from</span>
<span class="sd">            id_iter (iterable): iterable of search keys</span>
<span class="sd">            id_colname (str): column to be used as the search key (default: rowid)</span>
<span class="sd">            eager (bool): use eager evaluation</span>
<span class="sd">            unpack_scalars (bool): default True</span>
<span class="sd">            id_colname (bool): default False. Experimental feature that could result in a 10x speedup</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control get</span>

<span class="sd">        Ignore:</span>
<span class="sd">            tblname = &#39;annotations&#39;</span>
<span class="sd">            colnames = (&#39;name_rowid&#39;,)</span>
<span class="sd">            id_iter = aid_list</span>
<span class="sd">            #id_iter = id_iter[0:20]</span>
<span class="sd">            id_colname = &#39;rowid&#39;</span>
<span class="sd">            eager = True</span>
<span class="sd">            db = ibs.db</span>

<span class="sd">            x1 = db.get(tblname, colnames, id_iter, assume_unique=True)</span>
<span class="sd">            x2 = db.get(tblname, colnames, id_iter, assume_unique=False)</span>
<span class="sd">            x1 == x2</span>
<span class="sd">            %timeit  db.get(tblname, colnames, id_iter, assume_unique=True)</span>
<span class="sd">            %timeit  db.get(tblname, colnames, id_iter, assume_unique=False)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;notch&#39;, [1, 2, 3])</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;notch&#39;]</span>
<span class="sd">            &gt;&gt;&gt; db = table.db</span>
<span class="sd">            &gt;&gt;&gt; table.print_csv()</span>
<span class="sd">            &gt;&gt;&gt; # Break things to test set</span>
<span class="sd">            &gt;&gt;&gt; colnames = (&#39;dummy_annot_rowid&#39;,)</span>
<span class="sd">            &gt;&gt;&gt; got_data = db.get(&#39;notch&#39;, colnames, id_iter=rowids)</span>
<span class="sd">            &gt;&gt;&gt; assert got_data == [1, 2, 3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[sql]&#39;</span>
                <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
                <span class="o">+</span> <span class="s1">&#39; db.get(</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">, ...)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s1">&#39;must specify column names TUPLE to get from&#39;</span>
        <span class="c1"># if isinstance(colnames, six.string_types):</span>
        <span class="c1">#    colnames = (colnames,)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">assume_unique</span>
            <span class="ow">and</span> <span class="n">id_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">id_colname</span> <span class="o">==</span> <span class="s1">&#39;rowid&#39;</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">id_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_iter</span><span class="p">)</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT </span><span class="si">{colnames}</span><span class="s2"></span>
<span class="s2">                FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">                WHERE rowid in (</span><span class="si">{id_repr}</span><span class="s2">)</span>
<span class="s2">                ORDER BY rowid ASC</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                <span class="s1">&#39;colnames&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
                <span class="s1">&#39;id_repr&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

            <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">id_iter</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unpack_scalars&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">id_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_iter</span><span class="p">]</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span>
                <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.set"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tblname</span><span class="p">,</span>
        <span class="n">colnames</span><span class="p">,</span>
        <span class="n">val_iter</span><span class="p">,</span>
        <span class="n">id_iter</span><span class="p">,</span>
        <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="n">duplicate_behavior</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="n">duplcate_auto_resolve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setter</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control set</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;notch&#39;, [1, 2, 3])</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;notch&#39;]</span>
<span class="sd">            &gt;&gt;&gt; db = table.db</span>
<span class="sd">            &gt;&gt;&gt; table.print_csv()</span>
<span class="sd">            &gt;&gt;&gt; # Break things to test set</span>
<span class="sd">            &gt;&gt;&gt; colnames = (&#39;dummy_annot_rowid&#39;,)</span>
<span class="sd">            &gt;&gt;&gt; val_iter = [9003, 9001, 9002]</span>
<span class="sd">            &gt;&gt;&gt; orig_data = db.get(&#39;notch&#39;, colnames, id_iter=rowids)</span>
<span class="sd">            &gt;&gt;&gt; db.set(&#39;notch&#39;, colnames, val_iter, id_iter=rowids)</span>
<span class="sd">            &gt;&gt;&gt; new_data = db.get(&#39;notch&#39;, colnames, id_iter=rowids)</span>
<span class="sd">            &gt;&gt;&gt; assert new_data == val_iter</span>
<span class="sd">            &gt;&gt;&gt; assert new_data != orig_data</span>
<span class="sd">            &gt;&gt;&gt; table.print_csv()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="c1"># if isinstance(colnames, six.string_types):</span>
        <span class="c1">#    colnames = (colnames,)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val_iter</span><span class="p">)</span>  <span class="c1"># eager evaluation</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_iter</span><span class="p">)</span>  <span class="c1"># eager evaluation</span>

        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">or</span> <span class="p">(</span><span class="n">NOT_QUIET</span> <span class="ow">and</span> <span class="n">VERYVERBOSE</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] SETTER: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] * tblname=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tblname</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] * val_list=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val_list</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] * id_list=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_list</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] * id_colname=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_colname</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">has_duplicates</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">duplicates_exist</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">duplcate_auto_resolve</span><span class="p">:</span>
                    <span class="c1"># Check if values being set are equivalent</span>
                    <span class="k">if</span> <span class="n">has_duplicates</span><span class="p">:</span>

                        <span class="n">debug_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
                        <span class="n">key_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">debug_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;has_duplicates sanity check failed&#39;</span>

                        <span class="n">pop_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
                            <span class="n">index_list</span> <span class="o">=</span> <span class="n">debug_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                            <span class="n">value_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">index_list</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                                <span class="n">value</span> <span class="o">==</span> <span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value_list</span>
                            <span class="p">),</span> <span class="s1">&#39;Passing a non-unique list of ids with different set values&#39;</span>
                            <span class="n">pop_list</span> <span class="o">+=</span> <span class="n">index_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pop_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">id_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">val_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;[!set] Auto Resolution: Removed </span><span class="si">%d</span><span class="s1"> duplicate (id, value) pairs from the database operation&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pop_list</span><span class="p">),)</span>
                        <span class="p">)</span>

                    <span class="n">has_duplicates</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">duplicates_exist</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>

                <span class="k">assert</span> <span class="ow">not</span> <span class="n">has_duplicates</span><span class="p">,</span> <span class="s1">&#39;Passing a not-unique list of ids&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>

                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                    <span class="n">ex</span><span class="p">,</span>
                    <span class="s1">&#39;len(id_list) = </span><span class="si">%r</span><span class="s1">, len(set(id_list)) = </span><span class="si">%r</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))),</span>
                <span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">print_traceback</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
            <span class="c1"># Keep only the first setting of every row</span>
            <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">)</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;unknown duplicate_behavior=</span><span class="si">%r</span><span class="s1">. &#39;</span>
                    <span class="s1">&#39;known behaviors are: error and filter&#39;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">duplicate_behavior</span><span class="p">,)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_list</span><span class="p">)</span>
            <span class="n">num_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">num_val</span> <span class="o">==</span> <span class="n">num_id</span><span class="p">,</span> <span class="s1">&#39;list inputs have different lengths&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_val&#39;</span><span class="p">,</span> <span class="s1">&#39;num_id&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname_str&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;assign_str&#39;</span><span class="p">:</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=?&#39;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">]),</span>
            <span class="s1">&#39;where_clause&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE </span><span class="si">{tblname_str}</span><span class="s2"></span>
<span class="s2">            SET </span><span class="si">{assign_str}</span><span class="s2"></span>
<span class="s2">            WHERE </span><span class="si">{where_clause}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="c1"># TODO: The flattenize can be removed if we pass in val_lists instead</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="n">flattenize</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">id_list</span><span class="p">)))</span>

        <span class="c1"># params_iter = list(zip(val_list, id_list))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
            <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.delete"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        deleter. USE delete_rowids instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;rowid_str&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s1">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DELETE</span>
<span class="s2">            FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">            WHERE </span><span class="si">{rowid_str}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
            <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.delete_rowids"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.delete_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rowids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; deletes the the rows in rowid_list &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s1">&#39;rowid_str&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;rowid=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DELETE</span>
<span class="s2">            FROM </span><span class="si">{tblname}</span><span class="s2"></span>
<span class="s2">            WHERE </span><span class="si">{rowid_str}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">rowid_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span>
            <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

    <span class="c1"># ==============</span>
    <span class="c1"># CORE WRAPPERS</span>
    <span class="c1"># ==============</span>

    <span class="k">def</span> <span class="nf">_executeone_operation_fmt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_executemany_operation_fmt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">operation_fmt</span><span class="p">,</span>
        <span class="n">fmtdict</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dry Run&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="n">operation</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="c1"># =========</span>
    <span class="c1"># SQLDB CORE</span>
    <span class="c1"># =========</span>

<div class="viewcode-block" id="SQLDatabaseController.executeone"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.executeone">[docs]</a>    <span class="k">def</span> <span class="nf">executeone</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(),</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">):</span>
        <span class="n">contextkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nInput</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">contextkw</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_iter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">),</span> <span class="s1">&#39;params&#39;</span><span class="p">])</span>
                <span class="c1"># ut.sys.exit(1)</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">result_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.executemany"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.executemany">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">operation</span><span class="p">,</span>
        <span class="n">params_iter</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">keepwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showprog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if unpack_scalars is True only a single result must be returned for each query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- ARGS PREPROC ---</span>
        <span class="c1"># Aggresively compute iterator if the nInput is not given</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_iter</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;[sql!] WARNING: aggressive eval of params_iter because nInput=None&#39;</span>
                    <span class="p">)</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
                <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] Taking params_iter as iterator&#39;</span><span class="p">)</span>

        <span class="c1"># Do not compute executemany without params</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[sql!] WARNING: dont use executemany&#39;</span>
                    <span class="s1">&#39;with no params use executeone instead.&#39;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># --- SQL EXECUTION ---</span>
        <span class="n">contextkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nInput&#39;</span><span class="p">:</span> <span class="n">nInput</span><span class="p">,</span>
            <span class="s1">&#39;start_transaction&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="s1">&#39;keepwrap&#39;</span><span class="p">:</span> <span class="n">keepwrap</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">contextkw</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eager</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">showprog</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">showprog</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                        <span class="n">lbl</span> <span class="o">=</span> <span class="n">showprog</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lbl</span> <span class="o">=</span> <span class="s1">&#39;sqlread&#39;</span>
                    <span class="n">prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span>
                        <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">params_iter</span> <span class="o">=</span> <span class="n">prog</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
                <span class="n">results_iter</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                    <span class="c1"># list of iterators</span>
                    <span class="n">_unpacker_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_unpacker</span><span class="p">)</span>
                    <span class="n">results_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_unpacker_</span><span class="p">,</span> <span class="n">results_iter</span><span class="p">))</span>
                <span class="c1"># Eager evaluation</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_iter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">_tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                    <span class="c1"># Temporary hack to turn off eager_evaluation</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span><span class="p">:</span>
                        <span class="c1"># Eval results per query yeild per iter</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">_unpacker</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">results</span>

                <span class="n">results_list</span> <span class="o">=</span> <span class="n">_tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_list</span></div>

    <span class="c1"># def commit(db):</span>
    <span class="c1">#    db.connection.commit()</span>

<div class="viewcode-block" id="SQLDatabaseController.print_dbg_schema"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.print_dbg_schema">[docs]</a>    <span class="k">def</span> <span class="nf">print_dbg_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">CREATE&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">schema_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;CREATE&#39;</span><span class="p">))</span>
        <span class="p">)</span></div>

    <span class="c1"># =========</span>
    <span class="c1"># SQLDB METADATA</span>
    <span class="c1"># =========</span>
<div class="viewcode-block" id="SQLDatabaseController.get_metadata_items"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_metadata_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: metadata_items</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --exec-get_metadata_items</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = testdata_depc()[&#39;notch&#39;].db</span>
<span class="sd">            &gt;&gt;&gt; metadata_items = db.get_metadata_items()</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;metadata_items = %s&#39; % (ut.repr2(sorted(metadata_items)),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata_rowids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">METADATA_TABLE_NAME</span><span class="p">)</span>
        <span class="n">metadata_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata_value&#39;</span><span class="p">),</span> <span class="n">metadata_rowids</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">metadata_items</span></div>

<div class="viewcode-block" id="SQLDatabaseController.set_metadata_val"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.set_metadata_val">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span><span class="s1">&#39;Use the metadata property instead&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_metadata_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        key must be given as a repr-ed string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">METADATA_TABLE_NAME</span><span class="p">,</span>
            <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="s1">&#39;metadata_key, metadata_value&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;INSERT OR REPLACE INTO </span><span class="si">{tablename}</span><span class="s1"> (</span><span class="si">{columns}</span><span class="s1">) VALUES (?, ?)&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_metadata_val"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_metadata_val">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span><span class="s1">&#39;Use metadata property instead&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_metadata_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eval_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        val is the repr string unless eval_ is true</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39;metadata_key=?&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,)</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;duplicate keys in metadata table&#39;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">NoParam</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;metadata_table key=</span><span class="si">%r</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
        <span class="c1"># if key.endswith(&#39;_constraint&#39;) or</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_docstr&#39;</span><span class="p">):</span>
            <span class="c1"># Hack eval off for constriant and docstr</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eval_</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># eventually we will not have to worry about</span>
                <span class="c1"># mid level representations by default, for now flag it</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">val</span></div>

    <span class="c1"># ==============</span>
    <span class="c1"># SCHEMA MODIFICATION</span>
    <span class="c1"># ==============</span>

<div class="viewcode-block" id="SQLDatabaseController.add_column"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[sql] add column=</span><span class="si">%r</span><span class="s1"> of type=</span><span class="si">%r</span><span class="s1"> to tablename=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
            <span class="s1">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span>
            <span class="s1">&#39;coltype&#39;</span><span class="p">:</span> <span class="n">coltype</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE </span><span class="si">{tablename}</span><span class="s1"> ADD COLUMN </span><span class="si">{colname}</span><span class="s1"> </span><span class="si">{coltype}</span><span class="s1">&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__make_superkey_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">superkeys</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates SQL for the &#39;superkey&#39; constraint.</span>
<span class="sd">        A &#39;superkey&#39; is one or more columns that make up a unique constraint on the table.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_superkeys</span> <span class="o">=</span> <span class="n">superkeys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">has_superkeys</span><span class="p">:</span>
            <span class="c1"># Create a superkey statement for each superkey item</span>
            <span class="c1"># superkeys = [(col), (col1, col2, ...), ...],</span>
            <span class="k">for</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">superkeys</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CONSTRAINT superkey UNIQUE (</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">constraints</span>

    <span class="k">def</span> <span class="nf">__make_column_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">definition</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates SQL for the given column `name` and type, default &amp; constraint (i.e. `definition`).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;name cannot be an empty string paired with </span><span class="si">{</span><span class="n">definition</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">definition</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;definition cannot be an empty string paired with </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">definition</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_make_add_table_sqlstr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Creates the SQL for a CREATE TABLE statement</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str): table name</span>
<span class="sd">            coldef_list (list): list of tuples (name, type definition)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: operation</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control _make_add_table_sqlstr</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; autogen_dict = db.get_table_autogen_dict(tablename)</span>
<span class="sd">            &gt;&gt;&gt; coldef_list = autogen_dict[&#39;coldef_list&#39;]</span>
<span class="sd">            &gt;&gt;&gt; operation = db._make_add_table_sqlstr(tablename, coldef_list)</span>
<span class="sd">            &gt;&gt;&gt; print(operation)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coldef_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;empty coldef_list specified for </span><span class="si">{</span><span class="n">tablename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Check for invalid keyword arguments</span>
        <span class="n">bad_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metadata_keyval</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got unexpected keyword arguments: </span><span class="si">{</span><span class="n">bad_kwargs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] schema ensuring tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">func_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">,</span> <span class="n">_args</span><span class="p">,</span> <span class="n">metadata_keyval</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Create the main body of the CREATE TABLE statement with column definitions</span>
        <span class="c1"># coldef_list = [(&lt;column-name&gt;, &lt;definition&gt;,), ...]</span>
        <span class="n">body_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__make_column_definition</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">coldef_list</span><span class="p">]</span>

        <span class="c1"># Make a list of constraints to place on the table</span>
        <span class="n">constraint_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_superkey_constraints</span><span class="p">(</span>
            <span class="n">metadata_keyval</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;superkeys&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
        <span class="n">constraint_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">(</span><span class="n">constraint_list</span><span class="p">)</span>

        <span class="n">comma</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">sep</span>
        <span class="n">table_body</span> <span class="o">=</span> <span class="n">comma</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body_list</span> <span class="o">+</span> <span class="n">constraint_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;CREATE TABLE IF NOT EXISTS </span><span class="si">{</span><span class="n">tablename</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">sep</span><span class="si">}{</span><span class="n">table_body</span><span class="si">}{</span><span class="n">sep</span><span class="si">}</span><span class="s1">)&#39;</span>

<div class="viewcode-block" id="SQLDatabaseController.add_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.add_table">[docs]</a>    <span class="k">def</span> <span class="nf">add_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coldef_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add_table</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            coldef_list (list):</span>
<span class="sd">            constraint (list or None):</span>
<span class="sd">            docstr (str):</span>
<span class="sd">            superkeys (list or None): list of tuples of column names which</span>
<span class="sd">                uniquely identifies a rowid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_add_table_sqlstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">metadata_keyval</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.modify_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.modify_table">[docs]</a>    <span class="k">def</span> <span class="nf">modify_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">colmap_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tablename_new</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">drop_columns</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">add_columns</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">rename_columns</span><span class="o">=</span><span class="p">[],</span>
        <span class="c1"># transform_columns=[],</span>
        <span class="c1"># constraint=None, docstr=None, superkeys=None,</span>
        <span class="o">**</span><span class="n">metadata_keyval</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to modify the schema - only columns that are being added,</span>
<span class="sd">        removed or changed need to be enumerated</span>

<span class="sd">        Args:</span>
<span class="sd">           tablename (str): tablename</span>
<span class="sd">           colmap_list (list): of tuples (orig_colname, new_colname, new_coltype, convert_func)</span>
<span class="sd">               orig_colname - the original name of the column, None to append, int for index</span>
<span class="sd">               new_colname - the new column name (&#39;&#39; for same, None to delete)</span>
<span class="sd">               new_coltype - New Column Type. None to use data unmodified</span>
<span class="sd">               convert_func - Function to convert data from old to new</span>
<span class="sd">           constraint (str):</span>
<span class="sd">           superkeys (list)</span>
<span class="sd">           docstr (str)</span>
<span class="sd">           tablename_new (?)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; def loc_zip_map(x):</span>
<span class="sd">            ...     return x</span>
<span class="sd">            &gt;&gt;&gt; db.modify_table(const.CONTRIBUTOR_TABLE, (</span>
<span class="sd">            &gt;&gt;&gt;         # orig_colname,             new_colname,      new_coltype, convert_func</span>
<span class="sd">            &gt;&gt;&gt;         # a non-needed, but correct mapping (identity function)</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_rowid&#39;,      &#39;&#39;,                    &#39;&#39;,               None),</span>
<span class="sd">            &gt;&gt;&gt;         # for new columns, function is ignored (TYPE CANNOT BE EMPTY IF ADDING)</span>
<span class="sd">            &gt;&gt;&gt;         (None,                 &#39;contrib_loc_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            &gt;&gt;&gt;         # adding a new column at index 4 (if index is invalid, None is used)</span>
<span class="sd">            &gt;&gt;&gt;         (4,                    &#39;contrib_loc_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            &gt;&gt;&gt;         # for deleted columns, type and function are ignored</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_city&#39;,    None,                 &#39;&#39;,               None),</span>
<span class="sd">            &gt;&gt;&gt;         # for renamed columns, type and function are ignored</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_city&#39;,   &#39;contrib_loc_town&#39;,    &#39;&#39;,       None),</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_zip&#39;,    &#39;contrib_loc_zip&#39;,     &#39;TEXT&#39;,   loc_zip_map),</span>
<span class="sd">            &gt;&gt;&gt;         # type not changing, only NOT NULL provision</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;contrib_loc_country&#39;, &#39;&#39;,                   &#39;TEXT NOT NULL&#39;,  None),</span>
<span class="sd">            &gt;&gt;&gt;     ),</span>
<span class="sd">            &gt;&gt;&gt;     superkeys=[(&#39;contributor_rowid&#39;,)],</span>
<span class="sd">            &gt;&gt;&gt;     constraint=[],</span>
<span class="sd">            &gt;&gt;&gt;     docstr=&#39;Used to store the contributors to the project&#39;</span>
<span class="sd">            &gt;&gt;&gt; )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assert colmap_list is not None, &#39;must specify colmaplist&#39;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;tablename must be given&#39;</span>

        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] schema modifying tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[sql] * colmap_list = &#39;</span> <span class="o">+</span> <span class="s1">&#39;None&#39;</span>
                <span class="k">if</span> <span class="n">colmap_list</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">colmap_list</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">colmap_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colmap_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Augment colmap_list using convience mappings</span>
        <span class="k">for</span> <span class="n">drop_col</span> <span class="ow">in</span> <span class="n">drop_columns</span><span class="p">:</span>
            <span class="n">colmap_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">drop_col</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">add_col</span><span class="p">,</span> <span class="n">add_type</span> <span class="ow">in</span> <span class="n">add_columns</span><span class="p">:</span>
            <span class="n">colmap_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_col</span><span class="p">,</span> <span class="n">add_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">old_col</span><span class="p">,</span> <span class="n">new_col</span> <span class="ow">in</span> <span class="n">rename_columns</span><span class="p">:</span>
            <span class="n">colmap_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">old_col</span><span class="p">,</span> <span class="n">new_col</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="n">coldef_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coldef_list</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">colname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">coldef_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">coltype_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">coldef_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">colname_original_list</span> <span class="o">=</span> <span class="n">colname_list</span><span class="p">[:]</span>
        <span class="n">colname_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span> <span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">}</span>
        <span class="n">colmap_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">insert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">colmap</span> <span class="ow">in</span> <span class="n">colmap_list</span><span class="p">:</span>
            <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">map_</span><span class="p">)</span> <span class="o">=</span> <span class="n">colmap</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># Add column</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">dst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">),</span> <span class="s1">&#39;New column name must be valid in colmap=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colmap</span><span class="p">,)</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">),</span> <span class="s1">&#39;New column type must be specified in colmap=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colmap</span><span class="p">,)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="p">):</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;[sql] WARNING: multiple index inserted add &#39;</span>
                            <span class="s1">&#39;columns, may cause alignment issues&#39;</span>
                        <span class="p">)</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
                    <span class="n">insert</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Modify column</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="n">src</span> <span class="ow">in</span> <span class="n">colname_list</span>
                    <span class="p">),</span> <span class="s1">&#39;Unkown source colname=</span><span class="si">%s</span><span class="s1"> in tablename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;colname_list&#39;</span><span class="p">])</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">colname_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Drop column</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">),</span> <span class="s1">&#39;Deleted column name  must be valid&#39;</span>
                    <span class="k">del</span> <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dst</span><span class="p">:</span>
                    <span class="c1"># Rename column</span>
                    <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                    <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                    <span class="c1"># Check if type should change as well</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="c1"># Change column type</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                <span class="k">elif</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Simply map function across table&#39;s data</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Identity, this can be ommited as it is automatically done</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_</span>

        <span class="n">coldef_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">colname_list</span><span class="p">,</span> <span class="n">coltype_list</span><span class="p">))</span>
        <span class="n">tablename_orig</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">tablename_temp</span> <span class="o">=</span> <span class="n">tablename_orig</span> <span class="o">+</span> <span class="s1">&#39;_temp&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_nonce</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">metadata_keyval2</span> <span class="o">=</span> <span class="n">metadata_keyval</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_keyval2</span> <span class="ow">or</span> <span class="n">metadata_keyval2</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename_orig</span><span class="p">],</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="n">metadata_keyval2</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata_keyval2</span><span class="p">)</span>

        <span class="c1"># Copy data</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dst_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_original_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">src_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colname_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">src_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Run functions across all data for specified callums</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src_</span><span class="p">](</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_</span> <span class="ow">in</span> <span class="n">colmap_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">d</span>
                    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">src_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">src_list</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list_</span>
        <span class="p">]</span>
        <span class="c1"># Add the data to the database</span>

        <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">dst_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tablename_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Drop original table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c1"># Rename temp table to original table name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Rename new table to new name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.rename_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.rename_table">[docs]</a>    <span class="k">def</span> <span class="nf">rename_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[sql] schema renaming tablename=</span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c1"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c1"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename_old&#39;</span><span class="p">:</span> <span class="n">tablename_old</span><span class="p">,</span>
            <span class="s1">&#39;tablename_new&#39;</span><span class="p">:</span> <span class="n">tablename_new</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;ALTER TABLE </span><span class="si">{tablename_old}</span><span class="s1"> RENAME TO </span><span class="si">{tablename_new}</span><span class="s1">&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Rename table&#39;s metadata</span>
        <span class="n">key_old_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename_old</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span>
        <span class="p">]</span>
        <span class="n">key_new_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename_new</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span>
        <span class="p">]</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_old_list</span><span class="p">]</span>
        <span class="n">val_iter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_new_list</span><span class="p">]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">,)</span>
        <span class="c1"># logger.info(&#39;Setting metadata_key from %s to %s&#39; % (ut.repr2(id_iter), ut.repr2(val_iter)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;metadata_key&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.drop_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] schema dropping tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c1"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c1"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s1">&#39;DROP TABLE IF EXISTS </span><span class="si">{tablename}</span><span class="s1">&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Delete table&#39;s metadata</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="n">key_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;metadata_key&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.drop_all_tables"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.drop_all_tables">[docs]</a>    <span class="k">def</span> <span class="nf">drop_all_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DELETES ALL INFO IN TABLE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="o">!=</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># ==============</span>
    <span class="c1"># CONVINENCE</span>
    <span class="c1"># ==============</span>

<div class="viewcode-block" id="SQLDatabaseController.dump_tables_to_csv"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.dump_tables_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">dump_tables_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dump_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Dumps all csv database files to disk &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dump_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="s1">&#39;CSV_DUMP&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="n">table_fname</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
            <span class="n">table_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">table_fname</span><span class="p">)</span>
            <span class="n">table_csv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">table_fpath</span><span class="p">,</span> <span class="n">table_csv</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_schema_current_autogeneration_str"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_schema_current_autogeneration_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_current_autogeneration_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autogen_cmd</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Autogenerates the most up-to-date database schema</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --exec-get_schema_current_autogeneration_str</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; result = db.get_schema_current_autogeneration_str(&#39;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_version_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">()</span>
        <span class="c1"># Define what tab space we want to save</span>
        <span class="n">tab1</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># autogen_cmd = &#39;python -m dtool.DB_SCHEMA --test-test_dbschema</span>
        <span class="c1"># --force-incremental-db-update --dump-autogen-schema&#39;</span>
        <span class="c1"># File Header</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;AUTOGENERATED ON &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s1">&#39;printable&#39;</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;AutogenCommandLine:&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: Fix autogen command</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">autogen_cmd</span><span class="p">,</span> <span class="n">tab1</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# -*- coding: utf-8 -*-&#39;</span><span class="p">)</span>
        <span class="c1"># line_list.append(&#39;from wbia import constants as const&#39;)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Schema Version Current&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;VERSION_CURRENT = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">db_version_current</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;def update_current(db, ibs=None):&#39;</span><span class="p">)</span>
        <span class="c1"># Function content</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">line_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_autogen_str</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">pass</span>

        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_constraints"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: use coldef_list with table_autogen_dict instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">constraint</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">constraint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_coldef_list"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_coldef_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_coldef_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            list of (str, str) : each tuple is (col_name, col_type)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>

        <span class="n">coldef_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; PRIMARY KEY&#39;</span>
            <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; NOT NULL&#39;</span>
            <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="c1"># HACK: add parens if the value contains parens in the future</span>
                <span class="c1"># all default values should contain parens</span>
                <span class="n">LEOPARD_TURK_HACK</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">LEOPARD_TURK_HACK</span> <span class="ow">and</span> <span class="s1">&#39;(&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_value</span><span class="p">:</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; DEFAULT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">default_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s1">&#39; DEFAULT (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">default_value</span>
            <span class="n">coldef_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">coldef_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_autogen_dict"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_autogen_dict">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_table_autogen_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: autogen_dict</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control get_table_autogen_dict</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = SQLDatabaseController.from_uri(&#39;:memory:&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;dummy_table&#39;</span>
<span class="sd">            &gt;&gt;&gt; db.add_table(tablename, (</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;rowid&#39;, &#39;INTEGER PRIMARY KEY&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;value1&#39;, &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;value2&#39;, &#39;TEXT NOT NULL&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;value3&#39;, &#39;TEXT DEFAULT 1&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;time_added&#39;, &quot;INTEGER DEFAULT (CAST(STRFTIME(&#39;%s&#39;, &#39;NOW&#39;, &#39;UTC&#39;) AS INTEGER))&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ))</span>
<span class="sd">            &gt;&gt;&gt; autogen_dict = db.get_table_autogen_dict(tablename)</span>
<span class="sd">            &gt;&gt;&gt; result = ut.repr2(autogen_dict, nl=2)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">autogen_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;tablename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coldef_list</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;docstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;superkeys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;dependson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">dependson</span>
        <span class="k">return</span> <span class="n">autogen_dict</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_autogen_str"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_autogen_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_autogen_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: quoted_docstr</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control get_table_autogen_str</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = SQLDatabaseController.from_uri(&#39;:memory:&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;dummy_table&#39;</span>
<span class="sd">            &gt;&gt;&gt; db.add_table(tablename, (</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;rowid&#39;, &#39;INTEGER PRIMARY KEY&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;value&#39;, &#39;TEXT&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;time_added&#39;, &quot;INTEGER DEFAULT (CAST(STRFTIME(&#39;%s&#39;, &#39;NOW&#39;, &#39;UTC&#39;) AS INTEGER))&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ))</span>
<span class="sd">            &gt;&gt;&gt; result = &#39;\n&#39;.join(db.get_table_autogen_str(tablename))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tab1</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">tab2</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;db.add_table(</span><span class="si">%s</span><span class="s1">, [&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">tablename</span><span class="p">),))</span>
        <span class="c1"># column_list = db.get_columns(tablename)</span>
        <span class="c1"># colnamerepr_list = [ut.repr2(six.text_type(column[1]))</span>
        <span class="c1">#                     for column in column_list]</span>
        <span class="n">autogen_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]</span>
        <span class="n">max_colsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">coldef_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">))))</span>
        <span class="c1"># for column, colname_repr in zip(column_list, colnamerepr_list):</span>
        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">coldef_list</span><span class="p">:</span>
            <span class="n">name_part</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">col_name</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_colsize</span><span class="p">)</span>
            <span class="n">type_part</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">col_type</span><span class="p">)</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;(</span><span class="si">%s%s</span><span class="s1">),&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_part</span><span class="p">,</span> <span class="n">type_part</span><span class="p">,))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;],&#39;</span><span class="p">)</span>
        <span class="n">superkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># Append metadata values</span>
        <span class="n">specially_handled_table_metakeys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;docstr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;superkeys&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;constraint&#39;,</span>
            <span class="s1">&#39;dependsmap&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">quote_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="kn">import</span> <span class="nn">textwrap</span>

            <span class="n">wraped_docstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">textblock</span><span class="p">(</span><span class="n">docstr</span><span class="p">)))</span>
            <span class="n">indented_docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">wraped_docstr</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">tab2</span><span class="p">)</span>
            <span class="n">_TSQ</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">TRIPLE_SINGLE_QUOTE</span>
            <span class="n">quoted_docstr</span> <span class="o">=</span> <span class="n">_TSQ</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">indented_docstr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">tab2</span> <span class="o">+</span> <span class="n">_TSQ</span>
            <span class="k">return</span> <span class="n">quoted_docstr</span>

        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;docstr=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="n">quote_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;superkeys=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">superkeys</span><span class="p">),))</span>
        <span class="c1"># Hack out docstr and superkeys for now</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">METADATA_TABLE_COLUMN_NAMES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">specially_handled_table_metakeys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">],</span> <span class="n">suffix</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="n">dependsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">dependsmap</span>
        <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_dictstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">dependsmap</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">tab2</span><span class="p">)</span>
            <span class="n">depends_map_dictstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">_dictstr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="c1"># hack for formatting</span>
            <span class="n">depends_map_dictstr</span> <span class="o">=</span> <span class="n">depends_map_dictstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab2</span> <span class="o">+</span> <span class="s1">&#39;dependsmap=</span><span class="si">%s</span><span class="s1">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depends_map_dictstr</span><span class="p">,))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab1</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.dump_schema"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.dump_schema">[docs]</a>    <span class="k">def</span> <span class="nf">dump_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience: Dumps all csv database files to disk NOTE: This function</span>
<span class="sd">        is semi-obsolete because of the auto-generated current schema file.</span>
<span class="sd">        Use dump_schema_current_autogeneration instead for all purposes except</span>
<span class="sd">        for parsing out the database schema or for consice visual</span>
<span class="sd">        representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app_resource_dir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>
        <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">,</span> <span class="s1">&#39;schema.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">column_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
                    <span class="n">col_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_null</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;ALLOW NULL&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;NOT NULL&#39;</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">col_default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="s1">&#39;KEY&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">,</span> <span class="n">col_null</span><span class="p">,</span> <span class="n">col_default</span><span class="p">,</span> <span class="n">col_key</span><span class="p">)</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s%s%s%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_names"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lazy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span>
            <span class="n">tablename_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tablenames</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tablenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>

<div class="viewcode-block" id="SQLDatabaseController.has_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.has_table">[docs]</a>    <span class="k">def</span> <span class="nf">has_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; checks if a table exists &quot;&quot;&quot;</span>
        <span class="c1"># if not lazy or self._tablenames is None:</span>
        <span class="k">return</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">(</span><span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_superkey_colnames"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_superkey_colnames">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_table_superkey_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_table_superkey_colnames</span>
<span class="sd">        Actually resturns a list of tuples. need to change the name to</span>
<span class="sd">        get_table_superkey_colnames_list</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: superkeys</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_superkey_colnames</span>
<span class="sd">            python -m wbia --tf get_table_superkey_colnames --tablename=contributors</span>
<span class="sd">            python -m wbia --tf get_table_superkey_colnames --db PZ_Master0 --tablename=annotations</span>
<span class="sd">            python -m wbia --tf get_table_superkey_colnames --db PZ_Master0 --tablename=contributors  # NOQA</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; db = depc[&#39;chip&#39;].db</span>
<span class="sd">            &gt;&gt;&gt; superkeys = db.get_table_superkey_colnames(&#39;chip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = ut.repr2(superkeys, nl=False)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            [(&#39;dummy_annot_rowid&#39;, &#39;config_rowid&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">(</span>
            <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span> <span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> is not a part of this database&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,)</span>
        <span class="n">superkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">superkeys</span>
        <span class="k">if</span> <span class="n">superkeys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">superkeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">superkeys</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_primarykey_colnames"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_primarykey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_primarykey_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">primarykey_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="p">(</span><span class="n">column_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">dflt_value</span><span class="p">,</span> <span class="n">pk</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">pk</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">primarykey_colnames</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_docstr"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_docstr">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_docstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --exec-get_table_docstr</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; result = db.get_table_docstr(tablename)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            Used to store individual chip features (ellipses)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">docstr</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_columns"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_columns</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str): table name</span>

<span class="sd">        Returns:</span>
<span class="sd">            column_list : list of tuples with format:</span>
<span class="sd">                (</span>
<span class="sd">                    column_id  : id of the column</span>
<span class="sd">                    name       : the name of the column</span>
<span class="sd">                    type_      : the type of the column</span>
<span class="sd">                    notnull    : 0 or 1 if the column can contains null values</span>
<span class="sd">                    dflt_value : the default value</span>
<span class="sd">                    pk         : 0 or 1 if the column partecipate to the primary key</span>
<span class="sd">                )</span>

<span class="sd">        References:</span>
<span class="sd">            http://stackoverflow.com/questions/17717829/how-to-get-column-names-from-a-table-in-sqlite-via-pragma-net-c</span>
<span class="sd">            http://stackoverflow.com/questions/1601151/how-do-i-check-in-sqlite-whether-a-table-exists</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --exec-get_columns</span>
<span class="sd">            python -m dtool.sql_control --exec-get_columns --tablename=contributors</span>
<span class="sd">            python -m dtool.sql_control --exec-get_columns --tablename=nonexist</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; colrichinfo_list = db.get_columns(tablename)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;colrichinfo_list = %s&#39; % (ut.repr2(colrichinfo_list, nl=1),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            colrichinfo_list = [</span>
<span class="sd">                (0, &#39;keypoint_rowid&#39;, &#39;INTEGER&#39;, 0, None, 1),</span>
<span class="sd">                (1, &#39;chip_rowid&#39;, &#39;INTEGER&#39;, 1, None, 0),</span>
<span class="sd">                (2, &#39;config_rowid&#39;, &#39;INTEGER&#39;, 0, &#39;0&#39;, 0),</span>
<span class="sd">                (3, &#39;kpts&#39;, &#39;NDARRAY&#39;, 0, None, 0),</span>
<span class="sd">                (4, &#39;num&#39;, &#39;INTEGER&#39;, 0, None, 0),</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the table exists first. Throws an error if it does not exist.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT 1 FROM &#39;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39; LIMIT 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA TABLE_INFO(&#39;&quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span><span class="p">)</span>
        <span class="n">colinfo_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">colrichinfo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQLColumnRichInfo</span><span class="p">(</span><span class="o">*</span><span class="n">colinfo</span><span class="p">)</span> <span class="k">for</span> <span class="n">colinfo</span> <span class="ow">in</span> <span class="n">colinfo_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">colrichinfo_list</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_column_names"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Returns the sql tablename columns &quot;&quot;&quot;</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">column_names</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_column"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_column">[docs]</a>    <span class="k">def</span> <span class="nf">get_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">_column</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sanitize_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">column_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            FROM </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ORDER BY rowid ASC</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">_column</span><span class="p">,</span> <span class="n">_table</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">column_vals</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_as_pandas"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_as_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_as_pandas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">rowids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        aid = 30</span>
<span class="sd">        db = ibs.staging</span>
<span class="sd">        rowids = ut.flatten(ibs.get_review_rowids_from_single([aid]))</span>
<span class="sd">        tablename = &#39;reviews&#39;</span>
<span class="sd">        exclude_columns = &#39;review_user_confidence review_user_identity&#39;.split(&#39; &#39;)</span>
<span class="sd">        logger.info(db.get_table_as_pandas(tablename, rowids, exclude_columns=exclude_columns))</span>

<span class="sd">        db = ibs.db</span>
<span class="sd">        rowids = ut.flatten(ibs.get_annotmatch_rowids_from_aid([aid]))</span>
<span class="sd">        tablename = &#39;annotmatch&#39;</span>
<span class="sd">        exclude_columns = &#39;annotmatch_confidence annotmatch_posixtime_modified annotmatch_reviewer&#39;.split(&#39; &#39;)</span>
<span class="sd">        logger.info(db.get_table_as_pandas(tablename, rowids, exclude_columns=exclude_columns))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rowids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rowids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_column_data</span><span class="p">(</span>
            <span class="n">tablename</span><span class="p">,</span> <span class="n">rowids</span><span class="o">=</span><span class="n">rowids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span>
        <span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">rowids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">column_list</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_column_data"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_column_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_column_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">rowids</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grabs a table of information</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_column_data</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names = db.get_table_column_data(tablename)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_column_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">all_column_names</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">if</span> <span class="n">rowids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,),</span> <span class="n">rowids</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span></div>

<div class="viewcode-block" id="SQLDatabaseController.make_json_table_definition"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.make_json_table_definition">[docs]</a>    <span class="k">def</span> <span class="nf">make_json_table_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VERY HACKY FUNC RIGHT NOW. NEED TO FIX LATER</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (?):</span>

<span class="sd">        Returns:</span>
<span class="sd">            ?: new_transferdata</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia --tf sql_control.make_json_table_definition</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m utool --tf iter_module_doctestable --modname=dtool.sql_control</span>
<span class="sd">            --include_inherited=True</span>
<span class="sd">            python -m dtool.sql_control --exec-make_json_table_definition</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; table_def = db.make_json_table_definition(tablename)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;table_def = %s&#39; % (ut.repr2(table_def, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            table_def = {</span>
<span class="sd">                &#39;keypoint_rowid&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;chip_rowid&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;config_rowid&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">                &#39;kpts&#39;: &#39;NDARRAY&#39;,</span>
<span class="sd">                &#39;num&#39;: &#39;INTEGER&#39;,</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_transferdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_new_transferdata</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">column_list</span><span class="p">,</span>
            <span class="n">column_names</span><span class="p">,</span>
            <span class="n">extern_colx_list</span><span class="p">,</span>
            <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
            <span class="n">extern_superkey_colval_list</span><span class="p">,</span>
            <span class="n">extern_tablename_list</span><span class="p">,</span>
            <span class="n">extern_primarycolnames_list</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">new_transferdata</span>
        <span class="n">dependsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">dependsmap</span>

        <span class="n">richcolinfo_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">table_dict_def</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">richcolinfo_list</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dependsmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tablename</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># replace with superkey</span>
                    <span class="k">del</span> <span class="n">table_dict_def</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">_deptablecols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">superkey</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;unhandled&#39;</span>
                    <span class="n">colinfo</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_deptablecols</span><span class="p">}[</span><span class="n">superkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">table_dict_def</span><span class="p">[</span><span class="n">superkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">colinfo</span><span class="o">.</span><span class="n">type_</span>
        <span class="c1"># json_def_str = ut.repr2(table_dict_def, aligned=True)</span>
        <span class="k">return</span> <span class="n">table_dict_def</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_new_transferdata"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_new_transferdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_new_transferdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_column_data</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_new_transferdata</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_new_transferdata:1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; db = depc[tablename].db</span>
<span class="sd">            &gt;&gt;&gt; tablename_list = db.get_table_names()</span>
<span class="sd">            &gt;&gt;&gt; colrichinfo_list = db.get_columns(tablename)</span>
<span class="sd">            &gt;&gt;&gt; for tablename in tablename_list:</span>
<span class="sd">            ...     new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            ...     column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            ...     print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            ...     print(&#39;colnames = &#39; + ut.repr2(column_names))</span>
<span class="sd">            ...     print(&#39;extern_colx_list = &#39; + ut.repr2(extern_colx_list))</span>
<span class="sd">            ...     print(&#39;extern_superkey_colname_list = &#39; + ut.repr2(extern_superkey_colname_list))</span>
<span class="sd">            ...     print(&#39;L___&#39;)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; ibs = wbia.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; tablename_list = ibs.db.get_table_names()</span>
<span class="sd">            &gt;&gt;&gt; for tablename in tablename_list:</span>
<span class="sd">            ...     new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            ...     column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            ...     print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            ...     print(&#39;colnames = &#39; + ut.repr2(column_names))</span>
<span class="sd">            ...     print(&#39;extern_colx_list = &#39; + ut.repr2(extern_colx_list))</span>
<span class="sd">            ...     print(&#39;extern_superkey_colname_list = &#39; + ut.repr2(extern_superkey_colname_list))</span>
<span class="sd">            ...     print(&#39;L___&#39;)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # SLOW_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; ibs = wbia.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; db = ibs.db</span>
<span class="sd">            &gt;&gt;&gt; exclude_columns = []</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.IMAGE_TABLE</span>
<span class="sd">            &gt;&gt;&gt; new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            &gt;&gt;&gt; dependsmap = db.metadata[tablename].dependsmap</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;colnames = &#39; + ut.repr2(column_names))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_colx_list = &#39; + ut.repr2(extern_colx_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_superkey_colname_list = &#39; + ut.repr2(extern_superkey_colname_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;dependsmap = %s&#39; % (ut.repr2(dependsmap, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;L___&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tablename = ibs.const.ANNOTATION_TABLE</span>
<span class="sd">            &gt;&gt;&gt; new_transferdata = db.get_table_new_transferdata(tablename)</span>
<span class="sd">            &gt;&gt;&gt; column_list, column_names, extern_colx_list, extern_superkey_colname_list, extern_superkey_colval_list, extern_tablename_list, extern_primarycolnames_list = new_transferdata</span>
<span class="sd">            &gt;&gt;&gt; dependsmap = db.metadata[tablename].dependsmap</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;tablename = %r&#39; % (tablename,))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;colnames = &#39; + ut.repr2(column_names))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_colx_list = &#39; + ut.repr2(extern_colx_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;extern_superkey_colname_list = &#39; + ut.repr2(extern_superkey_colname_list))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;dependsmap = %s&#39; % (ut.repr2(dependsmap, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;L___&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">utool</span>

        <span class="k">with</span> <span class="n">utool</span><span class="o">.</span><span class="n">embed_on_exception_context</span><span class="p">:</span>
            <span class="n">all_column_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_column_names</span><span class="p">]</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">all_column_names</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_columns</span>
            <span class="p">]</span>

            <span class="n">extern_colx_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">extern_tablename_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">extern_superkey_colname_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">extern_superkey_colval_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">extern_primarycolnames_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dependsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">dependsmap</span>
            <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">colname</span><span class="p">,</span> <span class="n">dependtup</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dependsmap</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependtup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;must be 3 for now&#39;</span>
                    <span class="p">(</span>
                        <span class="n">extern_tablename</span><span class="p">,</span>
                        <span class="n">extern_primary_colnames</span><span class="p">,</span>
                        <span class="n">extern_superkey_colnames</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">dependtup</span>
                    <span class="k">if</span> <span class="n">extern_primary_colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># INFER PRIMARY COLNAMES</span>
                        <span class="n">extern_primary_colnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_primarykey_colnames</span><span class="p">(</span>
                            <span class="n">extern_tablename</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">extern_superkey_colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="k">def</span> <span class="nf">get_standard_superkey_colnames</span><span class="p">(</span><span class="n">tablename_</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># FIXME: Rectify duplicate code</span>
                                <span class="n">superkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename_</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">primary_superkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                                        <span class="n">tablename_</span>
                                    <span class="p">]</span><span class="o">.</span><span class="n">primary_superkey</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="s1">&#39;contributors&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">primary_superkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                                            <span class="p">(</span>
                                                <span class="s1">&#39;tablename_=</span><span class="si">%r</span><span class="s1"> has multiple superkeys=</span><span class="si">%r</span><span class="s1">, &#39;</span>
                                                <span class="s1">&#39;but no primary superkey.&#39;</span>
                                                <span class="s1">&#39; A primary superkey is required&#39;</span>
                                            <span class="p">)</span>
                                            <span class="o">%</span> <span class="p">(</span><span class="n">tablename_</span><span class="p">,</span> <span class="n">superkeys</span><span class="p">)</span>
                                        <span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">index</span> <span class="o">=</span> <span class="n">superkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">primary_superkey</span><span class="p">)</span>
                                        <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkeys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename_</span><span class="p">))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">print_table_csv</span><span class="p">(</span>
                                        <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">]</span>
                                    <span class="p">)</span>
                                    <span class="c1"># Execute hack to fix contributor tables</span>
                                    <span class="k">if</span> <span class="n">tablename_</span> <span class="o">==</span> <span class="s1">&#39;contributors&#39;</span><span class="p">:</span>
                                        <span class="c1"># hack to fix contributors table</span>
                                        <span class="n">constraint_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span>
                                            <span class="n">tablename_</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">constraint</span>
                                        <span class="n">parse_result</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                            <span class="s1">&#39;CONSTRAINT superkey UNIQUE (</span><span class="si">{superkey}</span><span class="s1">)&#39;</span><span class="p">,</span>
                                            <span class="n">constraint_str</span><span class="p">,</span>
                                        <span class="p">)</span>
                                        <span class="n">superkey</span> <span class="o">=</span> <span class="n">parse_result</span><span class="p">[</span><span class="s1">&#39;superkey&#39;</span><span class="p">]</span>
                                        <span class="k">assert</span> <span class="p">(</span>
                                            <span class="n">superkey</span> <span class="o">==</span> <span class="s1">&#39;contributor_tag&#39;</span>
                                        <span class="p">),</span> <span class="s1">&#39;hack failed1&#39;</span>
                                        <span class="k">assert</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">superkey</span> <span class="ow">is</span> <span class="kc">None</span>
                                        <span class="p">),</span> <span class="s1">&#39;hack failed2&#39;</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">superkey</span> <span class="o">=</span> <span class="p">[</span>
                                            <span class="p">(</span><span class="n">superkey</span><span class="p">,)</span>
                                        <span class="p">]</span>
                                        <span class="k">return</span> <span class="p">(</span><span class="n">superkey</span><span class="p">,)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                                            <span class="s1">&#39;Cannot Handle: len(superkeys) == 0. &#39;</span>
                                            <span class="s1">&#39;Probably a degenerate case&#39;</span>
                                        <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                                    <span class="n">ex</span><span class="p">,</span>
                                    <span class="s1">&#39;Error Getting superkey colnames&#39;</span><span class="p">,</span>
                                    <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tablename_&#39;</span><span class="p">,</span> <span class="s1">&#39;superkeys&#39;</span><span class="p">],</span>
                                <span class="p">)</span>
                                <span class="k">raise</span>
                            <span class="k">return</span> <span class="n">superkey_colnames</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">extern_superkey_colnames</span> <span class="o">=</span> <span class="n">get_standard_superkey_colnames</span><span class="p">(</span>
                                <span class="n">extern_tablename</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                                <span class="n">ex</span><span class="p">,</span>
                                <span class="s1">&#39;Error Building Transferdata&#39;</span><span class="p">,</span>
                                <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tablename_&#39;</span><span class="p">,</span> <span class="s1">&#39;dependtup&#39;</span><span class="p">],</span>
                            <span class="p">)</span>
                            <span class="k">raise</span>
                        <span class="c1"># INFER SUPERKEY COLNAMES</span>
                    <span class="n">colx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listfind</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
                    <span class="n">extern_rowids</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="n">colx</span><span class="p">]</span>
                    <span class="n">superkey_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">extern_tablename</span><span class="p">,</span> <span class="n">extern_superkey_colnames</span><span class="p">,</span> <span class="n">extern_rowids</span>
                    <span class="p">)</span>
                    <span class="n">extern_colx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colx</span><span class="p">)</span>
                    <span class="n">extern_superkey_colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_superkey_colnames</span><span class="p">)</span>
                    <span class="n">extern_superkey_colval_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">superkey_column</span><span class="p">)</span>
                    <span class="n">extern_tablename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_tablename</span><span class="p">)</span>
                    <span class="n">extern_primarycolnames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extern_primary_colnames</span><span class="p">)</span>

            <span class="n">new_transferdata</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">column_list</span><span class="p">,</span>
                <span class="n">column_names</span><span class="p">,</span>
                <span class="n">extern_colx_list</span><span class="p">,</span>
                <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
                <span class="n">extern_superkey_colval_list</span><span class="p">,</span>
                <span class="n">extern_tablename_list</span><span class="p">,</span>
                <span class="n">extern_primarycolnames_list</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_transferdata</span></div>

    <span class="c1"># def import_table_new_transferdata(tablename, new_transferdata):</span>
    <span class="c1">#    pass</span>

<div class="viewcode-block" id="SQLDatabaseController.merge_databases_new"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.merge_databases_new">[docs]</a>    <span class="k">def</span> <span class="nf">merge_databases_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_src</span><span class="p">,</span> <span class="n">ignore_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rowid_subsets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies over all non-rowid properties into another sql table. handles</span>
<span class="sd">        annotated dependenceis.</span>
<span class="sd">        Does not handle external files</span>
<span class="sd">        Could handle dependency tree order, but not yet implemented.</span>

<span class="sd">        FINISHME</span>

<span class="sd">        Args:</span>
<span class="sd">            db_src (SQLController): merge data from db_src into db</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --test-merge_databases_new:0</span>
<span class="sd">            python -m dtool.sql_control --test-merge_databases_new:2</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; #ibs_dst = wbia.opendb(dbdir=&#39;testdb_dst&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = wbia.opendb(db=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = wbia.opendb(dbdir=&#39;test_sql_merge_dst1&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = None</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src)</span>

<span class="sd">        Example1:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = wbia.opendb(db=&#39;testdb2&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = wbia.opendb(dbdir=&#39;test_sql_merge_dst2&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; ignore_tables = [&#39;lblannot&#39;, &#39;lblimage&#39;, &#39;image_lblimage_relationship&#39;, &#39;annotation_lblannot_relationship&#39;, &#39;keys&#39;]</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = None</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src, ignore_tables=ignore_tables)</span>

<span class="sd">        Example2:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; ibs_src = wbia.opendb(db=&#39;testdb2&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # OPEN A CLEAN DATABASE</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.fix_invalid_annotmatches()</span>
<span class="sd">            &gt;&gt;&gt; ibs_dst = wbia.opendb(dbdir=&#39;test_sql_subexport_dst2&#39;, allow_newdir=True, delete_ibsdir=True)</span>
<span class="sd">            &gt;&gt;&gt; ibs_src.ensure_contributor_rowids()</span>
<span class="sd">            &gt;&gt;&gt; # build test data</span>
<span class="sd">            &gt;&gt;&gt; db = ibs_dst.db</span>
<span class="sd">            &gt;&gt;&gt; db_src = ibs_src.db</span>
<span class="sd">            &gt;&gt;&gt; ignore_tables = [&#39;lblannot&#39;, &#39;lblimage&#39;, &#39;image_lblimage_relationship&#39;, &#39;annotation_lblannot_relationship&#39;, &#39;keys&#39;]</span>
<span class="sd">            &gt;&gt;&gt; # execute function</span>
<span class="sd">            &gt;&gt;&gt; aid_subset = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; rowid_subsets = {ANNOTATION_TABLE: aid_subset,</span>
<span class="sd">            ...                  NAME_TABLE: ibs_src.get_annot_nids(aid_subset),</span>
<span class="sd">            ...                  IMAGE_TABLE: ibs_src.get_annot_gids(aid_subset),</span>
<span class="sd">            ...                  ANNOTMATCH_TABLE: [],</span>
<span class="sd">            ...                  GSG_RELATION_TABLE: [],</span>
<span class="sd">            ...                  }</span>
<span class="sd">            &gt;&gt;&gt; db.merge_databases_new(db_src, ignore_tables=ignore_tables, rowid_subsets=rowid_subsets)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">veryverbose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Check version consistency</span>
        <span class="n">version_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">version</span>
        <span class="n">version_src</span> <span class="o">=</span> <span class="n">db_src</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">version</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">version_src</span> <span class="o">==</span> <span class="n">version_dst</span>
        <span class="p">),</span> <span class="s1">&#39;cannot merge databases that have different versions&#39;</span>
        <span class="c1"># Get merge tablenames</span>
        <span class="n">all_tablename_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
        <span class="c1"># always ignore the metadata table.</span>
        <span class="n">ignore_tables_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ignore_tables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ignore_tables_</span> <span class="o">+=</span> <span class="n">ignore_tables</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">all_tablename_list</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_tables_</span>
        <span class="p">]</span>
        <span class="c1"># Reorder tablenames based on dependencies.</span>
        <span class="c1"># the tables with dependencies are merged after the tables they depend on</span>
        <span class="n">dependsmap_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">dependsmap</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span>
        <span class="p">]</span>
        <span class="n">dependency_digraph</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tablename</span><span class="p">:</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">dependsmap</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">dependsmap</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dependsmap</span><span class="p">,</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dependsmap_list</span><span class="p">,</span> <span class="n">tablename_list</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">find_depth</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            depth first search to find root self cycles are counted as 0 depth</span>
<span class="sd">            will break if a true cycle exists</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">depth_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">find_depth</span><span class="p">(</span><span class="n">depends_tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">depends_tablename</span> <span class="o">!=</span> <span class="n">tablename</span>
                <span class="k">else</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">depends_tablename</span> <span class="ow">in</span> <span class="n">dependency_digraph</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depth_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">depth_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">depth</span>

        <span class="n">order_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_depth</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">dependency_digraph</span><span class="p">)</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span>
        <span class="p">]</span>
        <span class="n">sorted_tablename_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sortedby</span><span class="p">(</span><span class="n">tablename_list</span><span class="p">,</span> <span class="n">order_list</span><span class="p">)</span>
        <span class="c1"># ================================</span>
        <span class="c1"># Merge each table into new database</span>
        <span class="c1"># ================================</span>
        <span class="n">tablename_to_rowidmap</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># TODO</span>
        <span class="c1"># old_rowids_to_new_roids</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">sorted_tablename_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[sqlmerge] Merging tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="c1"># Collect the data from the source table that will be merged in</span>
            <span class="n">new_transferdata</span> <span class="o">=</span> <span class="n">db_src</span><span class="o">.</span><span class="n">get_table_new_transferdata</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c1"># FIXME: This needs to pass back sparser output</span>
            <span class="p">(</span>
                <span class="n">column_list</span><span class="p">,</span>
                <span class="n">column_names</span><span class="p">,</span>
                <span class="c1"># These fields are for external data dependencies. We need to find what the</span>
                <span class="c1"># new rowids will be in the destintation database</span>
                <span class="n">extern_colx_list</span><span class="p">,</span>
                <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
                <span class="n">extern_superkey_colval_list</span><span class="p">,</span>
                <span class="n">extern_tablename_list</span><span class="p">,</span>
                <span class="n">extern_primarycolnames_list</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">new_transferdata</span>
            <span class="c1"># FIXME: extract the primary rowid column a little bit nicer</span>
            <span class="k">assert</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_rowid&#39;</span><span class="p">)</span>
            <span class="n">old_rowid_list</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">column_names_</span> <span class="o">=</span> <span class="n">column_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">column_list_</span> <span class="o">=</span> <span class="n">column_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># +=================================================</span>
            <span class="c1"># WIP: IF SUBSET REQUSTED FILTER OUT INVALID ROWIDS</span>
            <span class="k">if</span> <span class="n">rowid_subsets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">rowid_subsets</span><span class="p">:</span>
                <span class="n">valid_rowids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rowid_subsets</span><span class="p">[</span><span class="n">tablename</span><span class="p">])</span>
                <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">in</span> <span class="n">valid_rowids</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">old_rowid_list</span><span class="p">]</span>
                <span class="n">valid_old_rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">old_rowid_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
                <span class="n">valid_column_list_</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_list_</span>
                <span class="p">]</span>
                <span class="n">valid_extern_superkey_colval_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">extern_superkey_colval_list</span>
                <span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39; * filtered number of rows from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">.&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_rowids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_old_rowid_list</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * no filtering requested&#39;</span><span class="p">)</span>
                <span class="n">valid_extern_superkey_colval_list</span> <span class="o">=</span> <span class="n">extern_superkey_colval_list</span>
                <span class="n">valid_old_rowid_list</span> <span class="o">=</span> <span class="n">old_rowid_list</span>
                <span class="n">valid_column_list_</span> <span class="o">=</span> <span class="n">column_list_</span>
            <span class="c1"># if len(valid_old_rowid_list) == 0:</span>
            <span class="c1">#    continue</span>
            <span class="c1"># L=================================================</span>

            <span class="c1"># ================================</span>
            <span class="c1"># Resolve external superkey lookups</span>
            <span class="c1"># ================================</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;[sqlmerge] </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> externaly dependant columns to resolve&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extern_colx_list</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="n">modified_column_list_</span> <span class="o">=</span> <span class="n">valid_column_list_</span><span class="p">[:]</span>
                <span class="n">new_extern_rowid_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># Find the mappings from the old tables rowids to the new tables rowids</span>
                <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">extern_colx_list</span><span class="p">,</span>
                    <span class="n">extern_superkey_colname_list</span><span class="p">,</span>
                    <span class="n">valid_extern_superkey_colval_list</span><span class="p">,</span>
                    <span class="n">extern_tablename_list</span><span class="p">,</span>
                    <span class="n">extern_primarycolnames_list</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="p">(</span>
                        <span class="n">colx</span><span class="p">,</span>
                        <span class="n">extern_superkey_colname</span><span class="p">,</span>
                        <span class="n">extern_superkey_colval</span><span class="p">,</span>
                        <span class="n">extern_tablename</span><span class="p">,</span>
                        <span class="n">extern_primarycolname</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
                    <span class="n">source_colname</span> <span class="o">=</span> <span class="n">column_names_</span><span class="p">[</span><span class="n">colx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">veryverbose</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sqlmerge] +--&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="s1">&#39;[sqlmerge] * resolving source_colname=</span><span class="si">%r</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;                 via extern_superkey_colname=</span><span class="si">%r</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;                 -&gt; extern_primarycolname=</span><span class="si">%r</span><span class="s1">. colx=</span><span class="si">%r</span><span class="s1">&#39;</span>
                                <span class="p">)</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">source_colname</span><span class="p">,</span>
                                    <span class="n">extern_superkey_colname</span><span class="p">,</span>
                                    <span class="n">extern_primarycolname</span><span class="p">,</span>
                                    <span class="n">colx</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;[sqlmerge] * resolving </span><span class="si">%r</span><span class="s1"> via </span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">source_colname</span><span class="p">,</span>
                                    <span class="n">extern_superkey_colname</span><span class="p">,</span>
                                    <span class="n">extern_primarycolname</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="n">_params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">extern_superkey_colval</span><span class="p">))</span>
                    <span class="n">new_extern_rowids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rowid_from_superkey</span><span class="p">(</span>
                        <span class="n">extern_tablename</span><span class="p">,</span>
                        <span class="n">_params_iter</span><span class="p">,</span>
                        <span class="n">superkey_colnames</span><span class="o">=</span><span class="n">extern_superkey_colname</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">num_Nones</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">new_extern_rowids</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;[sqlmerge] * there were </span><span class="si">%d</span><span class="s1"> none items&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_Nones</span><span class="p">,)</span>
                        <span class="p">)</span>
                    <span class="c1"># ut.assert_all_not_None(new_extern_rowids)</span>
                    <span class="n">new_extern_rowid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_extern_rowids</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">colx</span><span class="p">,</span> <span class="n">new_extern_rowids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">extern_colx_list</span><span class="p">,</span> <span class="n">new_extern_rowid_list</span>
                <span class="p">):</span>
                    <span class="n">modified_column_list_</span><span class="p">[</span><span class="n">colx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_extern_rowids</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modified_column_list_</span> <span class="o">=</span> <span class="n">valid_column_list_</span>

            <span class="c1"># ================================</span>
            <span class="c1"># Merge into db with add_cleanly</span>
            <span class="c1"># ================================</span>
            <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_superkey_colnames</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">superkey_paramxs_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">column_names_</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">superkey</span><span class="p">))</span> <span class="k">for</span> <span class="n">superkey</span> <span class="ow">in</span> <span class="n">superkey_colnames</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">superkey_colnames</span> <span class="ow">in</span> <span class="n">superkey_colnames_list</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;column_names_&#39;</span><span class="p">,</span> <span class="s1">&#39;superkey_colnames_list&#39;</span><span class="p">])</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># FIXME: Rectify duplicate code</span>
                <span class="n">primary_superkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">primary_superkey</span>
                <span class="k">if</span> <span class="n">primary_superkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> has multiple superkey_colnames_list=</span><span class="si">%r</span><span class="s1">, &#39;</span>
                            <span class="s1">&#39;but no primary superkey. &#39;</span>
                            <span class="s1">&#39;A primary superkey is required&#39;</span>
                        <span class="p">)</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">superkey_colnames_list</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">superkey_index</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">primary_superkey</span><span class="p">)</span>
                    <span class="n">superkey_paramx</span> <span class="o">=</span> <span class="n">superkey_paramxs_list</span><span class="p">[</span><span class="n">superkey_index</span><span class="p">]</span>
                    <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="p">[</span><span class="n">superkey_index</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">superkey_paramx</span> <span class="o">=</span> <span class="n">superkey_paramxs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">superkey_paramx</span> <span class="o">=</span> <span class="n">superkey_paramxs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="n">superkey_colnames_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># def get_referenced_table():</span>
                <span class="c1">#     # TODO use foreign keys to infer this data instead of hacks</span>
                <span class="c1">#     pass</span>
                <span class="c1"># logger.info(&#39;superkey_paramxs_list = %r&#39; % (superkey_paramxs_list, ))</span>
                <span class="c1"># logger.info(&#39;superkey_colnames_list = %r&#39; % (superkey_colnames_list, ))</span>
                <span class="c1"># raise ValueError(&#39;Cannot merge %r&#39; % (tablename, ))</span>

            <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">modified_column_list_</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_column_list</span><span class="p">):</span>
                <span class="n">superkey_params_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_column_list</span><span class="p">)</span>
                <span class="n">rowid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rowid_from_superkey</span><span class="p">(</span>
                    <span class="n">tablename</span><span class="p">,</span> <span class="n">superkey_params_iter</span><span class="p">,</span> <span class="n">superkey_colnames</span><span class="o">=</span><span class="n">superkey_colnames</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">rowid</span>

            <span class="c1"># TODO: allow for cetrain databases to take precidence over another</span>
            <span class="c1"># basically allow insert or replace</span>
            <span class="n">new_rowid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span>
                <span class="n">tablename</span><span class="p">,</span>
                <span class="n">column_names_</span><span class="p">,</span>
                <span class="n">params_iter</span><span class="p">,</span>
                <span class="n">get_rowid_from_superkey</span><span class="o">=</span><span class="n">get_rowid_from_superkey</span><span class="p">,</span>
                <span class="n">superkey_paramx</span><span class="o">=</span><span class="n">superkey_paramx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># TODO: Use mapping generated here for new rowids</span>
            <span class="n">old_rowids_to_new_roids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">valid_old_rowid_list</span><span class="p">,</span> <span class="n">new_rowid_list</span><span class="p">)</span>  <span class="c1"># NOQA</span>
            <span class="p">)</span>
            <span class="n">tablename_to_rowidmap</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_rowids_to_new_roids</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_csv"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">rowids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a tablename to csv format</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            exclude_columns (list):</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: csv_table</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.sql_control --test-get_table_csv</span>
<span class="sd">            python -m dtool.sql_control --exec-get_table_csv --tablename=contributors</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.sql_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;notch&#39;, [1, 2, 3])</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;notch&#39;]</span>
<span class="sd">            &gt;&gt;&gt; db = table.db</span>
<span class="sd">            &gt;&gt;&gt; ut.exec_funckw(db.get_table_csv, globals())</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;notch&#39;</span>
<span class="sd">            &gt;&gt;&gt; csv_table = db.get_table_csv(tablename, exclude_columns, truncate=True)</span>
<span class="sd">            &gt;&gt;&gt; print(csv_table)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># =None, column_list=[], header=&#39;&#39;, column_type=None</span>
        <span class="n">column_list</span><span class="p">,</span> <span class="n">column_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_column_data</span><span class="p">(</span>
            <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span> <span class="n">rowids</span><span class="o">=</span><span class="n">rowids</span>
        <span class="p">)</span>
        <span class="c1"># remove column prefix for more compact csvs</span>
        <span class="n">column_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tablename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># truncate = True</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span>
            <span class="p">]</span>

        <span class="n">csv_table</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_csv_table</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_lbls</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">comma_repl</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">csv_table</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_unicode</span><span class="p">(</span><span class="n">csv_table</span><span class="p">)</span>
        <span class="c1"># csv_table = ut.make_csv_table(column_list, column_lbls, header, comma_repl=&#39;&lt;comma&gt;&#39;)</span>
        <span class="k">return</span> <span class="n">csv_table</span></div>

<div class="viewcode-block" id="SQLDatabaseController.print_table_csv"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.print_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">print_table_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span>
                <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_table_csv_header"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_table_csv_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv_header</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_coldef_list</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">header_constraints</span> <span class="o">=</span> <span class="s1">&#39;# CONSTRAINTS: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">header_name</span> <span class="o">=</span> <span class="s1">&#39;# TABLENAME: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tablename</span>
        <span class="n">header_types</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">coldef_list</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># &#39;</span><span class="p">)</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">docstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">header_doc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># &#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">header_doc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">header_name</span> <span class="o">+</span> <span class="n">header_types</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">header_constraints</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span></div>

<div class="viewcode-block" id="SQLDatabaseController.print_schema"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.print_schema">[docs]</a>    <span class="k">def</span> <span class="nf">print_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.view_db_in_external_reader"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.view_db_in_external_reader">[docs]</a>    <span class="k">def</span> <span class="nf">view_db_in_external_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">known_readers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqlitebrowser&#39;</span><span class="p">,</span> <span class="s1">&#39;sqliteman&#39;</span><span class="p">]</span>
        <span class="n">sqlite3_reader</span> <span class="o">=</span> <span class="n">known_readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">sqlite3_reader</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
        <span class="c1"># ut.cmd(sqlite3_reader, sqlite3_db_fpath)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SQLDatabaseController.set_db_version"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.set_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">set_db_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="c1"># Do things properly, get the metadata_rowid (best because we want to assert anyway)</span>
        <span class="n">metadata_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;database_version&#39;</span><span class="p">]</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_key</span> <span class="ow">in</span> <span class="n">metadata_key_list</span><span class="p">)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">&#39;metadata_key=?&#39;</span>
        <span class="c1"># list of relationships for each image</span>
        <span class="n">metadata_rowid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span>
            <span class="n">METADATA_TABLE_NAME</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;metadata_rowid&#39;</span><span class="p">,),</span>
            <span class="n">params_iter</span><span class="p">,</span>
            <span class="n">where_clause</span><span class="p">,</span>
            <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">metadata_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s1">&#39;duplicate database_version keys in database&#39;</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_rowid</span> <span class="ow">in</span> <span class="n">metadata_rowid_list</span><span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">((</span><span class="n">_</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">METADATA_TABLE_NAME</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;metadata_value&#39;</span><span class="p">,),</span> <span class="n">val_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLDatabaseController.get_sql_version"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLDatabaseController.get_sql_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT sqlite_version()&#39;</span><span class="p">)</span>
        <span class="n">sql_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] SELECT sqlite_version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql_version</span><span class="p">,))</span>
        <span class="c1"># The version number sqlite3 module. NOT the version of SQLite library.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] sqlite3.version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">version</span><span class="p">,))</span>
        <span class="c1"># The version of the SQLite library</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[sql] sqlite3.sqlite_version = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">sqlite_version</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">sql_version</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Choose on of: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tablenames</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">SQLTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span></div>


<div class="viewcode-block" id="SQLTable"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SQLTable</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convinience object for dealing with a specific table</span>

<span class="sd">    table = db</span>
<span class="sd">    table = SQLTable(db, &#39;annotmatch&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">table</span><span class="o">.</span><span class="n">_setup_column_methods</span><span class="p">()</span>

<div class="viewcode-block" id="SQLTable.get"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">id_iter</span><span class="o">=</span><span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_column_methods</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_make_getter</span><span class="p">(</span><span class="n">column</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_getter</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowids</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">rowids</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_getter</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>

<div class="viewcode-block" id="SQLTable.number_of_rows"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.number_of_rows">[docs]</a>    <span class="k">def</span> <span class="nf">number_of_rows</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_row_count</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLTable.as_pandas"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.as_pandas">[docs]</a>    <span class="k">def</span> <span class="nf">as_pandas</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_as_pandas</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rowids</span><span class="o">=</span><span class="n">rowids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLTable.rowids"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.rowids">[docs]</a>    <span class="k">def</span> <span class="nf">rowids</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLTable.delete"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowids</span><span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_rowids</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rowids</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLTable.clear"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.sql_control.SQLTable.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rowids</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rowids</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;, n=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">number_of_rows</span><span class="p">())</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>