
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.dtool.depcache_control &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.dtool.depcache_control</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">implicit version of dependency cache from wbia/templates/template_generator</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">sql_control</span>
<span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">depcache_table</span>
<span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<span class="c1"># global function registry</span>
<span class="n">PREPROC_REGISTER</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">SUBPROP_REGISTER</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>


<span class="n">REG_PREPROC_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Args:</span>
<span class="s2">    tablename (str): name of the node (corrsponds to SQL table)</span>
<span class="s2">    parents (list): tables this node depends on</span>
<span class="s2">    colnames (list): data returned by this table</span>
<span class="s2">    coltypes (list): types of data returned by this table</span>
<span class="s2">    chunksize (int): (default = None)</span>
<span class="s2">    configclass (dtool.TableConfig): derivative of dtool.TableConfig.</span>
<span class="s2">        if None, a default class will be constructed for you. (default = None)</span>
<span class="s2">    docstr (str): (default = None)</span>
<span class="s2">    fname (str):  file name(default = None)</span>
<span class="s2">    asobject (bool): hacky dont use (default = False)</span>

<span class="s2">SeeAlso:</span>
<span class="s2">    depcache_table.DependencyCacheTable</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="check_register"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.check_register">[docs]</a><span class="k">def</span> <span class="nf">check_register</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;too many args&#39;</span>
    <span class="k">assert</span> <span class="s1">&#39;preproc_func&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;cannot specify func in wrapper&#39;</span></div>


<div class="viewcode-block" id="make_depcache_decors"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.make_depcache_decors">[docs]</a><span class="k">def</span> <span class="nf">make_depcache_decors</span><span class="p">(</span><span class="n">root_tablename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes global decorators to register functions for a tablename.</span>

<span class="sd">    A preproc function is meant to belong only to a single parent An algo</span>
<span class="sd">    function belongs to the root node, and may depend on a set of root nodes</span>
<span class="sd">    rather than just a single one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">apply_docstr</span><span class="p">(</span><span class="n">REG_PREPROC_DOC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">register_preproc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Global regsiter proproc function that will define a table for all</span>
<span class="sd">        dependency caches containing the parents. See</span>

<span class="sd">        See dtool.depcache_control.REG_PREPROC_DOC if docstr is not autogened</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">register_preproc_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">check_register</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;preproc_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">PREPROC_REGISTER</span><span class="p">[</span><span class="n">root_tablename</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">register_preproc_wrapper</span>

    <span class="k">def</span> <span class="nf">register_subprop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;preproc_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">SUBPROP_REGISTER</span><span class="p">[</span><span class="n">root_tablename</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">_wrapper</span>

    <span class="n">_depcdecors</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">({</span><span class="s1">&#39;preproc&#39;</span><span class="p">:</span> <span class="n">register_preproc</span><span class="p">,</span> <span class="s1">&#39;subprop&#39;</span><span class="p">:</span> <span class="n">register_subprop</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">_depcdecors</span></div>


<span class="k">class</span> <span class="nc">_CoreDependencyCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core worker functions for the depcache</span>
<span class="sd">    Inherited by a calss with some &quot;nice extras</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_register_prop</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span>
        <span class="n">tablename</span><span class="p">,</span>
        <span class="n">parents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">coltypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">preproc_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">configclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">requestclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default_to_unpack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a table with this dependency cache.</span>
<span class="sd">        Essentially passes args down to make a DependencyTable.</span>

<span class="sd">        SEE: dtool.REG_PREPROC_DOC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[depc] Registering tablename=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[depc]  * preproc_func=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">preproc_func</span><span class="p">,))</span>
        <span class="c1"># ----------</span>
        <span class="c1"># Sanitize inputs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="k">if</span> <span class="n">coltypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coltypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="c1"># Check if just a single column is given</span>
        <span class="k">if</span> <span class="n">default_to_unpack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">colnames</span><span class="p">):</span>
                <span class="n">default_to_unpack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">colnames</span><span class="p">]</span>
                <span class="n">coltypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">coltypes</span><span class="p">]</span>
                <span class="n">default_to_unpack</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">coltypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must specify coltypes of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="n">coltypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">default_fname</span>
        <span class="k">if</span> <span class="n">configclass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make a default config with no parameters</span>
            <span class="n">configclass</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configclass</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Dynamically make config class</span>
            <span class="n">default_cfgdict</span> <span class="o">=</span> <span class="n">configclass</span>
            <span class="n">configclass</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">make_configclass</span><span class="p">(</span><span class="n">default_cfgdict</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># ----------</span>
        <span class="c1"># Register a new table and configuration</span>
        <span class="k">if</span> <span class="n">requestclass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">requestclass_dict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestclass</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depcache_table</span><span class="o">.</span><span class="n">DependencyCacheTable</span><span class="p">(</span>
            <span class="n">depc</span><span class="o">=</span><span class="n">depc</span><span class="p">,</span>
            <span class="n">parent_tablenames</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span>
            <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">data_colnames</span><span class="o">=</span><span class="n">colnames</span><span class="p">,</span>
            <span class="n">data_coltypes</span><span class="o">=</span><span class="n">coltypes</span><span class="p">,</span>
            <span class="n">preproc_func</span><span class="o">=</span><span class="n">preproc_func</span><span class="p">,</span>
            <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span>
            <span class="n">default_to_unpack</span><span class="o">=</span><span class="n">default_to_unpack</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span> <span class="o">=</span> <span class="n">configclass</span>
        <span class="k">return</span> <span class="n">table</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">apply_docstr</span><span class="p">(</span><span class="n">REG_PREPROC_DOC</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">register_preproc</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorator for registration of cachables</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">register_preproc_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">check_register</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;preproc_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">_register_prop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">register_preproc_wrapper</span>

    <span class="k">def</span> <span class="nf">_register_subprop</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">propname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preproc_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; subproperties are always recomputeed on the fly &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">subproperties</span><span class="p">[</span><span class="n">propname</span><span class="p">]</span> <span class="o">=</span> <span class="n">preproc_func</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close all managed SQL databases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates all registered tables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[depc] Initialize </span><span class="si">%s</span><span class="s1"> depcache in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">if</span> <span class="n">depc</span><span class="o">.</span><span class="n">_use_globals</span><span class="p">:</span>
            <span class="n">reg_preproc</span> <span class="o">=</span> <span class="n">PREPROC_REGISTER</span><span class="p">[</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">]</span>
            <span class="n">reg_subprop</span> <span class="o">=</span> <span class="n">SUBPROP_REGISTER</span><span class="p">[</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[depc.init] Registering </span><span class="si">%d</span><span class="s1"> global preproc funcs&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_preproc</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">args_</span><span class="p">,</span> <span class="n">_kwargs</span> <span class="ow">in</span> <span class="n">reg_preproc</span><span class="p">:</span>
                <span class="n">depc</span><span class="o">.</span><span class="n">_register_prop</span><span class="p">(</span><span class="o">*</span><span class="n">args_</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[depc.init] Registering </span><span class="si">%d</span><span class="s1"> global subprops &#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_subprop</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">args_</span><span class="p">,</span> <span class="n">_kwargs</span> <span class="ow">in</span> <span class="n">reg_subprop</span><span class="p">:</span>
                <span class="n">depc</span><span class="o">.</span><span class="n">_register_subprop</span><span class="p">(</span><span class="o">*</span><span class="n">args_</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span><span class="p">)</span>

        <span class="c1"># Memory filestore</span>
        <span class="c1"># if False:</span>
        <span class="c1">#    # http://docs.pyfilesystem.org/en/latest/getting_started.html</span>
        <span class="c1">#    pip install fs</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;:memory:&#39;</span><span class="p">:</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_ext</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;.sqlite&#39;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span>

                <span class="n">prefix_dpath</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">fname_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix_dpath</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="n">prefix_dpath</span><span class="p">))</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="n">fname_</span><span class="p">)</span>
            <span class="c1"># if ut.get_argflag(&#39;--clear-all-depcache&#39;):</span>
            <span class="c1">#     ut.delete(fpath)</span>
            <span class="n">db_uri</span> <span class="o">=</span> <span class="s1">&#39;file://</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">))</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">sql_control</span><span class="o">.</span><span class="n">SQLDatabaseController</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="n">db_uri</span><span class="p">)</span>
            <span class="n">depcache_table</span><span class="o">.</span><span class="n">ensure_config_table</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[depc] Finished initialization&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">table</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">)</span>

        <span class="c1"># HACKS:</span>
        <span class="c1"># Define injected functions for autocomplete convinience</span>
        <span class="k">class</span> <span class="nc">InjectedDepc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">depc</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">InjectedDepc</span><span class="p">()</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">InjectedDepc</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">d</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">w</span>
        <span class="n">inject_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;get_</span><span class="si">{tablename}</span><span class="s1">_rowids&#39;</span><span class="p">,</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;get_</span><span class="si">{tablename}</span><span class="s1">_config_history&#39;</span><span class="p">,</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_config_history</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">wobj</span> <span class="o">=</span> <span class="n">InjectedDepc</span><span class="p">()</span>
            <span class="c1"># Set nested version</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">wobj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dfmtstr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">inject_patterns</span><span class="p">:</span>
                <span class="n">funcname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="n">attrname</span> <span class="o">=</span> <span class="n">dfmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
                <span class="n">get_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
                <span class="c1"># Set flat version</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">get_rowids</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">wobj</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="n">dfmtstr</span> <span class="o">=</span> <span class="s1">&#39;get_</span><span class="si">{tablename}</span><span class="s1">_</span><span class="si">{colname}</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">:</span>
                <span class="n">get_prop</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
                <span class="n">attrname</span> <span class="o">=</span> <span class="n">dfmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
                <span class="c1"># Set flat version</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">get_prop</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">wobj</span><span class="p">,</span> <span class="s1">&#39;get_&#39;</span> <span class="o">+</span> <span class="n">colname</span><span class="p">,</span> <span class="n">get_prop</span><span class="p">)</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># GRAPH INSPECTION</span>

    <span class="k">def</span> <span class="nf">get_dependencies</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets level dependences from root to tablename</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control --exec-get_dependencies</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;fgweight&#39;</span>
<span class="sd">            &gt;&gt;&gt; result = ut.repr3(depc.get_dependencies(tablename), nl=1)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            [</span>
<span class="sd">                [&#39;dummy_annot&#39;],</span>
<span class="sd">                [&#39;chip&#39;, &#39;probchip&#39;],</span>
<span class="sd">                [&#39;keypoint&#39;],</span>
<span class="sd">                [&#39;fgweight&#39;],</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="p">,</span> <span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">tablename</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">root_tablename</span>
            <span class="n">children_</span><span class="p">,</span> <span class="n">parents_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">depc</span><span class="o">.</span><span class="n">get_edges</span><span class="p">()))</span>
            <span class="n">child_to_parents</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">children_</span><span class="p">,</span> <span class="n">parents_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERYVERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;root = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tablename = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;child_to_parents = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">child_to_parents</span><span class="p">),))</span>
            <span class="n">to_root</span> <span class="o">=</span> <span class="p">{</span><span class="n">tablename</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">paths_to_root</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">child_to_parents</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERYVERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;to_root = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_root</span><span class="p">,))</span>
            <span class="n">from_root</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">reverse_path</span><span class="p">(</span><span class="n">to_root</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">child_to_parents</span><span class="p">)</span>
            <span class="n">dependency_levels_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_levels</span><span class="p">(</span><span class="n">from_root</span><span class="p">)</span>
            <span class="n">dependency_levels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">longest_levels</span><span class="p">(</span><span class="n">dependency_levels_</span><span class="p">)</span>
            <span class="n">dependency_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">dependency_levels</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="s1">&#39;error getting dependencies&#39;</span><span class="p">,</span>
                <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">&#39;tablename&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;children_to_parents&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;to_root&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;from_root&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dependency_levels_&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dependency_levels&#39;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">dependency_levels</span>

    <span class="k">def</span> <span class="nf">_ensure_config</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a full table configuration with all defaults using config</span>

<span class="sd">        Args:</span>
<span class="sd">            tablekey (str): name of the table to grab config from</span>
<span class="sd">            config (dict): may be overspecified or underspecfied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configclass</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablekey</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># requestclass = depc.requestclass_dict.get(tablekey, None)</span>
        <span class="k">if</span> <span class="n">configclass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Grab the correct configclass for the current table</span>
            <span class="n">config_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">config_</span> <span class="o">=</span> <span class="n">configclass</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;_subconfig_attrs&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Get correct config for implicit dependencies</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="n">configclass</span><span class="p">()</span><span class="o">.</span><span class="n">get_config_name</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">target_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">_subconfig_names</span><span class="p">:</span>
                    <span class="n">_index</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_subconfig_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
                    <span class="n">subcfg_attr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_subconfig_attrs</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
                    <span class="n">config_</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">subcfg_attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">config_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Preferable way to get configs with explicit</span>
                <span class="c1"># configs</span>
                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; **config = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,))</span>
                <span class="n">config_</span> <span class="o">=</span> <span class="n">configclass</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; config_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">config_</span>

    <span class="k">def</span> <span class="nf">get_config_trail</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_all_nodes_between</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_topsort_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">tablename_list</span><span class="p">)</span>
        <span class="n">config_trail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tablekey</span> <span class="ow">in</span> <span class="n">tablename_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tablekey</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="p">:</span>
                <span class="n">config_</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_ensure_config</span><span class="p">(</span><span class="n">tablekey</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">config_trail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_trail</span>

    <span class="k">def</span> <span class="nf">get_config_trail_str</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">config_trail</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_config_trail</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">trail_cfgstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config_trail</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">trail_cfgstr</span>

    <span class="k">def</span> <span class="nf">_get_parent_input</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span>
        <span class="n">tablename</span><span class="p">,</span>
        <span class="n">root_rowids</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">recompute_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Get ancestor rowids that are descendants of root</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">rowid_dict</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_all_descendant_rowids</span><span class="p">(</span>
            <span class="n">tablename</span><span class="p">,</span>
            <span class="n">root_rowids</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">ensure</span><span class="o">=</span><span class="n">ensure</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
            <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">,</span>
            <span class="n">recompute_all</span><span class="o">=</span><span class="n">recompute_all</span><span class="p">,</span>
            <span class="n">_debug</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">countdown_flag</span><span class="p">(</span><span class="n">_debug</span><span class="p">),</span>
            <span class="n">levels_up</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_get_parent_rowids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_rowids</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># STATE GETTERS</span>

    <span class="k">def</span> <span class="nf">rectify_input_tuple</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">exi_inputs</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standardizes inputs allowed for convinience into the expected input for</span>
<span class="sd">        get_parent_rowids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_tuple_</span> <span class="o">=</span> <span class="n">input_tuple</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;#expected=</span><span class="si">%d</span><span class="s1">, #got=1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">),)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Did you forget to cast multi-inputs to a tuple?&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># Inputs should always be a tuple of lists.</span>
            <span class="n">input_tuple_</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_tuple_</span><span class="p">,)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># HACK: for simple case where we only need one parent</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">input_tuple_</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">input_tuple_</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_tuple_</span><span class="p">,)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;#expected=</span><span class="si">%d</span><span class="s1">, #got=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># rectify input depth</span>
        <span class="n">rectified_input</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_tuple_</span><span class="p">,</span> <span class="n">exi_inputs</span><span class="o">.</span><span class="n">expected_input_depth</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">rectified_input</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rectified_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_depth</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rectified_input</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rectified_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rectified_input</span>

    <span class="k">def</span> <span class="nf">get_parent_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">target_tablename</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the parent rowids needed to get / compute a property of</span>
<span class="sd">        tablename</span>

<span class="sd">        Args:</span>
<span class="sd">            input_tuple :</span>
<span class="sd">                to be explicit send in as a tuple of lists.  Each list</span>
<span class="sd">                corresponds to parent information needed by expanded rmis (root</span>
<span class="sd">                most input).</span>

<span class="sd">                Each item in the tuple correponds a root most node, and should</span>
<span class="sd">                be specified as a list of inputs. For single items this is a</span>
<span class="sd">                scalar, for multi-items it is a list.</span>

<span class="sd">                For example if you have a property like a chip that depends on</span>
<span class="sd">                only one parent, then to get the chips for the first N</span>
<span class="sd">                annotations your list input tuple is:</span>
<span class="sd">                    input_tuple = ([1, 2, 3, ..., N],)</span>

<span class="sd">                For a single multi inputs:</span>
<span class="sd">                If you want to get two vocabs for even and odd annots then you</span>
<span class="sd">                have:</span>
<span class="sd">                    ([[0, 2, 4, ...], [1, 3, 5, ...]],)</span>

<span class="sd">                For a single comparasion version multi inputs:</span>
<span class="sd">                If you want to query the first N annotats against two</span>
<span class="sd">                vocabs then you have:</span>
<span class="sd">                    ([1, 2, 3, ..., N], [[0, 2, 4, ...], [1, 3, 5, ...]],)</span>
<span class="sd">                (Note this only works if broadcasting is on)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_recompute</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recompute_all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_debug&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_hack_rootmost</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_hack_rootmost&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[GetParentID-</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_tablename</span><span class="p">,),</span> <span class="n">enabled</span><span class="o">=</span><span class="n">_debug</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">color_text</span><span class="p">(</span><span class="s1">&#39;Enter get_parent_rowids&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * target_tablename = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_tablename</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * input_tuple=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">input_tuple</span><span class="p">),))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * config = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,))</span>
            <span class="n">target_table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">target_tablename</span><span class="p">]</span>

            <span class="c1"># TODO: Expand to the appropriate given inputs</span>
            <span class="k">if</span> <span class="n">_hack_rootmost</span><span class="p">:</span>
                <span class="c1"># Hack: if true, we are given inputs in rootmost form</span>
                <span class="n">exi_inputs</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">rootmost_inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise we are given inputs in totalroot form</span>
                <span class="n">exi_inputs</span> <span class="o">=</span> <span class="n">target_table</span><span class="o">.</span><span class="n">rootmost_inputs</span><span class="o">.</span><span class="n">total_expand</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * exi_inputs=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exi_inputs</span><span class="p">,))</span>

            <span class="n">rectified_input</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">rectify_input_tuple</span><span class="p">(</span><span class="n">exi_inputs</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">)</span>

            <span class="n">rowid_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rmi</span><span class="p">,</span> <span class="n">rowids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">exi_inputs</span><span class="o">.</span><span class="n">rmi_list</span><span class="p">,</span> <span class="n">rectified_input</span><span class="p">):</span>
                <span class="n">rowid_dict</span><span class="p">[</span><span class="n">rmi</span><span class="p">]</span> <span class="o">=</span> <span class="n">rowids</span>

            <span class="n">compute_edges</span> <span class="o">=</span> <span class="n">exi_inputs</span><span class="o">.</span><span class="n">flat_compute_rmi_edges</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * rectified_input=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">rectified_input</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * compute_edges=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">compute_edges</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">input_nodes</span><span class="p">,</span> <span class="n">output_node</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compute_edges</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span>
                        <span class="s1">&#39; * COMPUTING </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> EDGE </span><span class="si">%r</span><span class="s1"> -- </span><span class="si">%r</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">compute_edges</span><span class="p">),</span> <span class="n">input_nodes</span><span class="p">,</span> <span class="n">output_node</span><span class="p">),</span>
                        <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">tablekey</span> <span class="o">=</span> <span class="n">output_node</span><span class="o">.</span><span class="n">tablename</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablekey</span><span class="p">]</span>
                <span class="n">input_nodes_</span> <span class="o">=</span> <span class="n">input_nodes</span>
                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;table.parent_id_tablenames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_id_tablenames</span><span class="p">,)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;input_nodes_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">input_nodes_</span><span class="p">,))</span>
                <span class="n">input_multi_flags</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">ismulti</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">exi_inputs</span><span class="o">.</span><span class="n">rmi_list</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">input_nodes_</span>
                <span class="p">]</span>

                <span class="c1"># Args currently go in like this:</span>
                <span class="c1"># args  = [..., (pid_{i,1}, pid_{i,2}, ..., pid_{i,M}), ...]</span>
                <span class="c1"># They get converted into</span>
                <span class="c1"># argsT = [... (pid_{1,j}, ... pid_{N,j}) ...]</span>
                <span class="c1"># i = row, j = col</span>
                <span class="n">sig_multi_flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
                <span class="n">parent_rowidsT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">rowid_dict</span><span class="p">,</span> <span class="n">input_nodes_</span><span class="p">)</span>
                <span class="n">parent_rowids_</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># TODO: will need to figure out which columns to zip and which</span>
                <span class="c1"># columns to product (ie take product over ones that have 1</span>
                <span class="c1"># item, and zip ones that have equal amount of items)</span>
                <span class="k">for</span> <span class="n">flag1</span><span class="p">,</span> <span class="n">flag2</span><span class="p">,</span> <span class="n">rowidsT</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">sig_multi_flags</span><span class="p">,</span> <span class="n">input_multi_flags</span><span class="p">,</span> <span class="n">parent_rowidsT</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">flag1</span> <span class="ow">and</span> <span class="n">flag2</span><span class="p">:</span>
                        <span class="n">parent_rowids_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowidsT</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">flag1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag2</span><span class="p">:</span>
                        <span class="n">parent_rowids_</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rowidsT</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">flag1</span> <span class="ow">and</span> <span class="n">flag2</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowidsT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">parent_rowids_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowidsT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent_rowids_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowidsT</span><span class="p">)</span>
                <span class="c1"># Assume that we are either given corresponding lists or single values</span>
                <span class="c1"># that must be broadcast.</span>
                <span class="n">rowlens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">parent_rowids_</span><span class="p">))</span>
                <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rowlens</span><span class="p">)</span>
                <span class="n">parent_rowids2_</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">r</span> <span class="o">*</span> <span class="n">maxlen</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">parent_rowids_</span>
                <span class="p">]</span>
                <span class="n">_parent_rowids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">parent_rowids2_</span><span class="p">))</span>
                <span class="c1"># _parent_rowids = list(ut.product(*parent_rowids_))</span>

                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;parent_rowids_ = </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">parent_rowids_</span><span class="p">],</span>
                                <span class="n">strvals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;parent_rowids2_ = </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">parent_rowids2_</span><span class="p">],</span>
                                <span class="n">strvals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;_parent_rowids = </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span>
                                <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">_parent_rowids</span><span class="p">],</span>
                                    <span class="n">strvals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;-------------&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_node</span><span class="o">.</span><span class="n">tablename</span> <span class="o">!=</span> <span class="n">target_tablename</span><span class="p">:</span>
                    <span class="c1"># Get table configuration</span>
                    <span class="n">config_</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_ensure_config</span><span class="p">(</span><span class="n">tablekey</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="p">)</span>

                    <span class="n">output_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_rowid</span><span class="p">(</span>
                        <span class="n">_parent_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">_recompute</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span>
                    <span class="p">)</span>
                    <span class="n">rowid_dict</span><span class="p">[</span><span class="n">output_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rowids</span>
                    <span class="c1"># table.get_model_inputs(table.get_model_uuid(output_rowids)[0])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We are only computing up to the parents of the table here.</span>
                    <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">_parent_rowids</span>
                    <span class="k">break</span>
            <span class="c1"># rowids = rowid_dict[output_node]</span>
            <span class="k">return</span> <span class="n">parent_rowids</span>

    <span class="k">def</span> <span class="nf">check_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of flags where True means the row has been computed and</span>
<span class="sd">        False means that it needs to be computed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">(</span>
            <span class="n">tablename</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_not_None_items</span><span class="p">(</span><span class="n">existing_rowids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flags</span>

    <span class="k">def</span> <span class="nf">get_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">rowid_kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to get tablename rowids. Ensures rows exist unless ensure=False.</span>
<span class="sd">        rowids uniquely specify parent inputs and a configuration.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control get_rowids --show</span>
<span class="sd">            python -m dtool.depcache_control get_rowids:1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(True)</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(depc.get), globals())</span>
<span class="sd">            &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; root_rowids2 = [(4, 5, 6, 7)]</span>
<span class="sd">            &gt;&gt;&gt; root_rowids3 = root_rowids2</span>
<span class="sd">            &gt;&gt;&gt; _debug = True</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;smk_match&#39;</span>
<span class="sd">            &gt;&gt;&gt; input_tuple = (root_rowids, root_rowids2, root_rowids3)</span>
<span class="sd">            &gt;&gt;&gt; target_table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; inputs = target_table.rootmost_inputs.total_expand()</span>
<span class="sd">            &gt;&gt;&gt; depc.get_rowids(tablename, input_tuple, _debug=_debug)</span>
<span class="sd">            &gt;&gt;&gt; depc.print_all_tables()</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Test external / ensure getters</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; aids = [1,]</span>
<span class="sd">            &gt;&gt;&gt; depc.delete_property(&#39;keypoint&#39;, aids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; chip_fpaths = depc.get(&#39;chip&#39;, aids, &#39;chip&#39;, config=config, read_extern=False)</span>
<span class="sd">            &gt;&gt;&gt; ut.remove_file_list(chip_fpaths)</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;keypoint&#39;, aids, ensure=True, config=config)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;rowids = %r&#39; % (rowids,))</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [1, 2]</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; # Recompute the first few, make sure the rowids do not change</span>
<span class="sd">            &gt;&gt;&gt; _ = depc.get_rowids(&#39;chip&#39;, root_rowids + [3], config=config)</span>
<span class="sd">            &gt;&gt;&gt; assert _ == [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; initial_rowids = depc.get_rowids(&#39;chip&#39;, root_rowids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; recomp_rowids = depc.get_rowids(&#39;chip&#39;, root_rowids, config=config, recompute=True)</span>
<span class="sd">            &gt;&gt;&gt; assert recomp_rowids == initial_rowids, &#39;rowids should not change due to recompute&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_tablename</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">rowid_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_debug&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="n">_kwargs</span> <span class="o">=</span> <span class="n">rowid_kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">_hack_rootmost</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_hack_rootmost&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_recompute_all</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recompute_all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">recompute</span> <span class="o">=</span> <span class="n">_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="n">_recompute_all</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">target_tablename</span><span class="p">]</span>

        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span>
            <span class="n">target_tablename</span><span class="p">,</span>
            <span class="n">input_tuple</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">_hack_rootmost</span><span class="o">=</span><span class="n">_hack_rootmost</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[GetRowId-</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_tablename</span><span class="p">,),</span> <span class="n">enabled</span><span class="o">=</span><span class="n">_debug</span><span class="p">):</span>
            <span class="n">config_</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_ensure_config</span><span class="p">(</span><span class="n">target_tablename</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="p">)</span>
            <span class="n">rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_rowid</span><span class="p">(</span>
                <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">rowids</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">accepts_scalar_input2</span><span class="p">(</span><span class="n">argx_list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span>
        <span class="n">tablename</span><span class="p">,</span>
        <span class="n">root_rowids</span><span class="p">,</span>
        <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">recompute_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_extern</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">onthefly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">hack_paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access dependant properties the primary objects using primary ids.</span>

<span class="sd">        Gets the data in `colnames` of `tablename` that correspond to</span>
<span class="sd">        `root_rowids` using `config`.  if colnames is None, all columns are</span>
<span class="sd">        returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str): table name containing desired property</span>
<span class="sd">            root_rowids (List[int]): ids of the root object</span>
<span class="sd">            colnames (None): desired property (default = None)</span>
<span class="sd">            config (None): (default = None)</span>
<span class="sd">            read_extern: if False then only returns extern URI</span>
<span class="sd">            hack_paths: if False then does not compute extern info just returns</span>
<span class="sd">                path that it will be located at</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: prop_list</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control --exec-get</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(True)</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(depc.get), globals())</span>
<span class="sd">            &gt;&gt;&gt; aids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; _debug = True</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;labeler&#39;</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = aids</span>
<span class="sd">            &gt;&gt;&gt; prop_list = depc.get(</span>
<span class="sd">            &gt;&gt;&gt;     tablename, root_rowids, colnames)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;prop_list = %s&#39; % (ut.repr2(prop_list),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            prop_list = [(&#39;labeler([root(1)]:42)&#39;,), (&#39;labeler([root(2)]:42)&#39;,), (&#39;labeler([root(3)]:42)&#39;,)]</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(True)</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(depc.get), globals())</span>
<span class="sd">            &gt;&gt;&gt; aids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; _debug = True</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;smk_match&#39;</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;vocab&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [aids]</span>
<span class="sd">            &gt;&gt;&gt; prop_list = depc.get(</span>
<span class="sd">            &gt;&gt;&gt;     tablename, root_rowids, colnames, config)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;prop_list = %s&#39; % (ut.repr2(prop_list),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            prop_list = [(&#39;vocab([root(1;2;3)]:42)&#39;,)]</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(True)</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(depc.get), globals())</span>
<span class="sd">            &gt;&gt;&gt; aids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; _debug = True</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;chip&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = aids</span>
<span class="sd">            &gt;&gt;&gt; # Ensure chips are computed</span>
<span class="sd">            &gt;&gt;&gt; prop_list1 = depc.get(tablename, root_rowids)</span>
<span class="sd">            &gt;&gt;&gt; # Get file paths and delete them</span>
<span class="sd">            &gt;&gt;&gt; prop_list2 = depc.get(tablename, root_rowids, read_extern=False)</span>
<span class="sd">            &gt;&gt;&gt; n = ut.remove_file_list(ut.take_column(prop_list2, 1))</span>
<span class="sd">            &gt;&gt;&gt; assert n == len(prop_list2), &#39;files were not computed&#39;</span>
<span class="sd">            &gt;&gt;&gt; prop_list3 = depc.get(tablename, root_rowids)</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(prop_list1[0][1] == prop_list3[0][1]), &#39;computed same info&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tablename</span> <span class="o">==</span> <span class="n">depc</span><span class="o">.</span><span class="n">root_tablename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">root_getters</span><span class="p">[</span><span class="n">colnames</span><span class="p">](</span><span class="n">root_rowids</span><span class="p">)</span>
            <span class="c1"># pass</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[GetProp-</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,),</span> <span class="n">enabled</span><span class="o">=</span><span class="n">_debug</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * tablename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * root_rowids=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * colnames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colnames</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * config = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">hack_paths</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ensure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">read_extern</span><span class="p">:</span>
                <span class="c1"># HACK: should be able to not compute rows to get certain properties</span>
                <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>

                <span class="c1"># recompute_ = recompute or recompute_all</span>
                <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span>
                    <span class="n">tablename</span><span class="p">,</span>
                    <span class="n">root_rowids</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">recompute_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">config_</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_ensure_config</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * (ensured) config_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_</span><span class="p">,))</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                <span class="n">extern_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">extern_dpath</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="ow">or</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span><span class="p">)</span>
                <span class="n">fname_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_extern_fnames</span><span class="p">(</span>
                    <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_</span><span class="p">,</span> <span class="n">extern_col_index</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
                <span class="n">fpath_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">fpath_list</span>

            <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">):</span>
                <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">)</span>

            <span class="n">rowid_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
                <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
                <span class="n">ensure</span><span class="o">=</span><span class="n">ensure</span><span class="p">,</span>
                <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">,</span>
                <span class="n">recompute_all</span><span class="o">=</span><span class="n">recompute_all</span><span class="p">,</span>
                <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">rowdata_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">read_extern</span><span class="o">=</span><span class="n">read_extern</span><span class="p">,</span>
                <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">,</span>
                <span class="n">num_retries</span><span class="o">=</span><span class="n">num_retries</span><span class="p">,</span>
                <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
                <span class="n">ensure</span><span class="o">=</span><span class="n">ensure</span><span class="p">,</span>
                <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">input_tuple</span> <span class="o">=</span> <span class="n">root_rowids</span>

            <span class="k">for</span> <span class="n">trynum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
                    <span class="c1"># Vectorized get of properties</span>
                    <span class="n">tbl_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">input_tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">rowid_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;[depc.get] tbl_rowids = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">),)</span>
                        <span class="p">)</span>
                    <span class="n">prop_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_data</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="o">**</span><span class="n">rowdata_kw</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">depcache_table</span><span class="o">.</span><span class="n">ExternalStorageException</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;!!* Hit ExternalStorageException&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">trynum</span> <span class="o">==</span> <span class="n">num_retries</span><span class="p">:</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;* return prop_list=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">prop_list</span><span class="p">),))</span>
        <span class="k">return</span> <span class="n">prop_list</span>

    <span class="k">def</span> <span class="nf">get_native</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_extern</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets data using internal ids, which is faster if you have them.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control get_native:0</span>
<span class="sd">            python -m dtool.depcache_control get_native:1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Simple test of get native</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;keypoint&#39;</span>
<span class="sd">            &gt;&gt;&gt; aids = [1,]</span>
<span class="sd">            &gt;&gt;&gt; tbl_rowids = depc.get_rowids(tablename, aids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get_native(tablename, tbl_rowids)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;chip&#39;</span>
<span class="sd">            &gt;&gt;&gt; colnames = extern_colname = &#39;chip&#39;</span>
<span class="sd">            &gt;&gt;&gt; aids = [1, 2]</span>
<span class="sd">            &gt;&gt;&gt; depc.delete_property(tablename, aids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; # Ensure chip rowids exist then delete external data without</span>
<span class="sd">            &gt;&gt;&gt; # notifying the depcache. This forces the depcache to recover</span>
<span class="sd">            &gt;&gt;&gt; tbl_rowids = chip_rowids = depc.get_rowids(tablename, aids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; data_fpaths = depc.get(tablename, aids, extern_colname, config=config, read_extern=False)</span>
<span class="sd">            &gt;&gt;&gt; ut.remove_file_list(data_fpaths)</span>
<span class="sd">            &gt;&gt;&gt; chips = depc.get_native(tablename, tbl_rowids, extern_colname)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;chips = %r&#39; % (chips,))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_rowids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[GetNative </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,),</span> <span class="n">enabled</span><span class="o">=</span><span class="n">_debug</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * tablename = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * colnames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colnames</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; * tbl_rowids=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)))</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="c1"># import utool</span>
            <span class="c1"># with utool.embed_on_exception_context:</span>
            <span class="c1"># try:</span>
            <span class="n">prop_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_data</span><span class="p">(</span>
                <span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">,</span> <span class="n">read_extern</span><span class="o">=</span><span class="n">read_extern</span>
            <span class="p">)</span>
            <span class="c1"># except depcache_table.ExternalStorageException:</span>
            <span class="c1">#    # This code is a bit rendant and would probably live better elsewhere</span>
            <span class="c1">#    # Also need to fix issues if more than one column specified</span>
            <span class="c1">#    extern_uris = table.get_row_data(</span>
            <span class="c1">#        tbl_rowids, colnames, _debug=_debug, read_extern=False,</span>
            <span class="c1">#        delete_on_fail=True, ensure=False)</span>
            <span class="c1">#    from os.path import exists</span>
            <span class="c1">#    error_flags = [exists(uri) for uri in extern_uris]</span>
            <span class="c1">#    redo_rowids = ut.compress(tbl_rowids, ut.not_list(error_flags))</span>
            <span class="c1">#    parent_rowids = table.get_parent_rowids(redo_rowids)</span>
            <span class="c1">#    # config_rowids = table.get_row_cfgid(redo_rowids)</span>
            <span class="c1">#    configs = table.get_row_configs(redo_rowids)</span>
            <span class="c1">#    assert ut.allsame(list(map(id, configs))), &#39;more than one config not yet supported&#39;</span>
            <span class="c1">#    config = configs[0]</span>
            <span class="c1">#    table.get_rowid(parent_rowids, recompute=True, config=config)</span>

            <span class="c1">#    # TRY ONE MORE TIME</span>
            <span class="c1">#    prop_list = table.get_row_data(tbl_rowids, colnames, _debug=_debug,</span>
            <span class="c1">#                                   read_extern=read_extern,</span>
            <span class="c1">#                                   delete_on_fail=False)</span>
        <span class="k">return</span> <span class="n">prop_list</span>

    <span class="k">def</span> <span class="nf">get_config_history</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Vectorized get of properties</span>
        <span class="n">tbl_rowids</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">get_config_history</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_root_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">native_rowids</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            native_rowids (list):</span>

<span class="sd">        Returns:</span>
<span class="sd">            list:</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control get_root_rowids --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; config1 = {&#39;adapt_shape&#39;: False}</span>
<span class="sd">            &gt;&gt;&gt; config2 = {&#39;adapt_shape&#39;: True}</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [2, 3, 5, 7]</span>
<span class="sd">            &gt;&gt;&gt; native_rowids1 = depc.get_rowids(&#39;keypoint&#39;, root_rowids, config=config1)</span>
<span class="sd">            &gt;&gt;&gt; native_rowids2 = depc.get_rowids(&#39;keypoint&#39;, root_rowids, config=config2)</span>
<span class="sd">            &gt;&gt;&gt; ancestor_rowids1 = list(depc.get_root_rowids(&#39;keypoint&#39;, native_rowids1))</span>
<span class="sd">            &gt;&gt;&gt; ancestor_rowids2 = list(depc.get_root_rowids(&#39;keypoint&#39;, native_rowids2))</span>
<span class="sd">            &gt;&gt;&gt; assert native_rowids1 != native_rowids2, &#39;should have different native rowids&#39;</span>
<span class="sd">            &gt;&gt;&gt; assert ancestor_rowids1 == root_rowids, &#39;should have same root&#39;</span>
<span class="sd">            &gt;&gt;&gt; assert ancestor_rowids2 == root_rowids, &#39;should have same root&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_ancestor_rowids</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">native_rowids</span><span class="p">,</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ancestor_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">native_rowids</span><span class="p">,</span> <span class="n">ancestor_tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ancestor_tablename = depc.root; native_rowids = cid_list; tablename = const.CHIP_TABLE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ancestor_tablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ancestor_tablename</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">ancestor_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_ancestor_rowids</span><span class="p">(</span><span class="n">native_rowids</span><span class="p">,</span> <span class="n">ancestor_tablename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ancestor_rowids</span>

    <span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; creates a request for data that can be executed later &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[depc] NEW </span><span class="si">%s</span><span class="s1"> request&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,))</span>
        <span class="n">requestclass</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">requestclass_dict</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">requestclass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># STATE MODIFIERS</span>

    <span class="k">def</span> <span class="nf">delete_property</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the rowids of `tablename` that correspond to `root_rowids`</span>
<span class="sd">        using `config`.</span>

<span class="sd">        FIXME: make this work for all configs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">(</span>
            <span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">num_deleted</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_deleted</span>

    <span class="k">def</span> <span class="nf">delete_property_all</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the rowids of `tablename` that correspond to `root_rowids`</span>
<span class="sd">        using `config`.</span>

<span class="sd">        FIXME: make this work for all configs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
        <span class="n">all_rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_all_rowids</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">ancestor_rowid_list</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_ancestor_rowids</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">all_rowid_list</span><span class="p">)</span>

        <span class="n">rowid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">root_rowids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">ancestor_rowid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_rowid_list</span><span class="p">,</span> <span class="n">ancestor_rowid_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ancestor_rowid</span> <span class="ow">in</span> <span class="n">root_rowids_set</span><span class="p">:</span>
                <span class="n">rowid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span>

        <span class="n">num_deleted</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_deleted</span>


<div class="viewcode-block" id="DependencyCache"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DependencyCache</span><span class="p">(</span><span class="n">_CoreDependencyCache</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Currently, to use this class a user must:</span>
<span class="sd">        * on root modification, call depc.on_root_modified</span>
<span class="sd">        * use decorators to register relevant functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span>
        <span class="n">root_tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dpath</span><span class="o">=</span><span class="s1">&#39;./DEPCACHE&#39;</span><span class="p">,</span>
        <span class="n">controller</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default_fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="c1"># root_asobject=None,</span>
        <span class="n">get_root_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">root_getters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_globals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">default_fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_fname</span> <span class="o">=</span> <span class="n">root_tablename</span> <span class="o">+</span> <span class="s1">&#39;_primary_cache&#39;</span>
            <span class="c1"># default_fname = &#39;:memory:&#39;</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">root_getters</span> <span class="o">=</span> <span class="n">root_getters</span>
        <span class="c1"># Root of all dependencies</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">root_tablename</span> <span class="o">=</span> <span class="n">root_tablename</span>
        <span class="c1"># Directory all cachefiles are stored in</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="n">cache_dpath</span><span class="p">)</span>
        <span class="c1"># Parent (ibs) controller</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="c1"># Internal dictionary of dependant tables</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">requestclass_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">resultclass_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Mapping of different files properties are stored in</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Function to map a root rowid to an object</span>
        <span class="c1"># depc._root_asobject = root_asobject</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">_use_globals</span> <span class="o">=</span> <span class="n">use_globals</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">default_fname</span> <span class="o">=</span> <span class="n">default_fname</span>
        <span class="k">if</span> <span class="n">get_root_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;WARNING NEED UUID FUNCTION&#39;</span><span class="p">)</span>
            <span class="c1"># HACK</span>
            <span class="n">get_root_uuid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">identity</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">get_root_uuid</span> <span class="o">=</span> <span class="n">get_root_uuid</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--debug-depcache&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug-depc&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="DependencyCache.get_tablenames"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.get_tablenames">[docs]</a>    <span class="k">def</span> <span class="nf">get_tablenames</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tablenames</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_tablenames</span><span class="p">()</span>

<div class="viewcode-block" id="DependencyCache.print_schemas"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.print_schemas">[docs]</a>    <span class="k">def</span> <span class="nf">print_schemas</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fname = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,))</span>
            <span class="n">db</span><span class="o">.</span><span class="n">print_schema</span><span class="p">()</span></div>

    <span class="c1"># def print_table_csv(depc, tablename):</span>
    <span class="c1">#    depc[tablename]</span>

<div class="viewcode-block" id="DependencyCache.print_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.print_table">[docs]</a>    <span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">print_table</span><span class="p">()</span></div>

<div class="viewcode-block" id="DependencyCache.print_all_tables"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.print_all_tables">[docs]</a>    <span class="k">def</span> <span class="nf">print_all_tables</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">table</span><span class="o">.</span><span class="n">print_table</span><span class="p">()</span></div>
            <span class="c1"># db = table.db</span>
            <span class="c1"># db.print_table_csv(tablename)</span>

<div class="viewcode-block" id="DependencyCache.print_config_tables"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.print_config_tables">[docs]</a>    <span class="k">def</span> <span class="nf">print_config_tables</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;db_fname = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,))</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">print_table_csv</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DependencyCache.get_edges"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.get_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        edges for networkx structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">get_edgedata</span><span class="p">(</span><span class="n">tablekey</span><span class="p">,</span> <span class="n">parentkey</span><span class="p">,</span> <span class="n">parent_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]:</span>
                    <span class="n">edge_type_parts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># local_input_id = &#39;&#39;</span>
                    <span class="k">if</span> <span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]:</span>
                        <span class="c1"># TODO: give different ids to multi edges</span>
                        <span class="c1"># edge_type_parts.append(&#39;multi_%s_%s&#39; % (parentkey, tablekey))</span>
                        <span class="n">edge_type_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;multi&#39;</span><span class="p">)</span>
                        <span class="c1"># local_input_id += &#39;*&#39;</span>
                    <span class="k">if</span> <span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;nwise_idx&#39;</span><span class="p">],)</span>
                        <span class="n">edge_type_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nwise_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
                        <span class="c1"># local_input_id += six.text_type(parent_data[&#39;nwise_idx&#39;])</span>
                        <span class="c1"># edge_type_parts.append(&#39;nwise_%s_%s_%s&#39; % (</span>
                        <span class="c1">#     parentkey, tablekey, parent_data[&#39;nwise_idx&#39;],))</span>
                    <span class="n">edge_type_id</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edge_type_parts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_type_id</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
                    <span class="c1"># local_input_id = &#39;1&#39;</span>
                <span class="n">edge_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;ismulti&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;isnwise&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isnwise&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;nwise_idx&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nwise_idx&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;parent_colx&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_colx&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;edge_type&#39;</span><span class="p">:</span> <span class="n">edge_type_id</span><span class="p">,</span>
                    <span class="c1"># &#39;local_input_id&#39;: local_input_id,</span>
                    <span class="s1">&#39;local_input_id&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;taillabel&#39;</span><span class="p">:</span> <span class="n">parent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">),</span>
                    <span class="c1"># &#39;taillabel&#39;: local_input_id,  # proper graphviz attribute</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">edge_data</span>

            <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">parentkey</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">get_edgedata</span><span class="p">(</span><span class="n">tablekey</span><span class="p">,</span> <span class="n">parentkey</span><span class="p">,</span> <span class="n">parent_data</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">parentkey</span><span class="p">,</span> <span class="n">parent_data</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">parentkey</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">parentkey</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">edges</span></div>

<div class="viewcode-block" id="DependencyCache.get_implicit_edges"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.get_implicit_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_implicit_edges</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edges defined by subconfigurations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add implicit edges</span>
        <span class="n">implicit_edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Map config classes to tablenames</span>
        <span class="n">_inverted_ccdict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invert_dict</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tablename2</span><span class="p">,</span> <span class="n">configclass</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">configclass</span><span class="p">()</span>
            <span class="n">subconfigs</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_sub_config_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">subconfigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">subconfigs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tablename1_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">_inverted_ccdict</span><span class="p">,</span> <span class="n">subconfigs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tablename1</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">tablename1_list</span><span class="p">):</span>
                    <span class="n">implicit_edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tablename1</span><span class="p">,</span> <span class="n">tablename2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">implicit_edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;implicit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">implicit_edges</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">implicit_edges</span></div>

<div class="viewcode-block" id="DependencyCache.make_graph"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.make_graph">[docs]</a>    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">make_graph</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a networkx representation of the dependency graph</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool --tf DependencyCache.make_graph --show --reduced</span>

<span class="sd">            python -m wbia.control.IBEISControl show_depc_annot_graph --show --reduced</span>

<span class="sd">            python -m wbia.control.IBEISControl show_depc_annot_graph --show --reduced --testmode</span>
<span class="sd">            python -m wbia.control.IBEISControl show_depc_annot_graph --show --testmode</span>

<span class="sd">            python -m wbia.control.IBEISControl --test-show_depc_image_graph --show --reduced</span>
<span class="sd">            python -m wbia.control.IBEISControl --test-show_depc_image_graph --show</span>

<span class="sd">            python -m wbia.scripts.specialdraw double_depcache_graph --show --testmode</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; import utool as ut</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; graph = depc.make_graph(reduced=ut.get_argflag(&#39;--reduced&#39;))</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; pt.ensureqt()</span>
<span class="sd">            &gt;&gt;&gt; import networkx as nx</span>
<span class="sd">            &gt;&gt;&gt; #pt.show_nx(nx.dag.transitive_closure(graph))</span>
<span class="sd">            &gt;&gt;&gt; #pt.show_nx(ut.nx_transitive_reduction(graph))</span>
<span class="sd">            &gt;&gt;&gt; pt.show_nx(graph)</span>
<span class="sd">            &gt;&gt;&gt; pt.show_nx(graph, layout=&#39;agraph&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; import utool as ut</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; graph = depc.make_graph(reduced=True)</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; pt.ensureqt()</span>
<span class="sd">            &gt;&gt;&gt; import networkx as nx</span>
<span class="sd">            &gt;&gt;&gt; #pt.show_nx(nx.dag.transitive_closure(graph))</span>
<span class="sd">            &gt;&gt;&gt; #pt.show_nx(ut.nx_transitive_reduction(graph))</span>
<span class="sd">            &gt;&gt;&gt; pt.show_nx(graph)</span>
<span class="sd">            &gt;&gt;&gt; pt.show_nx(graph, layout=&#39;agraph&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

        <span class="c1"># graph = nx.DiGraph()</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">implicit_edges</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_implicit_edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">implicit_edges</span><span class="p">)</span>

        <span class="n">shape_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &#39;node&#39;: &#39;circle&#39;,</span>
            <span class="c1"># &#39;node&#39;: &#39;rect&#39;,</span>
            <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;root&#39;: &#39;rhombus&#39;,</span>
            <span class="c1"># &#39;root&#39;: &#39;circle&#39;,</span>
            <span class="c1"># &#39;root&#39;: &#39;circle&#39;,</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;root&#39;: &#39;rect&#39;,</span>
        <span class="p">}</span>
        <span class="c1"># import wbia.plottool as pt</span>
        <span class="n">NEUTRAL_BLUE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">159</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">RED</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &#39;algo&#39;: pt.DARK_GREEN,  # &#39;g&#39;,</span>
            <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="n">NEUTRAL_BLUE</span><span class="p">,</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">RED</span><span class="p">,</span>  <span class="c1"># &#39;r&#39;,</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">_node_attrs</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">props</span><span class="p">[</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">props</span>

        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">_node_attrs</span><span class="p">(</span><span class="n">color_dict</span><span class="p">))</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">_node_attrs</span><span class="p">(</span><span class="n">shape_dict</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reduced&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># FIXME; There is a bug in the reduction of the image depc graph</span>
            <span class="c1"># Reduce only the non-multi part of the graph</span>
            <span class="n">nonmulti_graph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">multi_data_edges</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">multi_edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">multi_data_edges</span><span class="p">]</span>
            <span class="n">nonmulti_graph</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">multi_edges</span><span class="p">)</span>

            <span class="c1"># Hack to recognize that implicit edges on multi-input edges</span>
            <span class="c1"># PROBABLY means that the implicit edge is also a multi edge This</span>
            <span class="c1"># needs to be fixed by indicating which parent edge the implicit</span>
            <span class="c1"># edge actually corresponds to.</span>
            <span class="n">multi_data_edges_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">multi_data_edges</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">in_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nonmulti_graph</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">in_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># If there is only one implicit edge on a multi-edge, it very</span>
                    <span class="c1"># likely means that the implicit edge should have the same</span>
                    <span class="c1"># input-id as the multi-edge</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">):</span>
                        <span class="n">nonmulti_graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="c1"># hack the multi-edge to reduce to the implicit version</span>
                    <span class="n">new_edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">multi_data_edges_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_edge</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">multi_data_edges_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="n">multi_data_edges</span> <span class="o">=</span> <span class="n">multi_data_edges_</span>

            <span class="c1"># &lt;ATTEMPT&gt;</span>
            <span class="c1"># The transitive reduction should respect impolicit edges,</span>
            <span class="c1"># but the end result should not contain any implicit edges</span>

            <span class="c1"># Transitive reduction wrt implicit edges</span>
            <span class="c1"># For every node...</span>
            <span class="n">implicit_aware</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">implicit_aware</span><span class="p">:</span>
                <span class="n">removed_in_edges</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                    <span class="n">in_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="c1"># if there is an implicit incoming edge</span>
                    <span class="n">implicit_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">in_edges</span><span class="p">]</span>
                    <span class="n">explicit_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">implicit_flags</span><span class="p">)</span>
                    <span class="n">implicit_edges</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">in_edges</span><span class="p">,</span> <span class="n">implicit_flags</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">implicit_edges</span><span class="p">:</span>
                        <span class="c1"># Ignore this edge if there is a common descendant</span>
                        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_common_descendants</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">pass</span>
                            <span class="c1"># removed_in_edges[node] = implicit_edges</span>
                            <span class="c1"># flag = False</span>

                    <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">implicit_edges</span><span class="p">):</span>
                        <span class="c1"># then remove all non-implicit incoming edges</span>
                        <span class="n">remove_non_implicit</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">in_edges</span><span class="p">,</span> <span class="n">explicit_flags</span><span class="p">)</span>
                        <span class="c1"># remember this nodes removed in edges</span>
                        <span class="n">removed_in_edges</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_non_implicit</span>
                <span class="n">to_remove2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">removed_in_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">nonmulti_graph</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">to_remove2</span><span class="p">)</span>

            <span class="n">graph_tr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_transitive_reduction</span><span class="p">(</span><span class="n">nonmulti_graph</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">implicit_aware</span><span class="p">:</span>
                <span class="c1"># Place old non-implicit structure on top of reduced implicit edges</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">removed_in_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">old_edges</span> <span class="o">=</span> <span class="n">removed_in_edges</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph_tr</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">old_edge</span> <span class="ow">in</span> <span class="n">old_edges</span><span class="p">:</span>
                            <span class="c1"># TODO: handle multiple old edges</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;implicit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># HACK IN STRUCTURE</span>
            <span class="c1"># Multi Edges</span>
            <span class="c1"># (doesn&#39;t quite work)</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">):</span>
                        <span class="n">new_parent</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph_tr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="c1"># graph_tr[new_parent][v][0][&#39;is_multi&#39;] = True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NEW MULTI&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="n">new_parent</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                        <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span>
                            <span class="n">graph_tr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ismulti&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">{(</span><span class="n">new_parent</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="kc">True</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="c1"># logger.info(v)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="n">graph_tr</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">multi_data_edges</span><span class="p">)</span>

            <span class="n">parents</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">parents</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">num_connect</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
                <span class="n">nwise_parents</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">num_connect</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nwise_parents</span><span class="p">:</span>
                    <span class="n">new_parent</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph_tr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">node</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># import utool</span>
                        <span class="c1"># utool.embed()</span>
                        <span class="n">graph_tr</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">new_parent</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                    <span class="c1"># G_tr[new_parent][v][0][&#39;is_multi&#39;] = True</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph_tr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">_node_attrs</span><span class="p">(</span><span class="n">color_dict</span><span class="p">))</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph_tr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">_node_attrs</span><span class="p">(</span><span class="n">shape_dict</span><span class="p">))</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_tr</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove_local_input_id&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">nx_delete_edge_attr</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s1">&#39;local_input_id&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">graph</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">explicit_graph</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reduced_graph</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">reduced</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="DependencyCache.show_graph"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.show_graph">[docs]</a>    <span class="k">def</span> <span class="nf">show_graph</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">reduced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper &quot;fluff&quot; function &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">reduced</span><span class="o">=</span><span class="n">reduced</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensureqt</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;agraph&#39;</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">show_nx</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="n">infostr_</span> <span class="o">=</span> <span class="s1">&#39;nTables=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">root_tablename</span><span class="p">,</span> <span class="n">infostr_</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="p">[</span><span class="n">tablekey</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">depc</span><span class="o">.</span><span class="n">root_tablename</span>

<div class="viewcode-block" id="DependencyCache.delete_root"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.delete_root">[docs]</a>    <span class="k">def</span> <span class="nf">delete_root</span><span class="p">(</span>
        <span class="n">depc</span><span class="p">,</span>
        <span class="n">root_rowids</span><span class="p">,</span>
        <span class="n">delete_extern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">table_config_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all properties of a root object regardless of config</span>

<span class="sd">        Args:</span>
<span class="sd">            root_rowids (list):</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control delete_root --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(depc.delete_root), globals())</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [1]</span>
<span class="sd">            &gt;&gt;&gt; depc.delete_root(root_rowids, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; depc.get(&#39;fgweight&#39;, [1])</span>
<span class="sd">            &gt;&gt;&gt; depc.delete_root(root_rowids, _debug=0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># graph = depc.make_graph(implicit=False)</span>
        <span class="c1"># hack</span>
        <span class="c1"># check to make sure child does not have another parent</span>
        <span class="n">rowid_dict</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_allconfig_descendant_rowids</span><span class="p">(</span>
            <span class="n">root_rowids</span><span class="p">,</span> <span class="n">table_config_filter</span>
        <span class="p">)</span>
        <span class="c1"># children = [child for child in graph.succ[depc.root_tablename]</span>
        <span class="c1">#            if sum([len(e) for e in graph.pred[child].values()]) == 1]</span>
        <span class="c1"># depc.delete_property(tablename, root_rowids, _debug=_debug)</span>
        <span class="n">num_deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">table_rowids</span> <span class="ow">in</span> <span class="n">rowid_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tablename</span> <span class="o">==</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Specific prop exclusion</span>
            <span class="n">delete_exclude_table_set_prop</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">delete_exclude_table_set_all</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tablename</span> <span class="ow">in</span> <span class="n">delete_exclude_table_set_prop</span>
                <span class="ow">or</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">delete_exclude_table_set_all</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="n">num_deleted</span> <span class="o">+=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">table_rowids</span><span class="p">,</span> <span class="n">delete_extern</span><span class="o">=</span><span class="n">delete_extern</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_deleted</span></div>

<div class="viewcode-block" id="DependencyCache.register_delete_table_exclusion"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.register_delete_table_exclusion">[docs]</a>    <span class="k">def</span> <span class="nf">register_delete_table_exclusion</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="p">:</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">delete_exclude_tables</span><span class="p">),)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[depc] Updated delete tables: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="DependencyCache.get_allconfig_descendant_rowids"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.get_allconfig_descendant_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">get_allconfig_descendant_rowids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">table_config_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

        <span class="c1"># list(nx.topological_sort(nx.bfs_tree(graph, depc.root)))</span>
        <span class="c1"># decendants = nx.descendants(graph, depc.root)</span>
        <span class="c1"># raise NotImplementedError()</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span>
        <span class="n">rowid_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rowid_dict</span><span class="p">[</span><span class="n">root</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_rowids</span>

        <span class="c1"># Find all rowids that inherit from the specific root rowids</span>
        <span class="n">sinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">nx_sink_nodes</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">target_tablename</span> <span class="ow">in</span> <span class="n">sinks</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">target_tablename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">itertwo</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">child_table</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>
                <span class="n">relevant_col_attrs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">attrs</span>
                    <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">child_table</span><span class="o">.</span><span class="n">parent_col_attrs</span>
                    <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent</span>
                <span class="p">]</span>
                <span class="n">parent_colnames</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">relevant_col_attrs</span>
                <span class="p">]</span>

                <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rowid_dict</span><span class="p">[</span><span class="n">parent</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">parent_colname</span> <span class="ow">in</span> <span class="n">parent_colnames</span><span class="p">:</span>
                    <span class="n">child_rowids</span> <span class="o">=</span> <span class="n">child_table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_where_eq_set</span><span class="p">(</span>
                        <span class="n">child_table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">child_table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">,),</span>
                        <span class="n">params_iter</span><span class="p">,</span>
                        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">where_colnames</span><span class="o">=</span><span class="p">[</span><span class="n">parent_colname</span><span class="p">],</span>
                        <span class="n">op</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># child_rowids = ut.flatten(child_rowids)</span>
                    <span class="k">if</span> <span class="n">table_config_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">config_filter</span> <span class="o">=</span> <span class="n">table_config_filter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">child_table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="kc">None</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">config_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># If a config filter is specified only grab rows that</span>
                            <span class="c1"># meed the filter</span>
                            <span class="n">tbl_cfgids</span> <span class="o">=</span> <span class="n">child_table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">child_rowids</span><span class="p">)</span>
                            <span class="n">cfgid2_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">child_rowids</span><span class="p">,</span> <span class="n">tbl_cfgids</span><span class="p">)</span>
                            <span class="n">unique_cfgids</span> <span class="o">=</span> <span class="n">cfgid2_rowids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">unique_cfgids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">unique_cfgids</span><span class="p">)</span>
                            <span class="n">unique_configs</span> <span class="o">=</span> <span class="n">child_table</span><span class="o">.</span><span class="n">get_config_from_rowid</span><span class="p">(</span>
                                <span class="n">unique_cfgids</span>
                            <span class="p">)</span>
                            <span class="n">passed_rowids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">cfgid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_configs</span><span class="p">,</span> <span class="n">tbl_cfgids</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span>
                                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config_filter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                    <span class="p">]</span>
                                <span class="p">):</span>
                                    <span class="n">passed_rowids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cfgid2_rowids</span><span class="p">[</span><span class="n">cfgid</span><span class="p">])</span>
                            <span class="n">child_rowids</span> <span class="o">=</span> <span class="n">passed_rowids</span>
                    <span class="n">rowid_dict</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                        <span class="n">child_rowids</span> <span class="o">+</span> <span class="n">rowid_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_dict</span></div>

<div class="viewcode-block" id="DependencyCache.notify_root_changed"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.notify_root_changed">[docs]</a>    <span class="k">def</span> <span class="nf">notify_root_changed</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">force_delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this is where we are notified that a &quot;registered&quot; root property has</span>
<span class="sd">        changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[depc] notified that columns (</span><span class="si">%s</span><span class="s1">) for (</span><span class="si">%d</span><span class="s1">) row(s) were modified&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">prop</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># for key in tables_depending_on(prop)</span>
        <span class="c1"># depc.delete_property(key, root_rowids)</span>
        <span class="c1"># TODO: check which properties were invalidated by this prop</span>
        <span class="c1"># TODO; remove invalidated properties</span>
        <span class="k">if</span> <span class="n">force_delete</span><span class="p">:</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">delete_root</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="DependencyCache.clear_all"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.clear_all">[docs]</a>    <span class="k">def</span> <span class="nf">clear_all</span><span class="p">(</span><span class="n">depc</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clearning all cached data in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depc</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">depc</span><span class="o">.</span><span class="n">cachetable_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">table</span><span class="o">.</span><span class="n">clear_table</span><span class="p">()</span></div>

<div class="viewcode-block" id="DependencyCache.make_root_info_uuid"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.make_root_info_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">make_root_info_uuid</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">info_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a uuid that depends on certain properties of the root object.</span>
<span class="sd">        This is used for implicit cache invalidation because, if those</span>
<span class="sd">        properties change then this uuid also changes.</span>

<span class="sd">        The depcache needs to know about stateful properties of dynamic root</span>
<span class="sd">        objects in order to correctly compute their hashes.</span>

<span class="sd">        &gt;&gt;&gt; #ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; root_rowids = ibs._get_all_aids()</span>
<span class="sd">        &gt;&gt;&gt; depc = ibs.depc_annot</span>
<span class="sd">        &gt;&gt;&gt; info_props = [&#39;image_uuid&#39;, &#39;verts&#39;, &#39;theta&#39;]</span>
<span class="sd">        &gt;&gt;&gt; info_props = [&#39;image_uuid&#39;, &#39;verts&#39;, &#39;theta&#39;, &#39;name&#39;, &#39;species&#39;, &#39;yaw&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">getters</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">root_getters</span><span class="p">,</span> <span class="n">info_props</span><span class="p">)</span>
        <span class="n">infotup_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">getter</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">)</span> <span class="k">for</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">getters</span><span class="p">])</span>
        <span class="n">info_uuid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">augment_uuid</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">infotup_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">info_uuid_list</span></div>

<div class="viewcode-block" id="DependencyCache.get_uuids"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.get_uuids">[docs]</a>    <span class="k">def</span> <span class="nf">get_uuids</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # TODO: Make uuids for dependant object based on root uuid and path of</span>
<span class="sd">        # construction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tablename</span> <span class="o">==</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">uuid_list</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_root_uuid</span><span class="p">(</span><span class="n">root_rowids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uuid_list</span></div>

    <span class="n">get_native_property</span> <span class="o">=</span> <span class="n">_CoreDependencyCache</span><span class="o">.</span><span class="n">get_native</span>
    <span class="n">get_property</span> <span class="o">=</span> <span class="n">_CoreDependencyCache</span><span class="o">.</span><span class="n">get</span>

<div class="viewcode-block" id="DependencyCache.stacked_config"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_control.DependencyCache.stacked_config">[docs]</a>    <span class="k">def</span> <span class="nf">stacked_config</span><span class="p">(</span><span class="n">depc</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_control stacked_config --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; source = depc.root</span>
<span class="sd">            &gt;&gt;&gt; dest = &#39;fgweight&#39;</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; stacked_config = depc.stacked_config(source, dest, config)</span>
<span class="sd">            &gt;&gt;&gt; cfgstr = stacked_config.get_cfgstr()</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;cfgstr = %s&#39; % (ut.repr2(cfgstr),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">make_graph</span><span class="p">(</span><span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">requires_tables</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">nx_all_nodes_between</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># requires_tables = ut.setdiff(ut.nx_all_nodes_between(depc.graph, &#39;annotations&#39;, &#39;featweight&#39;), [&#39;annotations&#39;])</span>
        <span class="n">requires_tables</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_topsort_nodes</span><span class="p">(</span><span class="n">depc</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">requires_tables</span><span class="p">)</span>
        <span class="n">requires_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="p">[</span><span class="n">tblname</span><span class="p">](</span><span class="o">**</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">tblname</span> <span class="ow">in</span> <span class="n">requires_tables</span>
        <span class="p">]</span>
        <span class="c1"># cfgstr_list = [cfg.get_cfgstr() for cfg in requires_configs]</span>
        <span class="n">stacked_config</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">StackedConfig</span><span class="p">(</span><span class="n">requires_configs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stacked_config</span></div></div>
        <span class="c1"># cfgstr = stacked_config.get_cfgstr()</span>
        <span class="c1"># cfgstr = &#39;_&#39;.join(cfgstr_list)</span>
        <span class="c1"># return cfgstr</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>