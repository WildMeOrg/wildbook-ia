
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.dtool.depcache_table &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.dtool.depcache_table</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module contining DependencyCacheTable</span>

<span class="sd">python -m dtool.depcache_control --exec-make_graph --show</span>
<span class="sd">python -m dtool.depcache_control --exec-make_graph --show --reduce</span>

<span class="sd">FIXME:</span>
<span class="sd">    RECTIFY: ismulti / ismodel need to be rectified. This indicate that this</span>
<span class="sd">        table recieves multiple inputs from at least one parent table.</span>

<span class="sd">    RECTIFY: Need to standardize parent rowids -vs- parent args.</span>
<span class="sd">        in one-to-one cases they are the same. In multi cases the rowids indicate</span>
<span class="sd">        a uuid and the args are the saved set of rowids that exist in the manifest.</span>

<span class="sd">    RECTIFY: is rowid_list row-major or column-major?</span>
<span class="sd">        I think currently rowid_list is row-major and rowid_listT is column-major</span>
<span class="sd">        but this may not be consistent.</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ubelt</span> <span class="k">as</span> <span class="nn">ub</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span>

<span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">sqlite3</span> <span class="k">as</span> <span class="n">lite</span>
<span class="kn">from</span> <span class="nn">wbia.dtool.sql_control</span> <span class="kn">import</span> <span class="n">SQLDatabaseController</span>
<span class="kn">from</span> <span class="nn">wbia.dtool.types</span> <span class="kn">import</span> <span class="n">TYPE_TO_SQLTYPE</span>

<span class="kn">import</span> <span class="nn">time</span>


<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;[depcache_table]&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<span class="n">EXTERN_SUFFIX</span> <span class="o">=</span> <span class="s1">&#39;_extern_uri&#39;</span>

<span class="n">CONFIG_TABLE</span> <span class="o">=</span> <span class="s1">&#39;config&#39;</span>
<span class="n">CONFIG_ROWID</span> <span class="o">=</span> <span class="s1">&#39;config_rowid&#39;</span>
<span class="n">CONFIG_HASHID</span> <span class="o">=</span> <span class="s1">&#39;config_hashid&#39;</span>
<span class="n">CONFIG_TABLENAME</span> <span class="o">=</span> <span class="s1">&#39;config_tablename&#39;</span>  <span class="c1"># tablename associated with config</span>
<span class="n">CONFIG_STRID</span> <span class="o">=</span> <span class="s1">&#39;config_strid&#39;</span>
<span class="n">CONFIG_DICT</span> <span class="o">=</span> <span class="s1">&#39;config_dict&#39;</span>


<span class="c1"># if ut.is_developer():</span>
<span class="c1">#     GRACE_PERIOD = 10</span>
<span class="c1"># else:</span>
<span class="n">GRACE_PERIOD</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--grace&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="ExternType"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.ExternType">[docs]</a><span class="k">class</span> <span class="nc">ExternType</span><span class="p">(</span><span class="n">ub</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type to denote an external resource not saved in an SQL table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_func</span><span class="p">,</span> <span class="n">write_func</span><span class="p">,</span> <span class="n">extern_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extkey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_func</span> <span class="o">=</span> <span class="n">write_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_func</span> <span class="o">=</span> <span class="n">read_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extern_ext</span> <span class="o">=</span> <span class="n">extern_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extkey</span> <span class="o">=</span> <span class="n">extkey</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extkey</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extkey</span> <span class="k">else</span> <span class="n">ext</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extern_ext</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extern_ext</span> <span class="ow">and</span> <span class="n">ext</span> <span class="k">else</span> <span class="n">ext</span>
        <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_func</span><span class="p">),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_func</span><span class="p">),</span>
            <span class="n">ext</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ExternalStorageException"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.ExternalStorageException">[docs]</a><span class="k">class</span> <span class="nc">ExternalStorageException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Indicates a missing external file &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExternalStorageException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="predrop_grace_period"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.predrop_grace_period">[docs]</a><span class="k">def</span> <span class="nf">predrop_grace_period</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Hack that gives the user some time to abort deleting everything &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">GRACE_PERIOD</span>
    <span class="n">warnmsg_fmt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WARNING TABLE={tablename} IS MODIFIED</span>

<span class="sd">        About to reset (DROP) entire cache={tablename}.</span>

<span class="sd">        Generally this is OK and you shouldnt worry because depcache</span>
<span class="sd">        information should be recomputable.</span>

<span class="sd">        If you really dont want this to happen you have {seconds} seconds to</span>
<span class="sd">        kill this process before deletion occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">GRACE_PERIOD</span>
        <span class="n">GRACE_PERIOD</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GRACE_PERIOD</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">warnmsg</span> <span class="o">=</span> <span class="n">warnmsg_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
    <span class="c1"># return ut.are_you_sure(warnmsg)</span>
    <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">grace_period</span><span class="p">(</span><span class="n">warnmsg</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_extern_io_funcs"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.make_extern_io_funcs">[docs]</a><span class="k">def</span> <span class="nf">make_extern_io_funcs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Hack in read/write defaults for pickleable classes &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_read_func</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># FIXME: The constructor should not be called by default to conform to</span>
        <span class="c1"># pickle standards</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;on_load&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_write_func</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;on_save&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_save</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_read_func</span><span class="p">,</span> <span class="n">_write_func</span></div>


<div class="viewcode-block" id="ensure_config_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.ensure_config_table">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">ensure_config_table</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; SQL definition of configuration table. &quot;&quot;&quot;</span>
    <span class="n">config_addtable_kw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="s1">&#39;tablename&#39;</span><span class="p">,</span>
                <span class="n">CONFIG_TABLE</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="s1">&#39;coldef_list&#39;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">CONFIG_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">CONFIG_HASHID</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">CONFIG_TABLENAME</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">CONFIG_STRID</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">CONFIG_DICT</span><span class="p">,</span> <span class="s1">&#39;DICT&#39;</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;docstr&#39;</span><span class="p">,</span> <span class="s1">&#39;table for algo configurations&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;superkeys&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="n">CONFIG_HASHID</span><span class="p">,)]),</span>
            <span class="p">(</span><span class="s1">&#39;dependson&#39;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">CONFIG_TABLE</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="o">**</span><span class="n">config_addtable_kw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">CONFIG_TABLE</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">config_addtable_kw</span>
        <span class="k">if</span> <span class="n">current_state</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_state</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">predrop_grace_period</span><span class="p">(</span><span class="n">CONFIG_TABLE</span><span class="p">):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">drop_all_tables</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="o">**</span><span class="n">new_state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Need to be able to modify tables&#39;</span><span class="p">)</span></div>


<span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_TableConfigHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper for configuration table &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_parent_rowids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            rowid_list (list): native table rowids</span>

<span class="sd">        Returns:</span>
<span class="sd">            parent_rowids (list of tuples): tuples of parent rowids</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # TODO: Need a test that creates a table</span>
<span class="sd">            &gt;&gt;&gt; # with two multi-dependencies and a two single dependencies</span>
<span class="sd">            &gt;&gt;&gt; # Then add two items to this table, and for each item</span>
<span class="sd">            &gt;&gt;&gt; # Find their parent inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_internal_columns</span><span class="p">(</span>
            <span class="n">rowid_list</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_id_colnames</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keepwrap</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_rowids</span>

    <span class="k">def</span> <span class="nf">get_parent_rowargs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            rowid_list (list): native table rowids</span>

<span class="sd">        Returns:</span>
<span class="sd">            parent_rowids (list of tuples): tuples of parent rowids</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # TODO: Need a test that creates a table</span>
<span class="sd">            &gt;&gt;&gt; # with two multi-dependencies and a two single dependencies</span>
<span class="sd">            &gt;&gt;&gt; # Then add two items to this table, and for each item</span>
<span class="sd">            &gt;&gt;&gt; # Find their parent inputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">parent_ismulti</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">parent_ismulti</span><span class="p">):</span>
            <span class="c1"># If any of the parent columns are multi-indexes, then lookup the</span>
            <span class="c1"># mapping from the aggregated uuid to the expanded rowid set.</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">model_uuids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_uuid</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">p_id_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">,</span> <span class="n">model_uuids</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">):</span>
                <span class="n">input_info</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_inputs</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
                <span class="n">fixed_args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">parent_id_colnames</span><span class="p">,</span> <span class="n">p_id_list</span><span class="p">,</span> <span class="n">parent_ismulti</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                        <span class="n">new_p_id</span> <span class="o">=</span> <span class="n">input_info</span><span class="p">[</span><span class="n">p_name</span> <span class="o">+</span> <span class="s1">&#39;_model_input&#39;</span><span class="p">]</span>
                        <span class="n">col_uuid</span> <span class="o">=</span> <span class="n">input_info</span><span class="p">[</span><span class="n">p_name</span> <span class="o">+</span> <span class="s1">&#39;_multi_id&#39;</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">col_uuid</span> <span class="o">==</span> <span class="n">p_id</span>
                        <span class="p">),</span> <span class="s1">&#39;the model input has unexpectedly changed&#39;</span>
                        <span class="n">fixed_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_p_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fixed_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_id</span><span class="p">)</span>
                <span class="n">parent_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixed_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="n">parent_rowids</span>
        <span class="k">return</span> <span class="n">parent_args</span>

    <span class="k">def</span> <span class="nf">get_row_parent_rowid_map</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>

<span class="sd">        parent_rowid_dict = depc.[&#39;feat&#39;].get_row_parent_rowid_map(rowid_list)</span>
<span class="sd">        key = parent_rowid_dict.keys()[0]</span>
<span class="sd">        val = parent_rowid_dict.values()[0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">parent_rowid_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_id_tablenames</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_transpose</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_rowid_dict</span>

    <span class="k">def</span> <span class="nf">get_config_history</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of config objects for all properties in the dependency</span>
<span class="sd">        history of this object. Multi-edges are handled. Set assume_unique to</span>
<span class="sd">        be false if there might be parents with different configs for the same</span>
<span class="sd">        table.</span>

<span class="sd">        &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>

<span class="sd">        parent_rowid_dict = depc.[&#39;feat&#39;].get_row_parent_rowid_map(rowid_list)</span>
<span class="sd">        key = parent_rowid_dict.keys()[0]</span>
<span class="sd">        val = parent_rowid_dict.values()[0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">assume_unique</span><span class="p">:</span>
            <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">rowid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tbl_cfgids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">cfgid2_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">,</span> <span class="n">tbl_cfgids</span><span class="p">)</span>
        <span class="n">unique_cfgids</span> <span class="o">=</span> <span class="n">cfgid2_rowids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">unique_cfgids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">unique_cfgids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cfgids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">unique_configs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_from_rowid</span><span class="p">(</span><span class="n">unique_cfgids</span><span class="p">)</span>

        <span class="c1"># parent_rowids = table.get_parent_rowids(rowid_list)</span>
        <span class="n">parent_rowargs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowargs</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>

        <span class="n">ret_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_configs</span><span class="p">]</span>
        <span class="n">depc</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span>
        <span class="n">rowargsT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listT</span><span class="p">(</span><span class="n">parent_rowargs</span><span class="p">)</span>
        <span class="n">parent_ismulti</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">ismulti</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">parent_id_tablenames</span><span class="p">,</span> <span class="n">parent_ismulti</span><span class="p">,</span> <span class="n">rowargsT</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">tblname</span> <span class="o">==</span> <span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">ismulti</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent_tbl</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tblname</span><span class="p">]</span>
            <span class="n">ancestor_configs</span> <span class="o">=</span> <span class="n">parent_tbl</span><span class="o">.</span><span class="n">get_config_history</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ancestor_configs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ancestor_configs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret_list</span>

    <span class="k">def</span> <span class="nf">__remove_old_configs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        table = ibs.depc[&#39;pairwise_match&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># developing</span>
        <span class="c1"># c = table.db.get_table_as_pandas(&#39;config&#39;)</span>
        <span class="c1"># t = table.db.get_table_as_pandas(table.tablename)</span>

        <span class="c1"># config_rowids = table.db.get_all_rowids(CONFIG_TABLE)</span>
        <span class="c1"># cfgdict_list = table.db.get(</span>
        <span class="c1">#     CONFIG_TABLE, colnames=(CONFIG_DICT,), id_iter=config_rowids,</span>
        <span class="c1">#     id_colname=CONFIG_ROWID)</span>
        <span class="c1"># bad_rowids = []</span>
        <span class="c1"># for rowid, cfgdict in zip(config_rowids, cfgdict_list):</span>
        <span class="c1">#     if cfgdict[&#39;version&#39;] &lt; 7:</span>
        <span class="c1">#         bad_rowids.append(rowid)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT rowid, {} from {}</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONFIG_DICT</span><span class="p">,</span> <span class="n">CONFIG_TABLE</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">bad_rowids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">cfgdict</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="c1"># MAKE GENERAL CONDITION</span>
            <span class="k">if</span> <span class="n">cfgdict</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">bad_rowids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span>

        <span class="n">in_str</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">bad_rowids</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT rowid from {tablename}</span>
<span class="sd">            WHERE config_rowid IN {bad_rowids}</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">bad_rowids</span><span class="o">=</span><span class="n">in_str</span><span class="p">)</span>
        <span class="c1"># logger.info(command)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">rowids</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delete_extern</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ancestor_rowids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="n">target_table</span><span class="p">):</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">depc</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span>
        <span class="k">for</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">parent_id_tablenames</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_transpose</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">tblname</span> <span class="o">==</span> <span class="n">target_table</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ids</span>
            <span class="n">parent_tbl</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">tblname</span><span class="p">]</span>
            <span class="n">ancestor_ids</span> <span class="o">=</span> <span class="n">parent_tbl</span><span class="o">.</span><span class="n">get_ancestor_rowids</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">target_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ancestor_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ancestor_ids</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Base case</span>

    <span class="k">def</span> <span class="nf">get_row_cfgid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_internal_columns</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">,</span> <span class="p">(</span><span class="n">CONFIG_ROWID</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">config_rowids</span>

    <span class="k">def</span> <span class="nf">get_row_configs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.query_request import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;chip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; rowid_list = depc.get_rowids(&#39;chip&#39;, [1, 2], config={})</span>
<span class="sd">            &gt;&gt;&gt; configs = table.get_row_configs(rowid_list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="c1"># Only look up the configs that are needed</span>
        <span class="n">unique_config_rowids</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">config_rowids</span><span class="p">)</span>
        <span class="n">unique_configs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_from_rowid</span><span class="p">(</span><span class="n">unique_config_rowids</span><span class="p">)</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ungroup_unique</span><span class="p">(</span><span class="n">unique_configs</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">configs</span>

    <span class="k">def</span> <span class="nf">get_row_cfghashid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">config_hashids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_hashid</span><span class="p">(</span><span class="n">config_rowids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_hashids</span>

    <span class="k">def</span> <span class="nf">get_row_cfgstr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">):</span>
        <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
        <span class="n">cfgstr_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">CONFIG_TABLE</span><span class="p">,</span>
            <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="n">CONFIG_STRID</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="o">=</span><span class="n">config_rowids</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="n">CONFIG_ROWID</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cfgstr_list</span>

    <span class="k">def</span> <span class="nf">get_config_rowid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">add_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_rowid</span>

    <span class="k">def</span> <span class="nf">get_config_hashid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config_rowid_list</span><span class="p">):</span>
        <span class="n">hashid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">CONFIG_TABLE</span><span class="p">,</span>
            <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="n">CONFIG_HASHID</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="o">=</span><span class="n">config_rowid_list</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="n">CONFIG_ROWID</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hashid_list</span>

    <span class="k">def</span> <span class="nf">get_config_rowid_from_hashid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config_hashid_list</span><span class="p">):</span>
        <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">CONFIG_TABLE</span><span class="p">,</span>
            <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="n">CONFIG_ROWID</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="o">=</span><span class="n">config_hashid_list</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="n">CONFIG_HASHID</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">config_rowid_list</span>

    <span class="k">def</span> <span class="nf">get_config_from_rowid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config_rowids</span><span class="p">):</span>
        <span class="n">cfgdict_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">CONFIG_TABLE</span><span class="p">,</span>
            <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="n">CONFIG_DICT</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="o">=</span><span class="n">config_rowids</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="n">CONFIG_ROWID</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">dict_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">table</span><span class="o">.</span><span class="n">configclass</span><span class="p">(</span><span class="o">**</span><span class="n">dict_</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dict_</span> <span class="ow">in</span> <span class="n">cfgdict_list</span>
        <span class="p">]</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">add_config</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># assume config is AlgoRequest or TableConfig</span>
            <span class="n">config_strid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">config_strid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">config_hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">config_strid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="ow">or</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;config_strid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_strid</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;config_hashid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_hashid</span><span class="p">,))</span>
        <span class="n">get_rowid_from_superkey</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_rowid_from_hashid</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">CONFIG_HASHID</span><span class="p">,</span> <span class="n">CONFIG_TABLENAME</span><span class="p">,</span> <span class="n">CONFIG_STRID</span><span class="p">,</span> <span class="n">CONFIG_DICT</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">):</span>
            <span class="c1"># Hack for requests</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">config</span>
        <span class="n">cfgdict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">config_hashid</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">config_strid</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)]</span>
        <span class="n">config_rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span>
            <span class="n">CONFIG_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span>
        <span class="p">)</span>
        <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">config_rowid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;config_rowid_list = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_rowid_list</span><span class="p">,))</span>
            <span class="c1"># logger.info(&#39;config_rowid = %r&#39; % (config_rowid,))</span>
        <span class="k">return</span> <span class="n">config_rowid</span>


<span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_TableDebugHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains printing and debug things</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">print_sql_info</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">add_op</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_make_add_table_sqlstr</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">table</span><span class="o">.</span><span class="n">_get_addtable_kw</span><span class="p">())</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="n">add_op</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_internal_info</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">all_attrs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-print_internal_info</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; tablenames = [&#39;labeler&#39;, &#39;vsone&#39;, &#39;neighbs&#39;, &#39;indexer&#39;]</span>
<span class="sd">            &gt;&gt;&gt; for table in ut.take(depc, tablenames): # .tables:</span>
<span class="sd">            &gt;&gt;&gt;     table.print_internal_info()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="c1"># Print the other inferred attrs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;table.parent_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.data_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">),))</span>
        <span class="c1"># Print the inferred allcol attrs</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span>
            <span class="s1">&#39;table.internal_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sorted_</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="s1">&#39;python&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">add_table_kw</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_addtable_kw</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.add_table_kw = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">add_table_kw</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">),))</span>
        <span class="n">table</span><span class="o">.</span><span class="n">print_sql_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">all_attrs</span><span class="p">:</span>
            <span class="c1"># Print all attributes</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_instance_attrnames</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">with_properties</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  table.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">a</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">print_table_csv</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c1"># if table.ismulti:</span>
        <span class="c1">#    table.print_model_manifests()</span>

    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">with_colattrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_graphattrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; debug function &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TABLE ATTRIBUTES&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.tablename = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.isinteractive = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.default_onthefly = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">default_onthefly</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.rm_extern_on_delete = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rm_extern_on_delete</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.chunksize = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">chunksize</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.fname = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">fname</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.docstr = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">docstr</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.data_colnames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.data_coltypes = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_coltypes</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">with_graphattrs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TABLE GRAPH ATTRIBUTES&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.children = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">children</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.parent = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.configclass = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">configclass</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.requestclass = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">requestclass</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">with_colattrs</span><span class="p">:</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TABEL COLUMN ATTRIBUTES&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;table.data_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">),)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;table.parent_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">),)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;table.internal_data_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">),)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;table.internal_parent_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_parent_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">),)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;table.internal_col_attrs = </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="n">nl</span><span class="p">),)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_schemadef</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_autogen_str</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">print_configs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-print_configs</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;keypoint&#39;]</span>
<span class="sd">            &gt;&gt;&gt; config = table.configclass()</span>
<span class="sd">            &gt;&gt;&gt; rowids = table.get_rowids_from_root([1, 2], config=config)</span>
<span class="sd">            &gt;&gt;&gt; config = table.configclass(adapt_shape=False)</span>
<span class="sd">            &gt;&gt;&gt; rowids = table.get_rowids_from_root([1, 2], config=config)</span>
<span class="sd">            &gt;&gt;&gt; table.print_configs()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;chip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;spam&#39;, [1, 2])</span>
<span class="sd">            &gt;&gt;&gt; table.print_configs()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">CONFIG_TABLE</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_csv</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">print_model_manifests</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;manifests&#39;</span><span class="p">)</span>
        <span class="n">rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_all_rowids</span><span class="p">()</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_uuid</span><span class="p">(</span><span class="n">rowids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rowids</span><span class="p">,</span> <span class="n">uuids</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rowid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">get_model_inputs</span><span class="p">(</span><span class="n">uuid</span><span class="p">),</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_assert_self</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">data_coltypes</span>
        <span class="p">),</span> <span class="s1">&#39;specify same number of colnames and coltypes&#39;</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check that preproc_func has a valid signature</span>
            <span class="c1"># ie (depc, parent_ids, config)</span>
            <span class="n">argspec</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_argspec</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span>
            <span class="k">if</span> <span class="n">argspec</span><span class="o">.</span><span class="n">varargs</span> <span class="ow">and</span> <span class="n">argspec</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;varargs and kwargs must have one arg for depcache&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;preproc_func=</span><span class="si">%r</span><span class="s1"> for table=</span><span class="si">%s</span><span class="s1"> must have a &#39;</span>
                        <span class="s1">&#39;depcache arg, at least one parent rowid arg, &#39;</span>
                        <span class="s1">&#39;and a config arg&#39;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">rowid_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowid_args</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">()):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;table.preproc_func = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span><span class="p">,))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;args = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rowid_args = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rowid_args</span><span class="p">,))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;preproc function for table=</span><span class="si">%s</span><span class="s1"> must have as many &#39;</span>
                        <span class="s1">&#39;rowids </span><span class="si">%d</span><span class="s1"> args as parent </span><span class="si">%d</span><span class="s1">&#39;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowid_args</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">()))</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">extern_class_colattrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">colattr</span>
            <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span>
            <span class="k">if</span> <span class="n">colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_external_class&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">extern_class_colattrs</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;coltype&#39;</span><span class="p">]</span>
            <span class="c1"># Check external column class funcs</span>
            <span class="n">argspec</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_argspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_nondefault</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_nondefault</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_nondefault</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    External args must be able to be constructed without any</span>
<span class="sd">                    args. IE: You need a default __init__(self) method</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_TableInternalSetup</span><span class="p">(</span><span class="n">ub</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper that sets up column information &quot;&quot;&quot;</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_infer_datacol</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the columns needed to represent relationship to data</span>

<span class="sd">        Infers interal properties about this table given the colnames and</span>
<span class="sd">        datatypes</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-_infer_datacol --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; for table in depc.tables:</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;----&#39;)</span>
<span class="sd">            &gt;&gt;&gt;     table._infer_datacol()</span>
<span class="sd">            &gt;&gt;&gt;     print(table)</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;table.data_col_attrs = %s&#39; %</span>
<span class="sd">            &gt;&gt;&gt;           ut.repr3(table.data_col_attrs, nl=8))</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;probchip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;spam&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;vsone&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_col_attrs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Parse column datatypes</span>
        <span class="n">_iter</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">data_coltypes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">data_colx</span><span class="p">,</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="c1"># Check column input subtypes</span>
            <span class="n">is_tuple</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">is_func</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_func_or_method</span><span class="p">(</span><span class="n">coltype</span><span class="p">)</span>
            <span class="n">is_externtup</span> <span class="o">=</span> <span class="n">is_tuple</span> <span class="ow">and</span> <span class="n">coltype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;extern&#39;</span>
            <span class="n">is_functup</span> <span class="o">=</span> <span class="n">is_tuple</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_func_or_method</span><span class="p">(</span><span class="n">coltype</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">is_exttype</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="n">ExternType</span><span class="p">)</span>
            <span class="c1"># Check column input main types</span>
            <span class="n">is_normal</span> <span class="o">=</span> <span class="n">coltype</span> <span class="ow">in</span> <span class="n">TYPE_TO_SQLTYPE</span>
            <span class="c1"># is_normal   = not (is_tuple or is_func)</span>
            <span class="n">isnested</span> <span class="o">=</span> <span class="n">is_tuple</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_func</span> <span class="ow">or</span> <span class="n">is_externtup</span><span class="p">)</span>
            <span class="n">is_external</span> <span class="o">=</span> <span class="n">is_func</span> <span class="ow">or</span> <span class="n">is_functup</span> <span class="ow">or</span> <span class="n">is_externtup</span> <span class="ow">or</span> <span class="n">is_exttype</span>
            <span class="c1"># Switch on input types</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;coltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coltype</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colx</span>
            <span class="k">if</span> <span class="n">is_normal</span><span class="p">:</span>
                <span class="c1"># Normal non-nested column</span>
                <span class="n">sqltype</span> <span class="o">=</span> <span class="n">TYPE_TO_SQLTYPE</span><span class="p">[</span><span class="n">coltype</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqltype</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;is_normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_normal</span>
            <span class="k">elif</span> <span class="n">isnested</span><span class="p">:</span>
                <span class="c1"># Nested non-function normal columns</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isnested&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isnested</span>
                <span class="n">nestattrs</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nestattrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">subtype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coltype</span><span class="p">):</span>
                    <span class="n">nestattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                    <span class="n">nestattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nestattr</span><span class="p">)</span>
                    <span class="n">flat_colname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                    <span class="n">sqltype</span> <span class="o">=</span> <span class="n">TYPE_TO_SQLTYPE</span><span class="p">[</span><span class="n">subtype</span><span class="p">]</span>
                    <span class="n">nestattr</span><span class="p">[</span><span class="s1">&#39;flat_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_colname</span>
                    <span class="n">nestattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqltype</span>
            <span class="k">elif</span> <span class="n">is_external</span><span class="p">:</span>
                <span class="c1"># Nested external funcs</span>
                <span class="n">write_func</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">is_exttype</span><span class="p">:</span>
                    <span class="n">read_func</span> <span class="o">=</span> <span class="n">coltype</span><span class="o">.</span><span class="n">read_func</span>
                    <span class="n">write_func</span> <span class="o">=</span> <span class="n">coltype</span><span class="o">.</span><span class="n">write_func</span>
                    <span class="k">if</span> <span class="n">coltype</span><span class="o">.</span><span class="n">extern_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;extern_ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coltype</span><span class="o">.</span><span class="n">extern_ext</span>
                    <span class="k">if</span> <span class="n">coltype</span><span class="o">.</span><span class="n">extkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;extkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coltype</span><span class="o">.</span><span class="n">extkey</span>
                <span class="k">elif</span> <span class="n">is_externtup</span><span class="p">:</span>
                    <span class="n">read_func</span> <span class="o">=</span> <span class="n">coltype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coltype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">write_func</span> <span class="o">=</span> <span class="n">coltype</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coltype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;extern_ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">is_functup</span><span class="p">:</span>
                    <span class="n">read_func</span> <span class="o">=</span> <span class="n">coltype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">read_func</span> <span class="o">=</span> <span class="n">coltype</span>
                <span class="n">intern_colname</span> <span class="o">=</span> <span class="n">colname</span> <span class="o">+</span> <span class="n">EXTERN_SUFFIX</span>
                <span class="n">sqltype</span> <span class="o">=</span> <span class="n">TYPE_TO_SQLTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;is_external&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intern_colname</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_func</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_func</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqltype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># External class column</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="s1">&#39;__getstate__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                    <span class="n">coltype</span><span class="p">,</span> <span class="s1">&#39;__setstate__&#39;</span>
                <span class="p">),</span> <span class="p">(</span><span class="s1">&#39;External classes must have __getstate__ and &#39;</span> <span class="s1">&#39;__setstate__ methods&#39;</span><span class="p">)</span>
                <span class="n">read_func</span><span class="p">,</span> <span class="n">write_func</span> <span class="o">=</span> <span class="n">make_extern_io_funcs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">coltype</span><span class="p">)</span>
                <span class="n">sqltype</span> <span class="o">=</span> <span class="n">TYPE_TO_SQLTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
                <span class="n">intern_colname</span> <span class="o">=</span> <span class="n">colname</span> <span class="o">+</span> <span class="n">EXTERN_SUFFIX</span>
                <span class="c1"># raise AssertionError(&#39;external class columns&#39;)</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;is_external&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;is_external_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;coltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coltype</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intern_colname</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_func</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_func</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqltype</span>
            <span class="n">data_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_col_attrs</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_infer_parentcol</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        construct columns to represent relationship to parent</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table _infer_parentcol --show</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: list of dictionaries for each parent</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;vsone&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;smk_match&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;neighbs&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;indexer&#39;]</span>
<span class="sd">            &gt;&gt;&gt; parent_col_attrs = table._infer_parentcol()</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;parent_col_attrs = %s&#39; % (ut.repr2(parent_col_attrs, nl=2),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; depc.d.get_indexer_data([1, 2, 3])</span>
<span class="sd">            &gt;&gt;&gt; import uuid</span>
<span class="sd">            &gt;&gt;&gt; depc.d.get_indexer_data([</span>
<span class="sd">            &gt;&gt;&gt;     uuid.UUID(&#39;a01eda32-e4e0-b139-3274-e91d1b3e9ecf&#39;)])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent_tablenames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_tablenames</span>
        <span class="n">parent_col_attrs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Handle dependencies when a parent are pairwise between tables</span>
        <span class="n">parent_id_prefixs1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parent_id_prefixs2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">parent_colx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_tablenames</span><span class="p">):</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="c1"># Detect multicolumns</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">ismulti</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">parent_table</span> <span class="o">=</span> <span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ismulti</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">parent_table</span> <span class="o">=</span> <span class="n">col</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ismulti</span>
            <span class="c1"># Local input-id helps specify branch ordering</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">ismulti</span><span class="p">:</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_table</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;parent_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colx</span>
            <span class="n">parent_id_prefixs1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_table</span><span class="p">)</span>
            <span class="n">parent_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

        <span class="n">colhist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">parent_id_prefixs1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent_colx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_id_prefixs1</span><span class="p">):</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">parent_col_attrs</span><span class="p">[</span><span class="n">parent_colx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">colhist</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Duplicate column names recieve indicies</span>
                <span class="n">nwise_idx</span> <span class="o">=</span> <span class="n">seen_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">nwise_total</span> <span class="o">=</span> <span class="n">colhist</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwise_idx</span><span class="p">)</span>
                <span class="n">seen_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nwise_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwise_total</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nwise_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nwise_idx</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">nwise_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">]:</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;local_input_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
            <span class="n">parent_id_prefixs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="c1"># Handle case when parent are a set of ids</span>
        <span class="k">for</span> <span class="n">colattr</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parent_col_attrs</span><span class="p">,</span> <span class="n">parent_id_prefixs2</span><span class="p">):</span>
            <span class="n">column_ismulti</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">column_ismulti</span><span class="p">:</span>
                <span class="c1"># Case when dependencies are many to one hash of set items</span>
                <span class="n">colname</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_setuuid&#39;</span>
                <span class="n">sqltype</span> <span class="o">=</span> <span class="s1">&#39;UUID NOT NULL&#39;</span>
                <span class="n">INPUT_SIZE_SUFFIX</span> <span class="o">=</span> <span class="s1">&#39;setsize&#39;</span>
                <span class="n">extra_cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">extra_cols</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;intern_colname&#39;</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">INPUT_SIZE_SUFFIX</span><span class="p">,</span>
                        <span class="s1">&#39;sqltype&#39;</span><span class="p">:</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">,</span>
                        <span class="c1"># &#39;doc&#39;: &#39;size of an input set for this model&#39;,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
                <span class="c1"># File that maintains manifest of model inputs</span>
                <span class="c1"># INPUT_FPATH_SUFFIX = &#39;setfpath&#39;</span>
                <span class="c1"># extra_cols += [{</span>
                <span class="c1"># &#39;intern_colname&#39;: prefix + &#39;_&#39; + INPUT_FPATH_SUFFIX,</span>
                <span class="c1"># &#39;sqltype&#39;: &#39;TEXT&#39;</span>
                <span class="c1"># }]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;extra_cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_cols</span>
                <span class="c1"># colattr[&#39;issuper&#39;] = True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Normal case when dependencies are one to one</span>
                <span class="n">colname</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_rowid&#39;</span>
                <span class="n">sqltype</span> <span class="o">=</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqltype</span>

        <span class="n">parent_col_attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">order_dict_by</span><span class="p">(</span><span class="n">colattr</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">,</span> <span class="s1">&#39;sqltype&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">parent_col_attrs</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">parent_col_attrs</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_infer_allcol</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine information from parentcol and datacol</span>
<span class="sd">        Build column definitions that will directly define SQL columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">internal_col_attrs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Append primary column</span>
        <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;sqltype&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;isprimary&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
        <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

        <span class="c1"># Append parent columns</span>
        <span class="n">ismulti</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">:</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]:</span>
                <span class="n">ismulti</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;ismulti&#39;</span><span class="p">]</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isnwise&#39;</span><span class="p">]:</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nwise_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;nwise_total&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nwise_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;nwise_idx&#39;</span><span class="p">]</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;parent_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_colx&#39;</span><span class="p">]</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isparent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;issuper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

        <span class="c1"># Append config columns</span>
        <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">,</span> <span class="n">CONFIG_ROWID</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;sqltype&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;issuper&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
        <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

        <span class="c1"># Append quick access column</span>
        <span class="c1"># return any(table.get_parent_col_attr(&#39;ismulti&#39;))</span>
        <span class="c1"># if table.ismulti:</span>
        <span class="k">if</span> <span class="n">ismulti</span><span class="p">:</span>
            <span class="c1"># Append model uuid column</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">model_uuid_colname</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;UUID NOT NULL&#39;</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
            <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

            <span class="c1"># Append model uuid column</span>
            <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">is_augmented_colname</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span>
            <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
            <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># TODO: eventually enable</span>
                <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">taggable</span><span class="p">:</span>
                    <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;model_tag&#39;</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEXT&#39;</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
                    <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Append primary rowid column</span>
            <span class="k">pass</span>

        <span class="c1"># Append data columns</span>
        <span class="k">for</span> <span class="n">data_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">:</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isnested&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">nestcol</span> <span class="ow">in</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;nestattrs&#39;</span><span class="p">]:</span>
                    <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nestcol</span><span class="p">[</span><span class="s1">&#39;flat_colname&#39;</span><span class="p">]</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nestcol</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
                <span class="k">if</span> <span class="n">data_colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_external&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;is_external_pointer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span>
                    <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_colattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span>
                <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>

        <span class="c1"># Append extra columns</span>
        <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extra_colattr</span> <span class="ow">in</span> <span class="n">parent_colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extra_cols&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">colattr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">]</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_col_attrs</span><span class="p">)</span>
                <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;isextra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">internal_col_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colattr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">internal_col_attrs</span>


<span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_TableGeneralHelper</span><span class="p">(</span><span class="n">ub</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">num_parents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_tablenames</span><span class="p">)</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">) nP=</span><span class="si">%d%s</span><span class="s1"> nC=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">num_parents</span><span class="p">,</span>
            <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">num_cols</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def _table_colnames(table):</span>
    <span class="c1">#    return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extern_dpath</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">cache_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span>
        <span class="n">extern_dname</span> <span class="o">=</span> <span class="s1">&#39;extern_&#39;</span> <span class="o">+</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">extern_dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="n">extern_dname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">extern_dpath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dpath</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="c1"># assert table.ismulti, &#39;only valid for models&#39;</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_storage&#39;</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">cache_dpath</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
        <span class="c1"># ut.ensuredir(dpath)</span>
        <span class="k">return</span> <span class="n">dpath</span>

    <span class="c1"># def dpath(table):</span>
    <span class="c1">#    from os.path import dirname</span>
    <span class="c1">#    dpath = dirname(table.db.fpath)</span>
    <span class="c1">#    return dpath</span>

    <span class="nd">@property</span>
    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">ismulti</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="c1"># TODO: or has multi parent</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configclass</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">configclass_dict</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requestclass</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">requestclass_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">new_request</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>

    <span class="c1"># --- Standard Properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">internal_data_col_attrs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_intern_col_attr</span><span class="p">(</span><span class="s1">&#39;isdata&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">internal_parent_col_attrs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_intern_col_attr</span><span class="p">(</span><span class="s1">&#39;isparent&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="c1"># --- / Standard Properties</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">get_parent_col_attr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">get_intern_data_col_attr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">get_intern_parent_col_attr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_parent_col_attrs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">get_intern_col_attr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">get_data_col_attr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">parent_id_tablenames</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">tablenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span><span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tablenames</span>

    <span class="nd">@property</span>
    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">parent_id_prefix</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">[</span><span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prefixes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extern_columns</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_data_col_attr</span><span class="p">(</span><span class="s1">&#39;colname&#39;</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_data_col_attr</span><span class="p">(</span><span class="s1">&#39;is_extern&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rowid_colname</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; rowid of this table used by other dependant tables &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span> <span class="o">+</span> <span class="s1">&#39;_rowid&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">superkey_colnames</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_id_colnames</span> <span class="o">+</span> <span class="p">(</span><span class="n">CONFIG_ROWID</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_uuid_colname</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;model_uuid&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_augmented_colname</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;augment_bit&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_id_colnames</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_rowids_from_root</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get_rowids</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">root_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">],</span> <span class="n">parent_colattr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># return tuple([parent_colattr[&#39;parent_table&#39;]</span>
        <span class="c1">#              for parent_colattr in table.parent_col_attrs])</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">],</span> <span class="n">parent_colattr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">parent_colattr</span><span class="p">[</span><span class="s1">&#39;parent_table&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">parent_colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span>
            <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">explicit_graph</span>
        <span class="n">children_tablenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">children_tablenames</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ancestors</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">explicit_graph</span>
        <span class="n">children_tablenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">children_tablenames</span>

    <span class="k">def</span> <span class="nf">show_dep_subgraph</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">inter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">wbia.plottool.interactions</span> <span class="kn">import</span> <span class="n">ExpandableInteraction</span>

        <span class="n">autostart</span> <span class="o">=</span> <span class="n">inter</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">ExpandableInteraction</span><span class="p">(</span><span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">explicit_graph</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_all_nodes_between</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="n">plot_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="s1">&#39;Ubuntu&#39;</span><span class="p">}</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">append_plot</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">show_nx</span><span class="p">,</span>
                <span class="n">G</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Dependency Subgraph (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">),</span>
                <span class="o">**</span><span class="n">plot_kw</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">autostart</span><span class="p">:</span>
            <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_input_graph</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">inter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table show_input_graph --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;smk_match&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table.show_input_graph()</span>
<span class="sd">            &gt;&gt;&gt; #print(depc[&#39;smk_match&#39;].flat_compute_rmi_edges)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.plottool.interactions</span> <span class="kn">import</span> <span class="n">ExpandableInteraction</span>

        <span class="n">autostart</span> <span class="o">=</span> <span class="n">inter</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">ExpandableInteraction</span><span class="p">(</span><span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">show_dep_subgraph</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rootmost_inputs</span>
        <span class="n">inter</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">show_exi_graph</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">autostart</span><span class="p">:</span>
            <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inter</span>

    <span class="nd">@property</span>
    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">expanded_input_graph</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-expanded_input_graph --show --table=neighbs</span>
<span class="sd">            python -m dtool.depcache_table --exec-expanded_input_graph --show --table=vsone</span>
<span class="sd">            python -m dtool.depcache_table --exec-expanded_input_graph --show --table=smk_match</span>

<span class="sd">        TODO:</span>
<span class="sd">            * determine root argument structure</span>
<span class="sd">            * ???</span>
<span class="sd">            * compute dependencies in order</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import * # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; tablename = ut.get_argval(&#39;--table&#39;, default=&#39;vsone&#39;)</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">            &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; pt.ensureqt()</span>
<span class="sd">            &gt;&gt;&gt; table.show_input_graph()</span>
<span class="sd">            &gt;&gt;&gt; pt.interactions.zoom_factory()</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">input_helpers</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">explicit_graph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">exi_graph</span> <span class="o">=</span> <span class="n">input_helpers</span><span class="o">.</span><span class="n">make_expanded_input_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exi_graph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rootmost_inputs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table rootmost_inputs --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_control import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; #tablename = &#39;multitest_score&#39;</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;smk_match&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; inputs = table.rootmost_inputs</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;inputs = %s&#39; % (inputs,))</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;compute_order = %s&#39; % (ut.repr2(inputs.flat_compute_rmi_edges(), nl=1)))</span>
<span class="sd">            ......</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            inputs = &lt;TableInput [annot[t], vocab[t], inv_index[t]]&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.dtool</span> <span class="kn">import</span> <span class="n">input_helpers</span>

        <span class="n">exi_graph</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">expanded_input_graph</span>
        <span class="n">rootmost_inputs</span> <span class="o">=</span> <span class="n">input_helpers</span><span class="o">.</span><span class="n">get_rootmost_inputs</span><span class="p">(</span><span class="n">exi_graph</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rootmost_inputs</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">requestable_col_attrs</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps names of requestable columns to indicies of internal columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">requestable_col_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">internal_data_col_attrs</span><span class="p">:</span>
            <span class="n">rattr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
            <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span>
            <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
            <span class="n">requestable_col_attrs</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">rattr</span>

        <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">:</span>
            <span class="n">rattr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isnested&#39;</span><span class="p">):</span>
                <span class="n">nest_internal_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;nestattrs&#39;</span><span class="p">],</span> <span class="s1">&#39;flat_colname&#39;</span><span class="p">)</span>
                <span class="n">nest_attrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">requestable_col_attrs</span><span class="p">,</span> <span class="n">nest_internal_names</span><span class="p">)</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nest_internal_names</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">nest_attrs</span><span class="p">,</span> <span class="s1">&#39;intern_colx&#39;</span><span class="p">)</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;isnested&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_external&#39;</span><span class="p">):</span>
                <span class="n">intern_attr</span> <span class="o">=</span> <span class="n">requestable_col_attrs</span><span class="p">[</span><span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]]</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intern_attr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">]</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intern_attr</span><span class="p">[</span><span class="s1">&#39;intern_colx&#39;</span><span class="p">]</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;read_func&#39;</span><span class="p">]</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;write_func&#39;</span><span class="p">]</span>
                <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;is_extern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span>
            <span class="n">rattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colname</span>
            <span class="n">requestable_col_attrs</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">rattr</span>
        <span class="k">return</span> <span class="n">requestable_col_attrs</span>

    <span class="nd">@ut</span><span class="o">.</span><span class="n">memoize</span>
    <span class="k">def</span> <span class="nf">computable_colnames</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="c1"># These are the colnames that we expect to be computed</span>
        <span class="n">intern_colnames</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="s1">&#39;intern_colname&#39;</span><span class="p">)</span>
        <span class="n">insertable_flags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="ow">not</span> <span class="n">colattr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isprimary&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span>
        <span class="p">]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">intern_colnames</span><span class="p">,</span> <span class="n">insertable_flags</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">colnames</span>


<span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_TableComputeHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper for computing functions &quot;&quot;&quot;</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">prepare_storage</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">proptup_gen</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts output from ``preproc_func`` to data that can be stored in SQL</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table prepare_storage</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(in_memory=False)</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;labeler&#39;</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;indexer&#39;</span>
<span class="sd">            &gt;&gt;&gt; config = {tablename + &#39;_param&#39;: None, &#39;foo&#39;: &#39;bar&#39;}</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;labeler&#39;, [1, 2, 3], &#39;data&#39;, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;labeler&#39;, [1, 2, 3], &#39;data&#39;, config=config, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;indexer&#39;, [[1, 2, 3]], &#39;data&#39;, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;indexer&#39;, [[1, 2, 3]], &#39;data&#39;, config=config, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(&#39;indexer&#39;, [[1, 2, 3]],  config=config, _debug=0)</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; model_uuid_list = table.get_internal_columns(rowids, (&#39;model_uuid&#39;,))</span>
<span class="sd">            &gt;&gt;&gt; model_uuid = model_uuid_list[0]</span>
<span class="sd">            &gt;&gt;&gt; rowids2 = table.get_model_rowids(model_uuid_list)</span>
<span class="sd">            &gt;&gt;&gt; assert rowids == rowids2, &#39;bad rowid computation&#39;</span>
<span class="sd">            &gt;&gt;&gt; table.print_table()</span>
<span class="sd">            &gt;&gt;&gt; table.print_internal_info()</span>
<span class="sd">            &gt;&gt;&gt; table.print_configs()</span>
<span class="sd">            &gt;&gt;&gt; table.print_model_manifests()</span>
<span class="sd">            &gt;&gt;&gt; #ut.vd(depc.cache_dpath)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">default_to_unpack</span><span class="p">:</span>
            <span class="c1"># Hack for tables explicilty specified with a single column</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">data</span><span class="p">,)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">proptup_gen</span><span class="p">)</span>
        <span class="c1"># Flatten nested columns</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">get_data_col_attr</span><span class="p">(</span><span class="s1">&#39;isnested&#39;</span><span class="p">)):</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_prepare_storage_nested</span><span class="p">(</span><span class="n">proptup_gen</span><span class="p">)</span>
        <span class="c1"># Write external columns</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">get_data_col_attr</span><span class="p">(</span><span class="s1">&#39;write_func&#39;</span><span class="p">)):</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_prepare_storage_extern</span><span class="p">(</span>
                <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">proptup_gen</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">:</span>
            <span class="n">manifest_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">dpath</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">manifest_dpath</span><span class="p">)</span>
        <span class="c1"># Concatenate data with internal rowids / config-id</span>
        <span class="k">for</span> <span class="n">ids_</span><span class="p">,</span> <span class="n">data_cols</span><span class="p">,</span> <span class="n">args_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">proptup_gen</span><span class="p">,</span> <span class="n">dirty_preproc_args</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">multi_parent_flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
                    <span class="n">parent_colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">)</span>
                    <span class="n">multi_id_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">parent_colnames</span><span class="p">,</span> <span class="n">multi_parent_flags</span><span class="p">)</span>
                    <span class="n">multi_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ids_</span><span class="p">,</span> <span class="n">multi_parent_flags</span><span class="p">)</span>
                    <span class="n">multi_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">args_</span><span class="p">,</span> <span class="n">multi_parent_flags</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">:</span>
                        <span class="n">multi_setsizes</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">manifest_data</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">multi_id</span><span class="p">,</span> <span class="n">arg_</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">multi_ids</span><span class="p">,</span> <span class="n">multi_args</span><span class="p">,</span> <span class="n">multi_id_names</span>
                        <span class="p">):</span>
                            <span class="k">assert</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">,</span> <span class="s1">&#39;only valid for models&#39;</span>
                            <span class="c1"># TODO: need to get back to root ids</span>
                            <span class="n">manifest_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="o">**</span><span class="p">{</span>
                                    <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_multi_id&#39;</span><span class="p">:</span> <span class="n">multi_id</span><span class="p">,</span>
                                    <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_primary_ids&#39;</span><span class="p">:</span> <span class="s1">&#39;FIXME&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg_</span><span class="p">),</span>
                                    <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_model_input&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg_</span><span class="p">),</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="n">multi_setsizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_</span><span class="p">))</span>

                        <span class="c1"># Make a new model uuid</span>
                        <span class="c1"># TODO: maybe we should not do this here</span>
                        <span class="n">model_uuid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashable_to_uuid</span><span class="p">((</span><span class="n">multi_ids</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()))</span>
                        <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
                        <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_uuid</span>
                        <span class="n">manifest_data</span><span class="p">[</span><span class="s1">&#39;augmented&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="n">manifest_fpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_manifest_fpath</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">manifest_fpath</span><span class="p">,</span> <span class="n">manifest_data</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                        <span class="c1"># TODO: hash all input UUIDs and the full config together</span>
                        <span class="n">quick_access_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="c1"># Give the setsize and setfpath data if needed</span>
                        <span class="n">parent_extra</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                                <span class="nb">zip</span><span class="p">(</span>
                                    <span class="n">multi_setsizes</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">quick_access_tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                        <span class="n">parent_extra</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                    <span class="c1"># parent_extra = tuple(ut.flatten(zip(multi_setsizes, multi_setfpaths)))</span>
                    <span class="c1"># parent_extra = tuple(ut.flatten([(len(arg), fname) for arg,</span>
                    <span class="c1">#                                 fname in zip(multi_args,</span>
                    <span class="c1">#                                              multi_fpaths)]))</span>
                    <span class="n">row_tup</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ids_</span>
                        <span class="o">+</span> <span class="p">(</span><span class="n">config_rowid</span><span class="p">,)</span>
                        <span class="o">+</span> <span class="n">quick_access_tup</span>
                        <span class="o">+</span> <span class="n">data_cols</span>
                        <span class="o">+</span> <span class="n">parent_extra</span>
                    <span class="p">)</span>
                    <span class="c1"># logger.info(&#39;row_tup = %r&#39; % (row_tup,))</span>
                    <span class="k">yield</span> <span class="n">row_tup</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                    <span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;cat error&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;data_cols&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_rowids&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">get_model_manifest_fname</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">):</span>
        <span class="n">manifest_fname</span> <span class="o">=</span> <span class="s1">&#39;input_manifest_</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_uuid</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">manifest_fname</span>

    <span class="k">def</span> <span class="nf">get_model_manifest_fpath</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">):</span>
        <span class="n">manifest_fname</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_manifest_fname</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">manifest_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">manifest_fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manifest_fpath</span>

    <span class="k">def</span> <span class="nf">get_model_inputs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">model_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; table.get_model_uuid([2])</span>
<span class="sd">            [UUID(&#39;5b66772c-e654-dd9a-c9de-0ccc1bb6861c&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">,</span> <span class="s1">&#39;must be a model&#39;</span>
        <span class="n">manifest_fpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_manifest_fpath</span><span class="p">(</span><span class="n">model_uuid</span><span class="p">)</span>
        <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">manifest_fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">manifest_data</span>

    <span class="k">def</span> <span class="nf">get_model_uuid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; table.get_model_uuid([2])</span>
<span class="sd">            [UUID(&#39;5b66772c-e654-dd9a-c9de-0ccc1bb6861c&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">,</span> <span class="s1">&#39;must be a model&#39;</span>
        <span class="n">model_uuid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_internal_columns</span><span class="p">(</span><span class="n">rowids</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;model_uuid&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">model_uuid_list</span>

    <span class="k">def</span> <span class="nf">get_model_rowids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">model_uuid_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the rowid of a model given its uuid</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; import uuid</span>
<span class="sd">            &gt;&gt;&gt; table.get_model_rowids([uuid.UUID(&#39;5b66772c-e654-dd9a-c9de-0ccc1bb6861c&#39;)])</span>
<span class="sd">            [2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">,</span> <span class="s1">&#39;must be a model&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">,)</span>
        <span class="n">andwhere_colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">model_uuid_colname</span><span class="p">,)</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">model_uuid_list</span><span class="p">))</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_where_eq</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">colnames</span><span class="p">,</span>
            <span class="n">params_iter</span><span class="p">,</span>
            <span class="n">andwhere_colnames</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">nInput</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">model_uuid_list</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">_prepare_storage_nested</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">proptup_gen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hack for when a sql schema has tuples defined in it.</span>
<span class="sd">        Accepts nested tuples and flattens them to fit into the sql tables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nCols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">)</span>
        <span class="n">idxs1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">get_data_col_attr</span><span class="p">(</span><span class="s1">&#39;isnested&#39;</span><span class="p">))</span>
        <span class="n">idxs2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">idxs1</span><span class="p">,</span> <span class="n">nCols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">proptup_gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="c1"># Split data into nested and unnested columns</span>
            <span class="n">unnested_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">)))</span>
            <span class="n">nested_cols</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">)</span>
            <span class="n">grouped_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">nested_cols</span><span class="p">,</span> <span class="n">unnested_cols</span><span class="p">]</span>
            <span class="n">groupxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">]</span>
            <span class="c1"># Flatten nested columns</span>
            <span class="n">unflat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ungroup</span><span class="p">(</span><span class="n">grouped_items</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Recombine the data</span>
            <span class="n">data_new</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">unflat</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">data_new</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">_prepare_storage_extern</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">proptup_gen</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes external data to disk if write function is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">internal_data_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">internal_data_col_attrs</span>
        <span class="n">writable_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="s1">&#39;write_func&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">extern_colattrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="n">writable_flags</span><span class="p">)</span>
        <span class="c1"># extern_colnames = ut.dict_take_column(extern_colattrs, &#39;colname&#39;)</span>
        <span class="n">extern_writers</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">extern_colattrs</span><span class="p">,</span> <span class="s1">&#39;write_func&#39;</span><span class="p">)</span>

        <span class="n">nCols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_data_col_attrs</span><span class="p">)</span>
        <span class="n">idxs1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">writable_flags</span><span class="p">)</span>
        <span class="n">idxs2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">idxs1</span><span class="p">,</span> <span class="n">nCols</span><span class="p">)</span>
        <span class="n">extern_fnames_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">_get_extern_fnames</span><span class="p">(</span>
                        <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">extern_colattr</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">extern_colattr</span> <span class="ow">in</span> <span class="n">extern_colattrs</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># get extern cache directory and fpaths</span>
        <span class="n">extern_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">extern_dpath</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="ow">or</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span><span class="p">)</span>
        <span class="c1"># extern_fpaths_list = [</span>
        <span class="c1">#     [join(extern_dpath, fname) for fname in fnames]</span>
        <span class="c1">#     for fnames in extern_fnames_list</span>
        <span class="c1"># ]</span>

        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">extern_fpaths</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">proptup_gen</span><span class="p">,</span> <span class="n">extern_fnames_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">normal_data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extern_data</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Did you forget to return/yeild your data as a tuple?&#39;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="c1"># Write external data to disk</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extern_data</span><span class="p">,</span> <span class="n">extern_fpaths</span><span class="p">,</span> <span class="n">extern_writers</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">write_func</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
                    <span class="n">abs_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>
                    <span class="c1"># logger.info(&#39;WRITE fpath = %r, abs_fpath = %r&#39; % (fpath, abs_fpath, ))</span>
                    <span class="n">write_func</span><span class="p">(</span><span class="n">abs_fpath</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">assert_exists</span><span class="p">(</span><span class="n">abs_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;external write&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">])</span>
                <span class="k">raise</span>
            <span class="c1"># Return path instead of data</span>
            <span class="n">grouped_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">extern_fpaths</span><span class="p">,</span> <span class="n">normal_data</span><span class="p">]</span>
            <span class="n">groupxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">]</span>
            <span class="n">data_new</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ungroup</span><span class="p">(</span><span class="n">grouped_items</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">data_new</span>

    <span class="k">def</span> <span class="nf">get_extern_fnames</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">extern_col_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convinience function around get_extern_fnames</span>

<span class="sd">        Exmaple:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; depc = ibs.depc_annot</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;chips&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; extern_col_index = 0</span>
<span class="sd">            &gt;&gt;&gt; info_props = [&#39;image_uuid&#39;, &#39;verts&#39;, &#39;theta&#39;]</span>
<span class="sd">            &gt;&gt;&gt; config = depc.configclass_dict[tablename]()</span>
<span class="sd">            &gt;&gt;&gt; root_rowids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; rowid_list = depc.get_rowids(tablename, root_rowids)</span>
<span class="sd">            &gt;&gt;&gt; parent_rowids = table.get_parent_rowids(rowid_list)</span>
<span class="sd">            &gt;&gt;&gt; fname_list = table.get_extern_fnames(parent_rowids, config)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;fname_list = %r&#39; % (fname_list,))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_rowid</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># depc.get_rowids(tablename, root_rowids, config)</span>
        <span class="n">internal_data_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">internal_data_col_attrs</span>
        <span class="n">writable_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="s1">&#39;write_func&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">extern_colattrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">internal_data_col_attrs</span><span class="p">,</span> <span class="n">writable_flags</span><span class="p">)</span>
        <span class="n">extern_colattr</span> <span class="o">=</span> <span class="n">extern_colattrs</span><span class="p">[</span><span class="n">extern_col_index</span><span class="p">]</span>
        <span class="n">fname_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_extern_fnames</span><span class="p">(</span>
            <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">extern_colattr</span>
        <span class="p">)</span>

        <span class="c1"># if False:</span>
        <span class="c1">#    root_rowids = table.depc.get_root_rowids(table.tablename, rowid_list)</span>
        <span class="c1">#    info_props = [&#39;image_uuid&#39;, &#39;verts&#39;, &#39;theta&#39;]</span>
        <span class="c1">#    table.depc.make_root_info_uuid(root_rowids, info_props)</span>

        <span class="k">return</span> <span class="n">fname_list</span>

    <span class="k">def</span> <span class="nf">_get_extern_fnames</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">extern_colattr</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO:</span>
<span class="sd">            * Clean up signature</span>
<span class="sd">            * Make this function return the filenames used</span>
<span class="sd">              by a specific external column in this table.  The inputs are the</span>
<span class="sd">              parent_rowids, (and the root rowids?), and the config.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_rowids (list of tuples) - list of tuples of rowids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_hashid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_hashid</span><span class="p">([</span><span class="n">config_rowid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">extern_colattr</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span>
        <span class="n">colattrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span><span class="p">[</span><span class="n">extern_colattr</span><span class="p">[</span><span class="s1">&#39;data_colx&#39;</span><span class="p">]]</span>
        <span class="c1"># if colname is not None:</span>
        <span class="c1">#    prefix += &#39;_&#39; + colname</span>
        <span class="c1"># TODO: Put relevant root properties into the hash of the filename</span>
        <span class="c1"># (like bbox, parent image. basically the general vuuid and suuid.</span>
        <span class="n">fmtstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{prefix}</span><span class="s1">_id=</span><span class="si">{rowids}</span><span class="s1">_</span><span class="si">{config_hashid}{ext}</span><span class="s1">&#39;</span>
        <span class="c1"># HACK: check if the config specifies the extension type</span>
        <span class="c1"># extkey = table.extern_ext_config_keys.get(colname, &#39;ext&#39;)</span>
        <span class="k">if</span> <span class="s1">&#39;extern_ext&#39;</span> <span class="ow">in</span> <span class="n">colattrs</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">colattrs</span><span class="p">[</span><span class="s1">&#39;extern_ext&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extkey</span> <span class="o">=</span> <span class="n">colattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extkey&#39;</span><span class="p">,</span> <span class="s1">&#39;ext&#39;</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">extkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">extkey</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="s1">&#39;.cPkl&#39;</span>
        <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">rowids</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">rowids</span><span class="p">))),</span>
                <span class="n">config_hashid</span><span class="o">=</span><span class="n">config_hashid</span><span class="p">,</span>
                <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">rowids</span> <span class="ow">in</span> <span class="n">parent_rowids</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">fname_list</span>

    <span class="k">def</span> <span class="nf">_compute_dirty_rows</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        dirty_preproc_args = preproc_args</span>
<span class="sd">        dirty_parent_ids = parent_rowids</span>
<span class="sd">        config_ = config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_parent_ids</span><span class="p">)</span>
        <span class="c1"># if verbose:</span>
        <span class="c1">#     logger.info(&#39;[deptbl.compute] nInput = %r&#39; % (nInput,))</span>

        <span class="c1"># Pack arguments into column-wise order to send to the func</span>
        <span class="n">argsT</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">dirty_preproc_args</span><span class="p">)</span>
        <span class="n">argsT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">argsT</span><span class="p">)</span>  <span class="c1"># TODO: remove</span>

        <span class="c1"># HACK extract config if given a request</span>
        <span class="n">config_</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">config</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">config</span>

        <span class="c1"># call registered worker function</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">vectorized</span><span class="p">:</span>
            <span class="c1"># Function is written in a way that only accepts multiple inputs at</span>
            <span class="c1"># once and generates output</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">,</span> <span class="o">*</span><span class="n">argsT</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Function is written in a way that only accepts a single row of</span>
            <span class="c1"># input at a time</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">,</span> <span class="o">*</span><span class="n">argrow</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">argrow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">argsT</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">DEBUG_LIST_MODE</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">DEBUG_LIST_MODE</span><span class="p">:</span>
            <span class="n">proptup_gen</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">proptup_gen</span><span class="p">)</span>
            <span class="n">num_output</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">proptup_gen</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">num_output</span> <span class="o">==</span> <span class="n">nInput</span>
            <span class="p">),</span> <span class="s1">&#39;Input and output sizes do not agree. &#39;</span> <span class="s1">&#39;num_output=</span><span class="si">%r</span><span class="s1">, num_input=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">num_output</span><span class="p">,</span>
                <span class="n">nInput</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Append rowids and rectify nested and external columns</span>
        <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">prepare_storage</span><span class="p">(</span>
            <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">proptup_gen</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config_</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_LIST_MODE</span><span class="p">:</span>
            <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span> <span class="o">==</span> <span class="n">nInput</span>
        <span class="c1"># None data means that there was an error for a specific row</span>
        <span class="k">return</span> <span class="n">dirty_params_iter</span>

    <span class="k">def</span> <span class="nf">_chunk_compute_dirty_rows</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span> <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes registered functions, does external storage and yeilds results</span>
<span class="sd">        to be stored internally in SQL.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table _chunk_compute_dirty_rows</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3(in_memory=False)</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;labeler&#39;, [1, 2, 3], &#39;data&#39;, _debug=True)</span>
<span class="sd">            &gt;&gt;&gt; data = depc.get(&#39;indexer&#39;, [[1, 2, 3]], &#39;data&#39;, _debug=True)</span>
<span class="sd">            &gt;&gt;&gt; depc.print_all_tables()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_parent_ids</span><span class="p">)</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="n">nInput</span> <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">table</span><span class="o">.</span><span class="n">chunksize</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[deptbl.compute] nInput=</span><span class="si">{}</span><span class="s1">, chunksize=</span><span class="si">{}</span><span class="s1">, tbl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nInput</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Report computation progress</span>
        <span class="n">dirty_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">))</span>
        <span class="n">prog_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgChunks</span><span class="p">(</span>
            <span class="n">dirty_iter</span><span class="p">,</span>
            <span class="n">chunksize</span><span class="p">,</span>
            <span class="n">nInput</span><span class="p">,</span>
            <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;[deptbl.compute] add </span><span class="si">%s</span><span class="s1"> chunk&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># These are the colnames that we expect to be computed</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">computable_colnames</span><span class="p">()</span>
        <span class="c1"># def unfinished_features():</span>
        <span class="c1">#    if table._asobject:</span>
        <span class="c1">#        # Convinience</span>
        <span class="c1">#        argsT = [table.depc.get_obj(parent, rowids)</span>
        <span class="c1">#                 for parent, rowids in zip(table.parents(),</span>
        <span class="c1">#                                           dirty_parent_ids_chunk)]</span>
        <span class="c1">#        onthefly = None</span>
        <span class="c1">#        if table.default_onthefly or onthefly:</span>
        <span class="c1">#            assert not table.ismulti, (&#39;cannot onthefly multi tables&#39;)</span>
        <span class="c1">#            proptup_gen = [tuple([None] * len(table.data_col_attrs))</span>
        <span class="c1">#                           for _ in range(len(dirty_parent_ids_chunk))]</span>
        <span class="c1">#    pass</span>
        <span class="c1"># CALL EXTERNAL PREPROCESSING / GENERATION FUNCTION</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># prog_iter = list(prog_iter)</span>
            <span class="k">for</span> <span class="n">dirty_chunk</span> <span class="ow">in</span> <span class="n">prog_iter</span><span class="p">:</span>
                <span class="n">nChunkInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_chunk</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nChunkInput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">dirty_parent_ids_chunk</span><span class="p">,</span> <span class="n">dirty_preproc_args_chunk</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">dirty_chunk</span><span class="p">)</span>

                <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_compute_dirty_rows</span><span class="p">(</span>
                    <span class="n">dirty_parent_ids_chunk</span><span class="p">,</span>
                    <span class="n">dirty_preproc_args_chunk</span><span class="p">,</span>
                    <span class="n">config_rowid</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">DEBUG_LIST_MODE</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">DEBUG_LIST_MODE</span><span class="p">:</span>
                    <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span> <span class="o">==</span> <span class="n">nChunkInput</span>
                <span class="c1"># TODO: Separate into func which can be specified as a callback.</span>
                <span class="c1"># None data means that there was an error for a specific row</span>
                <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span>
                <span class="n">nChunkInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params_iter</span><span class="p">,</span> <span class="n">nChunkInput</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="s1">&#39;error in add_rowids&#39;</span><span class="p">,</span>
                <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">&#39;table&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;table.parents()&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;argsT&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dirty_parent_ids&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;table.preproc_func&#39;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>


<div class="viewcode-block" id="DependencyCacheTable"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">DependencyCacheTable</span><span class="p">(</span>
    <span class="n">_TableGeneralHelper</span><span class="p">,</span>
    <span class="n">_TableInternalSetup</span><span class="p">,</span>
    <span class="n">_TableDebugHelper</span><span class="p">,</span>
    <span class="n">_TableComputeHelper</span><span class="p">,</span>
    <span class="n">_TableConfigHelper</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An individual node in the dependency graph.</span>

<span class="sd">    All SQL column information is stored in:</span>
<span class="sd">        internal_col_attrs - keeps track of internal info</span>

<span class="sd">    Additional metadata about specific columns is stored in</span>
<span class="sd">        parent_col_attrs - keeps track of parent info</span>
<span class="sd">        data_col_attrs - keeps track of computed data</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (dtool.SQLDatabaseController): pointer to underlying database</span>
<span class="sd">        depc (dtool.DependencyCache): pointer to parent cache</span>
<span class="sd">        tablename (str): name of the table</span>
<span class="sd">        docstr (str): documentation for table</span>
<span class="sd">        parent_tablenames (str): parent tables in depcache</span>
<span class="sd">        data_colnames (List[str]): columns produced by preproc_func</span>
<span class="sd">        data_coltypes (List[str]): column SQL types produced by preproc_func</span>
<span class="sd">        preproc_func (func): worker function</span>
<span class="sd">        vectorized (bool): by defaults it is assumed registered functions can</span>
<span class="sd">            process multiple inputs at once.</span>
<span class="sd">        taggable (bool): specifies if a computed object can be disconected from</span>
<span class="sd">            its ancestors and accessed via a tag.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m dtool.depcache_table --exec-DependencyCacheTable</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">        &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">        &gt;&gt;&gt; print(depc[&#39;vsmany&#39;])</span>
<span class="sd">        &gt;&gt;&gt; print(depc[&#39;spam&#39;])</span>
<span class="sd">        &gt;&gt;&gt; print(depc[&#39;vsone&#39;])</span>
<span class="sd">        &gt;&gt;&gt; print(depc[&#39;nnindexer&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">depc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent_tablenames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tablename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data_coltypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">preproc_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s1">&#39;no docstr&#39;</span><span class="p">,</span>
        <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">asobject</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">isinteractive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_to_unpack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_onthefly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">rm_extern_on_delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">taggable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        recieves kwargs from depc._register_prop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># HACK: jedi type hinting. Need to have non-obvious condition</span>
            <span class="n">table</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">SQLDatabaseController</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">fpath_to_db</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s1">&#39;tablename=</span><span class="si">%r</span><span class="s1"> cannot contain numbers&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,)</span>
        <span class="c1"># parent depcache</span>
        <span class="n">table</span><span class="o">.</span><span class="n">depc</span> <span class="o">=</span> <span class="n">depc</span>
        <span class="c1"># Definitions</span>
        <span class="n">table</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">table</span><span class="o">.</span><span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span>
        <span class="n">table</span><span class="o">.</span><span class="n">parent_tablenames</span> <span class="o">=</span> <span class="n">parent_tablenames</span>
        <span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data_colnames</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">data_coltypes</span> <span class="o">=</span> <span class="n">data_coltypes</span>
        <span class="n">table</span><span class="o">.</span><span class="n">preproc_func</span> <span class="o">=</span> <span class="n">preproc_func</span>
        <span class="n">table</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="c1"># Behavior</span>
        <span class="n">table</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table</span><span class="o">.</span><span class="n">default_to_unpack</span> <span class="o">=</span> <span class="n">default_to_unpack</span>
        <span class="n">table</span><span class="o">.</span><span class="n">vectorized</span> <span class="o">=</span> <span class="n">vectorized</span>
        <span class="n">table</span><span class="o">.</span><span class="n">taggable</span> <span class="o">=</span> <span class="n">taggable</span>

        <span class="c1"># table.store_modification_time = True</span>
        <span class="c1"># Use the filesystem to accomplish this</span>
        <span class="c1"># table.store_access_time = True</span>
        <span class="c1"># table.store_create_time = True</span>
        <span class="c1"># table.store_delete_time = True</span>

        <span class="n">table</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="c1"># Developmental properties</span>
        <span class="n">table</span><span class="o">.</span><span class="n">subproperties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">table</span><span class="o">.</span><span class="n">isinteractive</span> <span class="o">=</span> <span class="n">isinteractive</span>
        <span class="n">table</span><span class="o">.</span><span class="n">_asobject</span> <span class="o">=</span> <span class="n">asobject</span>
        <span class="n">table</span><span class="o">.</span><span class="n">default_onthefly</span> <span class="o">=</span> <span class="n">default_onthefly</span>
        <span class="c1"># SQL Internals</span>
        <span class="n">table</span><span class="o">.</span><span class="n">sqldb_fpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table</span><span class="o">.</span><span class="n">rm_extern_on_delete</span> <span class="o">=</span> <span class="n">rm_extern_on_delete</span>
        <span class="c1"># Update internals</span>
        <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_infer_parentcol</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_infer_datacol</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_infer_allcol</span><span class="p">()</span>
        <span class="c1"># Check for errors</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">_assert_self</span><span class="p">()</span>

        <span class="n">table</span><span class="o">.</span><span class="n">_hack_chunk_cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="DependencyCacheTable.initialize"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures the SQL schema for this cache table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">fname_to_db</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">fname</span><span class="p">]</span>
        <span class="c1"># logger.info(&#39;Checking sql for table=%r&#39; % (table.tablename,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_debug</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing table=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_addtable_kw</span><span class="p">()</span>
            <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="o">**</span><span class="n">new_state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Check for table modifications</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_addtable_kw</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_state</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">strict</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                    <span class="n">ex</span><span class="p">,</span>
                    <span class="s1">&#39;TABLE </span><span class="si">%s</span><span class="s1"> IS CORRUPTED&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,),</span>
                    <span class="n">iswarning</span><span class="o">=</span><span class="ow">not</span> <span class="n">strict</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">table</span><span class="o">.</span><span class="n">clear_table</span><span class="p">()</span>
                <span class="n">current_state</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_state</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_state</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;WARNING TABLE IS MODIFIED&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">predrop_grace_period</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">):</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">clear_table</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Need to be able to modify tables&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_addtable_kw</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Information that defines the SQL table</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table _get_addtable_kw</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; table1 = depc[&#39;indexer&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table2 = depc[&#39;neighbs&#39;]</span>
<span class="sd">            &gt;&gt;&gt; add_table_kw1 = table1._get_addtable_kw()</span>
<span class="sd">            &gt;&gt;&gt; add_table_kw2 = table2._get_addtable_kw()</span>
<span class="sd">            &gt;&gt;&gt; result1 = (&#39;%s.add_table_kw = %s&#39; % (table1.tablename, ut.repr2(add_table_kw1, nl=2),))</span>
<span class="sd">            &gt;&gt;&gt; result2 = (&#39;%s.add_table_kw = %s&#39; % (table2.tablename, ut.repr2(add_table_kw2, nl=2),))</span>
<span class="sd">            &gt;&gt;&gt; print(result1)</span>
<span class="sd">            &gt;&gt;&gt; print(result2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">],</span> <span class="n">colattr</span><span class="p">[</span><span class="s1">&#39;sqltype&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">colattr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span>
        <span class="p">]</span>
        <span class="n">superkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">superkey_colnames</span><span class="p">]</span>
        <span class="n">add_table_kw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s1">&#39;tablename&#39;</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;coldef_list&#39;</span><span class="p">,</span>
                    <span class="n">coldef_list</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;docstr&#39;</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">docstr</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;superkeys&#39;</span><span class="p">,</span>
                    <span class="n">superkeys</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;dependson&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">()),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">add_table_kw</span>

    <span class="c1"># ----------------------</span>
    <span class="c1"># --- GETTERS NATIVE ---</span>
    <span class="c1"># ----------------------</span>

    <span class="k">def</span> <span class="nf">_get_all_rowids</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_of_rows</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_row_count</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="DependencyCacheTable.ensure_rows"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.ensure_rows">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_rows</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">parent_ids_</span><span class="p">,</span>
        <span class="n">preproc_args</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">retry</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">retry_delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lazy addition</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;vsone&#39;]</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(table.get_rowid), globals())</span>
<span class="sd">            &gt;&gt;&gt; config = table.configclass()</span>
<span class="sd">            &gt;&gt;&gt; _debug = 5</span>
<span class="sd">            &gt;&gt;&gt; verbose = True</span>
<span class="sd">            &gt;&gt;&gt; # test duplicate inputs are detected and accounted for</span>
<span class="sd">            &gt;&gt;&gt; parent_rowids = [(i, i) for i in list(range(100))] * 100</span>
<span class="sd">            &gt;&gt;&gt; rectify_tup = table._rectify_ids(parent_rowids)</span>
<span class="sd">            &gt;&gt;&gt; (parent_ids_, preproc_args, idxs1, idxs2) = rectify_tup</span>
<span class="sd">            &gt;&gt;&gt; rowids = table.ensure_rows(parent_ids_, preproc_args, config=config, _debug=_debug)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;rowids = %r&#39; % (rowids,))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_debug</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
            <span class="c1"># Get requested configuration id</span>
            <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_rowid</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># Check which rows are already computed</span>
            <span class="n">initial_rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_rowid</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="n">initial_rowid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_rowid_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[deptbl.ensure] initial_rowid_list = </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">initial_rowid_list</span><span class="p">),)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.ensure] config_rowid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_rowid</span><span class="p">,))</span>

            <span class="c1"># Get corresponding &quot;dirty&quot; parent rowids</span>
            <span class="n">isdirty_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">initial_rowid_list</span><span class="p">)</span>
            <span class="n">num_dirty</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">isdirty_list</span><span class="p">)</span>
            <span class="n">num_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_dirty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[ADD]&#39;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">_debug</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">_debug</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Add </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> new rows to </span><span class="si">%r</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">num_dirty</span><span class="p">,</span>
                                <span class="n">num_total</span><span class="p">,</span>
                                <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;[deptbl.add]  * config_rowid = </span><span class="si">{}</span><span class="s1">, config=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">config_rowid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">dirty_parent_ids_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">isdirty_list</span><span class="p">)</span>
                    <span class="n">dirty_preproc_args_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">preproc_args</span><span class="p">,</span> <span class="n">isdirty_list</span><span class="p">)</span>

                    <span class="c1"># Process only unique items</span>
                    <span class="n">unique_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="n">dirty_parent_ids_</span><span class="p">)</span>
                    <span class="n">dirty_parent_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dirty_parent_ids_</span><span class="p">,</span> <span class="n">unique_flags</span><span class="p">)</span>
                    <span class="n">dirty_preproc_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dirty_preproc_args_</span><span class="p">,</span> <span class="n">unique_flags</span><span class="p">)</span>

                    <span class="c1"># Break iterator into chunks</span>
                    <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="c1"># check parent configs we are working with</span>
                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">parname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">parname</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">parent_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">[</span><span class="n">parname</span><span class="p">]</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                            <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">parent_history</span> <span class="o">=</span> <span class="n">parent_table</span><span class="o">.</span><span class="n">get_config_history</span><span class="p">(</span>
                                    <span class="n">rowid_list</span>
                                <span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;parent_history = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_history</span><span class="p">,))</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;[depcache_table] WARNING: config history is having troubles... says Jon&#39;</span>
                                <span class="p">)</span>

                    <span class="c1"># Gives the function a hacky cache to use between chunks</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">_hack_chunk_cache</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">gen</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_chunk_compute_dirty_rows</span><span class="p">(</span>
                        <span class="n">dirty_parent_ids</span><span class="p">,</span> <span class="n">dirty_preproc_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="p">,</span> <span class="n">config</span>
                    <span class="p">)</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    colnames, dirty_params_iter, nChunkInput = next(gen)</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params_iter</span><span class="p">,</span> <span class="n">nChunkInput</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                            <span class="n">colnames</span><span class="p">,</span>
                            <span class="n">dirty_params_iter</span><span class="p">,</span>
                            <span class="n">nInput</span><span class="o">=</span><span class="n">nChunkInput</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="c1"># Remove cache when main add is done</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">_hack_chunk_cache</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">_debug</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.add] finished add&#39;</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># The requested data is clean and must now exist in the parent</span>
                    <span class="c1"># database, do a lookup to ensure the correct order.</span>
                    <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_rowid</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">initial_rowid_list</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.add] rowid_list = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">lite</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;DEPC ENSURE_ROWS FOR TABLE </span><span class="si">%r</span><span class="s1"> FAILED DUE TO INTEGRITY ERROR (RETRY </span><span class="si">%d</span><span class="s1">)!&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">table</span><span class="p">,</span>
                    <span class="n">retry</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> WAITING </span><span class="si">%d</span><span class="s1"> SECONDS THEN RETRYING&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">retry_delay</span><span class="p">,))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>

            <span class="n">retry_</span> <span class="o">=</span> <span class="n">retry</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">ensure_rows</span><span class="p">(</span>
                <span class="n">parent_ids_</span><span class="p">,</span>
                <span class="n">preproc_args</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span><span class="p">,</span>
                <span class="n">retry</span><span class="o">=</span><span class="n">retry_</span><span class="p">,</span>
                <span class="n">retry_delay</span><span class="o">=</span><span class="n">retry_delay</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">rowid_list</span></div>

    <span class="k">def</span> <span class="nf">_rectify_ids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters any rows containing None ids and transforms many-to-one sets of</span>
<span class="sd">        rowids into hashable UUIDS.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;vocab&#39;</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;indexer&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; parent_rowids = [[1, 2, 3]]</span>
<span class="sd">            &gt;&gt;&gt; rectify_tup = table._rectify_ids(parent_rowids)</span>
<span class="sd">            &gt;&gt;&gt; parent_ids_, preproc_args, idxs1, idxs2 = rectify_tup</span>
<span class="sd">            ......</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;parent_ids_ = %r&#39; % (parent_ids_,)) + &#39;\n&#39;</span>
<span class="sd">            &gt;&gt;&gt; result += (&#39;preproc_args = %r&#39; % (preproc_args,))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>

<span class="sd">            parent_ids_ = [(UUID(&#39;356a192b-7913-b04c-5457-4d18c28d46e6&#39;),)]</span>
<span class="sd">            preproc_args = [[1, 2, 3]]</span>

<span class="sd">        Example1:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;vocab&#39;</span>
<span class="sd">            &gt;&gt;&gt; tablename = &#39;indexer&#39;</span>
<span class="sd">            &gt;&gt;&gt; table = depc[tablename]</span>
<span class="sd">            &gt;&gt;&gt; parent_rowids = [[1, 2, 3]]</span>
<span class="sd">            &gt;&gt;&gt; rowids = depc.get_rowids(tablename, parent_rowids)</span>
<span class="sd">            &gt;&gt;&gt; model_uuid_list = table.get_internal_columns(rowids, (&#39;model_uuid&#39;,))</span>
<span class="sd">            &gt;&gt;&gt; model_uuid = model_uuid_list[0]</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;model_uuid = %r&#39; % (model_uuid,))</span>
<span class="sd">            &gt;&gt;&gt; rowids2 = table.get_model_rowids(model_uuid_list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Force entire row to be none if any are none</span>
        <span class="n">anyNone_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parent_rowids</span><span class="p">]</span>
        <span class="n">idxs2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">anyNone_flags</span><span class="p">)</span>
        <span class="n">idxs1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">idxs2</span><span class="p">,</span> <span class="n">len_</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">))</span>
        <span class="n">valid_parent_ids_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">)</span>

        <span class="n">preproc_args</span> <span class="o">=</span> <span class="n">valid_parent_ids_</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">:</span>
            <span class="c1"># Convert any parent-id containing multiple values into a hash of uuids</span>
            <span class="n">multi_parent_flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_col_attr</span><span class="p">(</span><span class="s1">&#39;ismulti&#39;</span><span class="p">)</span>
            <span class="n">num_parents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_parent_flags</span><span class="p">)</span>
            <span class="n">multi_parent_colxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">multi_parent_flags</span><span class="p">)</span>
            <span class="n">normal_colxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">multi_parent_colxs</span><span class="p">,</span> <span class="n">num_parents</span><span class="p">)</span>
            <span class="n">multi_parents</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">ids_</span><span class="p">,</span> <span class="n">multi_parent_colxs</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">valid_parent_ids_</span>
            <span class="p">]</span>
            <span class="n">normal_parents</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">ids_</span><span class="p">,</span> <span class="n">normal_colxs</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">valid_parent_ids_</span>
            <span class="p">]</span>
            <span class="c1"># TODO: give each table a uuid getter function that derives from</span>
            <span class="c1"># get_root_uuids</span>
            <span class="n">multicol_tables</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">parents</span><span class="p">(),</span> <span class="n">multi_parent_colxs</span><span class="p">)</span>
            <span class="n">parent_uuid_getters</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">get_root_uuid</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">root</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">identity</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">multicol_tables</span>
            <span class="p">]</span>

            <span class="n">parent_uuids_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">uuid_getter</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">uuid_getter</span><span class="p">,</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parent_uuid_getters</span><span class="p">,</span> <span class="n">ids_tup</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">ids_tup</span> <span class="ow">in</span> <span class="n">multi_parents</span>
            <span class="p">]</span>
            <span class="n">multiset_uuid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">hashable_to_uuid</span><span class="p">(</span><span class="n">uuids</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuids</span> <span class="ow">in</span> <span class="n">parent_uuids_tup</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">parent_uuids_tup</span> <span class="ow">in</span> <span class="n">parent_uuids_list</span>
            <span class="p">]</span>
            <span class="c1"># preproc args are usually the same as parent ids.  Model tables</span>
            <span class="c1"># are the exception.</span>
            <span class="n">parent_ids_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">ungroup</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">uuids</span><span class="p">,</span> <span class="n">normalids</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">multi_parent_colxs</span><span class="p">,</span> <span class="n">normal_colxs</span><span class="p">],</span>
                        <span class="n">num_parents</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">uuids</span><span class="p">,</span> <span class="n">normalids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">multiset_uuid_list</span><span class="p">,</span> <span class="n">normal_parents</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_ids_</span> <span class="o">=</span> <span class="n">valid_parent_ids_</span>
        <span class="n">rectify_tup</span> <span class="o">=</span> <span class="n">parent_ids_</span><span class="p">,</span> <span class="n">preproc_args</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span>
        <span class="k">return</span> <span class="n">rectify_tup</span>

    <span class="k">def</span> <span class="nf">_unrectify_ids</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list_</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that output is the same length as input. Inserts necessary</span>
<span class="sd">        Nones where the original input was also None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: turn into generator</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ungroup</span><span class="p">([</span><span class="n">rowid_list_</span><span class="p">],</span> <span class="p">[</span><span class="n">idxs1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

<div class="viewcode-block" id="DependencyCacheTable.get_rowid"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.get_rowid">[docs]</a>    <span class="k">def</span> <span class="nf">get_rowid</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">parent_rowids</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the rowids of derived properties.  If they do not exist it</span>
<span class="sd">        computes them.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_rowids (list): list of tuples with the parent rowids as the</span>
<span class="sd">                    value of each tuple</span>
<span class="sd">            config (None): (default = None)</span>
<span class="sd">            ensure (bool): eager evaluation if True (default = True)</span>
<span class="sd">            eager (bool): (default = True)</span>
<span class="sd">            nInput (int): (default = None)</span>
<span class="sd">            recompute (bool): (default = False)</span>
<span class="sd">            _debug (None): (default = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: rowid_list</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-get_rowid</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache2 import testdata_depc3</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc3()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;labeler&#39;]</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(table.get_rowid), globals())</span>
<span class="sd">            &gt;&gt;&gt; config = table.configclass()</span>
<span class="sd">            &gt;&gt;&gt; _debug = True</span>
<span class="sd">            &gt;&gt;&gt; parent_rowids = list(zip([1, None, None, 2]))</span>
<span class="sd">            &gt;&gt;&gt; rowids = table.get_rowid(parent_rowids, config=config, _debug=_debug)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;rowids = %r&#39; % (rowids,))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            rowids = [1, None, None, 2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[deptbl.get_rowid] Get </span><span class="si">%s</span><span class="s1"> rowids via </span><span class="si">%d</span><span class="s1"> parent superkeys&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.get_rowid] config = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">,))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.get_rowid] ensure = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ensure</span><span class="p">,))</span>

        <span class="c1"># Ensure inputs are in the correct format / remove Nones</span>
        <span class="c1"># Collapse multi-inputs into a UUID hash</span>
        <span class="n">rectify_tup</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_rectify_ids</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">)</span>
        <span class="p">(</span><span class="n">parent_ids_</span><span class="p">,</span> <span class="n">preproc_args</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">)</span> <span class="o">=</span> <span class="n">rectify_tup</span>
        <span class="c1"># Do the getting / adding work</span>
        <span class="k">if</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REQUESTED RECOMPUTE&#39;</span><span class="p">)</span>
            <span class="c1"># get existing rowids, delete them, recompute the request</span>
            <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_rowid</span><span class="p">(</span>
                <span class="n">parent_ids_</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
            <span class="p">)</span>
            <span class="n">rowid_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rowid_list_</span><span class="p">)</span>
            <span class="n">needs_recompute_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">rowid_list_</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">_recompute_and_store</span><span class="p">(</span><span class="n">needs_recompute_rowids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If the config changes, there is nothing we can do.</span>
                <span class="c1"># We have to delete the rows.</span>
                <span class="n">table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">rowid_list_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensure</span> <span class="ow">or</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="c1"># Compute properties if they do not exist</span>
            <span class="k">for</span> <span class="n">try_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_retries</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">ensure_rows</span><span class="p">(</span>
                        <span class="n">parent_ids_</span><span class="p">,</span> <span class="n">preproc_args</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">ExternalStorageException</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">try_num</span> <span class="o">==</span> <span class="n">num_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_get_rowid</span><span class="p">(</span>
                <span class="n">parent_ids_</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="n">_debug</span>
            <span class="p">)</span>
        <span class="c1"># Map outputs to correspond with inputs</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_unrectify_ids</span><span class="p">(</span><span class="n">rowid_list_</span><span class="p">,</span> <span class="n">parent_rowids</span><span class="p">,</span> <span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span></div>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">_get_rowid</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">parent_ids_</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns rowids using parent superkeys. Does not add non-existing</span>
<span class="sd">        properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">,)</span>
        <span class="n">config_rowid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_rowid</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid table.tablename = </span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid parent_ids_ = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">parent_ids_</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid config = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid table.rowid_colname = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid config_rowid = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_rowid</span><span class="p">))</span>
        <span class="n">andwhere_colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">superkey_colnames</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">ids_</span> <span class="o">+</span> <span class="p">(</span><span class="n">config_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">parent_ids_</span><span class="p">)</span>
        <span class="c1"># TODO: make sure things that call this can accept a generator</span>
        <span class="c1"># Then remove this next line</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;**params_iter = %r&#39; % (params_iter,))</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_where_eq</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">colnames</span><span class="p">,</span>
            <span class="n">params_iter</span><span class="p">,</span>
            <span class="n">andwhere_colnames</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_get_rowid rowid_list = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

<div class="viewcode-block" id="DependencyCacheTable.clear_table"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.clear_table">[docs]</a>    <span class="k">def</span> <span class="nf">clear_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all data in this table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: need to clear one-to-one dependencies as well</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clearing data in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,))</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="o">**</span><span class="n">table</span><span class="o">.</span><span class="n">_get_addtable_kw</span><span class="p">())</span></div>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="DependencyCacheTable.delete_rows"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.delete_rows">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rows</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="n">delete_extern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --exec-delete_rows</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; #table = depc[&#39;keypoint&#39;]</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;chip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(table.delete_rows), globals())</span>
<span class="sd">            &gt;&gt;&gt; tablename = table.tablename</span>
<span class="sd">            &gt;&gt;&gt; graph = depc.explicit_graph</span>
<span class="sd">            &gt;&gt;&gt; config1 = None</span>
<span class="sd">            &gt;&gt;&gt; config2 = table.configclass(version=-1)</span>
<span class="sd">            &gt;&gt;&gt; config3 = table.configclass(version=-1, ext=&#39;.jpg&#39;)</span>
<span class="sd">            &gt;&gt;&gt; config4 = table.configclass(ext=&#39;.jpg&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # Create several configs of rowid</span>
<span class="sd">            &gt;&gt;&gt; aids = [1, 2, 3]</span>
<span class="sd">            &gt;&gt;&gt; depc.get_rowids(&#39;spam&#39;, aids, config=config1)</span>
<span class="sd">            &gt;&gt;&gt; depc.get_rowids(&#39;spam&#39;, aids, config=config2)</span>
<span class="sd">            &gt;&gt;&gt; depc.get_rowids(&#39;spam&#39;, aids, config=config3)</span>
<span class="sd">            &gt;&gt;&gt; depc.get_rowids(&#39;spam&#39;, aids, config=config4)</span>
<span class="sd">            &gt;&gt;&gt; # Delete the png configs</span>
<span class="sd">            &gt;&gt;&gt; rowid_list1 = depc.get_rowids(table.tablename, aids,</span>
<span class="sd">            &gt;&gt;&gt;                               config=config2)</span>
<span class="sd">            &gt;&gt;&gt; rowid_list2 = depc.get_rowids(table.tablename, aids,</span>
<span class="sd">            &gt;&gt;&gt;                               config=config1)</span>
<span class="sd">            &gt;&gt;&gt; rowid_list = rowid_list1 + rowid_list2</span>
<span class="sd">            &gt;&gt;&gt; assert len(ut.setintersect_ordered(rowid_list1, rowid_list2)) == 0</span>
<span class="sd">            &gt;&gt;&gt; table.delete_rows(rowid_list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># import networkx as nx</span>
        <span class="c1"># from wbia.dtool.algo.preproc import preproc_feat</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">on_delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">on_delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">delete_extern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delete_extern</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rm_extern_on_delete</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Requested delete of </span><span class="si">%d</span><span class="s1"> rows from </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">),</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">dry</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dry run&#39;</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;delete_extern = %r&#39; % (delete_extern,))</span>
        <span class="n">depc</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span>

        <span class="c1"># TODO:</span>
        <span class="c1"># REMOVE EXTERNAL FILES</span>
        <span class="n">internal_colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_intern_data_col_attr</span><span class="p">(</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">)</span>
        <span class="n">is_extern</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_intern_data_col_attr</span><span class="p">(</span><span class="s1">&#39;is_external_pointer&#39;</span><span class="p">)</span>
        <span class="n">extern_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">internal_colnames</span><span class="p">,</span> <span class="n">is_extern</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extern_colnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">uris</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_internal_columns</span><span class="p">(</span>
                <span class="n">rowid_list</span><span class="p">,</span>
                <span class="n">extern_colnames</span><span class="p">,</span>
                <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">keepwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">absuris</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">uris</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="p">[</span><span class="n">uri</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">uri_</span> <span class="ow">in</span> <span class="n">uri</span><span class="p">:</span>
                    <span class="n">absuris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">uri_</span><span class="p">))</span>
            <span class="n">fpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">fpath</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">absuris</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">delete_extern</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpaths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleting </span><span class="si">{}</span><span class="s1"> existing internal files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dry</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">remove_fpaths</span><span class="p">(</span><span class="n">fpaths</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpaths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Leaving </span><span class="si">{}</span><span class="s1"> dangling filepaths&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths</span><span class="p">)))</span>

        <span class="c1"># DELETE EXPLICITLY DEFINED CHILDREN</span>
        <span class="c1"># (TODO: handle implicit definitions)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">get_child_partial_rowids</span><span class="p">(</span><span class="n">child_table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="n">parent_colnames</span><span class="p">):</span>
                <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">child_table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">,)</span>
                <span class="n">andwhere_colnames</span> <span class="o">=</span> <span class="n">parent_colnames</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list</span><span class="p">)</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
                <span class="n">child_db</span> <span class="o">=</span> <span class="n">depc</span><span class="p">[</span><span class="n">child_table</span><span class="o">.</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">db</span>
                <span class="n">child_unflat_rowids</span> <span class="o">=</span> <span class="n">child_db</span><span class="o">.</span><span class="n">get_where_eq</span><span class="p">(</span>
                    <span class="n">child_table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
                    <span class="n">colnames</span><span class="p">,</span>
                    <span class="n">params_iter</span><span class="p">,</span>
                    <span class="n">andwhere_colnames</span><span class="p">,</span>
                    <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">keepwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">child_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">child_unflat_rowids</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">child_rowids</span>

            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting from </span><span class="si">%r</span><span class="s1"> children&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">children</span><span class="p">),))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Table is a leaf node&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">child_table</span><span class="o">.</span><span class="n">ismulti</span><span class="p">:</span>
                    <span class="c1"># Hack, wont work for vsone / multisets</span>
                    <span class="n">parent_colnames</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">child_table</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">][</span><span class="s1">&#39;intern_colname&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">child_rowids</span> <span class="o">=</span> <span class="n">get_child_partial_rowids</span><span class="p">(</span>
                        <span class="n">child_table</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="n">parent_colnames</span>
                    <span class="p">)</span>
                    <span class="n">child_table</span><span class="o">.</span><span class="n">delete_rows</span><span class="p">(</span><span class="n">child_rowids</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="n">dry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
            <span class="n">non_none_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_rowids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Deleting </span><span class="si">%d</span><span class="s1"> non-None rows from </span><span class="si">%s</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_none_rowids</span><span class="p">),</span> <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...done!&#39;</span><span class="p">)</span>

        <span class="c1"># Finalize: Delete rows from this table</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_rowids</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">)</span>
            <span class="n">num_deleted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">num_deleted</span></div>

    <span class="k">def</span> <span class="nf">_resolve_requested_columns</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">requested_colnames</span><span class="p">):</span>
        <span class="c1">########</span>
        <span class="c1"># Map requested colnames flat to internal colnames</span>
        <span class="c1">########</span>
        <span class="c1"># Get requested column information</span>
        <span class="n">requestable_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">requestable_col_attrs</span><span class="p">()</span>
        <span class="n">requested_colattrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">requestable_col_attrs</span><span class="p">,</span> <span class="n">requested_colnames</span><span class="p">)</span>
        <span class="c1"># Make column indicies iterable for grouping</span>
        <span class="n">intern_colxs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">xs</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">xs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">requested_colattrs</span><span class="p">,</span> <span class="s1">&#39;intern_colx&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">nested_offsets_end</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">intern_colxs</span><span class="p">))</span>
        <span class="n">nested_offsets_start</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nested_offsets_end</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Mark any columns with external information</span>
        <span class="n">isextern_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">requested_colattrs</span><span class="p">,</span> <span class="s1">&#39;is_extern&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">extern_colattrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">requested_colattrs</span><span class="p">,</span> <span class="n">isextern_flags</span><span class="p">)</span>
        <span class="n">extern_resolve_colxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nested_offsets_start</span><span class="p">,</span> <span class="n">isextern_flags</span><span class="p">)</span>
        <span class="n">extern_read_funcs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">extern_colattrs</span><span class="p">,</span> <span class="s1">&#39;read_func&#39;</span><span class="p">)</span>
        <span class="n">intern_colnames_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span><span class="p">,</span> <span class="s1">&#39;intern_colname&#39;</span><span class="p">)</span>
        <span class="n">intern_colnames</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_take</span><span class="p">(</span><span class="n">intern_colnames_</span><span class="p">,</span> <span class="n">intern_colxs</span><span class="p">)</span>

        <span class="c1"># TODO: this can be cleaned up</span>
        <span class="n">nesting_xs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x1</span> <span class="k">if</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nested_offsets_start</span><span class="p">,</span> <span class="n">nested_offsets_end</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">extern_resolve_tups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">extern_resolve_colxs</span><span class="p">,</span> <span class="n">extern_read_funcs</span><span class="p">))</span>
        <span class="n">flat_intern_colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">intern_colnames</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">nesting_xs</span><span class="p">,</span> <span class="n">extern_resolve_tups</span><span class="p">,</span> <span class="n">flat_intern_colnames</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="DependencyCacheTable.get_row_data"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.get_row_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_data</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">tbl_rowids</span><span class="p">,</span>
        <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">read_extern</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">delete_on_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">showprog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">unpack_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FIXME: unpacking is confusing with sql controller</span>
<span class="sd">        TODO: Clean up and allow for eager=False</span>

<span class="sd">        colnames = (&#39;mask&#39;, &#39;size&#39;)</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m dtool.depcache_table --test-get_row_data:0</span>
<span class="sd">            python -m dtool.depcache_table --test-get_row_data:1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.depcache_table import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import testdata_depc</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;chip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(table.get_row_data), globals())</span>
<span class="sd">            &gt;&gt;&gt; tbl_rowids = depc.get_rowids(&#39;chip&#39;, [1, 2, 3], _debug=True, recompute=True)</span>
<span class="sd">            &gt;&gt;&gt; colnames = (&#39;size_1&#39;, &#39;size&#39;, &#39;chip&#39; + EXTERN_SUFFIX, &#39;chip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs = dict(read_extern=True, num_retries=1, _debug=True)</span>
<span class="sd">            &gt;&gt;&gt; prop_list = table.get_row_data(tbl_rowids, colnames, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; prop_list0 = ut.take_column(prop_list, [0, 1, 2]) # data subset</span>
<span class="sd">            &gt;&gt;&gt; result = (ut.repr2(prop_list0, nl=1))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            &gt;&gt;&gt; #_debug, num_retries, read_extern = True, 1, True</span>
<span class="sd">            &gt;&gt;&gt; prop_gen = table.get_row_data(tbl_rowids, colnames, eager=False)</span>
<span class="sd">            &gt;&gt;&gt; prop_list2 = list(prop_gen)</span>
<span class="sd">            &gt;&gt;&gt; assert len(prop_list2) == len(prop_list), &#39;inconsistent lens&#39;</span>
<span class="sd">            &gt;&gt;&gt; assert all([ut.lists_eq(prop_list2[1], prop_list[1]) for x in range(len(prop_list))]), &#39;inconsistent vals&#39;</span>
<span class="sd">            &gt;&gt;&gt; chips = table.get_row_data(tbl_rowids, &#39;chip&#39;, eager=False)</span>

<span class="sd">            [</span>
<span class="sd">                [2453, (1707, 2453), &#39;chip_chip_id=1_pyrappzicqoskdjq.png&#39;],</span>
<span class="sd">                [250, (300, 250), &#39;chip_chip_id=2_pyrappzicqoskdjq.png&#39;],</span>
<span class="sd">                [372, (545, 372), &#39;chip_chip_id=3_pyrappzicqoskdjq.png&#39;],</span>
<span class="sd">            ]</span>


<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Test external / ensure getters</span>
<span class="sd">            &gt;&gt;&gt; from wbia.dtool.example_depcache import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; depc = testdata_depc()</span>
<span class="sd">            &gt;&gt;&gt; table = depc[&#39;chip&#39;]</span>
<span class="sd">            &gt;&gt;&gt; exec(ut.execstr_funckw(table.get_row_data), globals())</span>
<span class="sd">            &gt;&gt;&gt; depc.clear_all()</span>
<span class="sd">            &gt;&gt;&gt; config = {}</span>
<span class="sd">            &gt;&gt;&gt; aids = [1,]</span>
<span class="sd">            &gt;&gt;&gt; read_extern = False</span>
<span class="sd">            &gt;&gt;&gt; tbl_rowids = depc.get_rowids(&#39;chip&#39;, aids, config=config)</span>
<span class="sd">            &gt;&gt;&gt; data_fpaths = depc.get(&#39;chip&#39;, aids, &#39;chip&#39;, config=config, read_extern=False)</span>
<span class="sd">            &gt;&gt;&gt; # Ensure data is recomputed if an external file is missing</span>
<span class="sd">            &gt;&gt;&gt; ut.remove_fpaths(data_fpaths)</span>
<span class="sd">            &gt;&gt;&gt; data = table.get_row_data(tbl_rowids, &#39;chip&#39;, read_extern=False, ensure=False)</span>
<span class="sd">            &gt;&gt;&gt; data = table.get_row_data(tbl_rowids, &#39;chip&#39;, read_extern=False, ensure=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_debug</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">_debug</span> <span class="k">if</span> <span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_debug</span>
        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;Get col of tablename=</span><span class="si">%r</span><span class="s1">, colnames=</span><span class="si">%r</span><span class="s1"> with &#39;</span> <span class="s1">&#39;tbl_rowids=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="c1">####</span>
        <span class="c1"># Resolve requested column names</span>
        <span class="k">if</span> <span class="n">unpack_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unpack_columns</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">default_to_unpack</span>
        <span class="k">if</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">requested_colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">data_colnames</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="c1"># Unpack columns if only a single column is requested.</span>
            <span class="n">requested_colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">colnames</span><span class="p">,)</span>
            <span class="n">unpack_columns</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">requested_colnames</span> <span class="o">=</span> <span class="n">colnames</span>

        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;requested_colnames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">requested_colnames</span><span class="p">,))</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_resolve_requested_columns</span><span class="p">(</span><span class="n">requested_colnames</span><span class="p">)</span>
        <span class="n">nesting_xs</span><span class="p">,</span> <span class="n">extern_resolve_tups</span><span class="p">,</span> <span class="n">flat_intern_colnames</span> <span class="o">=</span> <span class="n">tup</span>

        <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[deptbl.get_row_data] flat_intern_colnames = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">flat_intern_colnames</span><span class="p">,)</span>
            <span class="p">)</span>

        <span class="n">nonNone_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_not_None_items</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="n">nonNone_tbl_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">nonNone_flags</span><span class="p">)</span>
        <span class="n">idxs1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nonNone_flags</span><span class="p">)</span>

        <span class="n">idxs2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">idxs1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">))</span>

        <span class="c1">####</span>
        <span class="c1"># Read data stored in SQL</span>
        <span class="c1"># FIXME: understand unpack_scalars and keepwrap</span>
        <span class="c1"># if table.default_onthefly:</span>
        <span class="c1"># table._onthefly_dataget</span>
        <span class="c1"># else:</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">nonNone_tbl_rowids</span><span class="p">):</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonNone_tbl_rowids</span><span class="p">)</span>

        <span class="n">generator_version</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">eager</span>

        <span class="n">raw_prop_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_internal_columns</span><span class="p">(</span>
            <span class="n">nonNone_tbl_rowids</span><span class="p">,</span>
            <span class="n">flat_intern_colnames</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
            <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">keepwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">showprog</span><span class="o">=</span><span class="n">showprog</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">tup_unflat_take</span><span class="p">(</span><span class="n">items_list</span><span class="p">,</span> <span class="n">unflat_index_list</span><span class="p">):</span>
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Hack for depcache, that needs a tuple version of ut.unflat_take</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">tuptake</span><span class="p">(</span><span class="n">list_</span><span class="p">,</span> <span class="n">index_list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">list_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">list_</span><span class="p">[</span><span class="n">index_list</span><span class="p">]</span>

            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">tup_unflat_take</span><span class="p">(</span><span class="n">items_list</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">tuptake</span><span class="p">(</span><span class="n">items_list</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">unflat_index_list</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># if len(raw_prop_list) &gt; 0:</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonNone_tbl_rowids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">generator_version</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">_generator_resolve_all</span><span class="p">():</span>
                    <span class="n">extern_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">extern_dpath</span>
                    <span class="k">for</span> <span class="n">rawprop</span> <span class="ow">in</span> <span class="n">raw_prop_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rawprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                                <span class="s1">&#39;raw prop was None, but it should always be a tuple. &#39;</span>
                                <span class="s1">&#39;This may indicate that the cache needs to be cleared&#39;</span>
                            <span class="p">)</span>

                        <span class="n">exprop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rawprop</span><span class="p">)</span>
                        <span class="c1"># Modify prop with external data</span>
                        <span class="k">for</span> <span class="n">extern_colx</span><span class="p">,</span> <span class="n">read_func</span> <span class="ow">in</span> <span class="n">extern_resolve_tups</span><span class="p">:</span>
                            <span class="n">uri</span> <span class="o">=</span> <span class="n">exprop</span><span class="p">[</span><span class="n">extern_colx</span><span class="p">]</span>
                            <span class="n">uri_full</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">read_extern</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">(</span><span class="n">uri_full</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">uri_full</span>
                                <span class="k">if</span> <span class="n">ensure</span><span class="p">:</span>
                                    <span class="n">ut</span><span class="o">.</span><span class="n">assertpath</span><span class="p">(</span><span class="n">uri_full</span><span class="p">)</span>
                            <span class="n">exprop</span><span class="p">[</span><span class="n">extern_colx</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                        <span class="c1"># nestprop = ut.unflat_take(exprop, nesting_xs)</span>
                        <span class="n">nestprop</span> <span class="o">=</span> <span class="n">tup_unflat_take</span><span class="p">(</span><span class="n">exprop</span><span class="p">,</span> <span class="n">nesting_xs</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">nestprop</span>

                <span class="n">prop_gen</span> <span class="o">=</span> <span class="n">_generator_resolve_all</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">unpack_columns</span><span class="p">:</span>
                    <span class="n">prop_gen</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prop_gen</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;noneager mode not fully worked out yet&#39;</span>
                <span class="k">return</span> <span class="n">prop_gen</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># logger.info(&#39;raw_prop_list = %r&#39; % (raw_prop_list,))</span>
                <span class="k">if</span> <span class="n">num_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">raw_prop_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_prop_list</span><span class="p">)</span>  <span class="c1"># TODO tee iterator instead?</span>
                <span class="k">for</span> <span class="n">try_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">tries_left</span> <span class="o">=</span> <span class="n">num_retries</span> <span class="o">-</span> <span class="n">try_num</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">prop_listT</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_resolve_any_external_data</span><span class="p">(</span>
                            <span class="n">nonNone_tbl_rowids</span><span class="p">,</span>
                            <span class="n">raw_prop_list</span><span class="p">,</span>
                            <span class="n">extern_resolve_tups</span><span class="p">,</span>
                            <span class="n">ensure</span><span class="p">,</span>
                            <span class="n">read_extern</span><span class="p">,</span>
                            <span class="n">delete_on_fail</span><span class="p">,</span>
                            <span class="n">tries_left</span><span class="p">,</span>
                            <span class="n">_debug</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="n">ExternalStorageException</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tries_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Things worked, dont need to try again</span>
                        <span class="k">break</span>
                <span class="c1">####</span>
                <span class="c1"># Unflatten data into any given nested structure</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop_listT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nested_proplistT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflat_take</span><span class="p">(</span><span class="n">prop_listT</span><span class="p">,</span> <span class="n">nesting_xs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">nesting_xs</span><span class="p">]):</span>
                        <span class="n">nested_proplistT</span><span class="p">[</span><span class="n">tx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">nested_proplistT</span><span class="p">[</span><span class="n">tx</span><span class="p">]))</span>
                    <span class="n">prop_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">nested_proplistT</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prop_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">####</span>
                <span class="c1"># Unpack single column datas if requested</span>
                <span class="k">if</span> <span class="n">unpack_columns</span><span class="p">:</span>
                    <span class="n">prop_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prop_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prop_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ungroup</span><span class="p">(</span>
                <span class="p">[</span><span class="n">prop_list</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs2</span><span class="p">)],</span> <span class="p">[</span><span class="n">idxs1</span><span class="p">,</span> <span class="n">idxs2</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">prop_list</span></div>

    <span class="k">def</span> <span class="nf">_resolve_any_external_data</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">nonNone_tbl_rowids</span><span class="p">,</span>
        <span class="n">raw_prop_list</span><span class="p">,</span>
        <span class="n">extern_resolve_tups</span><span class="p">,</span>
        <span class="n">ensure</span><span class="p">,</span>
        <span class="n">read_extern</span><span class="p">,</span>
        <span class="n">delete_on_fail</span><span class="p">,</span>
        <span class="n">tries_left</span><span class="p">,</span>
        <span class="n">_debug</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1">####</span>
        <span class="c1"># Read data specified by any external columns</span>
        <span class="n">extern_dpath</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">extern_dpath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prop_listT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">raw_prop_list</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;error on prop_list shape&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;raw_prop_list&#39;</span><span class="p">])</span>
            <span class="k">raise</span>

        <span class="k">for</span> <span class="n">extern_colx</span><span class="p">,</span> <span class="n">read_func</span> <span class="ow">in</span> <span class="n">extern_resolve_tups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[deptbl.get_row_data] read_func = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">read_func</span><span class="p">,))</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">failed_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">prop_listT</span><span class="p">[</span><span class="n">extern_colx</span><span class="p">]:</span>
                <span class="n">uri_full</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">read_extern</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">read_func</span><span class="p">(</span><span class="n">uri_full</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ensure</span><span class="p">:</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">assertpath</span><span class="p">(</span><span class="n">uri_full</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">uri_full</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                        <span class="n">ex</span><span class="p">,</span>
                        <span class="s1">&#39;failed to load external data&#39;</span><span class="p">,</span>
                        <span class="n">iswarning</span><span class="o">=</span><span class="p">(</span><span class="n">tries_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                            <span class="s1">&#39;tries_left&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uri&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uri_full&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="s1">&#39;uri_full&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;read_func&#39;</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">tries_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="n">failed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">failed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">failed_list</span><span class="p">):</span>
                <span class="c1"># FIXME: should directly recompute the data in the rows</span>
                <span class="c1"># rather than deleting the rowids.  Need the parent ids and</span>
                <span class="c1"># config to do that.</span>
                <span class="n">failed_uris</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">prop_listT</span><span class="p">[</span><span class="n">extern_colx</span><span class="p">],</span> <span class="n">failed_list</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Failed to read </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">trunc_repr</span><span class="p">(</span><span class="n">failed_uris</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">300</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">failed_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">nonNone_tbl_rowids</span><span class="p">,</span> <span class="n">failed_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">delete_on_fail</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">_recompute_external_storage</span><span class="p">(</span><span class="n">failed_rowids</span><span class="p">)</span>
                    <span class="c1"># table.delete_rows(failed_rowids, delete_extern=None)</span>
                <span class="k">raise</span> <span class="n">ExternalStorageException</span><span class="p">(</span>
                    <span class="s1">&#39;Some cached filenames failed to read. &#39;</span>
                    <span class="s1">&#39;Need to recompute </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> rows&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">failed_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_list</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="c1"># raise Exception(&#39;Non existant data on disk. Need to recompute rows&#39;)</span>
            <span class="n">prop_listT</span><span class="p">[</span><span class="n">extern_colx</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_list</span>
        <span class="k">return</span> <span class="n">prop_listT</span>

    <span class="k">def</span> <span class="nf">_recompute_external_storage</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tbl_rowids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recomputes the external file stored for this row.</span>
<span class="sd">        This DOES NOT modify the depcache internals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recomputing external data (_recompute_external_storage)&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: need to rectify parent ids?</span>

        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="n">parent_rowargs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowargs</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>

        <span class="c1"># configs = table.get_row_configs(tbl_rowids)</span>
        <span class="c1"># assert ut.allsame(list(map(id, configs))), &#39;more than one config not yet supported&#39;</span>
        <span class="c1"># TODO; groupby config</span>
        <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="n">unique_cfgids</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">config_rowids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">cfgid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groupxs</span><span class="p">,</span> <span class="n">unique_cfgids</span><span class="p">):</span>
            <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">parent_rowargs</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_from_rowid</span><span class="p">([</span><span class="n">cfgid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_compute_dirty_rows</span><span class="p">(</span>
                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="o">=</span><span class="n">cfgid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
            <span class="p">)</span>
            <span class="c1"># Evaulate just to ensure storage</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">dirty_params_iter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_and_store</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recomputes all data stored for this row.</span>
<span class="sd">        This DOES modify the depcache internals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recomputing external data (_recompute_and_store)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">parent_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowids</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="n">parent_rowargs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_parent_rowargs</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
        <span class="c1"># configs = table.get_row_configs(tbl_rowids)</span>
        <span class="c1"># assert ut.allsame(list(map(id, configs))), &#39;more than one config not yet supported&#39;</span>
        <span class="c1"># TODO; groupby config</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_rowids</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_row_cfgid</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">)</span>
            <span class="n">unique_cfgids</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">config_rowids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is incredibly hacky.</span>
            <span class="k">pass</span>

        <span class="n">colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">computable_colnames</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">xs</span><span class="p">,</span> <span class="n">cfgid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groupxs</span><span class="p">,</span> <span class="n">unique_cfgids</span><span class="p">):</span>
            <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">parent_rowids</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">parent_rowargs</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
            <span class="n">rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">tbl_rowids</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_from_rowid</span><span class="p">([</span><span class="n">cfgid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dirty_params_iter</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_compute_dirty_rows</span><span class="p">(</span>
                <span class="n">parent_ids</span><span class="p">,</span> <span class="n">parent_args</span><span class="p">,</span> <span class="n">config_rowid</span><span class="o">=</span><span class="n">cfgid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
            <span class="p">)</span>
            <span class="c1"># Evaulate to external and internal storage</span>
            <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params_iter</span><span class="p">,</span> <span class="n">rowids</span><span class="p">)</span>

    <span class="c1"># _onthefly_dataget</span>
    <span class="c1"># togroup_args = [parent_rowids]</span>
    <span class="c1"># grouped_parent_ids = ut.apply_grouping(parent_rowids, groupxs)</span>
    <span class="c1"># unique_args_list = [unique_configs]</span>

    <span class="c1"># raw_prop_lists = []</span>
    <span class="c1"># # func = ut.partial(table.preproc_func, table.depc)</span>
    <span class="c1"># def groupmap_func(group_args, unique_args):</span>
    <span class="c1">#    config_ = unique_args[0]</span>
    <span class="c1">#    argsT = group_args</span>
    <span class="c1">#    propgen = table.preproc_func(table.depc, *argsT, config=config_)</span>
    <span class="c1">#    return list(propgen)</span>

    <span class="c1"># def grouped_map(groupmap_func, groupxs, togroup_args, unique_args_list):</span>
    <span class="c1">#    # TODO; genralize to utool</span>
    <span class="c1">#    grouped_args_list = [ut.apply_grouping(togroup, groupxs) for</span>
    <span class="c1">#                         togroup in togroup_args]</span>
    <span class="c1">#    group_ret_list = []</span>
    <span class="c1">#    for group_args, unique_args in zip(grouped_args_list,</span>
    <span class="c1">#                                         unique_args_list):</span>
    <span class="c1">#        group_ret = groupmap_func(group_args, unique_args)</span>
    <span class="c1">#        group_ret_list.append(group_ret)</span>
    <span class="c1">#    ret_list = ut.ungroup(group_ret_list, groupxs)</span>
    <span class="c1">#    return ret_list</span>
    <span class="c1">#</span>
    <span class="c1"># raw_prop_list = grouped_map(groupmap_func, groupxs, togroup_args,</span>
    <span class="c1">#                            unique_args_list)</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="DependencyCacheTable.get_internal_columns"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.get_internal_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_internal_columns</span><span class="p">(</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">tbl_rowids</span><span class="p">,</span>
        <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">keepwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">showprog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access data in this table using the table PRIMARY KEY rowids (not</span>
<span class="sd">        depc PRIMARY ids)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prop_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
            <span class="n">colnames</span><span class="p">,</span>
            <span class="n">tbl_rowids</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">rowid_colname</span><span class="p">,</span>
            <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
            <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
            <span class="n">keepwrap</span><span class="o">=</span><span class="n">keepwrap</span><span class="p">,</span>
            <span class="n">showprog</span><span class="o">=</span><span class="n">showprog</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prop_list</span></div>

<div class="viewcode-block" id="DependencyCacheTable.export_rows"><a class="viewcode-back" href="../../../wbia.dtool.html#wbia.dtool.depcache_table.DependencyCacheTable.export_rows">[docs]</a>    <span class="k">def</span> <span class="nf">export_rows</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The goal of this is to export taggable data that can be used</span>
<span class="sd">        independantly of its dependant features.</span>

<span class="sd">        TODO List:</span>
<span class="sd">            * Gather information about columns</span>
<span class="sd">                * Native and (localized) external data</span>
<span class="sd">                    - &lt;table&gt;_rowid - non-transferable</span>
<span class="sd">                    - Parent UUIDS - non-transferable</span>
<span class="sd">                    - config rowid - non-transferable</span>
<span class="sd">                    - model_uuid -</span>
<span class="sd">                    - augment_bit - transferable - trivial</span>
<span class="sd">                    - words_extern_uri - copy to destination</span>
<span class="sd">                    - feat_setsize - transferable - trivial</span>
<span class="sd">                    - model_tag</span>

<span class="sd">                * Should also gather info from manifest:</span>
<span class="sd">                    * feat_setuuid_primary_ids - non-transferable</span>
<span class="sd">                    * feat_setuuid_model_input - non-transferable</span>

<span class="sd">                * Should gather exhaustive config history</span>

<span class="sd">            * Save to disk</span>

<span class="sd">            * Add function to reload data in exported format</span>

<span class="sd">            * Getters should be able to specify a tag inplace of the root input</span>
<span class="sd">            for the tagged. Additionally native root-ids should also be</span>
<span class="sd">            allowed.</span>


<span class="sd">        rowid = 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;unfinished&#39;</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">))</span>
        <span class="n">colvals</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="p">[</span><span class="n">rowid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># NOQA</span>

        <span class="n">uuid</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_uuid</span><span class="p">([</span><span class="n">rowid</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_model_inputs</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>  <span class="c1"># NOQA</span>

        <span class="n">config_history</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get_config_history</span><span class="p">([</span><span class="n">rowid</span><span class="p">])</span>  <span class="c1"># NOQA</span>

        <span class="n">table</span><span class="o">.</span><span class="n">parent_col_attrs</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_infer_parentcol</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">data_col_attrs</span>
        <span class="n">table</span><span class="o">.</span><span class="n">internal_col_attrs</span>

        <span class="n">table</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{tablename}</span><span class="s1"> WHERE rowid=?&#39;</span><span class="p">)</span>
        <span class="k">pass</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>