
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.control.DB_SCHEMA &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.control.DB_SCHEMA</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module Licence and docstring</span>

<span class="sd">TODO: ideally the wbia.constants module would not be used here</span>
<span class="sd">and each function would use its own constant variables that are suffixed</span>
<span class="sd">with the last version number that they existed in</span>

<span class="sd">TODO:</span>
<span class="sd">    Add a table for original_image_path</span>
<span class="sd">    Add column for image exif orientation</span>


<span class="sd">CommandLine:</span>
<span class="sd">    python -m wbia.control.DB_SCHEMA --test-autogen_db_schema</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">_sql_helpers</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">DB_SCHEMA_CURRENT</span>

    <span class="n">UPDATE_CURRENT</span> <span class="o">=</span> <span class="n">DB_SCHEMA_CURRENT</span><span class="o">.</span><span class="n">update_current</span>
    <span class="n">VERSION_CURRENT</span> <span class="o">=</span> <span class="n">DB_SCHEMA_CURRENT</span><span class="o">.</span><span class="n">VERSION_CURRENT</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">UPDATE_CURRENT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">VERSION_CURRENT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[dbcache] NO DB_SCHEMA_CURRENT AUTO-GENERATED!&#39;</span><span class="p">)</span>

<span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">profile</span>


<span class="n">ANNOTMATCH_TABLE</span> <span class="o">=</span> <span class="s1">&#39;annotmatch&#39;</span>
<span class="n">NAME_TABLE_v121</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE_v121</span>
<span class="n">NAME_TABLE_v130</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE_v130</span>
<span class="n">ANNOT_VISUAL_UUID</span> <span class="o">=</span> <span class="s1">&#39;annot_visual_uuid&#39;</span>
<span class="n">ANNOT_SEMANTIC_UUID</span> <span class="o">=</span> <span class="s1">&#39;annot_semantic_uuid&#39;</span>
<span class="n">ANNOT_UUID</span> <span class="o">=</span> <span class="s1">&#39;annot_uuid&#39;</span>
<span class="n">ANNOT_STAGED_UUID</span> <span class="o">=</span> <span class="s1">&#39;annot_staged_uuid&#39;</span>
<span class="n">ANNOT_YAW</span> <span class="o">=</span> <span class="s1">&#39;annot_yaw&#39;</span>
<span class="n">ANNOT_VIEWPOINT</span> <span class="o">=</span> <span class="s1">&#39;annot_viewpoint&#39;</span>
<span class="n">PART_ROWID</span> <span class="o">=</span> <span class="s1">&#39;part_rowid&#39;</span>
<span class="n">PART_UUID</span> <span class="o">=</span> <span class="s1">&#39;part_uuid&#39;</span>
<span class="n">PART_STAGED_UUID</span> <span class="o">=</span> <span class="s1">&#39;part_staged_uuid&#39;</span>
<span class="n">NAME_ROWID</span> <span class="o">=</span> <span class="s1">&#39;name_rowid&#39;</span>
<span class="n">SPECIES_ROWID</span> <span class="o">=</span> <span class="s1">&#39;species_rowid&#39;</span>
<span class="n">IMAGE_ROWID</span> <span class="o">=</span> <span class="s1">&#39;image_rowid&#39;</span>
<span class="n">ANNOT_ROWID</span> <span class="o">=</span> <span class="s1">&#39;annot_rowid&#39;</span>
<span class="n">ANNOT_PARENT_ROWID</span> <span class="o">=</span> <span class="s1">&#39;annot_parent_rowid&#39;</span>
<span class="n">ANNOTGROUP_ROWID</span> <span class="o">=</span> <span class="s1">&#39;annotgroup_rowid&#39;</span>
<span class="n">NAME_TEXT</span> <span class="o">=</span> <span class="s1">&#39;name_text&#39;</span>
<span class="n">SPECIES_TEXT</span> <span class="o">=</span> <span class="s1">&#39;species_text&#39;</span>
<span class="n">ANNOT_ROWID1</span> <span class="o">=</span> <span class="s1">&#39;annot_rowid1&#39;</span>
<span class="n">ANNOT_ROWID2</span> <span class="o">=</span> <span class="s1">&#39;annot_rowid2&#39;</span>
<span class="n">PARTY_ROWID</span> <span class="o">=</span> <span class="s1">&#39;party_rowid&#39;</span>
<span class="n">PARTY_TAG</span> <span class="o">=</span> <span class="s1">&#39;party_tag&#39;</span>
<span class="n">CONFIG_ROWID</span> <span class="o">=</span> <span class="s1">&#39;config_rowid&#39;</span>
<span class="n">IMAGE_UUID</span> <span class="o">=</span> <span class="s1">&#39;image_uuid&#39;</span>
<span class="n">CONFIG_SUFFIX</span> <span class="o">=</span> <span class="s1">&#39;config_suffix&#39;</span>

<span class="c1"># =======================</span>
<span class="c1"># Schema Version 1.0.0</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="update_1_0_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_0_0">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_0_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">IMAGE_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">IMAGE_UUID</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_uri&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_ext&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="s1">&#39;image_original_name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span>
            <span class="p">),</span>  <span class="c1"># We could parse this out of original_path</span>
            <span class="p">(</span><span class="s1">&#39;image_width&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_height&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">),</span>  <span class="c1"># this should probably be UCT</span>
            <span class="p">(</span>
                <span class="s1">&#39;image_gps_lat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;REAL DEFAULT -1.0&#39;</span><span class="p">,</span>
            <span class="p">),</span>  <span class="c1"># there doesn&#39;t seem to exist a GPSPoint in SQLite (TODO: make one in the __SQLITE3__ custom types</span>
            <span class="p">(</span><span class="s1">&#39;image_gps_lon&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT -1.0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_toggle_enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_toggle_reviewed&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">IMAGE_UUID</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        First class table used to store image locations and meta-data&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;encounter_text&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        List of all encounters&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">LBLTYPE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lbltype_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lbltype_default&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;lbltype_text&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        List of keys used to define the categories of annotation lables, text</span>
<span class="s2">        is for human-readability. The lbltype_default specifies the</span>
<span class="s2">        lblannot_value of annotations with a relationship of some</span>
<span class="s2">        lbltype_rowid&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="n">CONFIG_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">CONFIG_SUFFIX</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">CONFIG_SUFFIX</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store the ids of algorithm configurations that generate</span>
<span class="s2">        annotation lblannots.  Each user will have a config id for manual</span>
<span class="s2">        contributions &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">##########################</span>
    <span class="c1"># FIRST ORDER            #</span>
    <span class="c1">##########################</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOT_UUID</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_xtl&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_ytl&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_width&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_height&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_theta&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 0.0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_num_verts&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_verts&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_detect_confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT -1.0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_exemplar_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">ANNOT_UUID</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Mainly used to store the geometry of the annotation within its parent</span>
<span class="s2">        image The one-to-many relationship between images and annotations is</span>
<span class="s2">        encoded here Attributes are stored in the Annotation Label Relationship</span>
<span class="s2">        Table&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">LBLIMAGE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;lblimage_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblimage_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>  <span class="c1"># this is &quot;category&quot; in the proposal</span>
            <span class="p">(</span><span class="s1">&#39;lblimage_value&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblimage_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblimage_value&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store the labels (attributes) of images&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;lblannot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblannot_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>  <span class="c1"># this is &quot;category&quot; in the proposal</span>
            <span class="p">(</span><span class="s1">&#39;lblannot_value&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblannot_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblannot_value&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store the labels / attributes of annotations.</span>
<span class="s2">        E.G name, species &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">##########################</span>
    <span class="c1"># SECOND ORDER           #</span>
    <span class="c1">##########################</span>
    <span class="c1"># TODO: constraint needs modification</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;chip_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;chip_uri&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;chip_width&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;chip_height&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;config_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store *processed* annots as chips&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;feature_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;chip_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;feature_num_feats&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;feature_keypoints&#39;</span><span class="p">,</span> <span class="s1">&#39;NUMPY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;feature_sifts&#39;</span><span class="p">,</span> <span class="s1">&#39;NUMPY&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;chip_rowid, config_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store individual chip features (ellipses)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="s1">&#39;encounter_image_relationship&#39;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;egr_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">IMAGE_ROWID</span><span class="p">,</span> <span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Relationship between encounters and images (many to many mapping) the</span>
<span class="s2">        many-to-many relationship between images and encounters is encoded here</span>
<span class="s2">        encounter_image_relationship stands for encounter-image-pairs.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">##########################</span>
    <span class="c1"># THIRD ORDER            #</span>
    <span class="c1">##########################</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">GL_RELATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;glr_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblimage_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;glr_confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 0.0&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblimage_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;config_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store one-to-many the relationship between images</span>
<span class="s2">        and labels&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;alr_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;lblannot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;alr_confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 0.0&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblannot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;config_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store one-to-many the relationship between annotations (annots)</span>
<span class="s2">        and labels&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_0_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_0_0">[docs]</a><span class="k">def</span> <span class="nf">post_1_0_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># We are dropping the versions table and rather using the metadata table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying post_1_0_0&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VERSIONS_TABLE</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_1_2_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_2_0">[docs]</a><span class="k">def</span> <span class="nf">post_1_2_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying post_1_2_0&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schema_1_2_0_postprocess_fixuuids</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        schema_1_2_0_postprocess_fixuuids</span>

<span class="sd">        Args:</span>
<span class="sd">            ibs (IBEISController):</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; #import sys</span>
<span class="sd">            #&gt;&gt;&gt; sys.argv.append(&#39;--force-fresh&#39;)</span>
<span class="sd">            #&gt;&gt;&gt; ibs = wbia.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">            #&gt;&gt;&gt; ibs = wbia.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ibs = wbia.opendb(&#39;GZ_ALL&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # should be auto applied</span>
<span class="sd">            &gt;&gt;&gt; ibs.print_annotation_table(verbosity=1)</span>
<span class="sd">            &gt;&gt;&gt; result = schema_1_2_0_postprocess_fixuuids(ibs)</span>
<span class="sd">            &gt;&gt;&gt; ibs.print_annotation_table(verbosity=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># ibs.get_annot_name_rowids(aid_list)</span>
        <span class="c1">#</span>
        <span class="c1"># ANNOT_ROWID             = &#39;annot_rowid&#39;</span>
        <span class="n">ANNOTATION_TABLE</span> <span class="o">=</span> <span class="s1">&#39;annotations&#39;</span>
        <span class="n">NAME_ROWID</span> <span class="o">=</span> <span class="s1">&#39;name_rowid&#39;</span>
        <span class="n">SPECIES_ROWID</span> <span class="o">=</span> <span class="s1">&#39;species_rowid&#39;</span>
        <span class="n">AL_RELATION_TABLE</span> <span class="o">=</span> <span class="s1">&#39;annotation_lblannot_relationship&#39;</span>

        <span class="k">def</span> <span class="nf">set_annot_species_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">):</span>
            <span class="n">id_iter</span> <span class="o">=</span> <span class="n">aid_list</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">SPECIES_ROWID</span><span class="p">,)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_annot_name_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">name_rowid_list</span><span class="p">):</span>
            <span class="n">id_iter</span> <span class="o">=</span> <span class="n">aid_list</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="n">NAME_ROWID</span><span class="p">,)</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">name_rowid_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_alr_lblannot_rowids</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">):</span>
            <span class="n">lblannot_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">AL_RELATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lblannot_rowid&#39;</span><span class="p">,),</span> <span class="n">alrid_list</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">lblannot_rowids_list</span>

        <span class="k">def</span> <span class="nf">get_annot_alrids_oftype</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">lbltype_rowid</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get all the relationship ids belonging to the input annotations where the</span>
<span class="sd">            relationship ids are filtered to be only of a specific lbltype/category/type</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">alrids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">AL_RELATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;alr_rowid&#39;</span><span class="p">,),</span>
                <span class="n">aid_list</span><span class="p">,</span>
                <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span>
                <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Get lblannot_rowid of each relationship</span>
            <span class="n">lblannot_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">get_alr_lblannot_rowids</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">)</span>
            <span class="c1"># Get the type of each lblannot</span>
            <span class="n">lbltype_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">get_lblannot_lbltypes_rowids</span><span class="p">,</span> <span class="n">lblannot_rowids_list</span>
            <span class="p">)</span>
            <span class="c1"># only want the nids of individuals, not species, for example</span>
            <span class="n">valids_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">typeid</span> <span class="o">==</span> <span class="n">lbltype_rowid</span> <span class="k">for</span> <span class="n">typeid</span> <span class="ow">in</span> <span class="n">rowids</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">rowids</span> <span class="ow">in</span> <span class="n">lbltype_rowids_list</span>
            <span class="p">]</span>
            <span class="n">alrids_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">alrids</span><span class="p">,</span> <span class="n">valids</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">alrids</span><span class="p">,</span> <span class="n">valids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alrids_list</span><span class="p">,</span> <span class="n">valids_list</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">alrids_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">alrid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">alrid_list</span>
                <span class="k">for</span> <span class="n">alrid_list</span> <span class="ow">in</span> <span class="n">alrids_list</span>
            <span class="p">]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">alrid_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">alrid_list</span> <span class="ow">in</span> <span class="n">alrids_list</span><span class="p">]),</span> <span class="p">(</span>
                <span class="s1">&#39;More than one type per lbltype.  ALRIDS: &#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alrids_list</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;, ROW: &#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lbltype_rowid</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;, KEYS:&#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">lbltype_ids</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">alrids_list</span>

        <span class="k">def</span> <span class="nf">get_annot_speciesid_from_lblannot_relation</span><span class="p">(</span>
            <span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; function for getting speciesid the old way &quot;&quot;&quot;</span>
            <span class="n">species_lbltype_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;SPECIES_KEY&#39;</span><span class="p">,),</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;lbltype_text&#39;</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alrids_list</span> <span class="o">=</span> <span class="n">get_annot_alrids_oftype</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_lbltype_rowid</span><span class="p">)</span>
            <span class="n">lblannot_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">get_alr_lblannot_rowids</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">)</span>
            <span class="n">speciesid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lblannot_rowids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lblannot_rowids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span>
                <span class="k">for</span> <span class="n">lblannot_rowids</span> <span class="ow">in</span> <span class="n">lblannot_rowids_list</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">speciesid_list</span>

        <span class="k">def</span> <span class="nf">get_annot_name_rowids_from_lblannot_relation</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; function for getting nids the old way &quot;&quot;&quot;</span>
            <span class="n">individual_lbltype_rowid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;keys&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;lbltype_rowid&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;INDIVIDUAL_KEY&#39;</span><span class="p">,),</span>
                <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;lbltype_text&#39;</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alrids_list</span> <span class="o">=</span> <span class="n">get_annot_alrids_oftype</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">individual_lbltype_rowid</span><span class="p">)</span>
            <span class="n">lblannot_rowids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">get_alr_lblannot_rowids</span><span class="p">,</span> <span class="n">alrids_list</span><span class="p">)</span>
            <span class="c1"># Get a single nid from the list of lblannot_rowids of type INDIVIDUAL</span>
            <span class="c1"># TODO: get index of highest confidencename</span>
            <span class="n">nid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">lblannot_rowids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lblannot_rowids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_LBLANNOT_ROWID</span>
                <span class="k">for</span> <span class="n">lblannot_rowids</span> <span class="ow">in</span> <span class="n">lblannot_rowids_list</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">nid_list</span>

        <span class="n">nid_list1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">speciesid_list1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

        <span class="c1"># Get old values from lblannot table</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">get_annot_name_rowids_from_lblannot_relation</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">speciesid_list</span> <span class="o">=</span> <span class="n">get_annot_speciesid_from_lblannot_relation</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_list</span><span class="p">),</span> <span class="s1">&#39;cannot update to 1_2_0 name length error&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesid_list1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">speciesid_list</span>
        <span class="p">),</span> <span class="s1">&#39;cannot update to 1_2_0 species length error&#39;</span>

        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">(</span><span class="n">nid_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">(</span><span class="n">speciesid_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... returning No information in lblannot table to transfer&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Make sure information has not gotten out of sync</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">nid1</span> <span class="o">==</span> <span class="n">nid</span> <span class="ow">or</span> <span class="n">nid1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">nid1</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nid_list1</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">sid1</span> <span class="o">==</span> <span class="n">sid</span> <span class="ow">or</span> <span class="n">sid1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">sid1</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">speciesid_list1</span><span class="p">,</span> <span class="n">speciesid_list</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Cannot update database to 1_2_0 information out of sync&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Move values into the annotation table as a native column</span>
        <span class="n">set_annot_name_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">nid_list</span><span class="p">)</span>
        <span class="n">set_annot_species_rowids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">speciesid_list</span><span class="p">)</span>
        <span class="c1"># Update visual uuids</span>
        <span class="c1"># Moved this to post_process 1.21</span>
        <span class="c1"># ibs.update_annot_visual_uuids(aid_list)</span>
        <span class="c1"># ibs.update_annot_semantic_uuids(aid_list)</span>

    <span class="c1"># ibs.print_annotation_table(verbosity=1)</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_init_rowid_constants</span><span class="p">()</span>
        <span class="n">schema_1_2_0_postprocess_fixuuids</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;warning: ibs is None, so cannot apply name/species column fixes to existing database&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_2_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_2_1">[docs]</a><span class="k">def</span> <span class="nf">post_1_2_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;applying post_1_2_1&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">_init_rowid_constants</span><span class="p">()</span>
            <span class="c1"># db = ibs.db</span>
        <span class="n">UNKNOWN_ROWID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s1">&#39;____&#39;</span>
        <span class="n">UNKNOWN_NAME_ROWID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ANNOTATION_TABLE</span> <span class="o">=</span> <span class="s1">&#39;annotations&#39;</span>
        <span class="n">SPECIES_TABLE</span> <span class="o">=</span> <span class="s1">&#39;species&#39;</span>
        <span class="n">LBLANNOT_TABLE</span> <span class="o">=</span> <span class="s1">&#39;lblannot&#39;</span>
        <span class="n">SPECIES_ROWID</span> <span class="o">=</span> <span class="s1">&#39;species_rowid&#39;</span>
        <span class="n">NAME_ROWID</span> <span class="o">=</span> <span class="s1">&#39;name_rowid&#39;</span>
        <span class="n">NAME_TEXT</span> <span class="o">=</span> <span class="s1">&#39;name_text&#39;</span>
        <span class="n">ANNOT_SEMANTIC_UUID</span> <span class="o">=</span> <span class="s1">&#39;annot_semantic_uuid&#39;</span>
        <span class="n">lblannot_colnames</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;lblannot_uuid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lblannot_value&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lblannot_note&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">name_colnames</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;name_uuid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name_text&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name_note&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">species_colspeciess</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;species_uuid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;species_text&#39;</span><span class="p">,</span>
            <span class="s1">&#39;species_note&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Get old name and species rowids from annotaiton tables</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">)</span>
        <span class="n">name_rowids1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">NAME_ROWID</span><span class="p">,),</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="n">species_rowids1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">SPECIES_ROWID</span><span class="p">,),</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="c1"># Look at the unique non-unknown ones</span>
        <span class="n">unique_name_rowids1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">name_rowids1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">UNKNOWN_ROWID</span><span class="p">])))</span>
        <span class="n">unique_species_rowids1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">species_rowids1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">UNKNOWN_ROWID</span><span class="p">])))</span>
        <span class="c1"># Get params out of label annotation tables</span>
        <span class="n">name_params_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LBLANNOT_TABLE</span><span class="p">,</span> <span class="n">lblannot_colnames</span><span class="p">,</span> <span class="n">unique_name_rowids1</span><span class="p">)</span>
        <span class="n">species_params_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">LBLANNOT_TABLE</span><span class="p">,</span> <span class="n">lblannot_colnames</span><span class="p">,</span> <span class="n">unique_species_rowids1</span>
        <span class="p">)</span>
        <span class="c1"># Move params into name and species tables</span>
        <span class="n">unique_name_rowids2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">NAME_TABLE_v121</span><span class="p">,</span> <span class="n">name_colnames</span><span class="p">,</span> <span class="n">name_params_list</span><span class="p">)</span>
        <span class="n">unique_species_rowids2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span>
            <span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="n">species_colspeciess</span><span class="p">,</span> <span class="n">species_params_list</span>
        <span class="p">)</span>
        <span class="c1"># Build mapping from old table to new table</span>
        <span class="n">name_rowid_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_name_rowids1</span><span class="p">,</span> <span class="n">unique_name_rowids2</span><span class="p">))</span>
        <span class="n">speices_rowid_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_species_rowids1</span><span class="p">,</span> <span class="n">unique_species_rowids2</span><span class="p">))</span>
        <span class="n">name_rowid_mapping</span><span class="p">[</span><span class="n">UNKNOWN_ROWID</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNKNOWN_ROWID</span>
        <span class="n">speices_rowid_mapping</span><span class="p">[</span><span class="n">UNKNOWN_ROWID</span><span class="p">]</span> <span class="o">=</span> <span class="n">UNKNOWN_ROWID</span>
        <span class="c1"># Apply mapping</span>
        <span class="n">name_rowids2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_list</span><span class="p">(</span><span class="n">name_rowid_mapping</span><span class="p">,</span> <span class="n">name_rowids1</span><span class="p">)</span>
        <span class="n">species_rowid2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_list</span><span class="p">(</span><span class="n">speices_rowid_mapping</span><span class="p">,</span> <span class="n">species_rowids1</span><span class="p">)</span>
        <span class="c1"># Put new rowids back into annotation table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">NAME_ROWID</span><span class="p">,),</span> <span class="n">name_rowids2</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">SPECIES_ROWID</span><span class="p">,),</span> <span class="n">species_rowid2</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="c1"># HACK TODO use actual SQL to fix and move to 1.2.0</span>

        <span class="k">def</span> <span class="nf">get_annot_names_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
            <span class="n">name_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">name_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME_TABLE_v121</span><span class="p">,</span> <span class="p">(</span><span class="n">NAME_TEXT</span><span class="p">,),</span> <span class="n">name_rowid_list</span><span class="p">)</span>
            <span class="n">name_text_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">UNKNOWN</span> <span class="k">if</span> <span class="n">rowid</span> <span class="o">==</span> <span class="n">UNKNOWN_NAME_ROWID</span> <span class="ow">or</span> <span class="n">name_text</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name_text</span>
                <span class="k">for</span> <span class="n">name_text</span><span class="p">,</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">name_text_list</span><span class="p">,</span> <span class="n">name_rowid_list</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">name_text_list</span>

        <span class="k">def</span> <span class="nf">get_annot_semantic_uuid_info_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">_visual_infotup</span><span class="p">):</span>
            <span class="n">visual_infotup</span> <span class="o">=</span> <span class="n">_visual_infotup</span>
            <span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">verts_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">visual_infotup</span>
            <span class="c1"># It is visual info augmented with name and species</span>
            <span class="k">def</span> <span class="nf">get_annot_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
                <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_VIEWPOINT</span><span class="p">,),</span> <span class="n">aid_list</span>
                <span class="p">)</span>
                <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">viewpoint</span> <span class="k">if</span> <span class="n">viewpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">viewpoint</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">viewpoint</span> <span class="ow">in</span> <span class="n">viewpoint_list</span>
                <span class="p">]</span>
                <span class="k">return</span> <span class="n">viewpoint_list</span>

            <span class="n">view_list</span> <span class="o">=</span> <span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
            <span class="n">name_list</span> <span class="o">=</span> <span class="n">get_annot_names_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">semantic_infotup</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">image_uuid_list</span><span class="p">,</span>
                <span class="n">verts_list</span><span class="p">,</span>
                <span class="n">theta_list</span><span class="p">,</span>
                <span class="n">view_list</span><span class="p">,</span>
                <span class="n">name_list</span><span class="p">,</span>
                <span class="n">species_list</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">semantic_infotup</span>

        <span class="k">def</span> <span class="nf">get_annot_visual_uuid_info_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
            <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">verts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">visual_infotup</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">verts_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">visual_infotup</span>

        <span class="k">def</span> <span class="nf">update_annot_semantic_uuids_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">_visual_infotup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">semantic_infotup</span> <span class="o">=</span> <span class="n">get_annot_semantic_uuid_info_v121</span><span class="p">(</span>
                <span class="n">aid_list</span><span class="p">,</span> <span class="n">_visual_infotup</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">semantic_infotup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;len=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">semantic_infotup</span><span class="p">),)</span>
            <span class="n">annot_semantic_uuid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">augment_uuid</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">semantic_infotup</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ANNOT_SEMANTIC_UUID</span><span class="p">,),</span>
                <span class="n">annot_semantic_uuid_list</span><span class="p">,</span>
                <span class="n">aid_list</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">update_annot_visual_uuids_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">):</span>
            <span class="n">visual_infotup</span> <span class="o">=</span> <span class="n">get_annot_visual_uuid_info_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">visual_infotup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;len=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visual_infotup</span><span class="p">),)</span>
            <span class="n">annot_visual_uuid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">augment_uuid</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">visual_infotup</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),</span> <span class="n">annot_visual_uuid_list</span><span class="p">,</span> <span class="n">aid_list</span>
            <span class="p">)</span>
            <span class="c1"># If visual uuids are changes semantic ones are also changed</span>
            <span class="n">update_annot_semantic_uuids_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">visual_infotup</span><span class="p">)</span>

        <span class="n">update_annot_visual_uuids_v121</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_1_3_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_3_4">[docs]</a><span class="k">def</span> <span class="nf">post_1_3_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_init_rowid_constants</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_init_config</span><span class="p">()</span></div>
        <span class="c1"># Move up because this has changed</span>
        <span class="c1"># ibs.update_annot_visual_uuids(ibs.get_valid_aids())</span>


<div class="viewcode-block" id="pre_1_3_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.pre_1_3_1">[docs]</a><span class="k">def</span> <span class="nf">pre_1_3_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    need to ensure that visual uuid columns are unique before we add that</span>
<span class="sd">    constaint to sql. This will remove any annotations that are not unique</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># from wbia.other import ibsfuncs</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
        <span class="kn">import</span> <span class="nn">six</span>

        <span class="n">ibs</span><span class="o">.</span><span class="n">_init_rowid_constants</span><span class="p">()</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_init_config</span><span class="p">()</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pre_1_3_1_update_visual_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">pre_1_3_1_get_annot_visual_uuid_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
                <span class="n">image_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">verts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_verts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">theta_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">visual_infotup</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">verts_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">visual_infotup</span>

            <span class="k">def</span> <span class="nf">pre_1_3_1_get_annot_semantic_uuid_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">_visual_infotup</span><span class="p">):</span>
                <span class="n">image_uuid_list</span><span class="p">,</span> <span class="n">verts_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="o">=</span> <span class="n">visual_infotup</span>

                <span class="k">def</span> <span class="nf">get_annot_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
                    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_VIEWPOINT</span><span class="p">,),</span> <span class="n">aid_list</span>
                    <span class="p">)</span>
                    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">viewpoint</span> <span class="k">if</span> <span class="n">viewpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">viewpoint</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">viewpoint</span> <span class="ow">in</span> <span class="n">viewpoint_list</span>
                    <span class="p">]</span>
                    <span class="k">return</span> <span class="n">viewpoint_list</span>

                <span class="c1"># It is visual info augmented with name and species</span>
                <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
                <span class="n">name_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">semantic_infotup</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">image_uuid_list</span><span class="p">,</span>
                    <span class="n">verts_list</span><span class="p">,</span>
                    <span class="n">theta_list</span><span class="p">,</span>
                    <span class="n">viewpoint_list</span><span class="p">,</span>
                    <span class="n">name_list</span><span class="p">,</span>
                    <span class="n">species_list</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">semantic_infotup</span>

            <span class="n">visual_infotup</span> <span class="o">=</span> <span class="n">pre_1_3_1_get_annot_visual_uuid_info</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">visual_infotup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;len=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visual_infotup</span><span class="p">),)</span>
            <span class="n">annot_visual_uuid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">augment_uuid</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">visual_infotup</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),</span>
                <span class="n">annot_visual_uuid_list</span><span class="p">,</span>
                <span class="n">aid_list</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># If visual uuids are changes semantic ones are also changed</span>
            <span class="c1"># update semeantic pre 1_3_1</span>
            <span class="n">_visual_infotup</span> <span class="o">=</span> <span class="n">visual_infotup</span>
            <span class="n">semantic_infotup</span> <span class="o">=</span> <span class="n">pre_1_3_1_get_annot_semantic_uuid_info</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">_visual_infotup</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">semantic_infotup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;len=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">semantic_infotup</span><span class="p">),)</span>
            <span class="n">annot_semantic_uuid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">augment_uuid</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">semantic_infotup</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ANNOT_SEMANTIC_UUID</span><span class="p">,),</span>
                <span class="n">annot_semantic_uuid_list</span><span class="p">,</span>
                <span class="n">aid_list</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">pass</span>

        <span class="n">pre_1_3_1_update_visual_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">)</span>
        <span class="c1"># ibsfuncs.fix_remove_visual_dupliate_annotations(ibs)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
        <span class="n">dupaids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dupxs</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">):</span>
                <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">dupxs</span><span class="p">)</span>
                <span class="n">dupaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aids</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">toremove_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dupaids_list</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;About to delete toremove_aids=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">toremove_aids</span><span class="p">,))</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">toremove_aids</span><span class="p">)</span>

            <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">visual_uuid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_visual_uuids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
            <span class="n">ibs_dup_annots</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">visual_uuid_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibs_dup_annots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></div>


<span class="c1"># =======================</span>
<span class="c1"># Schema Version 1.0.1</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="update_1_0_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_0_1">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_0_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add a contributor&#39;s table</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_name_first&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_name_last&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_location_city&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_location_state&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_location_country&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_location_zip&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_note&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Used to store the contributors to the project</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.0 at index 1</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.0 at index 1</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;annot_parent_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># append column to v1.0.0 because None</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;feature_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 1.0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<span class="c1"># =======================</span>
<span class="c1"># Schema Version 1.0.2</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="update_1_0_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_0_2">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_0_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Fix the contibutor table&#39;s constraint</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.1 at index 1</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;contributor_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;contributor_tag&#39;</span><span class="p">,)],</span>
    <span class="p">)</span></div>


<span class="c1"># =======================</span>
<span class="c1"># Schema Version 1.1.0</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="update_1_1_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_1_0">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_1_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Moving chips and features to their own cache database</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHIP_TABLE</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">)</span>

    <span class="c1"># Add viewpoint (radians) to annotations</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.2 at index 11</span>
            <span class="c1"># (11, ANNOT_VIEWPOINT, &#39;REAL DEFAULT 0.0&#39;, None),</span>
            <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">ANNOT_VIEWPOINT</span><span class="p">,</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Add contributor to configs</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.2 at index 1</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;contributor_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="c1"># FIXME: This change may have broken things</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;contributor_uuid&#39;</span><span class="p">,</span> <span class="n">CONFIG_SUFFIX</span><span class="p">,)],</span>
    <span class="p">)</span>

    <span class="c1"># Add config to encounters</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># add column to v1.0.2 at index 2</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;config_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;encounter_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;encounter_text&#39;</span><span class="p">,)],</span>
    <span class="p">)</span>

    <span class="c1"># Error in the drop table script, re-drop again from post_1_0_0 to kill table&#39;s metadata</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">VERSIONS_TABLE</span><span class="p">)</span></div>


<span class="c1"># =======================</span>
<span class="c1"># Schema Version 1.1.1</span>
<span class="c1"># =======================</span>


<div class="viewcode-block" id="update_1_1_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_1_1">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_1_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Change name of column</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># rename column and change it&#39;s type</span>
            <span class="p">(</span><span class="s1">&#39;contributor_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="n">CONFIG_SUFFIX</span><span class="p">,)],</span>
    <span class="p">)</span>

    <span class="c1"># Change type of column</span>
    <span class="c1"># db.modify_table(const.CONFIG_TABLE, (</span>
    <span class="c1">#    # rename column and change it&#39;s type</span>
    <span class="c1">#    (&#39;contributor_rowid&#39;, &#39;&#39;, &#39;INTEGER&#39;, None),</span>
    <span class="c1"># ))</span>

    <span class="c1"># Change type of columns</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Update column&#39;s types</span>
            <span class="p">(</span><span class="s1">&#39;contributor_location_zip&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;contributor_note&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_2_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_2_0">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_2_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add columns to annotaiton table</span>
    <span class="n">tablename</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span>
    <span class="n">colmap_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># the visual uuid will be unique w.r.t. the appearence of the annotation</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ANNOT_VISUAL_UUID</span><span class="p">,</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="c1"># the visual uuid will be unique w.r.t. the appearence, name, and species of the annotation</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_semantic_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;species_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">aid_before</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">)</span>
    <span class="c1"># import utool as ut</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colmap_list</span><span class="p">)</span>
    <span class="c1"># Sanity check</span>
    <span class="n">aid_after</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">aid_before</span> <span class="o">==</span> <span class="n">aid_after</span></div>


<div class="viewcode-block" id="update_1_2_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_2_1">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">update_1_2_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Names and species are taken away from lblannot table and upgraded</span>
    <span class="c1"># to their own thing</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">NAME_TABLE_v121</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;name_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;name_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">NAME_TEXT</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;name_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">NAME_TEXT</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Stores the individual animal names</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;species_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;species_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">SPECIES_TEXT</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;species_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">SPECIES_TEXT</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Stores the different animal species</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;image_timedelta_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">NAME_TABLE_v121</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name_temp_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name_alias_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">tablename_new</span><span class="o">=</span><span class="n">NAME_TABLE_v130</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">NAME_TABLE_v121</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_start_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_end_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_gps_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_gps_lon&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_processed_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_shipped_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * New Image Columns</span>
<span class="sd">        - image_posix_timedelta</span>

<span class="sd">    * New Name Columns</span>
<span class="sd">        - name_temp_flag</span>
<span class="sd">        - name_alias_text</span>

<span class="sd">        - name_uuid</span>
<span class="sd">        - name_visual_uuid</span>
<span class="sd">        - name_member_annot_rowids_evalstr</span>
<span class="sd">        - name_member_num_annot_rowids</span>

<span class="sd">    * New Encounter Columns</span>
<span class="sd">        - encounter_start_posix_time</span>
<span class="sd">        - encounter_end_time_posix</span>
<span class="sd">        - encounter_gps_lat</span>
<span class="sd">        - encounter_gps_lon</span>
<span class="sd">        - encounter_processed_flag</span>
<span class="sd">        - encounter_shipped_flag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: changed shipped to commited</span>
    <span class="c1"># encounter_detected_flag</span>
    <span class="c1"># encounter_identified_flag???</span>

    <span class="k">pass</span></div>
    <span class="c1"># Need encounter processed and shipped flag</span>
    <span class="c1"># db.modify_table(const.CONFIG_TABLE, (</span>
    <span class="c1">#    # rename column and change it&#39;s type</span>
    <span class="c1"># )</span>


<div class="viewcode-block" id="update_1_3_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    update the visual_uuid to be a superkey by adding a constraint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make annot_visual_uuid not null and add it as a superkey</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="c1"># change type of annot_visual_uuid</span>
            <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># ERROR: this should have been ANNOT_SEMANTIC_UUID</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">ANNOT_UUID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,)],</span>
    <span class="p">)</span></div>
    <span class="c1"># pass</span>


<div class="viewcode-block" id="update_1_3_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_2">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for SMART DATA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_smart_xml_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;encounter_smart_waypoint_id&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_3"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_3">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># we should only be storing names here not paths</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="p">((</span><span class="s1">&#39;encounter_smart_xml_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;encounter_smart_xml_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_4">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># OLD ANNOT VIEWPOINT FUNCS. Hopefully these are not needed</span>
    <span class="c1"># def get_annot_viewpoints(ibs, aid_list):</span>
    <span class="c1">#    viewpoint_list = ibs.db.get(const.ANNOTATION_TABLE, (ANNOT_VIEWPOINT,), aid_list)</span>
    <span class="c1">#    viewpoint_list = [viewpoint if viewpoint &gt;= 0.0 else None for viewpoint in viewpoint_list]</span>
    <span class="c1">#    return viewpoint_list</span>
    <span class="c1"># def set_annot_viewpoint(ibs, aid_list, viewpoint_list, input_is_degrees=False):</span>
    <span class="c1">#    id_iter = ((aid,) for aid in aid_list)</span>
    <span class="c1">#    #viewpoint_list = [-1 if viewpoint is None else viewpoint for viewpoint in viewpoint_list]</span>
    <span class="c1">#    if input_is_degrees:</span>
    <span class="c1">#        viewpoint_list = [-1 if viewpoint is None else ut.deg_to_rad(viewpoint)</span>
    <span class="c1">#                          for viewpoint in viewpoint_list]</span>
    <span class="c1">#    #assert all([0.0 &lt;= viewpoint &lt; 2 * np.pi or viewpoint == -1.0 for viewpoint in viewpoint_list])</span>
    <span class="c1">#    val_iter = ((viewpoint, ) for viewpoint in viewpoint_list)</span>
    <span class="c1">#    ibs.db.set(const.ANNOTATION_TABLE, (ANNOT_VIEWPOINT,), val_iter, id_iter)</span>
    <span class="c1">#    ibs.update_annot_visual_uuids(aid_list)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;executing update_1_3_4&#39;</span><span class="p">)</span>
    <span class="n">TAU</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">TAU</span>

    <span class="k">def</span> <span class="nf">convert_old_viewpoint_to_yaw</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; we initially had viewpoint coordinates inverted</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import math</span>
<span class="sd">            &gt;&gt;&gt; TAU = 2 * math.pi</span>
<span class="sd">            &gt;&gt;&gt; old_viewpoint_labels = [</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;left&#39;       , 0.000 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;frontleft&#39;  , 0.125 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;front&#39;      , 0.250 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;frontright&#39; , 0.375 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;right&#39;      , 0.500 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;backright&#39;  , 0.625 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;back&#39;       , 0.750 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;backleft&#39;   , 0.875 * TAU,),</span>
<span class="sd">            &gt;&gt;&gt; ]</span>
<span class="sd">            &gt;&gt;&gt; for lbl, angle in old_viewpoint_labels:</span>
<span class="sd">            &gt;&gt;&gt;     yaw = convert_old_viewpoint_to_yaw(angle)</span>
<span class="sd">            &gt;&gt;&gt;     angle2 = convert_old_viewpoint_to_yaw(yaw)</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;old %15r %.2f -&gt; new %15r %.2f&#39; % (lbl, angle, lbl, yaw))</span>
<span class="sd">            &gt;&gt;&gt;     print(&#39;old %15r %.2f -&gt; new %15r %.2f&#39; % (lbl, yaw, lbl, angle2))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">yaw</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">angle</span> <span class="o">+</span> <span class="p">(</span><span class="n">TAU</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">%</span> <span class="n">TAU</span>
        <span class="k">return</span> <span class="n">yaw</span>

    <span class="kn">from</span> <span class="nn">wbia.dtool.sql_control</span> <span class="k">import</span> <span class="n">SQLDatabaseController</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">SQLDatabaseController</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Add original image path to image table for more data persistance and</span>
            <span class="c1"># stewardship</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;image_original_path&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># Add image location as a simple workaround for not using the gps</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;image_location_code&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Add image quality as an integer to filter the database more easilly</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># Add a path to a file that will represent if a pixel belongs to the</span>
            <span class="c1"># object of interest within the annotation.</span>
            <span class="c1"># (None, &#39;annot_mask_fpath&#39;,       &#39;STRING&#39;, None),</span>
            <span class="p">(</span><span class="n">ANNOT_VIEWPOINT</span><span class="p">,</span> <span class="n">ANNOT_YAW</span><span class="p">,</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span> <span class="n">convert_old_viewpoint_to_yaw</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_5"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_5">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_5</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; expand datasets to use new quality measures &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Adds a few different degrees of quality</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">qual_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_qualities</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">qual_list</span><span class="p">]</span>
        <span class="n">qual_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">qual_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">qual_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">qual_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s1">&#39;there were no qualities higher than 3 at this point&#39;</span>
        <span class="n">old_to_new</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">new_qual_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_to_new</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qual</span><span class="p">,</span> <span class="n">qual</span><span class="p">)</span> <span class="k">for</span> <span class="n">qual</span> <span class="ow">in</span> <span class="n">qual_list</span><span class="p">]</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_qualities</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">new_qual_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_6"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_6">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_6</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add table for explicit annotation-vs-annotation match information</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">PARTY_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="n">PARTY_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">PARTY_TAG</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">PARTY_TAG</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Serves as a group for contributors</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># instead of adding a specific many to many mapping relate images to both parties</span>
    <span class="c1"># and contributors</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;party_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),],</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span>
        <span class="n">extern_tables</span><span class="o">=</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">PARTY_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">],</span>
        <span class="c1"># TODO: add in many to 1 attribute mapping</span>
    <span class="p">)</span>

    <span class="c1"># db.add_table(const.PARTY_CONTRIB_RELATION_TABLE, (</span>
    <span class="c1">#    (&#39;party_contrib_relation_rowid&#39;,               &#39;INTEGER PRIMARY KEY&#39;),</span>
    <span class="c1">#    (&#39;party_rowid&#39;,                                &#39;INTEGER NOT NULL&#39;),</span>
    <span class="c1">#    (&#39;contributor_rowid&#39;,                          &#39;INTEGER NOT NULL&#39;),</span>
    <span class="c1"># ),</span>
    <span class="c1">#    superkeys=[(&#39;party_rowid&#39;, &#39;contributor_rowid&#39;)],</span>
    <span class="c1">#    relates=(const.PARTY_TABLE, const.CONTRIBUTOR_TABLE),</span>
    <span class="c1">#    docstr=&#39;&#39;&#39;</span>
    <span class="c1">#    Relates parties and contributors</span>
    <span class="c1">#    &#39;&#39;&#39;,</span>
    <span class="c1"># )</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOT_ROWID1</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOT_ROWID2</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 0&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annot_rowid1&#39;</span><span class="p">,</span> <span class="s1">&#39;annot_rowid2&#39;</span><span class="p">,)],</span>
        <span class="n">relates</span><span class="o">=</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">),</span>
        <span class="c1"># shortname=&#39;annotmatch&#39;,</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Sparsely stores explicit matching / not matching information. This</span>
<span class="s2">        serves as marking weather or not an annotation pair has been reviewed.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># add metadata props</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounter_image_relationship&#39;</span><span class="p">,</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;egr&#39;</span><span class="p">,</span>
        <span class="n">relates</span><span class="o">=</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="s1">&#39;encounters&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">AL_RELATION_TABLE</span><span class="p">,</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;alr&#39;</span><span class="p">,</span>
        <span class="n">relates</span><span class="o">=</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">LBLANNOT_TABLE</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">GL_RELATION_TABLE</span><span class="p">,</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;glr&#39;</span><span class="p">,</span>
        <span class="n">relates</span><span class="o">=</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">LBLIMAGE_TABLE</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;annot&#39;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_7"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_7">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_7</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Part of the dependsmap property might be inferred, but at least the keys and tables are needed.</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="n">extern_tables</span><span class="o">=</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">],</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">ANNOT_UUID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,)],</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="n">IMAGE_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">IMAGE_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">IMAGE_UUID</span><span class="p">,)),</span>
            <span class="n">NAME_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">NAME_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">NAME_TEXT</span><span class="p">,)),</span>
            <span class="n">SPECIES_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">SPECIES_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">SPECIES_TEXT</span><span class="p">,)),</span>
            <span class="n">ANNOT_PARENT_ROWID</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ANNOT_ROWID1</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),),</span>
            <span class="n">ANNOT_ROWID2</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),),</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;party_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">PARTY_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;party_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="n">PARTY_TAG</span><span class="p">,)),</span>
            <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;contributor_tag&#39;</span><span class="p">,),</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;contributor_tag&#39;</span><span class="p">,),</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;config_rowid&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,),</span>
                <span class="p">(</span><span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="n">CONFIG_SUFFIX</span><span class="p">,),</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounter_image_relationship&#39;</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;image_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">IMAGE_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">IMAGE_UUID</span><span class="p">,)),</span>
            <span class="s1">&#39;encounter_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;encounters&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;encounter_text&#39;</span><span class="p">,),),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_8"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_8">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_8</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Encounters only care about their text again as a uuid We are removing</span>
    <span class="c1"># config_rowid from encounters. Thus the dependency is not encoded</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span> <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;encounter_text&#39;</span><span class="p">,)],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_3_9"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_3_9">[docs]</a><span class="k">def</span> <span class="nf">update_1_3_9</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Remove contributors from configs</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span> <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">CONFIG_SUFFIX</span><span class="p">,)])</span>
    <span class="c1"># Add primary superkey to annotations table</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="n">primary_superkey</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;annot_visual_uuid&#39;</span><span class="p">,),</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Mainly used to store the geometry of the annotation within its parent</span>
<span class="s2">        image The one-to-many relationship between images and annotations is</span>
<span class="s2">        encoded here</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Remove contributors from configs</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounter_image_relationship&#39;</span><span class="p">,</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">IMAGE_ROWID</span><span class="p">,</span> <span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,)],</span>
        <span class="c1"># superkeys=[(CONFIG_SUFFIX,)]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;encounters&#39;</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;config_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIG_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="n">CONFIG_SUFFIX</span><span class="p">,)),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_2">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_age_months_est_min&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_age_months_est_max&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="c1"># HACK: Need a way to update the dependsmap without blowing the old one away</span>
        <span class="c1"># Also need to not overspecify information. colname to tablename should be fine.</span>
        <span class="c1"># we can have the extern colname be optional. superkey is definiately not needed</span>
        <span class="c1"># dependsmap=db.get_metadata_val(const.ANNOTATION_TABLE + &#39;_dependsmap&#39;, eval_=True) +</span>
        <span class="c1"># {}</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="n">IMAGE_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">IMAGE_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">IMAGE_UUID</span><span class="p">,)),</span>
            <span class="n">NAME_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">NAME_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">NAME_TEXT</span><span class="p">,)),</span>
            <span class="n">SPECIES_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">SPECIES_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">SPECIES_TEXT</span><span class="p">,)),</span>
            <span class="n">ANNOT_PARENT_ROWID</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span>
                <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,),</span>
            <span class="p">),</span>
            <span class="s1">&#39;contributor_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CONTRIBUTOR_TABLE</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name_sex&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT -1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),])</span></div>


<div class="viewcode-block" id="update_1_4_3"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_3">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_occluded&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_shadowed&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_washedout&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_blury&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_novelpose&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_is_commonpose&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_is_hard&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_is_scenerymatch&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_is_photobomb&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_is_nondistinct&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_4">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTGROUP_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">ANNOTGROUP_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotgroup_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotgroup_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotgroup_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annotgroup_text&#39;</span><span class="p">,)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        List of all annotation groups (annotgroups)&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">GA_RELATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;gar_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOTGROUP_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">ANNOTGROUP_ROWID</span><span class="p">,</span> <span class="n">ANNOT_ROWID</span><span class="p">)],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Relationship between annotgroups and annots (many to many mapping) the</span>
<span class="s2">        many-to-many relationship between annots and annotgroups is encoded here</span>
<span class="s2">        annotgroup_annotation_relationship stands for annotgroup-annotation-pairs.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_5"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_5">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_5</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_6"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_6">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_6</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Maybe we want the notation of each annotation having having a set of</span>
    <span class="c1"># classes with probabilities (c, p). Or an annotation label with a</span>
    <span class="c1"># confidence.</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="c1"># HACK: add a column for parsable tags, this should later be</span>
            <span class="c1"># replaced with a tag table and a tag-annot relation table</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># Remove these columns</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_occluded&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_shadowed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_washedout&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_blury&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_novelpose&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annot_is_commonpose&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_reviewed&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_reviewer&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_7"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_7">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_7</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;image_uri_original&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),))</span></div>


<div class="viewcode-block" id="post_1_4_7"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_4_7">[docs]</a><span class="k">def</span> <span class="nf">post_1_4_7</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_gids</span><span class="p">()</span>
        <span class="n">image_uri_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_uris</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris_original</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">image_uri_list</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="c1"># change type of image_uri_original</span>
            <span class="p">(</span><span class="s1">&#39;image_uri_original&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="pre_1_4_8"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.pre_1_4_8">[docs]</a><span class="k">def</span> <span class="nf">pre_1_4_8</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (wbia.IBEISController):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">tag_funcs</span>

        <span class="n">annotmatch_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="n">annotmatch_rowids</span>
        <span class="n">annotmatch_is_photobomb_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_photobomb&#39;</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">annotmatch_is_nondistinct</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_nondistinct&#39;</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">annotmatch_is_hard</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;annotmatch_is_hard&#39;</span><span class="p">,),</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span>
        <span class="p">)</span>
        <span class="n">annotmatch_is_scenerymatch</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_scenerymatch&#39;</span><span class="p">,),</span>
            <span class="n">id_iter</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ibs.get_annotmatch_note(annotmatch_rowids)</span>
        <span class="n">annotmatch_note_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_note&#39;</span><span class="p">,),</span>
            <span class="n">annotmatch_rowids</span><span class="p">,</span>
            <span class="n">id_colname</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_notes_list</span> <span class="o">=</span> <span class="n">annotmatch_note_list</span>
        <span class="n">new_notes_list</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">set_textformat_tag_flags</span><span class="p">(</span>
            <span class="s1">&#39;photobomb&#39;</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">,</span> <span class="n">annotmatch_is_photobomb_list</span>
        <span class="p">)</span>
        <span class="n">new_notes_list</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">set_textformat_tag_flags</span><span class="p">(</span>
            <span class="s1">&#39;nondistinct&#39;</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">,</span> <span class="n">annotmatch_is_nondistinct</span>
        <span class="p">)</span>
        <span class="n">new_notes_list</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">set_textformat_tag_flags</span><span class="p">(</span>
            <span class="s1">&#39;hard&#39;</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">,</span> <span class="n">annotmatch_is_hard</span>
        <span class="p">)</span>
        <span class="n">new_notes_list</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">set_textformat_tag_flags</span><span class="p">(</span>
            <span class="s1">&#39;scenerymatch&#39;</span><span class="p">,</span> <span class="n">new_notes_list</span><span class="p">,</span> <span class="n">annotmatch_is_scenerymatch</span>
        <span class="p">)</span>

        <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_note&#39;</span><span class="p">,),</span>
            <span class="n">new_notes_list</span><span class="p">,</span>
            <span class="n">annotmatch_rowids</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_8"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_8">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_8</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    change notes to tag_text_data</span>
<span class="sd">    add configuration that made the match</span>
<span class="sd">    add the score of the match</span>
<span class="sd">    add concept of: DEFINIATELY MATCHES, DOES NOT MATCH, CAN NOT DECIDE</span>

<span class="sd">    Probably want a separate table for the config_rowid matching results</span>
<span class="sd">    because the primary key needs to be (config_rowid, aid1, aid2) OR just</span>
<span class="sd">    (config_rowid, annotmatch_rowid)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="c1"># HACK: add a column for parsable tags, this should later be</span>
            <span class="c1"># replaced with a tag table and a tag-annot relation table</span>
            <span class="p">(</span><span class="s1">&#39;annot_tags&#39;</span><span class="p">,</span> <span class="s1">&#39;annot_tag_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_note&#39;</span><span class="p">,</span> <span class="s1">&#39;annotmatch_tag_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_posixtime_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_pairwise_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;config_hashid&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># Remove explicit case tags in favor of consistency</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_photobomb&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_nondistinct&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_hard&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_is_scenerymatch&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="pre_1_4_9"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.pre_1_4_9">[docs]</a><span class="k">def</span> <span class="nf">pre_1_4_9</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remapping_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;frogs&#39;</span><span class="p">:</span> <span class="s1">&#39;frog&#39;</span><span class="p">,</span>
            <span class="s1">&#39;giraffe&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seals_spotted&#39;</span><span class="p">:</span> <span class="s1">&#39;seal_spotted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seals_saimma_ringed&#39;</span><span class="p">:</span> <span class="s1">&#39;seal_saimma_ringed&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>

        <span class="n">species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_species_rowids</span><span class="p">()</span>
        <span class="n">species_text_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_texts</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">species_rowid_list</span><span class="p">,</span> <span class="n">species_text_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">remapping_dict</span><span class="p">:</span>
                <span class="c1"># Update record for reticulated giraffe</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">_set_species_texts</span><span class="p">([</span><span class="n">rowid</span><span class="p">],</span> <span class="p">[</span><span class="n">remapping_dict</span><span class="p">[</span><span class="n">text</span><span class="p">]])</span>

                <span class="c1"># Delete obsolete cPkl file on disk</span>
                <span class="n">cPlk_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.cPkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,))</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cPlk_path</span><span class="p">)</span>

                <span class="c1"># Recompute all effected annotation&#39;s semantic UUIDs</span>
                <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
                <span class="n">annot_species_rowid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_rowids</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
                <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">annot_species_rowid</span> <span class="o">==</span> <span class="n">rowid</span>
                    <span class="k">for</span> <span class="n">annot_species_rowid</span> <span class="ow">in</span> <span class="n">annot_species_rowid_list</span>
                <span class="p">]</span>
                <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">update_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_1_4_9"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_4_9">[docs]</a><span class="k">def</span> <span class="nf">update_1_4_9</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;species_code&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),))</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;species_nice&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),))</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;species_toggle_enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_4_9"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_4_9">[docs]</a><span class="k">def</span> <span class="nf">post_1_4_9</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_clean_species</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">SPECIES_TABLE</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="c1"># change type of species_nice</span>
            <span class="p">(</span><span class="s1">&#39;species_nice&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;species_code&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Rename encounters to imagesets</span>
    <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s1">&#39;encounters&#39;</span><span class="p">,</span> <span class="s1">&#39;imagesets&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s1">&#39;encounter_image_relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_image_relationship&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;imagesets&#39;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_text&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_note&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT NOT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_start_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_start_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_end_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_end_time_posix&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_gps_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_gps_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_gps_lon&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_gps_lon&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="s1">&#39;encounter_processed_flag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;imageset_processed_flag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="s1">&#39;encounter_shipped_flag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;imageset_shipped_flag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_smart_xml_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_smart_xml_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="s1">&#39;encounter_smart_waypoint_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;imageset_smart_waypoint_id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        List of all imagesets. This used to be called the encounter table.</span>
<span class="s2">        It represents a group of potentially many individuals seen in a</span>
<span class="s2">        specific place at a specific time.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;imageset_text&#39;</span><span class="p">,)],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;imageset_image_relationship&#39;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;egr_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;gsgr_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;encounter_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Relationship between imagesets and images (many to many mapping) the</span>
<span class="s2">        many-to-many relationship between images and imagesets is encoded</span>
<span class="s2">        here imageset_image_relationship stands for imageset-image-pairs.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;imageset_rowid&#39;</span><span class="p">)],</span>
        <span class="n">relates</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;imagesets&#39;</span><span class="p">),</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;gsgr&#39;</span><span class="p">,</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;imageset_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;imagesets&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;imageset_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;imageset_text&#39;</span><span class="p">,)),</span>
            <span class="s1">&#39;image_rowid&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;image_uuid&#39;</span><span class="p">,)),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Rename encounters to imagesets</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">IMAGE_UUID</span><span class="p">,)],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annot_rowid1&#39;</span><span class="p">,</span> <span class="s1">&#39;annot_rowid2&#39;</span><span class="p">,)],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_2">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add orientation to images</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;image_orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_5_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_5_2">[docs]</a><span class="k">def</span> <span class="nf">post_1_5_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>  <span class="c1"># NOQA</span>
        <span class="kn">from</span> <span class="nn">wbia.algo.preproc.preproc_image</span> <span class="k">import</span> <span class="n">parse_exif</span>
        <span class="kn">from</span> <span class="nn">wbia.scripts</span> <span class="k">import</span> <span class="n">fix_annotation_orientation_issue</span> <span class="k">as</span> <span class="n">faoi</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span>

        <span class="k">def</span> <span class="nf">_parse_orient</span><span class="p">(</span><span class="n">gpath</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[db_update (1.5.2)]     Parsing: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gpath</span><span class="p">,))</span>
            <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gpath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>  <span class="c1"># NOQA</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">orient</span> <span class="o">=</span> <span class="n">parse_exif</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>  <span class="c1"># Read exif tags</span>
            <span class="k">return</span> <span class="n">orient</span>

        <span class="c1"># Get images without orientations and add to the database</span>
        <span class="n">gid_list_all</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_gids</span><span class="p">()</span>
        <span class="n">gpath_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">)</span>
        <span class="n">valid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">exists</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list</span><span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">,</span> <span class="n">valid_list</span><span class="p">)</span>

        <span class="n">orient_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_orientation</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">orient_list</span><span class="p">)</span>
        <span class="n">gid_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">orient</span> <span class="ow">in</span> <span class="n">zipped</span> <span class="k">if</span> <span class="n">orient</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">gid_list_all</span><span class="p">),</span> <span class="n">valid_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;[db_update (1.5.2)] Parsing Exif orientations for </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> images (skipping </span><span class="si">%d</span><span class="s1">)&#39;</span>
            <span class="o">%</span> <span class="n">args</span>
        <span class="p">)</span>
        <span class="n">gpath_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">)</span>
        <span class="n">orient_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_orient</span><span class="p">(</span><span class="n">gpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpath</span> <span class="ow">in</span> <span class="n">gpath_list_</span><span class="p">]</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">_set_image_orientation</span><span class="p">(</span><span class="n">gid_list_</span><span class="p">,</span> <span class="n">orient_list_</span><span class="p">)</span>
        <span class="n">faoi</span><span class="o">.</span><span class="n">fix_annotation_orientation</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_3"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_3">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add reviewed flag to annotations</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;annot_toggle_reviewed&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_4">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Add reviewed flag to annotations</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;annot_toggle_multiple&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_5_5"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_5_5">[docs]</a><span class="k">def</span> <span class="nf">update_1_5_5</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Remove the config table</span>
    <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;configs&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;image_lblimage_relationship&#39;</span><span class="p">,</span>
        <span class="n">drop_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">],</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;image_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblimage_rowid&#39;</span><span class="p">)],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;annotation_lblannot_relationship&#39;</span><span class="p">,</span>
        <span class="n">drop_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">],</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annot_rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;lblannot_rowid&#39;</span><span class="p">)],</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="s1">&#39;imagesets&#39;</span><span class="p">,</span> <span class="n">drop_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;config_rowid&#39;</span><span class="p">],</span> <span class="n">dependsmap</span><span class="o">=</span><span class="p">{})</span></div>


<div class="viewcode-block" id="update_1_6_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;image_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),))</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># if ibs is not None:</span>
    <span class="c1">#     assert ibs.get_dbname() in [&#39;PZ_PB_RF_TRAIN&#39;, &#39;WWF_Lynx&#39;, &#39;EWT_Cheetahs&#39;], (</span>
    <span class="c1">#         &#39;this is a hacked state. to fix bug where EVIDENCE_DECISION.UNKNOWN was 2&#39;)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span>
        <span class="n">colmap_list</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_6_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_6_1">[docs]</a><span class="k">def</span> <span class="nf">post_1_6_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Find annotmatch rowids that have an old value of 2</span>
    <span class="n">ams</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where_eq</span><span class="p">(</span>
        <span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span>
        <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;annotmatch_rowid&#39;</span><span class="p">,),</span>
        <span class="n">params_iter</span><span class="o">=</span><span class="p">[(</span><span class="mi">2</span><span class="p">,)],</span>
        <span class="n">unpack_scalars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">where_colnames</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting </span><span class="si">%d</span><span class="s1"> old unknown values to NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ams</span><span class="p">)))</span>
    <span class="c1"># if ibs is not None:</span>
    <span class="c1">#     assert ibs.get_dbname() in [&#39;PZ_PB_RF_TRAIN&#39;, &#39;WWF_Lynx&#39;, &#39;EWT_Cheetahs&#39;], (</span>
    <span class="c1">#         &#39;this is a hacked state. to fix bug where EVIDENCE_DECISION.UNKNOWN was 2&#39;)</span>
    <span class="c1"># if False:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,),</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ams</span><span class="p">),</span> <span class="n">ams</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_2">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># All confidences thusfar have had no meaning. Change the column to an integer</span>
    <span class="c1"># to user the USER_CONFIDENCE_CODES and reset all values to None</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span>
        <span class="n">colmap_list</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="s1">&#39;annotmatch_confidence&#39;</span><span class="p">,</span>
                <span class="s1">&#39;annotmatch_confidence&#39;</span><span class="p">,</span>
                <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_3"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_3">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGESET_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;imageset_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">NAME_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),))</span></div>


<div class="viewcode-block" id="update_1_6_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_4">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;annot_viewpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;annot_toggle_interest&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">PART_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">PART_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">PART_UUID</span><span class="p">,</span> <span class="s1">&#39;UUID NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_xtl&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_ytl&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_width&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_height&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_theta&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT 0.0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_num_verts&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER NOT NULL&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_verts&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_viewpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_detect_confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;REAL DEFAULT -1.0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_toggle_reviewed&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_type&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_note&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;part_tag_text&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">docstr</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Mainly used to store the geometry of the annotation parts within its parent</span>
<span class="s2">        annotation. The one-to-many relationship between annotations and parts is</span>
<span class="s2">        encoded here</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">PART_UUID</span><span class="p">,),],</span>
        <span class="n">shortname</span><span class="o">=</span><span class="s1">&#39;part&#39;</span><span class="p">,</span>
        <span class="n">extern_tables</span><span class="o">=</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">],</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ANNOT_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,)),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_6_4"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_6_4">[docs]</a><span class="k">def</span> <span class="nf">post_1_6_4</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wbia.other</span> <span class="k">import</span> <span class="n">ibsfuncs</span>

        <span class="n">aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Get old yaw values</span>
        <span class="n">yaws</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_YAW</span><span class="p">,),</span> <span class="n">aids</span><span class="p">)</span>
        <span class="n">yaws</span> <span class="o">=</span> <span class="p">[</span><span class="n">yaw</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yaw</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaws</span><span class="p">]</span>
        <span class="c1"># Convert into viewpoint text</span>
        <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_yaw_viewtexts</span><span class="p">(</span><span class="n">yaws</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;annot_viewpoint&#39;</span><span class="p">,),</span> <span class="n">viewpoint_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="o">=</span><span class="n">aids</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_5"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_5">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_5</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGE_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;image_toggle_cameratrap&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_6"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_6">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_6</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_count&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_7"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_7">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_7</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_pairwise_prob&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;config_hashid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_8"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_8">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_8</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTMATCH_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Rename truth to visual decision</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;annotmatch_evidence_decision&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># Add new meta_decision</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annotmatch_meta_decision&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="c1"># remove the reviewed flag. This is basically stored via userid/count</span>
            <span class="p">(</span><span class="s1">&#39;annotmatch_reviewed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_6_9"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_6_9">[docs]</a><span class="k">def</span> <span class="nf">update_1_6_9</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Add column to mirror wildbook encounters</span>
            <span class="c1"># FIXME: make this an int that points to a different &quot;static_encounter&quot;</span>
            <span class="c1"># table rowid</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_static_encounter&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<span class="c1"># TODO: YAW TO VIEWPOINT CODE DATABASE CHANGE</span>
<div class="viewcode-block" id="update_1_7_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_7_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_7_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ignore:</span>
<span class="sd">        import wbia</span>
<span class="sd">        ibs = wbia.opendb(&#39;testdb1&#39;)</span>
<span class="sd">        ibs.annots().yaws</span>
<span class="sd">        ibs.annots().viewpoint_int</span>
<span class="sd">        codes = ibs.annots().viewpoint_code</span>
<span class="sd">        texts = [&#39;unknown&#39; if y is None else y for y in ibs.annots().yaw_texts]</span>
<span class="sd">        assert codes == texts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># Add code to represent an arbitrary viewpoint</span>
            <span class="c1"># We are just depricating yaw for now.</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_viewpoint_int&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="post_1_7_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.post_1_7_0">[docs]</a><span class="k">def</span> <span class="nf">post_1_7_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wbia.other</span> <span class="k">import</span> <span class="n">ibsfuncs</span>

        <span class="n">aids</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_rowids</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">)</span>

        <span class="c1"># Get old yaw values</span>
        <span class="n">yaws</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_YAW</span><span class="p">,),</span> <span class="n">aids</span><span class="p">)</span>
        <span class="n">yaws</span> <span class="o">=</span> <span class="p">[</span><span class="n">yaw</span> <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yaw</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaws</span><span class="p">]</span>
        <span class="c1"># Convert them into yaw/view codes</span>
        <span class="n">view_codes</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_yaw_viewtexts</span><span class="p">(</span><span class="n">yaws</span><span class="p">)</span>

        <span class="c1"># Convert the codes into integers</span>
        <span class="n">VIEW</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">VIEW</span>
        <span class="n">UNKNOWN_CODE</span> <span class="o">=</span> <span class="n">VIEW</span><span class="o">.</span><span class="n">INT_TO_CODE</span><span class="p">[</span><span class="n">VIEW</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">]</span>
        <span class="n">view_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNKNOWN_CODE</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">view_codes</span><span class="p">]</span>
        <span class="n">view_ints</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">VIEW</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">,</span> <span class="n">view_codes</span><span class="p">)</span>

        <span class="n">ibs</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;annot_viewpoint_int&#39;</span><span class="p">,),</span> <span class="n">view_ints</span><span class="p">,</span> <span class="n">id_iter</span><span class="o">=</span><span class="n">aids</span>
        <span class="p">)</span>

        <span class="c1"># Moved here from 1.3.4 because the way it is calculated changed</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">update_annot_visual_uuids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">(</span><span class="n">is_staged</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span></div>


<div class="viewcode-block" id="update_1_7_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_7_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_7_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">PART_TABLE</span><span class="p">,</span>
        <span class="p">[],</span>
        <span class="n">dependsmap</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ANNOT_ROWID</span><span class="p">:</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">ANNOT_ROWID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_UUID</span><span class="p">,)),</span>
        <span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_8_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_8_0">[docs]</a><span class="k">def</span> <span class="nf">update_1_8_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_staged_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_staged_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_staged_user_identity&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;annot_staged_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">ANNOT_UUID</span><span class="p">,),</span> <span class="p">(</span><span class="n">ANNOT_VISUAL_UUID</span><span class="p">,</span> <span class="n">ANNOT_STAGED_UUID</span><span class="p">,)],</span>
        <span class="n">primary_superkey</span><span class="o">=</span><span class="p">(</span><span class="n">ANNOT_UUID</span><span class="p">,),</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">PART_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_staged_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_staged_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_staged_user_identity&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_staged_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">superkeys</span><span class="o">=</span><span class="p">[(</span><span class="n">PART_UUID</span><span class="p">,)],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_8_1"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_8_1">[docs]</a><span class="k">def</span> <span class="nf">update_1_8_1</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">PART_TABLE</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_metadata_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;part_contour_json&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_8_2"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_8_2">[docs]</a><span class="k">def</span> <span class="nf">update_1_8_2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">ANNOTATION_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;annot_toggle_canonical&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT NULL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_1_8_3"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_1_8_3">[docs]</a><span class="k">def</span> <span class="nf">update_1_8_3</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span>
        <span class="n">const</span><span class="o">.</span><span class="n">IMAGESET_TABLE</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;imageset_occurrence_flag&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER DEFAULT 0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="update_2_0_0"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.update_2_0_0">[docs]</a><span class="k">def</span> <span class="nf">update_2_0_0</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># This update is simply a status marker for the software state</span>
    <span class="k">pass</span></div>


<span class="c1"># ========================</span>
<span class="c1"># Valid Versions &amp; Mapping</span>
<span class="c1"># ========================</span>

<span class="c1"># TODO: do we save a backup with the older version number in the file name?</span>


<span class="n">base</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">BASE_DATABASE_VERSION</span>
<span class="n">VALID_VERSIONS</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="c1"># version:   (Pre-Update Function,  Update Function,    Post-Update Function)</span>
        <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_0_0</span><span class="p">,</span> <span class="n">post_1_0_0</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.0.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_0_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.0.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_0_2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.1.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_1_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.1.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_1_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.2.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_2_0</span><span class="p">,</span> <span class="n">post_1_2_0</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_2_1</span><span class="p">,</span> <span class="n">post_1_2_1</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_1_3_1</span><span class="p">,</span> <span class="n">update_1_3_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_4</span><span class="p">,</span> <span class="n">post_1_3_4</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.5&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.6&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_6</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.7&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_7</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_8</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.3.9&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_3_9</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_4</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.5&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.6&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_6</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.7&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_4_7</span><span class="p">,</span> <span class="n">post_1_4_7</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_1_4_8</span><span class="p">,</span> <span class="n">update_1_4_8</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.4.9&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_1_4_9</span><span class="p">,</span> <span class="n">update_1_4_9</span><span class="p">,</span> <span class="n">post_1_4_9</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_2</span><span class="p">,</span> <span class="n">post_1_5_2</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_4</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.5.5&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_5_5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_1</span><span class="p">,</span> <span class="n">post_1_6_1</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_4</span><span class="p">,</span> <span class="n">post_1_6_4</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.5&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_5</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.6&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_6</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.7&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_7</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_8</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.6.9&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_6_9</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.7.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_7_0</span><span class="p">,</span> <span class="n">post_1_7_0</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.7.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_7_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.8.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_8_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.8.1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_8_1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.8.2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_8_2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;1.8.3&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_1_8_3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;2.0.0&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_2_0_0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SeeAlso:</span>
<span class="sd">    When updating versions need to test and modify in</span>
<span class="sd">    IBEISController._init_sqldbcore</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">LEGACY_UPDATE_FUNCTIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;1.4.1&#39;</span><span class="p">,</span> <span class="n">_sql_helpers</span><span class="o">.</span><span class="n">fix_metadata_consistency</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">__test_db_version_table_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    test for updating from version x to version y</span>

<span class="sd">    There is a problem where the contributor_table superkey is not in</span>
<span class="sd">    PZ_Master0 and I don&#39;t know why. Perhaps it was just a fluke, and it will</span>
<span class="sd">    be ensured from now on.</span>

<span class="sd">    Here is the hacky fix script:</span>
<span class="sd">        assert &#39;contributors_superkeys&#39; not in ut.get_list_column(ibs.db.get_metadata_items(), 0)</span>
<span class="sd">        sorted(ibs.db.get_metadata_items())</span>
<span class="sd">        # So weird that the constraint was set, but not the superkeys</span>
<span class="sd">        constraint_str = ibs.db.get_metadata_val(&#39;contributors_constraint&#39;)</span>
<span class="sd">        parse_result = parse.parse(&#39;CONSTRAINT superkey UNIQUE ({superkey})&#39;, constraint_str)</span>
<span class="sd">        superkey = parse_result[&#39;superkey&#39;]</span>
<span class="sd">        assert superkey == &#39;contributor_tag&#39;</span>
<span class="sd">        assert None is ibs.db.get_metadata_val(&#39;contributors_superkey&#39;)</span>
<span class="sd">        ibs.db.set_metadata_val(&#39;contributors_superkeys&#39;, &quot;[(&#39;contributor_tag&#39;,)]&quot;)</span>

<span class="sd">        # Made a mistake</span>
<span class="sd">        print(ibs.db.get_table_csv_header(&#39;metadata&#39;))</span>
<span class="sd">        badrowid = ibs.db.get_rowid_from_superkey(&#39;metadata&#39;, [(&#39;contributors_superkey&#39;,)], (&#39;metadata_key&#39;,))</span>
<span class="sd">        assert len(badrowid) == 1</span>
<span class="sd">        ibs.db.delete(&#39;metadata&#39;, [badrowid[0]])</span>

<span class="sd">    TODO: make a script that generates an empty database at version X</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="s1">&#39;tmpsqltestdir&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="s1">&#39;tmpsqltestdir&#39;</span><span class="p">)</span>
    <span class="n">tmpdir3</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="s1">&#39;tmpsqltestdir3&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">tmpdir3</span><span class="p">)</span>
    <span class="n">tmpdir3</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="s1">&#39;tmpsqltestdir3&#39;</span><span class="p">)</span>
    <span class="c1"># Should not show contributor table</span>
    <span class="n">ibs1</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">request_dbversion</span><span class="o">=</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ibs1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">print_schema</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;contributors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>

    <span class="n">ibs2</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">request_dbversion</span><span class="o">=</span><span class="s1">&#39;1.0.3&#39;</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ibs2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">print_schema</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;contributors&#39;</span> <span class="ow">in</span> <span class="n">ibs2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ibs2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_schema_current_autogeneration_str</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>

    <span class="k">assert</span> <span class="s1">&#39;contributors_superkeys&#39;</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">ibs2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_metadata_items</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ibs3</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">tmpdir3</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ibs3</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">print_schema</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;contributors&#39;</span> <span class="ow">in</span> <span class="n">ibs1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>

    <span class="c1"># wbia.control.IBEISControl.__ALL_CONTROLLERS__</span>

    <span class="n">ibs1</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ibs2</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ibs1</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ibs2</span><span class="o">.</span><span class="n">depc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">ibs1</span>
    <span class="k">del</span> <span class="n">ibs2</span>


<div class="viewcode-block" id="autogen_db_schema"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.autogen_db_schema">[docs]</a><span class="k">def</span> <span class="nf">autogen_db_schema</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    autogen_db_schema</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema --diff=1</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema -n=-1</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema -n=0</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema -n=1</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --force-incremental-db-update</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema --write</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema --force-incremental-db-update --dump-autogen-schema</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA --test-autogen_db_schema --force-incremental-db-update</span>


<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.control.DB_SCHEMA import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; autogen_db_schema()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">DB_SCHEMA</span>
    <span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">_sql_helpers</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">schema_spec</span> <span class="o">=</span> <span class="n">DB_SCHEMA</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">_sql_helpers</span><span class="o">.</span><span class="n">autogenerate_nth_schema_version</span><span class="p">(</span><span class="n">schema_spec</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span></div>


<div class="viewcode-block" id="dump_schema_sql"><a class="viewcode-back" href="../../../wbia.control.html#wbia.control.DB_SCHEMA.dump_schema_sql">[docs]</a><span class="k">def</span> <span class="nf">dump_schema_sql</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.control.DB_SCHEMA dump_schema_sql</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">dtool</span> <span class="k">as</span> <span class="n">dt</span>
    <span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">DB_SCHEMA_CURRENT</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">SQLDatabaseController</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>
    <span class="n">DB_SCHEMA_CURRENT</span><span class="o">.</span><span class="n">update_current</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">dump_str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">dump_to_string</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dump_str</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
        <span class="n">autogen_dict</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_autogen_dict</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="n">autogen_dict</span><span class="p">[</span><span class="s1">&#39;coldef_list&#39;</span><span class="p">]</span>
        <span class="n">str_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_make_add_table_sqlstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">coldef_list</span><span class="o">=</span><span class="n">coldef_list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">str_</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python -m wbia.algo.preproc.preproc_chip</span>
<span class="sd">    python -m wbia.control.DB_SCHEMA --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  <li><a href="../control.html">wbia.control</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
