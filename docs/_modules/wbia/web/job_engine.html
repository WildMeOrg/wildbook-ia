
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.web.job_engine &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.web.job_engine</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Accepts and handles requests for tasks.</span>

<span class="sd">Each of the following runs in its own Thread/Process.</span>

<span class="sd">BASICALLY DO A CLIENT/SERVER TO SPAWN PROCESSES</span>
<span class="sd">AND THEN A PUBLISH SUBSCRIBE TO RETURN DATA</span>

<span class="sd">Accepter:</span>
<span class="sd">    Receives tasks and requests</span>
<span class="sd">    Delegates tasks and responds to requests</span>
<span class="sd">    Tasks are delgated to an engine</span>

<span class="sd">Engine:</span>
<span class="sd">    the engine accepts requests.</span>
<span class="sd">    the engine immediately responds WHERE it will be ready.</span>
<span class="sd">    the engine sends a message to the collector saying that something will be ready.</span>
<span class="sd">    the engine then executes a task.</span>
<span class="sd">    The engine is given direct access to the data.</span>

<span class="sd">Collector:</span>
<span class="sd">    The collector accepts requests</span>
<span class="sd">    The collector can respond:</span>
<span class="sd">        * &lt;ResultContent&gt;</span>
<span class="sd">        * Results are ready.</span>
<span class="sd">        * Results are not ready.</span>
<span class="sd">        * Unknown jobid.</span>
<span class="sd">        * Error computing results.</span>
<span class="sd">        * Progress percent.</span>

<span class="sd">References:</span>
<span class="sd">    Simple task farm, with routed replies in pyzmq</span>
<span class="sd">    http://stackoverflow.com/questions/7809200/implementing-task-farm-messaging-pattern-with-zeromq</span>
<span class="sd">    https://gist.github.com/minrk/1358832</span>

<span class="sd">Notes:</span>
<span class="sd">    We are essentially goint to be spawning two processes.</span>
<span class="sd">    We can test these simultaniously using</span>

<span class="sd">        python -m wbia.web.job_engine job_engine_tester</span>

<span class="sd">    We can test these separately by first starting the background server</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --bg</span>

<span class="sd">        Alternative:</span>
<span class="sd">            python -m wbia.web.job_engine job_engine_tester --bg --no-engine</span>
<span class="sd">            python -m wbia.web.job_engine job_engine_tester --bg --only-engine --fg-engine</span>

<span class="sd">    And then running the forground process</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --fg</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># if False:</span>
<span class="c1">#    import os</span>
<span class="c1">#    os.environ[&#39;UTOOL_NOCNN&#39;] = &#39;True&#39;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">uuid</span>  <span class="c1"># NOQA</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">wbia.control</span> <span class="kn">import</span> <span class="n">controller_inject</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>


<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">make_ibs_register_decorator</span><span class="p">(</span>
    <span class="vm">__name__</span>
<span class="p">)</span>
<span class="n">register_api</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">get_wbia_flask_api</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

<span class="c1"># FIXME: needs to use correct number of ports</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1&#39;</span>
<span class="n">NUM_ENGINES</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--serial-job-lanes&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">2</span>
<span class="c1"># VERBOSE_JOBS = (</span>
<span class="c1">#     ut.get_argflag(&#39;--bg&#39;) or ut.get_argflag(&#39;--fg&#39;) or ut.get_argflag(&#39;--verbose-jobs&#39;)</span>
<span class="c1"># )</span>
<span class="n">VERBOSE_JOBS</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">GLOBAL_SHELVE_LOCK</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<span class="n">TIMESTAMP_FMTSTR</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z&#39;</span>
<span class="n">TIMESTAMP_TIMEZONE</span> <span class="o">=</span> <span class="s1">&#39;US/Pacific&#39;</span>


<span class="n">JOB_STATUS_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="update_proctitle"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.update_proctitle">[docs]</a><span class="k">def</span> <span class="nf">update_proctitle</span><span class="p">(</span><span class="n">procname</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">setproctitle</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CHANGING PROCESS TITLE&#39;</span><span class="p">)</span>
        <span class="n">old_title</span> <span class="o">=</span> <span class="n">setproctitle</span><span class="o">.</span><span class="n">getproctitle</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;old_title = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_title</span><span class="p">,))</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_computer_name</span><span class="p">()</span>
        <span class="n">new_title</span> <span class="o">=</span> <span class="s1">&#39;WBIA_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">procname</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;new_title = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_title</span><span class="p">,))</span>
        <span class="n">setproctitle</span><span class="o">.</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">new_title</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pip install setproctitle&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_engine_job_paths</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">)</span>
    <span class="n">record_filepath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;*.pkl&#39;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">record_filepath_list</span>


<span class="k">def</span> <span class="nf">_get_engine_lock_paths</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">)</span>
    <span class="n">lock_filepath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;*.lock&#39;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">lock_filepath_list</span>


<div class="viewcode-block" id="retry_job"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.retry_job">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">retry_job</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
    <span class="n">job_record_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)</span>
    <span class="n">job_record_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="n">job_record_filename</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">job_record_filepath</span><span class="p">)</span>

    <span class="n">job_record</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">job_record_filepath</span><span class="p">)</span>

    <span class="n">job_action</span> <span class="o">=</span> <span class="n">job_record</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
    <span class="n">job_args</span> <span class="o">=</span> <span class="n">job_record</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
    <span class="n">job_kwargs</span> <span class="o">=</span> <span class="n">job_record</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">][</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="n">job_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">job_action</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_result</span> <span class="o">=</span> <span class="n">job_func</span><span class="p">(</span><span class="o">*</span><span class="n">job_args</span><span class="p">,</span> <span class="o">**</span><span class="n">job_kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">job_action</span><span class="p">,</span> <span class="n">job_func</span><span class="p">,</span> <span class="n">job_args</span><span class="p">,</span> <span class="n">job_kwargs</span><span class="p">,</span> <span class="n">job_result</span></div>


<div class="viewcode-block" id="initialize_job_manager"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.initialize_job_manager">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">initialize_job_manager</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a background zmq job engine. Initializes a zmq object in this thread</span>
<span class="sd">    that can talk to the background processes.</span>

<span class="sd">    Run from the webserver</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.web.job_engine --exec-initialize_job_manager:0</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web import apis_engine</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web import job_engine</span>
<span class="sd">        &gt;&gt;&gt; ibs.load_plugin_module(job_engine)</span>
<span class="sd">        &gt;&gt;&gt; ibs.load_plugin_module(apis_engine)</span>
<span class="sd">        &gt;&gt;&gt; ibs.initialize_job_manager()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Initializqation success. Now closing&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs.close_job_manager()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Closing success.&#39;)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--web-tests)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; import requests</span>
<span class="sd">        &gt;&gt;&gt; with wbia.opendb_bg_web(db=&#39;testdb1&#39;, managed=True) as web_instance:</span>
<span class="sd">        ...     web_port = ibs.get_web_port_via_scan()</span>
<span class="sd">        ...     if web_port is None:</span>
<span class="sd">        ...         raise ValueError(&#39;IA web server is not running on any expected port&#39;)</span>
<span class="sd">        ...     baseurl = &#39;http://127.0.1.1:%s&#39; % (web_port, )</span>
<span class="sd">        ...     _payload = {&#39;image_attrs_list&#39;: [], &#39;annot_attrs_list&#39;: []}</span>
<span class="sd">        ...     payload = ut.map_dict_vals(ut.to_json, _payload)</span>
<span class="sd">        ...     resp1 = requests.post(baseurl + &#39;/api/test/helloworld/?f=b&#39;, data=payload)</span>
<span class="sd">        ...     #resp2 = requests.post(baseurl + &#39;/api/image/json/&#39;, data=payload)</span>
<span class="sd">        ...     #print(resp2)</span>
<span class="sd">        ...     #json_dict = resp2.json()</span>
<span class="sd">        ...     #text = json_dict[&#39;response&#39;]</span>
<span class="sd">        ...     #print(text)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">DynStruct</span><span class="p">()</span>

    <span class="n">use_static_ports</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--web-deterministic-ports&#39;</span><span class="p">):</span>
        <span class="n">use_static_ports</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--fg&#39;</span><span class="p">):</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">reciever</span> <span class="o">=</span> <span class="n">JobBackend</span><span class="p">(</span><span class="n">use_static_ports</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">reciever</span> <span class="o">=</span> <span class="n">JobBackend</span><span class="p">(</span><span class="n">use_static_ports</span><span class="o">=</span><span class="n">use_static_ports</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">reciever</span><span class="o">.</span><span class="n">initialize_background_processes</span><span class="p">(</span>
            <span class="n">dbdir</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_dbdir</span><span class="p">(),</span>
            <span class="n">containerized</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">containerized</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Delete any leftover locks from before</span>
    <span class="n">lock_filepath_list</span> <span class="o">=</span> <span class="n">_get_engine_lock_paths</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%d</span><span class="s1"> leftover engine locks&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lock_filepath_list</span><span class="p">),))</span>
    <span class="k">for</span> <span class="n">lock_filepath</span> <span class="ow">in</span> <span class="n">lock_filepath_list</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">lock_filepath</span><span class="p">)</span>

    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span> <span class="o">=</span> <span class="n">JobInterface</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">reciever</span><span class="o">.</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="n">ibs</span>
    <span class="p">)</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">initialize_client_thread</span><span class="p">()</span>
    <span class="c1"># Wait until the collector becomes live</span>
    <span class="k">while</span> <span class="mi">0</span> <span class="ow">and</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;result = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ok&#39;</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">queue_interrupted_jobs</span><span class="p">()</span></div>

    <span class="c1"># import wbia</span>
    <span class="c1"># #dbdir = &#39;/media/raid/work/testdb1&#39;</span>
    <span class="c1"># from wbia.web import app</span>
    <span class="c1"># web_port = ibs.get_web_port_via_scan()</span>
    <span class="c1"># if web_port is None:</span>
    <span class="c1">#     raise ValueError(&#39;IA web server is not running on any expected port&#39;)</span>
    <span class="c1"># proc = ut.spawn_background_process(app.start_from_wbia, ibs, port=web_port)</span>


<div class="viewcode-block" id="close_job_manager"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.close_job_manager">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">close_job_manager</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="c1"># if hasattr(ibs, &#39;job_manager&#39;) and ibs.job_manager is not None:</span>
    <span class="c1">#     pass</span>
    <span class="k">del</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">reciever</span>
    <span class="k">del</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_job_id_list"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_job_id_list">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="nd">@register_api</span><span class="p">(</span><span class="s1">&#39;/api/engine/job/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">__api_plural_check__</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_job_id_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web call that returns the list of job ids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        # Run Everything together</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_status</span>

<span class="sd">        # Start job queue in its own process</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --bg</span>
<span class="sd">        # Start web server in its own process</span>
<span class="sd">        ./main.py --web --fg</span>
<span class="sd">        pass</span>
<span class="sd">        # Run foreground process</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_status:0 --fg</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--web-tests)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; with wbia.opendb_bg_web(&#39;testdb1&#39;, managed=True) as web_ibs:  # , domain=&#39;http://52.33.105.88&#39;)</span>
<span class="sd">        ...     # Test get status of a job id that does not exist</span>
<span class="sd">        ...     response = web_ibs.send_wbia_request(&#39;/api/engine/job/&#39;, jobid=&#39;badjob&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_id_list</span><span class="p">()</span>
    <span class="n">jobid_list</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;jobid_list&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jobid_list</span></div>


<div class="viewcode-block" id="get_job_status"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_job_status">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="nd">@register_api</span><span class="p">(</span>
    <span class="s1">&#39;/api/engine/job/status/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">__api_plural_check__</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">get_job_status</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web call that returns the status of a job</span>

<span class="sd">    Returns one of:</span>
<span class="sd">        received              - job has been received, but not ingested yet</span>
<span class="sd">        accepted              - job has been accepted (validated)</span>
<span class="sd">        queued                - job has been transferred to the engine queue</span>
<span class="sd">        working               - job is being worked on by the engine</span>
<span class="sd">        publishing            - job is done on the engine, pushing results to collector</span>
<span class="sd">        completed | exception - job is complete or has an error</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        # Run Everything together</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_status</span>

<span class="sd">        # Start job queue in its own process</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --bg</span>
<span class="sd">        # Start web server in its own process</span>
<span class="sd">        ./main.py --web --fg</span>
<span class="sd">        pass</span>
<span class="sd">        # Run foreground process</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_status:0 --fg</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--web-tests)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; with wbia.opendb_bg_web(&#39;testdb1&#39;, managed=True) as web_ibs:  # , domain=&#39;http://52.33.105.88&#39;)</span>
<span class="sd">        ...     # Test get status of a job id that does not exist</span>
<span class="sd">        ...     response = web_ibs.send_wbia_request(&#39;/api/engine/job/status/&#39;, jobid=&#39;badjob&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_status_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span></div>


<span class="c1"># @register_ibs_method</span>
<span class="c1"># @register_api(&#39;/api/engine/job/terminate/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])</span>
<span class="c1"># def send_job_terminate(ibs, jobid):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Web call that terminates a job</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     success = ibs.job_manager.jobiface.terminate_job(jobid)</span>
<span class="c1">#     return success</span>


<div class="viewcode-block" id="get_job_metadata"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_job_metadata">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="nd">@register_api</span><span class="p">(</span>
    <span class="s1">&#39;/api/engine/job/metadata/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">__api_plural_check__</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">get_job_metadata</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web call that returns the metadata of a job</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        # Run Everything together</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_metadata</span>

<span class="sd">        # Start job queue in its own process</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --bg</span>
<span class="sd">        # Start web server in its own process</span>
<span class="sd">        ./main.py --web --fg</span>
<span class="sd">        pass</span>
<span class="sd">        # Run foreground process</span>
<span class="sd">        python -m wbia.web.job_engine --exec-get_job_metadata:0 --fg</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # WEB_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; with wbia.opendb_bg_web(&#39;testdb1&#39;, managed=True) as web_ibs:  # , domain=&#39;http://52.33.105.88&#39;)</span>
<span class="sd">        ...     # Test get metadata of a job id that does not exist</span>
<span class="sd">        ...     response = web_ibs.send_wbia_request(&#39;/api/engine/job/metadata/&#39;, jobid=&#39;badjob&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_metadata</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="get_job_result"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_job_result">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="nd">@register_api</span><span class="p">(</span><span class="s1">&#39;/api/engine/job/result/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_job_result</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Web call that returns the result of a job</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="wait_for_job_result"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.wait_for_job_result">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="nd">@register_api</span><span class="p">(</span><span class="s1">&#39;/api/engine/job/result/wait/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">wait_for_job_result</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">wait_for_job_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">job_manager</span><span class="o">.</span><span class="n">jobiface</span><span class="o">.</span><span class="n">get_unpacked_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="k">def</span> <span class="nf">_get_random_open_port</span><span class="p">():</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">49151</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_local_port_open</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">49151</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_local_port_open</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">port</span>


<div class="viewcode-block" id="job_engine_tester"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.job_engine_tester">[docs]</a><span class="k">def</span> <span class="nf">job_engine_tester</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.web.job_engine --exec-job_engine_tester</span>
<span class="sd">        python -b -m wbia.web.job_engine --exec-job_engine_tester</span>

<span class="sd">        python -m wbia.web.job_engine job_engine_tester</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --bg</span>
<span class="sd">        python -m wbia.web.job_engine job_engine_tester --fg</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">        &gt;&gt;&gt; from wbia.web.job_engine import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; job_engine_tester()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_init_signals</span><span class="p">()</span>
    <span class="c1"># now start a few clients, and fire off some requests</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">reciever</span> <span class="o">=</span> <span class="n">JobBackend</span><span class="p">(</span><span class="n">use_static_ports</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">jobiface</span> <span class="o">=</span> <span class="n">JobInterface</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">reciever</span><span class="o">.</span><span class="n">port_dict</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">wbia.init</span> <span class="kn">import</span> <span class="n">sysres</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--bg&#39;</span><span class="p">):</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_args_dbdir</span><span class="p">(</span>
            <span class="n">defaultdb</span><span class="o">=</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbdir</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">reciever</span><span class="o">.</span><span class="n">initialize_background_processes</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[testzmq] parent process is looping forever&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--fg&#39;</span><span class="p">):</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">initialize_client_thread</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbdir</span> <span class="o">=</span> <span class="n">sysres</span><span class="o">.</span><span class="n">get_args_dbdir</span><span class="p">(</span>
            <span class="n">defaultdb</span><span class="o">=</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbdir</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">reciever</span><span class="o">.</span><span class="n">initialize_background_processes</span><span class="p">(</span><span class="n">dbdir</span><span class="p">)</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">initialize_client_thread</span><span class="p">()</span>

    <span class="c1"># Foreground test script</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... waiting for jobs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--cmd&#39;</span><span class="p">):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
        <span class="c1"># jobiface.queue_job()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[test] ... emit test1&#39;</span><span class="p">)</span>
        <span class="n">callback_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">callback_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
        <span class="n">jobid1</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">queue_job</span><span class="p">(</span><span class="s1">&#39;helloworld&#39;</span><span class="p">,</span> <span class="n">callback_url</span><span class="p">,</span> <span class="n">callback_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">wait_for_job_result</span><span class="p">(</span><span class="n">jobid1</span><span class="p">)</span>
        <span class="n">jobid_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfgdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="n">identify_jobid</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">queue_job</span><span class="p">(</span>
            <span class="s1">&#39;query_chips_simple_dict&#39;</span><span class="p">,</span> <span class="n">callback_url</span><span class="p">,</span> <span class="n">callback_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">jobid_list</span><span class="p">:</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">wait_for_job_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">jobiface</span><span class="o">.</span><span class="n">wait_for_job_result</span><span class="p">(</span><span class="n">identify_jobid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FINISHED TEST SCRIPT&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="spawn_background_process"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.spawn_background_process">[docs]</a><span class="k">def</span> <span class="nf">spawn_background_process</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">func_name</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;job-engine.Progress-&#39;</span> <span class="o">+</span> <span class="n">func_name</span>
    <span class="n">proc_obj</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">proc_obj</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">proc_obj</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc_obj</span></div>


<div class="viewcode-block" id="JobBackend"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobBackend">[docs]</a><span class="k">class</span> <span class="nc">JobBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># self.num_engines = 3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_queue_proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s1">&#39;slow&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_engines</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="p">:</span> <span class="n">NUM_ENGINES</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_queue_proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># --</span>
        <span class="n">only_engine</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--only-engine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_collector</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">only_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_engine</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--no-engine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg_engine</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--fg-engine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_queue</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">only_engine</span>
        <span class="c1"># Find ports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_job_ports</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;JobBackend ports:&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning up job backend&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">engine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">[</span><span class="n">lane</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">engine</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_queue_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">engine_queue_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_queue_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_queue_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed external procs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_job_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_static_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">static_root</span><span class="o">=</span><span class="mi">51381</span><span class="p">):</span>
        <span class="c1"># _portgen = functools.partial(six.next, itertools.count(51381))</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;collect_pull_url&#39;</span><span class="p">,</span>
            <span class="s1">&#39;collect_push_url&#39;</span><span class="p">,</span>
            <span class="s1">&#39;engine_pull_url&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;engine_push_url&#39;,</span>
            <span class="c1"># &#39;collect_pushpull_url&#39;,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span><span class="p">:</span>
            <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;engine_</span><span class="si">%s</span><span class="s1">_push_url&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="p">,))</span>

        <span class="c1"># Get ports</span>
        <span class="k">if</span> <span class="n">use_static_ports</span><span class="p">:</span>
            <span class="n">port_list</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">static_root</span><span class="p">,</span> <span class="n">static_root</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">port_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">port_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">):</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">_get_random_open_port</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">port</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">port_list</span><span class="p">:</span>
                    <span class="n">port_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="n">port_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">port_list</span><span class="p">)</span>
        <span class="c1"># Assign ports</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">port_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">port_list</span><span class="p">))</span>
        <span class="p">}</span>

<div class="viewcode-block" id="JobBackend.initialize_background_processes"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobBackend.initialize_background_processes">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_background_processes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dbdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">containerized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">thread</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1"># if VERBOSE_JOBS:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initialize Background Processes&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_spawner</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

            <span class="c1"># if thread:</span>
            <span class="c1">#     _spawner_func_ = ut.spawn_background_daemon_thread</span>
            <span class="c1"># else:</span>
            <span class="c1">#     _spawner_func_ = ut.spawn_background_process</span>
            <span class="n">_spawner_func_</span> <span class="o">=</span> <span class="n">spawn_background_process</span>

            <span class="n">proc</span> <span class="o">=</span> <span class="n">_spawner_func_</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="s1">&#39;proc (</span><span class="si">%s</span><span class="s1">) died too soon&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span>
                    <span class="n">func</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">proc</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine_queue_proc</span> <span class="o">=</span> <span class="n">_spawner</span><span class="p">(</span>
                <span class="n">engine_queue_loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_queue_proc</span> <span class="o">=</span> <span class="n">_spawner</span><span class="p">(</span><span class="n">collect_queue_loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_collector</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_proc</span> <span class="o">=</span> <span class="n">_spawner</span><span class="p">(</span>
                <span class="n">collector_loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">containerized</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_engine</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_engine</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ENGINE IS IN DEBUG FOREGROUND MODE&#39;</span><span class="p">)</span>
                <span class="c1"># Spawn engine in foreground process</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_engines</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fg engine only works with one engine&#39;</span>
                <span class="n">engine_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">)</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;should never see this&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Normal case</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_lanes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_engines</span><span class="p">[</span><span class="n">lane</span><span class="p">]):</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">_spawner</span><span class="p">(</span>
                            <span class="n">engine_loop</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">containerized</span><span class="p">,</span> <span class="n">lane</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>

        <span class="c1"># Check if online</span>
        <span class="c1"># wait for processes to spin up</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_queue</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_queue_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="s1">&#39;engine died too soon&#39;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_queue_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="s1">&#39;collector queue died too soon&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_collector</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="s1">&#39;collector died too soon&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawn_engine</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">engine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_procs</span><span class="p">[</span><span class="n">lane</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="n">engine</span><span class="o">.</span><span class="n">is_alive</span><span class="p">(),</span> <span class="s1">&#39;engine died too soon&#39;</span></div></div>


<div class="viewcode-block" id="get_shelve_lock_filepath"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_shelve_lock_filepath">[docs]</a><span class="k">def</span> <span class="nf">get_shelve_lock_filepath</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">):</span>
    <span class="n">shelve_lock_filepath</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shelve_filepath</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">shelve_lock_filepath</span></div>


<div class="viewcode-block" id="touch_shelve_lock_file"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.touch_shelve_lock_file">[docs]</a><span class="k">def</span> <span class="nf">touch_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">):</span>
    <span class="n">shelve_lock_filepath</span> <span class="o">=</span> <span class="n">get_shelve_lock_filepath</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_shelve_lock_file"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.delete_shelve_lock_file">[docs]</a><span class="k">def</span> <span class="nf">delete_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">):</span>
    <span class="n">shelve_lock_filepath</span> <span class="o">=</span> <span class="n">get_shelve_lock_filepath</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_shelve_lock_file"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.wait_for_shelve_lock_file">[docs]</a><span class="k">def</span> <span class="nf">wait_for_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
    <span class="n">shelve_lock_filepath</span> <span class="o">=</span> <span class="n">get_shelve_lock_filepath</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">exists</span><span class="p">(</span><span class="n">shelve_lock_filepath</span><span class="p">):</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting for </span><span class="si">%0.02f</span><span class="s1"> seconds for lock so far&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elapsed</span><span class="p">,))</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="get_shelve_value"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_shelve_value">[docs]</a><span class="k">def</span> <span class="nf">get_shelve_value</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">wait_for_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">GLOBAL_SHELVE_LOCK</span><span class="p">:</span>
        <span class="n">wait_for_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
        <span class="n">touch_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">delete_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="set_shelve_value"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.set_shelve_value">[docs]</a><span class="k">def</span> <span class="nf">set_shelve_value</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">wait_for_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">GLOBAL_SHELVE_LOCK</span><span class="p">:</span>
        <span class="n">wait_for_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
        <span class="n">touch_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf</span><span class="p">:</span>
            <span class="n">shelf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">delete_shelve_lock_file</span><span class="p">(</span><span class="n">shelve_filepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="get_shelve_filepaths"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_shelve_filepaths">[docs]</a><span class="k">def</span> <span class="nf">get_shelve_filepaths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
    <span class="n">shelve_input_filepath</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.input.shelve&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)))</span>
    <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.output.shelve&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)))</span>
    <span class="k">return</span> <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span></div>


<div class="viewcode-block" id="initialize_process_record"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.initialize_process_record">[docs]</a><span class="k">def</span> <span class="nf">initialize_process_record</span><span class="p">(</span>
    <span class="n">record_filepath</span><span class="p">,</span>
    <span class="n">shelve_input_filepath</span><span class="p">,</span>
    <span class="n">shelve_output_filepath</span><span class="p">,</span>
    <span class="n">shelve_path</span><span class="p">,</span>
    <span class="n">shelve_archive_path</span><span class="p">,</span>
    <span class="n">collect_pull_interface</span><span class="p">,</span>
    <span class="n">jobiface_id</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">collect_recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">collect_pull_interface</span><span class="p">)</span>

    <span class="n">MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">ARCHIVE_DAYS</span> <span class="o">=</span> <span class="mi">14</span>

    <span class="n">timezone</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">TIMESTAMP_TIMEZONE</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">archive_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ARCHIVE_DAYS</span><span class="p">)</span>
    <span class="n">archive_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">archive_delta</span>
    <span class="n">archive_timestamp</span> <span class="o">=</span> <span class="n">archive_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIMESTAMP_FMTSTR</span><span class="p">)</span>

    <span class="n">jobid</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">jobcounter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Load the engine record</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Load the record info</span>
    <span class="n">engine_request</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attempts&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Check status</span>
    <span class="n">suppressed</span> <span class="o">=</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="n">MAX_ATTEMPTS</span>
    <span class="n">corrupted</span> <span class="o">=</span> <span class="n">engine_request</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="c1"># Load metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing metadata...corrupted&#39;</span><span class="p">)</span>
        <span class="n">corrupted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">archived</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">corrupted</span><span class="p">:</span>
        <span class="n">jobcounter</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobcounter&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">jobcounter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing jobcounter...corrupted&#39;</span><span class="p">)</span>
            <span class="n">corrupted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">job_age</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">corrupted</span> <span class="ow">and</span> <span class="n">completed</span><span class="p">:</span>
            <span class="n">completed_timestamp</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">completed_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">archive_elapsed</span> <span class="o">=</span> <span class="n">calculate_timedelta</span><span class="p">(</span>
                        <span class="n">completed_timestamp</span><span class="p">,</span> <span class="n">archive_timestamp</span>
                    <span class="p">)</span>
                    <span class="n">job_age</span> <span class="o">=</span> <span class="n">archive_elapsed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">archived</span> <span class="o">=</span> <span class="n">job_age</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">completed_timestamp</span><span class="p">,</span>
                        <span class="n">archive_timestamp</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;[job_engine] Could not determine archive status!</span><span class="se">\n\t</span><span class="s1">Completed: </span><span class="si">%r</span><span class="se">\n\t</span><span class="s1">Archive: </span><span class="si">%r</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="n">args</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">archived</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface_id</span><span class="p">)):</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;brightmagenta&#39;</span>
                    <span class="n">print_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">print_</span><span class="p">(</span><span class="s1">&#39;ARCHIVING JOB (AGE: </span><span class="si">%d</span><span class="s1"> SECONDS)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_age</span><span class="p">,))</span>
                    <span class="n">job_scr_filepath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)))</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">job_scr_filepath</span> <span class="ow">in</span> <span class="n">job_scr_filepath_list</span><span class="p">:</span>
                        <span class="n">job_dst_filepath</span> <span class="o">=</span> <span class="n">job_scr_filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">shelve_path</span><span class="p">,</span> <span class="n">shelve_archive_path</span>
                        <span class="p">)</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                            <span class="n">job_scr_filepath</span><span class="p">,</span> <span class="n">job_dst_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>  <span class="c1"># ut.copy allows for overwrite, ut.move does not</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">job_scr_filepath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">archived</span><span class="p">:</span>
        <span class="c1"># We have archived the job, don&#39;t bother registering it</span>
        <span class="n">engine_request</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">completed</span> <span class="ow">or</span> <span class="n">suppressed</span> <span class="ow">or</span> <span class="n">corrupted</span><span class="p">:</span>
            <span class="c1"># Register the job, pass the jobcounter and jobid only</span>
            <span class="n">engine_request</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">completed</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span>
            <span class="k">elif</span> <span class="n">suppressed</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;suppressed&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>

            <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>
            <span class="c1"># reply = collect_recieve_socket.recv_json()</span>
            <span class="c1"># jobid_ = reply[&#39;jobid&#39;]</span>
            <span class="c1"># assert jobid_ == jobid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We have a pending job, restart with the original request</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface_id</span><span class="p">)):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;brightblue&#39;</span> <span class="k">if</span> <span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;brightred&#39;</span>
                <span class="n">print_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

                <span class="n">print_</span><span class="p">(</span>
                    <span class="s1">&#39;RESTARTING FAILED JOB FROM RESTART (ATTEMPT </span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">print_</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">))</span>
                <span class="c1"># print_(ut.repr3(record))</span>

                <span class="n">times</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">received</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;received&#39;</span><span class="p">]</span>

                <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;restart_jobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobid</span>
                <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;restart_jobcounter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobcounter</span>
                <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;restart_received&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">received</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">collect_pull_interface</span><span class="p">)</span>
    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">jobcounter</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">engine_request</span><span class="p">,</span> <span class="n">archived</span><span class="p">,</span> <span class="n">completed</span><span class="p">,</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">corrupted</span>
    <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="JobInterface"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface">[docs]</a><span class="k">class</span> <span class="nc">JobInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">port_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span> <span class="o">=</span> <span class="n">id_</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">ibs</span> <span class="o">=</span> <span class="n">ibs</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">VERBOSE_JOBS</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span> <span class="o">=</span> <span class="n">port_dict</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;JobInterface ports:&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="n">jobiface</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaning up job frontend&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
                <span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_pull_url&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span>
                <span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># def init(jobiface):</span>
    <span class="c1">#     # Starts several new processes</span>
    <span class="c1">#     jobiface.initialize_background_processes()</span>
    <span class="c1">#     # Does not create a new process, but connects sockets on this process</span>
    <span class="c1">#     jobiface.initialize_client_thread()</span>

<div class="viewcode-block" id="JobInterface.initialize_client_thread"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.initialize_client_thread">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_client_thread</span><span class="p">(</span><span class="n">jobiface</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a ZMQ object in this thread. This talks to background processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing JobInterface&#39;</span><span class="p">)</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>  <span class="c1"># CHECK2 - REQ</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;client</span><span class="si">%s</span><span class="s1">.engine.DEALER&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_pull_url&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;connect engine_pull_url = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_pull_url&#39;</span><span class="p">],)</span>
            <span class="p">)</span>

        <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>  <span class="c1"># CHECK2 - REQ</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;client</span><span class="si">%s</span><span class="s1">.collect.DEALER&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;connect collect_pull_url = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">],)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="JobInterface.queue_interrupted_jobs"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.queue_interrupted_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">queue_interrupted_jobs</span><span class="p">(</span><span class="n">jobiface</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tqdm</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">ibs</span>

        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
            <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">shelve_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">shelve_archive_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ARCHIVE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shelve_path</span><span class="p">,)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">shelve_archive_path</span><span class="p">)</span>

            <span class="n">record_filepath_list</span> <span class="o">=</span> <span class="n">_get_engine_job_paths</span><span class="p">(</span><span class="n">ibs</span><span class="p">)</span>

            <span class="n">num_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_filepath_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reloading </span><span class="si">%d</span><span class="s1"> engine jobs...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_records</span><span class="p">,))</span>

            <span class="n">shelve_input_filepath_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">shelve_output_filepath_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">record_filepath</span> <span class="ow">in</span> <span class="n">record_filepath_list</span><span class="p">:</span>
                <span class="n">jobid</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">get_shelve_filepaths</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span>
                <span class="p">)</span>
                <span class="n">shelve_input_filepath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shelve_input_filepath</span><span class="p">)</span>
                <span class="n">shelve_output_filepath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shelve_output_filepath</span><span class="p">)</span>

            <span class="n">collect_pull_interface</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">]</span>

            <span class="n">arg_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">record_filepath_list</span><span class="p">,</span>
                    <span class="n">shelve_input_filepath_list</span><span class="p">,</span>
                    <span class="n">shelve_output_filepath_list</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">shelve_path</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_records</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">shelve_archive_path</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_records</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">collect_pull_interface</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_records</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_records</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_iter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">values_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_parallel</span><span class="o">.</span><span class="n">generate2</span><span class="p">(</span>
                    <span class="n">initialize_process_record</span><span class="p">,</span>
                    <span class="n">arg_iter</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">values_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">restart_jobcounter_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">restart_jobid_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">restart_request_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">global_jobcounter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_registered</span><span class="p">,</span> <span class="n">num_restarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">num_completed</span><span class="p">,</span> <span class="n">num_archived</span><span class="p">,</span> <span class="n">num_suppressed</span><span class="p">,</span> <span class="n">num_corrupted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">jobcounter</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="p">,</span>
                    <span class="n">engine_request</span><span class="p">,</span>
                    <span class="n">archived</span><span class="p">,</span>
                    <span class="n">completed</span><span class="p">,</span>
                    <span class="n">suppressed</span><span class="p">,</span>
                    <span class="n">corrupted</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">values</span>

                <span class="k">if</span> <span class="n">archived</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">engine_request</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="n">num_archived</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">jobcounter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">global_jobcounter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">global_jobcounter</span><span class="p">,</span> <span class="n">jobcounter</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">engine_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">archived</span>
                    <span class="k">if</span> <span class="n">completed</span><span class="p">:</span>
                        <span class="n">num_completed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">suppressed</span><span class="p">:</span>
                        <span class="n">num_suppressed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">num_corrupted</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_restarted</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">restart_jobcounter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobcounter</span><span class="p">)</span>
                    <span class="n">restart_jobid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
                    <span class="n">restart_request_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_request</span><span class="p">)</span>

                <span class="n">num_registered</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">assert</span> <span class="n">num_restarted</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">restart_jobcounter_list</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Registered </span><span class="si">%d</span><span class="s1"> jobs...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_registered</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> completed jobs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_completed</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> restarted jobs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_restarted</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> suppressed jobs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_suppressed</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> corrupted jobs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_corrupted</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Archived </span><span class="si">%d</span><span class="s1"> jobs...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_archived</span><span class="p">,))</span>

            <span class="c1"># Update the jobcounter to be up to date</span>
            <span class="n">update_notify</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;__set_jobcounter__&#39;</span><span class="p">:</span> <span class="n">global_jobcounter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating completed job counter: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">update_notify</span><span class="p">,))</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">update_notify</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
            <span class="n">jobcounter_</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobcounter&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">jobcounter_</span> <span class="o">==</span> <span class="n">global_jobcounter</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Re-sending </span><span class="si">%d</span><span class="s1"> engine jobs...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">restart_jobcounter_list</span><span class="p">),))</span>

            <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">restart_jobcounter_list</span><span class="p">)</span>
            <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">restart_jobcounter_list</span><span class="p">,</span> <span class="n">restart_jobid_list</span><span class="p">,</span> <span class="n">restart_request_list</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">zipped</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">zipped</span><span class="p">,</span> <span class="n">index_list</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">jobcounter</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">engine_request</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">zipped</span><span class="p">):</span>
                <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">engine_request</span><span class="p">)</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                <span class="n">jobcounter_</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobcounter&#39;</span><span class="p">]</span>
                <span class="n">jobid_</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">jobcounter_</span> <span class="o">==</span> <span class="n">jobcounter</span>
                <span class="k">assert</span> <span class="n">jobid_</span> <span class="o">==</span> <span class="n">jobid</span></div>

<div class="viewcode-block" id="JobInterface.queue_job"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.queue_job">[docs]</a>    <span class="k">def</span> <span class="nf">queue_job</span><span class="p">(</span>
        <span class="n">jobiface</span><span class="p">,</span>
        <span class="n">action</span><span class="p">,</span>
        <span class="n">callback_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">callback_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lane</span><span class="o">=</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        IBEIS:</span>
<span class="sd">            This is just a function that lives in the main thread and ships off</span>
<span class="sd">            a job.</span>

<span class="sd">        FIXME: I do not like having callback_url and callback_method specified</span>
<span class="sd">               like this with args and kwargs. If these must be there then</span>
<span class="sd">               they should be specified first, or</span>
<span class="sd">               THE PREFERED OPTION IS</span>
<span class="sd">               args and kwargs should not be specified without the * syntax</span>

<span class="sd">        The client - sends messages, and receives replies after they</span>
<span class="sd">        have been processed by the</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NAME: job_client</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>

            <span class="n">request</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                        <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">engine_request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                <span class="s1">&#39;callback_url&#39;</span><span class="p">:</span> <span class="n">callback_url</span><span class="p">,</span>
                <span class="s1">&#39;callback_method&#39;</span><span class="p">:</span> <span class="n">callback_method</span><span class="p">,</span>
                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                <span class="s1">&#39;restart_jobid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;restart_jobcounter&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;restart_received&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;lane&#39;</span><span class="p">:</span> <span class="n">lane</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Queue job: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">engine_request</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">),))</span>

            <span class="c1"># Send request to job</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">engine_request</span><span class="p">)</span>
            <span class="n">reply_notify</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">engine_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reply_notify = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reply_notify</span><span class="p">,))</span>
            <span class="n">jobid</span> <span class="o">=</span> <span class="n">reply_notify</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>

            <span class="n">ibs</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">ibs</span>
            <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">)</span>

                <span class="n">record_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)</span>
                <span class="n">record_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="n">record_filename</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">engine_request</span><span class="p">,</span>
                    <span class="s1">&#39;attempts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Release memor</span>
            <span class="n">action</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">callback_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">callback_method</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">engine_request</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">jobid</span></div>

<div class="viewcode-block" id="JobInterface.get_job_id_list"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_job_id_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_id_list</span><span class="p">(</span><span class="n">jobiface</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># jobiface.verbose &gt;= 1:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Request list of job ids&#39;</span><span class="p">)</span>
            <span class="n">pair_msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;job_id_list&#39;</span><span class="p">)</span>
            <span class="c1"># CALLS: collector_request_status</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">pair_msg</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>

<div class="viewcode-block" id="JobInterface.get_job_status"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_status</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Request status of jobid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
            <span class="n">pair_msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;job_status&#39;</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">)</span>
            <span class="c1"># CALLS: collector_request_status</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">pair_msg</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>

<div class="viewcode-block" id="JobInterface.get_job_status_dict"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_job_status_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_status_dict</span><span class="p">(</span><span class="n">jobiface</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># jobiface.verbose &gt;= 1:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Request list of job ids&#39;</span><span class="p">)</span>
            <span class="n">pair_msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;job_status_dict&#39;</span><span class="p">)</span>
            <span class="c1"># CALLS: collector_request_status</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">pair_msg</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>

<div class="viewcode-block" id="JobInterface.get_job_metadata"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_job_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_metadata</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Request metadata of jobid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
            <span class="n">pair_msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;job_input&#39;</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">)</span>
            <span class="c1"># CALLS: collector_request_metadata</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">pair_msg</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>

<div class="viewcode-block" id="JobInterface.get_job_result"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_job_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_result</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[client </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobiface</span><span class="o">.</span><span class="n">id_</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Request result of jobid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
            <span class="n">pair_msg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;job_result&#39;</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">)</span>
            <span class="c1"># CALLER: collector_request_result</span>
            <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">pair_msg</span><span class="p">)</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reply</span></div>

<div class="viewcode-block" id="JobInterface.get_unpacked_result"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.get_unpacked_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_unpacked_result</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="n">json_result</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">],</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json_result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Failed to unpack result&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span>
        <span class="c1"># Release raw JSON result</span>
        <span class="n">json_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="JobInterface.wait_for_job_result"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.JobInterface.wait_for_job_result">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_job_result</span><span class="p">(</span><span class="n">jobiface</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">tic</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">get_job_status</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;exception&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">jobiface</span><span class="o">.</span><span class="n">get_unpacked_result</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
                <span class="c1"># raise Exception(result)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exception occured in engine&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;working&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown jobstatus=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">],))</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Timeout&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="collect_queue_loop"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.collect_queue_loop">[docs]</a><span class="k">def</span> <span class="nf">collect_queue_loop</span><span class="p">(</span><span class="n">port_dict</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;collect&#39;</span>
    <span class="k">assert</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;must name queue&#39;</span>
    <span class="n">queue_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_queue&#39;</span>
    <span class="n">loop_name</span> <span class="o">=</span> <span class="n">queue_name</span> <span class="o">+</span> <span class="s1">&#39;_loop&#39;</span>

    <span class="n">update_proctitle</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>

    <span class="n">interface_pull</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_pull_url&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)]</span>
    <span class="n">interface_push</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_push_url&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)]</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">queue_name</span><span class="p">,)):</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Init make_queue_loop: name=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="c1"># bind the client dealer to the queue router</span>
        <span class="n">recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>  <span class="c1"># CHECKED - ROUTER</span>
        <span class="n">recieve_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;queue.&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;ROUTER&#39;</span><span class="p">)</span>
        <span class="n">recieve_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">interface_pull</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;bind </span><span class="si">%s</span><span class="s1">_url1 = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">interface_pull</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># bind the server router to the queue dealer</span>
        <span class="n">send_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>  <span class="c1"># CHECKED - DEALER</span>
        <span class="n">send_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;queue.&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;DEALER&#39;</span><span class="p">)</span>
        <span class="n">send_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">interface_push</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;bind </span><span class="si">%s</span><span class="s1">_url2 = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">interface_push</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">QUEUE</span><span class="p">,</span> <span class="n">recieve_socket</span><span class="p">,</span> <span class="n">send_socket</span><span class="p">)</span>  <span class="c1"># CHECKED - QUEUE</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Caught ctrl+c in queue loop. Gracefully exiting&#39;</span><span class="p">)</span>

        <span class="n">recieve_socket</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">interface_pull</span><span class="p">)</span>
        <span class="n">recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">send_socket</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">interface_push</span><span class="p">)</span>
        <span class="n">send_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exiting </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loop_name</span><span class="p">,))</span></div>


<div class="viewcode-block" id="engine_queue_loop"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.engine_queue_loop">[docs]</a><span class="k">def</span> <span class="nf">engine_queue_loop</span><span class="p">(</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">engine_lanes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialized queue loop</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Flow of information tags:</span>
    <span class="c1"># NAME: engine_queue</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;engine&#39;</span>
    <span class="n">queue_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_queue&#39;</span>
    <span class="n">loop_name</span> <span class="o">=</span> <span class="n">queue_name</span> <span class="o">+</span> <span class="s1">&#39;_loop&#39;</span>
    <span class="n">update_proctitle</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>

    <span class="nb">print</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">interface_engine_pull</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_pull_url&#39;</span><span class="p">]</span>
    <span class="n">interface_engine_push_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">lane</span><span class="p">:</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_</span><span class="si">%s</span><span class="s1">_push_url&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="p">,)]</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">engine_lanes</span>
    <span class="p">}</span>
    <span class="n">interface_collect_pull</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">queue_name</span><span class="p">,)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Init specialized make_queue_loop: name=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>

        <span class="c1"># bind the client dealer to the queue router</span>
        <span class="n">engine_receive_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>  <span class="c1"># CHECK2 - REP</span>
        <span class="n">engine_receive_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;special_queue.&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;ROUTER&#39;</span>
        <span class="p">)</span>
        <span class="n">engine_receive_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">interface_engine_pull</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;bind </span><span class="si">%s</span><span class="s1">_url2 = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">interface_engine_pull</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># bind the server router to the queue dealer</span>
        <span class="n">engine_send_socket_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">interface_engine_push_dict</span><span class="p">:</span>
            <span class="n">engine_send_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>  <span class="c1"># CHECKED - DEALER</span>
            <span class="n">engine_send_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
                <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;special_queue.&#39;</span> <span class="o">+</span> <span class="n">lane</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;DEALER&#39;</span>
            <span class="p">)</span>
            <span class="n">engine_send_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">interface_engine_push_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;bind </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">_url2 = </span><span class="si">%r</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">lane</span><span class="p">,</span>
                        <span class="n">interface_engine_push_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">engine_send_socket_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span> <span class="o">=</span> <span class="n">engine_send_socket</span>

        <span class="n">collect_recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>  <span class="c1"># CHECKED - DEALER</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="n">queue_name</span> <span class="o">+</span> <span class="s1">&#39;.collect.DEALER&#39;</span>
        <span class="p">)</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;connect collect_pull_url = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">))</span>

        <span class="c1"># but this shows what is really going on:</span>
        <span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>
        <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">engine_receive_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">engine_send_socket_dict</span><span class="p">:</span>
            <span class="n">engine_send_socket</span> <span class="o">=</span> <span class="n">engine_send_socket_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span>
            <span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">engine_send_socket</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

        <span class="c1"># always start at 0</span>
        <span class="n">global_jobcounter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">evts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">engine_receive_socket</span> <span class="ow">in</span> <span class="n">evts</span><span class="p">:</span>
                    <span class="c1"># CALLER: job_client</span>
                    <span class="n">idents</span><span class="p">,</span> <span class="n">engine_request</span> <span class="o">=</span> <span class="n">rcv_multipart_json</span><span class="p">(</span>
                        <span class="n">engine_receive_socket</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">print</span><span class="o">=</span><span class="nb">print</span>
                    <span class="p">)</span>

                    <span class="n">set_jobcounter</span> <span class="o">=</span> <span class="n">engine_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__set_jobcounter__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">set_jobcounter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">global_jobcounter</span> <span class="o">=</span> <span class="n">set_jobcounter</span>
                        <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;jobcounter&#39;</span><span class="p">:</span> <span class="n">global_jobcounter</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;... notifying client that jobcounter was updated to </span><span class="si">%d</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">global_jobcounter</span><span class="p">,)</span>
                        <span class="p">)</span>
                        <span class="c1"># RETURNS: job_client_return</span>
                        <span class="n">send_multipart_json</span><span class="p">(</span><span class="n">engine_receive_socket</span><span class="p">,</span> <span class="n">idents</span><span class="p">,</span> <span class="n">reply_notify</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># jobid = &#39;jobid-%04d&#39; % (jobcounter,)</span>
                    <span class="n">jobid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),)</span>
                    <span class="n">jobcounter</span> <span class="o">=</span> <span class="n">global_jobcounter</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">received</span> <span class="o">=</span> <span class="n">_timestamp</span><span class="p">()</span>

                    <span class="n">action</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>
                    <span class="n">callback_url</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;callback_url&#39;</span><span class="p">]</span>
                    <span class="n">callback_method</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;callback_method&#39;</span><span class="p">]</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span>
                    <span class="n">restart_jobid</span> <span class="o">=</span> <span class="n">engine_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart_jobid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">restart_jobcounter</span> <span class="o">=</span> <span class="n">engine_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart_jobcounter&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">restart_received</span> <span class="o">=</span> <span class="n">engine_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart_received&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">lane</span> <span class="o">=</span> <span class="n">engine_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lane&#39;</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">lane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">engine_lanes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39;WARNING: did not recognize desired lane </span><span class="si">%r</span><span class="s1"> from </span><span class="si">%r</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">lane</span><span class="p">,</span>
                                <span class="n">engine_lanes</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Defaulting to slow lane&#39;</span><span class="p">)</span>
                        <span class="n">lane</span> <span class="o">=</span> <span class="s1">&#39;slow&#39;</span>

                    <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;lane&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lane</span>

                    <span class="k">if</span> <span class="n">restart_jobid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="s1">&#39;[RESTARTING] Replacing jobid=</span><span class="si">%s</span><span class="s1"> with previous restart_jobid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">jobid</span><span class="p">,</span>
                            <span class="n">restart_jobid</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">jobid</span> <span class="o">=</span> <span class="n">restart_jobid</span>

                    <span class="k">if</span> <span class="n">restart_jobcounter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="s1">&#39;[RESTARTING] Replacing jobcounter=</span><span class="si">%s</span><span class="s1"> with previous restart_jobcounter=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">jobcounter</span><span class="p">,</span>
                            <span class="n">restart_jobcounter</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">jobcounter</span> <span class="o">=</span> <span class="n">restart_jobcounter</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Creating jobid </span><span class="si">%r</span><span class="s1"> (counter </span><span class="si">%d</span><span class="s1">)&#39;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">jobid</span><span class="p">,</span>
                            <span class="n">jobcounter</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">restart_received</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">received</span> <span class="o">=</span> <span class="n">restart_received</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Received (Notify Collector)</span>
                    <span class="c1"># Reply immediately with a new jobid</span>
                    <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                        <span class="s1">&#39;jobcounter&#39;</span><span class="p">:</span> <span class="n">jobcounter</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...notifying collector about new job&#39;</span><span class="p">)</span>
                    <span class="c1"># CALLS: collector_notify</span>
                    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Received (Notify Client)</span>
                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... notifying client that job was accepted&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idents</span><span class="p">,))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reply_notify</span><span class="p">,))</span>
                    <span class="c1"># RETURNS: job_client_return</span>
                    <span class="n">send_multipart_json</span><span class="p">(</span><span class="n">engine_receive_socket</span><span class="p">,</span> <span class="n">idents</span><span class="p">,</span> <span class="n">reply_notify</span><span class="p">)</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Metadata</span>

                    <span class="c1"># Reply immediately with a new jobid</span>
                    <span class="n">metadata_notify</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;jobcounter&#39;</span><span class="p">:</span> <span class="n">jobcounter</span><span class="p">,</span>
                            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                            <span class="s1">&#39;callback_url&#39;</span><span class="p">:</span> <span class="n">callback_url</span><span class="p">,</span>
                            <span class="s1">&#39;callback_method&#39;</span><span class="p">:</span> <span class="n">callback_method</span><span class="p">,</span>
                            <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                            <span class="s1">&#39;times&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;received&#39;</span><span class="p">:</span> <span class="n">received</span><span class="p">,</span>
                                <span class="s1">&#39;started&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;runtime&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;turnaround&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;runtime_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="s1">&#39;turnaround_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">},</span>
                            <span class="s1">&#39;lane&#39;</span><span class="p">:</span> <span class="n">lane</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...notifying collector about job metadata&#39;</span><span class="p">)</span>
                    <span class="c1"># CALLS: collector_notify</span>
                    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">metadata_notify</span><span class="p">)</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Accepted (Metadata Processed)</span>

                    <span class="c1"># We have been accepted, let&#39;s update the global_jobcounter</span>
                    <span class="n">global_jobcounter</span> <span class="o">=</span> <span class="n">jobcounter</span>

                    <span class="c1"># Reply immediately with a new jobid</span>
                    <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;accepted&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...notifying collector about new job&#39;</span><span class="p">)</span>
                    <span class="c1"># CALLS: collector_notify</span>
                    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Queueing on the Engine</span>
                    <span class="k">assert</span> <span class="s1">&#39;jobid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">engine_request</span>
                    <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobid</span>

                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... notifying backend engine to start&#39;</span><span class="p">)</span>
                    <span class="c1"># CALL: engine_</span>
                    <span class="n">engine_send_socket</span> <span class="o">=</span> <span class="n">engine_send_socket_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span>
                    <span class="n">send_multipart_json</span><span class="p">(</span><span class="n">engine_send_socket</span><span class="p">,</span> <span class="n">idents</span><span class="p">,</span> <span class="n">engine_request</span><span class="p">)</span>

                    <span class="c1"># Release</span>
                    <span class="n">idents</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">engine_request</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1">######################################################################</span>
                    <span class="c1"># Status: Queued</span>
                    <span class="n">queued_notify</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;queued&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...notifying collector that job was queued&#39;</span><span class="p">)</span>
                    <span class="c1"># CALLS: collector_notify</span>
                    <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">queued_notify</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Caught ctrl+c in </span><span class="si">%s</span><span class="s1"> queue. Gracefully exiting&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loop_name</span><span class="p">,))</span>

        <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">engine_receive_socket</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">engine_send_socket_dict</span><span class="p">:</span>
            <span class="n">engine_send_socket</span> <span class="o">=</span> <span class="n">engine_send_socket_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span>
            <span class="n">poller</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">engine_send_socket</span><span class="p">)</span>

        <span class="n">engine_receive_socket</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">interface_engine_pull</span><span class="p">)</span>
        <span class="n">engine_receive_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">interface_engine_push_dict</span><span class="p">:</span>
            <span class="n">engine_send_socket</span> <span class="o">=</span> <span class="n">engine_send_socket_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span>
            <span class="n">engine_send_socket</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">interface_engine_push_dict</span><span class="p">[</span><span class="n">lane</span><span class="p">])</span>
            <span class="n">engine_send_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">)</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exiting </span><span class="si">%s</span><span class="s1"> queue&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loop_name</span><span class="p">,))</span></div>


<div class="viewcode-block" id="engine_loop"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.engine_loop">[docs]</a><span class="k">def</span> <span class="nf">engine_loop</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">port_dict</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">containerized</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IBEIS:</span>
<span class="sd">        This will be part of a worker process with its own IBEISController</span>
<span class="sd">        instance.</span>

<span class="sd">        Needs to send where the results will go and then publish the results there.</span>

<span class="sd">    The engine_loop - receives messages, performs some action, and sends a reply,</span>
<span class="sd">    preserving the leading two message parts as routing identities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NAME: engine_</span>
    <span class="c1"># CALLED_FROM: engine_queue</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="c1"># base_print = print  # NOQA</span>
    <span class="nb">print</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;brightgreen&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[engine </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">id_</span><span class="p">)):</span>
        <span class="n">interface_engine_push</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;engine_</span><span class="si">%s</span><span class="s1">_push_url&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="p">,)]</span>
        <span class="n">interface_collect_pull</span> <span class="o">=</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_pull_url&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Initializing </span><span class="si">%s</span><span class="s1"> engine </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">lane</span><span class="p">,</span>
                    <span class="n">id_</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;connect engine_</span><span class="si">%s</span><span class="s1">_push_url = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">lane</span><span class="p">,</span>
                    <span class="n">interface_engine_push</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="n">dbdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">engine_send_sock</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>  <span class="c1"># CHECKED - ROUTER</span>
        <span class="n">engine_send_sock</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span>
            <span class="s1">&#39;engine.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">lane</span><span class="p">,</span>
                <span class="n">id_</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">engine_send_sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">interface_engine_push</span><span class="p">)</span>

        <span class="n">collect_recieve_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span>
            <span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span>
            <span class="s1">&#39;engine.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.collect.DEALER&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">lane</span><span class="p">,</span>
                <span class="n">id_</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;connect collect_pull_url = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;engine is initialized&#39;</span><span class="p">)</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">web</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">update_proctitle</span><span class="p">(</span>
            <span class="s1">&#39;engine_loop.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">lane</span><span class="p">,</span>
                <span class="n">id_</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">dbname</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">idents</span><span class="p">,</span> <span class="n">engine_request</span> <span class="o">=</span> <span class="n">rcv_multipart_json</span><span class="p">(</span><span class="n">engine_send_sock</span><span class="p">,</span> <span class="nb">print</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>

                <span class="n">action</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
                <span class="n">jobid</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>
                <span class="n">callback_url</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;callback_url&#39;</span><span class="p">]</span>
                <span class="n">callback_method</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;callback_method&#39;</span><span class="p">]</span>
                <span class="n">lane_</span> <span class="o">=</span> <span class="n">engine_request</span><span class="p">[</span><span class="s1">&#39;lane&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">jobid = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">action = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">args = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">kwargs = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">lane = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">lane_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lane_</span><span class="p">,))</span>

                <span class="c1"># Notify start working</span>
                <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># &#39;idents&#39;: idents,</span>
                    <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;working&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>

                <span class="n">engine_result</span> <span class="o">=</span> <span class="n">on_engine_request</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="n">exec_status</span> <span class="o">=</span> <span class="n">engine_result</span><span class="p">[</span><span class="s1">&#39;exec_status&#39;</span><span class="p">]</span>

                <span class="c1"># Notify start working</span>
                <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># &#39;idents&#39;: idents,</span>
                    <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;publishing&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>

                <span class="c1"># Store results in the collector</span>
                <span class="n">collect_request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># &#39;idents&#39;: idents,</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                    <span class="s1">&#39;engine_result&#39;</span><span class="p">:</span> <span class="n">engine_result</span><span class="p">,</span>
                    <span class="s1">&#39;callback_url&#39;</span><span class="p">:</span> <span class="n">callback_url</span><span class="p">,</span>
                    <span class="s1">&#39;callback_method&#39;</span><span class="p">:</span> <span class="n">callback_method</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># if VERBOSE_JOBS:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;...done working. pushing result to collector for jobid </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)</span>
                <span class="p">)</span>

                <span class="c1"># CALLS: collector_store</span>
                <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">collect_request</span><span class="p">)</span>

                <span class="c1"># Notify start working</span>
                <span class="n">reply_notify</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># &#39;idents&#39;: idents,</span>
                    <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">exec_status</span><span class="p">,</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">reply_notify</span><span class="p">)</span>

                <span class="c1"># We no longer need the engine result, and can clear it&#39;s memory</span>
                <span class="n">engine_request</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">engine_result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">collect_request</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Caught ctrl+c in engine loop. Gracefully exiting&#39;</span><span class="p">)</span>

        <span class="n">engine_send_sock</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">interface_engine_push</span><span class="p">)</span>
        <span class="n">engine_send_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">interface_collect_pull</span><span class="p">)</span>
        <span class="n">collect_recieve_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Release the IBEIS controller for each job, hopefully freeing memory</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Explicitly try to release GPU memory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">torch</span>

            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Explicitly release Python memory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gc</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ----</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exiting engine loop&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="on_engine_request"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.on_engine_request">[docs]</a><span class="k">def</span> <span class="nf">on_engine_request</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run whenever the engine recieves a message &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">attempts</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>

    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">retry_delay</span> <span class="ow">and</span> <span class="n">retry_delay</span> <span class="o">&lt;=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>

    <span class="c1"># Start working</span>
    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting job=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
    <span class="c1"># Map actions to IBEISController calls here</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;helloworld&#39;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">helloworld</span><span class="p">(</span><span class="n">time_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time_</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;HELLO time_=</span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_</span><span class="p">,))</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">retval</span>

        <span class="n">action_func</span> <span class="o">=</span> <span class="n">helloworld</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check for ibs func</span>
        <span class="n">action_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;resolving action=</span><span class="si">%r</span><span class="s1"> to wbia function=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">action_func</span><span class="p">))</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;__jobid__&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobid</span>
    <span class="n">exec_status</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">exec_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Global max attempts of 10</span>
                <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">action_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1"># success, no exception, break out of the loop</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">attempts</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;JOB </span><span class="si">%r</span><span class="s1"> FAILED (attempt </span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1">)!&#39;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">jobid</span><span class="p">,</span>
                                <span class="n">attempt</span><span class="p">,</span>
                                <span class="n">attempts</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> WAITING </span><span class="si">%d</span><span class="s1"> SECONDS THEN RETRYING&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">retry_delay</span><span class="p">,)</span>
                        <span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
            <span class="n">exec_status</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c1"># Remove __jobid__ from kwargs if it&#39;s not accepted by the action_func</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;unexpected keyword argument &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">key</span>
            <span class="p">):</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">formatex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">],</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">strip_ansi</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">exec_status</span> <span class="o">=</span> <span class="s1">&#39;exception&#39;</span>
    <span class="n">json_result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Clear any used memory</span>
    <span class="n">engine_result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;exec_status&#39;</span><span class="p">:</span> <span class="n">exec_status</span><span class="p">,</span>
        <span class="s1">&#39;json_result&#39;</span><span class="p">:</span> <span class="n">json_result</span><span class="p">,</span>
        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">engine_result</span></div>


<div class="viewcode-block" id="collector_loop"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.collector_loop">[docs]</a><span class="k">def</span> <span class="nf">collector_loop</span><span class="p">(</span><span class="n">port_dict</span><span class="p">,</span> <span class="n">dbdir</span><span class="p">,</span> <span class="n">containerized</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Service that stores completed algorithm results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="nb">print</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[collect] &#39;</span><span class="p">):</span>
        <span class="n">collect_rout_sock</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>  <span class="c1"># CHECK2 - PULL</span>
        <span class="n">collect_rout_sock</span><span class="o">.</span><span class="n">setsockopt_string</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="s1">&#39;collect.ROUTER&#39;</span><span class="p">)</span>
        <span class="n">collect_rout_sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_push_url&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;connect collect_push_url  = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_push_url&#39;</span><span class="p">],)</span>
            <span class="p">)</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">dbdir</span><span class="o">=</span><span class="n">dbdir</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">web</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">update_proctitle</span><span class="p">(</span><span class="s1">&#39;collector_loop&#39;</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>

        <span class="n">shelve_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_shelves_path</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">)</span>

        <span class="n">collector_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># several callers here</span>
                <span class="c1"># CALLER: collector_notify</span>
                <span class="c1"># CALLER: collector_store</span>
                <span class="c1"># CALLER: collector_request_status</span>
                <span class="c1"># CALLER: collector_request_metadata</span>
                <span class="c1"># CALLER: collector_request_result</span>
                <span class="n">idents</span><span class="p">,</span> <span class="n">collect_request</span> <span class="o">=</span> <span class="n">rcv_multipart_json</span><span class="p">(</span>
                    <span class="n">collect_rout_sock</span><span class="p">,</span> <span class="nb">print</span><span class="o">=</span><span class="nb">print</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reply</span> <span class="o">=</span> <span class="n">on_collect_request</span><span class="p">(</span>
                        <span class="n">ibs</span><span class="p">,</span>
                        <span class="n">collect_request</span><span class="p">,</span>
                        <span class="n">collector_data</span><span class="p">,</span>
                        <span class="n">shelve_path</span><span class="p">,</span>
                        <span class="n">containerized</span><span class="o">=</span><span class="n">containerized</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">collect_request</span><span class="p">))</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;ERROR in collection&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">reply</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">send_multipart_json</span><span class="p">(</span><span class="n">collect_rout_sock</span><span class="p">,</span> <span class="n">idents</span><span class="p">,</span> <span class="n">reply</span><span class="p">)</span>

                <span class="n">idents</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">collect_request</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Explicitly release Python memory</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">gc</span>

                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Caught ctrl+c in collector loop. Gracefully exiting&#39;</span><span class="p">)</span>

        <span class="n">collect_rout_sock</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;collect_push_url&#39;</span><span class="p">])</span>
        <span class="n">collect_rout_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exiting collector&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_timestamp</span><span class="p">():</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">TIMESTAMP_TIMEZONE</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">TIMESTAMP_FMTSTR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timestamp</span>


<div class="viewcode-block" id="invalidate_global_cache"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.invalidate_global_cache">[docs]</a><span class="k">def</span> <span class="nf">invalidate_global_cache</span><span class="p">(</span><span class="n">jobid</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">JOB_STATUS_CACHE</span>
    <span class="n">JOB_STATUS_CACHE</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_collector_shelve_filepaths"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.get_collector_shelve_filepaths">[docs]</a><span class="k">def</span> <span class="nf">get_collector_shelve_filepaths</span><span class="p">(</span><span class="n">collector_data</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">shelve_input_filepath</span> <span class="o">=</span> <span class="n">collector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">collector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span></div>


<div class="viewcode-block" id="convert_to_date"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.convert_to_date">[docs]</a><span class="k">def</span> <span class="nf">convert_to_date</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="n">TIMESTAMP_FMTSTR_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TIMESTAMP_FMTSTR</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">timestamp_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">timestamp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_</span><span class="p">,</span> <span class="n">TIMESTAMP_FMTSTR_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timestamp_date</span></div>


<div class="viewcode-block" id="calculate_timedelta"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.calculate_timedelta">[docs]</a><span class="k">def</span> <span class="nf">calculate_timedelta</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">convert_to_date</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">convert_to_date</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span>

    <span class="n">total_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
    <span class="n">total_seconds_</span> <span class="o">=</span> <span class="n">total_seconds</span>

    <span class="n">hours</span> <span class="o">=</span> <span class="n">total_seconds_</span> <span class="o">//</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">total_seconds_</span> <span class="o">-=</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="n">total_seconds_</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="n">total_seconds_</span> <span class="o">-=</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="n">total_seconds_</span>

    <span class="k">return</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">total_seconds</span></div>


<div class="viewcode-block" id="on_collect_request"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.on_collect_request">[docs]</a><span class="k">def</span> <span class="nf">on_collect_request</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">collect_request</span><span class="p">,</span> <span class="n">collector_data</span><span class="p">,</span> <span class="n">shelve_path</span><span class="p">,</span> <span class="n">containerized</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run whenever the collector recieves a message &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">requests</span>

    <span class="n">action</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">reply</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Ensure we have a collector record for the jobid</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collector_data</span><span class="p">:</span>
            <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">runtime_lock_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">runtime_lock_filepath</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">get_collector_shelve_filepaths</span><span class="p">(</span><span class="n">collector_data</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
    <span class="n">collector_shelve_input_filepath</span><span class="p">,</span> <span class="n">collector_shelve_output_filepath</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;notification&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">jobid</span><span class="p">,</span> <span class="n">runtime_lock_filepath</span><span class="p">]</span>

        <span class="c1"># received</span>
        <span class="c1"># accepted</span>
        <span class="c1"># queued</span>
        <span class="c1"># working</span>
        <span class="c1"># publishing</span>
        <span class="c1"># completed</span>
        <span class="c1"># exception</span>
        <span class="c1"># suppressed</span>
        <span class="c1"># corrupted</span>

        <span class="n">current_status</span> <span class="o">=</span> <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Updating jobid = </span><span class="si">%r</span><span class="s1"> status </span><span class="si">%r</span><span class="s1"> -&gt; </span><span class="si">%r</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">jobid</span><span class="p">,</span>
                <span class="n">current_status</span><span class="p">,</span>
                <span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Notify </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]))</span>
        <span class="n">invalidate_global_cache</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">runtime_lock_filepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">runtime_lock_filepath</span><span class="p">):</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">runtime_lock_filepath</span><span class="p">)</span>

            <span class="c1"># Mark the engine request as finished</span>
            <span class="n">record_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobid</span><span class="p">,)</span>
            <span class="n">record_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">shelve_path</span><span class="p">,</span> <span class="n">record_filename</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">record_filepath</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Update relevant times in the shelf</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">collector_shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">times</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_timestamp</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;working&#39;</span><span class="p">:</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;started&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_timestamp</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_timestamp</span><span class="p">()</span>

            <span class="c1"># Calculate runtime</span>
            <span class="n">received</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">started</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">turnaround</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turnaround&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">started</span><span class="p">,</span> <span class="n">completed</span><span class="p">]</span> <span class="ow">and</span> <span class="n">runtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">total_seconds</span> <span class="o">=</span> <span class="n">calculate_timedelta</span><span class="p">(</span>
                    <span class="n">started</span><span class="p">,</span> <span class="n">completed</span>
                <span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">hours</span><span class="p">,</span>
                    <span class="n">minutes</span><span class="p">,</span>
                    <span class="n">seconds</span><span class="p">,</span>
                    <span class="n">total_seconds</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> hours </span><span class="si">%d</span><span class="s1"> min. </span><span class="si">%s</span><span class="s1"> sec. (total: </span><span class="si">%d</span><span class="s1"> sec.)&#39;</span> <span class="o">%</span> <span class="n">args</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;runtime_sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_seconds</span>

            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">received</span><span class="p">,</span> <span class="n">completed</span><span class="p">]</span> <span class="ow">and</span> <span class="n">turnaround</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">total_seconds</span> <span class="o">=</span> <span class="n">calculate_timedelta</span><span class="p">(</span>
                    <span class="n">received</span><span class="p">,</span> <span class="n">completed</span>
                <span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">hours</span><span class="p">,</span>
                    <span class="n">minutes</span><span class="p">,</span>
                    <span class="n">seconds</span><span class="p">,</span>
                    <span class="n">total_seconds</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;turnaround&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> hours </span><span class="si">%d</span><span class="s1"> min. </span><span class="si">%s</span><span class="s1"> sec. (total: </span><span class="si">%d</span><span class="s1"> sec.)&#39;</span> <span class="o">%</span> <span class="n">args</span>
                <span class="n">times</span><span class="p">[</span><span class="s1">&#39;turnaround_sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_seconds</span>

            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times</span>
            <span class="n">set_shelve_value</span><span class="p">(</span><span class="n">collector_shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;register&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">jobid</span><span class="p">]</span>

        <span class="n">invalidate_global_cache</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">get_shelve_filepaths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        <span class="n">engine_result</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">shelve_output_filepath</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="c1"># Ensure we can read the data we expect out of a completed job</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metadata</span><span class="p">,</span> <span class="n">engine_result</span><span class="p">]:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>

        <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">shelve_input_filepath</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">shelve_output_filepath</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Register </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]))</span>

        <span class="n">metadata</span><span class="p">,</span> <span class="n">engine_result</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
        <span class="n">invalidate_global_cache</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="c1"># From the Engine</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">get_shelve_filepaths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
        <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shelve_input_filepath</span>

        <span class="n">set_shelve_value</span><span class="p">(</span><span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stored Metadata </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]))</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;store&#39;</span><span class="p">:</span>
        <span class="n">invalidate_global_cache</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>

        <span class="c1"># From the Engine</span>
        <span class="n">engine_result</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;engine_result&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">callback_url</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_url&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">callback_method</span> <span class="o">=</span> <span class="n">collect_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_method&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Get the engine result jobid</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">engine_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobid&#39;</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">collector_data</span>

        <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">get_shelve_filepaths</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span><span class="p">)</span>
        <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shelve_output_filepath</span>

        <span class="n">set_shelve_value</span><span class="p">(</span><span class="n">shelve_output_filepath</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="n">engine_result</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stored Result </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">]))</span>

        <span class="n">engine_result</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

        <span class="k">if</span> <span class="n">callback_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">containerized</span><span class="p">:</span>
                <span class="n">callback_url</span> <span class="o">=</span> <span class="n">callback_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;://localhost/&#39;</span><span class="p">,</span> <span class="s1">&#39;://wildbook:8080/&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">callback_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">callback_method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span>

            <span class="n">callback_method</span> <span class="o">=</span> <span class="n">callback_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;callback_method </span><span class="si">%r</span><span class="s1"> unsupported&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">callback_method</span><span class="p">,)</span>
            <span class="k">assert</span> <span class="n">callback_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">],</span> <span class="n">message</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">}</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">callback_url</span><span class="p">,</span>
                    <span class="n">callback_method</span><span class="p">,</span>
                    <span class="n">data_dict</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Attempting job completion callback to </span><span class="si">%r</span><span class="se">\n\t</span><span class="s1">HTTP Method: </span><span class="si">%r</span><span class="se">\n\t</span><span class="s1">Data Payload: </span><span class="si">%r</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="n">args</span>
                <span class="p">)</span>

                <span class="c1"># Perform callback</span>
                <span class="k">if</span> <span class="n">callback_method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">callback_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">callback_method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">callback_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">callback_method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">callback_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">()</span>

                <span class="c1"># Check response</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>  <span class="c1"># NOQA</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">text</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Callback completed...</span><span class="se">\n\t</span><span class="s1">Response: </span><span class="si">%r</span><span class="se">\n\t</span><span class="s1">Text: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Callback FAILED!&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;job_status&#39;</span><span class="p">:</span>
        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobstatus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;job_status_dict&#39;</span><span class="p">:</span>
        <span class="n">json_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">collector_data</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">JOB_STATUS_CACHE</span><span class="p">:</span>
                <span class="n">job_status_data</span> <span class="o">=</span> <span class="n">JOB_STATUS_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>

                <span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="n">shelve_output_filepath</span> <span class="o">=</span> <span class="n">get_shelve_filepaths</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">jobid</span>
                <span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>

                <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;corrupted&#39;</span><span class="p">]:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;suppressed&#39;</span><span class="p">]:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;suppressed&#39;</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># status = &#39;pending&#39;</span>
                        <span class="n">cache</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;jobcounter&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>

                <span class="n">times</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">request</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">{})</span>

                <span class="c1"># Support legacy jobs</span>
                <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">job_status_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                    <span class="s1">&#39;jobcounter&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobcounter&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;endpoint&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_received&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_started&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_runtime&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_updated&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_completed&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_turnaround&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turnaround&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_runtime_sec&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runtime_sec&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;time_turnaround_sec&#39;</span><span class="p">:</span> <span class="n">times</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;turnaround_sec&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;lane&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lane&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="n">JOB_STATUS_CACHE</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_status_data</span>

            <span class="n">json_result</span><span class="p">[</span><span class="n">jobid</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_status_data</span>

        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_result</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;job_id_list&#39;</span><span class="p">:</span>
        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;jobid_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">collector_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;job_input&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collector_data</span><span class="p">:</span>
            <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;invalid&#39;</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">collector_shelve_input_filepath</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>

        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;job_result&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collector_data</span><span class="p">:</span>
            <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;invalid&#39;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">collector_data</span><span class="p">[</span><span class="n">jobid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>

            <span class="n">engine_result</span> <span class="o">=</span> <span class="n">get_shelve_value</span><span class="p">(</span><span class="n">collector_shelve_output_filepath</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">engine_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;corrupted&#39;</span><span class="p">]:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;suppressed&#39;</span><span class="p">]:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;suppressed&#39;</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;corrupted&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># status = &#39;pending&#39;</span>
                    <span class="k">pass</span>
                <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">engine_result</span><span class="p">[</span><span class="s1">&#39;exec_status&#39;</span><span class="p">]</span>

                <span class="n">json_result</span> <span class="o">=</span> <span class="n">engine_result</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_result</span><span class="p">)</span>

        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;json_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="n">engine_result</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Release memory</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Other</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...error unknown action=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,))</span>
        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>

    <span class="k">return</span> <span class="n">reply</span></div>


<div class="viewcode-block" id="send_multipart_json"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.send_multipart_json">[docs]</a><span class="k">def</span> <span class="nf">send_multipart_json</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">idents</span><span class="p">,</span> <span class="n">reply</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper &quot;&quot;&quot;</span>
    <span class="n">reply_json</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">multi_reply</span> <span class="o">=</span> <span class="n">idents</span> <span class="o">+</span> <span class="p">[</span><span class="n">reply_json</span><span class="p">]</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">multi_reply</span><span class="p">)</span></div>


<div class="viewcode-block" id="rcv_multipart_json"><a class="viewcode-back" href="../../../wbia.web.html#wbia.web.job_engine.rcv_multipart_json">[docs]</a><span class="k">def</span> <span class="nf">rcv_multipart_json</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">print</span><span class="o">=</span><span class="nb">print</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper &quot;&quot;&quot;</span>
    <span class="c1"># note that the first two parts will be [&#39;Controller.ROUTER&#39;, &#39;Client.&lt;id_&gt;&#39;]</span>
    <span class="c1"># these are needed for the reply to propagate up to the right client</span>
    <span class="n">multi_msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">VERBOSE_JOBS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RCV Json: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">multi_msg</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">),))</span>
    <span class="n">idents</span> <span class="o">=</span> <span class="n">multi_msg</span><span class="p">[:</span><span class="n">num</span><span class="p">]</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">multi_msg</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">multi_msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">idents</span><span class="p">,</span> <span class="n">request</span></div>


<span class="k">def</span> <span class="nf">_on_ctrl_c</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia.zmq] Caught ctrl+c&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia.zmq] sys.exit(0)&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_init_signals</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">signal</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">_on_ctrl_c</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.web.job_engine</span>
<span class="sd">        python -m ibeis.web.job_engine --allexamples</span>
<span class="sd">        python -m ibeis.web.job_engine --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>