
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.plottool.nx_helpers &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.plottool.nx_helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helpers for graph plotting</span>

<span class="sd">References:</span>
<span class="sd">    http://www.graphviz.org/content/attrs</span>
<span class="sd">    http://www.graphviz.org/doc/info/attrs.html</span>

<span class="sd">Ignore:</span>
<span class="sd">    http://www.graphviz.org/pub/graphviz/stable/windows/graphviz-2.38.msi</span>
<span class="sd">    pip uninstall pydot</span>
<span class="sd">    pip uninstall pyparsing</span>
<span class="sd">    pip install -Iv https://pypi.python.org/packages/source/p/pyparsing/pyparsing-1.5.7.tar.gz#md5=9be0fcdcc595199c646ab317c1d9a709</span>
<span class="sd">    pip install pydot</span>
<span class="sd">    sudo apt-get  install libgraphviz4 libgraphviz-dev -y</span>
<span class="sd">    sudo apt-get install libgraphviz-dev</span>
<span class="sd">    pip install pygraphviz</span>
<span class="sd">    sudo pip3 install pygraphviz \</span>
<span class="sd">        --install-option=&quot;--include-path=/usr/include/graphviz&quot; \</span>
<span class="sd">        --install-option=&quot;--library-path=/usr/lib/graphviz/&quot;</span>
<span class="sd">    python -c &quot;import pygraphviz; print(pygraphviz.__file__)&quot;</span>
<span class="sd">    python3 -c &quot;import pygraphviz; print(pygraphviz.__file__)&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">dtool</span> <span class="k">as</span> <span class="n">dt</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

<span class="c1"># from wbia.plottool import colorfuncs</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<span class="n">LARGE_GRAPH</span> <span class="o">=</span> <span class="mi">100</span>


<div class="viewcode-block" id="dump_nx_ondisk"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.dump_nx_ondisk">[docs]</a><span class="k">def</span> <span class="nf">dump_nx_ondisk</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
    <span class="n">agraph</span> <span class="o">=</span> <span class="n">make_agraph</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="c1"># agraph = nx.nx_agraph.to_agraph(graph)</span>
    <span class="n">agraph</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">)</span>
    <span class="n">agraph</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="n">fpath</span><span class="p">))</span></div>


<div class="viewcode-block" id="ensure_nonhex_color"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.ensure_nonhex_color">[docs]</a><span class="k">def</span> <span class="nf">ensure_nonhex_color</span><span class="p">(</span><span class="n">orig_color</span><span class="p">):</span>
    <span class="c1"># TODO: move to ensure color</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig_color</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="n">hex_color</span> <span class="o">=</span> <span class="n">orig_color</span>
        <span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>

        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">hex2color</span><span class="p">(</span><span class="n">hex_color</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hex_color</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">alpha_hex</span> <span class="o">=</span> <span class="n">hex_color</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
            <span class="n">alpha_float</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha_hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_float</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">orig_color</span>
    <span class="k">return</span> <span class="n">color</span></div>


<div class="viewcode-block" id="show_nx"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.show_nx">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">show_nx</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;agraph&#39;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">img_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layoutkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        graph (networkx.Graph):</span>
<span class="sd">        with_labels (bool): (default = True)</span>
<span class="sd">        fnum (int): figure number(default = None)</span>
<span class="sd">        pnum (tuple): plot number(default = None)</span>
<span class="sd">        layout (str): (default = &#39;agraph&#39;)</span>
<span class="sd">        ax (None): (default = None)</span>
<span class="sd">        pos (None): (default = None)</span>
<span class="sd">        img_dict (dict): (default = None)</span>
<span class="sd">        title (str):  (default = None)</span>
<span class="sd">        layoutkw (None): (default = None)</span>
<span class="sd">        verbose (bool):  verbosity flag(default = None)</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        use_image, framewidth, modify_ax, as_directed, hacknoedge, hacknode,</span>
<span class="sd">        arrow_width, fontsize, fontweight, fontname, fontfamilty,</span>
<span class="sd">        fontproperties</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.plottool.nx_helpers show_nx --show</span>
<span class="sd">        python -m dtool --tf DependencyCache.make_graph --show</span>
<span class="sd">        python -m wbia.scripts.specialdraw double_depcache_graph --show --testmode</span>
<span class="sd">        python -m vtool.clustering2 unsupervised_multicut_labeling --show</span>


<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pygraphviz)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.plottool.nx_helpers import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import networkx as nx</span>
<span class="sd">        &gt;&gt;&gt; graph = nx.DiGraph()</span>
<span class="sd">        &gt;&gt;&gt; graph.add_nodes_from([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span>
<span class="sd">        &gt;&gt;&gt; graph.add_edges_from({&#39;a&#39;: &#39;b&#39;, &#39;b&#39;: &#39;c&#39;, &#39;b&#39;: &#39;d&#39;, &#39;c&#39;: &#39;d&#39;}.items())</span>
<span class="sd">        &gt;&gt;&gt; nx.set_node_attributes(graph, name=&#39;shape&#39;, values=&#39;rect&#39;)</span>
<span class="sd">        &gt;&gt;&gt; nx.set_node_attributes(graph, name=&#39;image&#39;, values={&#39;a&#39;: ut.grab_test_imgpath(&#39;carl.jpg&#39;)})</span>
<span class="sd">        &gt;&gt;&gt; nx.set_node_attributes(graph, name=&#39;image&#39;, values={&#39;d&#39;: ut.grab_test_imgpath(&#39;lena.png&#39;)})</span>
<span class="sd">        &gt;&gt;&gt; #nx.set_node_attributes(graph, name=&#39;height&#39;, values=100)</span>
<span class="sd">        &gt;&gt;&gt; with_labels = True</span>
<span class="sd">        &gt;&gt;&gt; fnum = None</span>
<span class="sd">        &gt;&gt;&gt; pnum = None</span>
<span class="sd">        &gt;&gt;&gt; e = show_nx(graph, with_labels, fnum, pnum, layout=&#39;agraph&#39;)</span>
<span class="sd">        &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; pt.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">img_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">img_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span>

    <span class="n">use_image</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_image&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting layout&#39;</span><span class="p">)</span>
    <span class="n">layout_info</span> <span class="o">=</span> <span class="n">get_nx_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">layoutkw</span><span class="o">=</span><span class="n">layoutkw</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing graph&#39;</span><span class="p">)</span>
    <span class="c1"># zoom = kwargs.pop(&#39;zoom&#39;, .4)</span>
    <span class="n">framewidth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;framewidth&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">patch_dict</span> <span class="o">=</span> <span class="n">draw_network2</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">layout_info</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">layout_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">patch_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modify_ax&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># axes.facecolor</span>

    <span class="n">node_size</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
    <span class="n">node_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">node_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">node_size</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()))</span>
        <span class="n">half_size_arr</span> <span class="o">=</span> <span class="n">size_arr</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">pos_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">node_pos</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()))</span>
        <span class="c1"># autoscale does not seem to work</span>
        <span class="c1"># ul_pos = pos_arr - half_size_arr</span>
        <span class="c1"># br_pos = pos_arr + half_size_arr</span>
        <span class="c1"># hack because edges are cut off.</span>
        <span class="c1"># need to take into account extent of edges as well</span>
        <span class="n">ul_pos</span> <span class="o">=</span> <span class="n">pos_arr</span> <span class="o">-</span> <span class="n">half_size_arr</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">br_pos</span> <span class="o">=</span> <span class="n">pos_arr</span> <span class="o">+</span> <span class="n">half_size_arr</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">ul_pos</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">br_pos</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="c1"># pt.plt.axis(&#39;off&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="k">if</span> <span class="n">use_image</span> <span class="ow">and</span> <span class="n">img_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing images&#39;</span><span class="p">)</span>
        <span class="n">node_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">img_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">node_pos</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>
        <span class="n">img_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">img_dict</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>
        <span class="n">size_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">node_size</span><span class="p">,</span> <span class="n">node_list</span><span class="p">)</span>
        <span class="c1"># color_list = ut.dict_take(nx.get_node_attributes(graph, &#39;color&#39;), node_list, None)</span>
        <span class="n">color_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s1">&#39;framecolor&#39;</span><span class="p">),</span> <span class="n">node_list</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">framewidth_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s1">&#39;framewidth&#39;</span><span class="p">),</span> <span class="n">node_list</span><span class="p">,</span> <span class="n">framewidth</span>
        <span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">netx_draw_images_at_positions</span><span class="p">(</span>
            <span class="n">img_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">size_list</span><span class="p">,</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">framewidth_list</span><span class="o">=</span><span class="n">framewidth_list</span>
        <span class="p">)</span>
        <span class="c1"># Hack in older interface</span>
        <span class="n">imgdat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">imgdat</span><span class="p">[</span><span class="s1">&#39;node_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_list</span>
        <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;imgdat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgdat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not drawing images&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">layout_info</span></div>


<div class="viewcode-block" id="netx_draw_images_at_positions"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.netx_draw_images_at_positions">[docs]</a><span class="k">def</span> <span class="nf">netx_draw_images_at_positions</span><span class="p">(</span>
    <span class="n">img_list</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">size_list</span><span class="p">,</span> <span class="n">color_list</span><span class="p">,</span> <span class="n">framewidth_list</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overlays images on a networkx graph</span>

<span class="sd">    References:</span>
<span class="sd">        https://gist.github.com/shobhit/3236373</span>
<span class="sd">        http://matplotlib.org/examples/pylab_examples/demo_annotation_box.html</span>
<span class="sd">        http://stackoverflow.com/questions/11487797/mpl-overlay-small-image</span>
<span class="sd">        http://matplotlib.org/api/text_api.html</span>
<span class="sd">        http://matplotlib.org/api/offsetbox_api.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="c1"># Ensure all images have been read</span>
    <span class="n">img_list_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">convert_colorspace</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">img</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">img_list</span>
    <span class="p">]</span>
    <span class="n">size_list_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">get_size</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">size</span>
        <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">size_list</span><span class="p">,</span> <span class="n">img_list</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pos_list</span><span class="p">,</span> <span class="n">img_list_</span><span class="p">,</span> <span class="n">size_list_</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">bbox_from_center_wh</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">extent_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_html_graphviz_attrs"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.parse_html_graphviz_attrs">[docs]</a><span class="k">def</span> <span class="nf">parse_html_graphviz_attrs</span><span class="p">():</span>
    <span class="c1"># Parse the documentation table</span>
    <span class="kn">import</span> <span class="nn">bs4</span>
    <span class="kn">import</span> <span class="nn">requests</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;http://www.graphviz.org/doc/info/attrs.html&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;html5lib&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">descendants</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;th&#39;</span><span class="p">)]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">td</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>

    <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1"># Find valid progs that can be used</span>
    <span class="n">all_progs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">full_df</span><span class="p">[</span><span class="s1">&#39;Notes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; only&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;not &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">all_progs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
    <span class="n">all_progs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_progs</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">}</span>

    <span class="c1"># Find which progs are supported by which rows</span>
    <span class="n">supported_progs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">full_df</span><span class="p">[</span><span class="s1">&#39;Notes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; only&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;not &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;only&#39;</span><span class="p">):</span>
            <span class="n">only</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
            <span class="n">supported_progs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">only</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;not&#39;</span><span class="p">):</span>
            <span class="n">noneof</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
            <span class="n">supported_progs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_progs</span> <span class="o">-</span> <span class="n">noneof</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">supported_progs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_progs</span><span class="p">)</span>

    <span class="c1"># Find subset that supports dot or neato</span>
    <span class="n">dot_or_neato</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">({</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="s1">&#39;neato&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">supported_progs</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">full_df</span><span class="p">[</span><span class="n">dot_or_neato</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">full_df</span>

    <span class="n">neato_</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">({</span><span class="s1">&#39;neato&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">supported_progs</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">full_df</span>

    <span class="c1"># types are:</span>
    <span class="c1"># edges, nodes, the root graph, subgraphs and cluster subgraphs</span>
    <span class="n">typed_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">}:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Used By&#39;</span><span class="p">]]</span>
        <span class="n">typed_keys</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">format_single_paragraph_sentences</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">typed_keys</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">])))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">full_df</span><span class="p">[</span><span class="n">neato_</span><span class="p">]</span>
    <span class="n">neato_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">}:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Used By&#39;</span><span class="p">]]</span>
        <span class="n">neato_keys</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">flags</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">format_single_paragraph_sentences</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">neato_keys</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">])))</span></div>


<div class="viewcode-block" id="GRAPHVIZ_KEYS"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.GRAPHVIZ_KEYS">[docs]</a><span class="k">class</span> <span class="nc">GRAPHVIZ_KEYS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># NOQA</span>
    <span class="n">N</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;URL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;area&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="p">,</span>
        <span class="s1">&#39;colorscheme&#39;</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;distortion&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fillcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fixedsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontname&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gradientangle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="p">,</span>
        <span class="s1">&#39;href&#39;</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;image&#39;</span><span class="p">,</span>
        <span class="s1">&#39;imagepos&#39;</span><span class="p">,</span>
        <span class="s1">&#39;imagescale&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelloc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;margin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nojustify&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ordering&#39;</span><span class="p">,</span>
        <span class="s1">&#39;orientation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;penwidth&#39;</span><span class="p">,</span>
        <span class="s1">&#39;peripheries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pos&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rects&#39;</span><span class="p">,</span>
        <span class="s1">&#39;regular&#39;</span><span class="p">,</span>
        <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;samplepoints&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shape&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shapefile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;showboxes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sides&#39;</span><span class="p">,</span>
        <span class="s1">&#39;skew&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sortv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;style&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;vertices&#39;</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xlabel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xlp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;z&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">E</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;URL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;arrowhead&#39;</span><span class="p">,</span>
        <span class="s1">&#39;arrowsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;arrowtail&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="p">,</span>
        <span class="s1">&#39;colorscheme&#39;</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;constraint&#39;</span><span class="p">,</span>
        <span class="s1">&#39;decorate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgeURL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgehref&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgetarget&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgetooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fillcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontname&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headURL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;head_lp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headclip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headhref&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headlabel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headport&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headtarget&#39;</span><span class="p">,</span>
        <span class="s1">&#39;headtooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;href&#39;</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelURL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelangle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labeldistance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelfloat&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelfontcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelfontname&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelfontsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelhref&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labeltarget&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labeltooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;len&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lhead&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ltail&#39;</span><span class="p">,</span>
        <span class="s1">&#39;minlen&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nojustify&#39;</span><span class="p">,</span>
        <span class="s1">&#39;penwidth&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pos&#39;</span><span class="p">,</span>
        <span class="s1">&#39;samehead&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sametail&#39;</span><span class="p">,</span>
        <span class="s1">&#39;showboxes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;style&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailURL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tail_lp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailclip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailhref&#39;</span><span class="p">,</span>
        <span class="s1">&#39;taillabel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailport&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailtarget&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tailtooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tooltip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xlabel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xlp&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">G</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Damping&#39;</span><span class="p">,</span>
        <span class="s1">&#39;K&#39;</span><span class="p">,</span>
        <span class="s1">&#39;URL&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_background&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bgcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;center&#39;</span><span class="p">,</span>
        <span class="s1">&#39;charset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;clusterrank&#39;</span><span class="p">,</span>
        <span class="s1">&#39;colorscheme&#39;</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;compound&#39;</span><span class="p">,</span>
        <span class="s1">&#39;concentrate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;defaultdist&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dim&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dimen&#39;</span><span class="p">,</span>
        <span class="s1">&#39;diredgeconstraints&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dpi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;epsilon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;esep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontcolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontname&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontnames&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontpath&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;forcelabels&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gradientangle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;href&#39;</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;imagepath&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inputscale&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label_scheme&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labeljust&#39;</span><span class="p">,</span>
        <span class="s1">&#39;labelloc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;landscape&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layerlistsep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layerselect&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layersep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;layout&#39;</span><span class="p">,</span>
        <span class="s1">&#39;levels&#39;</span><span class="p">,</span>
        <span class="s1">&#39;levelsgap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lheight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lwidth&#39;</span><span class="p">,</span>
        <span class="s1">&#39;margin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxiter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mclimit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mindist&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;model&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mosek&#39;</span><span class="p">,</span>
        <span class="s1">&#39;newrank&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nodesep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nojustify&#39;</span><span class="p">,</span>
        <span class="s1">&#39;normalize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;notranslate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nslimit</span><span class="se">\n</span><span class="s1">nslimit1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ordering&#39;</span><span class="p">,</span>
        <span class="s1">&#39;orientation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;outputorder&#39;</span><span class="p">,</span>
        <span class="s1">&#39;overlap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;overlap_scaling&#39;</span><span class="p">,</span>
        <span class="s1">&#39;overlap_shrink&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pack&#39;</span><span class="p">,</span>
        <span class="s1">&#39;packmode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pad&#39;</span><span class="p">,</span>
        <span class="s1">&#39;page&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pagedir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;quadtree&#39;</span><span class="p">,</span>
        <span class="s1">&#39;quantum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rankdir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ranksep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
        <span class="s1">&#39;remincross&#39;</span><span class="p">,</span>
        <span class="s1">&#39;repulsiveforce&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resolution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rotate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rotation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scale&#39;</span><span class="p">,</span>
        <span class="s1">&#39;searchsize&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sep&#39;</span><span class="p">,</span>
        <span class="s1">&#39;showboxes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">,</span>
        <span class="s1">&#39;smoothing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sortv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;splines&#39;</span><span class="p">,</span>
        <span class="s1">&#39;start&#39;</span><span class="p">,</span>
        <span class="s1">&#39;style&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stylesheet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="s1">&#39;truecolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;viewport&#39;</span><span class="p">,</span>
        <span class="s1">&#39;voro_margin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xdotversion&#39;</span><span class="p">,</span>
    <span class="p">}</span></div>


<span class="k">try</span><span class="p">:</span>

<div class="viewcode-block" id="GraphVizLayoutConfig"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.GraphVizLayoutConfig">[docs]</a>    <span class="k">class</span> <span class="nc">GraphVizLayoutConfig</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            Node Props:</span>
<span class="sd">                colorscheme    CEGN           string                NaN</span>
<span class="sd">                  fontcolor    CEGN            color                NaN</span>
<span class="sd">                   fontname    CEGN           string                NaN</span>
<span class="sd">                   fontsize    CEGN           double                NaN</span>
<span class="sd">                      label    CEGN        lblString                NaN</span>
<span class="sd">                  nojustify    CEGN             bool                NaN</span>
<span class="sd">                      style    CEGN            style                NaN</span>
<span class="sd">                      color     CEN   colorcolorList                NaN</span>
<span class="sd">                  fillcolor     CEN   colorcolorList                NaN</span>
<span class="sd">                      layer     CEN       layerRange                NaN</span>
<span class="sd">                   penwidth     CEN           double                NaN</span>
<span class="sd">               radientangle     CGN              int                NaN</span>
<span class="sd">                   labelloc     CGN           string                NaN</span>
<span class="sd">                     margin     CGN      doublepoint                NaN</span>
<span class="sd">                      sortv     CGN              int                NaN</span>
<span class="sd">                peripheries      CN              int                NaN</span>
<span class="sd">                  showboxes     EGN              int           dot only</span>
<span class="sd">                    comment     EGN           string                NaN</span>
<span class="sd">                        pos      EN  pointsplineType                NaN</span>
<span class="sd">                     xlabel      EN        lblString                NaN</span>
<span class="sd">                   ordering      GN           string           dot only</span>
<span class="sd">                      group       N           string           dot only</span>
<span class="sd">                        pin       N             bool   fdp | neato only</span>
<span class="sd">                 distortion       N           double                NaN</span>
<span class="sd">                  fixedsize       N       boolstring                NaN</span>
<span class="sd">                     height       N           double                NaN</span>
<span class="sd">                      image       N           string                NaN</span>
<span class="sd">                 imagescale       N       boolstring                NaN</span>
<span class="sd">                orientation       N           double                NaN</span>
<span class="sd">                    regular       N             bool                NaN</span>
<span class="sd">               samplepoints       N              int                NaN</span>
<span class="sd">                      shape       N            shape                NaN</span>
<span class="sd">                  shapefile       N           string                NaN</span>
<span class="sd">                      sides       N              int                NaN</span>
<span class="sd">                       skew       N           double                NaN</span>
<span class="sd">                      width       N           double                NaN</span>
<span class="sd">                          z       N           double                NaN</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: make a gridsearchable config for layouts</span>
<div class="viewcode-block" id="GraphVizLayoutConfig.get_param_info_list"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.GraphVizLayoutConfig.get_param_info_list">[docs]</a>        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">get_param_info_list</span><span class="p">():</span>
            <span class="n">param_info_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># GENERAL</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
                    <span class="s1">&#39;splines&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                    <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;line&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;polyline&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;curved&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;ortho&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;pack&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;packmode&#39;</span><span class="p">,</span> <span class="s1">&#39;cluster&#39;</span><span class="p">),</span>
                <span class="c1"># ut.ParamInfo(&#39;nodesep&#39;, ?),</span>
                <span class="c1"># NOT DOT</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
                    <span class="s1">&#39;overlap&#39;</span><span class="p">,</span> <span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="s1">&#39;ipsep&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;sep&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;esep&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span>  <span class="c1"># stricly  less than sep</span>
                <span class="c1"># NEATO ONLY</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;heir&#39;</span><span class="p">,</span> <span class="s1">&#39;KK&#39;</span><span class="p">,</span> <span class="s1">&#39;ipsep&#39;</span><span class="p">]),</span>
                <span class="c1"># kwargs[&#39;diredgeconstraints&#39;] = &#39;heir&#39;</span>
                <span class="c1"># kwargs[&#39;inputscale&#39;] = kwargs.get(&#39;inputscale&#39;, 72)</span>
                <span class="c1"># kwargs[&#39;Damping&#39;] = kwargs.get(&#39;Damping&#39;, .1)</span>
                <span class="c1"># DOT ONLY</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;rankdir&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;RL&#39;</span><span class="p">,</span> <span class="s1">&#39;TB&#39;</span><span class="p">,</span> <span class="s1">&#39;BT&#39;</span><span class="p">]),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;ranksep&#39;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;nodesep&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;clusterrank&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">])</span>
                <span class="c1"># OUTPUT ONLY</span>
                <span class="c1"># kwargs[&#39;dpi&#39;] = kwargs.get(&#39;dpi&#39;, 1.0)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">param_info_list</span></div></div>


<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="get_explicit_graph"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.get_explicit_graph">[docs]</a><span class="k">def</span> <span class="nf">get_explicit_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        graph (nx.Graph)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="k">def</span> <span class="nf">get_nx_base</span><span class="p">(</span><span class="n">graph</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">):</span>
            <span class="n">base_class</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiGraph</span><span class="p">):</span>
            <span class="n">base_class</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiGraph</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">):</span>
            <span class="n">base_class</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>
            <span class="n">base_class</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">base_class</span>

    <span class="n">base_class</span> <span class="o">=</span> <span class="n">get_nx_base</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">explicit_graph</span> <span class="o">=</span> <span class="n">base_class</span><span class="p">()</span>
    <span class="n">explicit_graph</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

    <span class="n">explicit_nodes</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">explicit_edges</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span>
    <span class="p">]</span>
    <span class="n">explicit_graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">explicit_nodes</span><span class="p">)</span>
    <span class="n">explicit_graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">explicit_edges</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">explicit_graph</span></div>


<div class="viewcode-block" id="get_nx_layout"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.get_nx_layout">[docs]</a><span class="k">def</span> <span class="nf">get_nx_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">layoutkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

    <span class="k">if</span> <span class="n">layoutkw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">layoutkw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">layout_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="n">edge_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">,</span>
                <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                <span class="nb">set</span><span class="p">([]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">node_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">,</span>
                <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                <span class="nb">set</span><span class="p">([]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">graph_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">layout_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">graph_keys</span><span class="p">},</span>
            <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">node_keys</span><span class="p">},</span>
            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_edge_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">edge_keys</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># Post checks</span>
        <span class="n">node_info</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">node_info</span> <span class="ow">and</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">node_info</span><span class="p">:</span>
                <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">node</span><span class="p">:</span> <span class="p">(</span><span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">],</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="c1"># node_info[&#39;size&#39;] = list(zip(node_info[&#39;width&#39;],</span>
                <span class="c1">#                             node_info[&#39;height&#39;]))</span>

    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s1">&#39;agraph&#39;</span><span class="p">:</span>
        <span class="c1"># PREFERED LAYOUT WITH MOST CONTROL</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">layout_info</span> <span class="o">=</span> <span class="n">nx_agraph_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">layoutkw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Undefined layout = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layout</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">layout_info</span></div>


<div class="viewcode-block" id="apply_graph_layout_attrs"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.apply_graph_layout_attrs">[docs]</a><span class="k">def</span> <span class="nf">apply_graph_layout_attrs</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">layout_info</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

    <span class="k">def</span> <span class="nf">noneish</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="n">isNone</span> <span class="o">=</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">isNoneStr</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span>
        <span class="k">return</span> <span class="n">isNone</span> <span class="ow">or</span> <span class="n">isNoneStr</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">noneish</span><span class="p">(</span><span class="n">n</span><span class="p">)}</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">noneish</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">graph_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">noneish</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">graph_attrs</span><span class="p">)</span></div>


<div class="viewcode-block" id="patch_pygraphviz"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.patch_pygraphviz">[docs]</a><span class="k">def</span> <span class="nf">patch_pygraphviz</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hacks around a python3 problem in 1.3.1 of pygraphviz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pygraphviz</span>

    <span class="k">if</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">__version__</span> <span class="o">!=</span> <span class="s1">&#39;1.3.1&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pygraphviz</span><span class="o">.</span><span class="n">agraph</span><span class="o">.</span><span class="n">AGraph</span><span class="p">,</span> <span class="s1">&#39;_run_prog_patch&#39;</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_run_prog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;nop&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply graphviz program to graph and return the result as a string.</span>

<span class="sd">        &gt;&gt;&gt; A = AGraph()</span>
<span class="sd">        &gt;&gt;&gt; s = A._run_prog() # doctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; s = A._run_prog(prog=&#39;acyclic&#39;) # doctest: +SKIP</span>

<span class="sd">        Use keyword args to add additional arguments to graphviz programs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pygraphviz.agraph</span> <span class="kn">import</span> <span class="n">shlex</span><span class="p">,</span> <span class="n">subprocess</span><span class="p">,</span> <span class="n">PipeReader</span><span class="p">,</span> <span class="n">warnings</span>

        <span class="n">runprog</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prog</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">runprog</span><span class="p">,</span> <span class="n">args</span><span class="p">])</span>
        <span class="n">dotargs</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">dotargs</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">close_fds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">child_stdin</span><span class="p">,</span> <span class="n">child_stdout</span><span class="p">,</span> <span class="n">child_stderr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># Use threading to avoid blocking</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">PipeReader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">child_stdout</span><span class="p">),</span> <span class="n">PipeReader</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">child_stderr</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">child_stdin</span><span class="p">)</span>
        <span class="n">child_stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Patch error in pygraphviz</span>
    <span class="n">pygraphviz</span><span class="o">.</span><span class="n">agraph</span><span class="o">.</span><span class="n">AGraph</span><span class="o">.</span><span class="n">_run_prog_patch</span> <span class="o">=</span> <span class="n">_run_prog</span>
    <span class="n">pygraphviz</span><span class="o">.</span><span class="n">agraph</span><span class="o">.</span><span class="n">AGraph</span><span class="o">.</span><span class="n">_run_prog_orig</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">agraph</span><span class="o">.</span><span class="n">AGraph</span><span class="o">.</span><span class="n">_run_prog</span>
    <span class="n">pygraphviz</span><span class="o">.</span><span class="n">agraph</span><span class="o">.</span><span class="n">AGraph</span><span class="o">.</span><span class="n">_run_prog</span> <span class="o">=</span> <span class="n">_run_prog</span></div>


<div class="viewcode-block" id="make_agraph"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.make_agraph">[docs]</a><span class="k">def</span> <span class="nf">make_agraph</span><span class="p">(</span><span class="n">graph_</span><span class="p">):</span>
    <span class="c1"># FIXME; make this not an inplace operation</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="kn">import</span> <span class="nn">pygraphviz</span>

    <span class="n">patch_pygraphviz</span><span class="p">()</span>
    <span class="c1"># Convert to agraph format</span>

    <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="n">is_large</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="n">LARGE_GRAPH</span>

    <span class="k">if</span> <span class="n">is_large</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Making agraph for large graph </span><span class="si">%d</span><span class="s1"> nodes. &#39;</span> <span class="s1">&#39;May take time&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_nodes</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">nx_ensure_agraph_color</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="c1"># Reduce size to be in inches not pixels</span>
    <span class="c1"># FIXME: make robust to param settings</span>
    <span class="c1"># Hack to make the w/h of the node take thae max instead of</span>
    <span class="c1"># dot which takes the minimum</span>
    <span class="n">shaped_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">graph_</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
    <span class="n">node_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_node_dict</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="n">node_attrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">node_dict</span><span class="p">,</span> <span class="n">shaped_nodes</span><span class="p">)</span>

    <span class="n">width_px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">node_attrs</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">))</span>
    <span class="n">height_px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">node_attrs</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">))</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take_column</span><span class="p">(</span><span class="n">node_attrs</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>

    <span class="n">inputscale</span> <span class="o">=</span> <span class="mf">72.0</span>
    <span class="n">width_in</span> <span class="o">=</span> <span class="n">width_px</span> <span class="o">/</span> <span class="n">inputscale</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">height_in</span> <span class="o">=</span> <span class="n">height_px</span> <span class="o">/</span> <span class="n">inputscale</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">width_in_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shaped_nodes</span><span class="p">,</span> <span class="n">width_in</span><span class="p">))</span>
    <span class="n">height_in_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shaped_nodes</span><span class="p">,</span> <span class="n">height_in</span><span class="p">))</span>

    <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">width_in_dict</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">height_in_dict</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">nx_delete_node_attr</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>

    <span class="c1"># Check for any nodes with groupids</span>
    <span class="n">node_to_groupid</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="s1">&#39;groupid&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">node_to_groupid</span><span class="p">:</span>
        <span class="n">groupid_to_nodes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">node_to_groupid</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groupid_to_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Initialize agraph format</span>
    <span class="c1"># import utool</span>
    <span class="c1"># utool.embed()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">nx_delete_None_edge_attr</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="n">agraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">nx_agraph</span><span class="o">.</span><span class="n">to_agraph</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="c1"># Add subgraphs labels</span>
    <span class="c1"># TODO: subgraph attrs</span>
    <span class="n">group_attrs</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groupattrs&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">groupid</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">groupid_to_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># subgraph_attrs = {}</span>
        <span class="n">subgraph_attrs</span> <span class="o">=</span> <span class="n">group_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cluster_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># FIXME: make this more natural to specify</span>
        <span class="k">if</span> <span class="s1">&#39;cluster&#39;</span> <span class="ow">in</span> <span class="n">subgraph_attrs</span><span class="p">:</span>
            <span class="n">cluster_flag</span> <span class="o">=</span> <span class="n">subgraph_attrs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">subgraph_attrs</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
        <span class="c1"># subgraph_attrs = dict(rankdir=&#39;LR&#39;)</span>
        <span class="c1"># subgraph_attrs = dict(rankdir=&#39;LR&#39;)</span>
        <span class="c1"># subgraph_attrs[&#39;rank&#39;] = &#39;min&#39;</span>
        <span class="c1"># subgraph_attrs[&#39;rank&#39;] = &#39;source&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">groupid</span>
        <span class="k">if</span> <span class="n">cluster_flag</span><span class="p">:</span>
            <span class="c1"># graphviz treast subgraphs labeld with cluster differently</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;cluster_&#39;</span> <span class="o">+</span> <span class="n">groupid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">groupid</span>
        <span class="n">agraph</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">subgraph_attrs</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">re</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">anode</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="c1"># TODO: Generally fix node positions</span>
        <span class="n">ptstr_</span> <span class="o">=</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ptstr_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptstr_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ptstr_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
            <span class="n">ptstr</span> <span class="o">=</span> <span class="n">ptstr_</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">)</span>
            <span class="n">ptstr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">ptstr</span><span class="p">)]</span>
            <span class="n">pt_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ptstr_list</span><span class="p">))</span>
            <span class="n">pt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">inputscale</span>
            <span class="n">new_ptstr_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pt_arr</span><span class="p">))</span>
            <span class="n">new_ptstr_</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_ptstr_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pin&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
            <span class="k">if</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">new_ptstr</span> <span class="o">=</span> <span class="n">new_ptstr_</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_ptstr</span> <span class="o">=</span> <span class="n">new_ptstr_</span>
            <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ptstr</span>

    <span class="k">if</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignore_labels&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="n">anode</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">return</span> <span class="n">agraph</span></div>


<span class="k">def</span> <span class="nf">_groupby_prelayout</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">layoutkw</span><span class="p">,</span> <span class="n">groupby</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets `pin` attr of `graph_` inplace in order to nodes according to</span>
<span class="sd">    specified layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

    <span class="n">has_pins</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
        <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="s1">&#39;pin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="p">)</span>

    <span class="n">has_pins</span> <span class="o">&amp;=</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">graph_</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_pins</span><span class="p">:</span>
        <span class="c1"># Layout groups separately</span>
        <span class="n">node_to_group</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
        <span class="n">group_to_nodes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invert_dict</span><span class="p">(</span><span class="n">node_to_group</span><span class="p">,</span> <span class="n">unique_vals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subgraph_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">subgraph_grid</span><span class="p">(</span><span class="n">subgraphs</span><span class="p">,</span> <span class="n">hpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vpad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subgraphs</span><span class="p">))))</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">stack_graphs</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">hpad</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">subgraphs</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">new_graph</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">stack_graphs</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">vpad</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_graph</span>

        <span class="n">group_grid</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">group_to_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">group_grid</span><span class="p">:</span>
                <span class="n">subnode_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">graph_</span><span class="o">.</span><span class="n">subgraph</span><span class="p">([</span><span class="n">node</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subnode_list</span><span class="p">:</span>
                    <span class="n">sub</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
                    <span class="n">nx_agraph_layout</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">layoutkw</span><span class="p">)</span>
                <span class="n">subgraph</span> <span class="o">=</span> <span class="n">subgraph_grid</span><span class="p">(</span><span class="n">subnode_list</span><span class="p">)</span>
                <span class="c1"># subgraph = graph_.subgraph(nodes)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subgraph</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">subgraph</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
            <span class="n">nx_agraph_layout</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">layoutkw</span><span class="p">)</span>
            <span class="n">subgraph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subgraph</span><span class="p">)</span>

        <span class="n">hpad</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hpad&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">vpad</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vpad&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">graph_</span> <span class="o">=</span> <span class="n">subgraph_grid</span><span class="p">(</span><span class="n">subgraph_list</span><span class="p">,</span> <span class="n">hpad</span><span class="p">,</span> <span class="n">vpad</span><span class="p">)</span>

        <span class="c1"># graph_ = ut.stack_graphs(subgraph_list)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pin&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">graph_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">graph_</span>
        <span class="c1"># logger.info(&#39;WARNING: GROUPING WOULD CLOBBER PINS. NOT GROUPING&#39;)</span>


<div class="viewcode-block" id="nx_agraph_layout"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.nx_agraph_layout">[docs]</a><span class="k">def</span> <span class="nf">nx_agraph_layout</span><span class="p">(</span>
    <span class="n">orig_graph</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_agraph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">layoutkw</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses graphviz and custom code to determine position attributes of nodes and</span>
<span class="sd">    edges.</span>

<span class="sd">    Args:</span>
<span class="sd">        groupby (str): if not None then nodes will be grouped by this</span>
<span class="sd">            attributes and groups will be layed out separately and then stacked</span>
<span class="sd">            together in a grid</span>

<span class="sd">    Ignore:</span>
<span class="sd">        orig_graph = graph</span>
<span class="sd">        graph = layout_graph</span>

<span class="sd">    References:</span>
<span class="sd">        http://www.graphviz.org/content/attrs</span>
<span class="sd">        http://www.graphviz.org/doc/info/attrs.html</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.plottool.nx_helpers nx_agraph_layout --show</span>

<span class="sd">    Doctest:</span>
<span class="sd">        &gt;&gt;&gt; # FIXME failing-test (22-Jul-2020) This test is failing and it&#39;s not clear how to fix it</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pygraphviz)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.plottool.nx_helpers import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; import networkx as nx</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; n, s = 9, 4</span>
<span class="sd">        &gt;&gt;&gt; offsets = list(range(0, (1 + n) * s, s))</span>
<span class="sd">        &gt;&gt;&gt; node_groups = [ut.lmap(str, range(*o)) for o in ut.itertwo(offsets)]</span>
<span class="sd">        &gt;&gt;&gt; edge_groups = [ut.combinations(nodes, 2) for nodes in node_groups]</span>
<span class="sd">        &gt;&gt;&gt; graph = nx.Graph()</span>
<span class="sd">        &gt;&gt;&gt; [graph.add_nodes_from(nodes) for nodes in node_groups]</span>
<span class="sd">        &gt;&gt;&gt; [graph.add_edges_from(edges) for edges in edge_groups]</span>
<span class="sd">        &gt;&gt;&gt; for count, nodes in enumerate(node_groups):</span>
<span class="sd">        ...     nx.set_node_attributes(graph, name=&#39;id&#39;, values=ut.dzip(nodes, [count]))</span>
<span class="sd">        &gt;&gt;&gt; layoutkw = dict(prog=&#39;neato&#39;)</span>
<span class="sd">        &gt;&gt;&gt; graph1, info1 = nx_agraph_layout(graph.copy(), inplace=True, groupby=&#39;id&#39;, **layoutkw)</span>
<span class="sd">        &gt;&gt;&gt; graph2, info2 = nx_agraph_layout(graph.copy(), inplace=True, **layoutkw)</span>
<span class="sd">        &gt;&gt;&gt; graph3, _ = nx_agraph_layout(graph1.copy(), inplace=True, **layoutkw)</span>
<span class="sd">        &gt;&gt;&gt; nx.set_node_attributes(graph1, name=&#39;pin&#39;, values=&#39;true&#39;)</span>
<span class="sd">        &gt;&gt;&gt; graph4, _ = nx_agraph_layout(graph1.copy(), inplace=True, **layoutkw)</span>
<span class="sd">        &gt;&gt;&gt; if pt.show_was_requested():</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_nx(graph1, layout=&#39;custom&#39;, pnum=(2, 2, 1), fnum=1)</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_nx(graph2, layout=&#39;custom&#39;, pnum=(2, 2, 2), fnum=1)</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_nx(graph3, layout=&#39;custom&#39;, pnum=(2, 2, 3), fnum=1)</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_nx(graph4, layout=&#39;custom&#39;, pnum=(2, 2, 4), fnum=1)</span>
<span class="sd">        &gt;&gt;&gt;     pt.show_if_requested()</span>
<span class="sd">        &gt;&gt;&gt; g1pos = nx.get_node_attributes(graph1, &#39;pos&#39;)[&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; g4pos = nx.get_node_attributes(graph4, &#39;pos&#39;)[&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; g2pos = nx.get_node_attributes(graph2, &#39;pos&#39;)[&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; g3pos = nx.get_node_attributes(graph3, &#39;pos&#39;)[&#39;1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;g1pos = {!r}&#39;.format(g1pos))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;g4pos = {!r}&#39;.format(g4pos))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;g2pos = {!r}&#39;.format(g2pos))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;g3pos = {!r}&#39;.format(g3pos))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(g1pos == g4pos), &#39;points between 1 and 4 were pinned so they should be equal&#39;</span>
<span class="sd">        &gt;&gt;&gt; #assert np.all(g2pos != g3pos), &#39;points between 2 and 3 were not pinned, so they should be different&#39;</span>

<span class="sd">        assert np.all(nx.get_node_attributes(graph1, &#39;pos&#39;)[&#39;1&#39;] == nx.get_node_attributes(graph4, &#39;pos&#39;)[&#39;1&#39;])</span>
<span class="sd">        assert np.all(nx.get_node_attributes(graph2, &#39;pos&#39;)[&#39;1&#39;] == nx.get_node_attributes(graph3, &#39;pos&#39;)[&#39;1&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># import networkx as nx</span>
    <span class="kn">import</span> <span class="nn">pygraphviz</span>

    <span class="c1"># graph_ = get_explicit_graph(orig_graph).copy()</span>
    <span class="n">graph_</span> <span class="o">=</span> <span class="n">get_explicit_graph</span><span class="p">(</span><span class="n">orig_graph</span><span class="p">)</span>

    <span class="c1"># only_explicit = True</span>
    <span class="c1"># if only_explicit:</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>
    <span class="n">is_large</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="n">LARGE_GRAPH</span>

    <span class="c1"># layoutkw = layoutkw.copy()</span>
    <span class="n">draw_implicit</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;draw_implicit&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">pinned_groups</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pinned_groups</span><span class="p">,</span> <span class="n">graph_</span> <span class="o">=</span> <span class="n">_groupby_prelayout</span><span class="p">(</span>
            <span class="n">graph_</span><span class="p">,</span> <span class="n">layoutkw</span><span class="o">=</span><span class="n">layoutkw</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span>
        <span class="p">)</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;prog&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prog</span> <span class="o">!=</span> <span class="s1">&#39;dot&#39;</span><span class="p">:</span>
        <span class="n">layoutkw</span><span class="p">[</span><span class="s1">&#39;overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overlap&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
    <span class="n">layoutkw</span><span class="p">[</span><span class="s1">&#39;splines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splines&#39;</span><span class="p">,</span> <span class="s1">&#39;spline&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prog</span> <span class="o">==</span> <span class="s1">&#39;neato&#39;</span><span class="p">:</span>
        <span class="n">layoutkw</span><span class="p">[</span><span class="s1">&#39;notranslate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>  <span class="c1"># for neato postprocessing</span>

    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">argparts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-G</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="p">[</span><span class="s1">&#39;splines&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># layoutkw is allowed to overwrite graph.graph[&#39;graph&#39;]</span>
        <span class="n">args_kw</span> <span class="o">=</span> <span class="n">graph_</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">GRAPHVIZ_KEYS</span><span class="o">.</span><span class="n">G</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args_kw</span><span class="p">:</span>
                    <span class="n">args_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># del args_kw[&#39;sep&#39;]</span>
        <span class="c1"># del args_kw[&#39;nodesep&#39;]</span>
        <span class="c1"># del args_kw[&#39;overlap&#39;]</span>
        <span class="c1"># del args_kw[&#39;notranslate&#39;]</span>
        <span class="n">argparts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-G</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">args_kw</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">splines</span> <span class="o">=</span> <span class="n">args_kw</span><span class="p">[</span><span class="s1">&#39;splines&#39;</span><span class="p">]</span>

    <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argparts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">is_large</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[nx_agraph_layout] args = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,))</span>
    <span class="c1"># Convert to agraph format</span>

    <span class="n">agraph</span> <span class="o">=</span> <span class="n">make_agraph</span><span class="p">(</span><span class="n">graph_</span><span class="p">)</span>

    <span class="c1"># Run layout</span>
    <span class="c1"># logger.info(&#39;prog = %r&#39; % (prog,))</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;BEFORE LAYOUT</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agraph</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">is_large</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Preforming agraph layout on graph with </span><span class="si">%d</span><span class="s1"> nodes.&#39;</span>
            <span class="s1">&#39;May take time&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_nodes</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># import warnings</span>
    <span class="c1"># warnings.filterwarnings(&quot;error&quot;)</span>
    <span class="c1"># import warnings</span>
    <span class="c1"># flag = False</span>

    <span class="c1"># for node in graph_.nodes():</span>
    <span class="c1">#    anode = pygraphviz.Node(agraph, node)</span>
    <span class="c1">#    ptstr_ = anode.attr[&#39;pos&#39;]</span>
    <span class="c1">#    logger.info(&#39;ptstr_ = %r&#39; % (ptstr_,))</span>

    <span class="c1"># FIXME; This spits out warnings on weird color input</span>
    <span class="c1"># import warnings</span>
    <span class="c1"># with warnings.catch_warnings(record=True):</span>
    <span class="c1">#     # warnings.filterwarnings(&#39;error&#39;)</span>
    <span class="c1">#     warnings.filterwarnings(&#39;ignore&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">agraph</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># import utool</span>
        <span class="c1"># utool.embed()</span>
        <span class="k">raise</span>
    <span class="c1"># except RuntimeWarning as ex:</span>
    <span class="c1">#    ut.printex(ex, iswarning=True)</span>
    <span class="c1">#    flag = True</span>
    <span class="c1"># if flag:</span>
    <span class="c1">#    import utool</span>
    <span class="c1">#    utool.embed()</span>

    <span class="k">if</span> <span class="n">is_large</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished agraph layout.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">test_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/test_graphviz_draw.png&#39;</span><span class="p">)</span>
        <span class="n">agraph</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">test_fpath</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">test_fpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AFTER LAYOUT</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agraph</span><span class="p">))</span>

    <span class="c1"># TODO: just replace with a single dict of attributes</span>
    <span class="n">node_layout_attrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">edge_layout_attrs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># for node in agraph.nodes():</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph_</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">anode</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">node_attrs</span> <span class="o">=</span> <span class="n">parse_anode_layout_attrs</span><span class="p">(</span><span class="n">anode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">node_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">node_layout_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">nx_edges</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="n">aedge</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="o">*</span><span class="n">edge</span><span class="p">)</span>
        <span class="n">edge_attrs</span> <span class="o">=</span> <span class="n">parse_aedge_layout_attrs</span><span class="p">(</span><span class="n">aedge</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">edge_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">edge_layout_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">draw_implicit</span><span class="p">:</span>
        <span class="c1"># ADD IN IMPLICIT EDGES</span>
        <span class="n">layout_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">nx_edges</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">orig_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">nx_edges</span><span class="p">(</span><span class="n">orig_graph</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">implicit_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orig_edges</span> <span class="o">-</span> <span class="n">layout_edges</span><span class="p">)</span>
        <span class="c1"># all_edges = list(set.union(orig_edges, layout_edges))</span>
        <span class="n">needs_implicit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">implicit_edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">needs_implicit</span><span class="p">:</span>
            <span class="c1"># Pin down positions</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">agraph</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                <span class="n">anode</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
                <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;!&#39;</span>

            <span class="c1"># Add new edges to route</span>
            <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="n">implicit_edges</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">orig_graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">iedge</span><span class="p">)</span>
                <span class="n">agraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">iedge</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;BEFORE IMPLICIT LAYOUT</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agraph</span><span class="p">))</span>
            <span class="c1"># Route the implicit edges (must use neato)</span>

            <span class="n">control_node</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;control_node = %r&#39; % (control_node,))</span>
            <span class="n">node1_attr1</span> <span class="o">=</span> <span class="n">parse_anode_layout_attrs</span><span class="p">(</span><span class="n">control_node</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;node1_attr1 = %r&#39; % (node1_attr1,))</span>

            <span class="n">implicit_kw</span> <span class="o">=</span> <span class="n">layoutkw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">implicit_kw</span><span class="p">[</span><span class="s1">&#39;overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
            <span class="c1"># del implicit_kw[&#39;overlap&#39;]  # can cause node positions to change</span>
            <span class="n">argparts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-G</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">implicit_kw</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argparts</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_large</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[nx_agraph_layout] About to draw implicit layout &#39;</span> <span class="s1">&#39;for large graph.&#39;</span>
                <span class="p">)</span>

            <span class="n">agraph</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;neato&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;-n &#39;</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_large</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;[nx_agraph_layout] done with implicit layout for &#39;</span> <span class="s1">&#39;large graph.&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">agraph</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/implicit_test_graphviz_draw.png&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AFTER IMPLICIT LAYOUT</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agraph</span><span class="p">))</span>

            <span class="n">control_node</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;control_node = %r&#39; % (control_node,))</span>
            <span class="n">node1_attr2</span> <span class="o">=</span> <span class="n">parse_anode_layout_attrs</span><span class="p">(</span><span class="n">control_node</span><span class="p">)</span>
            <span class="c1"># logger.info(&#39;node1_attr2 = %r&#39; % (node1_attr2,))</span>

            <span class="c1"># graph positions shifted</span>
            <span class="c1"># This is not the right place to divide by 72</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="n">node1_attr1</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">node1_attr2</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="c1"># logger.info(&#39;translation = %r&#39; % (translation,))</span>
            <span class="c1"># translation = np.array([0, 0])</span>
            <span class="c1"># logger.info(&#39;translation = %r&#39; % (translation,))</span>

            <span class="c1"># for iedge in all_edges:</span>
            <span class="k">for</span> <span class="n">iedge</span> <span class="ow">in</span> <span class="n">implicit_edges</span><span class="p">:</span>
                <span class="n">aedge</span> <span class="o">=</span> <span class="n">pygraphviz</span><span class="o">.</span><span class="n">Edge</span><span class="p">(</span><span class="n">agraph</span><span class="p">,</span> <span class="o">*</span><span class="n">iedge</span><span class="p">)</span>
                <span class="n">iedge_attrs</span> <span class="o">=</span> <span class="n">parse_aedge_layout_attrs</span><span class="p">(</span><span class="n">aedge</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iedge_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">edge_layout_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">iedge</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">pinned_groups</span><span class="p">:</span>
        <span class="c1"># Remove temporary pins put in place by groups</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">nx_delete_node_attr</span><span class="p">(</span><span class="n">graph_</span><span class="p">,</span> <span class="s1">&#39;pin&#39;</span><span class="p">)</span>

    <span class="n">graph_layout_attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">splines</span><span class="o">=</span><span class="n">splines</span><span class="p">)</span>

    <span class="n">layout_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;graph&#39;</span><span class="p">:</span> <span class="n">graph_layout_attrs</span><span class="p">,</span>
        <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">edge_layout_attrs</span><span class="p">),</span>
        <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">node_layout_attrs</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">apply_graph_layout_attrs</span><span class="p">(</span><span class="n">orig_graph</span><span class="p">,</span> <span class="n">layout_info</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">orig_graph</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># FIXME: there is really no point to returning graph unless we actually</span>
        <span class="c1"># modify its attributes</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_</span>
    <span class="k">if</span> <span class="n">return_agraph</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="n">layout_info</span><span class="p">,</span> <span class="n">agraph</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="n">layout_info</span></div>


<div class="viewcode-block" id="parse_point"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.parse_point">[docs]</a><span class="k">def</span> <span class="nf">parse_point</span><span class="p">(</span><span class="n">ptstr</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">ptstr</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">yy</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">xy</span></div>


<div class="viewcode-block" id="parse_anode_layout_attrs"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.parse_anode_layout_attrs">[docs]</a><span class="k">def</span> <span class="nf">parse_anode_layout_attrs</span><span class="p">(</span><span class="n">anode</span><span class="p">):</span>
    <span class="n">node_attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># try:</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">yy</span><span class="p">)))</span>
    <span class="c1"># except Exception:</span>
    <span class="c1">#    xy = np.array((0.0, 0.0))</span>
    <span class="n">adpi</span> <span class="o">=</span> <span class="mf">72.0</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">adpi</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">anode</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">adpi</span>
    <span class="n">node_attrs</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
    <span class="n">node_attrs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">node_attrs</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">node_attrs</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy</span>
    <span class="k">return</span> <span class="n">node_attrs</span></div>


<div class="viewcode-block" id="parse_aedge_layout_attrs"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.parse_aedge_layout_attrs">[docs]</a><span class="k">def</span> <span class="nf">parse_aedge_layout_attrs</span><span class="p">(</span><span class="n">aedge</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse grpahviz splineType</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">translation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">edge_attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">apos</span> <span class="o">=</span> <span class="n">aedge</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
    <span class="c1"># logger.info(&#39;apos = %r&#39; % (apos,))</span>
    <span class="n">end_pt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">start_pt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if &#39;-&#39; in apos:</span>
    <span class="c1">#    import utool</span>
    <span class="c1">#    utool.embed()</span>

    <span class="k">def</span> <span class="nf">safeadd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="n">strpos_list</span> <span class="o">=</span> <span class="n">apos</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">strtup_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">strpos_list</span><span class="p">]</span>

    <span class="n">ctrl_ptstrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">strtup_list</span> <span class="k">if</span> <span class="n">ea</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;es&#39;</span><span class="p">]</span>
    <span class="n">end_ptstrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">strtup_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">ea</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">]</span>
    <span class="n">start_ptstrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">strtup_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">ea</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_ptstrs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_ptstrs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_ptstrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">end_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">end_ptstrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_ptstrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">start_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">start_ptstrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">ctrl_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ea</span><span class="p">])</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">ctrl_ptstrs</span><span class="p">])</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">aedge</span><span class="o">.</span><span class="n">attr</span>
    <span class="n">ctrl_pts</span> <span class="o">=</span> <span class="n">ctrl_pts</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apos</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;ctrl_pts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">ctrl_pts</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;start_pt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">start_pt</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;end_pt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">end_pt</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;lp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">parse_point</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="n">translation</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;headlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headlabel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;taillabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;taillabel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;head_lp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">parse_point</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;head_lp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="n">translation</span><span class="p">)</span>
    <span class="n">edge_attrs</span><span class="p">[</span><span class="s1">&#39;tail_lp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeadd</span><span class="p">(</span><span class="n">parse_point</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tail_lp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="n">translation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">edge_attrs</span></div>


<div class="viewcode-block" id="format_anode_pos"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.format_anode_pos">[docs]</a><span class="k">def</span> <span class="nf">format_anode_pos</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">xy</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">,</span><span class="si">%f%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span> <span class="o">*</span> <span class="n">pin</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_node_size</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">node_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node_size</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="n">node_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_node_dict</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">nattrs</span> <span class="o">=</span> <span class="n">node_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">nattrs</span> <span class="ow">and</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">nattrs</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">nattrs</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">nattrs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="k">elif</span> <span class="s1">&#39;radius&#39;</span> <span class="ow">in</span> <span class="n">nattrs</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">height</span> <span class="o">=</span> <span class="n">nattrs</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">nattrs</span><span class="p">:</span>
            <span class="n">img_fpath</span> <span class="o">=</span> <span class="n">nattrs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">open_image_size</span><span class="p">(</span><span class="n">img_fpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">1100</span> <span class="o">/</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>


<div class="viewcode-block" id="draw_network2"><a class="viewcode-back" href="../../../wbia.plottool.html#wbia.plottool.nx_helpers.draw_network2">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">draw_network2</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">layout_info</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">as_directed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hacknoedge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">hacknode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kwargs:</span>
<span class="sd">        use_image, arrow_width, fontsize, fontweight, fontname, fontfamilty,</span>
<span class="sd">        fontproperties</span>

<span class="sd">    fancy way to draw networkx graphs without directly using networkx</span>

<span class="sd">    # python -m wbia.annotmatch_funcs review_tagged_joins --dpath ~/latex/crall-candidacy-2015/ --save figures4/mergecase.png --figsize=15,15 --clipwhite --diskshow</span>
<span class="sd">    # python -m dtool --tf DependencyCache.make_graph --show</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

    <span class="n">figsize</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--figsize&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">patch_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;patch_frame_dict&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;node_patch_dict&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;edge_patch_dict&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;arrow_patch_list&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="n">text_pseudo_objects</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># TODO: get font properties from nodes as well</span>
    <span class="n">font_prop</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">parse_fontkw</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># logger.info(&#39;font_prop = %r&#39; % (font_prop,))</span>
    <span class="c1"># logger.info(&#39;font_prop.get_name() = %r&#39; % (font_prop.get_name() ,))</span>

    <span class="n">node_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">node_size</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">splines</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splines&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">)</span>
    <span class="c1"># edge_startpoints = layout_info[&#39;edge&#39;][&#39;start_pt&#39;]</span>

    <span class="k">if</span> <span class="n">as_directed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">as_directed</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">is_directed</span><span class="p">()</span>

    <span class="c1"># Draw nodes</span>
    <span class="n">large_graph</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LARGE_GRAPH</span>
    <span class="c1"># for edge, pts in ut.ProgIter(edge_pos.items(), length=len(edge_pos), enabled=large_graph, lbl=&#39;drawing edges&#39;):</span>

    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">nattrs</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="p">),</span>
        <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;drawing nodes&#39;</span><span class="p">,</span>
        <span class="n">enabled</span><span class="o">=</span><span class="n">large_graph</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># shape = nattrs.get(&#39;shape&#39;, &#39;circle&#39;)</span>
        <span class="k">if</span> <span class="n">nattrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nattrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">node_color</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">NEUTRAL_BLUE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_color</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">NEUTRAL_BLUE</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">node_pos</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="n">using_image</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_image&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">nattrs</span>
        <span class="k">if</span> <span class="n">using_image</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hacknode</span><span class="p">:</span>
                <span class="n">alpha_</span> <span class="o">=</span> <span class="mf">0.7</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha_</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="n">node_color</span> <span class="o">=</span> <span class="n">ensure_nonhex_color</span><span class="p">(</span><span class="n">node_color</span><span class="p">)</span>
        <span class="c1"># intcolor = int(node_color.replace(&#39;#&#39;, &#39;0x&#39;), 16)</span>
        <span class="n">node_color</span> <span class="o">=</span> <span class="n">node_color</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">patch_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">node_color</span><span class="p">)</span>
        <span class="n">node_shape</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
            <span class="c1"># divide by 2 seems to work for agraph</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_get_node_size</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_size</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="o">**</span><span class="n">patch_kw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node_shape</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
            <span class="c1"># divide by 2 seems to work for agraph</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_get_node_size</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_size</span><span class="p">))</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Ellipse</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">patch_kw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node_shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;rhombus&#39;</span><span class="p">]:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">_get_node_size</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_size</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">45</span> <span class="k">if</span> <span class="n">node_shape</span> <span class="o">==</span> <span class="s1">&#39;rhombus&#39;</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># Convert xy to center position</span>
            <span class="n">xy_bl</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># rounded = angle == 0</span>
            <span class="n">node_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">nx_node_dict</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
            <span class="n">rounded</span> <span class="o">=</span> <span class="s1">&#39;rounded&#39;</span> <span class="ow">in</span> <span class="n">node_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">isdiag</span> <span class="o">=</span> <span class="s1">&#39;diagonals&#39;</span> <span class="ow">in</span> <span class="n">node_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">patches</span>

            <span class="k">if</span> <span class="n">rounded</span><span class="p">:</span>
                <span class="n">rpad</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="n">xy_bl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_bl</span><span class="p">)</span> <span class="o">+</span> <span class="n">rpad</span>
                <span class="n">width</span> <span class="o">-=</span> <span class="n">rpad</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">height</span> <span class="o">-=</span> <span class="n">rpad</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">boxstyle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">BoxStyle</span><span class="o">.</span><span class="n">Round</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="n">rpad</span><span class="p">)</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">FancyBboxPatch</span><span class="p">(</span>
                    <span class="n">xy_bl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="n">boxstyle</span><span class="p">,</span> <span class="o">**</span><span class="n">patch_kw</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">xy_bl</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">isdiag</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

                    <span class="n">center_xy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">bbox_center</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
                    <span class="n">_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center_xy</span><span class="p">)</span>
                    <span class="n">newverts_</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">_xy</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="n">_xy</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">_xy</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="n">_xy</span> <span class="o">+</span> <span class="p">[</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">]</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">newverts_</span><span class="p">,</span> <span class="o">**</span><span class="n">patch_kw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                        <span class="n">xy_bl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="o">**</span><span class="n">patch_kw</span>
                    <span class="p">)</span>

            <span class="n">patch</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="c1"># if style == &#39;rounded&#39;</span>
        <span class="c1"># elif node_shape in [&#39;roundbox&#39;]:</span>
        <span class="k">elif</span> <span class="n">node_shape</span> <span class="o">==</span> <span class="s1">&#39;stack&#39;</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">_get_node_size</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_size</span><span class="p">)</span>
            <span class="n">xy_bl</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">stackkw</span> <span class="o">=</span> <span class="n">patch_kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stackkw</span><span class="p">[</span><span class="s1">&#39;linewidths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">stackkw</span><span class="p">[</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="c1"># xshift = -width * (.1 / (depth ** (1 / 3))) / 3</span>
            <span class="c1"># yshift = height * (.1 / (depth ** (1 / 3))) / 2</span>
            <span class="c1"># xshift = -width * (.05) / 6</span>
            <span class="c1"># yshift = height * (.05) / 2</span>
            <span class="n">xshift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">200</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="n">yshift</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">stackkw</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xshift</span><span class="p">,</span> <span class="n">yshift</span><span class="p">])</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">cartoon_stacked_rects</span><span class="p">(</span><span class="n">xy_bl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">stackkw</span><span class="p">)</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unknown node_shape=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_shape</span><span class="p">,))</span>

        <span class="n">show_center</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">show_center</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;xr&#39;</span><span class="p">)</span>

        <span class="n">zorder</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zorder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Add a frame around the node</span>
            <span class="n">framewidth</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;framewidth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">framealpha</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;framealpha&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">framealign</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;framealign&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">framewidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">framecolor</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;framecolor&#39;</span><span class="p">,</span> <span class="n">node_color</span><span class="p">)</span>
                <span class="n">framecolor</span> <span class="o">=</span> <span class="n">ensure_nonhex_color</span><span class="p">(</span><span class="n">framecolor</span><span class="p">)</span>

                <span class="c1"># logger.info(&#39;framecolor = %r&#39; % (framecolor,))</span>
                <span class="k">if</span> <span class="n">framecolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">framecolor</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">BLACK</span>
                    <span class="n">framealpha</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">framewidth</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># HACK</span>
                        <span class="n">graphsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
                        <span class="n">framewidth</span> <span class="o">=</span> <span class="n">graphsize</span> <span class="o">/</span> <span class="mi">4</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">framewidth</span> <span class="o">=</span> <span class="mf">3.0</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="n">framewidth</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_bbox</span><span class="p">(</span>
                    <span class="n">bbox</span><span class="p">,</span>
                    <span class="n">bbox_color</span><span class="o">=</span><span class="n">framecolor</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                    <span class="n">align</span><span class="o">=</span><span class="n">framealign</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">framealpha</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="n">zorder</span><span class="p">)</span>
                <span class="c1"># frame.set_zorder()</span>
                <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;patch_frame_dict&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="c1"># import utool</span>
        <span class="c1"># utool.embed()</span>
        <span class="n">picker</span> <span class="o">=</span> <span class="n">nattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;picker&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_picker</span><span class="p">(</span><span class="n">picker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">patch</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="n">zorder</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_plotdat</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;node_data&#39;</span><span class="p">,</span> <span class="n">nattrs</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_plotdat</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># text += &#39;: &#39; + str(label)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;node_labels&#39;</span><span class="p">,</span> <span class="n">hacknode</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">using_image</span><span class="p">):</span>
            <span class="n">text_args</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">),</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_prop</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">text_pseudo_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">text_args</span><span class="p">,</span> <span class="n">zorder</span><span class="p">))</span>
        <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;node_patch_dict&#39;</span><span class="p">][</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span>

    <span class="k">def</span> <span class="nf">get_default_edge_data</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1">###</span>
    <span class="c1"># Draw Edges</span>
    <span class="c1"># NEW WAY OF DRAWING EDGEES</span>
    <span class="n">edge_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ctrl_pts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">n_invis_edge</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">edge_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
            <span class="n">edge_pos</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_pos</span><span class="p">),</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">large_graph</span><span class="p">,</span>
            <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;drawing edges&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_default_edge_data</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;invis&#39;</span><span class="p">:</span>
                <span class="n">n_invis_edge</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">alpha</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">defaultcolor</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">BLACK</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="n">defaultcolor</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">GREEN</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">defaultcolor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">defaultcolor</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">ensure_nonhex_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># layout_info[&#39;edge&#39;][&#39;ctrl_pts&#39;][edge]</span>
            <span class="c1"># layout_info[&#39;edge&#39;][&#39;start_pt&#39;][edge]</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">is_directed</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># color = data.get(&#39;color&#39;, color)[0:3]</span>
            <span class="n">start_point</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
            <span class="n">other_points</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># [0:3]</span>
            <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_point</span><span class="p">]</span> <span class="o">+</span> <span class="n">other_points</span>

            <span class="n">MOVETO</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span>
            <span class="n">LINETO</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span>
            <span class="c1"># STOP = mpl.path.Path.STOP</span>

            <span class="k">if</span> <span class="n">splines</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;polyline&#39;</span><span class="p">,</span> <span class="s1">&#39;ortho&#39;</span><span class="p">]:</span>
                <span class="n">CODE</span> <span class="o">=</span> <span class="n">LINETO</span>
            <span class="k">elif</span> <span class="n">splines</span> <span class="o">==</span> <span class="s1">&#39;curved&#39;</span><span class="p">:</span>
                <span class="c1"># CODE = mpl.path.Path.CURVE3</span>
                <span class="c1"># CODE = mpl.path.Path.CURVE3</span>
                <span class="n">CODE</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">CURVE4</span>
            <span class="k">elif</span> <span class="n">splines</span> <span class="o">==</span> <span class="s1">&#39;spline&#39;</span><span class="p">:</span>
                <span class="n">CODE</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">CURVE4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;splines = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">splines</span><span class="p">,))</span>

            <span class="n">astart_code</span> <span class="o">=</span> <span class="n">MOVETO</span>
            <span class="n">astart_code</span> <span class="o">=</span> <span class="n">MOVETO</span>

            <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_point</span><span class="p">]</span> <span class="o">+</span> <span class="n">other_points</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">astart_code</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">CODE</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_points</span><span class="p">)</span>

            <span class="n">end_pt</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_pt&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># HACK THE ENDPOINTS TO TOUCH THE BOUNDING BOXES</span>
            <span class="k">if</span> <span class="n">end_pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">verts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">end_pt</span><span class="p">]</span>
                <span class="n">codes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">LINETO</span><span class="p">]</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>

            <span class="n">figsize</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--figsize&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># HACK</span>
                <span class="n">graphsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="n">graphsize</span> <span class="o">/</span> <span class="mi">8</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">graphsize</span> <span class="o">/</span> <span class="mi">15</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--arrow-width&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--line-width&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
                <span class="c1"># logger.info(&#39;width = %r&#39; % (width,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

                    <span class="c1"># Compute arrow width using estimated graph size</span>
                    <span class="k">if</span> <span class="n">node_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">xys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">node_pos</span><span class="p">,</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">whs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">node_size</span><span class="p">,</span> <span class="n">node_pos</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">bboxes</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">bbox_from_xywh</span><span class="p">(</span><span class="n">xys</span><span class="p">,</span> <span class="n">whs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
                        <span class="n">extents</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">extent_from_bbox</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span>
                        <span class="n">tl_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">br_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">extents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">tl_pts</span><span class="p">,</span> <span class="n">br_pts</span><span class="p">])</span>
                        <span class="n">extent</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_pointset_extents</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
                        <span class="n">graph_w</span><span class="p">,</span> <span class="n">graph_h</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">bbox_from_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">graph_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">graph_w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">graph_h</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                        <span class="c1"># width = graph_dim * .0005</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="n">graph_dim</span> <span class="o">*</span> <span class="mf">0.005</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">arrow_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arrow_width&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">as_directed</span> <span class="ow">and</span> <span class="n">end_pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">lw</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lw&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="p">))</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="p">)</span>
            <span class="n">hatch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hatch&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># keep track of the linewidth as path effects (like stroke) are</span>
            <span class="c1"># added</span>
            <span class="n">full_lw</span> <span class="o">=</span> <span class="n">lw</span>

            <span class="c1"># effects = data.get(&#39;stroke&#39;, None)</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">patheffects</span>

            <span class="n">path_effects</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">sketch_params</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sketch&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sketch_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sketch_params</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># scale, length, randomness</span>
                    <span class="c1"># sketch_params = (10.0, 128.0, 16.0)</span>
                    <span class="n">sketch_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">128.0</span><span class="p">,</span> <span class="n">randomness</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,)</span>

            <span class="n">stroke_info</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stroke_info</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">stroke_info</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">strokekw</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stroke_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">strokekw</span> <span class="o">=</span> <span class="n">stroke_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># linewidth=3, foreground=&#39;r&#39;</span>
                    <span class="k">assert</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">strokekw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Hack to increase lw</span>
                    <span class="n">full_lw</span> <span class="o">=</span> <span class="n">lw</span> <span class="o">+</span> <span class="n">strokekw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">strokekw</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_lw</span>
                    <span class="n">path_effects</span> <span class="o">+=</span> <span class="p">[</span><span class="n">patheffects</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="o">**</span><span class="n">strokekw</span><span class="p">)]</span>

            <span class="c1"># http://matplotlib.org/1.2.1/examples/api/clippath_demo.html</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shadow&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shadowkw</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shadow&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">shadowkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">shadowkw</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">shadowkw</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">linewidth</span> <span class="o">=</span> <span class="n">shadowkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="n">full_lw</span><span class="p">)</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">shadowkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">shadow_color</span> <span class="o">=</span> <span class="n">shadowkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">shadow_color</span> <span class="o">=</span> <span class="n">shadowkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;shadow_color&#39;</span><span class="p">,</span> <span class="n">shadow_color</span><span class="p">)</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">shadowkw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="n">shadowkw_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
                        <span class="n">shadow_color</span><span class="o">=</span><span class="n">shadow_color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">rho</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">shadowkw_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shadowkw</span><span class="p">)</span>
                    <span class="n">path_effects</span> <span class="o">+=</span> <span class="p">[</span><span class="n">patheffects</span><span class="o">.</span><span class="n">SimpleLineShadow</span><span class="p">(</span><span class="o">**</span><span class="n">shadowkw_</span><span class="p">)]</span>

            <span class="c1"># for vert, code in path.iter_segments():</span>
            <span class="c1">#    logger.info(&#39;code = %r&#39; % (code,))</span>
            <span class="c1">#    logger.info(&#39;vert = %r&#39; % (vert,))</span>
            <span class="c1">#    if code == MOVETO:</span>
            <span class="c1">#        pass</span>

            <span class="c1"># for verts, code in path.cleaned().iter_segments():</span>
            <span class="c1">#    logger.info(&#39;code = %r&#39; % (code,))</span>
            <span class="c1">#    logger.info(&#39;verts = %r&#39; % (verts,))</span>
            <span class="c1">#    pass</span>
            <span class="n">path_effects</span> <span class="o">+=</span> <span class="p">[</span><span class="n">patheffects</span><span class="o">.</span><span class="n">Normal</span><span class="p">()]</span>

            <span class="n">picker</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;picker&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">zorder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zorder&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                <span class="n">path_effects</span><span class="o">=</span><span class="n">path_effects</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">picker</span><span class="o">=</span><span class="n">picker</span><span class="p">,</span>
                <span class="c1"># facecolor=color,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">joinstyle</span><span class="o">=</span><span class="s1">&#39;bevel&#39;</span><span class="p">,</span>
                <span class="n">hatch</span><span class="o">=</span><span class="n">hatch</span><span class="p">,</span>
                <span class="c1"># sketch_params=sketch_params,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sketch_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">patch</span><span class="o">.</span><span class="n">set_sketch_params</span><span class="p">(</span><span class="o">**</span><span class="n">sketch_params</span><span class="p">)</span>

            <span class="n">pt</span><span class="o">.</span><span class="n">set_plotdat</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;edge_data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">set_plotdat</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">as_directed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_pt</span><span class="p">)</span> <span class="o">-</span> <span class="n">other_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">dxy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dxy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="mf">0.1</span>
                    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">dxy</span>
                    <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">end_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">patch1</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">FancyArrow</span><span class="p">(</span>
                        <span class="n">rx</span><span class="p">,</span>
                        <span class="n">ry</span><span class="p">,</span>
                        <span class="n">dx</span><span class="p">,</span>
                        <span class="n">dy</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">,</span>
                        <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">head_starts_at_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">other_points</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">dxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">dxy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dxy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="mf">0.1</span>
                    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">dxy</span>
                    <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">other_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">patch1</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">FancyArrow</span><span class="p">(</span>
                        <span class="n">rx</span><span class="p">,</span>
                        <span class="n">ry</span><span class="p">,</span>
                        <span class="n">dx</span><span class="p">,</span>
                        <span class="n">dy</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">,</span>
                        <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">head_starts_at_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># ax.add_patch(patch1)</span>
                <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;arrow_patch_list&#39;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch1</span>

            <span class="n">taillabel</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;taillabel&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">headlabel</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headlabel&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># hack</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">taillabel</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">taillabel</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">taillabel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headlabel</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">headlabel</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">headlabel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># ha = &#39;left&#39;</span>
            <span class="c1"># ha = &#39;right&#39;</span>
            <span class="n">ha</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
            <span class="n">va</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
            <span class="n">labelcolor</span> <span class="o">=</span> <span class="n">color</span>  <span class="c1"># TODO allow for different colors</span>

            <span class="n">labelcolor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelcolor&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
            <span class="n">labelcolor</span> <span class="o">=</span> <span class="n">ensure_nonhex_color</span><span class="p">(</span><span class="n">labelcolor</span><span class="p">)</span>
            <span class="n">labelcolor</span> <span class="o">=</span> <span class="n">labelcolor</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">taillabel</span><span class="p">:</span>
                <span class="n">taillabel_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">][</span><span class="s1">&#39;tail_lp&#39;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">taillabel</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="n">taillabel_pos</span><span class="p">,</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">labelcolor</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span>
                    <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_prop</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">headlabel</span><span class="p">:</span>
                <span class="n">headlabel_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">][</span><span class="s1">&#39;head_lp&#39;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">headlabel</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="n">headlabel_pos</span><span class="p">,</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">labelcolor</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span>
                    <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_prop</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">label_pos</span> <span class="o">=</span> <span class="n">layout_info</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">][</span><span class="s1">&#39;lp&#39;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="n">label_pos</span><span class="p">,</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">labelcolor</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span>
                    <span class="n">fontproperties</span><span class="o">=</span><span class="n">font_prop</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;edge_patch_dict&#39;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span>

            <span class="c1"># ax.add_patch(patch)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%r</span><span class="s1"> node patches &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;node_patch_dict&#39;</span><span class="p">],)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%r</span><span class="s1"> edge patches &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;edge_patch_dict&#39;</span><span class="p">],)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;n_invis_edge = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_invis_edge</span><span class="p">,))</span>

    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;patch_frame_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">patch1</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;arrow_patch_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch1</span><span class="p">)</span>

    <span class="n">use_collections</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">use_collections</span><span class="p">:</span>
        <span class="n">edge_coll</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PatchCollection</span><span class="p">(</span>
            <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;edge_patch_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">node_coll</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PatchCollection</span><span class="p">(</span>
            <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;node_patch_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># coll.set_facecolor(fcolor)</span>
        <span class="c1"># coll.set_alpha(alpha)</span>
        <span class="c1"># coll.set_linewidth(lw)</span>
        <span class="c1"># coll.set_edgecolor(color)</span>
        <span class="c1"># coll.set_transform(ax.transData)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">node_coll</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">edge_coll</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;node_patch_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PatchCollection</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hacknoedge</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;edge_patch_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">text_args</span><span class="p">,</span> <span class="n">zorder</span> <span class="ow">in</span> <span class="n">text_pseudo_objects</span><span class="p">:</span>
        <span class="n">textobj</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ax_absolute_text</span><span class="p">(</span><span class="o">*</span><span class="n">text_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">text_args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">textobj</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="n">zorder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">patch_dict</span></div>


<span class="c1"># def arrowed_spines(ax=None, arrow_length=20, labels=(&#39;&#39;, &#39;&#39;), arrowprops=None):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     TODO arrow splines not spines</span>
<span class="c1">#     References:</span>
<span class="c1">#         https://gist.github.com/joferkington/3845684</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     xlabel, ylabel = labels</span>
<span class="c1">#     import wbia.plottool as pt</span>
<span class="c1">#     if ax is None:</span>
<span class="c1">#         ax = pt.plt.gca()</span>
<span class="c1">#     if arrowprops is None:</span>
<span class="c1">#         arrowprops = dict(arrowstyle=&#39;&lt;|-&#39;, facecolor=&#39;black&#39;)</span>

<span class="c1">#     for i, spine in enumerate([&#39;left&#39;, &#39;bottom&#39;]):</span>
<span class="c1">#         # Set up the annotation parameters</span>
<span class="c1">#         t = ax.spines[spine].get_transform()</span>
<span class="c1">#         xy, xycoords = [1, 0], (&#39;axes fraction&#39;, t)</span>
<span class="c1">#         xytext, textcoords = [arrow_length, 0], (&#39;offset points&#39;, t)</span>
<span class="c1">#         ha, va = &#39;left&#39;, &#39;bottom&#39;</span>

<span class="c1">#         # If axis is reversed, draw the arrow the other way</span>
<span class="c1">#         top, bottom = ax.spines[spine].axis.get_view_interval()</span>
<span class="c1">#         if top &lt; bottom:</span>
<span class="c1">#             xy[0] = 0</span>
<span class="c1">#             xytext[0] *= -1</span>
<span class="c1">#             ha, va = &#39;right&#39;, &#39;top&#39;</span>

<span class="c1">#         if spine is &#39;bottom&#39;:</span>
<span class="c1">#             xarrow = ax.annotate(xlabel, xy, xycoords=xycoords, xytext=xytext,</span>
<span class="c1">#                                  textcoords=textcoords, ha=ha, va=&#39;center&#39;,</span>
<span class="c1">#                                  arrowprops=arrowprops)</span>
<span class="c1">#         else:</span>
<span class="c1">#             yarrow = ax.annotate(ylabel, xy[::-1], xycoords=xycoords[::-1],</span>
<span class="c1">#                                  xytext=xytext[::-1], textcoords=textcoords[::-1],</span>
<span class="c1">#                                  ha=&#39;center&#39;, va=va, arrowprops=arrowprops)</span>
<span class="c1">#     return xarrow, yarrow</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  <li><a href="../plottool.html">wbia.plottool</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>