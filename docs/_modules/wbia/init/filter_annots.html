
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.init.filter_annots &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.init.filter_annots</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO:</span>
<span class="sd">    * cross validation</span>
<span class="sd">    * encounter vs database (time filtering)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">wbia.control</span> <span class="k">import</span> <span class="n">controller_inject</span>

<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">VERB_TESTDATA</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_verbflag</span><span class="p">(</span><span class="s1">&#39;testdata&#39;</span><span class="p">,</span> <span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="s1">&#39;acfg&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">SEED1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SEED2</span> <span class="o">=</span> <span class="mi">42</span>

<span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
    <span class="n">USE_ACFG_CACHE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--nocache-annot&#39;</span><span class="p">,</span> <span class="s1">&#39;--nocache-aid&#39;</span><span class="p">,</span> <span class="s1">&#39;--nocache&#39;</span><span class="p">))</span>
        <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">USE_CACHE</span>
    <span class="p">)</span>
    <span class="n">USE_ACFG_CACHE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">USE_ACFG_CACHE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_tup</span> <span class="o">=</span> <span class="n">controller_inject</span><span class="o">.</span><span class="n">make_ibs_register_decorator</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="n">_tup</span>


<div class="viewcode-block" id="time_filter_annots"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.time_filter_annots">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">time_filter_annots</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    python -m wbia.init.filter_annots time_filter_annots \</span>
<span class="sd">            --db PZ_Master1 -a ctrl:qmingt=2 --profile</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; result = time_filter_annots()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="n">wbia</span><span class="o">.</span><span class="n">testdata_expanded_aids</span><span class="p">()</span></div>


<div class="viewcode-block" id="filter_annots_general"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.filter_annots_general">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">filter_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  wbia controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>
<span class="sd">        filter_kw (?):</span>

<span class="sd">    KWargs::</span>
<span class="sd">        has_none_annotmatch, any_match_annotmatch, has_all, is_known,</span>
<span class="sd">        any_match_annot, logic_annot, none_match_annotmatch,</span>
<span class="sd">        max_num_annotmatch, any_startswith_annot, has_any, require_quality,</span>
<span class="sd">        species, any_match, view_ext, has_any_annotmatch, view_pername,</span>
<span class="sd">        max_num_annot, min_timedelta, any_startswith, max_numfeat,</span>
<span class="sd">        any_startswith_annotmatch, been_adjusted, any_endswith_annot,</span>
<span class="sd">        require_viewpoint, logic, has_any_annot, min_num_annotmatch, min_num,</span>
<span class="sd">        min_num_annot, has_all_annot, has_none, min_pername,</span>
<span class="sd">        any_endswith_annotmatch, any_endswith, require_timestamp, none_match,</span>
<span class="sd">        contributor_contains, has_all_annotmatch, logic_annotmatch, min_numfeat,</span>
<span class="sd">        none_match_annot, view_ext1, view_ext2, max_num, has_none_annot,</span>
<span class="sd">        minqual, view</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf filter_annots_general</span>
<span class="sd">        python -m wbia --tf filter_annots_general --db PZ_Master1 \</span>
<span class="sd">                --has_any=[needswork,correctable,mildviewpoint] \</span>
<span class="sd">                --has_none=[viewpoint,photobomb,error:viewpoint,quality] --show</span>

<span class="sd">        python -m wbia --tf filter_annots_general --db=GZ_Master1  \</span>
<span class="sd">                --max-numfeat=300 --show --minqual=junk --species=None</span>
<span class="sd">        python -m wbia --tf filter_annots_general --db=lynx \</span>
<span class="sd">                --been_adjusted=True</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = ut.argparse_dict(get_default_annot_filter_form(),</span>
<span class="sd">        &gt;&gt;&gt;                              type_hint=ut.ddict(list, has_any=list,</span>
<span class="sd">        &gt;&gt;&gt;                                                 has_none=list,</span>
<span class="sd">        &gt;&gt;&gt;                                                 logic=str))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;filter_kw = %s&#39; % (ut.repr2(filter_kw),))</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; #filter_kw = dict(is_known=True, min_num=1, has_any=&#39;viewpoint&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #filter_kw = dict(is_known=True, min_num=1, any_match=&#39;.*error.*&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filter_annots_general(ibs, aid_list, filter_kw)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;len(aid_list_) = %r&#39; % (len(aid_list_),))</span>
<span class="sd">        &gt;&gt;&gt; all_tags = ut.flatten(ibs.get_annot_all_tags(aid_list_))</span>
<span class="sd">        &gt;&gt;&gt; filtered_tag_hist = ut.dict_hist(all_tags)</span>
<span class="sd">        &gt;&gt;&gt; ut.print_dict(filtered_tag_hist, key_order_metric=&#39;val&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.print_dict(ibs.get_annot_stats_dict(aid_list_), &#39;annot_stats&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; import wbia.viz.interact</span>
<span class="sd">        &gt;&gt;&gt; wbia.viz.interact.interact_chip.interact_multichips(ibs, aid_list_)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">filter_kw_</span> <span class="o">=</span> <span class="n">get_default_annot_filter_form</span><span class="p">()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">aid_list</span>
    <span class="c1"># filter_kw = ut.merge_dicts(get_default_annot_filter_form(), filter_kw)</span>
    <span class="c1"># TODO MERGE FILTERFLAGS BY TAGS AND FILTERFLAGS INDEPENDANT</span>
    <span class="c1"># aid_list_ = ibs.filterannots_by_tags(aid_list_, filter_kw)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span></div>


<div class="viewcode-block" id="sample_annots_general"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.sample_annots_general">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">sample_annots_general</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_kw</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; filter + sampling &quot;&quot;&quot;</span>
    <span class="c1"># hack</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="k">if</span> <span class="n">aid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">filter_kw_</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">filter_kw_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">SUBINDEX_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">filter_kw_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">SAMPLE_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">filter_kw_</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">aid_list</span>
    <span class="c1"># filter_kw = ut.merge_dicts(get_default_annot_filter_form(), filter_kw)</span>
    <span class="c1"># TODO MERGE FILTERFLAGS BY TAGS AND FILTERFLAGS INDEPENDANT</span>
    <span class="c1"># aid_list_ = ibs.filterannots_by_tags(aid_list_, filter_kw)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list_</span><span class="p">,</span> <span class="n">filter_kw_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span></div>


<div class="viewcode-block" id="get_default_annot_filter_form"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.get_default_annot_filter_form">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">get_default_annot_filter_form</span><span class="p">():</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns dictionary containing defaults for all valid filter parameters</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf get_default_annot_filter_form</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = get_default_annot_filter_form()</span>
<span class="sd">        &gt;&gt;&gt; print(ut.repr2(filter_kw, align=True))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;, &#39;.join(filter_kw.keys()))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="n">iden_defaults</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">filter_kw</span> <span class="o">=</span> <span class="n">iden_defaults</span>
    <span class="c1"># tag_defaults = get_annot_tag_filterflags(</span>
    <span class="c1">#    None, None, {}, request_defaultkw=True)</span>
    <span class="c1"># filter_kw = ut.dict_union3(iden_defaults, tag_defaults, combine_op=None)</span>
    <span class="k">return</span> <span class="n">filter_kw</span></div>


<div class="viewcode-block" id="get_annot_tag_filterflags"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.get_annot_tag_filterflags">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">,</span> <span class="n">request_defaultkw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters annotations by tags including those that is belongs to in a pair</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">tag_funcs</span>

    <span class="c1"># Build Filters</span>
    <span class="n">filter_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_kwargs</span><span class="p">(</span><span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">)</span>

    <span class="n">annotmatch_filterkw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">annot_filterkw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">both_filterkw</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">kwreg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">KWReg</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">request_defaultkw</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filter_keys</span><span class="p">:</span>
        <span class="n">annotmatch_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_annotmatch&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">annot_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_annot&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">both_filterkw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">kwreg</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">request_defaultkw</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kwreg</span><span class="o">.</span><span class="n">defaultkw</span>

    <span class="c1"># Grab Data</span>
    <span class="n">need_annot_tags</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">annot_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">need_annotmatch_tags</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">annotmatch_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">need_both_tags</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">both_filterkw</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="k">if</span> <span class="n">need_annot_tags</span> <span class="ow">or</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">annot_tags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_case_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_annotmatch_tags</span> <span class="ow">or</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">annotmatch_tags_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_annotmatch_tags</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">both_tags_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">,</span>
                <span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">annot_tags_list</span><span class="p">,</span> <span class="n">annotmatch_tags_list</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Filter Data</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">need_annot_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">annot_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">annot_filterkw</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_annotmatch_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span>
            <span class="n">annotmatch_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">annotmatch_filterkw</span>
        <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">need_both_tags</span><span class="p">:</span>
        <span class="n">flags_</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">both_tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">both_filterkw</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">flags_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flags</span></div>


<div class="viewcode-block" id="filterannots_by_tags"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.filterannots_by_tags">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">filterannots_by_tags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  wbia controller object</span>
<span class="sd">        aid_list (list):  list of annotation rowids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf filterannots_by_tags</span>
<span class="sd">        utprof.py -m wbia --tf filterannots_by_tags</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        filter_annotmatch_by_tags</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_Master1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; has_any = ut.get_argval(&#39;--tags&#39;, type_=list,</span>
<span class="sd">        &gt;&gt;&gt;                         default=[&#39;SceneryMatch&#39;, &#39;Photobomb&#39;])</span>
<span class="sd">        &gt;&gt;&gt; min_num = ut.get_argval(&#39;--min_num&#39;, type_=int, default=1)</span>
<span class="sd">        &gt;&gt;&gt; filter_kw = dict(has_any=has_any, min_num=1)</span>
<span class="sd">        &gt;&gt;&gt; aid_list_ = filterannots_by_tags(ibs, aid_list, filter_kw)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;aid_list_ = %r&#39; % (aid_list_,))</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; pass</span>
<span class="sd">        &gt;&gt;&gt; # TODO: show special annot group in GUI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">filter_kw</span><span class="p">)</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid_list_</span></div>


<div class="viewcode-block" id="get_acfg_cacheinfo"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.get_acfg_cacheinfo">[docs]</a><span class="k">def</span> <span class="nf">get_acfg_cacheinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns location and name of the ~~annot~~ data cache</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span>

    <span class="c1"># Make loading aids a big faster for experiments</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">wbia</span>

        <span class="n">repodir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_module_dir</span><span class="p">(</span><span class="n">wbia</span><span class="p">))</span>
        <span class="n">acfg_cachedir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">repodir</span><span class="p">,</span> <span class="s1">&#39;ACFG_CACHE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># acfg_cachedir = &#39;./localdata/ACFG_CACHE&#39;</span>
        <span class="n">acfg_cachedir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(),</span> <span class="s1">&#39;ACFG_CACHE&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">)</span>
    <span class="n">acfg_cachename</span> <span class="o">=</span> <span class="s1">&#39;ACFG_CACHE&#39;</span>

    <span class="n">RESPECT_INTERNAL_CFGS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">RESPECT_INTERNAL_CFGS</span><span class="p">:</span>
        <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">relevant_aidcfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">],</span> <span class="n">ut</span><span class="o">.</span><span class="n">INTERNAL_CFGKEYS</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">],</span> <span class="n">ut</span><span class="o">.</span><span class="n">INTERNAL_CFGKEYS</span><span class="p">)</span>
        <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">relevant_aidcfg</span><span class="p">))</span>
    <span class="n">acfg_cacheinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acfg_cacheinfo</span></div>


<div class="viewcode-block" id="expand_single_acfg"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.expand_single_acfg">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">expand_single_acfg</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for main_helpers &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERB_TESTDATA</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+=== EXPAND_SINGLE_ACFG ===&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39; * acfg = </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">compress_aidcfg</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">),</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+---------------------&#39;</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annotation_set</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">filter_annots_intragroup</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">avail_aids</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L___ EXPAND_SINGLE_ACFG ___&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aids</span></div>


<div class="viewcode-block" id="hack_remove_label_errors"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.hack_remove_label_errors">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">hack_remove_label_errors</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">expanded_aids</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">qaids_</span><span class="p">,</span> <span class="n">daids_</span> <span class="o">=</span> <span class="n">expanded_aids</span>

    <span class="n">partitioned_sets</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">partition_annots_into_corresponding_groups</span><span class="p">(</span><span class="n">qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">partitioned_sets</span>
    <span class="n">query_group</span><span class="p">,</span> <span class="n">data_group</span><span class="p">,</span> <span class="n">unknown_group</span><span class="p">,</span> <span class="n">distract_group</span> <span class="o">=</span> <span class="n">tup</span>

    <span class="n">unknown_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_tag_filterflags</span><span class="p">,</span>
        <span class="n">unknown_group</span><span class="p">,</span>
        <span class="n">filter_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">none_match</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.*error.*&#39;</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="c1"># data_flags  = ibs.unflat_map(</span>
    <span class="c1">#    ibs.get_annot_tag_filterflags, data_group,</span>
    <span class="c1">#    filter_kw=dict(none_match=[&#39;.*error.*&#39;]))</span>
    <span class="n">query_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_tag_filterflags</span><span class="p">,</span>
        <span class="n">query_group</span><span class="p">,</span>
        <span class="n">filter_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">none_match</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.*error.*&#39;</span><span class="p">]),</span>
    <span class="p">)</span>

    <span class="n">query_noterror_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="nb">all</span><span class="p">,</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">list_zipflatten</span><span class="p">(</span>
                <span class="n">query_flags</span><span class="p">,</span>
                <span class="c1"># data_flags,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">unknown_noterror_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="n">unknown_flags</span><span class="p">))</span>

    <span class="n">filtered_queries</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">query_group</span><span class="p">,</span> <span class="n">query_noterror_flags</span><span class="p">))</span>
    <span class="n">filtered_unknown</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">unknown_group</span><span class="p">,</span> <span class="n">unknown_noterror_flags</span><span class="p">))</span>

    <span class="n">filtered_qaids_</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered_queries</span> <span class="o">+</span> <span class="n">filtered_unknown</span><span class="p">)</span>

    <span class="n">expanded_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">filtered_qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">filtered_qaids_</span><span class="p">,</span> <span class="n">daids_</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;L___ HACKED_EXPAND_ACFGS ___&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expanded_aids</span></div>


<div class="viewcode-block" id="hack_extra"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.hack_extra">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">hack_extra</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">expanded_aids</span><span class="p">):</span>
    <span class="c1"># SUCH HACK to get a larger database</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="n">_aidcfg</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">default</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">]</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;min_pername&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;require_viewpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;exclude_reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_aidcfg</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;hack&#39;</span>
    <span class="n">qaids</span> <span class="o">=</span> <span class="n">expanded_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="n">expanded_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">remove_groundtrue_aids</span><span class="p">(</span><span class="n">_extra_aids</span><span class="p">,</span> <span class="p">(</span><span class="n">qaids</span> <span class="o">+</span> <span class="n">daids</span><span class="p">))</span>
    <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">filter_annots_independent</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">_extra_aids</span><span class="p">,</span> <span class="n">_aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="n">_extra_aids</span> <span class="o">=</span> <span class="n">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">_extra_aids</span><span class="p">,</span> <span class="n">_aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="n">daids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span> <span class="o">+</span> <span class="n">_extra_aids</span><span class="p">)</span>
    <span class="n">expanded_aids</span> <span class="o">=</span> <span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expanded_aids</span></div>


<div class="viewcode-block" id="expand_acfgs_consistently"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.expand_acfgs_consistently">[docs]</a><span class="k">def</span> <span class="nf">expand_acfgs_consistently</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">acfg_combo</span><span class="p">,</span> <span class="n">initial_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">0</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expands a set of configurations such that they are comparable</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf parse_acfg_combo_list  \</span>
<span class="sd">                -a varysize</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_Master1 -a varysize</span>
<span class="sd">        #wbia --tf get_annotcfg_list --db lynx -a default:hack_imageset=True</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_Master1 -a varysize:qsize=None</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_Master0 --nofilter-dups  -a varysize</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_MTEST -a varysize --nofilter-dups</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_Master0 --verbtd \</span>
<span class="sd">                --nofilter-dups -a varysize</span>
<span class="sd">        wbia --tf get_annotcfg_list --db PZ_Master1 -a viewpoint_compare \</span>
<span class="sd">                --verbtd --nofilter-dups</span>
<span class="sd">        wbia --tf get_annotcfg_list -a timectrl --db GZ_Master1 --verbtd \</span>
<span class="sd">                --nofilter-dups</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init import main_helpers</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt.experiment_helpers import parse_acfg_combo_list</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #acfg_name_list = [&#39;timectrl:dpername=[1,2]&#39;]</span>
<span class="sd">        &gt;&gt;&gt; acfg_name_list = [&#39;default:crossval_enc=True,require_timestamp=True&#39;]</span>
<span class="sd">        &gt;&gt;&gt; aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; main_helpers.monkeypatch_encounters(ibs, aids, days=50)</span>
<span class="sd">        &gt;&gt;&gt; acfg_combo_list = parse_acfg_combo_list(acfg_name_list)</span>
<span class="sd">        &gt;&gt;&gt; acfg_combo = acfg_combo_list[0]</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = None</span>
<span class="sd">        &gt;&gt;&gt; use_cache = False</span>
<span class="sd">        &gt;&gt;&gt; verbose = False</span>
<span class="sd">        &gt;&gt;&gt; expanded_aids_combo_list = expand_acfgs_consistently(</span>
<span class="sd">        &gt;&gt;&gt;     ibs, acfg_combo, initial_aids=initial_aids, use_cache=use_cache,</span>
<span class="sd">        &gt;&gt;&gt;     verbose=verbose)</span>
<span class="sd">        &gt;&gt;&gt; # Restore state</span>
<span class="sd">        &gt;&gt;&gt; main_helpers.unmonkeypatch_encounters(ibs)</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(len(expanded_aids_combo_list), 5)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERB_TESTDATA</span>
    <span class="c1"># Edit configs so the sample sizes are consistent</span>
    <span class="c1"># FIXME: requiers that smallest configs are specified first</span>
    <span class="k">def</span> <span class="nf">tmpmin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
        <span class="k">elif</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Keep track of seen samples</span>
    <span class="n">min_qsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">min_dsize</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># HACK: Find out the params being varied and disallow those from being</span>
    <span class="c1"># prefiltered due to the lack of heirarchical filters</span>
    <span class="n">nonvaried_dict</span><span class="p">,</span> <span class="n">varied_acfg_list</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">partition_acfg_list</span><span class="p">(</span><span class="n">acfg_combo</span><span class="p">)</span>
    <span class="n">hack_exclude_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">(</span><span class="o">*</span><span class="n">acfg</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="n">varied_acfg_list</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># HACK: determine unconstrained min / max nannots</span>
    <span class="n">acfg_combo_in</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">acfg_combo</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">acfg_combo2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">acfg_combo_in</span><span class="p">)</span>

        <span class="n">unconstrained_expansions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">combox</span><span class="p">,</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acfg_combo2</span><span class="p">):</span>
            <span class="n">qcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">]</span>
            <span class="n">dcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[PRE </span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">combox</span><span class="p">,)):</span>
                <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">expand_acfgs</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span>
                    <span class="n">acfg</span><span class="p">,</span>
                    <span class="n">initial_aids</span><span class="o">=</span><span class="n">initial_aids</span><span class="p">,</span>
                    <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                    <span class="n">hack_exclude_keys</span><span class="o">=</span><span class="n">hack_exclude_keys</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">unconstrained_expansions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">acfg_combo_in</span><span class="p">,</span> <span class="s1">&#39;dcfg&#39;</span><span class="p">),</span> <span class="s1">&#39;force_const_size&#39;</span><span class="p">)):</span>
            <span class="n">unconstrained_lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">unconstrained_expansions</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># max_dlen = unconstrained_lens.T[1].max()</span>
            <span class="n">min_dlen</span> <span class="o">=</span> <span class="n">unconstrained_lens</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="n">acfg_combo_in</span><span class="p">:</span>
                <span class="n">dcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">]</span>
                <span class="c1"># TODO: make sample size annot_sample_size</span>
                <span class="c1"># sample size is #annots</span>
                <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span>
                    <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_dlen</span>

    <span class="n">acfg_combo_out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">combox</span><span class="p">,</span> <span class="n">acfg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acfg_combo_in</span><span class="p">):</span>
        <span class="n">qcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">]</span>
        <span class="n">dcfg</span> <span class="o">=</span> <span class="n">acfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">]</span>

        <span class="c1"># In some cases we may want to clamp these, but others we do not</span>
        <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;force_const_size&#39;</span><span class="p">]:</span>
            <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">],</span> <span class="n">min_qsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;force_const_size&#39;</span><span class="p">]:</span>
            <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">],</span> <span class="n">min_dsize</span><span class="p">)</span>

        <span class="c1"># Expand modified acfgdict</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">combox</span><span class="p">,)):</span>
            <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">expand_acfgs</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span>
                <span class="n">acfg</span><span class="p">,</span>
                <span class="n">initial_aids</span><span class="o">=</span><span class="n">initial_aids</span><span class="p">,</span>
                <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span>
                <span class="n">hack_exclude_keys</span><span class="o">=</span><span class="n">hack_exclude_keys</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># if dcfg.get(&#39;hack_extra&#39;, None):</span>
            <span class="c1">#    assert False</span>
            <span class="c1">#    expanded_aids = hack_extra(ibs, expanded_aids)</span>

            <span class="n">qsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># &lt;hack for float that should not interfere with other hacks</span>
            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qsize</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dsize</span><span class="p">:</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;_orig_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span>
            <span class="c1"># /--&gt;</span>

            <span class="k">if</span> <span class="n">min_qsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsize</span>
            <span class="k">if</span> <span class="n">min_dsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># UNSURE</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsize</span>

            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qsize</span><span class="p">:</span>
                <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;_true_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsize</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dsize</span><span class="p">:</span>
                <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;_true_sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsize</span>

            <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;force_const_size&#39;</span><span class="p">]:</span>
                <span class="n">min_qsize</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">min_qsize</span><span class="p">,</span> <span class="n">qsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;force_const_size&#39;</span><span class="p">]:</span>  <span class="c1"># UNSURE</span>
                <span class="n">min_dsize</span> <span class="o">=</span> <span class="n">tmpmin</span><span class="p">(</span><span class="n">min_dsize</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>

            <span class="c1"># so hacky</span>
            <span class="c1"># this has to be after sample_size assignment, otherwise the filtering</span>
            <span class="c1"># is unstable Remove queries that have labeling errors in them.</span>
            <span class="c1"># TODO: fix errors AND remove labels</span>
            <span class="c1"># remove_label_errors = ut.is_developer() or ut.get_argflag(&#39;--noerrors&#39;)</span>
            <span class="c1"># ut.is_developer() or ut.get_argflag(&#39;--noerrors&#39;)</span>
            <span class="n">remove_label_errors</span> <span class="o">=</span> <span class="n">qcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hackerrors&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_label_errors</span><span class="p">:</span>
                <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">hack_remove_label_errors</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">expanded_aids</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;crossval_enc&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;crossval_enc&#39;</span><span class="p">]:</span>
            <span class="c1"># Hack, just use qaids for cross validated sampleing</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">expanded_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">qenc_per_name</span> <span class="o">=</span> <span class="n">qcfg</span><span class="p">[</span><span class="s1">&#39;crossval_enc&#39;</span><span class="p">]</span>
            <span class="n">denc_per_name</span> <span class="o">=</span> <span class="n">dcfg</span><span class="p">[</span><span class="s1">&#39;crossval_enc&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">qenc_per_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">qenc_per_name</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">denc_per_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">denc_per_name</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">crossval_expansion</span> <span class="o">=</span> <span class="n">encounter_crossval</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">qenc_per_name</span><span class="o">=</span><span class="n">qenc_per_name</span><span class="p">,</span> <span class="n">denc_per_name</span><span class="o">=</span><span class="n">denc_per_name</span>
            <span class="p">)</span>

            <span class="kn">import</span> <span class="nn">uuid</span>

            <span class="n">unique_joinme</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">aid_pairs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">crossval_expansion</span><span class="p">):</span>
                <span class="n">acfg_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">acfg</span><span class="p">)</span>
                <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;crossval_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">][</span><span class="s1">&#39;crossval_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">][</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># FIMXE: needs to be different for all acfgs</span>
                <span class="c1"># out of this sample.</span>
                <span class="k">if</span> <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;joinme&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;joinme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_joinme</span>
                    <span class="n">acfg_out</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">][</span><span class="s1">&#39;joinme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_joinme</span>
                <span class="c1"># need further hacks to assign sample size correctly</span>
                <span class="c1"># after the crossval hack</span>
                <span class="n">acfg_combo_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acfg_out</span><span class="p">)</span>
            <span class="n">expanded_aids_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">crossval_expansion</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">acfg_combo_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acfg</span><span class="p">)</span>
            <span class="c1"># ibs.print_annotconfig_stats(*expanded_aids)</span>
            <span class="n">expanded_aids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expanded_aids</span><span class="p">)</span>

    <span class="c1"># Sample afterwords</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">acfg_combo_out</span><span class="p">,</span> <span class="n">expanded_aids_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="crossval_helper"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.crossval_helper">[docs]</a><span class="k">def</span> <span class="nf">crossval_helper</span><span class="p">(</span>
    <span class="n">nid_to_sample_pool</span><span class="p">,</span>
    <span class="n">perquery</span><span class="p">,</span>
    <span class="n">perdatab</span><span class="p">,</span>
    <span class="n">n_need</span><span class="p">,</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rebalance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    does sampling based on some grouping (or no grouping) of annots</span>

<span class="sd">    perquery = 2</span>
<span class="sd">    perdatab = 2</span>

<span class="sd">    nid_to_sample_pool = {</span>
<span class="sd">        1: [1, 2, 3, 4],</span>
<span class="sd">        2: [6, 7, 8, 9],</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid_to_sample_pool</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Names do not have enough data for </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> split&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">perquery</span><span class="p">,</span> <span class="n">perdatab</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split_combos</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">perquery</span><span class="p">,</span> <span class="n">perdatab</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">scipy</span>

        <span class="n">poolsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
        <span class="c1"># Number of ways we can select queries</span>
        <span class="n">n_qmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="n">poolsize</span><span class="p">,</span> <span class="n">perquery</span><span class="p">))</span>
        <span class="c1"># Number of ways we can select targets from remaining items</span>
        <span class="n">n_dmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="n">poolsize</span> <span class="o">-</span> <span class="n">perquery</span><span class="p">,</span> <span class="n">perdatab</span><span class="p">))</span>
        <span class="c1"># Total number of query / data combinations</span>
        <span class="n">n_combos</span> <span class="o">=</span> <span class="n">n_qmax</span> <span class="o">*</span> <span class="n">n_dmax</span>

        <span class="c1"># Yield random combinations until we get something we havent seen</span>
        <span class="n">poolset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_combos</span><span class="p">:</span>
            <span class="c1"># combo = tuple(sorted(rng.choice(items, size, replace=False)))</span>
            <span class="n">qcombo</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">perquery</span><span class="p">)))</span>
            <span class="n">remain</span> <span class="o">=</span> <span class="n">poolset</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">qcombo</span><span class="p">)</span>
            <span class="n">dcombo</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">remain</span><span class="p">,</span> <span class="n">perdatab</span><span class="p">)))</span>
            <span class="c1"># TODO: try not to use queries / databases that we&#39;ve used before</span>
            <span class="c1"># until we&#39;ve exhauseted those possibilities.</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">(</span><span class="n">qcombo</span><span class="p">,</span> <span class="n">dcombo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="n">splits</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">split</span>

    <span class="k">if</span> <span class="n">n_splits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># What is the maximum number of items in a name?</span>
        <span class="n">maxsize_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">nid_to_sample_pool</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="c1"># This is only a heuristic</span>
        <span class="n">n_splits</span> <span class="o">=</span> <span class="n">maxsize_name</span>

    <span class="c1"># Create a mapping from each name to a list of query/target splits</span>
    <span class="n">nid_to_splits</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># Create several splits for each name</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">pool</span> <span class="ow">in</span> <span class="n">nid_to_sample_pool</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Randomly select up to `n_splits` combinations of size `n_need`.</span>
        <span class="n">combo_iter</span> <span class="o">=</span> <span class="n">split_combos</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">perquery</span><span class="p">,</span> <span class="n">perdatab</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">fold_split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combo_iter</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Earlier samples will be biased towards names with more annots</span>
            <span class="n">nid_to_splits</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fold_split</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">n_splits</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="c1"># print(ut.repr2(list(nid_to_splits.values()), strvals=True, nl=2))</span>

    <span class="c1"># Some names may have more splits than others</span>
    <span class="c1"># nid_to_nsplits = ut.map_vals(len, nid_to_splits)</span>
    <span class="c1"># Find the name with the most splits</span>
    <span class="c1"># max_nid = ut.argmax(nid_to_nsplits)</span>
    <span class="c1"># max_size = nid_to_nsplits[max_nid]</span>

    <span class="n">new_splits</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_splits</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">rebalance</span><span class="p">:</span>
        <span class="c1"># Rebalance by adding combos from each name in a cycle.</span>
        <span class="c1"># The difference between the largest and smallest split is at most one.</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iflatten</span><span class="p">(</span><span class="n">nid_to_splits</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">new_splits</span><span class="p">[</span><span class="n">count</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_splits</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No rebalancing. The first split contains everything from the dataset</span>
        <span class="c1"># and subsequent splits contain less and less.</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">combos</span> <span class="ow">in</span> <span class="n">nid_to_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combos</span><span class="p">):</span>
                <span class="n">new_splits</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>

    <span class="c1"># Reshape into an expanded aids list</span>
    <span class="c1"># List of query / database objects per split, grouped by name.</span>
    <span class="n">reshaped_splits</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">listT</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="k">for</span> <span class="n">splits</span> <span class="ow">in</span> <span class="n">new_splits</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">reshaped_splits</span></div>


<div class="viewcode-block" id="encounter_crossval"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.encounter_crossval">[docs]</a><span class="k">def</span> <span class="nf">encounter_crossval</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aids</span><span class="p">,</span>
    <span class="n">qenc_per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">denc_per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">enc_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">confusors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">annots_per_enc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rebalance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">early</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a list of [ (qaids, daids) ] where there are `qenc_per_name` and</span>
<span class="sd">    `denc_per_name` for each individual in the datasets respectively.</span>
<span class="sd">    `enc_labels` specifies custom encounter labels.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.init.filter_annots encounter_crossval</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init import main_helpers</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; #ibs, aids = wbia.testdata_aids(</span>
<span class="sd">        &gt;&gt;&gt; #    defaultdb=&#39;WWF_Lynx_Copy&#39;,</span>
<span class="sd">        &gt;&gt;&gt; #    a=&#39;default:minqual=good,require_timestamp=True,view=left&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ibs, aids = wbia.testdata_aids(defaultdb=&#39;PZ_MTEST&#39;,</span>
<span class="sd">        &gt;&gt;&gt;                                 a=&#39;default:require_timestamp=True&#39;)</span>
<span class="sd">        &gt;&gt;&gt; main_helpers.monkeypatch_encounters(ibs, aids, days=50)</span>
<span class="sd">        &gt;&gt;&gt; qenc_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; denc_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; confusors = False</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;denc_per_name = %r&#39; % (denc_per_name,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;qenc_per_name = %r&#39; % (qenc_per_name,))</span>
<span class="sd">        &gt;&gt;&gt; rng = 0</span>
<span class="sd">        &gt;&gt;&gt; n_splits = 5</span>
<span class="sd">        &gt;&gt;&gt; expanded_aids = encounter_crossval(ibs, aids, n_splits=n_splits,</span>
<span class="sd">        &gt;&gt;&gt;                                    qenc_per_name=qenc_per_name,</span>
<span class="sd">        &gt;&gt;&gt;                                    denc_per_name=denc_per_name,</span>
<span class="sd">        &gt;&gt;&gt;                                    confusors=confusors, rng=rng)</span>
<span class="sd">        &gt;&gt;&gt; # ensure stats agree</span>
<span class="sd">        &gt;&gt;&gt; cfgargs = dict(per_vp=False, per_multiple=False, combo_dists=False,</span>
<span class="sd">        &gt;&gt;&gt;                per_name=False, per_enc=True, use_hist=False)</span>
<span class="sd">        &gt;&gt;&gt; for qaids, daids in expanded_aids:</span>
<span class="sd">        &gt;&gt;&gt;     stats = ibs.get_annotconfig_stats(qaids, daids, **cfgargs)</span>
<span class="sd">        &gt;&gt;&gt;     del stats[&#39;confusor_daid_stats&#39;]</span>
<span class="sd">        &gt;&gt;&gt;     print(ut.repr2(stats, strvals=True, strkeys=True, nl=2))</span>
<span class="sd">        &gt;&gt;&gt;     denc_stats = stats[&#39;matchable_daid_stats&#39;][&#39;denc_per_name&#39;]</span>
<span class="sd">        &gt;&gt;&gt;     qenc_stats = stats[&#39;qaid_stats&#39;][&#39;qenc_per_name&#39;]</span>
<span class="sd">        &gt;&gt;&gt;     assert denc_stats[&#39;min&#39;] == denc_stats[&#39;max&#39;]</span>
<span class="sd">        &gt;&gt;&gt;     assert denc_stats[&#39;min&#39;] == denc_per_name</span>
<span class="sd">        &gt;&gt;&gt;     assert qenc_stats[&#39;min&#39;] == qenc_stats[&#39;max&#39;]</span>
<span class="sd">        &gt;&gt;&gt;     assert qenc_stats[&#39;min&#39;] == qenc_per_name</span>
<span class="sd">        &gt;&gt;&gt; # Restore state</span>
<span class="sd">        &gt;&gt;&gt; main_helpers.unmonkeypatch_encounters(ibs)</span>
<span class="sd">        &gt;&gt;&gt; #qaids, daids = expanded_aids[0]</span>
<span class="sd">        &gt;&gt;&gt; #stats = ibs.get_annotconfig_stats(qaids, daids, use_hist=True)</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.repr2(stats, strvals=True, strkeys=True, nl=2))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qenc_per_name</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">qenc_per_name</span><span class="p">)</span>
    <span class="n">denc_per_name</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">denc_per_name</span><span class="p">)</span>

    <span class="c1"># We can only select individuals with enough encounters</span>
    <span class="c1"># Any name without enought data becomes a confusor</span>
    <span class="n">n_need</span> <span class="o">=</span> <span class="n">qenc_per_name</span> <span class="o">+</span> <span class="n">denc_per_name</span>
    <span class="n">perquery</span> <span class="o">=</span> <span class="n">qenc_per_name</span>
    <span class="n">perdatab</span> <span class="o">=</span> <span class="n">denc_per_name</span>

    <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enc_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">enc_labels</span> <span class="o">=</span> <span class="n">annots</span><span class="o">.</span><span class="n">encounter_text</span>

    <span class="c1"># Group annotations by encounter</span>
    <span class="n">encounters</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_annot_groups</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">enc_labels</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">enc_nids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">encounters</span><span class="o">.</span><span class="n">nids</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annots_per_enc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">encounters</span> <span class="o">=</span> <span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">annots_per_enc</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">encounters</span><span class="p">]</span>
    <span class="c1"># Group encounters by name</span>
    <span class="n">nid_to_encs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">encounters</span><span class="p">,</span> <span class="n">enc_nids</span><span class="p">)</span>

    <span class="n">nid_to_confusors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nid</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">encs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">nid_to_encs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_need</span>
    <span class="p">}</span>
    <span class="n">nid_to_sample_pool</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nid</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">encs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">encs</span> <span class="ow">in</span> <span class="n">nid_to_encs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_need</span>
    <span class="p">}</span>

    <span class="n">reshaped_splits</span> <span class="o">=</span> <span class="n">crossval_helper</span><span class="p">(</span>
        <span class="n">nid_to_sample_pool</span><span class="p">,</span>
        <span class="n">perquery</span><span class="p">,</span>
        <span class="n">perdatab</span><span class="p">,</span>
        <span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span>
        <span class="n">n_need</span><span class="o">=</span><span class="n">n_need</span><span class="p">,</span>
        <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
        <span class="n">rebalance</span><span class="o">=</span><span class="n">rebalance</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">early</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reshaped_splits</span><span class="p">,</span> <span class="n">nid_to_confusors</span>

    <span class="c1"># print(ut.repr4(reshaped_splits, nl=3))</span>
    <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">qpart</span><span class="p">),</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dpart</span><span class="p">)]</span> <span class="k">for</span> <span class="n">qpart</span><span class="p">,</span> <span class="n">dpart</span> <span class="ow">in</span> <span class="n">reshaped_splits</span>
    <span class="p">]</span>

    <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">qpart</span><span class="p">))),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dpart</span><span class="p">)))]</span>
        <span class="k">for</span> <span class="n">qpart</span><span class="p">,</span> <span class="n">dpart</span> <span class="ow">in</span> <span class="n">reshaped_splits</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">confusors</span><span class="p">:</span>
        <span class="c1"># Add confusors the the dataset</span>
        <span class="n">confusor_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">nid_to_confusors</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span> <span class="o">+</span> <span class="n">confusor_aids</span><span class="p">))</span> <span class="k">for</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="ow">in</span> <span class="n">expanded_aids_list</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">expanded_aids_list</span></div>


<div class="viewcode-block" id="annot_crossval"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.annot_crossval">[docs]</a><span class="k">def</span> <span class="nf">annot_crossval</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aid_list</span><span class="p">,</span>
    <span class="n">n_qaids_per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_daids_per_name</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_splits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">confusors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stratified sampling per name size</span>

<span class="sd">    Args:</span>
<span class="sd">        n_splits (int): number of query/database splits to create.</span>
<span class="sd">            note, some names may not be big enough to split this many times.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.init.filter_annots annot_crossval</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; n_qaids_per_name = 2</span>
<span class="sd">        &gt;&gt;&gt; n_daids_per_name = 3</span>
<span class="sd">        &gt;&gt;&gt; rng = 0</span>
<span class="sd">        &gt;&gt;&gt; debug = True</span>
<span class="sd">        &gt;&gt;&gt; n_splits = None</span>
<span class="sd">        &gt;&gt;&gt; expanded_aids_list = annot_crossval(</span>
<span class="sd">        &gt;&gt;&gt;     ibs, aid_list, n_qaids_per_name, n_daids_per_name, rng, debug,</span>
<span class="sd">        &gt;&gt;&gt;     n_splits, confusors=False)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;expanded_aids_list = %s&#39; % (ut.repr2(expanded_aids_list, nl=2),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parameters</span>
    <span class="n">n_need</span> <span class="o">=</span> <span class="n">n_qaids_per_name</span> <span class="o">+</span> <span class="n">n_daids_per_name</span>
    <span class="n">rebalance</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Group annotations by name</span>
    <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">aids</span><span class="o">=</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">nid_to_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">annots</span><span class="o">.</span><span class="n">nids</span><span class="p">)</span>

    <span class="c1"># Any name without enough data becomes a confusor</span>
    <span class="c1"># Otherwise we can use it in the sampling pool</span>
    <span class="n">nid_to_confusors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nid</span><span class="p">:</span> <span class="n">aids</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">nid_to_aids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_need</span>
    <span class="p">}</span>
    <span class="n">nid_to_sample_pool</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nid</span><span class="p">:</span> <span class="n">aids</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">nid_to_aids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_need</span>
    <span class="p">}</span>

    <span class="n">perquery</span> <span class="o">=</span> <span class="n">n_qaids_per_name</span>
    <span class="n">perdatab</span> <span class="o">=</span> <span class="n">n_daids_per_name</span>

    <span class="n">reshaped_splits</span> <span class="o">=</span> <span class="n">crossval_helper</span><span class="p">(</span>
        <span class="n">nid_to_sample_pool</span><span class="p">,</span>
        <span class="n">perquery</span><span class="p">,</span>
        <span class="n">perdatab</span><span class="p">,</span>
        <span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">,</span>
        <span class="n">n_need</span><span class="o">=</span><span class="n">n_need</span><span class="p">,</span>
        <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
        <span class="n">rebalance</span><span class="o">=</span><span class="n">rebalance</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">qpart</span><span class="p">)),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">dpart</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">qpart</span><span class="p">,</span> <span class="n">dpart</span> <span class="ow">in</span> <span class="n">reshaped_splits</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">confusors</span><span class="p">:</span>
        <span class="c1"># Add confusors the the dataset</span>
        <span class="n">confusor_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">nid_to_confusors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daids</span> <span class="o">+</span> <span class="n">confusor_aids</span><span class="p">))</span> <span class="k">for</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="ow">in</span> <span class="n">expanded_aids_list</span>
        <span class="p">]</span>

    <span class="c1"># if debug:</span>
    <span class="c1">#     debug_expanded_aids(expanded_aids_list)</span>
    <span class="k">return</span> <span class="n">expanded_aids_list</span></div>

    <span class="c1"># # Group annotations by encounter</span>
    <span class="c1"># unique_encounters, groupxs = annots.group_indicies(enc_labels)</span>
    <span class="c1"># encounter_nids = annots.take(ut.take_column(groupxs, 0)).nid</span>
    <span class="c1"># encounter_aids = ut.apply_grouping(annots.aids, groupxs)</span>
    <span class="c1"># # Group encounters by name</span>
    <span class="c1"># nid_to_encs = ut.group_items(encounter_aids, encounter_nids)</span>

    <span class="c1"># nid_to_confusors = {nid: enc for nid, enc in nid_to_encs.items()</span>
    <span class="c1">#                     if len(enc) &lt;  n_need}</span>
    <span class="c1"># nid_to_sample_pool = {nid: enc for nid, enc in nid_to_encs.items()</span>
    <span class="c1">#                       if len(enc) &gt;= n_need}</span>

    <span class="c1"># # Randomly shuffle encounters for each individual</span>
    <span class="c1"># valid_enc_rand_idxs = [(nid, ut.random_indexes(len(enc), rng=rng))</span>
    <span class="c1">#                        for nid, enc in nid_to_sample_pool.items()]</span>

    <span class="c1"># # For each individual choose a set of query and database encounters</span>
    <span class="c1"># crossval_idx_samples = []</span>
    <span class="c1"># max_num_encounters = max(map(len, (t[1] for t in valid_enc_rand_idxs)))</span>
    <span class="c1"># # TODO: iterate over a sliding window to choose multiple queries OR</span>
    <span class="c1"># # iterate over all combinations of queries... (harder)</span>
    <span class="c1"># for i in range(max_num_encounters):</span>
    <span class="c1">#     encx_split = {}</span>
    <span class="c1">#     for nid, idxs in valid_enc_rand_idxs:</span>
    <span class="c1">#         if i &lt; len(idxs):</span>
    <span class="c1">#             # Choose the database encounters from anything not chosen as a</span>
    <span class="c1">#             # query</span>
    <span class="c1">#             d_choices = ut.where(ut.not_list(</span>
    <span class="c1">#                 ut.index_to_boolmask([i], len(idxs))))</span>
    <span class="c1">#             js = rng.choice(d_choices, size=denc_per_name, replace=False)</span>
    <span class="c1">#             encx_split[nid] = (idxs[i:i + 1], idxs[js])</span>
    <span class="c1">#     crossval_idx_samples.append(encx_split)</span>

    <span class="c1"># # convert to aids</span>
    <span class="c1"># crossval_aid_samples = []</span>
    <span class="c1"># for encx_split in crossval_idx_samples:</span>
    <span class="c1">#     aid_split = {}</span>
    <span class="c1">#     for nid, (qxs, dxs) in encx_split.items():</span>
    <span class="c1">#         qaids = ut.flatten(ut.take(nid_to_sample_pool[nid], qxs))</span>
    <span class="c1">#         daids = ut.flatten(ut.take(nid_to_sample_pool[nid], dxs))</span>
    <span class="c1">#         assert len(dxs) == denc_per_name</span>
    <span class="c1">#         assert len(qxs) == qenc_per_name</span>
    <span class="c1">#         aid_split[nid] = (qaids, daids)</span>
    <span class="c1">#     crossval_aid_samples.append(aid_split)</span>

    <span class="c1"># tups = [(nid, aids_) for aid_split_ in crossval_aid_samples</span>
    <span class="c1">#         for nid, aids_ in aid_split_.items()]</span>
    <span class="c1"># groups = ut.take_column(tups, 0)</span>
    <span class="c1"># aidpairs = ut.take_column(tups, 1)</span>
    <span class="c1"># # crossval_samples[0]</span>

    <span class="c1"># # rebalance the queries</span>
    <span class="c1"># # Rewrite using rebalance code from crossval_annots</span>
    <span class="c1"># # Very inefficient but does what I want</span>
    <span class="c1"># group_to_idxs = ut.dzip(*ut.group_indices(groups))</span>
    <span class="c1"># freq = ut.dict_hist(groups)</span>
    <span class="c1"># g = list(freq.keys())[ut.argmax(list(freq.values()))]</span>
    <span class="c1"># size = freq[g]</span>
    <span class="c1"># new_splits = [[] for _ in range(size)]</span>
    <span class="c1"># while True:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         g = list(freq.keys())[ut.argmax(list(freq.values()))]</span>
    <span class="c1">#         if freq[g] == 0:</span>
    <span class="c1">#             raise StopIteration()</span>
    <span class="c1">#         group_idxs = group_to_idxs[g]</span>
    <span class="c1">#         group_to_idxs[g] = []</span>
    <span class="c1">#         freq[g] = 0</span>
    <span class="c1">#         priorityx = ut.argsort(list(map(len, new_splits)))</span>
    <span class="c1">#         for nextidx, splitx in zip(group_idxs, priorityx):</span>
    <span class="c1">#             new_splits[splitx].append(nextidx)</span>
    <span class="c1">#     except StopIteration:</span>
    <span class="c1">#         break</span>
    <span class="c1"># # name_splits = ut.unflat_take(groups, new_splits)</span>
    <span class="c1"># aid_splits = ut.unflat_take(aidpairs, new_splits)</span>

    <span class="c1"># # Add annots that could not meet these requirements are distractors</span>
    <span class="c1"># confusors = ut.flatten(ut.flatten(list(nid_to_confusors.values())))</span>

    <span class="c1"># expanded_aids_list = []</span>
    <span class="c1"># for aidsplit in aid_splits:</span>
    <span class="c1">#     qaids = sorted(ut.flatten(ut.take_column(aidsplit, 0)))</span>
    <span class="c1">#     daids = sorted(ut.flatten(ut.take_column(aidsplit, 1)) + confusors)</span>
    <span class="c1">#     expanded_aids_list.append((qaids, daids))</span>
    <span class="c1"># return expanded_aids_list</span>


<div class="viewcode-block" id="expand_acfgs"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.expand_acfgs">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">expand_acfgs</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aidcfg</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hack_exclude_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">initial_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main multi-expansion function. Expands an annot config dict into qaids and</span>
<span class="sd">    daids.  New version of this function based on a configuration dictionary</span>
<span class="sd">    built from command line argumetns</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  wbia controller object</span>
<span class="sd">        aidcfg (dict): configuration of the annotation filter</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>
<span class="sd">        use_cache (bool):  turns on disk based caching(default = None)</span>
<span class="sd">        hack_exclude_keys (None): (default = None)</span>
<span class="sd">        initial_aids (None): (default = None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: expanded_aids=(qaid_list, daid_list) - expanded list of aids</span>
<span class="sd">            that meet the criteria of the aidcfg filter</span>

<span class="sd">    TODO:</span>
<span class="sd">        The database should be created first in most circumstances, then</span>
<span class="sd">        the queries should be filtered to meet the database restrictions?</span>
<span class="sd">        I&#39;m not sure Sometimes you need to set the query aids constant, but</span>
<span class="sd">        sometimes you need to set the data aids constant. Seems to depend.</span>

<span class="sd">        This function very much needs the idea of filter chains</span>

<span class="sd">        OkNewIdea:</span>
<span class="sd">            3 filters:</span>
<span class="sd">                * Common sampling - takes care of things like min time delta,</span>
<span class="sd">                * species, quality viewpoint etc.</span>
<span class="sd">                * query sampling</span>
<span class="sd">                * database sampling</span>
<span class="sd">            Basic idea is</span>
<span class="sd">                * Sample large pool</span>
<span class="sd">                * Partition pool into query and database</span>
<span class="sd">            Requires:</span>
<span class="sd">                * base sampling params</span>
<span class="sd">                * partition1 params</span>
<span class="sd">                * partition2 params</span>
<span class="sd">                * inter partition params?</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.dev -e print_acfg  -a timectrl:qsize=10,dsize=10  --db PZ_MTEST --veryverbtd --nocache-aid</span>
<span class="sd">        python -m wbia.dev -e print_acfg  -a timectrl:qminqual=good,qsize=10,dsize=10  --db PZ_MTEST --veryverbtd --nocache-aid</span>

<span class="sd">        python -m wbia.dev -e print_acfg  -a timectrl --db PZ_MTEST --verbtd --nocache-aid</span>
<span class="sd">        python -m wbia.dev -e print_acfg  -a timectrl --db PZ_Master1 --verbtd --nocache-aid</span>
<span class="sd">        python -m wbia.dev -e print_acfg  -a timequalctrl --db PZ_Master1 --verbtd --nocache-aid</span>

<span class="sd">        python -m wbia.dev -e rank_cmc   -a controlled:qsize=10,dsize=10,dper_name=2 -t default --db PZ_MTEST</span>
<span class="sd">        python -m wbia.dev -e rank_cmc   -a controlled:qsize=10,dsize=20,dper_name=2 -t default --db PZ_MTEST</span>
<span class="sd">        python -m wbia.dev -e print      -a controlled:qsize=10,dsize=10             -t default --db PZ_MTEST --verbtd --nocache-aid</span>

<span class="sd">        python -m wbia.dev -e latexsum -t candinvar -a viewpoint_compare  --db NNP_Master3 --acfginfo</span>
<span class="sd">        utprof.py -m wbia.dev -e print -t candk -a varysize  --db PZ_MTEST --acfginfo</span>
<span class="sd">        utprof.py -m wbia.dev -e latexsum -t candk -a controlled  --db PZ_Master0 --acfginfo</span>

<span class="sd">        python -m wbia --tf get_annotcfg_list:0 --db NNP_Master3 -a viewpoint_compare --nocache-aid --verbtd</span>

<span class="sd">        python -m wbia --tf get_annotcfg_list  --db PZ_Master1 \</span>
<span class="sd">            -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">            --acfginfo --veryverbtd  --veryverbtd</span>
<span class="sd">        python -m wbia --tf draw_rank_cmc --db PZ_Master1 --show -t best \</span>
<span class="sd">            -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">            --acfginfo --veryverbtd</span>

<span class="sd">        python -m wbia --tf get_annotcfg_list  --db Oxford -a default:qhas_any=\(query,\),dpername=2,exclude_reference=True --acfginfo --verbtd  --veryverbtd --nocache-aid</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.init.filter_annots --exec-expand_acfgs --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = copy.deepcopy(annotation_configs.default)</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;qcfg&#39;][&#39;species&#39;] = &#39;primary&#39;</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = None</span>
<span class="sd">        &gt;&gt;&gt; expanded_aids = expand_acfgs(ibs, aidcfg, initial_aids=initial_aids)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr3(expanded_aids, nl=1, nobr=True)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        [1, 2, 3, 4, 5, 6],</span>
<span class="sd">        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERB_TESTDATA</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s1">&#39;type(aidcfg)=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">),)</span>
    <span class="n">aidcfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>

    <span class="c1"># Check if this filter has been cached</span>
    <span class="c1"># TODO: keep a database state config that augments the cachestr?</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_cache</span> <span class="o">=</span> <span class="n">USE_ACFG_CACHE</span>

    <span class="c1"># save_cache = True</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">save_cache</span><span class="p">:</span>
        <span class="n">acfg_cacheinfo</span> <span class="o">=</span> <span class="n">get_acfg_cacheinfo</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">)</span>
        <span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span> <span class="o">=</span> <span class="n">acfg_cacheinfo</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">aids_tup</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">tryload_cache</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aids_tup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">aids_tup</span>
            <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span>

    <span class="n">comp_acfg</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">compress_aidcfg</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;+=== EXPAND_ACFGS ===&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * acfg = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">comp_acfg</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">),))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="c1"># Breakup into common, query, and database configs</span>
    <span class="n">qcfg</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">]</span>
    <span class="n">dcfg</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">]</span>
    <span class="n">common_cfg</span> <span class="o">=</span> <span class="n">comp_acfg</span><span class="p">[</span><span class="s1">&#39;common&#39;</span><span class="p">]</span>

    <span class="c1"># Extract the common independent filtering params</span>
    <span class="n">idenfilt_cfg_default</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">INDEPENDENT_DEFAULTS</span>
    <span class="n">idenfilt_cfg_empty</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">idenfilt_cfg_default</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">idenfilt_cfg_common</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">idenfilt_cfg_empty</span><span class="p">,</span> <span class="n">common_cfg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hack_exclude_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hack_exclude_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">idenfilt_cfg_common</span><span class="p">:</span>
                <span class="n">idenfilt_cfg_common</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Find the q/d specific filtering flags that were already taken care of in</span>
    <span class="c1"># common filtering. Set them all to None, so we dont rerun that filter</span>
    <span class="n">qpredone_iden_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect</span><span class="p">(</span><span class="n">qcfg</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">qpredone_iden_keys</span><span class="p">:</span>
        <span class="n">qcfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">dpredone_iden_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect</span><span class="p">(</span><span class="n">dcfg</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dpredone_iden_keys</span><span class="p">:</span>
        <span class="n">dcfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># if aidcfg[&#39;qcfg&#39;][&#39;hack_imageset&#39;] is True:</span>
    <span class="c1">#    return ibs.get_imageset_expanded_aids()</span>
    <span class="c1"># Hack: Make hierarchical filters to supersede this</span>
    <span class="k">if</span> <span class="n">initial_aids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_aids</span><span class="p">()</span>

    <span class="n">initial_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annotation_set</span><span class="p">(</span><span class="n">initial_aids</span><span class="p">,</span> <span class="n">is_staged</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">verbflags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">qfiltflags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span><span class="p">)</span>
    <span class="n">dfiltflags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span><span class="p">)</span>

    <span class="n">default_aids</span> <span class="o">=</span> <span class="n">initial_aids</span>

    <span class="c1"># A chain of filters on all of the aids</span>
    <span class="n">global_filter_chain</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">),</span>
        <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">idenfilt_cfg_common</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># Chains of filters individually for each partition</span>
    <span class="n">partition_chains</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="c1"># Query partition chain</span>
            <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
            <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
            <span class="p">(</span><span class="n">sample_annots</span><span class="p">,</span> <span class="n">qcfg</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="c1"># Database partition chain</span>
            <span class="p">(</span><span class="n">filter_annots_independent</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">),</span>
            <span class="p">(</span><span class="n">filter_annots_intragroup</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">),</span>
            <span class="p">(</span><span class="n">sample_annots_wrt_ref</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># GLOBAL FILTER CHAIN</span>
        <span class="c1"># applies filtering to all available aids</span>
        <span class="k">for</span> <span class="n">filtfn</span><span class="p">,</span> <span class="n">filtcfg</span> <span class="ow">in</span> <span class="n">global_filter_chain</span><span class="p">:</span>
            <span class="n">default_aids</span> <span class="o">=</span> <span class="n">filtfn</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="n">default_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">withpre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">verbflags</span>
            <span class="p">)</span>

        <span class="c1"># PARTITION FILTER CHAIN</span>
        <span class="c1"># chain of filters for query / database annots</span>
        <span class="n">default_qaids</span> <span class="o">=</span> <span class="n">default_daids</span> <span class="o">=</span> <span class="n">default_aids</span>
        <span class="n">partition_avail_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_qaids</span><span class="p">,</span> <span class="n">default_daids</span><span class="p">]</span>
        <span class="n">partion_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">qfiltflags</span><span class="p">,</span> <span class="n">dfiltflags</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partition_chains</span><span class="p">)):</span>
            <span class="n">filter_chain</span> <span class="o">=</span> <span class="n">partition_chains</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">_partkw</span> <span class="o">=</span> <span class="n">partion_kwargs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">filter_tup</span> <span class="ow">in</span> <span class="n">filter_chain</span><span class="p">:</span>
                <span class="n">filtfn</span><span class="p">,</span> <span class="n">filtcfg</span> <span class="o">=</span> <span class="n">filter_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># handle filters that take reference sets</span>
                    <span class="n">refindex</span> <span class="o">=</span> <span class="n">filter_tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ref_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">refindex</span><span class="p">]</span>
                    <span class="n">_partkw</span><span class="p">[</span><span class="s1">&#39;ref_aids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_aids</span>
                <span class="c1"># Execute filtering</span>
                <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">filtfn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">_partkw</span><span class="p">)</span>
            <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail_aids</span>

        <span class="c1"># SUBINDEX EACH PARTITIONED CHAIN</span>
        <span class="n">subindex_cfgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">qcfg</span><span class="p">,</span> <span class="n">dcfg</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partition_avail_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">_partkw</span> <span class="o">=</span> <span class="n">partion_kwargs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">filtcfg</span> <span class="o">=</span> <span class="n">subindex_cfgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">subindex_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filtcfg</span><span class="p">,</span> <span class="o">**</span><span class="n">_partkw</span><span class="p">)</span>
            <span class="n">partition_avail_aids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">avail_aids</span>

        <span class="c1"># UNPACK FILTER RESULTS</span>
        <span class="n">avail_qaids</span><span class="p">,</span> <span class="n">avail_daids</span> <span class="o">=</span> <span class="n">partition_avail_aids</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PRINTING ERROR INFO&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * acfg = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">comp_acfg</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">),))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error executing filter chains&#39;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="n">qaid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_qaids</span><span class="p">)</span>
    <span class="n">daid_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_daids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;+---------------------&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;L___ EXPAND_ACFGS ___&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="c1"># Save filter to cache</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">save_cache</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">acfg_cachedir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">save_cache</span><span class="p">(</span>
                <span class="n">acfg_cachedir</span><span class="p">,</span> <span class="n">acfg_cachename</span><span class="p">,</span> <span class="n">aid_cachestr</span><span class="p">,</span> <span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span></div>


<div class="viewcode-block" id="expand_species"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.expand_species">[docs]</a><span class="k">def</span> <span class="nf">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">avail_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_primary_database_species</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">avail_aids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_dominant_species</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species</span></div>


<div class="viewcode-block" id="filter_annots_independent"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.filter_annots_independent">[docs]</a><span class="nd">@profile</span>
<span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">filter_annots_independent</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">,</span> <span class="n">withpre</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filtering that doesn&#39;t have to do with a reference set of aids</span>

<span class="sd">    TODO make filterflags version</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  wbia controller object</span>
<span class="sd">        avail_aids (list):</span>
<span class="sd">        aidcfg (dict):</span>
<span class="sd">        prefix (str): (default = &#39;&#39;)</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: avail_aids</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf filter_annots_independent --veryverbtd</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = input_aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = annotation_configs.default[&#39;dcfg&#39;]</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;require_timestamp&#39;] = True</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;require_quality&#39;] = False</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;is_known&#39;] = True</span>
<span class="sd">        &gt;&gt;&gt; prefix = &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = filter_annots_independent(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                                        prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;avail_aids = %s&#39; % (str(avail_aids),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        # Testing tag features</span>
<span class="sd">        python -m wbia --tf draw_rank_cmc --db PZ_Master1 --show -t best \</span>
<span class="sd">            -a timectrl:qhas_any=\(needswork,correctable,mildviewpoint\),qhas_none=\(viewpoint,photobomb,error:viewpoint,quality\) \</span>
<span class="sd">            ---acfginfo --veryverbtd</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.other</span> <span class="k">import</span> <span class="n">ibsfuncs</span>

    <span class="k">if</span> <span class="n">aidcfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No annot filter returning&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verb_context</span><span class="p">(</span><span class="s1">&#39;FILTER_INDEPENDENT&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="n">withpre</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_known&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;is_known&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_without_name</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;is_known&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_exemplar&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_exemplar_flags</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="o">==</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;is_exemplar&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;is_exemplar&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reviewed&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_reviewed</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="o">==</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;reviewed&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;reviewed&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multiple&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_multiple</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="o">==</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;multiple&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;multiple&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_timestamp&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;require_timestamp&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_without_timestamps</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_gps&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;require_gps&#39;</span><span class="p">):</span>
            <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
            <span class="n">annots</span> <span class="o">=</span> <span class="n">annots</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annots</span><span class="o">.</span><span class="n">gps</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">annots</span><span class="o">.</span><span class="n">aids</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_timestamp&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;max_timestamp&#39;</span><span class="p">):</span>
            <span class="n">max_dt</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_timestamp&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">datetime</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_dt</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">max_unixtime</span> <span class="o">=</span> <span class="n">max_dt</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_dt</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">max_dt</span> <span class="o">==</span> <span class="s1">&#39;now&#39;</span><span class="p">:</span>
                    <span class="n">max_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_dt</span> <span class="o">=</span> <span class="n">max_dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">max_dt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">max_dt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">date_to_datetime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="n">max_unixtime</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">datetime_to_posixtime</span><span class="p">(</span><span class="n">max_dt</span><span class="p">)</span>
            <span class="n">unixtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span><span class="o">.</span><span class="n">image_unixtimes_asfloat</span><span class="p">)</span>
            <span class="n">flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unixtimes</span><span class="p">),</span> <span class="n">unixtimes</span> <span class="o">&lt;=</span> <span class="n">max_unixtime</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="n">cfg_species</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;species&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg_species</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg_species</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">cfg_species</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cfg_species</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cfg_species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_species</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span>
            <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;been_adjusted&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># HACK to see if the annotation has been adjusted from the default</span>
        <span class="c1"># value set by dbio.ingest_database</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_been_adjusted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;been_adjusted&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contributor_contains&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">contributor_contains</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;contributor_contains&#39;</span><span class="p">]</span>
        <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_gids</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">tag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_contributor_tag</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">contributor_contains</span> <span class="ow">in</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_list</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;contributor_contains&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minqual&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_quality&#39;</span><span class="p">):</span>
        <span class="n">minqual</span> <span class="o">=</span> <span class="s1">&#39;junk&#39;</span> <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;minqual&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;minqual&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;minqual&#39;</span><span class="p">,</span> <span class="s1">&#39;require_quality&#39;</span><span class="p">):</span>
            <span class="c1"># Filter quality</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_quality</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">minqual</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;require_quality&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_unixtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_unixtime</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_unixtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">unixtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">unixtimes</span> <span class="o">&lt;=</span> <span class="n">max_unixtime</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;max_unixtime&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_unixtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_unixtime</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_unixtime&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">unixtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">unixtimes</span> <span class="o">&gt;=</span> <span class="n">min_unixtime</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;min_unixtime&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_numfeat&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_numfeat&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_numfeat</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;max_numfeat&#39;</span><span class="p">]</span>
        <span class="n">min_numfeat</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;min_numfeat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_numfeat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_numfeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">min_numfeat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_numfeat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">numfeat_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">))</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">numfeat_list</span> <span class="o">&gt;=</span> <span class="n">min_numfeat</span><span class="p">,</span> <span class="n">numfeat_list</span> <span class="o">&lt;=</span> <span class="n">max_numfeat</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;max_numfeat&#39;</span><span class="p">,</span> <span class="s1">&#39;min_numfeat&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;require_viewpoint&#39;</span><span class="p">):</span>
        <span class="c1"># Resolve base viewpoint</span>
        <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;primary1&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">view</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">OLD</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">OLD</span><span class="p">:</span>
            <span class="n">view_ext1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext1&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">view_ext2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext2&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_ext2&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">valid_yaws</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_extended_viewpoints</span><span class="p">(</span>
                <span class="n">view</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="n">view_ext1</span><span class="p">,</span> <span class="n">num2</span><span class="o">=</span><span class="n">view_ext2</span>
            <span class="p">)</span>
            <span class="n">unknown_ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;require_viewpoint&#39;</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span>
                <span class="s1">&#39;view&#39;</span><span class="p">,</span>
                <span class="s1">&#39;require_viewpoint&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext2&#39;</span><span class="p">,</span>
                <span class="n">valid_yaws</span><span class="o">=</span><span class="n">valid_yaws</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_aids_to_viewpoint</span><span class="p">(</span>
                    <span class="n">avail_aids</span><span class="p">,</span> <span class="n">valid_yaws</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="n">unknown_ok</span>
                <span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">rectify_view</span><span class="p">(</span><span class="n">vstr</span><span class="p">):</span>
                <span class="c1"># FIXME: I stopped implementing the += stuff</span>
                <span class="n">vstr_num</span> <span class="o">=</span> <span class="n">vstr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vstr_num</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
                    <span class="n">vstr</span> <span class="o">=</span> <span class="n">vstr_num</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">vstr</span><span class="p">:</span>
                        <span class="n">vstr</span><span class="p">,</span> <span class="n">numstr</span> <span class="o">=</span> <span class="n">vstr_num</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numstr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">vstr</span><span class="p">:</span>
                        <span class="n">vstr</span><span class="p">,</span> <span class="n">numstr</span> <span class="o">=</span> <span class="n">vstr_num</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">numstr</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;cant do += yet&#39;</span>
                <span class="k">if</span> <span class="n">vstr</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">yawtxt</span><span class="p">,</span> <span class="n">other_yawtxt</span> <span class="ow">in</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">YAWALIAS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">other_yawtxt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">other_yawtxt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vstr</span> <span class="o">==</span> <span class="n">yawtxt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">yawtxt</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other_yawtxt</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vstr</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="k">return</span> <span class="n">yawtxt</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown viewpoint vstr=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vstr</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valid_yaw_txts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_yaw_txts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">rectify_view</span><span class="p">(</span><span class="n">vstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">vstr</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">smart_cast</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="n">unknown_ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;require_viewpoint&#39;</span><span class="p">]</span>
            <span class="n">yaw_flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_viewpoint_filterflags</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">valid_yaw_txts</span><span class="p">,</span> <span class="n">unknown_ok</span><span class="o">=</span><span class="n">unknown_ok</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">yaw_flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">yaw_flags</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span>
                <span class="s1">&#39;view&#39;</span><span class="p">,</span>
                <span class="s1">&#39;require_viewpoint&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_ext2&#39;</span><span class="p">,</span>
                <span class="n">valid_yaws</span><span class="o">=</span><span class="n">valid_yaw_txts</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">yaw_flags</span><span class="p">)</span>

    <span class="c1"># if aidcfg.get(&#39;exclude_view&#39;) is not None:</span>
    <span class="c1">#    raise NotImplementedError(&#39;view tag resolution of exclude_view&#39;)</span>
    <span class="c1">#    # Filter viewpoint</span>
    <span class="c1">#    # TODO need to resolve viewpoints</span>
    <span class="c1">#    exclude_view = aidcfg.get(&#39;exclude_view&#39;)</span>
    <span class="c1">#    with VerbosityContext(&#39;exclude_view&#39;, hack=True):</span>
    <span class="c1">#        avail_aids = ibs.remove_aids_of_viewpoint(</span>
    <span class="c1">#            avail_aids, exclude_view)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_pername_global&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Keep annots with at least this many groundtruths in the database</span>
        <span class="n">min_pername_global</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_pername_global&#39;</span><span class="p">)</span>
        <span class="n">num_gt_global_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_groundtruth</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num_gt_global_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_pername_global</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;exclude_view&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_pername_global&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_pername_global</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_pername_global&#39;</span><span class="p">)</span>
        <span class="n">num_gt_global_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_groundtruth</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">noself</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num_gt_global_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_pername_global</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;exclude_view&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="c1"># FILTER HACK integrating some notion of tag functions</span>
    <span class="c1"># TODO: further integrate</span>
    <span class="k">if</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_any&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_none&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">filterkw</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;has_any&#39;</span><span class="p">,</span> <span class="s1">&#39;has_none&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">get_annot_tag_filterflags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">filterkw</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;has_any&#39;</span><span class="p">,</span> <span class="s1">&#39;has_none&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span></div>


<div class="viewcode-block" id="filter_annots_intragroup"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.filter_annots_intragroup">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">filter_annots_intragroup</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">,</span> <span class="n">withpre</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This filters annots using information about the relationships</span>
<span class="sd">    between the annotations in the ``avail_aids`` group. This function is not</span>
<span class="sd">    independent and a second consecutive call may yield new results.</span>
<span class="sd">    Thus, the order in which this filter is applied matters.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        wbia --tf get_annotcfg_list \</span>
<span class="sd">                -a default:qsame_imageset=True,been_adjusted=True,excluderef=True \</span>
<span class="sd">                --db lynx --veryverbtd --nocache-aid</span>

<span class="sd">    Ignore:</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_timedelta&#39;] = 60 * 60 * 24</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_pername&#39;] = 3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.other</span> <span class="k">import</span> <span class="n">ibsfuncs</span>

    <span class="k">if</span> <span class="n">aidcfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No annot filter returning&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verb_context</span><span class="p">(</span><span class="s1">&#39;FILTER_INTRAGROUP&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="n">withpre</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span>
        <span class="n">species</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">expand_species</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span> <span class="n">avail_aids</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;same_imageset&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">same_imageset</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;same_imageset&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">same_imageset</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="n">imgsetid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_primary_imageset</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">multiprop2_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hierarchical_group_items</span><span class="p">(</span>
            <span class="n">avail_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">nid_list</span><span class="p">,</span> <span class="n">imgsetid_list</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">qaid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># TODO: sampling using different enouncters</span>
        <span class="k">for</span> <span class="n">imgsetid</span><span class="p">,</span> <span class="n">nid2_aids</span> <span class="ow">in</span> <span class="n">multiprop2_aids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aids_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nid2_aids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argmax</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)))</span>
                <span class="n">qaids</span> <span class="o">=</span> <span class="n">aids_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">qaid_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;same_imageset&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">qaid_list</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="c1"># TODO:</span>
    <span class="c1"># Filter via GPS distance</span>
    <span class="c1"># try:</span>
    <span class="c1">#    if aidcfg[&#39;min_spacedelta&#39;] is not None:</span>
    <span class="c1">#        pass</span>
    <span class="c1">#    if aidcfg[&#39;min_spacetimedelta&#39;] is not None:</span>
    <span class="c1">#        pass</span>
    <span class="c1"># except KeyError:</span>
    <span class="c1">#    pass</span>

    <span class="c1"># FIXME: This is NOT an independent filter because it depends on pairwise</span>
    <span class="c1"># interactions</span>
    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_pername&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
        <span class="c1"># This filter removes entire names.  The avaiable aids must be from</span>
        <span class="c1"># names with certain viewpoint frequency properties</span>
        <span class="n">prop2_nid2_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_prop_and_name</span><span class="p">(</span>
            <span class="n">avail_aids</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoint_code</span>
        <span class="p">)</span>

        <span class="n">countstr</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;view_pername&#39;</span><span class="p">]</span>
        <span class="n">primary_viewpoint</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_primary_species_viewpoint</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">lhs_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;primary&#39;</span><span class="p">:</span> <span class="n">primary_viewpoint</span><span class="p">,</span>
            <span class="s1">&#39;primary1&#39;</span><span class="p">:</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_extended_viewpoints</span><span class="p">(</span>
                <span class="n">primary_viewpoint</span><span class="p">,</span> <span class="n">num1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">include_base</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">CountstrParser</span><span class="p">(</span><span class="n">lhs_dict</span><span class="p">,</span> <span class="n">prop2_nid2_aids</span><span class="p">)</span>
        <span class="n">nid2_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_countstr_expr</span><span class="p">(</span><span class="n">countstr</span><span class="p">)</span>
        <span class="n">nid2_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name_dict</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">valid_nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nid</span> <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">nid2_flag</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">flag</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;view_pername&#39;</span><span class="p">,</span> <span class="n">countstr</span><span class="o">=</span><span class="n">countstr</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">nid2_aids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">))</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;min_timedelta&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_timedelta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_timedelta</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;min_timedelta&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;min_timedelta&#39;</span><span class="p">,</span> <span class="n">min_timedelta</span><span class="o">=</span><span class="n">min_timedelta</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">filter_annots_using_minimum_timedelta</span><span class="p">(</span>
                <span class="n">avail_aids</span><span class="p">,</span> <span class="n">min_timedelta</span>
            <span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="c1"># Each aid must have at least this number of other groundtruth aids</span>
    <span class="n">min_pername</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;min_pername&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">min_pername</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span>
            <span class="n">avail_aids</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;min_pername&#39;</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">grouped_aids_</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">min_pername</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">grouped_aids_</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
            <span class="c1"># avail_aids = ut.flatten([</span>
            <span class="c1">#    aids for aids in grouped_aids_ if len(aids) &gt;= min_pername])</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="n">max_pername</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;max_pername&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_pername</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grouped_aids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span>
            <span class="n">avail_aids</span><span class="p">,</span> <span class="n">distinguish_unknowns</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;max_pername&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span><span class="n">aids</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">grouped_aids_</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_pername</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># avail_aids = sorted(avail_aids)</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span></div>


<div class="viewcode-block" id="get_reference_preference_order"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.get_reference_preference_order">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">get_reference_preference_order</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">gt_ref_grouped_aids</span><span class="p">,</span>
    <span class="n">gt_avl_grouped_aids</span><span class="p">,</span>
    <span class="n">prop_getter</span><span class="p">,</span>
    <span class="n">cmp_func</span><span class="p">,</span>
    <span class="n">aggfn</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orders preference for sampling based on some metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">grouped_reference_unixtimes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">prop_getter</span><span class="p">,</span> <span class="n">gt_ref_grouped_aids</span><span class="p">)</span>
    <span class="n">grouped_available_gt_unixtimes</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">prop_getter</span><span class="p">,</span> <span class="n">gt_avl_grouped_aids</span><span class="p">)</span>

    <span class="n">grouped_reference_props</span> <span class="o">=</span> <span class="n">grouped_reference_unixtimes</span>
    <span class="n">grouped_available_gt_props</span> <span class="o">=</span> <span class="n">grouped_available_gt_unixtimes</span>

    <span class="c1"># Order the available aids by some aggregation over some metric</span>
    <span class="n">preference_scores</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">aggfn</span><span class="p">(</span><span class="n">cmp_func</span><span class="p">(</span><span class="n">ref_prop</span><span class="p">,</span> <span class="n">avl_prop</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ref_prop</span><span class="p">,</span> <span class="n">avl_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_reference_props</span><span class="p">,</span> <span class="n">grouped_available_gt_props</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># Order by increasing timedelta (metric)</span>
    <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span><span class="n">preference_scores</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gt_preference_idx_list</span></div>


<div class="viewcode-block" id="sample_annots_wrt_ref"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.sample_annots_wrt_ref">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">sample_annots_wrt_ref</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">ref_aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sampling when a reference set is given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_per_name</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">)</span>
    <span class="n">sample_per_ref_name</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_per_ref_name&#39;</span><span class="p">)</span>
    <span class="n">exclude_reference</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exclude_reference&#39;</span><span class="p">)</span>
    <span class="n">sample_size</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_offset&#39;</span><span class="p">)</span>
    <span class="n">sample_rule_ref</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_rule_ref&#39;</span><span class="p">)</span>
    <span class="n">sample_rule</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_rule&#39;</span><span class="p">)</span>
    <span class="n">sample_occur</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_occur&#39;</span><span class="p">)</span>
    <span class="n">exclude_ref_contact</span> <span class="o">=</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exclude_ref_contact&#39;</span><span class="p">)</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
    <span class="n">ref_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verb_context</span><span class="p">(</span><span class="s1">&#39;SAMPLE (REF)&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_per_ref_name</span> <span class="o">=</span> <span class="n">sample_per_name</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">exclude_reference</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ref_aids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ref_aids=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ref_aids</span><span class="p">,)</span>
        <span class="c1"># VerbosityContext.report_annot_stats(ibs, avail_aids, prefix, &#39;&#39;)</span>
        <span class="c1"># VerbosityContext.report_annot_stats(ibs, ref_aids, prefix, &#39;&#39;)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;exclude_reference&#39;</span><span class="p">,</span> <span class="n">num_ref_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">ref_aids</span><span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exclude_ref_contact</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;exclude_ref_contact&#39;</span><span class="p">,</span> <span class="n">num_ref_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)):</span>
            <span class="c1"># also_exclude_overlaps = ibs.get_dbname() == &#39;Oxford&#39;</span>
            <span class="n">contact_aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_contact_aids</span><span class="p">(</span>
                <span class="n">ref_aids</span><span class="p">,</span> <span class="n">daid_list</span><span class="o">=</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Disallow the same name in the same image</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">,</span> <span class="n">contact_aids_list</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)</span>
            <span class="n">sameimg_samename_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="o">==</span> <span class="n">y0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contact_aids_list</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># contact_aids = ut.flatten(contact_aids_list)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_ordered</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">sameimg_samename_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_occur</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_occur&#39;</span><span class="p">,</span> <span class="n">num_ref_aids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)):</span>
            <span class="c1"># Get other aids from the references&#39; encounters</span>
            <span class="n">ref_enc_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)</span>
            <span class="n">avail_enc_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_encounter_text</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff_flags</span><span class="p">(</span><span class="n">avail_enc_texts</span><span class="p">,</span> <span class="n">ref_enc_texts</span><span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">avail_aids</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_float</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>
        <span class="c1"># A float sample size is a interpolations between full data and small</span>
        <span class="c1"># data</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sample_size</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_aids</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expanding sample size to: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,))</span>

    <span class="c1"># This function first partitions aids into a one set that corresonds with</span>
    <span class="c1"># the reference set and another that does not correspond with the reference</span>
    <span class="c1"># set. The rest of the filters operate on these sets independently</span>
    <span class="n">partitioned_sets</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">partition_annots_into_corresponding_groups</span><span class="p">(</span>
        <span class="n">ref_aids</span><span class="p">,</span> <span class="n">avail_aids</span>
    <span class="p">)</span>
    <span class="c1"># items</span>
    <span class="c1"># [0], and [1] are corresponding lists of annot groups</span>
    <span class="c1"># [2], and [3] are non-corresonding annot groups</span>
    <span class="p">(</span>
        <span class="n">gt_ref_grouped_aids</span><span class="p">,</span>
        <span class="n">gt_avl_grouped_aids</span><span class="p">,</span>
        <span class="n">gf_ref_grouped_aids</span><span class="p">,</span>
        <span class="n">gf_avl_grouped_aids</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">partitioned_sets</span>

    <span class="k">if</span> <span class="n">sample_per_ref_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_rule_ref</span> <span class="o">==</span> <span class="s1">&#39;maxtimedelta&#39;</span><span class="p">:</span>
            <span class="c1"># Maximize time delta between query and corresponding database</span>
            <span class="c1"># annotations</span>
            <span class="n">cmp_func</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">absdiff</span>
            <span class="n">aggfn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
            <span class="n">prop_getter</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span>
            <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="n">get_reference_preference_order</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span>
                <span class="n">gt_ref_grouped_aids</span><span class="p">,</span>
                <span class="n">gt_avl_grouped_aids</span><span class="p">,</span>
                <span class="n">prop_getter</span><span class="p">,</span>
                <span class="n">cmp_func</span><span class="p">,</span>
                <span class="n">aggfn</span><span class="p">,</span>
                <span class="n">rng</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">sample_rule_ref</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">gt_preference_idx_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">gt_avl_grouped_aids</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown sample_rule_ref = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_rule_ref</span><span class="p">,))</span>
        <span class="n">gt_sample_idxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column_slice</span><span class="p">(</span>
            <span class="n">gt_preference_idx_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_ref_name</span>
        <span class="p">)</span>
        <span class="n">gt_sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">,</span> <span class="n">gt_sample_idxs_list</span><span class="p">)</span>
        <span class="n">gt_avl_grouped_aids</span> <span class="o">=</span> <span class="n">gt_sample_aids</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span>
            <span class="s1">&#39;sample_per_ref_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sample_rule_ref&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sample_offset&#39;</span><span class="p">,</span>
            <span class="n">sample_per_ref_name</span><span class="o">=</span><span class="n">sample_per_ref_name</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_per_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># sample rule is always random for gf right now</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">gf_preference_idx_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">gf_avl_grouped_aids</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown sample_rule=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_rule</span><span class="p">,))</span>
        <span class="n">gf_sample_idxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column_slice</span><span class="p">(</span>
            <span class="n">gf_preference_idx_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_name</span>
        <span class="p">)</span>
        <span class="n">gf_sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">,</span> <span class="n">gf_sample_idxs_list</span><span class="p">)</span>
        <span class="n">gf_avl_grouped_aids</span> <span class="o">=</span> <span class="n">gf_sample_aids</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_rule&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_offset&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">)</span>

    <span class="n">gt_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gt_avl_grouped_aids</span><span class="p">)</span>
    <span class="n">gf_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">gf_avl_grouped_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Keep all correct matches to the reference set</span>
        <span class="c1"># We have the option of keeping ground false</span>
        <span class="n">num_gt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_avl_aids</span><span class="p">)</span>
        <span class="n">num_gf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gf_avl_aids</span><span class="p">)</span>
        <span class="n">num_keep_gf</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">-</span> <span class="n">num_gt</span>
        <span class="n">num_remove_gf</span> <span class="o">=</span> <span class="n">num_gf</span> <span class="o">-</span> <span class="n">num_keep_gf</span>
        <span class="k">if</span> <span class="n">num_remove_gf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Too few ground false</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Warning: Cannot meet sample_size=</span><span class="si">%r</span><span class="s1">. available_</span><span class="si">%s</span><span class="s1">aids &#39;</span>
                    <span class="s1">&#39;will be undersized by at least </span><span class="si">%d</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">-</span><span class="n">num_remove_gf</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_keep_gf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Too many multitons; Can never remove a multiton</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;Warning: Cannot meet sample_size=</span><span class="si">%r</span><span class="s1">. available_</span><span class="si">%s</span><span class="s1">aids &#39;</span>
                <span class="s1">&#39;will be oversized by at least </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">-</span><span class="n">num_keep_gf</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="n">gf_avl_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">gf_avl_aids</span><span class="p">,</span> <span class="n">num_keep_gf</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="c1"># random ordering makes for bad hashes</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span>
            <span class="s1">&#39;sample_size&#39;</span><span class="p">,</span>
            <span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
            <span class="n">num_remove_gf</span><span class="o">=</span><span class="n">num_remove_gf</span><span class="p">,</span>
            <span class="n">num_keep_gf</span><span class="o">=</span><span class="n">num_keep_gf</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">gt_avl_aids</span> <span class="o">+</span> <span class="n">gf_avl_aids</span>

    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gt_avl_aids</span> <span class="o">+</span> <span class="n">gf_avl_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span></div>


<div class="viewcode-block" id="multi_sampled_seaturtle_queries"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.multi_sampled_seaturtle_queries">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">multi_sampled_seaturtle_queries</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">wbia</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">experiment_helpers</span>
    <span class="kn">from</span> <span class="nn">wbia.init.filter_annots</span> <span class="k">import</span> <span class="n">expand_acfgs</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="n">aidcfg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">annotation_configs</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;seaturtles&#39;</span>  <span class="c1"># &#39;testdb1&#39;</span>
    <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="n">defaultdb</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;default:sample_occur=True,occur_offset=0,exclude_reference=True,qhas_any=(left,right),num_names=1&#39;</span>
    <span class="p">]</span>
    <span class="n">acfg_combo_list</span> <span class="o">=</span> <span class="n">experiment_helpers</span><span class="o">.</span><span class="n">parse_acfg_combo_list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">aidcfg</span> <span class="o">=</span> <span class="n">acfg_combo_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Do each name individually. A bit slower, but more correct</span>
        <span class="n">qaids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">daids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;name_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="o">=</span> <span class="n">expand_acfgs</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_cache</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">qaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
                <span class="n">daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids_list</span><span class="p">)</span>
            <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;name_offset&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaids_list</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">):</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">enc_per_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">per_enc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># A bit faster because we can do multiple names at the same time</span>
        <span class="n">qaids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">daids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;num_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;dcfg&#39;</span><span class="p">][</span><span class="s1">&#39;num_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;name_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="o">=</span> <span class="n">expand_acfgs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;qcfg&#39;</span><span class="p">][</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">qaids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>
            <span class="n">daids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">qaids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qaids_list</span><span class="p">,</span> <span class="n">daids_list</span><span class="p">):</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaids</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">enc_per_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">per_enc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="sample_annots"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.sample_annots">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">sample_annots</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sampling preserves input sample structure and thust does not always return</span>
<span class="sd">    exact values</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia --tf sample_annots --veryverbtd</span>

<span class="sd">        python -m wbia --tf get_annotcfg_list --db seaturtles \</span>
<span class="sd">            -a default:qhas_any=\(left,right\),sample_occur=True,exclude_reference=True,sample_offset=0,num_names=1 --acfginfo</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = input_aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = copy.deepcopy(annotation_configs.default[&#39;dcfg&#39;])</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;sample_per_name&#39;] = 3</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;sample_size&#39;] = 10</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;min_pername&#39;] = 2</span>
<span class="sd">        &gt;&gt;&gt; prefix = &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = filter_annots_independent(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                                        prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = sample_annots(ibs, avail_aids, aidcfg,</span>
<span class="sd">        &gt;&gt;&gt;                            prefix, avail_aids)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;avail_aids = %s&#39; % (str(avail_aids),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.init.filter_annots import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia.expt import annotation_configs</span>
<span class="sd">        &gt;&gt;&gt; db = &#39;seaturtles&#39;  # &#39;testdb1&#39;</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=db)</span>
<span class="sd">        &gt;&gt;&gt; aidcfg = copy.deepcopy(annotation_configs.default)[&#39;qcfg&#39;]</span>
<span class="sd">        &gt;&gt;&gt; aidcfg[&#39;sample_occur&#39;] = True</span>
<span class="sd">        &gt;&gt;&gt; initial_aids = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; withpre, verbose, prefix = True, 2, &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = filter_annots_independent(</span>
<span class="sd">        &gt;&gt;&gt;     ibs, initial_aids, {&#39;has_any&#39;: [&#39;left&#39;, &#39;right&#39;]}, prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; qaids = sample_annots(ibs, avail_aids, aidcfg, prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; avail_aids = initial_aids</span>
<span class="sd">        &gt;&gt;&gt; ref_aids = qaids</span>
<span class="sd">        &gt;&gt;&gt; dcfg = dict(exclude_reference=True, sample_occur=True)</span>
<span class="sd">        &gt;&gt;&gt; daids = sample_annots_wrt_ref(ibs, initial_aids, dcfg, qaids, prefix, verbose)</span>
<span class="sd">        &gt;&gt;&gt; ibs.print_annotconfig_stats(qaids, daids, enc_per_name=True, per_enc=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="k">import</span> <span class="n">annotation_configs</span>

    <span class="k">def</span> <span class="nf">get_cfg</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">default_dict</span> <span class="o">=</span> <span class="n">annotation_configs</span><span class="o">.</span><span class="n">SAMPLE_DEFAULTS</span>
        <span class="k">return</span> <span class="n">aidcfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verb_context</span><span class="p">(</span><span class="s1">&#39;SAMPLE (NOREF)&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">()</span>

    <span class="n">sample_rule</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_rule&#39;</span><span class="p">)</span>
    <span class="n">sample_per_name</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">)</span>
    <span class="n">sample_size</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_offset&#39;</span><span class="p">)</span>
    <span class="n">occur_offset</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;occur_offset&#39;</span><span class="p">)</span>
    <span class="n">name_offset</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;name_offset&#39;</span><span class="p">)</span>
    <span class="n">num_names</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;num_names&#39;</span><span class="p">)</span>
    <span class="n">sample_occur</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_occur&#39;</span><span class="p">)</span>

    <span class="n">unflat_get_annot_unixtimes</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_image_unixtimes_asfloat</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">occur_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">occur_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">name_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name_offset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">num_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;num_names&#39;</span><span class="p">):</span>
            <span class="n">name_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">name_offset</span><span class="p">,</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">num_names</span><span class="p">)</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">[</span><span class="n">name_slice</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sample_occur</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Occurrence / Encounter sampling</span>
        <span class="n">occur_texts</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_occurrence_text</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_names</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>
        <span class="n">grouped_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hierarchical_group_items</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="p">[</span><span class="n">names</span><span class="p">,</span> <span class="n">occur_texts</span><span class="p">])</span>
        <span class="c1"># ensure dictionary ordering for offset consistency</span>
        <span class="n">sgrouped_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">hmap_vals</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">,</span> <span class="n">grouped_</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">occur_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">occur_offset</span><span class="p">,</span> <span class="n">occur_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">occur_slice</span><span class="p">])</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">sgrouped_</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_offset&#39;</span><span class="p">):</span>
            <span class="c1"># TODO: num ocurrences to sample</span>
            <span class="c1"># TODO: num annots per encounter to sample</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>
        <span class="c1"># now find which groups of annotations share those tags</span>

    <span class="k">if</span> <span class="n">sample_per_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># For the query we just choose a single annot per name</span>
        <span class="c1"># For the database we have to do something different</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Order based on some preference (like random)</span>
        <span class="n">sample_seed</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">(</span><span class="s1">&#39;sample_seed&#39;</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">sample_seed</span><span class="p">)</span>
        <span class="c1"># + --- Get nested sample indicies ---</span>
        <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span> <span class="k">for</span> <span class="n">aids</span> <span class="ow">in</span> <span class="n">grouped_aids</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s1">&#39;mintime&#39;</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">unflat_get_annot_unixtimes</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span>
                <span class="n">unixtime_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s1">&#39;maxtime&#39;</span><span class="p">:</span>
            <span class="n">unixtime_list</span> <span class="o">=</span> <span class="n">unflat_get_annot_unixtimes</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
            <span class="n">preference_idxs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsort_groups</span><span class="p">(</span><span class="n">unixtime_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sample_rule</span> <span class="o">==</span> <span class="s1">&#39;qual_and_view&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">!=</span> <span class="s1">&#39;qual_and_view&#39;</span><span class="p">:</span>
                <span class="c1"># Hacked in</span>
                <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_rule&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_offset&#39;</span><span class="p">):</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_viewpoint_subset</span><span class="p">(</span>
                        <span class="n">avail_aids</span><span class="p">,</span> <span class="n">annots_per_view</span><span class="o">=</span><span class="n">sample_per_name</span>
                    <span class="p">)</span>
                    <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown sample_rule=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_rule</span><span class="p">,))</span>
        <span class="c1"># L ___</span>
        <span class="k">if</span> <span class="n">sample_rule</span> <span class="o">!=</span> <span class="s1">&#39;qual_and_view&#39;</span><span class="p">:</span>
            <span class="n">sample_idxs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">iget_list_column_slice</span><span class="p">(</span>
                    <span class="n">preference_idxs_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">sample_per_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">sample_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_ziptake</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">sample_idxs_list</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_per_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_rule&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_offset&#39;</span><span class="p">):</span>
                <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_aids</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># BUG: Should sample annots while preserving name size</span>
        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning sample size too large&#39;</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="c1"># Randomly sample names rather than annotations this makes sampling a</span>
        <span class="c1"># knapsack problem. Use a random greedy solution</span>
        <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">group_annots_by_name</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># knapsack items values and weights are are num annots per name</span>
        <span class="n">knapsack_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">),</span> <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">aids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">deterministic_shuffle</span><span class="p">(</span><span class="n">knapsack_items</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">total_value</span><span class="p">,</span> <span class="n">items_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">knapsack_greedy</span><span class="p">(</span><span class="n">knapsack_items</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
        <span class="n">group_idx_sample</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">items_subset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">subgroup_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">grouped_aids</span><span class="p">,</span> <span class="n">group_idx_sample</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;sample_size&#39;</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">subgroup_aids</span><span class="p">)</span>
            <span class="c1"># avail_aids = ut.random_sample(avail_aids, sample_size, rng=rng)</span>
        <span class="k">if</span> <span class="n">total_value</span> <span class="o">!=</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampling could not get exactly right sample size&#39;</span><span class="p">)</span>
        <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">avail_aids</span></div>


<div class="viewcode-block" id="subindex_annots"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.subindex_annots">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">subindex_annots</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">avail_aids</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">ref_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERB_TESTDATA</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns exact subindex of annotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VerbosityContext</span> <span class="o">=</span> <span class="n">verb_context</span><span class="p">(</span><span class="s1">&#39;SUBINDEX&#39;</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;shuffle&#39;</span><span class="p">]:</span>
        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">SEED2</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;shuffle&#39;</span><span class="p">,</span> <span class="n">SEED2</span><span class="o">=</span><span class="n">SEED2</span><span class="p">):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">,</span> <span class="n">rand_idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indicies</span> <span class="o">=</span> <span class="n">ensure_flatlistlike</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span>
        <span class="n">_indexed_aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">avail_aids</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">indicies</span> <span class="k">if</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">VerbosityContext</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">subset_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_indexed_aids</span><span class="p">)):</span>
            <span class="n">avail_aids</span> <span class="o">=</span> <span class="n">_indexed_aids</span>

    <span class="c1"># Always sort aids to preserve hashes? (Maybe sort the vuuids instead)</span>
    <span class="n">avail_aids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">avail_aids</span><span class="p">)</span>

    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">endfilter</span><span class="p">(</span><span class="n">withpost</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avail_aids</span></div>


<div class="viewcode-block" id="ensure_flatiterable"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.ensure_flatiterable">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">ensure_flatiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">fuzzy_int</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">input_</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="c1"># print(input_)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;cannot ensure </span><span class="si">%r</span><span class="s1"> input_=</span><span class="si">%r</span><span class="s1"> is iterable&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">input_</span><span class="p">),</span> <span class="n">input_</span><span class="p">))</span></div>


<div class="viewcode-block" id="ensure_flatlistlike"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.ensure_flatlistlike">[docs]</a><span class="k">def</span> <span class="nf">ensure_flatlistlike</span><span class="p">(</span><span class="n">input_</span><span class="p">):</span>
    <span class="c1"># if isinstance(input_, slice):</span>
    <span class="c1">#    pass</span>
    <span class="n">iter_</span> <span class="o">=</span> <span class="n">ensure_flatiterable</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_</span><span class="p">)</span></div>


<div class="viewcode-block" id="verb_context"><a class="viewcode-back" href="../../../wbia.init.html#wbia.init.filter_annots.verb_context">[docs]</a><span class="k">def</span> <span class="nf">verb_context</span><span class="p">(</span><span class="n">filtertype</span><span class="p">,</span> <span class="n">aidcfg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; closure helper &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">VerbosityContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Printing filter info in a way that avoids polluting the function</span>
<span class="sd">        namespace. This is a hack.</span>

<span class="sd">        This is a with_statement context class that expect a variable avail_aids</span>
<span class="sd">        to be modified inside the context. It prints the state of the variable</span>
<span class="sd">        before and after filtering. Several static methods can be used</span>
<span class="sd">        at the start and end of larger filtering functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">filterextra</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">dictkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nobraces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">infostr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">subdict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">aidcfg</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">infostr</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="o">**</span><span class="n">dictkw</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] * Filter by </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">infostr</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">filterextra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">infostr2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">filterextra</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]      </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">infostr2</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">num_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
                <span class="n">num_removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_before</span> <span class="o">-</span> <span class="n">num_after</span>
                <span class="k">if</span> <span class="n">num_removed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]   ... removed </span><span class="si">%d</span><span class="s1"> annots. </span><span class="si">%d</span><span class="s1"> remain&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">num_removed</span><span class="p">,</span> <span class="n">num_after</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name_suffix</span><span class="p">,</span> <span class="n">statskw</span><span class="o">=</span><span class="p">{}):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]  &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),)):</span>
                    <span class="c1"># TODO: helpx on statskw</span>
                    <span class="c1"># statskw = dict(per_name_vpedge=None, per_name=None)</span>
                    <span class="n">dict_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;aid_stats&#39;</span> <span class="o">+</span> <span class="n">name_suffix</span>
                    <span class="c1"># hashid, per_name, per_qual, per_vp, per_name_vpedge,</span>
                    <span class="c1"># per_image, min_name_hourdist</span>
                    <span class="n">ibs</span><span class="o">.</span><span class="n">print_annot_stats</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">dict_name</span><span class="p">,</span> <span class="o">**</span><span class="n">statskw</span><span class="p">)</span>

        <span class="c1"># def report_annotconfig_stats(ref_aids, aids):</span>
        <span class="c1">#    with ut.Indenter(&#39;  &#39;):</span>
        <span class="c1">#        ibs.print_annotconfig_stats(ref_aids, avail_aids)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">startfilter</span><span class="p">(</span><span class="n">withpre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Args:</span>
<span class="sd">                withpre (bool): if True reports stats before filtering</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] * [</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">AIDS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">filtertype</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">withpre</span><span class="p">:</span>
                    <span class="n">ibs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;ibs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;_pre&#39;</span><span class="p">)</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">endfilter</span><span class="p">(</span><span class="n">withpost</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">ibs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;ibs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;avail_aids&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_var_from_stack</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">hashid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_hashid_semantic_uuid</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">withpost</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">VerbosityContext</span><span class="o">.</span><span class="n">report_annot_stats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;_post&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] * HAHID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">hashid</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] * [</span><span class="si">%s</span><span class="s1">]: len(avail_</span><span class="si">%s</span><span class="s1">aids) = </span><span class="si">%r</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">filtertype</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">))</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">VerbosityContext</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.init.filter_annots</span>
<span class="sd">        python -m wbia.init.filter_annots --allexamples</span>
<span class="sd">        python -m wbia.init.filter_annots --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
