
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.algo.verif.clf_helpers &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.algo.verif.clf_helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is a work in progress, as such concepts are subject to change.</span>

<span class="sd">MAIN IDEA:</span>
<span class="sd">    `MultiTaskSamples` serves as a structure to contain and manipulate a set of</span>
<span class="sd">    samples with potentially many different types of labels and features.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>  <span class="c1"># NOQA</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ubelt</span> <span class="k">as</span> <span class="nn">ub</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">dtool</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">sklearn.metrics</span>
<span class="kn">import</span> <span class="nn">sklearn.ensemble</span>
<span class="kn">import</span> <span class="nn">sklearn.pipeline</span>
<span class="kn">import</span> <span class="nn">sklearn.neural_network</span>
<span class="kn">from</span> <span class="nn">wbia.algo.verif</span> <span class="k">import</span> <span class="n">sklearn_utils</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">range</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="XValConfig"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.XValConfig">[docs]</a><span class="k">class</span> <span class="nc">XValConfig</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">_param_info_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># ut.ParamInfo(&#39;type&#39;, &#39;StratifiedKFold&#39;),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;n_splits&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
            <span class="s1">&#39;shuffle&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span>
        <span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
            <span class="s1">&#39;random_state&#39;</span><span class="p">,</span>
            <span class="mi">3953056901</span><span class="p">,</span>
            <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="ClfProblem"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">ClfProblem</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">deploy_task_clfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_clfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">xval_kw</span> <span class="o">=</span> <span class="n">XValConfig</span><span class="p">()</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_clfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ClfProblem.set_pandas_options"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem.set_pandas_options">[docs]</a>    <span class="k">def</span> <span class="nf">set_pandas_options</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="c1"># pd.options.display.max_rows = 10</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span></div>

<div class="viewcode-block" id="ClfProblem.set_pandas_options_low"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem.set_pandas_options_low">[docs]</a>    <span class="k">def</span> <span class="nf">set_pandas_options_low</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="c1"># pd.options.display.max_rows = 10</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span></div>

<div class="viewcode-block" id="ClfProblem.set_pandas_options_normal"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem.set_pandas_options_normal">[docs]</a>    <span class="k">def</span> <span class="nf">set_pandas_options_normal</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="c1"># pd.options.display.max_rows = 10</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">160</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span></div>

<div class="viewcode-block" id="ClfProblem.learn_evaluation_classifiers"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem.learn_evaluation_classifiers">[docs]</a>    <span class="k">def</span> <span class="nf">learn_evaluation_classifiers</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">task_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clf_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates by learning classifiers using cross validation.</span>
<span class="sd">        Do not use this to learn production classifiers.</span>

<span class="sd">        python -m wbia.algo.verif.vsone evaluate_classifiers --db PZ_PB_RF_TRAIN --show</span>

<span class="sd">        Example:</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m clf_helpers learn_evaluation_classifiers</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.verif.clf_helpers import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; pblm = IrisProblem()</span>
<span class="sd">            &gt;&gt;&gt; pblm.setup()</span>
<span class="sd">            &gt;&gt;&gt; pblm.verbose = True</span>
<span class="sd">            &gt;&gt;&gt; pblm.eval_clf_keys = [&#39;Logit&#39;, &#39;RF&#39;]</span>
<span class="sd">            &gt;&gt;&gt; pblm.eval_task_keys = [&#39;iris&#39;]</span>
<span class="sd">            &gt;&gt;&gt; pblm.eval_data_keys = [&#39;learn(all)&#39;]</span>
<span class="sd">            &gt;&gt;&gt; result = pblm.learn_evaluation_classifiers()</span>
<span class="sd">            &gt;&gt;&gt; res = pblm.task_combo_res[&#39;iris&#39;][&#39;Logit&#39;][&#39;learn(all)&#39;]</span>
<span class="sd">            &gt;&gt;&gt; res.print_report()</span>
<span class="sd">            &gt;&gt;&gt; res = pblm.task_combo_res[&#39;iris&#39;][&#39;RF&#39;][&#39;learn(all)&#39;]</span>
<span class="sd">            &gt;&gt;&gt; res.print_report()</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_clfs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">AutoVivification</span><span class="p">()</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">AutoVivification</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">task_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_keys</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_keys</span>
        <span class="k">if</span> <span class="n">data_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_keys</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_data_keys</span>
        <span class="k">if</span> <span class="n">clf_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clf_keys</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">eval_clf_keys</span>

        <span class="k">if</span> <span class="n">task_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">pblm</span><span class="o">.</span><span class="n">primary_task_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clf_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clf_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pblm</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;[pblm] learn_evaluation_classifiers&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;[pblm] task_keys = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_keys</span><span class="p">))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;[pblm] data_keys = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_keys</span><span class="p">))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;[pblm] clf_keys = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clf_keys</span><span class="p">))</span>

        <span class="n">Prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prehack</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">task_prog</span> <span class="o">=</span> <span class="n">Prog</span><span class="p">(</span><span class="n">task_keys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Task&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">task_prog</span><span class="p">:</span>
            <span class="n">dataset_prog</span> <span class="o">=</span> <span class="n">Prog</span><span class="p">(</span><span class="n">data_keys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">data_key</span> <span class="ow">in</span> <span class="n">dataset_prog</span><span class="p">:</span>
                <span class="n">clf_prog</span> <span class="o">=</span> <span class="n">Prog</span><span class="p">(</span><span class="n">clf_keys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;CLF&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">clf_key</span> <span class="ow">in</span> <span class="n">clf_prog</span><span class="p">:</span>
                    <span class="n">pblm</span><span class="o">.</span><span class="n">_ensure_evaluation_clf</span><span class="p">(</span><span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_ensure_evaluation_clf</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Learns and caches an evaluation (cross-validated) classifier and tests</span>
<span class="sd">        and caches the results.</span>

<span class="sd">        data_key = &#39;learn(sum,glob)&#39;</span>
<span class="sd">        clf_key = &#39;RF&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: add in params used to construct features into the cfgstr</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;sample_hashid&#39;</span><span class="p">):</span>
            <span class="n">ibs</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">infr</span><span class="o">.</span><span class="n">ibs</span>
            <span class="n">sample_hashid</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">sample_hashid</span><span class="p">()</span>

            <span class="n">feat_dims</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c1"># cfg_prefix = sample_hashid + pblm.qreq_.get_cfgstr() + feat_cfgstr</span>

            <span class="n">est_kw1</span><span class="p">,</span> <span class="n">est_kw2</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_estimator_params</span><span class="p">(</span><span class="n">clf_key</span><span class="p">)</span>
            <span class="n">param_id</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_dict_hashid</span><span class="p">(</span><span class="n">est_kw1</span><span class="p">)</span>
            <span class="n">xval_id</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">xval_kw</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">sample_hashid</span><span class="p">,</span>
                    <span class="n">param_id</span><span class="p">,</span>
                    <span class="n">xval_id</span><span class="p">,</span>
                    <span class="n">task_key</span><span class="p">,</span>
                    <span class="n">data_key</span><span class="p">,</span>
                    <span class="n">clf_key</span><span class="p">,</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">hashid_arr</span><span class="p">(</span><span class="n">feat_dims</span><span class="p">,</span> <span class="s1">&#39;feats&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;eval_clfres_&#39;</span> <span class="o">+</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
            <span class="n">feat_dims</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
            <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># TODO: ABI class should not be caching</span>
        <span class="n">cacher_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;vsone_rf_train&#39;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">use_cache</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cacher_clf</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">Cacher</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">[</span><span class="n">feat_dims</span><span class="p">],</span> <span class="o">**</span><span class="n">cacher_kw</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">cacher_clf</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_train_evaluation_clf</span><span class="p">(</span><span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">)</span>
            <span class="n">cacher_clf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">clf_list</span><span class="p">,</span> <span class="n">res_list</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
        <span class="n">combo_res</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">combine_results</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">eval_task_clfs</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf_list</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">task_combo_res</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">combo_res</span>

    <span class="k">def</span> <span class="nf">_train_evaluation_clf</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Learns a cross-validated classifier on the dataset</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.verif.vsone import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; pblm = OneVsOneProblem()</span>
<span class="sd">            &gt;&gt;&gt; pblm.load_features()</span>
<span class="sd">            &gt;&gt;&gt; pblm.load_samples()</span>
<span class="sd">            &gt;&gt;&gt; data_key = &#39;learn(all)&#39;</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;photobomb_state&#39;</span>
<span class="sd">            &gt;&gt;&gt; clf_key = &#39;RF-OVR&#39;</span>
<span class="sd">            &gt;&gt;&gt; task_key = &#39;match_state&#39;</span>
<span class="sd">            &gt;&gt;&gt; data_key = pblm.default_data_key</span>
<span class="sd">            &gt;&gt;&gt; clf_key = pblm.default_clf_key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_df</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">clf_partial</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_get_estimator</span><span class="p">(</span><span class="n">clf_key</span><span class="p">)</span>
        <span class="n">xval_kw</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">xval_kw</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>

        <span class="n">clf_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skf_list</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">stratified_kfold_indices</span><span class="p">(</span><span class="o">**</span><span class="n">xval_kw</span><span class="p">)</span>
        <span class="n">skf_prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">skf_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;skf-train-eval&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="ow">in</span> <span class="n">skf_prog</span><span class="p">:</span>
            <span class="n">X_df_train</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">X_df_train</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_idx</span><span class="p">)</span>
            <span class="c1"># train_uv = X_df.iloc[train_idx].index</span>
            <span class="c1"># X_train = X_df.loc[train_uv]</span>
            <span class="c1"># y_train = labels.encoded_df.loc[train_uv]</span>

            <span class="k">if</span> <span class="n">feat_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X_df_train</span> <span class="o">=</span> <span class="n">X_df_train</span><span class="p">[</span><span class="n">feat_dims</span><span class="p">]</span>

            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_df_train</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="n">clf</span> <span class="o">=</span> <span class="n">clf_partial</span><span class="p">()</span>
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

            <span class="c1"># Note: There is a corner case where one fold doesn&#39;t get any</span>
            <span class="c1"># labels of a certain class. Because y_train is an encoded integer,</span>
            <span class="c1"># the clf.classes_ attribute will cause predictions to agree with</span>
            <span class="c1"># other classifiers trained on the same labels.</span>

            <span class="c1"># Evaluate results</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">make_single</span><span class="p">(</span>
                <span class="n">clf</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="o">=</span><span class="n">feat_dims</span>
            <span class="p">)</span>
            <span class="n">clf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clf_list</span><span class="p">,</span> <span class="n">res_list</span>

    <span class="k">def</span> <span class="nf">_external_classifier_result</span><span class="p">(</span>
        <span class="n">pblm</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_idx</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an external classifier (ensure its trained on disjoint data)</span>
<span class="sd">        evaluate all data on it.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_idx (list): subset of this classifier to test on</span>
<span class="sd">                (defaults to all if None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_df</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">make_single</span><span class="p">(</span>
            <span class="n">clf</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="o">=</span><span class="n">feat_dims</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="ClfProblem.learn_deploy_classifiers"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfProblem.learn_deploy_classifiers">[docs]</a>    <span class="k">def</span> <span class="nf">learn_deploy_classifiers</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">task_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clf_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Learns on data without any train/validation split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pblm</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;[pblm] learn_deploy_classifiers&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clf_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clf_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span>
        <span class="k">if</span> <span class="n">data_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="k">if</span> <span class="n">task_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">supported_tasks</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">pblm</span><span class="o">.</span><span class="n">deploy_task_clfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">deploy_task_clfs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">AutoVivification</span><span class="p">()</span>

        <span class="n">Prog</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgPartial</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prehack</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">task_prog</span> <span class="o">=</span> <span class="n">Prog</span><span class="p">(</span><span class="n">task_keys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Task&#39;</span><span class="p">)</span>
        <span class="n">task_clfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">task_key</span> <span class="ow">in</span> <span class="n">task_prog</span><span class="p">:</span>
            <span class="n">clf</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_train_deploy_clf</span><span class="p">(</span><span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">)</span>
            <span class="n">task_clfs</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>
            <span class="n">pblm</span><span class="o">.</span><span class="n">deploy_task_clfs</span><span class="p">[</span><span class="n">task_key</span><span class="p">][</span><span class="n">clf_key</span><span class="p">][</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>

        <span class="k">return</span> <span class="n">task_clfs</span></div>

    <span class="k">def</span> <span class="nf">_estimator_params</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">):</span>
        <span class="n">est_type</span> <span class="o">=</span> <span class="n">clf_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">est_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span> <span class="s1">&#39;RandomForest&#39;</span><span class="p">}:</span>
            <span class="n">est_kw1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># &#39;max_depth&#39;: 4,</span>
                <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;class_weight&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;criterion&#39;</span><span class="p">:</span> <span class="s1">&#39;entropy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span>
                <span class="c1"># &#39;max_features&#39;: None,</span>
                <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="c1"># &#39;n_estimators&#39;: 64,</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># Hack to only use missing values if we have the right sklearn</span>
            <span class="k">if</span> <span class="s1">&#39;missing_values&#39;</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_kwargs</span><span class="p">(</span>
                <span class="n">sklearn</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestClassifier</span><span class="o">.</span><span class="fm">__init__</span>
            <span class="p">):</span>
                <span class="n">est_kw1</span><span class="p">[</span><span class="s1">&#39;missing_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">est_kw2</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">3915904814</span><span class="p">,</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">est_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;SVC&#39;</span><span class="p">,</span> <span class="s1">&#39;SVM&#39;</span><span class="p">}:</span>
            <span class="n">est_kw1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">est_kw2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">est_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Logit&#39;</span><span class="p">,</span> <span class="s1">&#39;LogisticRegression&#39;</span><span class="p">}:</span>
            <span class="n">est_kw1</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">est_kw2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">est_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;MLP&#39;</span><span class="p">}:</span>
            <span class="n">est_kw1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                <span class="n">beta_1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">beta_2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
                <span class="n">early_stopping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">,</span>
                <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
                <span class="n">learning_rate_init</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">nesterovs_momentum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">power_t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">3915904814</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
                <span class="n">validation_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">warm_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">est_kw2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unknown Estimator&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">est_kw1</span><span class="p">,</span> <span class="n">est_kw2</span>

    <span class="k">def</span> <span class="nf">_get_estimator</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns sklearn classifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">clf_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">wrap_type</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">est_type</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">multiclass_wrapper</span> <span class="o">=</span> <span class="p">{</span>
            <span class="kc">None</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span>
            <span class="s1">&#39;OVR&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">multiclass</span><span class="o">.</span><span class="n">OneVsRestClassifier</span><span class="p">,</span>
            <span class="s1">&#39;OVO&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">multiclass</span><span class="o">.</span><span class="n">OneVsOneClassifier</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">wrap_type</span><span class="p">]</span>
        <span class="n">est_class</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestClassifier</span><span class="p">,</span>
            <span class="s1">&#39;SVC&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">,</span>
            <span class="s1">&#39;Logit&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">,</span>
            <span class="s1">&#39;MLP&#39;</span><span class="p">:</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">neural_network</span><span class="o">.</span><span class="n">MLPClassifier</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">est_type</span><span class="p">]</span>

        <span class="n">est_kw1</span><span class="p">,</span> <span class="n">est_kw2</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_estimator_params</span><span class="p">(</span><span class="n">est_type</span><span class="p">)</span>
        <span class="n">est_params</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">(</span><span class="n">est_kw1</span><span class="p">,</span> <span class="n">est_kw2</span><span class="p">)</span>

        <span class="c1"># steps = []</span>
        <span class="c1"># steps.append((est_type, est_class(**est_params)))</span>
        <span class="c1"># if wrap_type is not None:</span>
        <span class="c1">#     steps.append((wrap_type, multiclass_wrapper))</span>
        <span class="k">if</span> <span class="n">est_type</span> <span class="o">==</span> <span class="s1">&#39;MLP&#39;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">clf_partial</span><span class="p">():</span>
                <span class="n">pipe</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="s1">&#39;inputer&#39;</span><span class="p">,</span>
                            <span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Imputer</span><span class="p">(</span>
                                <span class="n">missing_values</span><span class="o">=</span><span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="c1"># (&#39;scale&#39;, sklearn.preprocessing.StandardScaler),</span>
                        <span class="p">(</span><span class="s1">&#39;est&#39;</span><span class="p">,</span> <span class="n">est_class</span><span class="p">(</span><span class="o">**</span><span class="n">est_params</span><span class="p">)),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">multiclass_wrapper</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">est_type</span> <span class="o">==</span> <span class="s1">&#39;Logit&#39;</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">clf_partial</span><span class="p">():</span>
                <span class="n">pipe</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="s1">&#39;inputer&#39;</span><span class="p">,</span>
                            <span class="n">sklearn</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Imputer</span><span class="p">(</span>
                                <span class="n">missing_values</span><span class="o">=</span><span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;est&#39;</span><span class="p">,</span> <span class="n">est_class</span><span class="p">(</span><span class="o">**</span><span class="n">est_params</span><span class="p">)),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">multiclass_wrapper</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">clf_partial</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">multiclass_wrapper</span><span class="p">(</span><span class="n">est_class</span><span class="p">(</span><span class="o">**</span><span class="n">est_params</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">clf_partial</span>

    <span class="k">def</span> <span class="nf">_train_deploy_clf</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">clf_key</span><span class="p">):</span>
        <span class="n">X_df</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">clf_partial</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_get_estimator</span><span class="p">(</span><span class="n">clf_key</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Training deployment </span><span class="si">{}</span><span class="s1"> classifier on </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">clf_key</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">task_key</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">clf_partial</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clf</span>

    <span class="k">def</span> <span class="nf">_optimize_rf_hyperparams</span><span class="p">(</span><span class="n">pblm</span><span class="p">,</span> <span class="n">data_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper script I&#39;ve only run interactively</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.verif.vsone import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; pblm = OneVsOneProblem.from_empty(&#39;PZ_PB_RF_TRAIN&#39;)</span>
<span class="sd">            #&gt;&gt;&gt; pblm = OneVsOneProblem.from_empty(&#39;GZ_Master1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; pblm.load_samples()</span>
<span class="sd">            &gt;&gt;&gt; pblm.load_features()</span>
<span class="sd">            &gt;&gt;&gt; pblm.build_feature_subsets()</span>
<span class="sd">            &gt;&gt;&gt; data_key=None</span>
<span class="sd">            &gt;&gt;&gt; task_key=None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">RandomizedSearchCV</span>  <span class="c1"># NOQA</span>
        <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">GridSearchCV</span>  <span class="c1"># NOQA</span>
        <span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>
        <span class="kn">from</span> <span class="nn">wbia.algo.verif</span> <span class="k">import</span> <span class="n">sklearn_utils</span>

        <span class="k">if</span> <span class="n">data_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="k">if</span> <span class="n">task_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">primary_task_key</span>

        <span class="c1"># Load data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span><span class="o">.</span><span class="n">y_enc</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">group_ids</span>

        <span class="c1"># Define estimator and parameter search space</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="s1">&#39;class_weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;balanced&#39;</span><span class="p">],</span>
            <span class="s1">&#39;criterion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">,</span> <span class="s1">&#39;gini&#39;</span><span class="p">],</span>
            <span class="c1"># &#39;max_features&#39;: [&#39;sqrt&#39;, &#39;log2&#39;],</span>
            <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">],</span>
            <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)),</span>
            <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)),</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># debug</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_dict</span><span class="o">.</span><span class="n">all_dict_combinations</span><span class="p">(</span><span class="n">grid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">est</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">est</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">StratifiedGroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="n">SearchCV</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">RandomizedSearchCV</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">SearchCV</span> <span class="o">=</span> <span class="n">GridSearchCV</span>

        <span class="n">search</span> <span class="o">=</span> <span class="n">SearchCV</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">n_cpus</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">num_cpus</span><span class="p">()</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">n_cpus</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">n_jobs_est</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_jobs_ser</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_iter</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="n">n_jobs_est</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">/</span> <span class="n">n_iter</span><span class="p">))</span>
        <span class="n">est</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs_est</span><span class="p">)</span>
        <span class="n">search</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs_ser</span><span class="p">)</span>

        <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">cv_results_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;rank_test_score&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">,</span> <span class="s1">&#39;μ-test&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;std_test_score&#39;</span><span class="p">,</span> <span class="s1">&#39;σ-test&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;mean_train_score&#39;</span><span class="p">,</span> <span class="s1">&#39;μ-train&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;std_train_score&#39;</span><span class="p">,</span> <span class="s1">&#39;σ-train&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;mean_fit_time&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_time&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">alias</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">cvresult_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">cvresult_df</span> <span class="o">=</span> <span class="n">cvresult_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cvresult_df</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Varied params:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ranked Params&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ranked scores on development set:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cvresult_df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best parameters set found on hyperparam set:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best_params_ = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">),))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fastest params&#39;</span><span class="p">)</span>
        <span class="n">cvresult_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cvresult_df</span><span class="p">[</span><span class="s1">&#39;fit_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_dev_calib</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        interactive script only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>
        <span class="kn">from</span> <span class="nn">sklearn.calibration</span> <span class="k">import</span> <span class="n">CalibratedClassifierCV</span>
        <span class="kn">from</span> <span class="nn">sklearn.calibration</span> <span class="k">import</span> <span class="n">calibration_curve</span>
        <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">log_loss</span><span class="p">,</span> <span class="n">brier_score_loss</span>

        <span class="c1"># Load data</span>
        <span class="n">data_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span>
        <span class="n">task_key</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">primary_task_key</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span><span class="o">.</span><span class="n">y_enc</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">group_ids</span>

        <span class="c1"># Split into test/train/valid</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">StratifiedGroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">test_idx</span><span class="p">,</span> <span class="n">train_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">))</span>
        <span class="c1"># valid_idx = train_idx[0::2]</span>
        <span class="c1"># train_idx = train_idx[1::2]</span>
        <span class="c1"># train_valid_idx = np.hstack([train_idx, valid_idx])</span>

        <span class="c1"># Train Uncalibrated RF</span>
        <span class="n">est_kw</span> <span class="o">=</span> <span class="n">pblm</span><span class="o">.</span><span class="n">_estimator_params</span><span class="p">(</span><span class="s1">&#39;RF&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uncal_clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">est_kw</span><span class="p">)</span>
        <span class="n">uncal_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">])</span>
        <span class="n">uncal_probs</span> <span class="o">=</span> <span class="n">uncal_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">uncal_score</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">uncal_probs</span><span class="p">)</span>
        <span class="n">uncal_brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">uncal_probs</span><span class="p">)</span>

        <span class="c1"># Train Calibrated RF</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;isotonic&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span> <span class="k">else</span> <span class="s1">&#39;sigmoid&#39;</span>
        <span class="n">precal_clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">est_kw</span><span class="p">)</span>
        <span class="c1"># cv = sklearn_utils.StratifiedGroupKFold(n_splits=3)</span>
        <span class="n">cal_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">precal_clf</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="n">cal_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">])</span>
        <span class="n">cal_probs</span> <span class="o">=</span> <span class="n">cal_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cal_score</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cal_probs</span><span class="p">)</span>
        <span class="n">cal_brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cal_probs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cal_brier = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_brier</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;uncal_brier = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uncal_brier</span><span class="p">,))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;uncal_score = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uncal_score</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cal_score = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cal_score</span><span class="p">,))</span>

        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">qtensure</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">fraction_of_positives</span><span class="p">,</span> <span class="n">mean_predicted_value</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span>
            <span class="n">y_test</span><span class="p">,</span> <span class="n">uncal_probs</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Perfectly calibrated&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">mean_predicted_value</span><span class="p">,</span>
            <span class="n">fraction_of_positives</span><span class="p">,</span>
            <span class="s1">&#39;s-&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%1.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;uncal-RF&#39;</span><span class="p">,</span> <span class="n">uncal_brier</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">fraction_of_positives</span><span class="p">,</span> <span class="n">mean_predicted_value</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span>
            <span class="n">y_test</span><span class="p">,</span> <span class="n">cal_probs</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">mean_predicted_value</span><span class="p">,</span>
            <span class="n">fraction_of_positives</span><span class="p">,</span>
            <span class="s1">&#39;s-&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%1.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;cal-RF&#39;</span><span class="p">,</span> <span class="n">cal_brier</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>


<div class="viewcode-block" id="ClfResult"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">ClfResult</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles evaluation statistics for a multiclass classifier trained on a</span>
<span class="sd">    specific dataset with specific labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Attributes that identify the task and data the classifier is evaluated on</span>
    <span class="n">_key_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;task_key&#39;</span><span class="p">,</span> <span class="s1">&#39;data_key&#39;</span><span class="p">,</span> <span class="s1">&#39;class_names&#39;</span><span class="p">]</span>

    <span class="c1"># Attributes about results and labels of individual samples</span>
    <span class="n">_datafame_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;probs_df&#39;</span><span class="p">,</span> <span class="s1">&#39;probhats_df&#39;</span><span class="p">,</span> <span class="s1">&#39;target_bin_df&#39;</span><span class="p">,</span> <span class="s1">&#39;target_enc_df&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">task_key</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">data_key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">index</span>

<div class="viewcode-block" id="ClfResult.make_single"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.make_single">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_single</span><span class="p">(</span><span class="n">ClfResult</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span> <span class="n">X_df</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">data_key</span><span class="p">,</span> <span class="n">feat_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a result for a single cross validiation subset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_df_test</span> <span class="o">=</span> <span class="n">X_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">feat_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_df_test</span> <span class="o">=</span> <span class="n">X_df_test</span><span class="p">[</span><span class="n">feat_dims</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">X_df_test</span><span class="o">.</span><span class="n">index</span>
        <span class="c1"># clf_probs = clf.predict_proba(X_df_test)</span>

        <span class="c1"># index = pd.Series(test_idx, name=&#39;test_idx&#39;)</span>
        <span class="c1"># Ensure shape corresponds with all classes</span>

        <span class="k">def</span> <span class="nf">align_cols</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr_cols</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">alignx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_alignment</span><span class="p">(</span><span class="n">arr_cols</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">aligned_arrT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">none_take</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">alignx</span><span class="p">)</span>
            <span class="n">aligned_arrT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">aligned_arrT</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span>
            <span class="n">aligned_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">aligned_arrT</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">aligned_arr</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">task_key</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">task_name</span>
        <span class="n">res</span><span class="o">.</span><span class="n">data_key</span> <span class="o">=</span> <span class="n">data_key</span>
        <span class="n">res</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">feat_dims</span> <span class="o">=</span> <span class="n">feat_dims</span>

        <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">predict_proba_df</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_df_test</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="s1">&#39;estimators_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># The n-th estimator in the OVR classifier predicts the prob of the</span>
            <span class="c1"># n-th class (as label 1).</span>
            <span class="n">probs_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">[</span><span class="n">est</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_df_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">align_cols</span><span class="p">(</span><span class="n">probs_hat</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">classes_</span><span class="p">),</span>
                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># In the OVR-case, ideally things will sum to 1, but when they</span>
            <span class="c1"># don&#39;t normalization happens. An Z-value of more than 1 means</span>
            <span class="c1"># overconfidence, and under 0 means underconfidence.</span>
            <span class="n">res</span><span class="o">.</span><span class="n">confidence_ratio</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ClfResult.compress"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="n">res2</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="p">()</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">task_key</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">task_key</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">data_key</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">data_key</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">probs_df</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">target_bin_df</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>
        <span class="n">res2</span><span class="o">.</span><span class="n">target_enc_df</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res2</span><span class="o">.</span><span class="n">probhats_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res2</span><span class="o">.</span><span class="n">probhats_df</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>
            <span class="c1"># res2.confidence_ratio = res.confidence_ratio[flags]</span>
        <span class="k">return</span> <span class="n">res2</span></div>

<div class="viewcode-block" id="ClfResult.combine_results"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.combine_results">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">combine_results</span><span class="p">(</span><span class="n">ClfResult</span><span class="p">,</span> <span class="n">res_list</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine results from cross validation runs into a single result</span>
<span class="sd">        representing the performance of the entire dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure that res_lists are not overlapping</span>
        <span class="k">for</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">res_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">),</span> <span class="s1">&#39;ClfResult dataframes must be disjoint&#39;</span>
        <span class="c1"># sanity check</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">target_enc_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Combine them with pandas</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ClfResult</span><span class="p">()</span>
        <span class="n">res0</span> <span class="o">=</span> <span class="n">res_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Transfer single attributes (which should all be the same)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">_key_attrs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res0</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">]</span>
            <span class="p">),</span> <span class="s1">&#39;ClfResult with different key attributes are incompatible&#39;</span>
        <span class="c1"># Combine dataframe properties (which should all have disjoint indices)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">_datafame_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res0</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combo_attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">])</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">combo_attr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ClfResult</span><span class="o">.</span><span class="n">_datafame_attrs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;index got weird&#39;</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ClfResult.hardness_analysis"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.hardness_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">hardness_analysis</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">infr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;argmax&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        samples = pblm.samples</span>

<span class="sd">        # TODO MWE with sklearn data</span>

<span class="sd">            # ClfResult.make_single(ClfResult, clf, X_df, test_idx, labels,</span>
<span class="sd">            # data_key, feat_dims=None):</span>

<span class="sd">            import sklearn.datasets</span>
<span class="sd">            iris = sklearn.datasets.load_iris()</span>

<span class="sd">            # TODO: make this setup simpler</span>
<span class="sd">            pblm = ClfProblem()</span>
<span class="sd">            task_key, clf_key, data_key = &#39;iris&#39;, &#39;RF&#39;, &#39;learn(all)&#39;</span>
<span class="sd">            X_df = pd.DataFrame(iris.data, columns=iris.feature_names)</span>
<span class="sd">            samples = MultiTaskSamples(X_df.index)</span>
<span class="sd">            samples.apply_indicators({&#39;iris&#39;: {name: iris.target == idx</span>
<span class="sd">                         for idx, name in enumerate(iris.target_names)}})</span>
<span class="sd">            samples.X_dict = {&#39;learn(all)&#39;: X_df}</span>

<span class="sd">            pblm.samples = samples</span>
<span class="sd">            pblm.xval_kw[&#39;type&#39;] = &#39;StratifiedKFold&#39;</span>
<span class="sd">            clf_list, res_list = pblm._train_evaluation_clf(</span>
<span class="sd">                task_key, data_key, clf_key)</span>
<span class="sd">            labels = pblm.samples.subtasks[task_key]</span>
<span class="sd">            res = ClfResult.combine_results(res_list, labels)</span>


<span class="sd">        res.get_thresholds(&#39;mcc&#39;, &#39;maximize&#39;)</span>

<span class="sd">        predict_method = &#39;argmax&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">easiness</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># pred = sklearn_utils.predict_from_probs(res.probs_df, predict_method)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;max-mcc&#39;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_thresholds</span><span class="p">(</span><span class="s1">&#39;mcc&#39;</span><span class="p">,</span> <span class="s1">&#39;maximize&#39;</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">predict_from_probs</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;easiness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">easiness</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;hardness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;easiness&#39;</span><span class="p">]</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;aid1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;aid2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># meta[&#39;aid1&#39;] = samples.aid_pairs.T[0].take(res.probs_df.index.values)</span>
        <span class="c1"># meta[&#39;aid2&#39;] = samples.aid_pairs.T[1].take(res.probs_df.index.values)</span>
        <span class="c1"># meta[&#39;pred&#39;] = res.probs_df.values.argmax(axis=1)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">values</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;aid1&#39;</span><span class="p">,</span> <span class="s1">&#39;aid2&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">infr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ibs</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">ibs</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">conf_dict</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">get_edge_attrs</span><span class="p">(</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">,</span>
                <span class="n">edges</span><span class="p">,</span>
                <span class="n">on_missing</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">conf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">conf_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">conf_df</span> <span class="o">=</span> <span class="n">conf_df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">real_conf</span><span class="o">=</span><span class="n">conf_df</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;real_conf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;real_conf&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;hardness&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">meta</span></div>

<div class="viewcode-block" id="ClfResult.missing_classes"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.missing_classes">[docs]</a>    <span class="k">def</span> <span class="nf">missing_classes</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="c1"># Find classes that were never predicted</span>
        <span class="n">unique_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
        <span class="n">missing_classes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">unique_predictions</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">missing_classes</span></div>

<div class="viewcode-block" id="ClfResult.augment_if_needed"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.augment_if_needed">[docs]</a>    <span class="k">def</span> <span class="nf">augment_if_needed</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds in dummy values for missing classes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_classes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">missing_classes</span><span class="p">()</span>
        <span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
        <span class="n">y_test_enc_aug</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_enc_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_test_bin_aug</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">clf_probs_aug</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_enc_aug</span><span class="p">))</span>
        <span class="n">n_missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_classes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clf_probhats_aug</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clf_probhats_aug</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Check if augmentation is necessary</span>
        <span class="k">if</span> <span class="n">n_missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">missing_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_missing</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">))</span>
            <span class="n">missing_bin</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_missing</span><span class="p">),</span> <span class="n">missing_classes</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">missing_enc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">missing_classes</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">y_test_enc_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y_test_enc_aug</span><span class="p">,</span> <span class="n">missing_enc</span><span class="p">])</span>
            <span class="n">y_test_bin_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">y_test_bin_aug</span><span class="p">,</span> <span class="n">missing_bin</span><span class="p">])</span>
            <span class="n">clf_probs_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">clf_probs_aug</span><span class="p">,</span> <span class="n">missing_bin</span><span class="p">])</span>
            <span class="c1"># make sample weights where dummies have no weight</span>
            <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">sample_weight</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_missing</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>

            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clf_probhats_aug</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">clf_probhats_aug</span><span class="p">,</span> <span class="n">missing_bin</span><span class="p">])</span>

        <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span> <span class="o">=</span> <span class="n">clf_probs_aug</span>
        <span class="n">res</span><span class="o">.</span><span class="n">clf_probhats</span> <span class="o">=</span> <span class="n">clf_probhats_aug</span>
        <span class="n">res</span><span class="o">.</span><span class="n">y_test_enc</span> <span class="o">=</span> <span class="n">y_test_enc_aug</span>
        <span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span> <span class="o">=</span> <span class="n">y_test_bin_aug</span>
        <span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span> <span class="o">=</span> <span class="n">sample_weight</span></div>

<div class="viewcode-block" id="ClfResult.extended_clf_report"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.extended_clf_report">[docs]</a>    <span class="k">def</span> <span class="nf">extended_clf_report</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">pred_enc</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pred_enc</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_enc</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span>
        <span class="n">target_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">classification_report2</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span>
            <span class="n">y_pred</span><span class="p">,</span>
            <span class="n">target_names</span><span class="o">=</span><span class="n">target_names</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span></div>

<div class="viewcode-block" id="ClfResult.print_report"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.print_report">[docs]</a>    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">pred_enc</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">extended_clf_report</span><span class="p">()</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span>
            <span class="n">y_true</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">y_test_enc</span><span class="p">,</span>
            <span class="n">y_pred</span><span class="o">=</span><span class="n">pred_enc</span><span class="p">,</span>
            <span class="n">target_names</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision/Recall Report:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClfResult.get_thresholds"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.get_thresholds">[docs]</a>    <span class="k">def</span> <span class="nf">get_thresholds</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;mcc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_metric = &#39;thresholds&#39;</span>
<span class="sd">        at_metric = metric = &#39;mcc&#39;</span>
<span class="sd">        at_value = value = &#39;maximize&#39;</span>

<span class="sd">        a = []</span>
<span class="sd">        b = []</span>
<span class="sd">        for x in np.linspace(0, 1, 1000):</span>
<span class="sd">            a += [cfms.get_metric_at_metric(&#39;thresholds&#39;, &#39;fpr&#39;, x, subindex=True)]</span>
<span class="sd">            b += [cfms.get_thresh_at_metric(&#39;fpr&#39;, x)]</span>
<span class="sd">        a = np.array(a)</span>
<span class="sd">        b = np.array(b)</span>
<span class="sd">        d = (a - b)</span>
<span class="sd">        print((d.min(), d.max()))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">:</span>
            <span class="n">cfms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="n">cfms</span><span class="o">.</span><span class="n">get_metric_at_metric</span><span class="p">(</span><span class="s1">&#39;thresh&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">threshes</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>
        <span class="k">return</span> <span class="n">threshes</span></div>

<div class="viewcode-block" id="ClfResult.get_pos_threshes"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.get_pos_threshes">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_pos_threshes</span><span class="p">(</span>
        <span class="n">res</span><span class="p">,</span>
        <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">maximize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">warmup</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds a threshold that achieves the desired `value` for the desired</span>
<span class="sd">        metric, while maximizing or minimizing the threshold.</span>

<span class="sd">        For positive classification you want to minimize the threshold.</span>
<span class="sd">        Priors can be passed in to augment probabilities depending on support.</span>
<span class="sd">        By default a class prior is 1 for threshold minimization and 0 for</span>
<span class="sd">        maximization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_threshes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">priors</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="ow">not</span> <span class="n">maximize</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">:</span>
            <span class="n">cfms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>

            <span class="n">learned_thresh</span> <span class="o">=</span> <span class="n">cfms</span><span class="o">.</span><span class="n">get_metric_at_metric</span><span class="p">(</span><span class="s1">&#39;thresh&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># learned_thresh = cfms.get_thresh_at_metric(</span>
            <span class="c1">#     metric, value, maximize=maximize)</span>

            <span class="n">prior_thresh</span> <span class="o">=</span> <span class="n">priors</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">n_support</span> <span class="o">=</span> <span class="n">cfms</span><span class="o">.</span><span class="n">n_pos</span>

            <span class="k">if</span> <span class="n">warmup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                python -m wbia.plottool.draw_func2 plot_func --show --range=0,1 \</span>
<span class="sd">                        --func=&quot;lambda x: np.maximum(0, (x - .6) / (1 - .6))&quot;</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># If n_support &lt; warmup: then interpolate to learned thresh</span>
                <span class="n">nmax</span> <span class="o">=</span> <span class="n">warmup</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warmup</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">warmup</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
                <span class="c1"># alpha varies from 0 to 1</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">n_support</span><span class="p">)</span> <span class="o">/</span> <span class="n">nmax</span>
                <span class="c1"># transform alpha through nonlinear function (similar to ReLU)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mf">0.6</span>  <span class="c1"># transition point</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">prior_thresh</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">learned_thresh</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">learned_thresh</span>
            <span class="n">pos_threshes</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_thresh</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos_threshes</span></div>

<div class="viewcode-block" id="ClfResult.report_thresholds"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.report_thresholds">[docs]</a>    <span class="k">def</span> <span class="nf">report_thresholds</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="c1"># import vtool as vt</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Threshold Report&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
        <span class="n">y_test_bin</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># y_test_enc = y_test_bin.argmax(axis=1)</span>
        <span class="c1"># clf_probs = res.probs_df.values</span>

        <span class="c1"># The maximum allowed false positive rate</span>
        <span class="c1"># We expect that we will make 1 error every 1,000 decisions</span>
        <span class="c1"># thresh_df[&#39;foo&#39;] = [1, 2, 3]</span>
        <span class="c1"># thresh_df[&#39;foo&#39;][res.class_names[k]] = 1</span>

        <span class="c1"># for k in [2, 0, 1]:</span>
        <span class="n">choice_mv</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;@fpr=.01&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;@fpr=.001&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;@fpr=.0001&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;@fpr=.0000&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;@max(mcc)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;mcc&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)),</span>
                <span class="c1"># (class_name + &#39;@max(acc)&#39;, (&#39;acc&#39;, &#39;max&#39;)),</span>
                <span class="c1"># (class_name + &#39;@max(mk)&#39;, (&#39;mk&#39;, &#39;max&#39;)),</span>
                <span class="c1"># (class_name + &#39;@max(bm)&#39;, (&#39;bm&#39;, &#39;max&#39;)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">thresh_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">cfms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="c1"># probs, labels = clf_probs.T[k], y_test_bin.T[k]</span>
            <span class="c1"># cfms = vt.ConfusionMetrics().fit(probs, labels)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">choice_mv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">mv</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">cfms</span><span class="o">.</span><span class="n">get_index_at_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">class_name</span> <span class="o">+</span> <span class="n">k</span>
                <span class="n">thresh_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="s1">&#39;tpr&#39;</span><span class="p">,</span> <span class="s1">&#39;tpa&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;mk&#39;</span><span class="p">,</span> <span class="s1">&#39;mcc&#39;</span><span class="p">]:</span>
                    <span class="n">thresh_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfms</span><span class="o">.</span><span class="n">get_metric_at_index</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">thresh_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">thresh_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">thresh_df</span> <span class="o">=</span> <span class="n">thresh_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">thresh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="k">if</span> <span class="n">cfms</span><span class="o">.</span><span class="n">n_pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cfms</span><span class="o">.</span><span class="n">n_neg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Raw 1vR </span><span class="si">{}</span><span class="s1"> Thresholds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">thresh_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)))</span>
                <span class="c1"># chosen_type = class_name + &#39;@fpr=0&#39;</span>
                <span class="c1"># pos_threshes[class_name] = thresh_df.loc[chosen_type][&#39;thresh&#39;]</span>

        <span class="k">for</span> <span class="n">choice_k</span><span class="p">,</span> <span class="n">choice_mv</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">choice_mv</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">choice_mv</span>
            <span class="n">pos_threshes</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_pos_threshes</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="n">warmup</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Choosing threshold based on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">choice_k</span><span class="p">,))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">report_auto_thresholds</span><span class="p">(</span><span class="n">pos_threshes</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClfResult.report_auto_thresholds"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.report_auto_thresholds">[docs]</a>    <span class="k">def</span> <span class="nf">report_auto_thresholds</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">threshes</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">report_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">print_</span> <span class="o">=</span> <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">print_</span><span class="p">(</span>
            <span class="s1">&#39;Chosen thresholds = </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">threshes</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">),)</span>
        <span class="p">)</span>

        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">target_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span>
        <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_enc</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y_pred</span><span class="p">,</span> <span class="n">can_autodecide</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">predict_from_probs</span><span class="p">(</span>
            <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="p">,</span>
            <span class="n">threshes</span><span class="p">,</span>
            <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">can_autodecide</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">sample_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">auto_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">can_autodecide</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">auto_true</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">can_autodecide</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">auto_probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="p">[</span><span class="n">can_autodecide</span><span class="p">]</span>

        <span class="n">total_cases</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_weight</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">print_</span><span class="p">(</span><span class="s1">&#39;Will autodecide for </span><span class="si">%r</span><span class="s1">/</span><span class="si">%r</span><span class="s1"> cases&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">can_autodecide</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">total_cases</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">frac_str</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1"> = </span><span class="si">{:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">y_test_bin</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">supported_class_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">print_</span><span class="p">(</span><span class="s1">&#39; * Auto-Decide Per-Class Summary&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">supported_class_idxs</span><span class="p">:</span>
            <span class="c1"># Look at fail/succs in threshold</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># number of times this class appears overall</span>
            <span class="n">n_total_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># get the cases where this class was predicted</span>
            <span class="n">auto_true_k</span> <span class="o">=</span> <span class="n">auto_true</span> <span class="o">==</span> <span class="n">k</span>
            <span class="n">auto_pred_k</span> <span class="o">=</span> <span class="n">auto_pred</span> <span class="o">==</span> <span class="n">k</span>
            <span class="c1"># number of cases auto predicted</span>
            <span class="n">n_pred_k</span> <span class="o">=</span> <span class="n">auto_pred_k</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># number of times auto was right</span>
            <span class="n">n_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">auto_true_k</span> <span class="o">&amp;</span> <span class="n">auto_pred_k</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># number of times auto was wrong</span>
            <span class="n">n_fp</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">auto_true_k</span> <span class="o">&amp;</span> <span class="n">auto_pred_k</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">fail_str</span> <span class="o">=</span> <span class="n">frac_str</span><span class="p">(</span><span class="n">n_fp</span><span class="p">,</span> <span class="n">n_pred_k</span><span class="p">)</span>
            <span class="n">pass_str</span> <span class="o">=</span> <span class="n">frac_str</span><span class="p">(</span><span class="n">n_tp</span><span class="p">,</span> <span class="n">n_total_k</span><span class="p">)</span>
            <span class="n">fmtstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">:&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;    </span><span class="si">{n_total_k}</span><span class="s1"> samples existed, and did </span><span class="si">{n_pred_k}</span><span class="s1"> auto predictions&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;    got </span><span class="si">{pass_str}</span><span class="s1"> right&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;    made </span><span class="si">{fail_str}</span><span class="s1"> errors&#39;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">print_</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())))</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">classification_report2</span><span class="p">(</span>
            <span class="n">y_true</span><span class="p">,</span>
            <span class="n">y_pred</span><span class="p">,</span>
            <span class="n">target_names</span><span class="o">=</span><span class="n">target_names</span><span class="p">,</span>
            <span class="n">sample_weight</span><span class="o">=</span><span class="n">can_autodecide</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">print_</span><span class="p">(</span><span class="s1">&#39; * Auto-Decide Confusion&#39;</span><span class="p">)</span>
        <span class="n">print_</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;confusion&#39;</span><span class="p">])))</span>
        <span class="n">print_</span><span class="p">(</span><span class="s1">&#39; * Auto-Decide Metrics&#39;</span><span class="p">)</span>
        <span class="n">print_</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="s1">&#39;mcc&#39;</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">print_</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;mcc&#39;</span><span class="p">])))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">auto_truth_bin</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="p">[</span><span class="n">can_autodecide</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">supported_class_idxs</span><span class="p">:</span>
                <span class="n">auto_truth_k</span> <span class="o">=</span> <span class="n">auto_truth_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">auto_probs_k</span> <span class="o">=</span> <span class="n">auto_probs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">auto_probs_k</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
                    <span class="n">auc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">auto_truth_k</span><span class="p">,</span> <span class="n">auto_probs_k</span><span class="p">)</span>
                    <span class="n">print_</span><span class="p">(</span>
                        <span class="s1">&#39; * Auto AUC(Macro): </span><span class="si">{:.4f}</span><span class="s1"> for class=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">auc</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">report</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span></div>

<div class="viewcode-block" id="ClfResult.confusions"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.confusions">[docs]</a>    <span class="k">def</span> <span class="nf">confusions</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">y_test_bin</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">clf_probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
        <span class="n">probs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">clf_probs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">confusions</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ConfusionMetrics</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">confusions</span></div>

<div class="viewcode-block" id="ClfResult.ishow_roc"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.ishow_roc">[docs]</a>    <span class="k">def</span> <span class="nf">ishow_roc</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">qtensure</span><span class="p">()</span>
        <span class="n">y_test_bin</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># The maximum allowed false positive rate</span>
        <span class="c1"># We expect that we will make 1 error every 1,000 decisions</span>
        <span class="c1"># thresh_df[&#39;foo&#39;] = [1, 2, 3]</span>
        <span class="c1"># thresh_df[&#39;foo&#39;][res.class_names[k]] = 1</span>
        <span class="c1"># for k in [2, 0, 1]:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">y_test_bin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># only show one in the binary case</span>
                <span class="k">continue</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">confusions</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">confusions</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="n">ROCInteraction</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">interact_roc_factory</span><span class="p">(</span>
                <span class="n">confusions</span><span class="p">,</span> <span class="n">show_operating_point</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c1"># ROCInteraction.static_plot(fnum, None, name=class_name)</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">ROCInteraction</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">class_name</span><span class="p">)</span>
            <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1"># if False:</span>
        <span class="c1">#     X = probs</span>
        <span class="c1">#     y = labels</span>
        <span class="c1">#     encoder = vt.ScoreNormalizer()</span>
        <span class="c1">#     encoder.fit(probs, labels)</span>
        <span class="c1">#     learn_thresh = encoder.learn_threshold2()</span>
        <span class="c1">#     encoder.inverse_normalize(learn_thresh)</span>
        <span class="c1"># encoder.visualize(fnum=k)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ClfResult.show_roc"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.show_roc">[docs]</a>    <span class="k">def</span> <span class="nf">show_roc</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">target_bin_df</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probs_df</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">confusions</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ConfusionMetrics</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">confusions</span><span class="o">.</span><span class="n">draw_roc_curve</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClfResult.roc_scores_ovr_hat"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.roc_scores_ovr_hat">[docs]</a>    <span class="k">def</span> <span class="nf">roc_scores_ovr_hat</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">)):</span>
            <span class="n">class_k_truth</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">class_k_probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">probhats_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">class_k_truth</span><span class="p">,</span> <span class="n">class_k_probs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">auc</span></div>

<div class="viewcode-block" id="ClfResult.roc_scores_ovr"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.roc_scores_ovr">[docs]</a>    <span class="k">def</span> <span class="nf">roc_scores_ovr</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">class_k_truth</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">class_k_probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">class_k_truth</span><span class="p">,</span> <span class="n">class_k_probs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">auc</span></div>

<div class="viewcode-block" id="ClfResult.confusions_ovr"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.confusions_ovr">[docs]</a>    <span class="k">def</span> <span class="nf">confusions_ovr</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="c1"># one_vs_rest confusions</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">class_k_truth</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">class_k_probs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">cfms</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ConfusionMetrics</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">class_k_probs</span><span class="p">,</span> <span class="n">class_k_truth</span><span class="p">)</span>
            <span class="c1"># auc = sklearn.metrics.roc_auc_score(class_k_truth, class_k_probs)</span>
            <span class="k">yield</span> <span class="n">res</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">cfms</span></div>

<div class="viewcode-block" id="ClfResult.roc_score"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.ClfResult.roc_score">[docs]</a>    <span class="k">def</span> <span class="nf">roc_score</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">augment_if_needed</span><span class="p">()</span>
        <span class="n">auc_learn</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">y_test_bin</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">clf_probs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">auc_learn</span></div></div>


<div class="viewcode-block" id="MultiTaskSamples"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">MultiTaskSamples</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles samples (i.e. feature-label pairs) with a combination of</span>
<span class="sd">    non-mutually exclusive subclassification labels</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.algo.verif.clf_helpers MultiTaskSamples</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.algo.verif.clf_helpers import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; samples = MultiTaskSamples([0, 1, 2, 3])</span>
<span class="sd">        &gt;&gt;&gt; tasks_to_indicators = ut.odict([</span>
<span class="sd">        &gt;&gt;&gt;     (&#39;task1&#39;, ut.odict([</span>
<span class="sd">        &gt;&gt;&gt;         (&#39;state1&#39;, [0, 0, 0, 1]),</span>
<span class="sd">        &gt;&gt;&gt;         (&#39;state2&#39;, [0, 0, 1, 0]),</span>
<span class="sd">        &gt;&gt;&gt;         (&#39;state3&#39;, [1, 1, 0, 0]),</span>
<span class="sd">        &gt;&gt;&gt;     ])),</span>
<span class="sd">        &gt;&gt;&gt;     (&#39;task2&#39;, ut.odict([</span>
<span class="sd">        &gt;&gt;&gt;         (&#39;state4&#39;, [0, 0, 0, 1]),</span>
<span class="sd">        &gt;&gt;&gt;         (&#39;state5&#39;, [1, 1, 1, 0]),</span>
<span class="sd">        &gt;&gt;&gt;     ]))</span>
<span class="sd">        &gt;&gt;&gt; ])</span>
<span class="sd">        &gt;&gt;&gt; samples.apply_indicators(tasks_to_indicators)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>

    <span class="c1"># def set_simple_scores(samples, simple_scores):</span>
    <span class="c1">#     if simple_scores is not None:</span>
    <span class="c1">#         edges = ut.emap(tuple, samples.aid_pairs.tolist())</span>
    <span class="c1">#         assert (edges == simple_scores.index.tolist())</span>
    <span class="c1">#     samples.simple_scores = simple_scores</span>

    <span class="c1"># def set_feats(samples, X_dict):</span>
    <span class="c1">#     if X_dict is not None:</span>
    <span class="c1">#         edges = ut.emap(tuple, samples.aid_pairs.tolist())</span>
    <span class="c1">#         for X in X_dict.values():</span>
    <span class="c1">#             assert np.all(edges == X.index.tolist())</span>
    <span class="c1">#     samples.X_dict = X_dict</span>

<div class="viewcode-block" id="MultiTaskSamples.supported_tasks"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.supported_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">supported_tasks</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_key</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">has_support</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">task_key</span></div>

<div class="viewcode-block" id="MultiTaskSamples.apply_indicators"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.apply_indicators">[docs]</a>    <span class="k">def</span> <span class="nf">apply_indicators</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">tasks_to_indicators</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds labels for a specific task</span>

<span class="sd">        Args:</span>
<span class="sd">            tasks_to_indicators (dict): takes the form:</span>
<span class="sd">                {</span>
<span class="sd">                   `my_task_name1&#39; {</span>
<span class="sd">                       &#39;class1&#39;: [list of bools indicating class membership]</span>
<span class="sd">                       ...</span>
<span class="sd">                       &#39;classN&#39;: [list of bools indicating class membership]</span>
<span class="sd">                   }</span>
<span class="sd">                   ...</span>
<span class="sd">                   `my_task_nameN&#39;: ...</span>
<span class="sd">               }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">n_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks_to_indicators</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">tasks_to_indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">MultiClassLabels</span><span class="o">.</span><span class="n">from_indicators</span><span class="p">(</span>
                <span class="n">indicator</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="n">task_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">samples</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
            <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span>
            <span class="k">elif</span> <span class="n">n_samples</span> <span class="o">!=</span> <span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;numer of samples is different&#39;</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span></div>

<div class="viewcode-block" id="MultiTaskSamples.apply_encoded_labels"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.apply_encoded_labels">[docs]</a>    <span class="k">def</span> <span class="nf">apply_encoded_labels</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">y_enc</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">task_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds labels for a specific task. Alternative to `apply_indicators`</span>

<span class="sd">        Args:</span>
<span class="sd">            y_enc (list): integer label indicating the class for each sample</span>
<span class="sd">            class_names (list): list of strings indicating the class-domain</span>
<span class="sd">            task_name (str): key for denoting this specific task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># convert to indicator structure and use that</span>
        <span class="n">tasks_to_indicators</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">task_name</span><span class="p">,</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_enc</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">apply_indicators</span><span class="p">(</span><span class="n">tasks_to_indicators</span><span class="p">)</span></div>

    <span class="c1"># @ut.memoize</span>
<div class="viewcode-block" id="MultiTaskSamples.encoded_2d"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.encoded_2d">[docs]</a>    <span class="k">def</span> <span class="nf">encoded_2d</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">encoded_2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">encoded_df</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoded_2d</span></div>

<div class="viewcode-block" id="MultiTaskSamples.class_name_basis"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.class_name_basis">[docs]</a>    <span class="k">def</span> <span class="nf">class_name_basis</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; corresponds with indexes returned from encoded1d &quot;&quot;&quot;</span>
        <span class="n">class_name_basis</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">t</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">class_names</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="c1"># class_name_basis = [(b, a) for a, b in ut.product(*[</span>
        <span class="c1">#     v.class_names for k, v in samples.items()][::-1])]</span>
        <span class="k">return</span> <span class="n">class_name_basis</span></div>

<div class="viewcode-block" id="MultiTaskSamples.class_idx_basis_2d"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.class_idx_basis_2d">[docs]</a>    <span class="k">def</span> <span class="nf">class_idx_basis_2d</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 2d-index version of class_name_basis &quot;&quot;&quot;</span>
        <span class="n">class_idx_basis_2d</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">class_idx_basis_2d</span></div>

<div class="viewcode-block" id="MultiTaskSamples.class_idx_basis_1d"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.class_idx_basis_1d">[docs]</a>    <span class="k">def</span> <span class="nf">class_idx_basis_1d</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 1d-index version of class_name_basis &quot;&quot;&quot;</span>
        <span class="n">n_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">n_classes</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">class_idx_basis_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_idx_basis_1d</span></div>

    <span class="c1"># @ut.memoize</span>
<div class="viewcode-block" id="MultiTaskSamples.encoded_1d"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.encoded_1d">[docs]</a>    <span class="k">def</span> <span class="nf">encoded_1d</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a unique label for each combination of samples &quot;&quot;&quot;</span>
        <span class="c1"># from sklearn.preprocessing import MultiLabelBinarizer</span>
        <span class="n">encoded_2d</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">encoded_2d</span><span class="p">()</span>
        <span class="n">class_space</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">n_classes</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">class_space</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">encoded_1d</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsets</span> <span class="o">*</span> <span class="n">encoded_2d</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># e = MultiLabelBinarizer()</span>
        <span class="c1"># bin_coeff = e.fit_transform(encoded_2d)</span>
        <span class="c1"># bin_basis = (2 ** np.arange(bin_coeff.shape[1]))[None, :]</span>
        <span class="c1"># # encoded_1d = (bin_coeff * bin_basis).sum(axis=1)</span>
        <span class="c1"># encoded_1d = (bin_coeff * bin_basis[::-1]).sum(axis=1)</span>
        <span class="c1"># # vt.unique_rows(sklearn.preprocessing.MultiLabelBinarizer().fit_transform(encoded_2d))</span>
        <span class="c1"># [v.encoded_df.values for k, v in samples.items()]</span>
        <span class="c1"># encoded_df_1d = pd.concat([v.encoded_df for k, v in samples.items()], axis=1)</span>
        <span class="k">return</span> <span class="n">encoded_1d</span></div>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;nS=</span><span class="si">%r</span><span class="s1">, nT=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">samples</span><span class="o">.</span><span class="n">n_tasks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">task_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="p">[</span><span class="n">task_key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">samples</span><span class="o">.</span><span class="n">n_samples</span>

<div class="viewcode-block" id="MultiTaskSamples.print_info"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.print_info">[docs]</a>    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">print_info</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hist(all) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">make_histogram</span><span class="p">())))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len(all) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)))</span></div>

<div class="viewcode-block" id="MultiTaskSamples.make_histogram"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.make_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">make_histogram</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; label histogram &quot;&quot;&quot;</span>
        <span class="n">class_name_basis</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">class_name_basis</span><span class="p">()</span>
        <span class="n">class_idx_basis_1d</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">class_idx_basis_1d</span><span class="p">()</span>
        <span class="c1"># print(&#39;class_idx_basis_1d = %r&#39; % (class_idx_basis_1d,))</span>
        <span class="c1"># print(samples.encoded_1d())</span>
        <span class="n">multi_task_idx_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">encoded_1d</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">class_idx_basis_1d</span>
        <span class="p">)</span>
        <span class="n">multi_task_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">class_name_basis</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">multi_task_idx_hist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">multi_task_hist</span></div>

<div class="viewcode-block" id="MultiTaskSamples.items"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">subtasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">labels</span></div>

    <span class="c1"># def take(samples, idxs):</span>
    <span class="c1">#     mask = ut.index_to_boolmask(idxs, len(samples))</span>
    <span class="c1">#     return samples.compress(mask)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_ids</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="MultiTaskSamples.stratified_kfold_indices"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.stratified_kfold_indices">[docs]</a>    <span class="k">def</span> <span class="nf">stratified_kfold_indices</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="o">**</span><span class="n">xval_kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: check xval label frequency</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">model_selection</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">encoded_1d</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">group_ids</span>

        <span class="n">type_</span> <span class="o">=</span> <span class="n">xval_kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># FIXME: The StratifiedGroupKFold could be implemented better.</span>
            <span class="n">splitter</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">StratifiedGroupKFold</span><span class="p">(</span><span class="o">**</span><span class="n">xval_kw</span><span class="p">)</span>
            <span class="n">skf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;StratifiedKFold&#39;</span><span class="p">:</span>
            <span class="n">splitter</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="o">**</span><span class="n">xval_kw</span><span class="p">)</span>
            <span class="n">skf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">skf_list</span></div>

<div class="viewcode-block" id="MultiTaskSamples.subsplit_indices"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiTaskSamples.subsplit_indices">[docs]</a>    <span class="k">def</span> <span class="nf">subsplit_indices</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">subset_idx</span><span class="p">,</span> <span class="o">**</span><span class="n">xval_kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; split an existing set &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">model_selection</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset_idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">encoded_1d</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">group_ids</span><span class="p">[</span><span class="n">subset_idx</span><span class="p">]</span>

        <span class="n">xval_kw_</span> <span class="o">=</span> <span class="n">xval_kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;n_splits&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xval_kw_</span><span class="p">:</span>
            <span class="n">xval_kw_</span><span class="p">[</span><span class="s1">&#39;n_splits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">xval_kw_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;StratifiedGroupKFold&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># FIXME: The StratifiedGroupKFold could be implemented better.</span>
            <span class="n">splitter</span> <span class="o">=</span> <span class="n">sklearn_utils</span><span class="o">.</span><span class="n">StratifiedGroupKFold</span><span class="p">(</span><span class="o">**</span><span class="n">xval_kw_</span><span class="p">)</span>
            <span class="n">rel_skf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;StratifiedKFold&#39;</span><span class="p">:</span>
            <span class="n">splitter</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">StratifiedKFold</span><span class="p">(</span><span class="o">**</span><span class="n">xval_kw_</span><span class="p">)</span>
            <span class="n">rel_skf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>

        <span class="c1"># map back into original coords</span>
        <span class="n">skf_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">subset_idx</span><span class="p">[</span><span class="n">rel_idx1</span><span class="p">],</span> <span class="n">subset_idx</span><span class="p">[</span><span class="n">rel_idx2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">rel_idx1</span><span class="p">,</span> <span class="n">rel_idx2</span> <span class="ow">in</span> <span class="n">rel_skf_list</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">skf_list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">subset_idx</span><span class="p">,</span> <span class="n">idx1</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">subset_idx</span><span class="p">,</span> <span class="n">idx2</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx2</span><span class="p">)</span>
            <span class="c1"># assert</span>
        <span class="k">return</span> <span class="n">skf_list</span></div></div>


<div class="viewcode-block" id="MultiClassLabels"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">MultiClassLabels</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used by samples to encode a single set of mutually exclusive labels.  These</span>
<span class="sd">    can either be binary or multiclass.</span>

<span class="sd">        import pandas as pd</span>
<span class="sd">        pd.options.display.max_rows = 10</span>
<span class="sd">        # pd.options.display.max_rows = 20</span>
<span class="sd">        pd.options.display.max_columns = 40</span>
<span class="sd">        pd.options.display.width = 160</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="c1"># Helper Info</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Core data</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">default_class</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="MultiClassLabels.has_support"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.has_support">[docs]</a>    <span class="k">def</span> <span class="nf">has_support</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">make_histogram</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="MultiClassLabels.lookup_class_idx"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.lookup_class_idx">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_class_idx</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">dzip</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">classes_</span><span class="p">)[</span><span class="n">class_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="MultiClassLabels.from_indicators"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.from_indicators">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_indicators</span><span class="p">(</span><span class="n">MultiClassLabels</span><span class="p">,</span> <span class="n">indicator</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">six</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">MultiClassLabels</span><span class="p">()</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">indicator</span><span class="p">)))</span>
        <span class="c1"># if index is None:</span>
        <span class="c1">#     index = pd.Series(np.arange(n_samples), name=&#39;index&#39;)</span>
        <span class="n">indicator_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">indicator_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="p">),</span> <span class="s1">&#39;states in the same task must be mutually exclusive&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span> <span class="o">=</span> <span class="n">indicator_df</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="n">indicator_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">indicator_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">task_name</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">task_name</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 1 column means binary case</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">default_class_name</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labels</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target_type</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">multiclass</span><span class="o">.</span><span class="n">type_of_target</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">y_enc</span><span class="p">)</span>

<div class="viewcode-block" id="MultiClassLabels.one_vs_rest_task_names"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.one_vs_rest_task_names">[docs]</a>    <span class="k">def</span> <span class="nf">one_vs_rest_task_names</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">task_name</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-v-rest)&#39;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="MultiClassLabels.gen_one_vs_rest_labels"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.gen_one_vs_rest_labels">[docs]</a>    <span class="k">def</span> <span class="nf">gen_one_vs_rest_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.verif.clf_helpers import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; indicator = ut.odict([</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;state1&#39;, [0, 0, 0, 1]),</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;state2&#39;, [0, 0, 1, 0]),</span>
<span class="sd">            &gt;&gt;&gt;         (&#39;state3&#39;, [1, 1, 0, 0]),</span>
<span class="sd">            &gt;&gt;&gt;     ])</span>
<span class="sd">            &gt;&gt;&gt; labels = MultiClassLabels.from_indicators(indicator, task_name=&#39;task1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; sublabels = list(labels.gen_one_vs_rest_labels())</span>
<span class="sd">            &gt;&gt;&gt; sublabel = sublabels[0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">labels</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="n">task_names_1vR</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">one_vs_rest_task_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">task_name</span> <span class="o">=</span> <span class="n">task_names_1vR</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">indicator_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">indicator_df</span><span class="p">[</span><span class="s1">&#39;not-&#39;</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">indicator_df</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">indicator_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
            <span class="c1"># indicator = labels.encoded_df == k</span>
            <span class="c1"># indicator.rename(columns={indicator.columns[0]: class_name}, inplace=True)</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicator_df</span><span class="p">)</span>
            <span class="n">sublabel</span> <span class="o">=</span> <span class="n">MultiClassLabels</span><span class="p">()</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">indicator_df</span> <span class="o">=</span> <span class="n">indicator_df</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="n">indicator_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># if len(indicator_df.columns) == 1:</span>
            <span class="c1">#     sublabel.encoded_df = pd.DataFrame(</span>
            <span class="c1">#         indicator_df.values.T[0],</span>
            <span class="c1">#         columns=[task_name]</span>
            <span class="c1">#     )</span>
            <span class="c1"># else:</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">encoded_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">indicator_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">task_name</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span>
            <span class="p">)</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">task_name</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublabel</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
            <span class="c1"># if sublabel.n_classes == 1:</span>
            <span class="c1">#     sublabel.n_classes = 2  # 1 column means binary case</span>
            <span class="n">sublabel</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sublabel</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)</span>

            <span class="c1"># sublabel = MultiClassLabels.from_indicators(indicator,</span>
            <span class="c1"># task_name=subname, index=samples.index)</span>
            <span class="k">yield</span> <span class="n">sublabel</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_bin</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">labels</span><span class="o">.</span><span class="n">indicator_df</span><span class="o">.</span><span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_enc</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">labels</span><span class="o">.</span><span class="n">encoded_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">task_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">task_name</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nD=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nC=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">n_classes</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">labels</span><span class="o">.</span><span class="n">n_samples</span>

<div class="viewcode-block" id="MultiClassLabels.make_histogram"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.make_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">make_histogram</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">class_idx_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">y_enc</span><span class="p">)</span>
        <span class="n">class_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_keys</span><span class="p">(</span><span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">labels</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">class_idx_hist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_hist</span></div>

<div class="viewcode-block" id="MultiClassLabels.print_info"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.MultiClassLabels.print_info">[docs]</a>    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hist(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">task_name</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">make_histogram</span><span class="p">())))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">task_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="IrisProblem"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.IrisProblem">[docs]</a><span class="k">class</span> <span class="nc">IrisProblem</span><span class="p">(</span><span class="n">ClfProblem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple demo using the abstract clf problem to work on the iris dataset.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.verif.clf_helpers import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; pblm = IrisProblem()</span>
<span class="sd">            &gt;&gt;&gt; pblm.setup()</span>
<span class="sd">            &gt;&gt;&gt; pblm.samples</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IrisProblem.setup"><a class="viewcode-back" href="../../../../wbia.algo.verif.html#wbia.algo.verif.clf_helpers.IrisProblem.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">pblm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sklearn.datasets</span>

        <span class="n">iris</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_iris</span><span class="p">()</span>

        <span class="n">pblm</span><span class="o">.</span><span class="n">primary_task_key</span> <span class="o">=</span> <span class="s1">&#39;iris&#39;</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">default_data_key</span> <span class="o">=</span> <span class="s1">&#39;learn(all)&#39;</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">default_clf_key</span> <span class="o">=</span> <span class="s1">&#39;RF&#39;</span>

        <span class="n">X_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">MultiTaskSamples</span><span class="p">(</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">apply_indicators</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;iris&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">target_names</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">X_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learn(all)&#39;</span><span class="p">:</span> <span class="n">X_df</span><span class="p">}</span>

        <span class="n">pblm</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
        <span class="n">pblm</span><span class="o">.</span><span class="n">xval_kw</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;StratifiedKFold&#39;</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.algo.verif.samples</span>
<span class="sd">        python -m wbia.algo.verif.samples --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../wbia.html">wbia</a><ul>
  <li><a href="../../algo.html">wbia.algo</a><ul>
  <li><a href="../verif.html">wbia.algo.verif</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
