
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.algo.graph.mixin_priority &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.algo.graph.mixin_priority</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">wbia.algo.graph</span> <span class="k">import</span> <span class="n">nx_utils</span> <span class="k">as</span> <span class="n">nxu</span>
<span class="kn">from</span> <span class="nn">wbia.algo.graph.state</span> <span class="k">import</span> <span class="n">POSTV</span><span class="p">,</span> <span class="n">NEGTV</span>
<span class="kn">from</span> <span class="nn">wbia.algo.graph.state</span> <span class="k">import</span> <span class="n">SAME</span><span class="p">,</span> <span class="n">DIFF</span><span class="p">,</span> <span class="n">NULL</span>  <span class="c1"># NOQA</span>
<span class="kn">from</span> <span class="nn">wbia.algo.graph</span> <span class="k">import</span> <span class="n">mixin_loops</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">ENABLE_PRIORITY_PCC_CORRECTION</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="Priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority">[docs]</a><span class="k">class</span> <span class="nc">Priority</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles prioritization of edges for review.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.algo.graph.mixin_priority import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia.algo.graph import demo</span>
<span class="sd">        &gt;&gt;&gt; infr = demo.demodata_infr(num_pccs=20)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Priority.remaining_reviews"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.remaining_reviews">[docs]</a>    <span class="k">def</span> <span class="nf">remaining_reviews</span><span class="p">(</span><span class="n">infr</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_pop</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wraps queue so ordering is determenistic &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_push</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wraps queue so ordering is determenistic &quot;&quot;&quot;</span>
        <span class="n">PSEUDO_RANDOM_TIEBREAKER</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">PSEUDO_RANDOM_TIEBREAKER</span><span class="p">:</span>
            <span class="c1"># Make it so tiebreakers have a pseudo-random order</span>
            <span class="n">chaotic</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">digest_data</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">alg</span><span class="o">=</span><span class="s1">&#39;sha1&#39;</span><span class="p">)[:</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
            <span class="n">tiebreaker</span> <span class="o">=</span> <span class="p">(</span><span class="n">chaotic</span><span class="p">,)</span> <span class="o">+</span> <span class="n">edge</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tiebreaker</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">assert_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mixin_loops</span><span class="o">.</span><span class="n">PRINCETON_KAIA_EDGE_LIST</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print(&#39;[Priority._push] FILTERING EDGES FOR KAIA&#39;)</span>
            <span class="c1"># Sanity check, make sure that one of the edges is in the tier 1 dataset</span>
            <span class="n">include_filter_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mixin_loops</span><span class="o">.</span><span class="n">PRINCETON_KAIA_EDGE_LIST</span><span class="p">)</span>

            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_filter_set</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_filter_set</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># tiebreaker = (chaotic(chaotic(u) + chaotic(v)), u, v)</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">priority</span><span class="p">,</span> <span class="n">tiebreaker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_peek_many</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wraps queue so ordering is determenistic &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">peek_many</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_remove_edge_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">edges_</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span> <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;removed priority from </span><span class="si">{}</span><span class="s1"> edges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges_</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">delete_items</span><span class="p">(</span><span class="n">edges_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reinstate_edge_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">edges_</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span> <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># TODO: use whatever the current metric is</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;prob_match&#39;</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;reprioritize </span><span class="si">{}</span><span class="s1"> edges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges_</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">priorities</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">gen_edge_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">edges_</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edges_</span><span class="p">,</span> <span class="n">priorities</span><span class="p">):</span>
                <span class="n">infr</span><span class="o">.</span><span class="n">_push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_increase_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;increase priority of </span><span class="si">{}</span><span class="s1"> edges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;prob_match&#39;</span>
        <span class="n">priorities</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">gen_edge_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">priorities</span><span class="p">):</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">amount</span><span class="p">)</span>

<div class="viewcode-block" id="Priority.remove_internal_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.remove_internal_priority">[docs]</a>    <span class="k">def</span> <span class="nf">remove_internal_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_remove_edge_priority</span><span class="p">(</span><span class="n">nxu</span><span class="o">.</span><span class="n">edges_inside</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">cc</span><span class="p">))</span></div>

<div class="viewcode-block" id="Priority.remove_external_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.remove_external_priority">[docs]</a>    <span class="k">def</span> <span class="nf">remove_external_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_remove_edge_priority</span><span class="p">(</span><span class="n">nxu</span><span class="o">.</span><span class="n">edges_outgoing</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">cc</span><span class="p">))</span></div>

<div class="viewcode-block" id="Priority.remove_between_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.remove_between_priority">[docs]</a>    <span class="k">def</span> <span class="nf">remove_between_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_remove_edge_priority</span><span class="p">(</span><span class="n">nxu</span><span class="o">.</span><span class="n">edges_cross</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">))</span></div>

<div class="viewcode-block" id="Priority.reinstate_between_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.reinstate_between_priority">[docs]</a>    <span class="k">def</span> <span class="nf">reinstate_between_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reinstate the appropriate edges into the queue</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edges_cross</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">unreviewed_graph</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_reinstate_edge_priority</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span></div>

<div class="viewcode-block" id="Priority.reinstate_internal_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.reinstate_internal_priority">[docs]</a>    <span class="k">def</span> <span class="nf">reinstate_internal_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reinstate the appropriate edges into the queue</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edges_inside</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">unreviewed_graph</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_reinstate_edge_priority</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span></div>

<div class="viewcode-block" id="Priority.reinstate_external_priority"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.reinstate_external_priority">[docs]</a>    <span class="k">def</span> <span class="nf">reinstate_external_priority</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reinstate the appropriate edges into the queue</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">nxu</span><span class="o">.</span><span class="n">edges_outgoing</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">unreviewed_graph</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_reinstate_edge_priority</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_correct_priorities</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="n">corrected_priority</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ENABLE_PRIORITY_PCC_CORRECTION</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">corrected_priority</span>

        <span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">primary_task</span> <span class="o">=</span> <span class="s1">&#39;match_state&#39;</span>
                <span class="n">decision_probs</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">task_probs</span><span class="p">[</span><span class="n">primary_task</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">decision_probs</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">decision_probs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
                <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">priority</span> <span class="o">!=</span> <span class="n">decision_probs</span><span class="p">[</span><span class="n">NEGTV</span><span class="p">]:</span>
                        <span class="n">corrected_priority</span> <span class="o">=</span> <span class="n">decision_probs</span><span class="p">[</span><span class="n">NEGTV</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">priority</span> <span class="o">!=</span> <span class="n">decision_probs</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]:</span>
                        <span class="n">corrected_priority</span> <span class="o">=</span> <span class="n">decision_probs</span><span class="p">[</span><span class="n">POSTV</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">corrected_priority</span>

<div class="viewcode-block" id="Priority.prioritize"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.prioritize">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">prioritize</span><span class="p">(</span>
        <span class="n">infr</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_inconsistent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds edges to the priority queue</span>

<span class="sd">        Doctest:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph.mixin_priority import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph import demo</span>
<span class="sd">            &gt;&gt;&gt; infr = demo.demodata_infr(num_pccs=7, size=5)</span>
<span class="sd">            &gt;&gt;&gt; infr.ensure_cliques(meta_decision=SAME)</span>
<span class="sd">            &gt;&gt;&gt; # Add a negative edge inside a PCC</span>
<span class="sd">            &gt;&gt;&gt; ccs = list(infr.positive_components())</span>
<span class="sd">            &gt;&gt;&gt; edge1 = tuple(list(ccs[0])[0:2])</span>
<span class="sd">            &gt;&gt;&gt; edge2 = tuple(list(ccs[1])[0:2])</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback(edge1, NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback(edge2, NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; num_new = infr.prioritize(reset=True)</span>
<span class="sd">            &gt;&gt;&gt; order = infr._peek_many(np.inf)</span>
<span class="sd">            &gt;&gt;&gt; scores = ut.take_column(order, 1)</span>
<span class="sd">            &gt;&gt;&gt; assert scores[0] &gt; 10</span>
<span class="sd">            &gt;&gt;&gt; assert len(scores) == num_new, &#39;should prioritize two hypotheis edges&#39;</span>
<span class="sd">            &gt;&gt;&gt; unrev_edges = set(infr.unreviewed_graph.edges())</span>
<span class="sd">            &gt;&gt;&gt; err_edges = set(ut.flatten(infr.nid_to_errors.values()))</span>
<span class="sd">            &gt;&gt;&gt; edges = set(list(unrev_edges - err_edges)[0:2])</span>
<span class="sd">            &gt;&gt;&gt; edges.update(list(err_edges)[0:2])</span>
<span class="sd">            &gt;&gt;&gt; num_new = infr.prioritize(edges=edges, reset=True)</span>
<span class="sd">            &gt;&gt;&gt; order2 = infr._peek_many(np.inf)</span>
<span class="sd">            &gt;&gt;&gt; scores2 = np.array(ut.take_column(order2, 1))</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(scores2[0:2] &gt; 10)</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(scores2[2:] &lt; 10)</span>

<span class="sd">        Example:</span>
<span class="sd">            import wbia</span>
<span class="sd">            infr = wbia.AnnotInference(&#39;PZ_MTEST&#39;, aids=&#39;all&#39;, autoinit=&#39;staging&#39;)</span>
<span class="sd">            infr.verbose = 1000</span>
<span class="sd">            infr.load_published()</span>
<span class="sd">            incon_edges = set(ut.iflatten(infr.nid_to_errors.values()))</span>
<span class="sd">            assert len(incon_edges) &gt; 0</span>
<span class="sd">            edges = list(infr.find_pos_redun_candidate_edges())</span>
<span class="sd">            assert len(set(incon_edges).intersection(set(edges))) == 0</span>
<span class="sd">            infr.add_candidate_edges(edges)</span>

<span class="sd">            infr.prioritize()</span>
<span class="sd">            print(ut.repr4(infr.status()))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="ow">or</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">PriorityQueue</span><span class="p">()</span>
        <span class="n">low</span> <span class="o">=</span> <span class="mf">1e-9</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;prob_match&#39;</span>

        <span class="c1"># If edges are not explicilty specified get unreviewed and error edges</span>
        <span class="c1"># that are not redundant</span>
        <span class="k">if</span> <span class="n">edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must provide edges with scores&#39;</span><span class="p">)</span>
            <span class="n">unrev_edges</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">unreviewed_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">filter_edges_flagged_as_redun</span><span class="p">(</span><span class="n">unrev_edges</span><span class="p">))</span>

        <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;ensuring </span><span class="si">{}</span><span class="s1"> edge(s) get priority&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inference.enabled&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">force_inconsistent</span><span class="p">:</span>
            <span class="c1"># Ensure that maybe_error edges are always prioritized</span>
            <span class="n">maybe_error_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">maybe_error_edges</span><span class="p">())</span>
            <span class="n">extra_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">maybe_error_edges</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span>
            <span class="n">extra_edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_edges</span><span class="p">)</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                <span class="s1">&#39;ensuring </span><span class="si">{}</span><span class="s1"> inconsistent edge(s) get priority&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extra_edges</span><span class="p">)),</span>
                <span class="mi">5</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pgen</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">gen_edge_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">extra_edges</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">low</span><span class="p">))</span>
                <span class="n">extra_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pgen</span><span class="p">)</span>
                <span class="n">extra_scores</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">extra_scores</span><span class="p">)]</span> <span class="o">=</span> <span class="n">low</span>

                <span class="n">scores</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">aslist</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">aslist</span><span class="p">(</span><span class="n">extra_scores</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">aslist</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_edges</span>

        <span class="c1"># Ensure edges are in some arbitrary order</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

        <span class="c1"># Ensure given scores do not have nan values</span>
        <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pgen</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">gen_edge_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">low</span><span class="p">)</span>
            <span class="n">priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pgen</span><span class="p">))</span>
            <span class="n">priorities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">priorities</span><span class="p">)]</span> <span class="o">=</span> <span class="n">low</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">priorities</span><span class="p">)):</span>
                <span class="n">priorities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">priorities</span><span class="p">)]</span> <span class="o">=</span> <span class="n">low</span>

        <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inference.enabled&#39;</span><span class="p">]:</span>
            <span class="c1"># Increase priority of any flagged maybe_error edges</span>
            <span class="n">err_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="ow">in</span> <span class="n">maybe_error_edges</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
            <span class="n">priorities</span><span class="p">[</span><span class="n">err_flags</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>

        <span class="c1"># Push new items into the priority queue</span>
        <span class="n">num_new</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">priorities</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
                <span class="n">num_new</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">corrected_priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_correct_priorities</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">corrected_priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="n">corrected_priority</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">_push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

        <span class="n">infr</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;added </span><span class="si">%d</span><span class="s1"> edges to the queue&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_new</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_new</span></div>

<div class="viewcode-block" id="Priority.push"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Push an edge back onto the queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;prob_match&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">prob_match</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">get_edge_attr</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">prob_match</span>
        <span class="n">corrected_priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_correct_priorities</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">corrected_priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">corrected_priority</span>
        <span class="c1"># Use edge-nids to break ties for determenistic behavior</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">_push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span></div>

<div class="viewcode-block" id="Priority.pop"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.pop">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="n">infr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main interface to the priority queue used by the algorithm loops.</span>
<span class="sd">        Pops the highest priority edge from the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The outer loop simulates recursive calls without using the stack</span>
        <span class="n">SIZE_THRESH_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">SIZE_THRESH</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_pop</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s1">&#39;no more to review!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Re-prioritize positive or negative relative to PCCs</span>
                <span class="n">corrected_priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">_correct_priorities</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">corrected_priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">infr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">corrected_priority</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">SIZE_THRESH_ENABLED</span> <span class="ow">and</span> <span class="n">infr</span><span class="o">.</span><span class="n">phase</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
                    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">cc1</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">nid1</span><span class="p">)</span>
                    <span class="n">cc2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">nid2</span><span class="p">)</span>
                    <span class="n">size1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span>
                    <span class="n">size2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">size1</span> <span class="o">&gt;</span> <span class="n">SIZE_THRESH</span> <span class="ow">and</span> <span class="n">size2</span> <span class="o">&gt;</span> <span class="n">SIZE_THRESH</span><span class="p">):</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;redun.enabled&#39;</span><span class="p">]:</span>
                    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
                    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">pos_graph</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span>
                    <span class="n">pos_graph</span><span class="p">[</span><span class="n">nid1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nid1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">infr</span><span class="o">.</span><span class="n">nid_to_errors</span><span class="p">:</span>
                            <span class="c1"># skip edges that increase local connectivity beyond</span>
                            <span class="c1"># redundancy thresholds.</span>
                            <span class="n">k_pos</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;redun.pos&#39;</span><span class="p">]</span>
                            <span class="c1"># Much faster to compute local connectivity on subgraph</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">nid1</span><span class="p">)</span>
                            <span class="n">pos_subgraph</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                            <span class="n">pos_conn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">local_edge_connectivity</span><span class="p">(</span>
                                <span class="n">pos_subgraph</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">k_pos</span>
                            <span class="p">)</span>
                            <span class="c1"># Compute local connectivity</span>
                            <span class="k">if</span> <span class="n">pos_conn</span> <span class="o">&gt;=</span> <span class="n">k_pos</span><span class="p">:</span>
                                <span class="k">continue</span>  <span class="c1"># Loop instead of recursion</span>
                                <span class="c1"># return infr.pop()</span>
                <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;queue.conf.thresh&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Ignore reviews that would re-enforce a relationship that</span>
                    <span class="c1"># already has high confidence.</span>
                    <span class="n">thresh_code</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;queue.conf.thresh&#39;</span><span class="p">]</span>
                    <span class="n">thresh</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">[</span><span class="n">thresh_code</span><span class="p">]</span>
                    <span class="c1"># FIXME: at the time of writing a hard coded priority of 10</span>
                    <span class="c1"># or more means that this is part of an inconsistency</span>
                    <span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
                        <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">confidently_connected</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
                                <span class="n">infr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">confidently_separated</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
                                <span class="n">infr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="s1">&#39;fix_mode_split&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="c1"># only checking edges within a name</span>
                    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># Loop instead of recursion</span>
                        <span class="c1"># return infr.pop()</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="s1">&#39;fix_mode_merge&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="c1"># only checking edges within a name</span>
                    <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pos_graph</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># Loop instead of recursive (infr.pop())</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="s1">&#39;fix_mode_predict&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="c1"># No longer needed.</span>
                    <span class="n">pred</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># only report cases where the prediction differs</span>
                    <span class="c1"># FIXME: at the time of writing a hard coded priority of 10</span>
                    <span class="c1"># or more means that this is part of an inconsistency</span>
                    <span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">nid1</span><span class="p">,</span> <span class="n">nid2</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">node_labels</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edge</span>
                            <span class="c1"># Don&#39;t re-review confident CCs</span>
                            <span class="n">thresh</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">[</span><span class="s1">&#39;pretty_sure&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">infr</span><span class="o">.</span><span class="n">confidently_connected</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
                                <span class="k">continue</span>  <span class="c1"># Loop instead of recursive (infr.pop())</span>
                        <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">POSTV</span> <span class="ow">and</span> <span class="n">nid1</span> <span class="o">==</span> <span class="n">nid2</span><span class="p">:</span>
                            <span class="k">continue</span>  <span class="c1"># Loop instead of recursive (infr.pop())</span>
                        <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">NEGTV</span> <span class="ow">and</span> <span class="n">nid1</span> <span class="o">!=</span> <span class="n">nid2</span><span class="p">:</span>
                            <span class="k">continue</span>  <span class="c1"># Loop instead of recursive (infr.pop())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;in error recover mode&#39;</span><span class="p">)</span>
                <span class="n">infr</span><span class="o">.</span><span class="n">assert_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span></div>

<div class="viewcode-block" id="Priority.peek"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.peek">[docs]</a>    <span class="k">def</span> <span class="nf">peek</span><span class="p">(</span><span class="n">infr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">infr</span><span class="o">.</span><span class="n">peek_many</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Priority.peek_many"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.peek_many">[docs]</a>    <span class="k">def</span> <span class="nf">peek_many</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Peeks at the top n edges in the queue.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph.mixin_priority import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph import demo</span>
<span class="sd">            &gt;&gt;&gt; infr = demo.demodata_infr(num_pccs=7, size=5)</span>
<span class="sd">            &gt;&gt;&gt; infr.refresh_candidate_edges()</span>
<span class="sd">            &gt;&gt;&gt; infr.peek_many(50)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Do pops that may invalidate pos redun edges internal to PCCs</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Pop the top n edges off the queue</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Push them back because we are just peeking</span>
        <span class="c1"># (although we may have invalidated things based on local connectivity)</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span></div>

<div class="viewcode-block" id="Priority.confidently_connected"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.confidently_connected">[docs]</a>    <span class="k">def</span> <span class="nf">confidently_connected</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if u and v are conneted by edges above a confidence threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">satisfied</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">edge_decision</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">decision</span> <span class="o">!=</span> <span class="n">POSTV</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">)</span>
            <span class="n">conf_int</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span>
            <span class="n">conf_int</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">conf_int</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">conf_int</span>
            <span class="k">return</span> <span class="n">conf_int</span> <span class="o">&gt;=</span> <span class="n">thresh</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">bfs_conditional</span><span class="p">(</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">yield_if</span><span class="o">=</span><span class="n">satisfied</span><span class="p">,</span> <span class="n">continue_if</span><span class="o">=</span><span class="n">satisfied</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Priority.confidently_separated"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.confidently_separated">[docs]</a>    <span class="k">def</span> <span class="nf">confidently_separated</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if u and v are conneted by edges above a confidence threshold</span>

<span class="sd">        Doctest:</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph.mixin_priority import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.graph import demo</span>
<span class="sd">            &gt;&gt;&gt; infr = demo.make_demo_infr(ccs=[(1, 2), (3, 4), (5, 6), (7, 8)])</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback((1, 5), NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback((5, 8), NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback((6, 3), NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; u, v = (1, 4)</span>
<span class="sd">            &gt;&gt;&gt; thresh = 0</span>
<span class="sd">            &gt;&gt;&gt; assert not infr.confidently_separated(u, v, thresh)</span>
<span class="sd">            &gt;&gt;&gt; infr.add_feedback((2, 3), NEGTV)</span>
<span class="sd">            &gt;&gt;&gt; assert not infr.confidently_separated(u, v, thresh)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">can_cross</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">n_negs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            DFS state condition</span>

<span class="sd">            Args:</span>
<span class="sd">                edge (tuple): the edge we are trying to cross</span>
<span class="sd">                n_negs (int): the number of negative edges crossed so far</span>

<span class="sd">            Returns:</span>
<span class="sd">                flag, new_state -</span>
<span class="sd">                   flag (bool): True if the edge can be crossed</span>
<span class="sd">                   new_state: new state for future decisions in this path.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">edge_decision</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="c1"># only cross positive or negative edges</span>
            <span class="k">if</span> <span class="n">decision</span> <span class="ow">in</span> <span class="p">{</span><span class="n">POSTV</span><span class="p">,</span> <span class="n">NEGTV</span><span class="p">}:</span>
                <span class="c1"># only cross a negative edge once</span>
                <span class="n">willcross</span> <span class="o">=</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">NEGTV</span>
                <span class="k">if</span> <span class="n">willcross</span> <span class="ow">and</span> <span class="n">n_negs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
                    <span class="c1"># only cross edges above a threshold</span>
                    <span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;unspecified&#39;</span><span class="p">)</span>
                    <span class="n">conf_int</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CONFIDENCE</span><span class="o">.</span><span class="n">CODE_TO_INT</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span>
                    <span class="n">conf_int</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">conf_int</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">conf_int</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">conf_int</span> <span class="o">&gt;=</span> <span class="n">thresh</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">n_negs</span> <span class="o">+</span> <span class="n">willcross</span>
                    <span class="k">return</span> <span class="n">flag</span><span class="p">,</span> <span class="n">num</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_negs</span>

        <span class="c1"># need to do DFS check for this. Make DFS only allowed to</span>
        <span class="c1"># cross a negative edge once.</span>
        <span class="c1"># def dfs_cond_rec(G, parent, state, visited=None):</span>
        <span class="c1">#     if visited is None:</span>
        <span class="c1">#         visited = set()</span>
        <span class="c1">#     visited.add(parent)</span>
        <span class="c1">#     for child in G.neighbors(parent):</span>
        <span class="c1">#         if child not in visited:</span>
        <span class="c1">#             edge = (parent, child)</span>
        <span class="c1">#             flag, new_state = can_cross(G, edge, state)</span>
        <span class="c1">#             if flag:</span>
        <span class="c1">#                 yield child</span>
        <span class="c1">#                 for _ in dfs_cond_rec(G, child, new_state, visited):</span>
        <span class="c1">#                     yield _</span>

        <span class="c1"># need to do DFS check for this. Make DFS only allowed to</span>
        <span class="c1"># cross a negative edge once.</span>
        <span class="k">def</span> <span class="nf">dfs_cond_stack</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="c1"># stack based version</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="p">{</span><span class="n">source</span><span class="p">}</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">source</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">source</span><span class="p">]),</span> <span class="n">state</span><span class="p">)]</span>
            <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                        <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                        <span class="n">flag</span><span class="p">,</span> <span class="n">new_state</span> <span class="o">=</span> <span class="n">can_cross</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">child</span>
                            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">child</span><span class="p">]),</span> <span class="n">new_state</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dfs_cond_stack</span><span class="p">(</span><span class="n">infr</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Priority.generate_reviews"><a class="viewcode-back" href="../../../../wbia.algo.graph.html#wbia.algo.graph.mixin_priority.Priority.generate_reviews">[docs]</a>    <span class="k">def</span> <span class="nf">generate_reviews</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">pos_redun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neg_redun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamic generator that yeilds high priority reviews</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pos_redun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;redun.pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_redun</span>
        <span class="k">if</span> <span class="n">neg_redun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infr</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;redun.neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_redun</span>
        <span class="n">infr</span><span class="o">.</span><span class="n">prioritize</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">infr</span><span class="o">.</span><span class="n">_generate_reviews</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_generate_reviews</span><span class="p">(</span><span class="n">infr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">edge</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">infr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">edge</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.algo.graph.mixin_priority</span>
<span class="sd">        python -m wbia.algo.graph.mixin_priority --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../wbia.html">wbia</a><ul>
  <li><a href="../../algo.html">wbia.algo</a><ul>
  <li><a href="../graph.html">wbia.algo.graph</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
