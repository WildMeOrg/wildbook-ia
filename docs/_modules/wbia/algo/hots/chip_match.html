
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia.algo.hots.chip_match &#8212; wbia 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia.algo.hots.chip_match</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">python -m utool.util_inspect check_module_usage --pat=&quot;chip_match.py&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">xor</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">wbia.algo.hots</span> <span class="kn">import</span> <span class="n">hstypes</span>
<span class="kn">from</span> <span class="nn">wbia.algo.hots</span> <span class="kn">import</span> <span class="n">old_chip_match</span>
<span class="kn">from</span> <span class="nn">wbia.algo.hots</span> <span class="kn">import</span> <span class="n">scoring</span>
<span class="kn">from</span> <span class="nn">wbia.algo.hots</span> <span class="kn">import</span> <span class="n">name_scoring</span>
<span class="kn">from</span> <span class="nn">wbia.algo.hots</span> <span class="kn">import</span> <span class="n">_pipeline_helpers</span> <span class="k">as</span> <span class="n">plh</span>  <span class="c1"># NOQA</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="NeedRecomputeError"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.NeedRecomputeError">[docs]</a><span class="k">class</span> <span class="nc">NeedRecomputeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="n">DEBUG_CHIPMATCH</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># import six</span>

<span class="n">MAX_FNAME_LEN</span> <span class="o">=</span> <span class="mi">80</span> <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">WIN32</span> <span class="k">else</span> <span class="mi">200</span>
<span class="n">TRUNCATE_UUIDS</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--truncate-uuids&#39;</span><span class="p">,</span> <span class="s1">&#39;--trunc-uuids&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="safeop"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.safeop">[docs]</a><span class="k">def</span> <span class="nf">safeop</span><span class="p">(</span><span class="n">op_</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">xs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">op_</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="filtnorm_op"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.filtnorm_op">[docs]</a><span class="k">def</span> <span class="nf">filtnorm_op</span><span class="p">(</span><span class="n">filtnorm_</span><span class="p">,</span> <span class="n">op_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="kc">None</span>
        <span class="k">if</span> <span class="n">filtnorm_</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="p">[</span><span class="n">safeop</span><span class="p">(</span><span class="n">op_</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">filtnorm_</span><span class="p">]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="extend_scores"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.extend_scores">[docs]</a><span class="k">def</span> <span class="nf">extend_scores</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span></div>


<div class="viewcode-block" id="extend_nplists_"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.extend_nplists_">[docs]</a><span class="k">def</span> <span class="nf">extend_nplists_</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x_list</span> <span class="o">+</span> <span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span></div>


<div class="viewcode-block" id="extend_pylist_"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.extend_pylist_">[docs]</a><span class="k">def</span> <span class="nf">extend_pylist_</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x_list</span> <span class="o">+</span> <span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span><span class="p">)</span></div>


<div class="viewcode-block" id="extend_nplists"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.extend_nplists">[docs]</a><span class="k">def</span> <span class="nf">extend_nplists</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">safeop</span><span class="p">(</span><span class="n">extend_nplists_</span><span class="p">,</span> <span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="extend_pylist"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.extend_pylist">[docs]</a><span class="k">def</span> <span class="nf">extend_pylist</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">safeop</span><span class="p">(</span><span class="n">extend_pylist_</span><span class="p">,</span> <span class="n">x_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_numpy_lists"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.convert_numpy_lists">[docs]</a><span class="k">def</span> <span class="nf">convert_numpy_lists</span><span class="p">(</span><span class="n">arr_list</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">new_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">atleast_nd</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">new_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_arrs</span></div>


<div class="viewcode-block" id="safecast_numpy_lists"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.safecast_numpy_lists">[docs]</a><span class="k">def</span> <span class="nf">safecast_numpy_lists</span><span class="p">(</span><span class="n">arr_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arr_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_arrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">new_arrs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_arrs</span></div>


<div class="viewcode-block" id="aslist"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.aslist">[docs]</a><span class="k">def</span> <span class="nf">aslist</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="convert_numpy"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.convert_numpy">[docs]</a><span class="k">def</span> <span class="nf">convert_numpy</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_arrs_eq"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.check_arrs_eq">[docs]</a><span class="k">def</span> <span class="nf">check_arrs_eq</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arr1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">arr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arr1</span> <span class="o">==</span> <span class="n">arr2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr2</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="safe_check_lens_eq"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.safe_check_lens_eq">[docs]</a><span class="k">def</span> <span class="nf">safe_check_lens_eq</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if it is safe to check if two arrays are equal</span>

<span class="sd">    safe_check_lens_eq(None, 1)</span>
<span class="sd">    safe_check_lens_eq([3], [2, 4])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;outer lengths do not correspond&#39;</span>
    <span class="k">if</span> <span class="n">arr1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">arr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr2</span><span class="p">),</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;(</span><span class="si">%r</span><span class="s1"> != </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr2</span><span class="p">))</span></div>


<div class="viewcode-block" id="safe_check_nested_lens_eq"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.safe_check_nested_lens_eq">[docs]</a><span class="k">def</span> <span class="nf">safe_check_nested_lens_eq</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if it is safe to check if two arrays are equal (nested)</span>

<span class="sd">    safe_check_nested_lens_eq(None, 1)</span>
<span class="sd">    safe_check_nested_lens_eq([[3, 4]], [[2, 4]])</span>
<span class="sd">    safe_check_nested_lens_eq([[1, 2, 3], [1, 2]], [[1, 2, 3], [1, 2]])</span>
<span class="sd">    safe_check_nested_lens_eq([[1, 2, 3], [1, 2]], [[1, 2, 3], [1]])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">arr1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">arr2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">safe_check_lens_eq</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="s1">&#39;outer lengths do not correspond&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">y</span>
            <span class="p">),</span> <span class="s1">&#39;inner lengths at position=</span><span class="si">%r</span><span class="s1"> do not correspond (</span><span class="si">%r</span><span class="s1"> != </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">count</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
            <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_assert_eq_len</span><span class="p">(</span><span class="n">list1_</span><span class="p">,</span> <span class="n">list2_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">list1_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq_len</span><span class="p">(</span><span class="n">list1_</span><span class="p">,</span> <span class="n">list2_</span><span class="p">)</span>


<div class="viewcode-block" id="prepare_dict_uuids"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.prepare_dict_uuids">[docs]</a><span class="k">def</span> <span class="nf">prepare_dict_uuids</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hacks to ensure proper uuid conversion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">class_dict</span> <span class="o">=</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;qaid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span> <span class="ow">and</span> <span class="s1">&#39;qannot_uuid&#39;</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">:</span>
        <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_aids_from_uuid</span><span class="p">(</span><span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qannot_uuid&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;daid_list&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span> <span class="ow">and</span> <span class="s1">&#39;dannot_uuid_list&#39;</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">:</span>
        <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;daid_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_aids_from_uuid</span><span class="p">(</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dannot_uuid_list&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;dnid_list&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span> <span class="ow">and</span> <span class="s1">&#39;dannot_uuid_list&#39;</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">:</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;daid_list&#39;</span><span class="p">]</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_rowids_from_text</span><span class="p">(</span><span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dname_list&#39;</span><span class="p">])</span>
        <span class="c1"># if anything is unknown need to set to be negative daid</span>
        <span class="n">check_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span><span class="p">])</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="o">-</span><span class="n">daid</span> <span class="k">if</span> <span class="n">dnid</span> <span class="ow">in</span> <span class="n">check_set</span> <span class="k">else</span> <span class="n">dnid</span>
            <span class="k">for</span> <span class="n">daid</span><span class="p">,</span> <span class="n">dnid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">dnid_list</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dnid_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dnid_list</span>
    <span class="k">if</span> <span class="s1">&#39;qnid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span> <span class="ow">and</span> <span class="s1">&#39;qname&#39;</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">:</span>
        <span class="n">qnid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_rowids_from_text</span><span class="p">(</span><span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qname&#39;</span><span class="p">])</span>
        <span class="c1"># if anything is unknown need to set to be negative daid</span>
        <span class="n">qaid</span> <span class="o">=</span> <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qaid&#39;</span><span class="p">]</span>
        <span class="n">qnid</span> <span class="o">=</span> <span class="o">-</span><span class="n">qaid</span> <span class="k">if</span> <span class="n">qnid</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_NAME_ROWID</span> <span class="k">else</span> <span class="n">qnid</span>
        <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qnid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnid</span>
    <span class="k">if</span> <span class="s1">&#39;unique_nids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_dict</span> <span class="ow">and</span> <span class="s1">&#39;unique_name_list&#39;</span> <span class="ow">in</span> <span class="n">class_dict</span><span class="p">:</span>
        <span class="c1"># FIXME: there is no notion of which names belong to this nid</span>
        <span class="c1"># unique_nids = ibs.get_name_rowids_from_text(class_dict[&#39;unique_name_list&#39;])</span>
        <span class="c1"># class_dict[&#39;unique_nids&#39;] = unique_nids</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dnid_list&#39;</span><span class="p">]</span>
        <span class="c1"># This will probably work... for the short term</span>
        <span class="n">unique_nids_</span><span class="p">,</span> <span class="n">name_groupxs_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">))</span>
        <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;unique_nids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_nids_</span>
    <span class="k">return</span> <span class="n">class_dict</span></div>


<span class="k">class</span> <span class="nc">_ChipMatchVisualization</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class containing the visualization function for ChipMatch</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">show_single_namematch</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span>
        <span class="n">qreq_</span><span class="p">,</span>
        <span class="n">dnid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">homog</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--homog&#39;</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_single_namematch --show</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_single_namematch --show --qaid 1</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_single_namematch --show --qaid 1 \</span>
<span class="sd">                --dpath figures --save ~/latex/crall-candidacy-2015/figures/namematch.jpg</span>

<span class="sd">            python -m wbia --tf _ChipMatchVisualization.show_single_namematch --show --rank=0 --qaid=1 --save rank0.jpg</span>
<span class="sd">            python -m wbia --tf _ChipMatchVisualization.show_single_namematch --show --rank=1 --qaid=1 --save rank1.jpg</span>
<span class="sd">            python -m wbia --tf _ChipMatchVisualization.show_single_namematch --show --rank=2 --qaid=1 --save rank2.jpg</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;, default_qaids=[18])</span>
<span class="sd">            &gt;&gt;&gt; if True:</span>
<span class="sd">            &gt;&gt;&gt;     import matplotlib as mpl</span>
<span class="sd">            &gt;&gt;&gt;     from wbia.scripts.thesis import TMP_RC</span>
<span class="sd">            &gt;&gt;&gt;     mpl.rcParams.update(TMP_RC)</span>
<span class="sd">            &gt;&gt;&gt; from wbia.viz import viz_matches</span>
<span class="sd">            &gt;&gt;&gt; defaultkw = dict(ut.recursive_parse_kwargs(viz_matches.show_name_matches))</span>
<span class="sd">            &gt;&gt;&gt; kwargs = ut.argparse_dict(defaultkw, only_specified=True)</span>
<span class="sd">            &gt;&gt;&gt; kwargs.pop(&#39;qaid&#39;, None)</span>
<span class="sd">            &gt;&gt;&gt; _nid = ut.get_argval(&#39;--dnid&#39;, default=cm.qnid)</span>
<span class="sd">            &gt;&gt;&gt; rank = ut.get_argval(&#39;--rank&#39;, default=None)</span>
<span class="sd">            &gt;&gt;&gt; dnid = None if rank is not None else _nid</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, dnid=dnid, rank=rank, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.viz</span> <span class="kn">import</span> <span class="n">viz_matches</span>

        <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dnid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;must choose one&#39;</span>
        <span class="k">if</span> <span class="n">dnid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dnid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_rank_name</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
        <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;cm.nid2_nidx has not been evaluated yet&#39;</span><span class="p">)</span>
        <span class="c1"># &lt;GET NAME GROUPXS&gt;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
            <span class="c1"># if nidx == 144:</span>
            <span class="c1">#    raise</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># def extend():</span>
            <span class="c1"># pass</span>
            <span class="c1"># cm.daid_list</span>
            <span class="c1"># cm.print_inspect_str(qreq_)</span>
            <span class="c1"># cm_orig = cm  # NOQA</span>
            <span class="c1"># cm_orig.assert_self(qreq_)</span>
            <span class="c1"># other_aids = qreq_.daids</span>
            <span class="c1"># Hack to get rid of key error</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CHIP HAS NO GROUND TRUTH MATCHES&#39;</span><span class="p">)</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cm2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
            <span class="n">cm2</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">cm2</span>
            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
            <span class="c1"># raise</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="n">dnids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dnid</span> <span class="o">==</span> <span class="n">dnids</span><span class="p">),</span> <span class="s1">&#39;inconsistent naming, dnid=</span><span class="si">%r</span><span class="s1">, dnids=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">dnid</span><span class="p">,</span>
            <span class="n">dnids</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">daids</span> <span class="o">!=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
        <span class="c1"># &lt;/GET NAME GROUPXS&gt;</span>
        <span class="c1"># sort annots in this name by the chip score</span>
        <span class="c1"># HACK USE cm.annot_score_list</span>
        <span class="n">group_sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">groupxs</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">group_sortx</span><span class="p">)</span>
        <span class="c1"># get the info for this name</span>
        <span class="n">name_fm_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="n">REMOVE_EMPTY_MATCHES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_groupxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span>
        <span class="n">REMOVE_EMPTY_MATCHES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">REMOVE_EMPTY_MATCHES</span><span class="p">:</span>
            <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">name_fm_list</span><span class="p">])</span>
            <span class="n">MAX_MATCHES</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">isvalid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_at_least_n_items_valid</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">,</span> <span class="n">MAX_MATCHES</span><span class="p">)</span>
            <span class="n">name_fm_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">name_fm_list</span><span class="p">,</span> <span class="n">isvalid_list</span><span class="p">)</span>
            <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">sorted_groupxs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">)</span>

        <span class="n">name_H1_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">homog</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">name_fsv_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">name_fs_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">name_fsv_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">name_fsv_list</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">name_daid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c1"># find features marked as invalid by name scoring</span>
        <span class="n">featflag_list</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">get_chipmatch_namescore_nonvoting_feature_flags</span><span class="p">(</span>
            <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span>
        <span class="p">)</span>
        <span class="n">name_featflag_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">featflag_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c1"># Get the scores for names and chips</span>
        <span class="n">name_score</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">name_rank</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listfind</span><span class="p">(</span><span class="n">aslist</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">nidx</span><span class="p">)</span>
        <span class="n">name_annot_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sorted_groupxs</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">viz_matches</span><span class="o">.</span><span class="n">show_name_matches</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span>
            <span class="n">qaid</span><span class="p">,</span>
            <span class="n">name_daid_list</span><span class="p">,</span>
            <span class="n">name_fm_list</span><span class="p">,</span>
            <span class="n">name_fs_list</span><span class="p">,</span>
            <span class="n">name_H1_list</span><span class="p">,</span>
            <span class="n">name_featflag_list</span><span class="p">,</span>
            <span class="n">name_score</span><span class="o">=</span><span class="n">name_score</span><span class="p">,</span>
            <span class="n">name_rank</span><span class="o">=</span><span class="n">name_rank</span><span class="p">,</span>
            <span class="n">name_annot_scores</span><span class="o">=</span><span class="n">name_annot_scores</span><span class="p">,</span>
            <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
            <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_</span>

    <span class="k">def</span> <span class="nf">show_single_annotmatch</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">daid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">homog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: rename daid to aid2</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match show_single_annotmatch:0 --show</span>
<span class="sd">            python -m wbia.algo.hots.chip_match show_single_annotmatch:1 --show</span>

<span class="sd">            python -m wbia.algo.hots.chip_match show_single_annotmatch --show --qaids=5245 --daids=5161 --db PZ_Master1</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; daid = cm.groundtruth_daids[0]</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_annotmatch(qreq_, daid)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; # Make sure we can show results against an aid that wasn&#39;t matched</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; daid = ut.setdiff(qreq_.daids, cm.daid_list)[0]</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_annotmatch(qreq_, daid)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">            cm.compress_top_feature_matches(num=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.viz</span> <span class="kn">import</span> <span class="n">viz_matches</span>

        <span class="k">if</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">daid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;use aid2 instead of daid kwarg&#39;</span>
            <span class="n">daid</span> <span class="o">=</span> <span class="n">aid2</span>

        <span class="k">if</span> <span class="n">daid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">daid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">[</span><span class="n">daid</span><span class="p">]</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">H1</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">homog</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fsv</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">fsv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">showkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fm</span><span class="o">=</span><span class="n">fm</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">H1</span><span class="o">=</span><span class="n">H1</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">viz_matches</span><span class="o">.</span><span class="n">show_matches2</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="o">**</span><span class="n">showkw</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_ranked_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">clip_top</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the ranked-list of name/annot matches using matplotlib</span>

<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest): query request object with hyper-parameters</span>
<span class="sd">            clip_top (int): (default = 6)</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            fnum, figtitle, plottype, ...more</span>

<span class="sd">        SeeAlso:</span>
<span class="sd">            wbia.viz.viz_matches.show_matches2</span>
<span class="sd">            wbia.viz.viz_matches.show_name_matches</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_ranked_matches --show --qaid 1</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_ranked_matches --qaid 86 --colorbar_=False --show</span>
<span class="sd">            python -m wbia --tf ChipMatch.show_ranked_matches:0 --qaid 86 --colorbar_=False --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.viz import viz_matches</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; if True:</span>
<span class="sd">            &gt;&gt;&gt;     import matplotlib as mpl</span>
<span class="sd">            &gt;&gt;&gt;     from wbia.scripts.thesis import TMP_RC</span>
<span class="sd">            &gt;&gt;&gt;     mpl.rcParams.update(TMP_RC)</span>
<span class="sd">            &gt;&gt;&gt; cm_list, qreq_ = wbia.testdata_cmlist(&#39;PZ_MTEST&#39;, [1])</span>
<span class="sd">            &gt;&gt;&gt; defaultkw = dict(ut.recursive_parse_kwargs(viz_matches.show_name_matches))</span>
<span class="sd">            &gt;&gt;&gt; kwargs = ut.argparse_dict(defaultkw, only_specified=True)</span>
<span class="sd">            &gt;&gt;&gt; ut.delete_dict_keys(kwargs, [&#39;qaid&#39;])</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;plottype&#39;] = kwargs.get(&#39;plottype&#39;, &#39;namematch&#39;)</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; clip_top = ut.get_argval(&#39;--clip-top&#39;, default=3)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.repr2(kwargs, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, clip_top, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia.viz import viz_matches</span>
<span class="sd">            &gt;&gt;&gt; defaultkw = dict(ut.recursive_parse_kwargs(viz_matches.show_name_matches))</span>
<span class="sd">            &gt;&gt;&gt; kwargs = ut.argparse_dict(defaultkw, only_specified=True)</span>
<span class="sd">            &gt;&gt;&gt; kwargs.pop(&#39;qaid&#39;, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;plottype&#39;] = kwargs.get(&#39;plottype&#39;, &#39;namematch&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; clip_top = ut.get_argval(&#39;--clip-top&#39;, default=3)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.repr2(kwargs, nl=True),))</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, clip_top, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span> <span class="n">clip_top</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_index_matches</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_daids_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_index_matches</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_index_matches</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;annotmatch&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="k">if</span> <span class="n">fnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">next_fnum</span><span class="p">()</span>
        <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get_square_row_cols</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_list</span><span class="p">),</span> <span class="n">fix</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--vert&#39;</span><span class="p">):</span>
            <span class="c1"># HACK</span>
            <span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span> <span class="o">=</span> <span class="n">nCols</span><span class="p">,</span> <span class="n">nRows</span>
        <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="p">,</span> <span class="n">nCols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="n">daid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">pnum</span> <span class="o">=</span> <span class="n">next_pnum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s1">&#39;namematch&#39;</span><span class="p">:</span>
                <span class="n">dnid</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">daid</span><span class="p">)</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">show_single_namematch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">dnid</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s1">&#39;annotmatch&#39;</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">daid</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># FIXME:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">annot_score</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">score_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;score = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">,)</span> <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;score = None&#39;</span>
                <span class="p">)</span>
                <span class="n">annot_score_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;annot_score = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">annot_score</span><span class="p">,)</span>
                    <span class="k">if</span> <span class="n">annot_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="s1">&#39;annot_score = None&#39;</span>
                <span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">score_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">annot_score_str</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unknown plottype=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plottype</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">figtitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="n">figtitle</span><span class="p">)</span>

    <span class="n">show_matches</span> <span class="o">=</span> <span class="n">show_single_annotmatch</span>  <span class="c1"># HACK</span>

    <span class="k">def</span> <span class="nf">ishow_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iteract with a match to an individual annotation (or maybe name?)</span>

<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters</span>
<span class="sd">            aid2 (int):  annotation id(default = None)</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-ishow_single_annotmatch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; aid2 = None</span>
<span class="sd">            &gt;&gt;&gt; result = cm.ishow_single_annotmatch(qreq_, aid2, noupdate=True)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.viz.interact</span> <span class="kn">import</span> <span class="n">interact_matches</span>  <span class="c1"># NOQA</span>

        <span class="c1"># if aid == &#39;top&#39;:</span>
        <span class="c1">#    aid = cm.get_top_aids(ibs)</span>
        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">aid2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aid2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="n">ntop</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[cm] ishow_single_annotmatch aids(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span>
                <span class="n">aid2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">interact_matches</span><span class="o">.</span><span class="n">MatchInteraction</span><span class="p">(</span>
                <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span>
            <span class="p">)</span>
            <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">inter</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed in cm.ishow_single_annotmatch&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">,</span> <span class="s1">&#39;qreq_&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="c1"># if not kwargs.get(&#39;noupdate&#39;, False):</span>
        <span class="c1">#    import wbia.plottool as pt</span>
        <span class="c1">#    pt.update()</span>

    <span class="n">ishow_match</span> <span class="o">=</span> <span class="n">ishow_single_annotmatch</span>
    <span class="n">ishow_matches</span> <span class="o">=</span> <span class="n">ishow_single_annotmatch</span>

    <span class="k">def</span> <span class="nf">ishow_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-_ChipMatchVisualization.ishow_analysis --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; qaid = 18</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[qaid])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.ishow_analysis(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia.viz.interact</span> <span class="kn">import</span> <span class="n">interact_qres</span>

        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;show_query&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interact_qres</span><span class="o">.</span><span class="n">ishow_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">wbia.viz</span> <span class="kn">import</span> <span class="n">viz_qres</span>

        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;show_query&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">viz_qres</span><span class="o">.</span><span class="n">show_qres_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">imwrite_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-ChipMatch.imwrite_single_annotmatch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;dpi&#39;] = ut.get_argval(&#39;--dpi&#39;, int, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;figsize&#39;] = ut.get_argval(&#39;--figsize&#39;, list, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;fpath&#39;] = ut.get_argval(&#39;--fpath&#39;, str, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_fmatches&#39;] = not ut.get_argflag(&#39;--no-fmatches&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;vert&#39;] = ut.get_argflag(&#39;--vert&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_border&#39;] = ut.get_argflag(&#39;--draw_border&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;saveax&#39;] = ut.get_argflag(&#39;--saveax&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;in_image&#39;] = ut.get_argflag(&#39;--in-image&#39;)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_lbl&#39;] = ut.get_argflag(&#39;--no-draw-lbl&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.repr2(kwargs),))</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; aid = cm.get_top_aids()[0]</span>
<span class="sd">            &gt;&gt;&gt; img_fpath = cm.imwrite_single_annotmatch(qreq_, aid, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; # show the image dumped to disk</span>
<span class="sd">            &gt;&gt;&gt; ut.startfile(img_fpath, quote=True)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="c1"># Pop save kwargs from kwargs</span>
        <span class="n">save_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;figsize&#39;</span><span class="p">,</span> <span class="s1">&#39;saveax&#39;</span><span class="p">,</span> <span class="s1">&#39;fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;fpath_strict&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="n">save_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_pop</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">save_keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">savekw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">save_keys</span><span class="p">,</span> <span class="n">save_vals</span><span class="p">))</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">savekw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fpath&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;fpath_strict&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">savekw</span><span class="p">:</span>
            <span class="n">savekw</span><span class="p">[</span><span class="s1">&#39;usetitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">was_interactive</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">is_interactive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make new figure</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fnum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1"># fig = pt.figure(fnum=fnum, doclf=True, docla=True)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="c1"># Draw Matches</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">colorbar_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># if not kwargs.get(&#39;notitle&#39;, False):</span>
        <span class="c1">#    pt.set_figtitle(cm.make_smaller_title())</span>
        <span class="c1"># Save Figure</span>
        <span class="c1"># Setting fig=fig might make the dpi and figsize code not work</span>
        <span class="n">img_fpath</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="o">**</span><span class="n">savekw</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>  <span class="c1"># Ensure that this figure will not pop up</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">was_interactive</span><span class="p">)</span>
        <span class="c1"># if False:</span>
        <span class="c1">#    ut.startfile(img_fpath)</span>
        <span class="k">return</span> <span class="n">img_fpath</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">imwrite_single_annotmatch2</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        users newer rendering based code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="c1"># Pop save kwargs from kwargs</span>
        <span class="n">save_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;figsize&#39;</span><span class="p">,</span> <span class="s1">&#39;saveax&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="n">save_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_pop</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">save_keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">savekw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">save_keys</span><span class="p">,</span> <span class="n">save_vals</span><span class="p">))</span>
        <span class="n">was_interactive</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">is_interactive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make new figure</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fnum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1"># Create figure --- this takes about 19% - 11% of the time depending on settings</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Draw Matches --- this takes about 48% - 67% of the time depending on settings</span>
        <span class="c1"># wrapped call to show_matches2</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">colorbar_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Write matplotlib axes to an image</span>
        <span class="n">axes_extents</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">extract_axes_extents</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes_extents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;more than one axes&#39;</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">axes_extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># with io.BytesIO() as stream:</span>
        <span class="c1"># This call takes 23% - 15% of the time depending on settings</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="o">**</span><span class="n">savekw</span><span class="p">)</span>
        <span class="c1"># stream.seek(0)</span>
        <span class="c1"># data = np.fromstring(stream.getvalue(), dtype=np.uint8)</span>
        <span class="c1"># image = cv2.imdecode(data, 1)</span>
        <span class="c1"># Ensure that this figure will not pop up</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">was_interactive</span><span class="p">)</span>
        <span class="c1"># return image</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">render_single_annotmatch</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-_ChipMatchVisualization.render_single_annotmatch --show</span>
<span class="sd">            utprof.py -m wbia.algo.hots.chip_match --exec-_ChipMatchVisualization.render_single_annotmatch --show</span>
<span class="sd">            utprof.py -m wbia.algo.hots.chip_match --exec-_ChipMatchVisualization.render_single_annotmatch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;dpi&#39;] = ut.get_argval(&#39;--dpi&#39;, int, None)</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_fmatches&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;vert&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;show_score&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;show_timedelta&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_border&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;in_image&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; kwargs[&#39;draw_lbl&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;kwargs = %s&#39; % (ut.repr2(kwargs),))</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; aid = cm.get_top_aids()[0]</span>
<span class="sd">            &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; tt = ut.tic(&#39;render image&#39;)</span>
<span class="sd">            &gt;&gt;&gt; img = cm.render_single_annotmatch(qreq_, aid, **kwargs)</span>
<span class="sd">            &gt;&gt;&gt; ut.toc(tt)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; pt.imshow(img)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">io</span>
        <span class="kn">import</span> <span class="nn">cv2</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="c1"># Pop save kwargs from kwargs</span>
        <span class="n">save_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="s1">&#39;figsize&#39;</span><span class="p">,</span> <span class="s1">&#39;saveax&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="n">save_vals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take_pop</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">save_keys</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">savekw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">save_keys</span><span class="p">,</span> <span class="n">save_vals</span><span class="p">))</span>
        <span class="n">was_interactive</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">is_interactive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make new figure</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fnum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1"># Create figure --- this takes about 19% - 11% of the time depending on settings</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Draw Matches --- this takes about 48% - 67% of the time depending on settings</span>
        <span class="c1"># wrapped call to show_matches2</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">show_single_annotmatch</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">colorbar_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Write matplotlib axes to an image</span>
        <span class="n">axes_extents</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">extract_axes_extents</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes_extents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;more than one axes&#39;</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">axes_extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="c1"># This call takes 23% - 15% of the time depending on settings</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="o">**</span><span class="n">savekw</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Ensure that this figure will not pop up</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">was_interactive</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">was_interactive</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="k">def</span> <span class="nf">qt_inspect_gui</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ranks_top</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_scoring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ibs (IBEISController):  wbia controller object</span>
<span class="sd">            ranks_top (int): (default = 6)</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters(default = None)</span>
<span class="sd">            name_scoring (bool): (default = False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            QueryResult: qres_wgt -  object of feature correspondences and scores</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-qt_inspect_gui --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver(&#39;PZ_MTEST&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ranks_top = 6</span>
<span class="sd">            &gt;&gt;&gt; name_scoring = False</span>
<span class="sd">            &gt;&gt;&gt; qres_wgt = cm.qt_inspect_gui(ibs, ranks_top, qreq_, name_scoring)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import wbia.guitool</span>
<span class="sd">            &gt;&gt;&gt; guitool.qtapp_loop(qwin=qres_wgt)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[cm] qt_inspect_gui&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">wbia.gui</span> <span class="kn">import</span> <span class="n">inspect_gui</span>
        <span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">guitool</span>

        <span class="n">guitool</span><span class="o">.</span><span class="n">ensure_qapp</span><span class="p">()</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[inspect_matches] make_qres_widget&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span> <span class="o">=</span> <span class="n">inspect_gui</span><span class="o">.</span><span class="n">QueryResultsWidget</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">cm_list</span><span class="p">,</span> <span class="n">ranks_top</span><span class="o">=</span><span class="n">ranks_top</span><span class="p">,</span> <span class="n">name_scoring</span><span class="o">=</span><span class="n">name_scoring</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[inspect_matches] show&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[inspect_matches] raise&#39;</span><span class="p">)</span>
        <span class="n">qres_wgt</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qres_wgt</span>


<span class="k">class</span> <span class="nc">_ChipMatchScorers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluators evaluate the specific score and add it to a dictionary that can</span>
<span class="sd">    maintain multiple different types of scores. These dicts are:</span>
<span class="sd">        cm.algo_name_scores and cm.algo_annot_scores</span>

<span class="sd">    Cannoizers make a specific type of score cannonical via</span>
<span class="sd">    cm.score_list, cm.name_score_list, and cm.annot_score_list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Evaluators</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">evaluate_csum_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.scoring import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;testdb1&#39;, qaid_list=[1])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.evaluate_dnids(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; cm.qnid = 1   # Hack for testdb1 names</span>
<span class="sd">            &gt;&gt;&gt; gt_flags = cm.get_groundtruth_flags()</span>
<span class="sd">            &gt;&gt;&gt; cm.evaluate_csum_annot_score(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; annot_score_list = cm.algo_annot_scores[&#39;csum&#39;]</span>
<span class="sd">            &gt;&gt;&gt; assert annot_score_list[gt_flags].max() &gt; annot_score_list[~gt_flags].max()</span>
<span class="sd">            &gt;&gt;&gt; assert annot_score_list[gt_flags].max() &gt; 10.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_fsv_prod_list</span><span class="p">()</span>
        <span class="n">csum_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">fs_list</span><span class="p">])</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csum_scores</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">evaluate_nsum_name_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calls name scoring logic &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_dnids</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">fmech_scores</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">compute_fmech_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">normsum</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="o">.</span><span class="n">normsum</span>
            <span class="k">if</span> <span class="n">normsum</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;depricated&#39;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># cm.algo_name_scores[&#39;fmech&#39;] = fmech_scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;nsum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmech_scores</span>

    <span class="k">def</span> <span class="nf">evaluate_maxcsum_name_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">grouped_csum</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
        <span class="n">maxcsum_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">grouped_csum</span><span class="p">])</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;maxcsum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxcsum_scores</span>

    <span class="k">def</span> <span class="nf">evaluate_sumamech_name_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">grouped_csum</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
        <span class="n">sumamech_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scores</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">grouped_csum</span><span class="p">])</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;sumamech&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumamech_score_list</span>

    <span class="c1"># --- Cannonizers</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">score_annot_csum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-score_annot_csum --show</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-score_annot_csum --show --qaid 18</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_annot_csum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_annot_csum&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_annot_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">])</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">score_name_maxcsum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is amech from the thesis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_dnids</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_annot_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_maxcsum_name_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;maxcsum&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">score_name_nsum</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is fmech from the thesis</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-score_name_nsum --show --qaid 1</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-score_name_nsum --show --qaid 18 -t default:normsum=True</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; qreq_, args = plh.testdata_pre(&#39;end&#39;, defaultdb=&#39;PZ_MTEST&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                                a=[&#39;default&#39;], qaid_override=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = args.cm_list_SVER[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; gt_score = cm.score_list.compress(cm.get_groundtruth_flags()).max()</span>
<span class="sd">            &gt;&gt;&gt; cm.print_csv()</span>
<span class="sd">            &gt;&gt;&gt; top_nid = cm.unique_nids[cm.name_score_list.argmax()]</span>
<span class="sd">            &gt;&gt;&gt; assert cm.get_top_nids()[0] == top_nid, &#39;bug in alignment&#39;</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.show_ranked_matches(qreq_, figtitle=&#39;score_name_nsum&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">            &gt;&gt;&gt; assert cm.get_top_nids()[0] == cm.qnid, &#39;is this case truely hard?&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_annot_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_nsum_name_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;nsum&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">score_name_sumamech</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_csum_annot_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">evaluate_sumamech_name_score</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">set_cannonical_name_score</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;sumamech&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<div class="viewcode-block" id="MatchBaseIO"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.MatchBaseIO">[docs]</a><span class="k">class</span> <span class="nc">MatchBaseIO</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MatchBaseIO.load_from_fpath"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.MatchBaseIO.load_from_fpath">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_from_fpath</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MatchBaseIO.save_to_fpath"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.MatchBaseIO.save_to_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_fpath</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python wbia --tf MatchBaseIO.save_to_fpath --verbtest --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; qaid = 18</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[qaid])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; dpath = ut.get_app_resource_dir(&#39;wbia&#39;)</span>
<span class="sd">            &gt;&gt;&gt; fpath = join(dpath, &#39;tmp_chipmatch.cPkl&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ut.delete(fpath)</span>
<span class="sd">            &gt;&gt;&gt; cm.save_to_fpath(fpath)</span>
<span class="sd">            &gt;&gt;&gt; cm2 = ChipMatch.load_from_fpath(fpath)</span>
<span class="sd">            &gt;&gt;&gt; assert cm == cm2</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.ishow_analysis(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ut.save_data(fpath, cm.__getstate__(), verbose=verbose)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">return</span> <span class="n">state_dict</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;algo_annot_scores&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_dict</span> <span class="ow">and</span> <span class="s1">&#39;algo_name_scores&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
            <span class="c1"># Move to new dict algo score interface</span>
            <span class="c1"># This can be removed once we are sure all caches made before this</span>
            <span class="c1"># change have been recomputed or deleted.</span>
            <span class="n">algo_annot_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">_special_annot_scores</span><span class="p">}</span>
            <span class="n">algo_name_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">_special_name_scores</span><span class="p">}</span>
            <span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;csum_score_list&#39;</span><span class="p">]</span>
            <span class="n">algo_name_scores</span><span class="p">[</span><span class="s1">&#39;nsum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;nsum_score_list&#39;</span><span class="p">]</span>
            <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;algo_annot_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algo_annot_scores</span>
            <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;algo_name_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algo_name_scores</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;csum_score_list&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;nsum_score_list&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;acov_score_list&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;ncov_score_list&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;maxcsum_score_list&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;special_annot_scores&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="s1">&#39;special_name_scores&#39;</span><span class="p">]</span>
        <span class="n">cm</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

<div class="viewcode-block" id="MatchBaseIO.copy"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.MatchBaseIO.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>
        <span class="n">out</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div></div>


<span class="k">class</span> <span class="nc">_BaseVisualization</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">show_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># HACK FOR ANNOT MATCH (HUMPBACKS)</span>
        <span class="kn">from</span> <span class="nn">wbia.viz</span> <span class="kn">import</span> <span class="n">viz_qres</span>

        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;show_query&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;\n&#39;)</span>
        <span class="c1"># logger.info(&quot;???? HACK SHOW QRES ANALYSIS&quot;)</span>
        <span class="k">return</span> <span class="n">viz_qres</span><span class="o">.</span><span class="n">show_qres_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ishow_analysis</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># HACK FOR ANNOT MATCH (HUMPBACKS)</span>
        <span class="kn">from</span> <span class="nn">wbia.viz.interact</span> <span class="kn">import</span> <span class="n">interact_qres</span>

        <span class="n">kwshow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;show_query&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;show_timedelta&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwshow</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interact_qres</span><span class="o">.</span><span class="n">ishow_analysis</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwshow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_single_namematch</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">dnid</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">homog</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--homog&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        HACK FOR ANNOT MATCH</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># HACK FOR ANNOT MATCH (HUMPBACKS)</span>
        <span class="c1"># logger.info(&#39;\n&#39;)</span>
        <span class="c1"># logger.info(&quot;???? HACK SHOW SINGLE NAME MATCH&quot;)</span>
        <span class="kn">from</span> <span class="nn">wbia.viz</span> <span class="kn">import</span> <span class="n">viz_matches</span>

        <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;cm.nid2_nidx has not been evaluated yet&#39;</span><span class="p">)</span>
            <span class="c1"># cm.score_name_nsum(qreq_)</span>
        <span class="c1"># &lt;GET NAME GROUPXS&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># cm.print_inspect_str(qreq_)</span>
            <span class="n">cm_orig</span> <span class="o">=</span> <span class="n">cm</span>  <span class="c1"># NOQA</span>
            <span class="n">cm_orig</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
            <span class="c1"># Hack to get rid of key error</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cm2</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">extend_results</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
            <span class="n">cm2</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">cm2</span>
            <span class="n">nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">[</span><span class="n">dnid</span><span class="p">]</span>
            <span class="c1"># raise</span>
        <span class="c1"># &lt;/GET NAME GROUPXS&gt;</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="n">dnids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dnid</span> <span class="o">==</span> <span class="n">dnids</span><span class="p">),</span> <span class="s1">&#39;inconsistent naming, dnid=</span><span class="si">%r</span><span class="s1">, dnids=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">dnid</span><span class="p">,</span>
            <span class="n">dnids</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">daids</span> <span class="o">!=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
        <span class="c1"># &lt;/GET NAME GROUPXS&gt;</span>
        <span class="c1"># sort annots in this name by the chip score</span>
        <span class="n">group_sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">groupxs</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_groupxs</span> <span class="o">=</span> <span class="n">groupxs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">group_sortx</span><span class="p">)</span>
        <span class="c1"># get the info for this name</span>
        <span class="n">name_daid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sorted_groupxs</span><span class="p">)</span>
        <span class="c1"># find features marked as invalid by name scoring</span>
        <span class="c1"># Get the scores for names and chips</span>
        <span class="n">name_score</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">[</span><span class="n">nidx</span><span class="p">]</span>
        <span class="n">name_rank</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listfind</span><span class="p">(</span><span class="n">aslist</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">nidx</span><span class="p">)</span>
        <span class="n">name_annot_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sorted_groupxs</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># logger.info(&#39;kwargs.copy = %r&#39; % (kwargs,))</span>
        <span class="c1"># draw_fmatches = kwargs.get(&#39;draw_fmatches&#39;, True)</span>
        <span class="c1"># MEGAHACK TO DEAL WITH OLD EXPLICIT ELLIPSE FEATURES</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;draw_fmatches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;draw_ell&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_matches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">viz_matches</span><span class="o">.</span><span class="n">show_name_matches</span><span class="p">(</span>
            <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">,</span>
            <span class="n">qaid</span><span class="p">,</span>
            <span class="n">name_daid_list</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">name_score</span><span class="o">=</span><span class="n">name_score</span><span class="p">,</span>
            <span class="n">name_rank</span><span class="o">=</span><span class="n">name_rank</span><span class="p">,</span>
            <span class="n">name_annot_scores</span><span class="o">=</span><span class="n">name_annot_scores</span><span class="p">,</span>
            <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
            <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_</span>


<span class="k">class</span> <span class="nc">_AnnotMatchConvenienceGetter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># @property</span>
    <span class="c1"># def algo_annot_scores(cm):</span>
    <span class="c1">#     attrs = [score_method + &#39;_score_list&#39; for score_method in cm._special_annot_scores]</span>
    <span class="c1">#     algo_annot_scores = ut.ClassAttrDictProxy(cm, cm._special_annot_scores, attrs)</span>
    <span class="c1">#     return algo_annot_scores</span>

    <span class="c1"># @property</span>
    <span class="c1"># def algo_name_scores(cm):</span>
    <span class="c1">#     attrs = [score_method + &#39;_score_list&#39; for score_method in cm._special_name_scores]</span>
    <span class="c1">#     algo_name_scores = ut.ClassAttrDictProxy(cm, cm._special_name_scores, attrs)</span>
    <span class="c1">#     return algo_name_scores</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># Score-Based Result Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">pandas_annot_info</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;daid&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>
            <span class="s1">&#39;dnid&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span>
            <span class="s1">&#39;rank&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span>
            <span class="s1">&#39;truth&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">annot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">annot_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">annot_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">annot_df</span>

    <span class="k">def</span> <span class="nf">pandas_name_info</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dnid&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span>
            <span class="s1">&#39;rank&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),</span>
            <span class="s1">&#39;truth&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">name_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">name_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">name_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name_df</span>

    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize info about the groundtruth and the best groundfalse.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ibs = qreq_.ibs</span>

        <span class="n">cminfo_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="c1"># annot props</span>
            <span class="n">gt_aid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_aid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gt_annot_daid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_annot_daid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gt_annot_rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_annot_rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gt_annot_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_annot_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="c1"># name props</span>
            <span class="n">gt_name_rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_name_rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gt_name_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">gf_name_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Name and annot info sorted by rank</span>
        <span class="n">name_df</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">pandas_name_info</span><span class="p">()</span>
        <span class="n">annot_df</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">pandas_annot_info</span><span class="p">()</span>

        <span class="n">name_df</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">pandas_name_info</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">truth</span><span class="p">,</span> <span class="n">tstr</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;gf&#39;</span><span class="p">)]:</span>
            <span class="c1"># Name properties</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">name_df</span><span class="p">[</span><span class="s1">&#39;truth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">truth</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">]:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_name_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tstr</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
                    <span class="n">cminfo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_df</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># else:</span>
            <span class="c1">#     if truth == 0 and len(cm.dnid_list) &lt; len(name_df):</span>
            <span class="c1">#         # Handle the case where the cm list is not extended</span>
            <span class="c1">#         randrank = np.random.randint(len(cm.dnid_list), len(name_df))</span>
            <span class="c1">#         key = &#39;{}_name_{}&#39;.format(tstr, &#39;rank&#39;)</span>
            <span class="c1">#         cminfo_dict[key] = randrank</span>
            <span class="c1">#         key = &#39;{}_name_{}&#39;.format(tstr, &#39;score&#39;)</span>
            <span class="c1">#         cminfo_dict[key] = -np.inf</span>

            <span class="c1"># Annot properties</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">annot_df</span><span class="p">[</span><span class="s1">&#39;truth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">truth</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;daid&#39;</span><span class="p">]:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_annot_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tstr</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
                    <span class="n">cminfo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">annot_df</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">cminfo_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">gt_aid</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gt_annot_daid&#39;</span><span class="p">],</span>
                <span class="n">gf_aid</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gf_annot_daid&#39;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gt_annot_daid&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gf_annot_daid&#39;</span><span class="p">]</span>

        <span class="c1"># old aliases</span>
        <span class="n">cminfo_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">gt_rank</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gt_annot_rank&#39;</span><span class="p">],</span>
                <span class="n">gf_rank</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gf_annot_rank&#39;</span><span class="p">],</span>
                <span class="n">gt_raw_score</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gt_annot_score&#39;</span><span class="p">],</span>
                <span class="n">gf_raw_score</span><span class="o">=</span><span class="n">cminfo_dict</span><span class="p">[</span><span class="s1">&#39;gf_annot_score&#39;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cminfo_dict</span>

    <span class="c1"># def get_ranked_nids_and_aids(cm):</span>
    <span class="c1">#     &quot;&quot;&quot; Hacky func</span>
    <span class="c1">#     Returns:</span>
    <span class="c1">#         wbia.algo.hots.name_scoring.NameScoreTup</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     sortx = cm.name_score_list.argsort()[::-1]</span>
    <span class="c1">#     sorted_name_scores = cm.name_score_list.take(sortx, axis=0)</span>
    <span class="c1">#     sorted_nids = cm.unique_nids.take(sortx, axis=0)</span>
    <span class="c1">#     sorted_groupxs = ut.take(cm.name_groupxs, sortx)</span>
    <span class="c1">#     sorted_daids = vt.apply_grouping(cm.daid_list,  sorted_groupxs)</span>
    <span class="c1">#     sorted_annot_scores = vt.apply_grouping(cm.annot_score_list,  sorted_groupxs)</span>
    <span class="c1">#     # do subsorting</span>
    <span class="c1">#     subsortx_list = [scores.argsort()[::-1] for scores in sorted_annot_scores]</span>
    <span class="c1">#     subsorted_daids = vt.ziptake(sorted_daids, subsortx_list)</span>
    <span class="c1">#     subsorted_annot_scores = vt.ziptake(sorted_annot_scores, subsortx_list)</span>
    <span class="c1">#     nscoretup = name_scoring.NameScoreTup(sorted_nids, sorted_name_scores,</span>
    <span class="c1">#                                           subsorted_daids,</span>
    <span class="c1">#                                           subsorted_annot_scores)</span>
    <span class="c1">#     return nscoretup</span>

    <span class="k">def</span> <span class="nf">get_annot_ave_precision</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sklearn.metrics</span>

        <span class="n">annot_df</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">pandas_annot_info</span><span class="p">()</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">annot_df</span><span class="p">[</span><span class="s1">&#39;truth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_score</span> <span class="o">=</span> <span class="n">annot_df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">avep</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_score</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;avep = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">avep</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">avep</span>

    <span class="k">def</span> <span class="nf">get_name_ave_precision</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">sklearn.metrics</span>

        <span class="n">name_df</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">pandas_name_info</span><span class="p">()</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">name_df</span><span class="p">[</span><span class="s1">&#39;truth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_score</span> <span class="o">=</span> <span class="n">name_df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">avep</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_score</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;avep = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">avep</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">avep</span>

    <span class="k">def</span> <span class="nf">get_top_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_scores</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">top_scores</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_scores</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_scores</span>

    <span class="k">def</span> <span class="nf">get_top_nids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sortx_</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">sortx_</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)]</span>
        <span class="n">top_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_nids</span>

    <span class="k">def</span> <span class="nf">get_top_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">top_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_aids</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_aids</span>

    <span class="k">def</span> <span class="nf">get_top_truth_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">truth</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; top scoring aids of a certain truth value &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">_top_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>

        <span class="n">isunknown_list</span> <span class="o">=</span> <span class="n">_top_nids</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">isunknown_list</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">truth_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">==</span> <span class="n">_top_nids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">truth_list</span><span class="p">[</span><span class="n">isunknown_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">UNKNOWN</span>

        <span class="c1"># truth_list = ibs.get_match_truths([cm.qaid] * len(_top_aids), _top_aids)</span>
        <span class="n">flag_list</span> <span class="o">=</span> <span class="n">truth_list</span> <span class="o">==</span> <span class="n">truth</span>
        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flag_list</span><span class="p">)</span>
        <span class="n">_top_aids</span> <span class="o">=</span> <span class="n">_top_aids</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">top_truth_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">_top_aids</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">top_truth_aids</span>

    <span class="k">def</span> <span class="nf">get_top_gf_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">NEGATIVE</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_top_gt_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_truth_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">EVIDENCE_DECISION</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">,</span> <span class="n">ntop</span><span class="p">)</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># Getter Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">get_name_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">dnids</span><span class="p">):</span>
        <span class="c1"># idx_list = [cm.daid2_idx.get(daid, None) for daid in daids]</span>
        <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">dnids</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">nidx_list</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">score_list</span>

    <span class="k">def</span> <span class="nf">get_name_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">dnids</span><span class="p">):</span>  <span class="c1"># score_method=None):</span>
        <span class="n">score_ranks</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">dnids</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rank_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_ranks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rank_list</span>

    <span class="c1"># def get_nid_scores(cm, nid_list):</span>
    <span class="c1">#     nidx_list = ut.dict_take(cm.nid2_nidx, nid_list)</span>
    <span class="c1">#     name_scores = vt.list_take_(cm.name_score_list, nidx_list)</span>
    <span class="c1">#     return name_scores</span>

    <span class="k">def</span> <span class="nf">get_rank_name</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="n">sorted_nids</span><span class="p">,</span> <span class="n">sorted_name_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_ranked_nids</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sorted_nids</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_ranked_nids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_name_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sorted_nids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_nids</span><span class="p">,</span> <span class="n">sorted_name_scores</span>

    <span class="k">def</span> <span class="nf">get_annot_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="n">score_method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: how to specify either annot_score_list or score_list?</span>
        <span class="c1"># score_list = cm.annot_score_list</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">score_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">score_list</span>

    <span class="k">def</span> <span class="nf">get_annot_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daids</span><span class="p">):</span>  <span class="c1"># score_method=None):</span>
        <span class="n">score_ranks</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daids</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">rank_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_ranks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rank_list</span>

    <span class="k">def</span> <span class="nf">get_groundtruth_flags</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;run cm.evaluate_dnids&#39;</span>
        <span class="n">gt_flags</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
        <span class="k">return</span> <span class="n">gt_flags</span>

    <span class="k">def</span> <span class="nf">get_groundtruth_daids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">gt_flags</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_groundtruth_flags</span><span class="p">()</span>
        <span class="n">gt_daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_compress_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">gt_flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gt_daids</span>

    <span class="k">def</span> <span class="nf">get_groundfalse_daids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">gf_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_groundtruth_flags</span><span class="p">())</span>
        <span class="n">gf_daids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_compress_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">gf_flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gf_daids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groundtruth_daids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_groundtruth_daids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_num_matches_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">num_matches_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num_matches_list</span>

    <span class="k">def</span> <span class="nf">get_name_shortlist_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">nNameShortList</span><span class="p">,</span> <span class="n">nAnnotPerName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; top_daids = cm.get_name_shortlist_aids(5, 2)</span>
<span class="sd">            &gt;&gt;&gt; assert cm.qnid in ibs.get_annot_name_rowids(top_daids)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_daids</span> <span class="o">=</span> <span class="n">scoring</span><span class="o">.</span><span class="n">get_name_shortlist_aids</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span>
            <span class="n">nNameShortList</span><span class="p">,</span>
            <span class="n">nAnnotPerName</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">top_daids</span>

    <span class="k">def</span> <span class="nf">get_annot_shortlist_aids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">num_shortlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; top_daids = cm.get_annot_shortlist_aids(5 * 2)</span>
<span class="sd">            &gt;&gt;&gt; assert cm.qnid in ibs.get_annot_name_rowids(top_daids)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">topx</span> <span class="o">=</span> <span class="n">sortx</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_shortlist</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span>
        <span class="n">top_daids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">[</span><span class="n">topx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">top_daids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_daids</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sortx</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unique_name_ranks</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_argsort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sortx</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">argsort</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no annot scores computed&#39;</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sortx</span>

    <span class="k">def</span> <span class="nf">name_argsort</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no name scores computed&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="AnnotMatch"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch">[docs]</a><span class="k">class</span> <span class="nc">AnnotMatch</span><span class="p">(</span>
    <span class="n">MatchBaseIO</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">,</span> <span class="n">_BaseVisualization</span><span class="p">,</span> <span class="n">_AnnotMatchConvenienceGetter</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This implements part the match between whole annotations and the other</span>
<span class="sd">    annotaions / names. This does not include algorithm specific feature</span>
<span class="sd">    matches.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attr_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;qaid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;qnid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;daid_list&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dnid_list&#39;</span><span class="p">,</span>
        <span class="s1">&#39;H_list&#39;</span><span class="p">,</span>
        <span class="s1">&#39;score_list&#39;</span><span class="p">,</span>
        <span class="s1">&#39;annot_score_list&#39;</span><span class="p">,</span>
        <span class="s1">&#39;unique_nids&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name_score_list&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">_special_annot_scores</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;csum&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;acov&#39;,</span>
    <span class="p">]</span>

    <span class="c1"># Special name scores</span>
    <span class="n">_special_name_scores</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;nsum&#39;</span><span class="p">,</span>  <span class="c1"># fmech</span>
        <span class="s1">&#39;maxcsum&#39;</span><span class="p">,</span>  <span class="c1"># amech</span>
        <span class="s1">&#39;sumamech&#39;</span><span class="p">,</span>  <span class="c1"># amech</span>
        <span class="c1"># &#39;ncov&#39;,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># This is aligned with daid list, do not confuse with unique_nids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># standard groupings</span>
        <span class="c1"># TODO: rename unique_nids to indicate it is aligned with name_groupxs</span>
        <span class="c1"># Annot scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Name scores</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># belongs to name_groupxs</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">_special_annot_scores</span><span class="p">}</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">_special_name_scores</span><span class="p">}</span>
        <span class="c1"># for score_method in cm._special_name_scores:</span>
        <span class="c1">#     setattr(cm, score_method + &#39;_score_list&#39;, None)</span>
        <span class="c1"># for score_method in cm._special_annot_scores:</span>
        <span class="c1">#     setattr(cm, score_method + &#39;_score_list&#39;, None)</span>
        <span class="c1"># Re-evaluatables (for convinience only)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># maps onto cm.daid_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># maps onto cm.unique_nids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;qaid=</span><span class="si">%s</span><span class="s1"> nD=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">num_daids</span><span class="p">)</span>

<div class="viewcode-block" id="AnnotMatch.initialize"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span>
        <span class="n">qaid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">daid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dnid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">qnid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name_score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">annot_score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qaid and daid_list are not optional. fm_list and fsv_list are strongly</span>
<span class="sd">        encouraged and will probalby break things if they are not there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="o">=</span> <span class="n">qaid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="c1"># name info</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">qnid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">dnid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">unique_nids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autoinit</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">DEBUG_CHIPMATCH</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnnotMatch.to_dict"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">class_dict</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;need ibs to convert uuids&#39;</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dannot_uuid_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;dname_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">)</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qannot_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_uuids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
            <span class="n">class_dict</span><span class="p">[</span><span class="s1">&#39;qname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_name_texts</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_dict</span></div>

<div class="viewcode-block" id="AnnotMatch.from_dict"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert dict of arguments back to ChipMatch object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">ChipMatch</span><span class="o">.</span><span class="n">initialize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># HACKY</span>
        <span class="n">key_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;autoinit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">other_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">class_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">key_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Not unserializing extra attributes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">other_keys</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_dict</span> <span class="o">=</span> <span class="n">prepare_dict_uuids</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="p">)</span>

        <span class="n">dict_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">key_list</span><span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy</span><span class="p">(</span>
            <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">],</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span>
        <span class="p">)</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">dict_subset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span></div>

    <span class="k">def</span> <span class="nf">_update_daid_index</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuilds inverted index from aid to internal index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_unique_nid_index</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuilds inverted index from nid to internal (name) index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assert cm.unique_nids is not None</span>
        <span class="n">unique_nids_</span><span class="p">,</span> <span class="n">name_groupxs_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">)</span>
        <span class="c1"># assert unique_nids_.dtype == hstypes.INTEGER_TYPE</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name score is misaligned&#39;</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">unique_nids_</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_index_lookup</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
        <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">unique_nids_</span><span class="p">))</span>
        <span class="n">inverse_idx_list</span> <span class="o">=</span> <span class="n">nidx_list</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">name_groupxs_</span><span class="p">,</span> <span class="n">inverse_idx_list</span><span class="p">)</span>

<div class="viewcode-block" id="AnnotMatch.evaluate_dnids"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.evaluate_dnids">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_dnids</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># cm.qnid = qreq_.qannots.loc([cm.qaid]).nids[0]</span>
            <span class="c1"># dnid_list = qreq_.dannots.loc(cm.daid_list).nids</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_qreq_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_qreq_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="c1"># ibs = qreq_.ibs</span>
        <span class="k">elif</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;no source of dnids&#39;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span></div>

    <span class="c1"># ------------------</span>
    <span class="c1"># State Modification Functions</span>
    <span class="c1"># ------------------</span>

    <span class="c1"># Cannonical Setters</span>

<div class="viewcode-block" id="AnnotMatch.set_cannonical_annot_score"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.set_cannonical_annot_score">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">set_cannonical_annot_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">annot_score_list</span>
        <span class="c1"># cm.name_score_list  = None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">annot_score_list</span></div>

<div class="viewcode-block" id="AnnotMatch.set_cannonical_name_score"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.AnnotMatch.set_cannonical_name_score">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">set_cannonical_name_score</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="c1"># align with score_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">name_scoring</span><span class="o">.</span><span class="n">align_name_scores_with_annots</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">,</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_ChipMatchConvenienceGetter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># Getter Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">get_flat_fm_info</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: info_</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-get_flat_fm_info --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_pre_sver(</span>
<span class="sd">            &gt;&gt;&gt;     defaultdb=&#39;PZ_MTEST&#39;, qaid_list=[18])</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; info_ = cm.get_flat_fm_info()</span>
<span class="sd">            &gt;&gt;&gt; ut.assert_all_eq(ut.lmap(len, info_.values()))</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;info_ = %s&#39; % (ut.repr3(info_, precision=2),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="c1"># flags = cm.score_list &gt; 0</span>
        <span class="c1"># Compress to desired info</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">fm_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="c1"># Flatten on a feature level</span>
        <span class="n">len_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
        <span class="n">info_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nfilt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>
        <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;fsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">safe_cat</span><span class="p">(</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nfilt</span><span class="p">))</span>
        <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;fm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">safe_cat</span><span class="p">(</span>
            <span class="n">fm_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">default_dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FM_DTYPE</span>
        <span class="p">)</span>
        <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;aid1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">len_list</span><span class="p">),</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">info_</span><span class="p">[</span><span class="s1">&#39;aid2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">safe_cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">daid</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">daid</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">len_list</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">default_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span>
            <span class="n">default_dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">info_</span>

    <span class="k">def</span> <span class="nf">get_num_feat_score_cols</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_fsv_prod_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_annot_fm</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">daid</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">daid</span><span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fm</span>

    <span class="k">def</span> <span class="nf">get_fs_list</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">xor</span><span class="p">(</span><span class="n">colx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">colx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fs_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qfxs_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dfxs_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nfxs_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">nfxs_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nfxs_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">naids_list</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">naids_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">naids_list</span>


<span class="k">class</span> <span class="nc">_ChipMatchDebugger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ------------------</span>
    <span class="c1"># String Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">print_inspect_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_inspect_str</span><span class="p">(</span><span class="n">qreq_</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">print_rawinfostr</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_rawinfostr</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">print_csv</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cvs_str</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">inspect_difference</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking difference&#39;</span><span class="p">)</span>
        <span class="n">raw_infostr1</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_rawinfostr</span><span class="p">(</span><span class="n">colored</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">raw_infostr2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_rawinfostr</span><span class="p">(</span><span class="n">colored</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">difftext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_textdiff</span><span class="p">(</span><span class="n">raw_infostr1</span><span class="p">,</span> <span class="n">raw_infostr2</span><span class="p">,</span> <span class="n">num_context_lines</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">difftext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no difference&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">print_difftext</span><span class="p">(</span><span class="n">difftext</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_inspect_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            qreq_ (QueryRequest):  query request object with hyper-parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: varinfo</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-get_inspect_str</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;, a=&#39;default:dindex=0:10,qindex=0:1&#39;, t=&#39;best:SV=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; varinfo = cm.get_inspect_str(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;varinfo = %s&#39; % (str(varinfo),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cm.assert_self(qreq_)</span>

        <span class="n">top_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; top aids&#39;</span><span class="p">,</span> <span class="s1">&#39; scores&#39;</span><span class="p">,</span> <span class="s1">&#39; ranks&#39;</span><span class="p">]</span>

        <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>

        <span class="n">top_aids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">top_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">top_aids</span><span class="p">)</span>
        <span class="c1"># top_rawscores = np.array(cm.get_aid_scores(top_aids, rawscore=True), dtype=np.float64)</span>
        <span class="n">top_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_aids</span><span class="p">))</span>
        <span class="n">top_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_aids</span><span class="p">,</span> <span class="n">top_scores</span><span class="p">,</span> <span class="n">top_ranks</span><span class="p">]</span>

        <span class="n">top_lbls</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39; isgt&#39;</span><span class="p">]</span>
        <span class="n">istrue</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_match_truths</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_aids</span><span class="p">),</span> <span class="n">top_aids</span><span class="p">)</span>
        <span class="n">top_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">istrue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

        <span class="n">top_lbls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top nid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">top_lbls</span>
        <span class="n">top_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">top_aids</span><span class="p">)]</span> <span class="o">+</span> <span class="n">top_list</span>

        <span class="n">top_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">top_list</span><span class="p">)</span>
        <span class="c1"># top_stack = np.array(top_stack, dtype=object)</span>
        <span class="n">top_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top_stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="c1"># np.int32)</span>
        <span class="n">top_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span>
            <span class="n">top_stack</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suppress_small</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_line_width</span><span class="o">=</span><span class="mi">200</span>
        <span class="p">)</span>

        <span class="n">top_lbl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top_lbls</span><span class="p">)</span>
        <span class="n">inspect_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;QueryResult&#39;</span><span class="p">,</span>
            <span class="n">qreq_</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">(),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gt_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">aslist</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_top_gt_aids</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="p">))</span>
            <span class="n">gt_ranks</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_ranks</span><span class="p">(</span><span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">gt_scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;len(cm.daid_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">))</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;len(cm.unique_nids) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">))</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gt_ranks = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gt_ranks</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gt_aids = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gt_aids</span><span class="p">)</span>
            <span class="n">inspect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gt_scores = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">gt_scores</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>

        <span class="n">inspect_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;qaid=</span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span>
                <span class="s1">&#39;qnid=</span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">,</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">hz_str</span><span class="p">(</span><span class="n">top_lbl</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">top_str</span><span class="p">),</span>
                <span class="c1"># &#39;num feat matches per annotation stats:&#39;,</span>
                <span class="c1"># ut.indent(ut.repr2(nFeatMatch_stats)),</span>
                <span class="c1"># ut.indent(nFeatMatch_stats_str),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">inspect_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inspect_list</span><span class="p">)</span>

        <span class="c1"># inspect_str = ut.indent(inspect_str, &#39;[INSPECT] &#39;)</span>
        <span class="k">return</span> <span class="n">inspect_str</span>

    <span class="k">def</span> <span class="nf">get_rawinfostr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">colored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: varinfo</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match get_rawinfostr</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;, a=&#39;default:dindex=0:10,qindex=0:1&#39;, t=&#39;best:SV=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; varinfo = cm.get_rawinfostr()</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;varinfo = %s&#39; % (varinfo,))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">varinfo</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">onlyrepr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">canshowrepr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">varcolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">):</span>
            <span class="n">varval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">varname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cm.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">varinfo_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">print_summary</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">onlyrepr</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span>
            <span class="n">show_repr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">show_repr</span> <span class="o">=</span> <span class="n">show_repr</span> <span class="ow">or</span> <span class="p">(</span><span class="n">onlyrepr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">print_summary</span><span class="p">)</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="k">if</span> <span class="n">colored</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_dbg</span><span class="o">.</span><span class="n">COLORED_EXCEPTIONS</span><span class="p">:</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">color_text</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">varcolor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_repr</span><span class="p">:</span>
                <span class="n">varval_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">varval</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varval_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">varval_str</span> <span class="o">=</span> <span class="s1">&#39;&lt;omitted&gt;&#39;</span>
                <span class="n">varval_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span><span class="n">varval_str</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;    * </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">varval_str</span><span class="p">)]</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
            <span class="k">if</span> <span class="n">print_summary</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">varval</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">show_repr</span><span class="p">:</span>
                    <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="c1"># &#39;    %s varinfo(%s):&#39; % (symbol, varname,),</span>
                        <span class="s1">&#39;    </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> = &lt;not shown!&gt;&#39;</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">symbol</span><span class="p">,</span>
                            <span class="n">varname</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">]</span>
                <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;          len = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varval</span><span class="p">),)]</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varval</span><span class="p">):</span>
                    <span class="n">depth_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truncate_str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
                    <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;          depth = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth_str</span><span class="p">,)]</span>
                <span class="n">varinfo_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;          types = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_type_profile</span><span class="p">(</span><span class="n">varval</span><span class="p">),)]</span>
                <span class="c1"># varinfo = &#39;\n&#39;.join(ut.align_lines(varinfo_list, &#39;=&#39;))</span>
            <span class="n">aligned_varinfo_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">align_lines</span><span class="p">(</span><span class="n">varinfo_list</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">varinfo</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aligned_varinfo_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">varinfo</span>

        <span class="n">str_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">str_list</span><span class="o">.</span><span class="n">append</span>
        <span class="n">attr_order</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;cm.qaid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.qnid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.unique_nids&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.daid_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.dnid_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.fs_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.fm_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.fk_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.fsv_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.fsv_col_lbls&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.filtnorm_aids&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.filtnorm_fxs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.H_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.score_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.annot_score_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.name_score_list&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;cm.sumamech_score_list&#39;,</span>
            <span class="s1">&#39;cm.nid2_nidx&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cm.daid2_idx&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">attrs_</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cm.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attr_order</span><span class="p">]</span>
        <span class="n">unspecified_attrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs_</span><span class="p">))</span>

        <span class="n">append</span><span class="p">(</span><span class="s1">&#39;ChipMatch:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attr_order</span><span class="p">:</span>
            <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unspecified_attrs</span><span class="p">:</span>
            <span class="n">append</span><span class="p">(</span><span class="n">varinfo</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">varcolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>
        <span class="n">infostr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">infostr</span>

    <span class="k">def</span> <span class="nf">get_cvs_str</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">numtop</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            numtop (int): (default = 6)</span>
<span class="sd">            ibs (IBEISController):  wbia controller object(default = None)</span>
<span class="sd">            sort (bool): (default = True)</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: csv_str</span>

<span class="sd">        Notes:</span>
<span class="sd">            Very weird that it got a score</span>
<span class="sd">            qaid 6 vs 41 has</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [72, 79, 0, 17, 6, 60, 15, 36, 63]</span>
<span class="sd">                [0.060, 0.053, 0.0497, 0.040, 0.016, 0, 0, 0, 0]</span>
<span class="sd">                [7, 40, 41, 86, 103, 88, 8, 101, 35]</span>
<span class="sd">            makes very little sense</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-get_cvs_str --force-serial</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, qreq_, cm_list = plh.testdata_post_sver()</span>
<span class="sd">            &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">            &gt;&gt;&gt; numtop = 6</span>
<span class="sd">            &gt;&gt;&gt; ibs = None</span>
<span class="sd">            &gt;&gt;&gt; sort = True</span>
<span class="sd">            &gt;&gt;&gt; csv_str = cm.get_cvs_str(numtop, ibs, sort)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;csv_str = \n%s&#39; % (str(csv_str),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning: cm.score_list is None and sort is True&#39;</span><span class="p">)</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_argsort</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qnid</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">)</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qnid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
            <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span>
        <span class="c1"># Build columns for the csv, filtering out unavailable information</span>
        <span class="n">column_lbls_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;daid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dnid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_matches&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annot_scores&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fm_depth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fsv_depth&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">column_list_</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">dnid_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_num_matches_list</span><span class="p">(),</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">),</span>
            <span class="c1"># None if cm.name_score_list is None else vt.list_take_(cm.name_score_list, sortx),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">))),</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">list_take_</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">))),</span>
        <span class="p">]</span>
        <span class="n">isnone_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">column_list_</span><span class="p">)</span>
        <span class="n">column_lbls</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">column_lbls_</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">column_list_</span><span class="p">,</span> <span class="n">isnone_list</span><span class="p">)</span>
        <span class="c1"># Clip to the top results</span>
        <span class="k">if</span> <span class="n">numtop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">listclip</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">numtop</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="c1"># hard case for python text parsing</span>
        <span class="c1"># better know about quoted hash symbols</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            # qaid = {qaid}</span>
<span class="sd">            # qnid = {qnid}</span>
<span class="sd">            # fsv_col_lbls = {fsv_col_lbls}</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qaid</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qnid</span><span class="o">=</span><span class="n">qnid</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">csv_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_csv_table</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_lbls</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">comma_repl</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_str</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># Testing Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">assert_self</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assert_feats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span>
    <span class="p">):</span>
        <span class="c1"># return list1_ is None or len(list1_) == len(list2_)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;must have qaid&#39;</span>
            <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;must give daids&#39;</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">_assert_eq_len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">print_rawinfostr</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>

        <span class="n">testlog</span> <span class="o">=</span> <span class="n">TestLogger</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;lookup score by daid&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">daids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">()</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_top_scores</span><span class="p">()</span>
                <span class="n">scores_</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_annot_scores</span><span class="p">(</span><span class="n">daids</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">scores</span> <span class="o">==</span> <span class="n">scores_</span><span class="p">):</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s1">&#39;score mappings are NOT ok&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;dnid_list = name(daid_list)&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">==</span> <span class="n">nid_list</span><span class="p">):</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s1">&#39;annot aligned nids are NOT ok&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;unique nid mapping&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;name mappings are not built&#39;</span>
                <span class="n">nidx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">nidx_list</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nidx_list</span><span class="p">)))</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">[</span><span class="n">nidx_list</span><span class="p">]</span> <span class="o">==</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;allsame(grouped(dnid_list))&#39;</span><span class="p">):</span>
                <span class="n">grouped_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span> <span class="ow">in</span> <span class="n">grouped_nids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                            <span class="s1">&#39;internal dnid name grouping is NOT consistent&#39;</span>
                        <span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;allsame(name(grouped(daid_list)))&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># this might fail if this result is old and the names have changed</span>
                    <span class="n">grouped_aids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                    <span class="n">grouped_mapped_nids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">unflat_map</span><span class="p">(</span>
                        <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_name_rowids</span><span class="p">,</span> <span class="n">grouped_aids</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">nids</span> <span class="ow">in</span> <span class="n">grouped_mapped_nids</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">nids</span><span class="p">):</span>
                            <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                                <span class="s1">&#39;internal daid name grouping is NOT consistent&#39;</span>
                            <span class="p">)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;dnid_list - unique_nid alignment&#39;</span><span class="p">):</span>
                <span class="n">grouped_nids</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_groupxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_nids</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nids</span> <span class="o">==</span> <span class="n">nid</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                            <span class="s1">&#39;cm.unique_nids is NOT aligned with &#39;</span>
                            <span class="s1">&#39;vt.apply_grouping(cm.dnid_list, cm.name_groupxs). &#39;</span>
                            <span class="s1">&#39; nids=</span><span class="si">%r</span><span class="s1">, nid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">start_test</span><span class="p">(</span><span class="s1">&#39;daid_list - unique_nid alignment&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nids</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_mapped_nids</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nids</span> <span class="o">==</span> <span class="n">nid</span><span class="p">):</span>
                        <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span>
                            <span class="s1">&#39;cm.unique_nids is NOT aligned with &#39;</span>
                            <span class="s1">&#39;vt.apply_grouping(name(cm.daid_list), cm.name_groupxs). &#39;</span>
                            <span class="s1">&#39; name(aids)=</span><span class="si">%r</span><span class="s1">, nid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">end_test</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s1">&#39;lengths are ok&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;check fm_shape&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">],</span> <span class="mi">2</span>
                    <span class="p">),</span> <span class="s1">&#39;fm arrs must be Nx2 dimensions&#39;</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;fsv_col_lbls agree with fsv shape&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">strict</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="p">),</span> <span class="s1">&#39;need to specify the names of the columns&#39;</span>
                        <span class="n">num_col_lbls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">num_col_lbls</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">num_col_lbls</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">],</span> <span class="n">num_col_lbls</span>
                    <span class="p">),</span> <span class="s1">&#39;num_col_lbls=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_col_lbls</span><span class="p">,)</span>

            <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;filtnorm checks&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">testlog</span><span class="o">.</span><span class="n">skip_test</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;num_col_lbls agree with filtnorm_arrs&#39;</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_col_lbls</span>
                        <span class="p">),</span> <span class="s1">&#39;bad len </span><span class="si">%r</span><span class="s1"> != </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">),</span> <span class="n">num_col_lbls</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_col_lbls</span>
                    <span class="k">with</span> <span class="n">testlog</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s1">&#39;len(fsvs) agree with filtnorm_arrs&#39;</span><span class="p">):</span>
                        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">aids_list</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">fsv</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">aids</span><span class="p">,</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">)</span>
                                    <span class="p">]</span>
                                <span class="p">)</span>
                                <span class="k">for</span> <span class="n">aids_list</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span>
                            <span class="p">]</span>
                        <span class="p">),</span> <span class="s1">&#39;norm aid indicies do not agree with featscores&#39;</span>
                        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">fxs_list</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                                    <span class="p">[</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">fsv</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fxs</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">fxs</span><span class="p">,</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fxs_list</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">)</span>
                                    <span class="p">]</span>
                                <span class="p">)</span>
                                <span class="k">for</span> <span class="n">fxs_list</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span>
                            <span class="p">]</span>
                        <span class="p">),</span> <span class="s1">&#39;norm fx indicies do not agree with featscores&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">print_rawinfostr</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="c1"># testlog.log_passed(&#39;filtkey and fsv shapes are ok&#39;)</span>

        <span class="k">if</span> <span class="n">assert_feats</span> <span class="ow">and</span> <span class="p">(</span><span class="n">strict</span> <span class="ow">or</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">external_qaids</span> <span class="o">=</span> <span class="n">aslist</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">qaids</span><span class="p">)</span>
            <span class="n">external_daids</span> <span class="o">=</span> <span class="n">aslist</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">daids</span><span class="p">)</span>
            <span class="n">proot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">qparams</span><span class="p">,</span> <span class="s1">&#39;pipeline_root&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proot</span> <span class="o">==</span> <span class="s1">&#39;vsone&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_qaids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;only one external qaid for vsone&#39;</span>
                <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">indexer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nExternalQVecs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_vecs</span><span class="p">(</span>
                        <span class="n">external_qaids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">extern_query_config2</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="n">qreq_</span><span class="o">.</span><span class="n">indexer</span><span class="o">.</span><span class="n">idx2_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nExternalQVecs</span>
                    <span class="p">),</span> <span class="s1">&#39;did not index query descriptors properly&#39;</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s1">&#39;vsone daids are ok are ok&#39;</span><span class="p">)</span>

            <span class="n">nFeats1</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">extern_query_config2</span>
            <span class="p">)</span>
            <span class="n">nFeats2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_num_feats</span><span class="p">(</span>
                    <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">extern_data_config2</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># This does not need to be the case especially if the daid_list</span>
                <span class="c1"># was exteneded</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_issubset</span><span class="p">(</span>
                        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">external_daids</span>
                    <span class="p">),</span> <span class="s1">&#39;cmtup_old must be subset of daids&#39;</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;daid_list&#39;</span><span class="p">,</span> <span class="s1">&#39;external_daids&#39;</span><span class="p">])</span>
                    <span class="k">raise</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fm_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span>
                <span class="n">fx2s_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm_</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
                <span class="n">fx1s_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm_</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm_</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
                <span class="n">max_fx1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fx1s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fx1s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">fx1s</span> <span class="ow">in</span> <span class="n">fx1s_list</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">max_fx2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fx2s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fx2s</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">fx2s</span> <span class="ow">in</span> <span class="n">fx2s_list</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">assert_lessthan</span><span class="p">(</span>
                    <span class="n">max_fx2_list</span><span class="p">,</span>
                    <span class="n">nFeats2_list</span><span class="p">,</span>
                    <span class="s1">&#39;max feat index must be less than num feats&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">assert_lessthan</span><span class="p">(</span>
                    <span class="n">max_fx1_list</span><span class="p">,</span> <span class="n">nFeats1</span><span class="p">,</span> <span class="s1">&#39;max feat index must be less than num feats&#39;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                    <span class="n">ex</span><span class="p">,</span>
                    <span class="n">keys</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;qaid&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;daid_list&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;nFeats1&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;nFeats2_list&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;max_fx1_list&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;max_fx2_list&#39;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>
                <span class="k">raise</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="s1">&#39;nFeats are ok in fm&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_skipped</span><span class="p">(</span><span class="s1">&#39;nFeat check&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qreq_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>


<div class="viewcode-block" id="ChipMatch"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ChipMatch</span><span class="p">(</span>
    <span class="n">_ChipMatchVisualization</span><span class="p">,</span>
    <span class="n">AnnotMatch</span><span class="p">,</span>
    <span class="n">_ChipMatchScorers</span><span class="p">,</span>
    <span class="n">old_chip_match</span><span class="o">.</span><span class="n">_OldStyleChipMatchSimulator</span><span class="p">,</span>
    <span class="n">_ChipMatchConvenienceGetter</span><span class="p">,</span>
    <span class="n">_ChipMatchDebugger</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    behaves as as the ChipMatchOldTup named tuple until we</span>
<span class="sd">    completely replace the old structure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Standard Contstructor</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qaid and daid_list are not optional. fm_list and fsv_list are strongly</span>
<span class="sd">        encouraged and will probalby break things if they are not there.</span>

<span class="sd">        SeeAlso: initialize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Hack for ipython reload</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;id(cm.__class__) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;id(ChipMatch) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">),))</span>
            <span class="c1"># import utool</span>
            <span class="c1"># utool.embed()</span>
            <span class="c1"># assert id(cm.__class__) &gt; id(ChipMatch)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">STRICT</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Hacks for norm</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ChipMatch.initialize"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="n">cm</span><span class="p">,</span>
        <span class="n">qaid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">daid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fm_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fsv_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fk_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">H_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dnid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">qnid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name_score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">annot_score_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filtnorm_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filtnorm_fxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        qaid and daid_list are not optional. fm_list and fsv_list are strongly</span>
<span class="sd">        encouraged and will probalby break things if they are not there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">DEBUG_CHIPMATCH</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;incompatable data&#39;</span>
            <span class="k">assert</span> <span class="n">daid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;must give daids&#39;</span>
            <span class="k">assert</span> <span class="n">fm_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">fsv_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsv_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">fk_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fk_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">H_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">H_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">score_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
            <span class="k">assert</span> <span class="n">dnid_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dnid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="o">=</span> <span class="n">qaid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="n">H_list</span>
        <span class="c1"># name info</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">=</span> <span class="n">qnid</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">dnid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">unique_nids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">name_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">annot_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">fm_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">fsv_list</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fk_list</span>
            <span class="k">if</span> <span class="n">fk_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">fsv_col_lbls</span>
        <span class="c1"># HACKY normalizer info</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span> <span class="o">=</span> <span class="n">filtnorm_aids</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span> <span class="o">=</span> <span class="n">filtnorm_fxs</span>
        <span class="c1"># TODO: have subclass or dict for special scores</span>
        <span class="k">if</span> <span class="n">autoinit</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">DEBUG_CHIPMATCH</span><span class="p">:</span>
                <span class="n">cm</span><span class="o">.</span><span class="n">assert_self</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChipMatch.arraycast_self"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.arraycast_self">[docs]</a>    <span class="k">def</span> <span class="nf">arraycast_self</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures internal structure is in numpy array formats</span>
<span class="sd">        TODO: come up with better name</span>
<span class="sd">        Remove old initialize method and rename to initialize?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="c1"># name info</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span>
        <span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span>
        <span class="p">)</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="n">safecast_numpy_lists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">safecast_numpy_lists</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">safecast_numpy_lists</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">FLOAT_TYPE</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">safecast_numpy_lists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_empty_hack</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># if isinstance(other, cm.__class__):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">qaid</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">qnid</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fm_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fs_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fk_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">&amp;=</span> <span class="n">check_arrs_eq</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return False</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># Modification / Evaluation Functions</span>
    <span class="c1"># ------------------</span>

    <span class="k">def</span> <span class="nf">_cast_scores</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">]</span>

<div class="viewcode-block" id="ChipMatch.compress_results"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.compress_results">[docs]</a>    <span class="k">def</span> <span class="nf">compress_results</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">compress_annots</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.extend_results"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.extend_results">[docs]</a>    <span class="k">def</span> <span class="nf">extend_results</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">other_aids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new ChipMatch containing empty data for an extended set of</span>
<span class="sd">        aids</span>

<span class="sd">        Args:</span>
<span class="sd">            qreq_ (wbia.QueryRequest):  query request object with hyper-parameters</span>
<span class="sd">            other_aids (None): (default = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            wbia.ChipMatch: out</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-extend_results --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               a=&#39;default:dindex=0:10,qindex=0:1&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               t=&#39;best:SV=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; assert len(cm.daid_list) == 9</span>
<span class="sd">            &gt;&gt;&gt; cm.assert_self(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; other_aids = qreq_.ibs.get_valid_aids()</span>
<span class="sd">            &gt;&gt;&gt; out = cm.extend_results(qreq_, other_aids)</span>
<span class="sd">            &gt;&gt;&gt; assert len(out.daid_list) == 118</span>
<span class="sd">            &gt;&gt;&gt; out.assert_self(qreq_)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other_aids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_aids</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">daids</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">ibs</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">other_aids</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">)</span>
        <span class="n">other_aids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">,</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">])</span>
        <span class="n">other_nids_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">other_unique_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">other_nids_</span><span class="p">),</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">num2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_unique_nids</span><span class="p">)</span>

        <span class="n">daid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">other_aids_</span><span class="p">)</span>
        <span class="n">dnid_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">other_nids_</span><span class="p">)</span>

        <span class="n">score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

        <span class="n">unique_nids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span> <span class="n">other_unique_nids</span><span class="p">)</span>
        <span class="n">name_score_list</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">num2</span><span class="p">)</span>

        <span class="n">qaid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">qnid</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">qnid</span>
        <span class="n">fsv_col_lbls</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span>

        <span class="c1"># &lt;feat correspondence&gt;</span>
        <span class="n">nVs</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">fsv_col_lbls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">fm_list</span> <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FM_DTYPE</span><span class="p">)</span>
        <span class="n">fk_list</span> <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FK_DTYPE</span><span class="p">)</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">extend_nplists</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nVs</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">)</span>
        <span class="n">H_list</span> <span class="o">=</span> <span class="n">extend_pylist</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">filtnorm_aids</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">,</span> <span class="n">extend_nplists</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span>
        <span class="p">)</span>
        <span class="n">filtnorm_fxs</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span><span class="p">,</span> <span class="n">extend_nplists</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">INDEX_TYPE</span>
        <span class="p">)</span>
        <span class="c1"># &lt;/feat correspondence&gt;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">(</span>
            <span class="n">qaid</span><span class="p">,</span>
            <span class="n">daid_list</span><span class="p">,</span>
            <span class="n">fm_list</span><span class="p">,</span>
            <span class="n">fsv_list</span><span class="p">,</span>
            <span class="n">fk_list</span><span class="p">,</span>
            <span class="n">score_list</span><span class="p">,</span>
            <span class="n">H_list</span><span class="p">,</span>
            <span class="n">fsv_col_lbls</span><span class="p">,</span>
            <span class="n">dnid_list</span><span class="p">,</span>
            <span class="n">qnid</span><span class="p">,</span>
            <span class="n">unique_nids</span><span class="p">,</span>
            <span class="n">name_score_list</span><span class="p">,</span>
            <span class="n">annot_score_list</span><span class="p">,</span>
            <span class="n">filtnorm_fxs</span><span class="o">=</span><span class="n">filtnorm_fxs</span><span class="p">,</span>
            <span class="n">filtnorm_aids</span><span class="o">=</span><span class="n">filtnorm_aids</span><span class="p">,</span>
            <span class="n">autoinit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span>
        <span class="c1"># attrs should be dicts</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_scores</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">num2</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.combine_cms"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.combine_cms">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">combine_cms</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">cm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # FIXME failing-test (22-Jul-2020) This test is failing and it&#39;s not clear how to fix it</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">            &gt;&gt;&gt; from wbia.core_annots import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; ibs, depc, aid_list = testdata_core(size=4)</span>
<span class="sd">            &gt;&gt;&gt; request = depc.new_request(&#39;vsone&#39;, [1], [2, 3, 4], {&#39;dim_size&#39;: 450})</span>
<span class="sd">            &gt;&gt;&gt; rawres_list2 = request.execute(postprocess=False)</span>
<span class="sd">            &gt;&gt;&gt; cm_list = ut.take_column(rawres_list2, 1)</span>
<span class="sd">            &gt;&gt;&gt; out = ChipMatch.combine_cms(cm_list)</span>
<span class="sd">            &gt;&gt;&gt; out.score_name_nsum(request)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; out.ishow_analysis(request)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">common_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qaid&#39;</span><span class="p">,</span> <span class="s1">&#39;qnid&#39;</span><span class="p">,</span> <span class="s1">&#39;fsv_col_lbls&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">common_attrs</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_getattr</span><span class="p">(</span><span class="n">cm_list</span><span class="p">,</span> <span class="s1">&#39;qaid&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">allsame</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">new_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># assumes disjoint</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;daid_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dnid_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;score_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annot_score_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;H_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fm_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fsv_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fk_list&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filtnorm_aids&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filtnorm_fxs&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;qaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qaid</span>
        <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;qnid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qnid</span>
        <span class="n">new_attrs</span><span class="p">[</span><span class="s1">&#39;fsv_col_lbls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fsv_col_lbls</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_getattr</span><span class="p">(</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_all_eq_to</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">new_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">(</span><span class="o">**</span><span class="n">new_attrs</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.take_annots"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.take_annots">[docs]</a>    <span class="k">def</span> <span class="nf">take_annots</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepscores</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Keeps results only for the selected annotation indices.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match take_annots</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               a=&#39;default:dindex=0:10,qindex=0:1&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               t=&#39;best:sv=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; idx_list = list(range(cm.num_daids))</span>
<span class="sd">            &gt;&gt;&gt; inplace = False</span>
<span class="sd">            &gt;&gt;&gt; keepscores = True</span>
<span class="sd">            &gt;&gt;&gt; other = out = cm.take_annots(idx_list, inplace, keepscores)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;out = %s&#39; % (ut.repr2(out, nl=1),))</span>
<span class="sd">            &gt;&gt;&gt; # Because the subset was all aids in order, the output</span>
<span class="sd">            &gt;&gt;&gt; # ChipMatch should be exactly the same.</span>
<span class="sd">            &gt;&gt;&gt; assert cm.inspect_difference(out), &#39;Should be exactly equal!&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               a=&#39;default:dindex=0:10,qindex=0:1&#39;,</span>
<span class="sd">            &gt;&gt;&gt;                               t=&#39;best:SV=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; idx_list = [0, 2]</span>
<span class="sd">            &gt;&gt;&gt; inplace = False</span>
<span class="sd">            &gt;&gt;&gt; keepscores = True</span>
<span class="sd">            &gt;&gt;&gt; other = out = cm.take_annots(idx_list, inplace, keepscores)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;out = %s&#39; % (ut.repr2(out, nl=1),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">cm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">(</span><span class="n">qaid</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qnid</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">qnid</span><span class="p">,</span> <span class="n">fsv_col_lbls</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_aids</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_fxs</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtnorm_fxs</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keepscores</span><span class="p">:</span>
            <span class="c1"># Annot Scores</span>
            <span class="n">out</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">annot_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">annot_score_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span>
                    <span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">idx_list</span>
                <span class="p">)</span>

            <span class="c1"># Name Scores</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">nidxs_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span><span class="p">,</span> <span class="n">nidxs_subset</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span><span class="p">,</span> <span class="n">nidxs_subset</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">take2</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">nidxs_subset</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset</span>
                <span class="n">out</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">out</span><span class="o">.</span><span class="n">name_groupxs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Name Scores</span>
                <span class="c1"># TODO: remove score of names that were removed?</span>
                <span class="n">out</span><span class="o">.</span><span class="n">nid2_nidx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nid2_nidx</span>
                <span class="n">out</span><span class="o">.</span><span class="n">unique_nids</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">unique_nids</span>
                <span class="n">out</span><span class="o">.</span><span class="n">name_score_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">name_score_list</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">algo_name_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">out</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">_update_unique_nid_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.take_feature_matches"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.take_feature_matches">[docs]</a>    <span class="k">def</span> <span class="nf">take_feature_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">indicies_list</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepscores</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes outlier feature matches</span>
<span class="sd">        TODO: rectify with shortlist_subset</span>

<span class="sd">        Args:</span>
<span class="sd">            indicies_list (list): list of lists of indicies to keep.</span>
<span class="sd">                    if an item is None, the match to the corresponding daid is</span>
<span class="sd">                    removed.</span>
<span class="sd">            inplace (bool): (default = False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            wbia.ChipMatch: out</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --exec-take_feature_matches --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm(&#39;PZ_MTEST&#39;, a=&#39;default:dindex=0:10,qindex=0:1&#39;, t=&#39;best:SV=False&#39;)</span>
<span class="sd">            &gt;&gt;&gt; indicies_list = [list(range(i + 1)) for i in range(cm.num_daids)]</span>
<span class="sd">            &gt;&gt;&gt; inplace = False</span>
<span class="sd">            &gt;&gt;&gt; keepscores = True</span>
<span class="sd">            &gt;&gt;&gt; out = cm.take_feature_matches(indicies_list, inplace, keepscores)</span>
<span class="sd">            &gt;&gt;&gt; assert not cm.inspect_difference(out, verbose=False), &#39;should be different&#39;</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;out = %s&#39; % (ut.repr2(out),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicies_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">),</span> <span class="s1">&#39;must correspond to daids&#39;</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_not_None_items</span><span class="p">(</span><span class="n">indicies_list</span><span class="p">)</span>

        <span class="c1"># Remove disgarded matches</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">compress_annots</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span> <span class="n">keepscores</span><span class="o">=</span><span class="n">keepscores</span><span class="p">)</span>
        <span class="n">indicies_list2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">indicies_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">safeop</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_aids</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span>
            <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_aids</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_fxs</span> <span class="o">=</span> <span class="n">filtnorm_op</span><span class="p">(</span>
            <span class="n">out</span><span class="o">.</span><span class="n">filtnorm_fxs</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">,</span> <span class="n">indicies_list2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># out.assert_self(verbose=False)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.shortlist_subset"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.shortlist_subset">[docs]</a>    <span class="k">def</span> <span class="nf">shortlist_subset</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">top_aids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns a new cmtup_old with only the requested daids</span>
<span class="sd">        TODO: rectify with take_feature_matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid2_idx</span><span class="p">,</span> <span class="n">top_aids</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">take_annots</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">keepscores</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.compress_annots"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.compress_annots">[docs]</a>    <span class="k">def</span> <span class="nf">compress_annots</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepscores</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">take_annots</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">inplace</span><span class="p">,</span> <span class="n">keepscores</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ChipMatch.append_featscore_column"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.append_featscore_column">[docs]</a>    <span class="k">def</span> <span class="nf">append_featscore_column</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">filtkey</span><span class="p">,</span> <span class="n">filtweight_list</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">inplace</span><span class="p">,</span> <span class="s1">&#39;this is always inplace right now&#39;</span>
        <span class="k">assert</span> <span class="n">filtkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="p">,</span> <span class="s1">&#39;already have filtkey=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtkey</span><span class="p">,)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_col_lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtkey</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcat</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">filtweight_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChipMatch.compress_top_feature_matches"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.compress_top_feature_matches">[docs]</a>    <span class="k">def</span> <span class="nf">compress_top_feature_matches</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="p">,</span> <span class="n">use_random</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DO NOT USE</span>

<span class="sd">        FIXME: Use boolean lists</span>

<span class="sd">        Removes all but the best feature matches for testing purposes</span>
<span class="sd">        rng = np.random.RandomState(0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># num = 10</span>
        <span class="n">fs_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_fsv_prod_list</span><span class="p">()</span>
        <span class="n">score_sortx</span> <span class="o">=</span> <span class="p">[</span><span class="n">fs</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">fs_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">use_random</span><span class="p">:</span>
            <span class="c1"># keep jagedness</span>
            <span class="n">score_sortx_filt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sortx</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">num</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="n">score_sortx</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_sortx_filt</span> <span class="o">=</span> <span class="p">[</span><span class="n">sortx</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortx</span><span class="p">))]</span> <span class="k">for</span> <span class="n">sortx</span> <span class="ow">in</span> <span class="n">score_sortx</span><span class="p">]</span>

        <span class="c1"># cm.take_feature_matches()</span>

        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">score_sortx_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ChipMatch.sortself"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.sortself">[docs]</a>    <span class="k">def</span> <span class="nf">sortself</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; reorders the internal data using cm.score_list &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning using sortself&#39;</span><span class="p">)</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">daid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">dnid_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fm_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fsv_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fs_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">fk_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">score_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">score_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="c1"># FIXME: Not all properties covered</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">algo_annot_scores</span><span class="p">[</span><span class="s1">&#39;csum&#39;</span><span class="p">],</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">H_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">trytake</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">H_list</span><span class="p">,</span> <span class="n">sortx</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">_update_daid_index</span><span class="p">()</span></div>

    <span class="c1"># ---</span>

    <span class="c1"># Alternative Cosntructors / Convertors</span>

<div class="viewcode-block" id="ChipMatch.from_json"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">json_str</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert json string back to ChipMatch object</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            # FIXME: util_test is broken with classmethods</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-from_json --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm1, qreq_ = wbia.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm1.to_json()</span>
<span class="sd">            &gt;&gt;&gt; cm = ChipMatch.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, 1)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">class_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ChipMatch</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">class_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChipMatch.from_dict"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert dict of arguments back to ChipMatch object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">ChipMatch</span><span class="o">.</span><span class="n">initialize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># HACKY</span>
        <span class="n">key_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;autoinit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="n">other_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">class_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">key_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Not unserializing extra attributes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">other_keys</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">ibs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_dict</span> <span class="o">=</span> <span class="n">prepare_dict_uuids</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">ibs</span><span class="p">)</span>

        <span class="n">dict_subset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">class_dict</span><span class="p">,</span> <span class="n">key_list</span><span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fm_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy_lists</span><span class="p">(</span>
            <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fm_list&#39;</span><span class="p">],</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FM_DTYPE</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fsv_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy_lists</span><span class="p">(</span>
            <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fsv_list&#39;</span><span class="p">],</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_numpy</span><span class="p">(</span>
            <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">],</span> <span class="n">hstypes</span><span class="o">.</span><span class="n">FS_DTYPE</span>
        <span class="p">)</span>
        <span class="n">safe_check_nested_lens_eq</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fm_list&#39;</span><span class="p">],</span> <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fsv_list&#39;</span><span class="p">])</span>
        <span class="n">safe_check_lens_eq</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">],</span> <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fsv_list&#39;</span><span class="p">])</span>
        <span class="n">safe_check_lens_eq</span><span class="p">(</span><span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;score_list&#39;</span><span class="p">],</span> <span class="n">dict_subset</span><span class="p">[</span><span class="s1">&#39;fm_list&#39;</span><span class="p">])</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">(</span><span class="o">**</span><span class="n">dict_subset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span></div>

<div class="viewcode-block" id="ChipMatch.to_json"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.to_json">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">cm</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize ChipMatch object as JSON string</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-ChipMatch.to_json:0</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-ChipMatch.to_json</span>
<span class="sd">            python -m wbia.algo.hots.chip_match --test-ChipMatch.to_json:1 --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Simple doctest demonstrating the json format</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; cm.compress_top_feature_matches(num=4, rng=np.random.RandomState(0))</span>
<span class="sd">            &gt;&gt;&gt; # Serialize</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;\n\nRaw ChipMatch JSON:\n&#39;)</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm.to_json()</span>
<span class="sd">            &gt;&gt;&gt; print(json_str)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;\n\nPretty ChipMatch JSON:\n&#39;)</span>
<span class="sd">            &gt;&gt;&gt; # Pretty String Formatting</span>
<span class="sd">            &gt;&gt;&gt; dictrep = ut.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; dictrep = ut.delete_dict_keys(dictrep, [key for key, val in dictrep.items() if val is None])</span>
<span class="sd">            &gt;&gt;&gt; result  = ut.repr2_json(dictrep, nl=2, precision=2, key_order_metric=&#39;strlen&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # test to convert back and forth from json</span>
<span class="sd">            &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import wbia</span>
<span class="sd">            &gt;&gt;&gt; cm, qreq_ = wbia.testdata_cm()</span>
<span class="sd">            &gt;&gt;&gt; cm1 = cm</span>
<span class="sd">            &gt;&gt;&gt; # Serialize</span>
<span class="sd">            &gt;&gt;&gt; json_str = cm.to_json()</span>
<span class="sd">            &gt;&gt;&gt; print(repr(json_str))</span>
<span class="sd">            &gt;&gt;&gt; # Unserialize</span>
<span class="sd">            &gt;&gt;&gt; cm = ChipMatch.from_json(json_str)</span>
<span class="sd">            &gt;&gt;&gt; # Show if it works</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; cm.score_name_nsum(qreq_)</span>
<span class="sd">            &gt;&gt;&gt; cm.show_single_namematch(qreq_, 1)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">            &gt;&gt;&gt; # result = (&#39;json_str = \n%s&#39; % (str(json_str),))</span>
<span class="sd">            &gt;&gt;&gt; # print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># can&#39;t encode dictionaries with integer keys</span>
        <span class="c1"># this means you need to rebuild indexes on reconstruction</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;daid2_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;nid2_nidx&#39;</span><span class="p">])</span>
        <span class="c1"># logger.info(&#39;data = %r&#39; % (list(data.keys()),))</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_str</span></div>

    <span class="c1"># --- IO</span>

<div class="viewcode-block" id="ChipMatch.get_fpath"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">):</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_qresdir</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_chipmatch_fname</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="ChipMatch.save"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">save_to_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

    <span class="c1"># @classmethod</span>
    <span class="c1"># def load(cls, qreq_, qaid, dpath=None, verbose=None):</span>
    <span class="c1">#    fname = get_chipmatch_fname(qaid, qreq_)</span>
    <span class="c1">#    if dpath is None:</span>
    <span class="c1">#        dpath = qreq_.get_qresdir()</span>
    <span class="c1">#    fpath = join(dpath, fname)</span>
    <span class="c1">#    cm = cls.load_from_fpath(fpath, verbose=verbose)</span>
    <span class="c1">#    return cm</span>

<div class="viewcode-block" id="ChipMatch.load_from_fpath"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.ChipMatch.load_from_fpath">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_from_fpath</span><span class="p">(</span><span class="n">ChipMatch</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># state_dict = ut.load_data(fpath, verbose=verbose)</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;filtnorm_aids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NeedRecomputeError</span><span class="p">(</span><span class="s1">&#39;old version of chipmatch&#39;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">ChipMatch</span><span class="p">()</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cm</span></div></div>


<span class="c1"># -----</span>
<span class="c1"># Misc</span>
<span class="c1"># -----</span>


<div class="viewcode-block" id="TestLogger"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger">[docs]</a><span class="k">class</span> <span class="nc">TestLogger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

<div class="viewcode-block" id="TestLogger.start_test"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.start_test">[docs]</a>    <span class="k">def</span> <span class="nf">start_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="TestLogger.log_skipped"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.log_skipped">[docs]</a>    <span class="k">def</span> <span class="nf">log_skipped</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">testlog</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[cm] skip: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestLogger.log_passed"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.log_passed">[docs]</a>    <span class="k">def</span> <span class="nf">log_passed</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">testlog</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[cm] pass: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestLogger.skip_test"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.skip_test">[docs]</a>    <span class="k">def</span> <span class="nf">skip_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">log_skipped</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestLogger.log_failed"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.log_failed">[docs]</a>    <span class="k">def</span> <span class="nf">log_failed</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span><span class="p">[</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">failed_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[cm] FAILED!: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestLogger.end_test"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.end_test">[docs]</a>    <span class="k">def</span> <span class="nf">end_test</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">test_out</span><span class="p">[</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_passed</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span><span class="p">)</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestLogger.context"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.TestLogger.context">[docs]</a>    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">testlog</span><span class="o">.</span><span class="n">start_test</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">testlog</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="n">testlog</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">testlog</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="n">testlog</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">testlog</span><span class="o">.</span><span class="n">current_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">testlog</span><span class="o">.</span><span class="n">log_failed</span><span class="p">(</span><span class="s1">&#39;error occured&#39;</span><span class="p">)</span>
            <span class="n">testlog</span><span class="o">.</span><span class="n">end_test</span><span class="p">()</span></div>


<div class="viewcode-block" id="testdata_cm"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.testdata_cm">[docs]</a><span class="k">def</span> <span class="nf">testdata_cm</span><span class="p">():</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">cm_list</span> <span class="o">=</span> <span class="n">plh</span><span class="o">.</span><span class="n">testdata_pre_sver</span><span class="p">(</span><span class="s1">&#39;PZ_MTEST&#39;</span><span class="p">,</span> <span class="n">qaid_list</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">cm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">score_name_nsum</span><span class="p">(</span><span class="n">qreq_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cm</span><span class="p">,</span> <span class="n">qreq_</span></div>


<div class="viewcode-block" id="get_chipmatch_fname"><a class="viewcode-back" href="../../../../wbia.algo.hots.html#wbia.algo.hots.chip_match.get_chipmatch_fname">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">get_chipmatch_fname</span><span class="p">(</span>
    <span class="n">qaid</span><span class="p">,</span>
    <span class="n">qreq_</span><span class="p">,</span>
    <span class="n">qauuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">TRUNCATE_UUIDS</span><span class="o">=</span><span class="n">TRUNCATE_UUIDS</span><span class="p">,</span>
    <span class="n">MAX_FNAME_LEN</span><span class="o">=</span><span class="n">MAX_FNAME_LEN</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.algo.hots.chip_match --test-get_chipmatch_fname</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.algo.hots.chip_match import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; qreq_, args = plh.testdata_pre(&#39;spatial_verification&#39;,</span>
<span class="sd">        &gt;&gt;&gt;                                defaultdb=&#39;PZ_MTEST&#39;, qaid_override=[18],</span>
<span class="sd">        &gt;&gt;&gt;                                p=&#39;default:sqrd_dist_on=True&#39;)</span>
<span class="sd">        &gt;&gt;&gt; cm_list = args.cm_list_FILT</span>
<span class="sd">        &gt;&gt;&gt; cm = cm_list[0]</span>
<span class="sd">        &gt;&gt;&gt; fname = get_chipmatch_fname(cm.qaid, qreq_, qauuid=None,</span>
<span class="sd">        &gt;&gt;&gt;                             TRUNCATE_UUIDS=False, MAX_FNAME_LEN=200)</span>
<span class="sd">        &gt;&gt;&gt; result = fname</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">        qaid=18_cm_cvgrsbnffsgifyom_quuid=a126d459-b730-573e-7a21-92894b016565.cPkl</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">qauuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[chipmatch] Warning: qasuuid should be given&#39;</span><span class="p">)</span>
        <span class="n">qauuid</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_qreq_pcc_uuids</span><span class="p">([</span><span class="n">qaid</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[chipmatch] Warning: cfgstr should be passed given&#39;</span><span class="p">)</span>
        <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">(</span><span class="n">with_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># logger.info(&#39;cfgstr = %r&#39; % (cfgstr,))</span>
    <span class="n">fname_fmt</span> <span class="o">=</span> <span class="s1">&#39;qaid=</span><span class="si">{qaid}</span><span class="s1">_cm_</span><span class="si">{cfgstr}</span><span class="s1">_quuid=</span><span class="si">{qauuid}{ext}</span><span class="s1">&#39;</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span>
    <span class="c1"># text_type = str</span>
    <span class="n">qauuid_str</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">qauuid</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">TRUNCATE_UUIDS</span> <span class="k">else</span> <span class="n">text_type</span><span class="p">(</span><span class="n">qauuid</span><span class="p">)</span>
    <span class="n">fmt_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">qaid</span><span class="o">=</span><span class="n">qaid</span><span class="p">,</span> <span class="n">qauuid</span><span class="o">=</span><span class="n">qauuid_str</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.cPkl&#39;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">long_fname_format</span><span class="p">(</span>
        <span class="n">fname_fmt</span><span class="p">,</span> <span class="n">fmt_dict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cfgstr&#39;</span><span class="p">],</span> <span class="n">max_len</span><span class="o">=</span><span class="n">MAX_FNAME_LEN</span><span class="p">,</span> <span class="n">hack27</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../../wbia.html">wbia</a><ul>
  <li><a href="../../algo.html">wbia.algo</a><ul>
  <li><a href="../hots.html">wbia.algo.hots</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>