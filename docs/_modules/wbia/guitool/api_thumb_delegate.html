
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.guitool.api_thumb_delegate &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.guitool.api_thumb_delegate</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CommandLine:</span>
<span class="sd">    rm -rf /media/raid/work/PZ_MTEST/_ibsdb/_wbia_cache/match_thumbs/</span>
<span class="sd">    python -m wbia.gui.inspect_gui --test-test_review_widget --show --verbose-thumb</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">wbia.guitool.__PYQT__</span> <span class="k">import</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">wbia.guitool.__PYQT__</span> <span class="k">import</span> <span class="n">QtWidgets</span>  <span class="c1"># NOQA</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

<span class="n">ut</span><span class="o">.</span><span class="n">noinject</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;[APIThumbDelegate]&#39;</span><span class="p">)</span>


<span class="n">VERBOSE_QT</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--verbose-qt&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbqt&#39;</span><span class="p">))</span>
<span class="n">VERBOSE_THUMB</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--verbose-thumb&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbthumb&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">VERBOSE_QT</span>
<span class="p">)</span>


<span class="n">MAX_NUM_THUMB_THREADS</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="read_thumb_size"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.read_thumb_size">[docs]</a><span class="k">def</span> <span class="nf">read_thumb_size</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ThumbDelegate] Reading thumb size&#39;</span><span class="p">)</span>
    <span class="c1"># npimg = vt.imread(thumb_path, delete_if_corrupted=True)</span>
    <span class="c1"># (height, width) = npimg.shape[0:2]</span>
    <span class="c1"># del npimg</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">open_image_size</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="s1">&#39;image=</span><span class="si">%r</span><span class="s1"> seems corrupted. Needs deletion&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thumb_path</span><span class="p">,),</span>
                <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;image=</span><span class="si">%r</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">thumb_path</span><span class="p">,),</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span></div>


<div class="viewcode-block" id="test_show_qimg"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.test_show_qimg">[docs]</a><span class="k">def</span> <span class="nf">test_show_qimg</span><span class="p">(</span><span class="n">qimg</span><span class="p">):</span>
    <span class="n">qpixmap</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">(</span><span class="n">qimg</span><span class="p">)</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">()</span>
    <span class="n">lbl</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">qpixmap</span><span class="p">)</span>
    <span class="n">lbl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># show label with qim image</span>
    <span class="k">return</span> <span class="n">lbl</span></div>


<span class="c1"># @ut.memprof</span>
<div class="viewcode-block" id="read_thumb_as_qimg"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.read_thumb_as_qimg">[docs]</a><span class="k">def</span> <span class="nf">read_thumb_as_qimg</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        thumb_path (?):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (qimg, width, height)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --test-read_thumb_as_qimg --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.guitool.api_thumb_delegate import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia.guitool</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; thumb_path = ut.grab_test_imgpath(&#39;carl.jpg&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; guitool.ensure_qtapp()</span>
<span class="sd">        &gt;&gt;&gt; qimg = read_thumb_as_qimg(thumb_path)</span>
<span class="sd">        &gt;&gt;&gt; print(qimg)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; lbl = test_show_qimg(qimg)</span>
<span class="sd">        &gt;&gt;&gt; #guitool.qtapp_loop()</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>

<span class="sd">    Timeit::</span>
<span class="sd">        %timeit np.dstack((npimg, np.full(npimg.shape[0:2], 255, dtype=np.uint8)))</span>
<span class="sd">        %timeit cv2.cvtColor(npimg, cv2.COLOR_BGR2BGRA)</span>
<span class="sd">        npimg1 = np.dstack((npimg, np.full(npimg.shape[0:2], 255, dtype=np.uint8)))</span>
<span class="sd">        # seems to be memory leak in cvtColor?</span>
<span class="sd">        npimg2 = cv2.cvtColor(npimg, cv2.COLOR_BGR2BGRA)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ThumbDelegate] Reading thumb as qimg. thumb_path=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thumb_path</span><span class="p">,))</span>
    <span class="c1"># Read thumbnail image and convert to 32bit aligned for Qt</span>
    <span class="c1"># if False:</span>
    <span class="c1">#    data  = np.dstack((npimg, np.full(npimg.shape[0:2], 255, dtype=np.uint8)))</span>
    <span class="c1"># if False:</span>
    <span class="c1">#    # Reading the npimage and then handing it off to Qt causes a memory</span>
    <span class="c1">#    # leak. The numpy array probably is never unallocated because qt doesn&#39;t</span>
    <span class="c1">#    # own it and it never loses its reference count</span>
    <span class="c1">#    #npimg = vt.imread(thumb_path, delete_if_corrupted=True)</span>
    <span class="c1">#    #print(&#39;npimg.dtype = %r, %r&#39; % (npimg.shape, npimg.dtype))</span>
    <span class="c1">#    #npimg   = cv2.cvtColor(npimg, cv2.COLOR_BGR2BGRA)</span>
    <span class="c1">#    #format_ = QtGui.QImage.Format_ARGB32</span>
    <span class="c1">#    ##    #data    = npimg.astype(np.uint8)</span>
    <span class="c1">#    ##    #npimg   = np.dstack((npimg[:, :, 3], npimg[:, :, 0:2]))</span>
    <span class="c1">#    ##    #data    = npimg.astype(np.uint8)</span>
    <span class="c1">#    ##else:</span>
    <span class="c1">#    ## Memory seems to be no freed by the QImage?</span>
    <span class="c1">#    ##data = np.ascontiguousarray(npimg[:, :, ::-1].astype(np.uint8), dtype=np.uint8)</span>
    <span class="c1">#    ##data = np.ascontiguousarray(npimg[:, :, :].astype(np.uint8), dtype=np.uint8)</span>
    <span class="c1">#    #data = npimg</span>
    <span class="c1">#    ##format_ = QtGui.QImage.Format_RGB888</span>
    <span class="c1">#    #(height, width) = data.shape[0:2]</span>
    <span class="c1">#    #qimg    = QtGui.QImage(data, width, height, format_)</span>
    <span class="c1">#    #del npimg</span>
    <span class="c1">#    #del data</span>
    <span class="c1"># else:</span>
    <span class="c1"># format_ = QtGui.QImage.Format_ARGB32</span>
    <span class="c1"># qimg    = QtGui.QImage(thumb_path, format_)</span>
    <span class="n">qimg</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qimg</span></div>


<span class="n">RUNNING_CREATION_THREADS</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="register_thread"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.register_thread">[docs]</a><span class="k">def</span> <span class="nf">register_thread</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">RUNNING_CREATION_THREADS</span>
    <span class="n">RUNNING_CREATION_THREADS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>


<div class="viewcode-block" id="unregister_thread"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.unregister_thread">[docs]</a><span class="k">def</span> <span class="nf">unregister_thread</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">RUNNING_CREATION_THREADS</span>
    <span class="k">del</span> <span class="n">RUNNING_CREATION_THREADS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<span class="n">DELEGATE_BASE</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QItemDelegate</span>


<div class="viewcode-block" id="APIThumbDelegate"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate">[docs]</a><span class="k">class</span> <span class="nc">APIThumbDelegate</span><span class="p">(</span><span class="n">DELEGATE_BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    There is one Thumb Delegate per column. Keep that in mind when writing for</span>
<span class="sd">    this class.</span>

<span class="sd">    TODO: The delegate can have a reference to the view, and it is allowed</span>
<span class="sd">    to resize the rows to fit the images.  It probably should not resize columns</span>
<span class="sd">    but it can get the column width and resize the image to that size.</span>

<span class="sd">    get_thumb_size is a callback function which should return whatever the</span>
<span class="sd">    requested thumbnail size is</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">         api_item_view.infer_delegates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_thumb_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[ThumbDelegate] __init__ parent=</span><span class="si">%r</span><span class="s1">, get_thumb_size=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">get_thumb_size</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">DELEGATE_BASE</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># TODO: get from the view</span>
        <span class="k">if</span> <span class="n">get_thumb_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_size</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">128</span>  <span class="c1"># 256</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_size</span> <span class="o">=</span> <span class="n">get_thumb_size</span>  <span class="c1"># 256</span>
        <span class="n">dgt</span><span class="o">.</span><span class="n">last_thumbsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dgt</span><span class="o">.</span><span class="n">row_rezised_flags</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># SUPER HACK FOR RESIZE SHRINK</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">cachetools</span>

            <span class="n">dgt</span><span class="o">.</span><span class="n">thumb_cache</span> <span class="o">=</span> <span class="n">cachetools</span><span class="o">.</span><span class="n">TTLCache</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">dgt</span><span class="o">.</span><span class="n">thumb_cache</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LRUDict</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="c1"># import utool</span>
        <span class="c1"># utool.embed()</span>

<div class="viewcode-block" id="APIThumbDelegate.paint"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.paint">[docs]</a>    <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: prevent recursive paint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">verticalOffset</span><span class="p">()</span> <span class="o">+</span> <span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="c1"># Check if still in viewport</span>
        <span class="k">if</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_path_if_exists</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thumb_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if still in viewport</span>
                <span class="k">if</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="c1"># Read the precomputed thumbnail</span>
                <span class="k">if</span> <span class="n">thumb_path</span> <span class="ow">in</span> <span class="n">dgt</span><span class="o">.</span><span class="n">thumb_cache</span><span class="p">:</span>
                    <span class="n">qimg</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">thumb_cache</span><span class="p">[</span><span class="n">thumb_path</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qimg</span> <span class="o">=</span> <span class="n">read_thumb_as_qimg</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
                    <span class="n">dgt</span><span class="o">.</span><span class="n">thumb_cache</span><span class="p">[</span><span class="n">thumb_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">qimg</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">qimg</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">qimg</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
                <span class="c1"># Adjust the cell size to fit the image</span>
                <span class="n">dgt</span><span class="o">.</span><span class="n">adjust_thumb_cell_size</span><span class="p">(</span><span class="n">qtindex</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="c1"># Check if still in viewport</span>
                <span class="k">if</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="c1"># Paint image on an item in some view</span>
                <span class="n">painter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">painter</span><span class="o">.</span><span class="n">setClipRect</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>
                <span class="n">painter</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
                <span class="n">painter</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">qimg</span><span class="p">)</span>
                <span class="n">painter</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in APIThumbDelegate&#39;</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error in APIThumbDelegate&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span></div>

<div class="viewcode-block" id="APIThumbDelegate.sizeHint"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.sizeHint">[docs]</a>    <span class="k">def</span> <span class="nf">sizeHint</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">verticalOffset</span><span class="p">()</span> <span class="o">+</span> <span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_path_if_exists</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thumb_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Read the precomputed thumbnail</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">read_thumb_size</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(&quot;[APIThumbDelegate] Name not found&quot;)</span>
                <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in APIThumbDelegate&#39;</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error in APIThumbDelegate&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">()</span></div>

<div class="viewcode-block" id="APIThumbDelegate.get_model_data"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.get_model_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_data</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The model data for a thumb should be a tuple:</span>
<span class="sd">        (thumb_path, img_path, imgsize, bboxes, thetas)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">qtindex</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">datakw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">thumbsize</span><span class="o">=</span><span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_size</span><span class="p">())</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">qtindex</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">,</span> <span class="o">**</span><span class="n">datakw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># The data should be specified as a thumbtup</span>
        <span class="c1"># if isinstance(data, QtCore.QVariant):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;toPyObject&#39;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toPyObject</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="c1"># data = (data, None, None, None, None)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># HACK FOR DIFFERENT TYPE OF THUMB DATA</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s1">&#39;data=</span><span class="si">%r</span><span class="s1"> is </span><span class="si">%r</span><span class="s1">. should be a thumbtup&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">thumbtup</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c1"># (thumb_path, img_path, bbox_list) = thumbtup</span>
        <span class="k">return</span> <span class="n">thumbtup</span></div>

<div class="viewcode-block" id="APIThumbDelegate.spawn_thumb_creation_thread"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.spawn_thumb_creation_thread">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_thumb_creation_thread</span><span class="p">(</span>
        <span class="n">dgt</span><span class="p">,</span>
        <span class="n">thumb_path</span><span class="p">,</span>
        <span class="n">img_path</span><span class="p">,</span>
        <span class="n">img_size</span><span class="p">,</span>
        <span class="n">qtindex</span><span class="p">,</span>
        <span class="n">view</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">,</span>
        <span class="n">bbox_list</span><span class="p">,</span>
        <span class="n">theta_list</span><span class="p">,</span>
        <span class="n">interest_list</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ThumbDelegate] Spawning thumbnail creation thread&#39;</span><span class="p">)</span>
        <span class="n">thumbsize</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_size</span><span class="p">()</span>
        <span class="n">thumb_creation_thread</span> <span class="o">=</span> <span class="n">ThumbnailCreationThread</span><span class="p">(</span>
            <span class="n">thumb_path</span><span class="p">,</span>
            <span class="n">img_path</span><span class="p">,</span>
            <span class="n">img_size</span><span class="p">,</span>
            <span class="n">thumbsize</span><span class="p">,</span>
            <span class="n">qtindex</span><span class="p">,</span>
            <span class="n">view</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">,</span>
            <span class="n">bbox_list</span><span class="p">,</span>
            <span class="n">theta_list</span><span class="p">,</span>
            <span class="n">interest_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># register_thread(thumb_path, thumb_creation_thread)</span>
        <span class="c1"># Initialize threadcount</span>
        <span class="k">if</span> <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># dgt.pool = QtCore.QThreadPool()</span>
            <span class="c1"># dgt.pool.setMaxThreadCount(MAX_NUM_THUMB_THREADS)</span>
            <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThreadPool</span><span class="o">.</span><span class="n">globalInstance</span><span class="p">()</span>
        <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">thumb_creation_thread</span><span class="p">)</span></div>
        <span class="c1"># print(&#39;[ThumbDelegate] Waiting to compute&#39;)</span>

<div class="viewcode-block" id="APIThumbDelegate.get_thumb_path_if_exists"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.get_thumb_path_if_exists">[docs]</a>    <span class="k">def</span> <span class="nf">get_thumb_path_if_exists</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the thumbnail is ready to paint</span>

<span class="sd">        Returns:</span>
<span class="sd">            thumb_path if computed otherwise returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if still in viewport</span>
        <span class="k">if</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get data from the models display role</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">get_model_data</span><span class="p">(</span><span class="n">qtindex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[thumb_delegate] no data&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">thumbtup_mode</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">thumbdat_mode</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">),</span> <span class="s1">&#39;must exist&#39;</span>
                <span class="k">return</span> <span class="n">thumb_path</span>
            <span class="k">if</span> <span class="n">thumbtup_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="n">interest_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">thumb_path</span><span class="p">,</span>
                        <span class="n">img_path</span><span class="p">,</span>
                        <span class="n">img_size</span><span class="p">,</span>
                        <span class="n">bbox_list</span><span class="p">,</span>
                        <span class="n">theta_list</span><span class="p">,</span>
                        <span class="n">interest_list</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">thumb_path</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="n">img_path</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="n">bbox_list</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="n">img_size</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[thumb_delegate] something is wrong&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="n">thumbdat_mode</span><span class="p">:</span>
                <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fpath&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[thumb_delegate] something is wrong&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;error getting thumbnail data&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check if still in viewport</span>
        <span class="k">if</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">thumbtup_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39;[ThumbDelegate] SOURCE IMAGE NOT COMPUTED: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,)</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">dgt</span><span class="o">.</span><span class="n">spawn_thumb_creation_thread</span><span class="p">(</span>
                    <span class="n">thumb_path</span><span class="p">,</span>
                    <span class="n">img_path</span><span class="p">,</span>
                    <span class="n">img_size</span><span class="p">,</span>
                    <span class="n">qtindex</span><span class="p">,</span>
                    <span class="n">view</span><span class="p">,</span>
                    <span class="n">offset</span><span class="p">,</span>
                    <span class="n">bbox_list</span><span class="p">,</span>
                    <span class="n">theta_list</span><span class="p">,</span>
                    <span class="n">interest_list</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">thumbdat_mode</span><span class="p">:</span>
                <span class="n">thumbdat</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">thread_func</span> <span class="o">=</span> <span class="n">thumbdat</span><span class="p">[</span><span class="s1">&#39;thread_func&#39;</span><span class="p">]</span>
                <span class="n">main_func</span> <span class="o">=</span> <span class="n">thumbdat</span><span class="p">[</span><span class="s1">&#39;main_func&#39;</span><span class="p">]</span>
                <span class="c1"># kwargs = data[&#39;kwargs&#39;]</span>
                <span class="c1"># func(*args, **kwargs)</span>
                <span class="c1"># print(&#39;data = %r&#39; % (data,))</span>
                <span class="c1"># print(&#39;newdata not computed&#39;)</span>
                <span class="c1"># SPAWN</span>
                <span class="k">if</span> <span class="n">VERBOSE_THUMB</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ThumbDelegate] Spawning thumbnail creation thread&#39;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">main_func</span><span class="p">()</span>
                <span class="n">thumb_creation_thread</span> <span class="o">=</span> <span class="n">ThumbnailCreationThread2</span><span class="p">(</span>
                    <span class="n">thread_func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">offset</span>
                <span class="p">)</span>
                <span class="c1"># register_thread(thumb_path, thumb_creation_thread)</span>
                <span class="c1"># Initialize threadcount</span>
                <span class="k">if</span> <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># dgt.pool = QtCore.QThreadPool()</span>
                    <span class="c1"># dgt.pool.setMaxThreadCount(MAX_NUM_THUMB_THREADS)</span>
                    <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThreadPool</span><span class="o">.</span><span class="n">globalInstance</span><span class="p">()</span>
                <span class="n">dgt</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">thumb_creation_thread</span><span class="p">)</span>
                <span class="c1"># print(&#39;[ThumbDelegate] Waiting to compute&#39;)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># thumb is computed return the path</span>
            <span class="k">return</span> <span class="n">thumb_path</span></div>

<div class="viewcode-block" id="APIThumbDelegate.adjust_thumb_cell_size"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.APIThumbDelegate.adjust_thumb_cell_size">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_thumb_cell_size</span><span class="p">(</span><span class="n">dgt</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called during paint to ensure that the cell is large enough for the</span>
<span class="sd">        image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTableView</span><span class="p">):</span>
            <span class="c1"># dimensions of the table cells</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">qtindex</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>
            <span class="n">col_width</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">columnWidth</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">column</span><span class="p">())</span>
            <span class="n">col_height</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">rowHeight</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">thumbsize</span> <span class="o">=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">get_thumb_size</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">thumbsize</span> <span class="o">!=</span> <span class="n">dgt</span><span class="o">.</span><span class="n">last_thumbsize</span><span class="p">:</span>
                <span class="c1"># has thumbsize changed?</span>
                <span class="k">if</span> <span class="n">thumbsize</span> <span class="o">!=</span> <span class="n">col_width</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">column</span><span class="p">(),</span> <span class="n">thumbsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">height</span> <span class="o">!=</span> <span class="n">col_height</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">setRowHeight</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">dgt</span><span class="o">.</span><span class="n">last_thumbsize</span> <span class="o">=</span> <span class="n">thumbsize</span>
            <span class="c1"># Let columns shrink</span>
            <span class="k">if</span> <span class="n">thumbsize</span> <span class="o">!=</span> <span class="n">col_width</span><span class="p">:</span>
                <span class="n">view</span><span class="o">.</span><span class="n">setColumnWidth</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">column</span><span class="p">(),</span> <span class="n">thumbsize</span><span class="p">)</span>
            <span class="c1"># Let rows grow</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">col_height</span><span class="p">:</span>
                <span class="n">view</span><span class="o">.</span><span class="n">setRowHeight</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">height</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dgt</span><span class="o">.</span><span class="n">row_rezised_flags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="c1"># HACK TO ONLY SHRINK ONCE WONT WORK WITH RESORT</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dgt</span><span class="o">.</span><span class="n">row_rezised_flags</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Let rows shrink</span>
                <span class="c1"># IF THERE IS MORE THAN ONE COLUMN WITH THUMBS THEN THIS WILL CAUSE</span>
                <span class="c1"># COLS TO BE RESIZED MANY TIMES UNDER THE HOOD. THAT CAUSES</span>
                <span class="c1"># MULTIPLE READS OF THE THUMBS WHICH CAUSES MAJOR SLOWDOWNS.</span>
                <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">col_height</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">setRowHeight</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">height</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTreeView</span><span class="p">):</span>
            <span class="n">col_width</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">columnWidth</span><span class="p">(</span><span class="n">qtindex</span><span class="o">.</span><span class="n">column</span><span class="p">())</span>
            <span class="n">col_height</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">rowHeight</span><span class="p">(</span><span class="n">qtindex</span><span class="p">)</span></div></div>
            <span class="c1"># TODO: finishme</span>


<div class="viewcode-block" id="view_would_not_be_visible"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.view_would_not_be_visible">[docs]</a><span class="k">def</span> <span class="nf">view_would_not_be_visible</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the current scroll position is far beyond the</span>
<span class="sd">    scroll position when this was initially requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">viewport</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">viewport</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
    <span class="n">height_offset</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">verticalOffset</span><span class="p">()</span>
    <span class="n">current_offset</span> <span class="o">=</span> <span class="n">height_offset</span> <span class="o">+</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_offset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">height</span></div>


<div class="viewcode-block" id="get_thread_thumb_info"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.get_thread_thumb_info">[docs]</a><span class="k">def</span> <span class="nf">get_thread_thumb_info</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --test-get_thread_thumb_info</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.guitool.api_thumb_delegate import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; bbox_list = [(100, 50, 400, 200)]</span>
<span class="sd">        &gt;&gt;&gt; theta_list = [0]</span>
<span class="sd">        &gt;&gt;&gt; thumbsize = 128</span>
<span class="sd">        &gt;&gt;&gt; img_size = 600, 300</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; result = get_thread_thumb_info(bbox_list, theta_list, thumbsize, img_size)</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        ((128, 64), [[[21, 11], [107, 11], [107, 53], [21, 53], [21, 11]]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta_list</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_listlike</span><span class="p">(</span><span class="n">theta_list</span><span class="p">)</span> <span class="k">else</span> <span class="n">theta_list</span>
    <span class="n">max_dsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thumbsize</span><span class="p">)</span>
    <span class="n">dsize</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resized_clamped_thumb_dims</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">max_dsize</span><span class="p">)</span>
    <span class="c1"># Compute new verts list</span>
    <span class="n">new_verts_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">scaled_verts_from_bbox_gen</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dsize</span><span class="p">,</span> <span class="n">new_verts_list</span></div>


<div class="viewcode-block" id="make_thread_thumb"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.make_thread_thumb">[docs]</a><span class="k">def</span> <span class="nf">make_thread_thumb</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">dsize</span><span class="p">,</span> <span class="n">new_verts_list</span><span class="p">,</span> <span class="n">interest_list</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes thumbnail with overlay. Called in thead</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --test-make_thread_thumb --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia.guitool.api_thumb_delegate import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; img_path = ut.grab_test_imgpath(&#39;carl.jpg&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dsize = (32, 32)</span>
<span class="sd">        &gt;&gt;&gt; new_verts_list = []</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; thumb = make_thread_thumb(img_path, dsize, new_verts_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; pt.imshow(thumb)</span>
<span class="sd">        &gt;&gt;&gt; pt.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">vtool</span> <span class="k">import</span> <span class="n">geometry</span>

    <span class="n">orange_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">blue_bgr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># imread causes a MEMORY LEAK most likely!</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>  <span class="c1"># Read Image (.0424s) &lt;- Takes most time!</span>
    <span class="c1"># if False:</span>
    <span class="c1">#    #http://stackoverflow.com/questions/9794019/convert-numpy-array-to-pyside-qpixmap</span>
    <span class="c1">#    # http://kogs-www.informatik.uni-hamburg.de/~meine/software/vigraqt/qimage2ndarray.py</span>
    <span class="c1">#    #import numpy as np</span>
    <span class="c1">#    #qimg = QtGui.QImage(img_path, str(QtGui.QImage.Format_RGB32))</span>
    <span class="c1">#    #temp_shape = (qimg.height(), qimg.bytesPerLine() * 8 // qimg.depth(), 4)</span>
    <span class="c1">#    #result_shape = (qimg.height(), qimg.width())</span>
    <span class="c1">#    #buf = qimg.bits().asstring(qimg.numBytes())</span>
    <span class="c1">#    #result  = np.frombuffer(buf, np.uint8).reshape(temp_shape)</span>
    <span class="c1">#    #result = result[:, :result_shape[1]]</span>
    <span class="c1">#    #result = result[..., :3]</span>
    <span class="c1">#    #img = result</span>
    <span class="n">thumb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="p">)</span>  <span class="c1"># Resize to thumb dims (.0015s)</span>
    <span class="k">del</span> <span class="n">img</span>
    <span class="c1"># Draw bboxes on thumb (not image)</span>
    <span class="n">color_bgr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">blue_bgr</span> <span class="k">if</span> <span class="n">interest</span> <span class="k">else</span> <span class="n">orange_bgr</span> <span class="k">for</span> <span class="n">interest</span> <span class="ow">in</span> <span class="n">interest_list</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color_bgr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_verts_list</span><span class="p">,</span> <span class="n">color_bgr_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_verts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geometry</span><span class="o">.</span><span class="n">draw_verts</span><span class="p">(</span><span class="n">thumb</span><span class="p">,</span> <span class="n">new_verts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_bgr</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">thumb</span><span class="p">)</span>
        <span class="c1"># thumb = geometry.draw_verts(thumb, new_verts, color=orange_bgr, thickness=2)</span>
    <span class="k">return</span> <span class="n">thumb</span></div>


<span class="n">RUNNABLE_BASE</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRunnable</span>


<div class="viewcode-block" id="ThumbnailCreationThread2"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread2">[docs]</a><span class="k">class</span> <span class="nc">ThumbnailCreationThread2</span><span class="p">(</span><span class="n">RUNNABLE_BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HACK</span>
<span class="sd">    TODO: http://stackoverflow.com/questions/6783194/background-thread-with-qthread-in-pyqt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">thread_func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">qtindex</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="n">RUNNABLE_BASE</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">thread_func</span> <span class="o">=</span> <span class="n">thread_func</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span> <span class="o">=</span> <span class="n">qtindex</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>

<div class="viewcode-block" id="ThumbnailCreationThread2.thumb_would_not_be_visible"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread2.thumb_would_not_be_visible">[docs]</a>    <span class="k">def</span> <span class="nf">thumb_would_not_be_visible</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute thumbnail in a different thread &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># func = thread.thumbdat[&#39;func&#39;]</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">thread_func</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">,</span> <span class="o">*</span><span class="n">thread</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># func(check_func=thread.thumb_would_not_be_visible)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">dataChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="p">)</span>

<div class="viewcode-block" id="ThumbnailCreationThread2.run"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread2.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;thread failed&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
            <span class="c1"># raise</span>


<div class="viewcode-block" id="ThumbnailCreationThread"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread">[docs]</a><span class="k">class</span> <span class="nc">ThumbnailCreationThread</span><span class="p">(</span><span class="n">RUNNABLE_BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to compute thumbnails concurrently</span>

<span class="sd">    References:</span>
<span class="sd">        TODO:</span>
<span class="sd">        http://stackoverflow.com/questions/6783194/background-thread-with-qthread-in-pyqt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">thread</span><span class="p">,</span>
        <span class="n">thumb_path</span><span class="p">,</span>
        <span class="n">img_path</span><span class="p">,</span>
        <span class="n">img_size</span><span class="p">,</span>
        <span class="n">thumbsize</span><span class="p">,</span>
        <span class="n">qtindex</span><span class="p">,</span>
        <span class="n">view</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">,</span>
        <span class="n">bbox_list</span><span class="p">,</span>
        <span class="n">theta_list</span><span class="p">,</span>
        <span class="n">interest_list</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">RUNNABLE_BASE</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">thumb_path</span> <span class="o">=</span> <span class="n">thumb_path</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">img_path</span> <span class="o">=</span> <span class="n">img_path</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span> <span class="o">=</span> <span class="n">qtindex</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">thumbsize</span> <span class="o">=</span> <span class="n">thumbsize</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">bbox_list</span> <span class="o">=</span> <span class="n">bbox_list</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">theta_list</span> <span class="o">=</span> <span class="n">theta_list</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">interest_list</span> <span class="o">=</span> <span class="n">interest_list</span>

<div class="viewcode-block" id="ThumbnailCreationThread.thumb_would_not_be_visible"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread.thumb_would_not_be_visible">[docs]</a>    <span class="k">def</span> <span class="nf">thumb_would_not_be_visible</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">view_would_not_be_visible</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute thumbnail in a different thread &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="c1"># time.sleep(.005)  # Wait a in case the user is just scrolling</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># Precompute info BEFORE reading the image (.0002s)</span>
        <span class="n">dsize</span><span class="p">,</span> <span class="n">new_verts_list</span> <span class="o">=</span> <span class="n">get_thread_thumb_info</span><span class="p">(</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">theta_list</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumbsize</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">img_size</span>
        <span class="p">)</span>
        <span class="c1"># time.sleep(.005)  # Wait a in case the user is just scrolling</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># -----------------</span>
        <span class="c1"># This part takes time, hopefully the user actually wants to see this</span>
        <span class="c1"># thumbnail.</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">make_thread_thumb</span><span class="p">(</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">img_path</span><span class="p">,</span> <span class="n">dsize</span><span class="p">,</span> <span class="n">new_verts_list</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">interest_list</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">thumb</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">thumb</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thumb_would_not_be_visible</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># print(&#39;[ThumbCreationThread] Thumb Written: %s&#39; % thread.thumb_path)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">dataChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">qtindex</span><span class="p">)</span>
        <span class="c1"># unregister_thread(thread.thumb_path)</span>

<div class="viewcode-block" id="ThumbnailCreationThread.run"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.ThumbnailCreationThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;thread failed&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
            <span class="c1"># raise</span>

    <span class="c1"># def __del__(self):</span>
    <span class="c1">#    print(&#39;About to delete creation thread&#39;)</span>


<span class="c1"># GRAVE:</span>
<span class="c1"># print(&#39;[APIItemDelegate] Request Thumb: rc=(%d, %d), nBboxes=%r&#39; %</span>
<span class="c1">#      (qtindex.row(), qtindex.column(), len(bbox_list)))</span>
<span class="c1"># print(&#39;[APIItemDelegate] bbox_list = %r&#39; % (bbox_list,))</span>


<div class="viewcode-block" id="simple_thumbnail_widget"><a class="viewcode-back" href="../../../wbia.guitool.html#wbia.guitool.api_thumb_delegate.simple_thumbnail_widget">[docs]</a><span class="k">def</span> <span class="nf">simple_thumbnail_widget</span><span class="p">():</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very simple example to test thumbnails</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --test-simple_thumbnail_widget  --show --verbthumb</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --test-simple_thumbnail_widget  --show --tb</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # GUI_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--gui)</span>
<span class="sd">        &gt;&gt;&gt; from wbia.guitool.api_thumb_delegate import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia.guitool</span>
<span class="sd">        &gt;&gt;&gt; guitool.ensure_qapp()  # must be ensured before any embeding</span>
<span class="sd">        &gt;&gt;&gt; wgt = simple_thumbnail_widget()</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; wgt.show()</span>
<span class="sd">        &gt;&gt;&gt; guitool.qtapp_loop(wgt, frequency=100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia.guitool</span>

    <span class="n">guitool</span><span class="o">.</span><span class="n">ensure_qapp</span><span class="p">()</span>
    <span class="n">col_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="s1">&#39;image_name&#39;</span><span class="p">,</span> <span class="s1">&#39;thumb&#39;</span><span class="p">]</span>
    <span class="n">col_types_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;thumb&#39;</span><span class="p">:</span> <span class="s1">&#39;PIXMAP&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">guitool_test_thumbdir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;guitool&#39;</span><span class="p">,</span> <span class="s1">&#39;thumbs&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">guitool_test_thumbdir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">guitool_test_thumbdir</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>

    <span class="c1"># imgname_list = sorted(ut.TESTIMG_URL_DICT.keys())</span>
    <span class="n">imgname_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;carl.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;lena.png&#39;</span><span class="p">,</span> <span class="s1">&#39;patsy.jpg&#39;</span><span class="p">]</span>
    <span class="n">imgname_list</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;doesnotexist.jpg&#39;</span><span class="p">]</span>

    <span class="n">num_imgs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgname_list</span><span class="p">)))</span>
    <span class="c1"># num_imgs = list(range(500))</span>

    <span class="k">def</span> <span class="nf">thread_func</span><span class="p">(</span><span class="n">would_be</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">vtool.fontdemo</span> <span class="k">import</span> <span class="n">get_text_test_img</span>

        <span class="n">get_text_test_img</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">thumb_getter</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">thumbsize</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Thumb getters must conform to thumbtup structure &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imgname_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;fpath&#39;</span><span class="p">:</span> <span class="n">id_</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thread_func&#39;</span><span class="p">:</span> <span class="n">thread_func</span><span class="p">,</span>
                <span class="s1">&#39;main_func&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">id_</span><span class="p">,),</span>
            <span class="p">}</span>
        <span class="c1"># print(id_)</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="o">==</span> <span class="s1">&#39;doesnotexist.jpg&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grab_test_imgpath</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">img_size</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">open_image_size</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">guitool_test_thumbdir</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">img_path</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="o">==</span> <span class="s1">&#39;carl.jpg&#39;</span><span class="p">:</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)]</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">id_</span> <span class="o">==</span> <span class="s1">&#39;lena.png&#39;</span><span class="p">:</span>
            <span class="c1"># bbox_list = [(10, 10, 200, 200)]</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">theta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interest_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
        <span class="n">thumbtup</span> <span class="o">=</span> <span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">interest_list</span><span class="p">)</span>
        <span class="c1"># print(&#39;thumbtup = %r&#39; % (thumbtup,))</span>
        <span class="k">return</span> <span class="n">thumbtup</span>
        <span class="c1"># return None</span>

    <span class="k">def</span> <span class="nf">imgname_getter</span><span class="p">(</span><span class="n">rowid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rowid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgname_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">imgname_list</span><span class="p">[</span><span class="n">rowid</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span>

    <span class="n">col_getter_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;rowid&#39;</span><span class="p">:</span> <span class="n">num_imgs</span><span class="p">,</span>
        <span class="s1">&#39;image_name&#39;</span><span class="p">:</span> <span class="n">imgname_getter</span><span class="p">,</span>
        <span class="s1">&#39;thumb&#39;</span><span class="p">:</span> <span class="n">thumb_getter</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">col_ider_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;thumb&#39;</span><span class="p">:</span> <span class="s1">&#39;image_name&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">col_setter_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">editable_colnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sortby</span> <span class="o">=</span> <span class="s1">&#39;rowid&#39;</span>

    <span class="k">def</span> <span class="nf">get_thumb_size</span><span class="p">():</span>
        <span class="k">return</span> <span class="mi">128</span>

    <span class="c1"># get_thumb_size = lambda: 128  # NOQA</span>
    <span class="n">col_width_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">col_bgrole_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">api</span> <span class="o">=</span> <span class="n">guitool</span><span class="o">.</span><span class="n">CustomAPI</span><span class="p">(</span>
        <span class="n">col_name_list</span><span class="p">,</span>
        <span class="n">col_types_dict</span><span class="p">,</span>
        <span class="n">col_getter_dict</span><span class="p">,</span>
        <span class="n">col_bgrole_dict</span><span class="p">,</span>
        <span class="n">col_ider_dict</span><span class="p">,</span>
        <span class="n">col_setter_dict</span><span class="p">,</span>
        <span class="n">editable_colnames</span><span class="p">,</span>
        <span class="n">sortby</span><span class="p">,</span>
        <span class="n">get_thumb_size</span><span class="p">,</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="n">col_width_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">make_headers</span><span class="p">(</span><span class="n">tblnice</span><span class="o">=</span><span class="s1">&#39;Utool Test Images&#39;</span><span class="p">)</span>

    <span class="n">wgt</span> <span class="o">=</span> <span class="n">guitool</span><span class="o">.</span><span class="n">APIItemWidget</span><span class="p">()</span>
    <span class="n">wgt</span><span class="o">.</span><span class="n">change_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">wgt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="c1"># guitool.qtapp_loop(qwin=wgt, ipy=ipy, frequency=loop_freq)</span>
    <span class="k">return</span> <span class="n">wgt</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --allexamples</span>
<span class="sd">        python -m wbia.guitool.api_thumb_delegate --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  <li><a href="../guitool.html">wbia.guitool</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
