
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wbia.scripts.getshark_old &#8212; wbia 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for wbia.scripts.getshark_old</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span>

<span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_injured_sharks"><a class="viewcode-back" href="../../../wbia.scripts.html#wbia.scripts.getshark_old.get_injured_sharks">[docs]</a><span class="k">def</span> <span class="nf">get_injured_sharks</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from wbia.scripts.getshark import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">requests</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.whaleshark.org/getKeywordImages.jsp&#39;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="s1">&#39;indexName&#39;</span><span class="p">)</span>
    <span class="n">key_to_nice</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="s1">&#39;indexName&#39;</span><span class="p">]:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;readableName&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">}</span>

    <span class="n">injury_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;injury&#39;</span><span class="p">,</span>
        <span class="s1">&#39;net&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hook&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trunc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;damage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scar&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nicks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bite&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">injury_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span> <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">pat</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">injury_patterns</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="n">noninjury_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">setdiff</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">injury_keys</span><span class="p">)</span>
    <span class="n">injury_nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">key_to_nice</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">injury_keys</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="n">noninjury_nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">key_to_nice</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">noninjury_keys</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="n">injury_keys</span>

    <span class="n">keyed_images</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;reading index&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">key_url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;?indexName=</span><span class="si">{indexName}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexName</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">key_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_url</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">key_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">key_imgs</span> <span class="o">=</span> <span class="n">key_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
        <span class="n">keyed_images</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_imgs</span>

    <span class="n">key_hist</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">imgs</span> <span class="ow">in</span> <span class="n">keyed_images</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">key_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">(</span><span class="n">key_hist</span><span class="p">,</span> <span class="s1">&#39;vals&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">key_hist</span><span class="p">))</span>
    <span class="n">nice_key_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_keys</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">key_to_nice</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">key_hist</span><span class="p">)</span>
    <span class="n">nice_key_hist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">sort_dict</span><span class="p">(</span><span class="n">nice_key_hist</span><span class="p">,</span> <span class="s1">&#39;vals&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">nice_key_hist</span><span class="p">))</span>

    <span class="n">key_to_urls</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">keyed_images</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">overlaps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kn">import</span> <span class="nn">itertools</span>

    <span class="n">overlap_img_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">key_to_urls</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">overlap_imgs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">isect</span><span class="p">(</span><span class="n">key_to_urls</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span> <span class="n">key_to_urls</span><span class="p">[</span><span class="n">k2</span><span class="p">])</span>
        <span class="n">num_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_imgs</span><span class="p">)</span>
        <span class="n">overlaps</span><span class="p">[(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">num_overlap</span>
        <span class="n">overlaps</span><span class="p">[(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k1</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_to_urls</span><span class="p">[</span><span class="n">k1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># print(&#39;[%s][%s], overlap=%r&#39; % (k1, k2, num_overlap))</span>
            <span class="n">overlap_img_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">overlap_imgs</span><span class="p">)</span>

    <span class="n">all_img_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">key_to_urls</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
    <span class="n">num_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_img_urls</span><span class="p">)</span>  <span class="c1"># NOQA</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;num_all = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_all</span><span class="p">,))</span>

    <span class="c1"># Determine super-categories</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nicks&#39;</span><span class="p">,</span> <span class="s1">&#39;scar&#39;</span><span class="p">,</span> <span class="s1">&#39;trunc&#39;</span><span class="p">]</span>

    <span class="c1"># Force these keys into these categories</span>
    <span class="n">key_to_cat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scarbite&#39;</span><span class="p">:</span> <span class="s1">&#39;other_injury&#39;</span><span class="p">}</span>

    <span class="n">cat_to_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_to_urls</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_to_cat</span><span class="p">:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">key_to_cat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">cat_to_keys</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">cat_to_keys</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="s1">&#39;other_injury&#39;</span>
            <span class="n">cat_to_keys</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">cat_urls</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">cat_to_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">cat_urls</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">key_to_urls</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="n">cat_hist</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat_urls</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">cat_urls</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cat_urls</span><span class="p">[</span><span class="n">cat</span><span class="p">]))</span>
        <span class="n">cat_hist</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_urls</span><span class="p">[</span><span class="n">cat</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">cat_to_keys</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">cat_hist</span><span class="p">))</span>

    <span class="n">key_to_cat</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">cat_to_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">])</span>

    <span class="c1"># ingestset = {</span>
    <span class="c1">#    &#39;__class__&#39;: &#39;ImageSet&#39;,</span>
    <span class="c1">#    &#39;images&#39;: ut.ddict(dict)</span>
    <span class="c1"># }</span>
    <span class="c1"># for key, key_imgs in keyed_images.items():</span>
    <span class="c1">#    for imgdict in key_imgs:</span>
    <span class="c1">#        url = imgdict[&#39;url&#39;]</span>
    <span class="c1">#        encid = imgdict[&#39;correspondingEncounterNumber&#39;]</span>
    <span class="c1">#        # Make structure</span>
    <span class="c1">#        encdict = encounters[encid]</span>
    <span class="c1">#        encdict[&#39;__class__&#39;] = &#39;Encounter&#39;</span>
    <span class="c1">#        imgdict = ut.delete_keys(imgdict.copy(), [&#39;correspondingEncounterNumber&#39;])</span>
    <span class="c1">#        imgdict[&#39;__class__&#39;] = &#39;Image&#39;</span>
    <span class="c1">#        cat = key_to_cat[key]</span>
    <span class="c1">#        annotdict = {&#39;relative_bbox&#39;: [.01, .01, .98, .98], &#39;tags&#39;: [cat, key]}</span>
    <span class="c1">#        annotdict[&#39;__class__&#39;] = &#39;Annotation&#39;</span>

    <span class="c1">#        # Ensure structures exist</span>
    <span class="c1">#        encdict[&#39;images&#39;] = encdict.get(&#39;images&#39;, [])</span>
    <span class="c1">#        imgdict[&#39;annots&#39;] = imgdict.get(&#39;annots&#39;, [])</span>

    <span class="c1">#        # Add an image to this encounter</span>
    <span class="c1">#        encdict[&#39;images&#39;].append(imgdict)</span>
    <span class="c1">#        # Add an annotation to this image</span>
    <span class="c1">#        imgdict[&#39;annots&#39;].append(annotdict)</span>

    <span class="c1">##http://springbreak.wildbook.org/rest/org.ecocean.Encounter/1111</span>
    <span class="c1"># get_enc_url = &#39;http://www.whaleshark.org/rest/org.ecocean.Encounter/%s&#39; % (encid,)</span>
    <span class="c1"># resp = requests.get(get_enc_url)</span>
    <span class="c1"># print(ut.repr3(encdict))</span>
    <span class="c1"># print(ut.repr3(encounters))</span>

    <span class="c1"># Download the files to the local disk</span>
    <span class="c1"># fpath_list =</span>

    <span class="n">all_urls</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">keyed_images</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">cat_to_keys</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="s1">&#39;url&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">dldir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/tmpsharks&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">commonprefix</span><span class="p">,</span> <span class="n">basename</span>  <span class="c1"># NOQA</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">commonprefix</span><span class="p">(</span><span class="n">all_urls</span><span class="p">)</span>
    <span class="n">suffix_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">url_</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">url_</span> <span class="ow">in</span> <span class="n">all_urls</span><span class="p">]</span>
    <span class="n">fname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffix_list</span><span class="p">]</span>

    <span class="n">fpath_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">all_urls</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">),</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;downloading imgs&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grab_file_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="n">dldir</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fpath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>

    <span class="c1"># Make sure we keep orig info</span>
    <span class="c1"># url_to_keys = ut.ddict(list)</span>
    <span class="n">url_to_info</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">imgdict_list</span> <span class="ow">in</span> <span class="n">keyed_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">imgdict</span> <span class="ow">in</span> <span class="n">imgdict_list</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">imgdict</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">url_to_info</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">imgdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c1"># url_to_keys[url].append(key)</span>

    <span class="n">info_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">url_to_info</span><span class="p">,</span> <span class="n">all_urls</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;correspondingEncounterNumber&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;url with two different encounter nums&#39;</span>
    <span class="c1"># Combine duplicate tags</span>

    <span class="n">hashid_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">get_file_uuid</span><span class="p">(</span><span class="n">fpath_</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">for</span> <span class="n">fpath_</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">fpath_list</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">hashid_list</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Group properties by duplicate images</span>
    <span class="c1"># groupxs = [g for g in groupxs if len(g) &gt; 1]</span>
    <span class="n">fpath_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">fpath_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">url_list_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">all_urls</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">info_list_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_accum</span><span class="p">(</span><span class="o">*</span><span class="n">info_</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">info_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">encid_list_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;correspondingEncounterNumber&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">info_list_</span>
    <span class="p">]</span>
    <span class="n">keys_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">info_</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">info_</span> <span class="ow">in</span> <span class="n">info_list_</span><span class="p">]</span>
    <span class="n">cats_list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">key_to_cat</span><span class="p">,</span> <span class="n">keys</span><span class="p">))</span> <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">keys_list_</span><span class="p">]</span>

    <span class="n">clist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ColumnLists</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;gpath&#39;</span><span class="p">:</span> <span class="n">fpath_list_</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url_list_</span><span class="p">,</span>
            <span class="s1">&#39;encid&#39;</span><span class="p">:</span> <span class="n">encid_list_</span><span class="p">,</span>
            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">keys_list_</span><span class="p">,</span>
            <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="n">cats_list_</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># for info_ in ut.apply_grouping(info_list, groupxs):</span>
    <span class="c1">#    info = ut.dict_accum(*info_)</span>
    <span class="c1">#    info = ut.map_dict_vals(ut.flatten, info)</span>
    <span class="c1">#    x = ut.unique(ut.flatten(ut.dict_accum(*info_)[&#39;correspondingEncounterNumber&#39;]))</span>
    <span class="c1">#    if len(x) &gt; 1:</span>
    <span class="c1">#        info = info.copy()</span>
    <span class="c1">#        del info[&#39;keys&#39;]</span>
    <span class="c1">#        print(ut.repr3(info))</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">fpath_has_imgext</span><span class="p">,</span> <span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gpath&#39;</span><span class="p">])</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="n">clist</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s1">&#39;WS_Injury&#39;</span><span class="p">,</span> <span class="n">allow_newdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">add_images</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gpath&#39;</span><span class="p">])</span>
    <span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gid_list</span>

    <span class="n">failed_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flag_None_items</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# failed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">failed_flags</span><span class="p">)),)</span>
    <span class="n">passed_flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">(</span><span class="n">failed_flags</span><span class="p">)</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="n">clist</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">passed_flags</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_all_not_None</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">])</span>
    <span class="c1"># ibs.get_image_uris_original(clist[&#39;gid&#39;])</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_uris_original</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">],</span> <span class="n">clist</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ut.zipflat(clist[&#39;cat&#39;], clist[&#39;key&#39;])</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Can run detection instead</span>
        <span class="n">clist</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">zipflat</span><span class="p">(</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">])</span>
        <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">use_images_as_annotations</span><span class="p">(</span>
            <span class="n">clist</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">],</span> <span class="n">adjust_percent</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">tags_list</span><span class="o">=</span><span class="n">clist</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">aid_list</span>

    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="kn">from</span> <span class="nn">wbia</span> <span class="k">import</span> <span class="n">core_annots</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">qt4ensure</span><span class="p">()</span>
    <span class="c1"># annots = ibs.annots()</span>
    <span class="c1"># aids = [1, 2]</span>
    <span class="c1"># ibs.depc_annot.get(&#39;hog&#39;, aids , &#39;hog&#39;)</span>
    <span class="c1"># ibs.depc_annot.get(&#39;chip&#39;, aids, &#39;img&#39;)</span>
    <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">InteractiveIter</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()):</span>
        <span class="n">hogs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_annot</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get_hog_hog</span><span class="p">([</span><span class="n">aid</span><span class="p">])</span>
        <span class="n">chips</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_annot</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get_chips_img</span><span class="p">([</span><span class="n">aid</span><span class="p">])</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">chips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hogimg</span> <span class="o">=</span> <span class="n">core_annots</span><span class="o">.</span><span class="n">make_hog_block_image</span><span class="p">(</span><span class="n">hogs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hogimg</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1"># print(len(groupxs))</span>

    <span class="c1"># if False:</span>
    <span class="c1"># groupxs = ut.find_duplicate_items(ut.lmap(basename, suffix_list)).values()</span>
    <span class="c1"># print(ut.repr3(ut.apply_grouping(all_urls, groupxs)))</span>
    <span class="c1">#    # FIX</span>
    <span class="c1">#    for fpath, fname in zip(fpath_list, fname_list):</span>
    <span class="c1">#        if ut.checkpath(fpath):</span>
    <span class="c1">#            ut.move(fpath, join(dirname(fpath), fname))</span>
    <span class="c1">#            print(&#39;fpath = %r&#39; % (fpath,))</span>

    <span class="c1"># import wbia</span>
    <span class="c1"># from wbia.dbio import ingest_dataset</span>
    <span class="c1"># dbdir = wbia.sysres.lookup_dbdir(&#39;WS_ALL&#39;)</span>
    <span class="c1"># self = ingest_dataset.Ingestable2(dbdir)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Show overlap matrix</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">dict_</span> <span class="o">=</span> <span class="n">overlaps</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">overlaps</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">label_texts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

        <span class="k">def</span> <span class="nf">label_ticks</span><span class="p">(</span><span class="n">label_texts</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

            <span class="n">truncated_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">lbl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">label_texts</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label_texts</span><span class="p">))))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">truncated_labels</span><span class="p">)</span>
            <span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="o">-</span><span class="mi">55</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()]</span>
            <span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()]</span>

            <span class="c1"># xgrid, ygrid = np.meshgrid(range(len(label_texts)), range(len(label_texts)))</span>
            <span class="c1"># pt.plot_surface3d(xgrid, ygrid, disjoint_mat)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label_texts</span><span class="p">))))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">truncated_labels</span><span class="p">)</span>
            <span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="c1"># [lbl.set_rotation(20) for lbl in ax.get_yticklabels()]</span>

        <span class="c1"># df = df.sort(axis=0)</span>
        <span class="c1"># df = df.sort(axis=1)</span>

        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">matplotlib.colors</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">label_ticks</span><span class="p">(</span><span class="n">label_texts</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># overlap_df = pd.DataFrame.from_dict(overlap_img_list)</span>

    <span class="k">class</span> <span class="nc">TmpImage</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">hog</span>
    <span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">exposure</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="n">image2</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astronaut</span><span class="p">())</span>  <span class="c1"># NOQA</span>

    <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;./GOPR1120.JPG&#39;</span>

    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fpath</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        http://scikit-image.org/docs/dev/auto_examples/plot_hog.html</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">grayscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">color_funcs</span><span class="o">.</span><span class="n">to_base01</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">hog_image</span> <span class="o">=</span> <span class="n">hog</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">orientations</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">pixels_per_cell</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
            <span class="n">cells_per_block</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">visualise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input image&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_adjustable</span><span class="p">(</span><span class="s1">&#39;box-forced&#39;</span><span class="p">)</span>

        <span class="c1"># Rescale histogram for better display</span>
        <span class="n">hog_image_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">hog_image</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">))</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hog_image_rescaled</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Histogram of Oriented Gradients&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_adjustable</span><span class="p">(</span><span class="s1">&#39;box-forced&#39;</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="c1"># for</span>


<div class="viewcode-block" id="detect_sharks"><a class="viewcode-back" href="../../../wbia.scripts.html#wbia.scripts.getshark_old.detect_sharks">[docs]</a><span class="k">def</span> <span class="nf">detect_sharks</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gids</span><span class="p">):</span>
    <span class="c1"># import wbia</span>
    <span class="c1"># ibs = wbia.opendb(&#39;WS_ALL&#39;)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;algo&#39;</span><span class="p">:</span> <span class="s1">&#39;yolo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sensitivity&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="s1">&#39;config_filepath&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span>
            <span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.cfg&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;weight_filepath&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span>
            <span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.39000.weights&#39;</span>
        <span class="p">),</span>
        <span class="s1">&#39;class_filepath&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span>
            <span class="s1">&#39;~/work/WS_ALL/localizer_backup/detect.yolo.2.cfg.classes&#39;</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="n">depc</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_image</span>

    <span class="c1"># imgsets = ibs.imagesets(text=&#39;Injured Sharks&#39;)</span>
    <span class="c1"># images = ibs.images(imgsets.gids[0])</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">gids</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">compress</span><span class="p">([</span><span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.gif&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">exts</span><span class="p">])</span>
    <span class="n">gid_list</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">gids</span>

    <span class="c1"># result is a tuple:</span>
    <span class="c1"># (score, bbox_list, theta_list, conf_list, class_list)</span>
    <span class="n">results_list</span> <span class="o">=</span> <span class="n">depc</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;localizations&#39;</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">results_list2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">multi_gids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_gids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ibs.set_image_imagesettext(failed_gids, [&#39;Fixme&#39;] * len(failed_gids))</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_image_imagesettext</span><span class="p">(</span><span class="n">multi_gids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Fixme2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_gids</span><span class="p">))</span>

    <span class="n">failed_gids</span>

    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">results_list</span><span class="p">):</span>
        <span class="n">score</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">,</span> <span class="n">class_list</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">failed_gids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results_list2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gid</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multi_gids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">conf_list</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">theta_list</span><span class="p">[</span><span class="n">idx</span> <span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">results_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(([</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">]))</span>

    <span class="n">localized_imgs</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">localized_imgs</span><span class="o">.</span><span class="n">aids</span><span class="p">])</span>
    <span class="n">old_annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">localized_imgs</span><span class="o">.</span><span class="n">aids</span><span class="p">))</span>
    <span class="c1"># old_tags = old_annots.case_tags</span>

    <span class="c1"># Override old bboxes</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_bboxes</span><span class="p">(</span><span class="n">old_annots</span><span class="o">.</span><span class="n">aids</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">qt4ensure</span><span class="p">()</span>

        <span class="n">inter</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">MultiImageInteraction</span><span class="p">(</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="n">bboxes_list</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">results_list2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">dump_to_disk</span><span class="p">(</span><span class="s1">&#39;shark_loc&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;shark_loc&#39;</span><span class="p">)</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">inter</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">MultiImageInteraction</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">failed_gids</span><span class="p">))</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">inter</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">MultiImageInteraction</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">multi_gids</span><span class="p">))</span>
        <span class="n">inter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="train_part_detector"><a class="viewcode-back" href="../../../wbia.scripts.html#wbia.scripts.getshark_old.train_part_detector">[docs]</a><span class="k">def</span> <span class="nf">train_part_detector</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Problem:</span>
<span class="sd">        healthy sharks usually have a mostly whole body shot</span>
<span class="sd">        injured sharks usually have a close up shot.</span>
<span class="sd">        This distribution of images is likely what the injur-shark net is picking up on.</span>

<span class="sd">    The goal is to train a detector that looks for things that look</span>
<span class="sd">    like the distribution of injured sharks.</span>

<span class="sd">    We will run this on healthy sharks to find the parts of</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s1">&#39;WS_ALL&#39;</span><span class="p">)</span>
    <span class="n">imgset</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">imagesets</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Injured Sharks&#39;</span><span class="p">)</span>
    <span class="n">injured_annots</span> <span class="o">=</span> <span class="n">imgset</span><span class="o">.</span><span class="n">annots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># NOQA</span>

    <span class="c1"># config = {</span>
    <span class="c1">#    &#39;dim_size&#39;: (224, 224),</span>
    <span class="c1">#    &#39;resize_dim&#39;: &#39;wh&#39;</span>
    <span class="c1"># }</span>

    <span class="kn">from</span> <span class="nn">pydarknet</span> <span class="k">import</span> <span class="n">Darknet_YOLO_Detector</span>

    <span class="n">data_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(),</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;localizer&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">Darknet_YOLO_Detector</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">dark</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">dark</span>

    <span class="n">localizer_weight_path</span><span class="p">,</span> <span class="n">localizer_config_path</span><span class="p">,</span> <span class="n">localizer_class_path</span> <span class="o">=</span> <span class="n">results</span>
    <span class="n">classifier_model_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">classifier_train</span><span class="p">()</span>
    <span class="n">labeler_model_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">labeler_train</span><span class="p">()</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(),</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;detector&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">localizer_weight_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;localizer.weights&#39;</span><span class="p">))</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">localizer_config_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;localizer.config&#39;</span><span class="p">))</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">localizer_class_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;localizer.classes&#39;</span><span class="p">))</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">classifier_model_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;classifier.npy&#39;</span><span class="p">))</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">labeler_model_path</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;labeler.npy&#39;</span><span class="p">))</span></div>

    <span class="c1"># ibs.detector_train()</span>


<div class="viewcode-block" id="purge_ensure_one_annot_per_images"><a class="viewcode-back" href="../../../wbia.scripts.html#wbia.scripts.getshark_old.purge_ensure_one_annot_per_images">[docs]</a><span class="k">def</span> <span class="nf">purge_ensure_one_annot_per_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    pip install Pipe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Purge all but one annotation</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">()</span>
    <span class="c1"># images.aids</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">_annot_groups</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="c1"># Take all but the largest annotations per images</span>
    <span class="n">large_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">index_to_boolmask</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">bbox_area</span><span class="p">]</span>
    <span class="n">small_masks</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">not_list</span><span class="p">,</span> <span class="n">large_masks</span><span class="p">)</span>
    <span class="c1"># Remove all but the largets annotation</span>
    <span class="n">small_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">zipcompress</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">aid</span><span class="p">,</span> <span class="n">small_masks</span><span class="p">)</span>
    <span class="n">small_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">small_aids</span><span class="p">)</span>

    <span class="c1"># Fix any empty images</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">images</span><span class="p">()</span>
    <span class="n">empty_images</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">num_annotations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;empty_images = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">empty_images</span><span class="p">,))</span>
    <span class="c1"># list(map(basename, map(dirname, images.uris_original)))</span>

    <span class="k">def</span> <span class="nf">VecPipe</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pipe</span>

        <span class="nd">@pipe</span><span class="o">.</span><span class="n">Pipe</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
            <span class="c1"># return (None if item is None else func(item) for item in sequence)</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="n">name_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">uris_original</span> <span class="o">|</span> <span class="n">VecPipe</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span> <span class="o">|</span> <span class="n">VecPipe</span><span class="p">(</span><span class="n">basename</span><span class="p">))</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">aids</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">assert_all_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">aids_list</span> <span class="o">|</span> <span class="n">VecPipe</span><span class="p">(</span><span class="nb">len</span><span class="p">)))</span>
    <span class="n">annots</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">annots</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids_list</span><span class="p">))</span>
    <span class="n">annots</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">name_list</span></div>


<div class="viewcode-block" id="shark_misc"><a class="viewcode-back" href="../../../wbia.scripts.html#wbia.scripts.getshark_old.shark_misc">[docs]</a><span class="k">def</span> <span class="nf">shark_misc</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">wbia</span>

    <span class="n">ibs</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">opendb</span><span class="p">(</span><span class="s1">&#39;WS_ALL&#39;</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_been_adjusted</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">adjusted_aids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adjusted_aids</span></div>

    <span class="c1"># if False:</span>
    <span class="c1">#    # TRY TO FIGURE OUT WHY URLS ARE MISSING IN STEP 1</span>
    <span class="c1">#    encounter_to_parsed1 = parsed1.group_items(&#39;encounter&#39;)</span>
    <span class="c1">#    encounter_to_parsed2 = parsed2.group_items(&#39;encounter&#39;)</span>

    <span class="c1">#    url_to_parsed1 = parsed1.group_items(&#39;img_url&#39;)</span>
    <span class="c1">#    url_to_parsed2 = parsed2.group_items(&#39;img_url&#39;)</span>

    <span class="c1">#    def set_overlap(set1, set2):</span>
    <span class="c1">#        set1 = set(set1)</span>
    <span class="c1">#        set2 = set(set2)</span>
    <span class="c1">#        return ut.odict([</span>
    <span class="c1">#            (&#39;s1&#39;, len(set1)),</span>
    <span class="c1">#            (&#39;s2&#39;, len(set2)),</span>
    <span class="c1">#            (&#39;isect&#39;, len(set1.intersection(set2))),</span>
    <span class="c1">#            (&#39;union&#39;, len(set1.union(set2))),</span>
    <span class="c1">#            (&#39;s1 - s2&#39;, len(set1.difference(set2))),</span>
    <span class="c1">#            (&#39;s2 - s1&#39;, len(set2.difference(set1))),</span>
    <span class="c1">#        ])</span>
    <span class="c1">#    print(&#39;encounter overlap: &#39; + ut.repr3(set_overlap(encounter_to_parsed1, encounter_to_parsed2)))</span>
    <span class="c1">#    print(&#39;url overlap: &#39; + ut.repr3(set_overlap(url_to_parsed1, url_to_parsed2)))</span>

    <span class="c1">#    url1 = list(url_to_parsed1.keys())</span>
    <span class="c1">#    url2 = list(url_to_parsed2.keys())</span>
    <span class="c1">#    # remove common prefixes</span>
    <span class="c1">#    from os.path import commonprefix, basename  # NOQA</span>
    <span class="c1">#    cp1 = commonprefix(url1)</span>
    <span class="c1">#    cp2 = commonprefix(url2)</span>
    <span class="c1">#    #suffix1 = sorted([u[len(cp1):].lower() for u in url1])</span>
    <span class="c1">#    #suffix2 = sorted([u[len(cp2):].lower() for u in url2])</span>
    <span class="c1">#    suffix1 = sorted([u[len(cp1):] for u in url1])</span>
    <span class="c1">#    suffix2 = sorted([u[len(cp2):] for u in url2])</span>
    <span class="c1">#    print(&#39;suffix overlap: &#39; + ut.repr3(set_overlap(suffix1, suffix2)))</span>
    <span class="c1">#    set1 = set(suffix1)</span>
    <span class="c1">#    set2 = set(suffix2)</span>
    <span class="c1">#    only1 = list(set1 - set1.intersection(set2))</span>
    <span class="c1">#    only2 = list(set2 - set1.intersection(set2))</span>

    <span class="c1">#    import numpy as np</span>
    <span class="c1">#    for suf in ut.ProgIter(only2, bs=True):</span>
    <span class="c1">#        dist = np.array(ut.edit_distance(suf, only1))</span>
    <span class="c1">#        idx = ut.argsort(dist)[0:3]</span>
    <span class="c1">#        if dist[idx][0] &lt; 3:</span>
    <span class="c1">#            close = ut.take(only1, idx)</span>
    <span class="c1">#            print(&#39;---&#39;)</span>
    <span class="c1">#            print(&#39;suf = %r&#39; % (join(cp2, suf),))</span>
    <span class="c1">#            print(&#39;close = %s&#39; % (ut.repr3([join(cp1, c) for c in close]),))</span>
    <span class="c1">#            print(&#39;---&#39;)</span>
    <span class="c1">#            break</span>

    <span class="c1">#    # Associate keywords with original images</span>
    <span class="c1">#    #lower_urls = [x.lower() for x in parsed[&#39;img_url&#39;]]</span>
    <span class="c1">#    url_to_idx = ut.make_index_lookup(parsed1[&#39;img_url&#39;])</span>
    <span class="c1">#    parsed1[&#39;keywords&#39;] = [[] for _ in range(len(parsed1))]</span>
    <span class="c1">#    for url, keys in url_to_keys.items():</span>
    <span class="c1">#        # hack because urls are note in the same format</span>
    <span class="c1">#        url = url.replace(&#39;wildbook_data_dir&#39;, &#39;shepherd_data_dir&#39;)</span>
    <span class="c1">#        url = url.lower()</span>
    <span class="c1">#        if url in url_to_idx:</span>
    <span class="c1">#            idx = url_to_idx[url]</span>
    <span class="c1">#            parsed1[&#39;keywords&#39;][idx].extend(keys)</span>

    <span class="c1"># healthy_annots = ibs.annots(ibs.imagesets(text=&#39;Non-Injured Sharks&#39;).aids[0])</span>
    <span class="c1"># ibs.set_annot_prop(&#39;healthy&#39;, healthy_annots.aids, [True] * len(healthy_annots))</span>
    <span class="c1"># [&#39;healthy&#39; in t and len(t) &gt; 0 for t in single_annots.case_tags]</span>
    <span class="c1"># healthy_tags = []</span>

    <span class="c1"># ut.find_duplicate_items(cur_img_uuids)</span>
    <span class="c1"># ut.find_duplicate_items(new_img_uuids)</span>
    <span class="c1"># cur_uuids = set(cur_img_uuids)</span>
    <span class="c1"># new_uuids = set(new_img_uuids)</span>
    <span class="c1"># both_uuids = new_uuids.intersection(cur_uuids)</span>
    <span class="c1"># only_cur = cur_uuids - both_uuids</span>
    <span class="c1"># only_new = new_uuids - both_uuids</span>
    <span class="c1"># print(&#39;len(cur_uuids) = %r&#39; % (len(cur_uuids)))</span>
    <span class="c1"># print(&#39;len(new_uuids) = %r&#39; % (len(new_uuids)))</span>
    <span class="c1"># print(&#39;len(both_uuids) = %r&#39; % (len(both_uuids)))</span>
    <span class="c1"># print(&#39;len(only_cur) = %r&#39; % (len(only_cur)))</span>
    <span class="c1"># print(&#39;len(only_new) = %r&#39; % (len(only_new)))</span>

    <span class="c1"># Ensure that data in both sets are syncronized</span>
    <span class="c1"># images_both = []</span>

    <span class="c1"># if False:</span>
    <span class="c1">#    print(&#39;Removing small images&#39;)</span>
    <span class="c1">#    import numpy as np</span>
    <span class="c1">#    import vtool as vt</span>
    <span class="c1">#    imgsize_list = np.array([vt.open_image_size(gpath) for gpath in parsed[&#39;new_fpath&#39;]])</span>
    <span class="c1">#    sqrt_area_list = np.sqrt(np.prod(imgsize_list, axis=1))</span>
    <span class="c1">#    areq_flags_list = sqrt_area_list &gt;= 750</span>
    <span class="c1">#    parsed = parsed.compress(areq_flags_list)</span>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia.html">wbia - Wildbook IA</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia.html">wbia</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

    </div>




  </body>
</html>
