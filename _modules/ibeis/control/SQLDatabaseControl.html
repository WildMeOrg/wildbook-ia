<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ibeis.control.SQLDatabaseControl &mdash; ibeis 0.1.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="ibeis 0.1.0.dev1 documentation" href="../../../index.html" />
    <link rel="up" title="ibeis.control" href="../control.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../control.html" accesskey="U">ibeis.control</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ibeis.control.SQLDatabaseControl</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Interface into SQL for the IBEIS Controller</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="c"># Python</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">utool</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
<span class="c"># Tools</span>
<span class="kn">from</span> <span class="nn">ibeis</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">ibeis.control._sql_helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_unpacker</span><span class="p">,</span> <span class="n">sanatize_sql</span><span class="p">,</span>
                                        <span class="n">SQLExecutionContext</span><span class="p">,</span> <span class="n">PRINT_SQL</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ibeis.control</span> <span class="kn">import</span> <span class="n">__SQLITE3__</span> <span class="k">as</span> <span class="n">lite</span>
<span class="p">(</span><span class="k">print</span><span class="p">,</span> <span class="n">print_</span><span class="p">,</span> <span class="n">printDBG</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[sql]&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="default_decorator"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.default_decorator">[docs]</a><span class="k">def</span> <span class="nf">default_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">func</span>
    <span class="c">#return profile(func)</span>
    <span class="c">#return utool.indent_func(&#39;[sql.&#39; + func.__name__ + &#39;]&#39;)(func)</span>
</div>
<span class="n">VERBOSE</span>        <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span>
<span class="n">VERYVERBOSE</span>    <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERYVERBOSE</span>
<span class="n">QUIET</span>          <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">QUIET</span> <span class="ow">or</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--quiet-sql&#39;</span><span class="p">)</span>
<span class="n">VERBOSE_SQL</span>    <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--verb-sql&#39;</span><span class="p">)</span>
<span class="n">AUTODUMP</span>       <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--auto-dump&#39;</span><span class="p">)</span>
<span class="n">COPY_TO_MEMORY</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--copy-db-to-memory&#39;</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot; If would be really great if we could get a certain set of setters, getters,</span>
<span class="sd">and deleters to be indexed into only with rowids. If we could do this than for</span>
<span class="sd">that subset of data, we could hook up a least recently used cache which is</span>
<span class="sd">populated whenever you get data from some table/colname using the rowid as the</span>
<span class="sd">key. The cache would then only have to be invalidated if we were going to set /</span>
<span class="sd">get data from that same rowid.  This would offer big speadups for both the</span>
<span class="sd">recognition algorithm and the GUI. &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>


<div class="viewcode-block" id="common_decor"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.common_decor">[docs]</a><span class="k">def</span> <span class="nf">common_decor</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">closure_common</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">default_decorator</span><span class="p">(</span><span class="n">closure_common</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getter_sql"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.getter_sql">[docs]</a><span class="k">def</span> <span class="nf">getter_sql</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">closure_getter</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">common_decor</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="adder_sql"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.adder_sql">[docs]</a><span class="k">def</span> <span class="nf">adder_sql</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c">#return common_decor(func)</span>
    <span class="k">return</span> <span class="n">func</span>

</div>
<div class="viewcode-block" id="setter_sql"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.setter_sql">[docs]</a><span class="k">def</span> <span class="nf">setter_sql</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c">#return common_decor(func)</span>
    <span class="k">return</span> <span class="n">func</span>

</div>
<div class="viewcode-block" id="deleter_sql"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.deleter_sql">[docs]</a><span class="k">def</span> <span class="nf">deleter_sql</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c">#return common_decor(func)</span>
    <span class="k">return</span> <span class="n">func</span>

</div>
<div class="viewcode-block" id="ider_sql"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.ider_sql">[docs]</a><span class="k">def</span> <span class="nf">ider_sql</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c">#return common_decor(func)</span>
    <span class="k">return</span> <span class="n">func</span>

</div>
<span class="n">__STR__</span> <span class="o">=</span> <span class="nb">str</span> <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span> <span class="k">else</span> <span class="nb">unicode</span>


<div class="viewcode-block" id="SQLAtomicContext"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext">[docs]</a><span class="k">class</span> <span class="nc">SQLAtomicContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">PRINT_SQL</span><span class="p">):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>  <span class="c"># Reference to sqldb</span>
        <span class="n">context</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c"># Get new cursor</span>
        <span class="n">context</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

<div class="viewcode-block" id="SQLAtomicContext.__enter__"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext.__enter__">[docs]</a>    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the database into a state of an atomic transaction &quot;&quot;&quot;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;BEGIN EXCLUSIVE TRANSACTION&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>
</div>
<div class="viewcode-block" id="SQLAtomicContext.__exit__"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLAtomicContext.__exit__">[docs]</a>    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finalization of an SQLAtomicContext &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># An SQLError is a serious offence.</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] FATAL ERROR IN ATOMIC CONTEXT&#39;</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>  <span class="c"># Dump on error</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] Error in atomic context manager!: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>  <span class="c"># return a falsey value on error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="SQLDatabaseController"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController">[docs]</a><span class="k">class</span> <span class="nc">SQLDatabaseController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SQLDatabaseController an efficientish interface into SQL</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sqldb_dpath</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">sqldb_fname</span><span class="o">=</span><span class="s">&#39;database.sqlite3&#39;</span><span class="p">,</span>
                 <span class="n">text_factory</span><span class="o">=</span><span class="n">__STR__</span><span class="p">,</span> <span class="n">inmemory</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates db and opens connection &quot;&quot;&quot;</span>
        <span class="c">#with utool.Timer(&#39;New SQLDatabaseController&#39;):</span>
        <span class="c">#printDBG(&#39;[sql.__init__]&#39;)</span>
        <span class="c"># TODO:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># key \in [tblname][colnames][rowid]</span>
        <span class="c"># Get SQL file path</span>
        <span class="n">db</span><span class="o">.</span><span class="n">dir_</span>  <span class="o">=</span> <span class="n">sqldb_dpath</span>
        <span class="n">db</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">sqldb_fname</span>
        <span class="k">assert</span> <span class="n">exists</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">),</span> <span class="s">&#39;[sql] db.dir_=</span><span class="si">%r</span><span class="s"> does not exist!&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">dir_</span>
        <span class="n">db</span><span class="o">.</span><span class="n">fpath</span>    <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">text_factory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] Initializing new database&#39;</span><span class="p">)</span>
        <span class="c"># Open the SQL database connection with support for custom types</span>
        <span class="c">#lite.enable_callback_tracebacks(True)</span>
        <span class="c">#db.fpath = &#39;:memory:&#39;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span>
        <span class="c">#db.connection.isolation_level = None  # turns sqlite3 autocommit off</span>
        <span class="c">#db.connection.isolation_level = lite.IMMEDIATE  # turns sqlite3 autocommit off</span>
        <span class="k">if</span> <span class="n">inmemory</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">inmemory</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">COPY_TO_MEMORY</span><span class="p">):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_copy_to_memory</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">text_factory</span>
        <span class="c"># Get a cursor which will preform sql commands / queries / executions</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c"># Optimize the database (if anything is set)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_ensure_metadata_table</span><span class="p">()</span>

<div class="viewcode-block" id="SQLDatabaseController.get_fpath"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">fpath</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.close"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_ensure_metadata_table</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="c"># We need this to be done every time so that the update code works correctly.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;metadata_rowid&#39;</span><span class="p">,</span>               <span class="s">&#39;INTEGER PRIMARY KEY&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;metadata_key&#39;</span><span class="p">,</span>                 <span class="s">&#39;TEXT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,</span>               <span class="s">&#39;TEXT&#39;</span><span class="p">),</span>
        <span class="p">),</span>
            <span class="n">superkey_colnames_list</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;metadata_key&#39;</span><span class="p">,)],</span>
            <span class="c"># IMPORTANT: Yes, we want this line to be tabbed over for the schema auto-generation</span>
            <span class="n">docstr</span><span class="o">=</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">        The table that stores permanently all of the metadata about the</span>
<span class="s">        database (tables, etc)&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="c"># Ensure that a version number exists</span>
        <span class="n">db</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">(</span><span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="SQLDatabaseController.get_db_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_version</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">metadata_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;database_version&#39;</span><span class="p">]</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_key</span> <span class="ow">in</span> <span class="n">metadata_key_list</span><span class="p">)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39;metadata_key=?&#39;</span>
        <span class="c"># list of relationships for each image</span>
        <span class="n">metadata_value_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                                           <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span>
                                           <span class="n">where_clause</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_value_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;duplicate database_version keys in database&#39;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">metadata_value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ensure</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">BASE_DATABASE_VERSION</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;metadata_key&#39;</span><span class="p">,</span> <span class="s">&#39;metadata_value&#39;</span><span class="p">]</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s">&#39;database_version&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
            <span class="n">get_rowid_from_superkey</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c"># We don&#39;t care to find any, because we know there is no version</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span>
</div>
    <span class="k">def</span> <span class="nf">_copy_to_memory</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="c"># http://stackoverflow.com/questions/3850022/python-sqlite3-load-existing-db-file-to-memory</span>
        <span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">cStringIO</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">QUIET</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] Copying database into RAM&#39;</span><span class="p">)</span>
        <span class="n">tempfile</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
            <span class="n">tempfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># Create a database in memory and import from tempfile</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="s">&quot;:memory:&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">Row</span>

    <span class="c">#@utool.memprof</span>
<div class="viewcode-block" id="SQLDatabaseController.reboot"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] reboot&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect2</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">text_factory</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.optimize"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="c"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html#pragma-cache_size</span>
        <span class="c"># http://web.utk.edu/~jplyon/sqlite/SQLite_optimization_FAQ.html</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] running sql pragma optimizions&#39;</span><span class="p">)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA cache_size = 0;&#39;)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA cache_size = 1024;&#39;)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA page_size = 1024;&#39;)</span>
        <span class="c">#print(&#39;[sql] running sql pragma optimizions&#39;)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;PRAGMA cache_size = 10000;&#39;</span><span class="p">)</span>  <span class="c"># Default: 2000</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;PRAGMA temp_store = MEMORY;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;PRAGMA synchronous = OFF;&#39;</span><span class="p">)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA synchronous = NORMAL;&#39;)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA synchronous = FULL;&#39;)  # Default</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA parser_trace = OFF;&#39;)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA busy_timeout = 1;&#39;)</span>
        <span class="c">#db.cur.execute(&#39;PRAGMA default_cache_size = 0;&#39;)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.shrink_memory"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.shrink_memory">[docs]</a>    <span class="k">def</span> <span class="nf">shrink_memory</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] shrink_memory&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;PRAGMA shrink_memory;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.vacuum"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.vacuum">[docs]</a>    <span class="k">def</span> <span class="nf">vacuum</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] vaccum&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;VACUUM;&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.squeeze"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.squeeze">[docs]</a>    <span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] squeeze&#39;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">shrink_memory</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>

    <span class="c">#==============</span>
    <span class="c"># API INTERFACE</span>
    <span class="c">#==============</span>

    <span class="c">#@ider_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        SELECT rowid</span>
<span class="s">        FROM {tblname}</span>
<span class="s">        ORDER BY rowid ASC</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.get_all_col_rows"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_col_rows">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_col_rows</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of all rowids from a table in ascending order &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span> <span class="s">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        SELECT {colname}</span>
<span class="s">        FROM {tblname}</span>
<span class="s">        ORDER BY rowid ASC</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">)</span>

    <span class="c">#@ider_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get_all_rowids_where"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_all_rowids_where">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_rowids_where</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns a list of rowids from a table in ascending order satisfying</span>
<span class="sd">        a condition &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tblname&#39;</span><span class="p">:</span> <span class="n">tblname</span><span class="p">,</span> <span class="s">&#39;where_clause&#39;</span><span class="p">:</span> <span class="n">where_clause</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        SELECT rowid</span>
<span class="s">        FROM {tblname}</span>
<span class="s">        WHERE {where_clause}</span>
<span class="s">        ORDER BY rowid ASC</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ADDER NOTE: use add_cleanly &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tblname&#39;</span>  <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                   <span class="s">&#39;erotemes&#39;</span> <span class="p">:</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;?&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)),</span>
                   <span class="s">&#39;params&#39;</span>   <span class="p">:</span> <span class="s">&#39;,</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        INSERT INTO {tblname}(</span>
<span class="s">        rowid,</span>
<span class="s">        {params}</span>
<span class="s">        ) VALUES (NULL, {erotemes})</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                                   <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowid_list</span>

    <span class="c">#@adder_sql</span>
<div class="viewcode-block" id="SQLDatabaseController.add_cleanly"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_cleanly">[docs]</a>    <span class="k">def</span> <span class="nf">add_cleanly</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">,</span> <span class="n">superkey_paramx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ADDER Extra input:</span>
<span class="sd">        the first item of params_iter must be a superkey (like a uuid),</span>

<span class="sd">        Does not add None values. Does not add duplicate values.</span>
<span class="sd">        For each None input returns None ouptut.</span>
<span class="sd">        For each duplicate input returns existing rowid</span>

<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to add into</span>

<span class="sd">            colnames (tuple of strs): columns whos values are specified in params_iter</span>

<span class="sd">            params_iter (iterable): an iterable of tuples where each tuple corresonds to a row</span>

<span class="sd">            get_rowid_from_superkey (func): function that tests if a row needs</span>
<span class="sd">                to be added. It should return None for any new rows to be inserted.</span>
<span class="sd">                It should return the existing rowid if one exists</span>

<span class="sd">            superkey_paramx (tuple of ints): indicies of tuples in params_iter which</span>
<span class="sd">                correspond to superkeys. defaults to (0,)</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterable: rowid_list_ -- list of newly added or previously added rowids</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; db = &#39;?&#39;</span>
<span class="sd">            &gt;&gt;&gt; tblname = tblname_temp</span>
<span class="sd">            &gt;&gt;&gt; colnames = dst_list</span>
<span class="sd">            &gt;&gt;&gt; params_iter = data_list</span>
<span class="sd">            &gt;&gt;&gt; #get_rowid_from_superkey = &#39;?&#39;</span>
<span class="sd">            &gt;&gt;&gt; superkey_paramx = (0,)</span>
<span class="sd">            &gt;&gt;&gt; rowid_list_ = add_cleanly(db, tblname, colnames, params_iter, get_rowid_from_superkey, superkey_paramx)</span>
<span class="sd">            &gt;&gt;&gt; print(rowid_list_)</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="c"># ADD_CLEANLY_1: PREPROCESS INPUT</span>
        <span class="n">params_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>  <span class="c"># eagerly evaluate for superkeys</span>
        <span class="c"># Extract superkeys from the params list (requires eager eval)</span>
        <span class="n">superkey_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">superkey_paramx</span><span class="p">]</span>
        <span class="c"># ADD_CLEANLY_2: PREFORM INPUT CHECKS</span>
        <span class="c"># check which parameters are valid</span>
        <span class="c">#and not any(ut.flag_None_items(params))</span>
        <span class="n">isvalid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">]</span>
        <span class="c"># Check for duplicate inputs</span>
        <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)))</span>
        <span class="c"># Check to see if this already exists in the database</span>
        <span class="n">rowid_list_</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>
        <span class="n">isnew_list</span>  <span class="o">=</span> <span class="p">[</span><span class="n">rowid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">rowid_list_</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">isunique_list</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[WARNING]: duplicate inputs to db.add_cleanly&#39;</span><span class="p">)</span>
        <span class="c"># Flag each item that needs to added to the database</span>
        <span class="n">needsadd_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">all</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isvalid_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">,</span> <span class="n">isnew_list</span><span class="p">)))</span>
        <span class="c"># ADD_CLEANLY_3.1: EXIT IF CLEAN</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">needsadd_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rowid_list_</span>  <span class="c"># There is nothing to add. Return the rowids</span>
        <span class="c"># ADD_CLEANLY_3.2: PERFORM DIRTY ADDITIONS</span>
        <span class="n">dirty_params</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">params_list</span><span class="p">,</span> <span class="n">needsadd_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] adding </span><span class="si">%r</span><span class="s">/</span><span class="si">%r</span><span class="s"> new </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirty_params</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="n">tblname</span><span class="p">))</span>
        <span class="c"># Add any unadded parameters to the database</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">dirty_params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span>
                <span class="s">&#39;dirty_params&#39;</span><span class="p">,</span>
                <span class="s">&#39;needsadd_list&#39;</span><span class="p">,</span>
                <span class="s">&#39;superkey_lists&#39;</span><span class="p">,</span>
                <span class="s">&#39;rowid_list_&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="c"># TODO: We should only have to preform a subset of adds here</span>
        <span class="c"># (at the positions where rowid_list was None in the getter check)</span>
        <span class="n">rowid_list</span> <span class="o">=</span> <span class="n">get_rowid_from_superkey</span><span class="p">(</span><span class="o">*</span><span class="n">superkey_lists</span><span class="p">)</span>

        <span class="c"># ADD_CLEANLY_4: SANITY CHECK AND RETURN</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_list</span><span class="p">),</span> <span class="s">&#39;failed sanity check&#39;</span>
        <span class="k">return</span> <span class="n">rowid_list</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.get_where2"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_where2">[docs]</a>    <span class="k">def</span> <span class="nf">get_where2</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">andwhere_colnames</span><span class="p">,</span>
                   <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; hacked in function for nicer templates &quot;&quot;&quot;</span>
        <span class="n">andwhere_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">colname</span> <span class="o">+</span> <span class="s">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">andwhere_colnames</span><span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">andwhere_clauses</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span>
                            <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#@getter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get_where"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_where">[docs]</a>    <span class="k">def</span> <span class="nf">get_where</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span>
                  <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="c">#if isinstance(colnames, six.string_types):</span>
        <span class="c">#    colnames = (colnames,)</span>
        <span class="k">if</span> <span class="n">where_clause</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tblname&#39;</span>     <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                       <span class="s">&#39;colnames&#39;</span>    <span class="p">:</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="p">}</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            SELECT {colnames}</span>
<span class="s">            FROM {tblname}</span>
<span class="s">            &#39;&#39;&#39;</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executeone_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;tblname&#39;</span>     <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
                        <span class="s">&#39;colnames&#39;</span>    <span class="p">:</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span>
                        <span class="s">&#39;where_clauses&#39;</span> <span class="p">:</span>  <span class="n">where_clause</span><span class="p">,</span> <span class="p">}</span>
            <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            SELECT {colnames}</span>
<span class="s">            FROM {tblname}</span>
<span class="s">            WHERE {where_clauses}</span>
<span class="s">            &#39;&#39;&#39;</span>

            <span class="n">val_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                                     <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                                                     <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
                                                     <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val_list</span>

    <span class="c">#@getter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get_rowid_from_superkey"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_rowid_from_superkey">[docs]</a>    <span class="k">def</span> <span class="nf">get_rowid_from_superkey</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">params_iter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">superkey_colnames</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter which uses the constrained superkeys instead of rowids &quot;&quot;&quot;</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">colname</span> <span class="o">+</span> <span class="s">&#39;=?&#39;</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">superkey_colnames</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;rowid&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#@getter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.get"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">id_iter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter</span>
<span class="sd">        Args:</span>
<span class="sd">            tblname (str): table name to get from</span>
<span class="sd">            colnames (tuple of str): column names to grab from</span>
<span class="sd">            id_iter (iterable): iterable of search keys</span>
<span class="sd">            id_colname (str): column to be used as the search key (default: rowid)</span>
<span class="sd">            eager (bool): use eager evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s">&#39;must specify column names to get from&#39;</span>
        <span class="c">#if isinstance(colnames, six.string_types):</span>
        <span class="c">#    colnames = (colnames,)</span>
        <span class="k">if</span> <span class="n">id_iter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s">&#39;=?&#39;</span><span class="p">)</span>
            <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_iter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#@setter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.set"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s">&#39;rowid&#39;</span><span class="p">,</span>
            <span class="n">duplicate_behavior</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setter &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="c">#if isinstance(colnames, six.string_types):</span>
        <span class="c">#    colnames = (colnames,)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val_iter</span><span class="p">)</span>  <span class="c"># eager evaluation</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">id_iter</span><span class="p">)</span>  <span class="c"># eager evaluation</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">QUIET</span> <span class="ow">and</span> <span class="n">VERYVERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] SETTER: &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_caller_name</span><span class="p">())</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] * tblname=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tblname</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] * val_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val_list</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] * id_list=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_list</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] * id_colname=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_colname</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">duplicates_exist</span><span class="p">(</span><span class="n">id_list</span><span class="p">),</span> <span class="s">&quot;Passing a not-unique list of ids&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">debug_duplicate_items</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
                <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;len(id_list) = </span><span class="si">%r</span><span class="s">, len(set(id_list)) = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))))</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">duplicate_behavior</span> <span class="o">==</span> <span class="s">&#39;filter&#39;</span><span class="p">:</span>
            <span class="c"># Keep only the first setting of every row</span>
            <span class="n">isunique_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">flag_unique_items</span><span class="p">(</span><span class="n">id_iter</span><span class="p">)</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">filter_items</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">isunique_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;unknown duplicate_behavior=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">duplicate_behavior</span><span class="p">,))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_list</span><span class="p">)</span>
            <span class="n">num_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">num_val</span> <span class="o">==</span> <span class="n">num_id</span><span class="p">,</span> <span class="s">&#39;list inputs have different lengths&#39;</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;num_val&#39;</span><span class="p">,</span> <span class="s">&#39;num_id&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tblname_str&#39;</span>  <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s">&#39;assign_str&#39;</span>   <span class="p">:</span> <span class="s">&#39;,</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=?&#39;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">]),</span>
            <span class="s">&#39;where_clause&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            UPDATE {tblname_str}</span>
<span class="s">            SET {assign_str}</span>
<span class="s">            WHERE {where_clause}</span>
<span class="s">            &#39;&#39;&#39;</span>

        <span class="c"># TODO: The flattenize can be removed if we pass in val_lists instead</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">flattenize</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">val_list</span><span class="p">,</span> <span class="n">id_list</span><span class="p">)))</span>
        <span class="c">#params_iter = list(zip(val_list, id_list))</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#@deleter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.delete"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s">&#39;rowid&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; deleter. USE delete_rowids instead &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tblname&#39;</span>   <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s">&#39;rowid_str&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">id_colname</span> <span class="o">+</span> <span class="s">&#39;=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            DELETE</span>
<span class="s">            FROM {tblname}</span>
<span class="s">            WHERE {rowid_str}</span>
<span class="s">            &#39;&#39;&#39;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#@deleter_sql</span></div>
<div class="viewcode-block" id="SQLDatabaseController.delete_rowids"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.delete_rowids">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rowids</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tblname</span><span class="p">,</span> <span class="n">rowid_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; deletes the the rows in rowid_list &quot;&quot;&quot;</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tblname&#39;</span>   <span class="p">:</span> <span class="n">tblname</span><span class="p">,</span>
            <span class="s">&#39;rowid_str&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s">&#39;rowid=?&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">operation_fmt</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            DELETE</span>
<span class="s">            FROM {tblname}</span>
<span class="s">            WHERE {rowid_str}</span>
<span class="s">            &#39;&#39;&#39;</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_rowid</span> <span class="ow">in</span> <span class="n">rowid_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">_executemany_operation_fmt</span><span class="p">(</span><span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span>
                                             <span class="n">params_iter</span><span class="o">=</span><span class="n">params_iter</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#==============</span>
    <span class="c"># CORE WRAPPERS</span>
    <span class="c">#==============</span>
</div>
    <span class="nd">@default_decorator</span>
    <span class="k">def</span> <span class="nf">_executeone_operation_fmt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@default_decorator</span>
    <span class="k">def</span> <span class="nf">_executemany_operation_fmt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation_fmt</span><span class="p">,</span> <span class="n">fmtdict</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span>
                                   <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="n">unpack_scalars</span><span class="p">,</span>
                              <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="n">eager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#=========</span>
    <span class="c"># SQLDB CORE</span>
    <span class="c">#=========</span>

    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.add_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_table">[docs]</a>    <span class="k">def</span> <span class="nf">add_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coldef_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table_constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">docstr</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">superkey_colnames_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add_table</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>
<span class="sd">            coldef_list (list):</span>
<span class="sd">            table_constraints (list or None):</span>
<span class="sd">            docstr (str):</span>
<span class="sd">            superkey_colnames_list (list or None): list of tuples of column names which uniquely identifies a rowid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;tablename must be given&#39;</span>
        <span class="k">assert</span> <span class="n">coldef_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;tablename must be given&#39;</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] schema ensuring tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">utool</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">]</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">table_constraints</span><span class="o">=</span><span class="n">table_constraints</span><span class="p">,</span> <span class="n">docstr</span><span class="o">=</span><span class="n">docstr</span><span class="p">,</span>
                           <span class="n">superkey_colnames_list</span><span class="o">=</span><span class="n">superkey_colnames_list</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">func_str</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">,</span> <span class="n">_args</span><span class="p">,</span> <span class="n">_kwargs</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c"># anyway.</span>
        <span class="k">if</span> <span class="n">table_constraints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">table_constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">has_superkeys</span> <span class="o">=</span> <span class="p">(</span><span class="n">superkey_colnames_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_superkeys</span><span class="p">:</span>
                <span class="c">#if len(table_constraints) != 0:</span>
                <span class="c">#    print(&#39;[sql] Warning: blindly commented assert would have triggered&#39;)</span>
                <span class="c">#assert len(table_constraints) == 0</span>
                <span class="c"># Add each superkey_colnames as a table constraint</span>
                <span class="n">constraint_fmtstr</span> <span class="o">=</span> <span class="s">&#39;CONSTRAINT superkey UNIQUE ({colnames_str})&#39;</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s">&#39;must be list got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">superkey_colnames</span> <span class="ow">in</span> <span class="n">superkey_colnames_list</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s">&#39;must be list of tuples&#39;</span>
                    <span class="n">colnames_str</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">)</span>
                    <span class="n">unique_constraint</span> <span class="o">=</span> <span class="n">constraint_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colnames_str</span><span class="o">=</span><span class="n">colnames_str</span><span class="p">)</span>
                    <span class="n">table_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_constraint</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span>
        <span class="n">body_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coldef_list</span><span class="p">]</span>

        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;table_body&#39;</span><span class="p">:</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body_list</span> <span class="o">+</span> <span class="n">table_constraints</span><span class="p">),</span>
            <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;CREATE TABLE IF NOT EXISTS {tablename} ({table_body})&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Insert or replace docstr in metadata table</span>
            <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                <span class="s">&#39;columns&#39;</span><span class="p">:</span> <span class="s">&#39;metadata_key, metadata_value&#39;</span>
            <span class="p">}</span>
            <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;INSERT OR REPLACE INTO {tablename} ({columns}) VALUES (?, ?)&#39;</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_docstr&#39;</span><span class="p">,</span> <span class="n">docstr</span><span class="p">]</span>
            <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Insert or replace constraint in metadata table</span>
            <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                <span class="s">&#39;columns&#39;</span><span class="p">:</span> <span class="s">&#39;metadata_key, metadata_value&#39;</span>
            <span class="p">}</span>
            <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;INSERT OR REPLACE INTO {tablename} ({columns}) VALUES (?, ?)&#39;</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_constraint&#39;</span><span class="p">,</span> <span class="s">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_constraints</span><span class="p">)]</span>
            <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">superkey_colnames_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># have the metadata table keep track of table superkeys</span>
            <span class="c"># Insert or replace superkeys in metadata table</span>
            <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span>
                <span class="s">&#39;columns&#39;</span><span class="p">:</span> <span class="s">&#39;metadata_key, metadata_value&#39;</span>
            <span class="p">}</span>
            <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;INSERT OR REPLACE INTO {tablename} ({columns}) VALUES (?, ?)&#39;</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
            <span class="c">#superkey_colnames_list_repr = &#39;;&#39;.join(superkey_colnames_list)</span>
            <span class="n">superkey_colnames_list_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">superkey_colnames_list</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_superkeys&#39;</span><span class="p">,</span> <span class="n">superkey_colnames_list_repr</span><span class="p">]</span>
            <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.add_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] add column=</span><span class="si">%r</span><span class="s"> of type=</span><span class="si">%r</span><span class="s"> to tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">coltype</span><span class="p">,</span> <span class="n">tablename</span><span class="p">))</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
            <span class="s">&#39;colname&#39;</span><span class="p">:</span> <span class="n">colname</span><span class="p">,</span>
            <span class="s">&#39;coltype&#39;</span><span class="p">:</span> <span class="n">coltype</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;ALTER TABLE {tablename} ADD COLUMN {colname} {coltype}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.modify_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.modify_table">[docs]</a>    <span class="k">def</span> <span class="nf">modify_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colmap_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table_constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">docstr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">superkey_colnames_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tablename_new</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">colmap_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;must specify colmaplist&#39;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;must specify tablename&#39;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        funciton to modify the schema - only columns that are being added, removed or changed need to be enumerated</span>

<span class="sd">        Args:</span>
<span class="sd">           tablename (str): tablename</span>
<span class="sd">           colmap_list (list): of tuples (orig_colname, new_colname, new_coltype, convert_func)</span>
<span class="sd">           table_constraints (str):</span>
<span class="sd">           superkey_colnames_list (list)</span>
<span class="sd">           docstr (str)</span>
<span class="sd">           tablename_new (?)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; def contributor_location_zip_map(x):</span>
<span class="sd">            ...     return x</span>
<span class="sd">            &gt;&gt;&gt; ibs = None</span>
<span class="sd">            &gt;&gt;&gt; ibs.db.modify_table(constants.CONTRIBUTOR_TABLE, (</span>
<span class="sd">            ... #  Original Column Name,             New Column Name,                 New Column Type, Function to convert data from old to new</span>
<span class="sd">            ... #   [None to append, int for index]  [&#39;&#39; for same, None to delete]    [&#39;&#39; for same]    [None to use data unmodified]</span>
<span class="sd">            ...    # a non-needed, but correct mapping (identity function)</span>
<span class="sd">            ...    (&#39;contributor_rowid&#39;,             &#39;&#39;,                              &#39;&#39;,               None),</span>
<span class="sd">            ...    # for new columns, function is ignored (TYPE CANNOT BE EMPTY IF ADDING)</span>
<span class="sd">            ...    (None,                            &#39;contributor__location_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            ...    # adding a new column at index 4 (if index is invalid, None is used)</span>
<span class="sd">            ...    (4,                               &#39;contributor__location_address&#39;, &#39;TEXT&#39;,           None),</span>
<span class="sd">            ...    # for deleted columns, type and function are ignored</span>
<span class="sd">            ...    (&#39;contributor__location_city&#39;,    None,                            &#39;&#39;,               None),</span>
<span class="sd">            ...    # for renamed columns, type and function are ignored</span>
<span class="sd">            ...    (&#39;contributor__location_city&#39;,    &#39;contributor__location_town&#39;,    &#39;&#39;,               None),</span>
<span class="sd">            ...    (&#39;contributor_location_zip&#39;,      &#39;contributor_location_zip&#39;,      &#39;TEXT&#39;,           contributor_location_zip_map),</span>
<span class="sd">            ...    # type not changing, only NOT NULL provision</span>
<span class="sd">            ...    (&#39;contributor__location_country&#39;, &#39;&#39;,                              &#39;TEXT NOT NULL&#39;,  None),</span>
<span class="sd">            ...    ),</span>
<span class="sd">            ...    superkey_colnames_list=[(&#39;contributor_rowid&#39;,)],</span>
<span class="sd">            ...    table_constraints=[],</span>
<span class="sd">            ...    docstr=&#39;Used to store the contributors to the project&#39;</span>
<span class="sd">            ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] schema modifying tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>

        <span class="n">colname_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">colname_original_list</span> <span class="o">=</span> <span class="n">colname_list</span><span class="p">[:]</span>
        <span class="n">coltype_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">colname_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span> <span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">}</span>
        <span class="n">colmap_dict</span>  <span class="o">=</span> <span class="p">{}</span>

        <span class="n">insert</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">map_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">colmap_list</span><span class="p">:</span>
            <span class="c">#is_newcol = dst not in colname_list</span>
            <span class="c">#if dst == &#39;annot_visual_uuid&#39;:</span>
            <span class="c">#    ut.embed()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="c"># Add column</span>
                <span class="k">assert</span> <span class="n">dst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;New column&#39;s name must be valid&quot;</span>
                <span class="k">assert</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;New column&#39;s type must be specified&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">src</span><span class="p">):</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] WARNING: multiple index inserted add columns, may cause allignment issues&#39;</span><span class="p">)</span>
                    <span class="n">colname_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                    <span class="n">coltype_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
                    <span class="n">insert</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">,</span> <span class="s">&#39;Unkown source colname=</span><span class="si">%s</span><span class="s"> in tablename=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;colname_list&#39;</span><span class="p">])</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">colname_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dst</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Drop column</span>
                    <span class="k">assert</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Deleted column&#39;s name  must be valid&quot;</span>
                    <span class="k">del</span> <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dst</span> <span class="ow">and</span>
                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">type_</span> <span class="o">==</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">])):</span>
                    <span class="c"># Rename column</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">colname_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                    <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                    <span class="n">colname_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                    <span class="c"># Change column type</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_</span>
                <span class="k">elif</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Simply map function across table&#39;s data</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Identity, this can be ommited as it is automatically done</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="n">coltype_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_</span>

        <span class="n">coldef_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">colname_list</span><span class="p">,</span> <span class="n">coltype_list</span><span class="p">))</span>
        <span class="n">tablename_orig</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="n">tablename_temp</span> <span class="o">=</span> <span class="n">tablename_orig</span> <span class="o">+</span> <span class="s">&#39;_temp&#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">random_nonce</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_constraints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">table_constraints</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span>
                     <span class="n">table_constraints</span><span class="o">=</span><span class="n">table_constraints</span><span class="p">,</span>
                     <span class="n">docstr</span><span class="o">=</span><span class="n">docstr</span><span class="p">,</span>
                     <span class="n">superkey_colnames_list</span><span class="o">=</span><span class="n">superkey_colnames_list</span><span class="p">)</span>

        <span class="c"># Copy data</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dst_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_original_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colname_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">src_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colname_dict</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">src_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># Run functions across all data for specified callums</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">([</span>
                <span class="n">colmap_dict</span><span class="p">[</span><span class="n">src_</span><span class="p">](</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_</span> <span class="ow">in</span> <span class="n">colmap_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">d</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">src_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">src_list</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list_</span>
        <span class="p">]</span>
        <span class="c"># Add the data to the database</span>
        <span class="n">get_rowid_from_superkey</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">dst_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tablename_new</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Drop original table</span>
            <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="c"># Rename temp table to original table name</span>
            <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Rename new table to new name</span>
            <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.reorder_columns"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.reorder_columns">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_columns</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">order_list</span><span class="p">):</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] schema column reordering for tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c"># Get current tables</span>
        <span class="n">colname_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">coltype_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">coltype_list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order_list</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colname_list</span><span class="p">))</span> <span class="p">]),</span> <span class="s">&#39;Order index list invalid&#39;</span>
        <span class="c"># Reorder column definitions</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">order_list</span><span class="p">,</span> <span class="n">colname_list</span><span class="p">,</span> <span class="n">coltype_list</span><span class="p">)))</span>
        <span class="n">coldef_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span> <span class="ow">in</span> <span class="n">combined</span> <span class="p">]</span>
        <span class="n">tablename_temp</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_temp&#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">random_nonce</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">table_constraints</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">coldef_list</span><span class="p">,</span>
                     <span class="n">table_constraints</span><span class="o">=</span><span class="n">table_constraints</span><span class="p">,</span>
                     <span class="n">docstr</span><span class="o">=</span><span class="n">docstr</span><span class="p">,)</span>
        <span class="c"># Copy data</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">colname_list</span><span class="p">))</span>
        <span class="c"># Add the data to the database</span>
        <span class="n">get_rowid_from_superkey</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_cleanly</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">colname_list</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">get_rowid_from_superkey</span><span class="p">)</span>
        <span class="c"># Drop original table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="c"># Rename temp table to original table name</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="n">tablename_temp</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.duplicate_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.duplicate_table">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">tablename_duplicate</span><span class="p">):</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] schema duplicating tablename=</span><span class="si">%r</span><span class="s"> into tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">tablename_duplicate</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">[],</span> <span class="n">tablename_new</span><span class="o">=</span><span class="n">tablename_duplicate</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.duplicate_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.duplicate_column">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">):</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] schema duplicating tablename.colname=</span><span class="si">%r</span><span class="s">.</span><span class="si">%r</span><span class="s"> into tablename.colname=</span><span class="si">%r</span><span class="s">.</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">))</span>
        <span class="c"># Modify table to add a blank column with the appropriate tablename and NO data</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_types</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_types</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[!sql] could not find colname=</span><span class="si">%r</span><span class="s"> to duplicate&#39;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># Add column to the table</span>
        <span class="c"># DATABASE TABLE CACHES ARE UPDATED WITH add_column</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">colname_duplicate</span><span class="p">,</span> <span class="n">column_types</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="c"># Copy the data from the original column to the new duplcate column</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tablename&#39;</span><span class="p">:</span>           <span class="n">tablename</span><span class="p">,</span>
            <span class="s">&#39;colname_duplicate&#39;</span><span class="p">:</span>   <span class="n">colname_duplicate</span><span class="p">,</span>
            <span class="s">&#39;colname&#39;</span><span class="p">:</span>             <span class="n">colname</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;UPDATE {tablename} SET {colname_duplicate} = {colname}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.rename_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.rename_table">[docs]</a>    <span class="k">def</span> <span class="nf">rename_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] schema renaming tablename=</span><span class="si">%r</span><span class="s"> -&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename_old</span><span class="p">,</span> <span class="n">tablename_new</span><span class="p">))</span>
        <span class="c"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tablename_old&#39;</span><span class="p">:</span> <span class="n">tablename_old</span><span class="p">,</span>
            <span class="s">&#39;tablename_new&#39;</span><span class="p">:</span> <span class="n">tablename_new</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;ALTER TABLE {tablename_old} RENAME TO {tablename_new}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Rename table&#39;s metadata</span>
        <span class="n">key_old_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename_old</span> <span class="o">+</span> <span class="s">&#39;_constraint&#39;</span><span class="p">,</span>
            <span class="n">tablename_old</span> <span class="o">+</span> <span class="s">&#39;_docstr&#39;</span><span class="p">,</span>
            <span class="n">tablename_old</span> <span class="o">+</span> <span class="s">&#39;_superkeys&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">key_new_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename_new</span> <span class="o">+</span> <span class="s">&#39;_constraint&#39;</span><span class="p">,</span>
            <span class="n">tablename_new</span> <span class="o">+</span> <span class="s">&#39;_docstr&#39;</span><span class="p">,</span>
            <span class="n">tablename_new</span> <span class="o">+</span> <span class="s">&#39;_superkeys&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_old_list</span><span class="p">)</span>
        <span class="n">val_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_new_list</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;metadata_key&#39;</span><span class="p">,)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s">&#39;metadata_key&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.rename_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.rename_column">[docs]</a>    <span class="k">def</span> <span class="nf">rename_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname_old</span><span class="p">,</span> <span class="n">colname_new</span><span class="p">):</span>
        <span class="c"># DATABASE TABLE CACHES ARE UPDATED WITH modify_table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">colname_old</span><span class="p">,</span> <span class="n">colname_new</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">))</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.drop_table"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">printDBG</span><span class="p">(</span><span class="s">&#39;[sql] schema dropping tablename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tablename</span><span class="p">)</span>
        <span class="c"># Technically insecure call, but all entries are statically inputted by</span>
        <span class="c"># the database&#39;s owner, who could delete or alter the entire database</span>
        <span class="c"># anyway.</span>
        <span class="n">fmtkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">op_fmtstr</span> <span class="o">=</span> <span class="s">&#39;DROP TABLE IF EXISTS {tablename}&#39;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">op_fmtstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtkw</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Delete table&#39;s metadata</span>
        <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_constraint&#39;</span><span class="p">,</span>
            <span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_docstr&#39;</span><span class="p">,</span>
            <span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_superkeys&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">key_list</span><span class="p">,</span> <span class="n">id_colname</span><span class="o">=</span><span class="s">&#39;metadata_key&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.drop_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.drop_column">[docs]</a>    <span class="k">def</span> <span class="nf">drop_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="c"># DATABASE TABLE CACHES ARE UPDATED WITH modify_table</span>
        <span class="n">db</span><span class="o">.</span><span class="n">modify_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">))</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.executeone"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.executeone">[docs]</a>    <span class="k">def</span> <span class="nf">executeone</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(),</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_iter</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">utool</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;operation&#39;</span><span class="p">),</span> <span class="s">&#39;params&#39;</span><span class="p">])</span>
                <span class="c"># utool.sys.exit(1)</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">result_list</span>
</div>
    <span class="nd">@default_decorator</span>
    <span class="c">#@utool.memprof</span>
<div class="viewcode-block" id="SQLDatabaseController.executemany"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.executemany">[docs]</a>    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE_SQL</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c"># --- ARGS PREPROC ---</span>
        <span class="c"># Aggresively compute iterator if the nInput is not given</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_iter</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql!] WARNING: aggressive eval of params_iter because nInput=None&#39;</span><span class="p">)</span>
                <span class="n">params_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
                <span class="n">nInput</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] Taking params_iter as iterator&#39;</span><span class="p">)</span>

        <span class="c"># Do not compute executemany without params</span>
        <span class="k">if</span> <span class="n">nInput</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql!] WARNING: dont use executemany&#39;</span>
                      <span class="s">&#39;with no params use executeone instead.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c"># --- SQL EXECUTION ---</span>
        <span class="n">contextkw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;nInput&#39;</span><span class="p">:</span> <span class="n">nInput</span><span class="p">,</span>
            <span class="s">&#39;start_transaction&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="n">SQLExecutionContext</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">contextkw</span><span class="p">)</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
            <span class="c">#try:</span>
            <span class="k">if</span> <span class="n">eager</span><span class="p">:</span>
                <span class="c">#if utool.DEBUG2:</span>
                <span class="c">#    print(&#39;--------------&#39;)</span>
                <span class="c">#    print(&#39;+++ eager eval&#39;)</span>
                <span class="c">#    print(operation)</span>
                <span class="c">#    print(&#39;+++ eager eval&#39;)</span>
                <span class="c">#results_iter = list(</span>
                    <span class="c">#map(</span>
                    <span class="c">#    list,</span>
                    <span class="c">#    (context.execute_and_generate_results(params) for params in params_iter)</span>
                    <span class="c">#)</span>
                <span class="c">#)  # list of iterators</span>
                <span class="n">results_iter</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                    <span class="n">results_iter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_unpacker</span><span class="p">,</span> <span class="n">results_iter</span><span class="p">))</span>  <span class="c"># list of iterators</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_iter</span><span class="p">)</span>  <span class="c"># Eager evaluation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#if utool.DEBUG2:</span>
                <span class="c">#    print(&#39;--------------&#39;)</span>
                <span class="c">#    print(&#39; +++ lazy eval&#39;)</span>
                <span class="c">#    print(operation)</span>
                <span class="c">#    print(&#39; +++ lazy eval&#39;)</span>
                <span class="k">def</span> <span class="nf">tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                    <span class="c"># Temporary hack to turn off eager_evaluation</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iter</span><span class="p">:</span>
                        <span class="c"># Eval results per query yeild per iter</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">execute_and_generate_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">unpack_scalars</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">_unpacker</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">results</span>
                <span class="n">results_list</span> <span class="o">=</span> <span class="n">tmpgen</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="c">#except Exception as ex:</span>
            <span class="c">#    utool.printex(ex)</span>
            <span class="c">#    raise</span>
        <span class="k">return</span> <span class="n">results_list</span>

    <span class="c">#@default_decorator</span>
    <span class="c">#def commit(db):</span>
    <span class="c">#    db.connection.commit()</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_to_file"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_file</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">file_</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql.dump]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_commit</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c">#db.commit(verbose=False)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">schema_only</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;INSERT&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_to_string"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_to_string">[docs]</a>    <span class="k">def</span> <span class="nf">dump_to_string</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">retStr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">VERBOSE_SQL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql.dump]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_commit</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c">#db.commit(verbose=False)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iterdump</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">schema_only</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;INSERT&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">retStr</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">retStr</span>

    <span class="c">#==============</span>
    <span class="c"># CONVINENCE</span>
    <span class="c">#==============</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">file_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_commit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">file_</span>
            <span class="k">if</span> <span class="n">dump_fpath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s">&#39;.dump.txt&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">auto_commit</span><span class="p">,</span> <span class="n">schema_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">auto_commit</span><span class="p">,</span> <span class="n">schema_only</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_tables_to_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_tables_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">dump_tables_to_csv</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Dumps all csv database files to disk &quot;&quot;&quot;</span>
        <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">dir_</span><span class="p">,</span> <span class="s">&#39;CSV_DUMP&#39;</span><span class="p">)</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="n">table_fname</span> <span class="o">=</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;.csv&#39;</span>
            <span class="n">table_csv</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dump_dir</span><span class="p">,</span> <span class="n">table_fname</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_csv</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_schema_current_autogeneration_str"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_schema_current_autogeneration_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_current_autogeneration_str</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Autogenerates the most up-to-date database schema</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = ibs.db.get_schema_current_autogeneration_str()</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_version_current</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_db_version</span><span class="p">()</span>

        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># File Header</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;# AUTOGENERATED ON &#39;</span> <span class="o">+</span> <span class="n">utool</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="s">&#39;printable&#39;</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;from __future__ import absolute_import, division, print_function&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;from ibeis import constants as const&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;# Schema Version Current&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;# =======================&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;VERSION_CURRENT = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_version_current</span><span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;def update_current(db, ibs=None):&#39;</span><span class="p">)</span>
        <span class="c"># Define what tab space we want to save</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="c"># Function content</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="c"># Hack to find the name of the constant variable</span>
            <span class="n">constant_name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">tablename</span><span class="p">:</span>
                    <span class="n">constant_name</span> <span class="o">=</span> <span class="n">variable</span>
                    <span class="k">break</span>
            <span class="c"># assert constant_name is not None, &quot;Table name does not exists in constants&quot;</span>
            <span class="k">if</span> <span class="n">constant_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">db.add_table(const.</span><span class="si">%s</span><span class="s">, (&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">constant_name</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">db.add_table(</span><span class="si">%r</span><span class="s">, (&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
                <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># Check if PRIMARY KEY</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s">&quot; PRIMARY KEY&quot;</span>
                <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># Check if NOT NULL</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s">&quot; NOT NULL&quot;</span>
                <span class="k">elif</span> <span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">col_type</span> <span class="o">+=</span> <span class="s">&quot; DEFAULT &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  <span class="c"># Specify default value</span>
                <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">(</span><span class="si">%s%r</span><span class="s">),&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">tab</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">),&#39;</span> <span class="o">%</span> <span class="n">tab</span><span class="p">)</span>
            <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_superkeys</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">superkey_colnames=</span><span class="si">%r</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">tab</span><span class="p">,</span> <span class="n">superkey_colnames_list</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">docstr=</span><span class="se">\&#39;\&#39;\&#39;</span><span class="si">%s</span><span class="se">\&#39;\&#39;\&#39;</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">tab</span><span class="p">,</span> <span class="n">docstr</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_schema_current_autogeneration"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_schema_current_autogeneration">[docs]</a>    <span class="k">def</span> <span class="nf">dump_schema_current_autogeneration</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience: Autogenerates the most up-to-date database schema &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sqldb] dumping current schema to output_filename=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_filename</span><span class="p">,))</span>
        <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
        <span class="n">schema_current_str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_schema_current_autogeneration_str</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">schema_current_str</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.dump_schema"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.dump_schema">[docs]</a>    <span class="k">def</span> <span class="nf">dump_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience: Dumps all csv database files to disk</span>
<span class="sd">            NOTE: This function is semi-obsolete because of the auto-generated</span>
<span class="sd">            current schema file.  Use dump_schema_current_autogeneration instead for</span>
<span class="sd">            all purposes except for parsing out the database schema or for consice visual</span>
<span class="sd">            representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">app_resource_dir</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span><span class="s">&#39;ibeis&#39;</span><span class="p">)</span>
        <span class="n">dump_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">,</span> <span class="s">&#39;schema.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dump_fpath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()):</span>
                <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">:</span>
                    <span class="n">col_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">col_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_null</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="s">&#39;ALLOW NULL&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&#39;NOT NULL&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">col_default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">col_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="s">&#39;KEY&#39;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">col_type</span><span class="p">,</span> <span class="n">col_null</span><span class="p">,</span> <span class="n">col_default</span><span class="p">,</span> <span class="n">col_key</span><span class="p">)</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="si">%s%s%s%s%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">utool</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">app_resource_dir</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_names"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span>
        <span class="n">tablename_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tablename_list</span> <span class="p">]</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_constraints"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_constraints</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39;metadata_key=?&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_constraint&#39;</span><span class="p">,)]</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">constraint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_superkeys"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_superkeys">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_superkeys</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_table_superkeys</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str):</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: superkey_colnames_list</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m ibeis.control.SQLDatabaseControl --test-get_table_superkeys</span>

<span class="sd">        Example0:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; import ibeis</span>
<span class="sd">            &gt;&gt;&gt; ibs = ibeis.opendb(&#39;testdb1&#39;)</span>
<span class="sd">            &gt;&gt;&gt; result = ibs.db.get_table_superkeys(&#39;lblimage&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            [(&#39;lbltype_rowid&#39;, &#39;lblimage_value&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">(),</span> <span class="s">&#39;tablename=</span><span class="si">%r</span><span class="s"> is not a part of this database&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39;metadata_key=?&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_superkeys&#39;</span><span class="p">,)]</span>
        <span class="n">superkey_colnames_list_repr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># These asserts might not be valid, but in that case this function needs</span>
        <span class="c"># to be rewritten under a different name</span>
        <span class="c">#assert len(superkey_colnames_list) == 1, &#39;INVALID DEVELOPER ASSUMPTION IN SQLCONTROLLER. MORE THAN 1 SUPERKEY&#39;</span>
        <span class="k">if</span> <span class="n">superkey_colnames_list_repr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Sometimes the metadata gets moved for some reason</span>
            <span class="c"># Hack the information out of the constraints</span>
            <span class="n">constraint_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;INVALID DEVELOPER ASSUMPTION IN SQLCONTROLLER. MORE THAN 1 CONSTRAINT&#39;</span>
            <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">constraint_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">parse</span>
                <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraint_list</span><span class="p">:</span>
                    <span class="n">parse_result</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&#39;CONSTRAINT superkey UNIQUE ({colnames})&#39;</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parse_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">superkey_colnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">parse_result</span><span class="p">[</span><span class="s">&#39;colnames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
                        <span class="n">superkey_colnames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">superkey_colnames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#superkey_colnames = superkey_colnames_str.split(&#39;;&#39;)</span>
            <span class="c">#with ut.EmbedOnException():</span>
            <span class="k">if</span> <span class="n">superkey_colnames_list_repr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># hack for old metadata superkey_val format</span>
                <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">superkey_colnames_list_repr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># new evalable format</span>
                <span class="n">superkey_colnames_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">superkey_colnames_list_repr</span><span class="p">)</span>
        <span class="c">#superkey_colnames_list = [</span>
        <span class="c">#    None if superkey_colname is None else str(superkey_colname)</span>
        <span class="c">#    for superkey_colname in superkey_colnames</span>
        <span class="c">#]</span>
        <span class="c">#superkey_colnames_list = list(map(tuple, superkey_colnames_list))</span>
        <span class="k">return</span> <span class="n">superkey_colnames_list</span>
</div>
    <span class="n">get_table_superkey_colnames</span> <span class="o">=</span> <span class="n">get_table_superkeys</span>

    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_primarykey_colnames"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_primarykey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_primarykey_colnames</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">primarykey_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span>
                               <span class="k">for</span> <span class="p">(</span><span class="n">column_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">dflt_value</span><span class="p">,</span> <span class="n">pk</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">columns</span>
                               <span class="k">if</span> <span class="n">pk</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">primarykey_colnames</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_otherkey_colnames"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_otherkey_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_otherkey_colnames</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">flat_superkey_colnames_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_superkeys</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
        <span class="c">#superkey_colnames_list = set((lambda x: x if x is not None else [])(db.get_table_superkeys(tablename)))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">otherkey_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span>
                             <span class="k">for</span> <span class="p">(</span><span class="n">column_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">dflt_value</span><span class="p">,</span> <span class="n">pk</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">columns</span>
                             <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pk</span> <span class="ow">and</span>   <span class="c"># not primary key</span>
                                 <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flat_superkey_colnames_list</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">otherkey_colnames</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_docstr"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_docstr">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_docstr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39;metadata_key=?&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tablename</span> <span class="o">+</span> <span class="s">&#39;_docstr&#39;</span><span class="p">,)]</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">docstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_columns"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_columns">[docs]</a>    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_columns</span>

<span class="sd">        Args:</span>
<span class="sd">            tablename (str): table name</span>

<span class="sd">        Returns:</span>
<span class="sd">            column_list : list of tuples with format:</span>
<span class="sd">                (</span>
<span class="sd">                    column_id  : id of the column</span>
<span class="sd">                    name       : the name of the column</span>
<span class="sd">                    type_      : the type of the column</span>
<span class="sd">                    notnull    : 0 or 1 if the column can contains null values</span>
<span class="sd">                    dflt_value : the default value</span>
<span class="sd">                    pk         : 0 or 1 if the column partecipate to the primary key</span>
<span class="sd">                )</span>

<span class="sd">        References:</span>
<span class="sd">            http://stackoverflow.com/questions/17717829/how-to-get-column-names-from-a-table-in-sqlite-via-pragma-net-c</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from ibeis.control.SQLDatabaseControl import *  # NOQA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;PRAGMA TABLE_INFO(&#39;&quot;</span> <span class="o">+</span> <span class="n">tablename</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">column_list</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column_names"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Returns the sql tablename columns &quot;&quot;&quot;</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">column_names</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column_types"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column_types">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_types</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Returns the sql tablename columns &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_format</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s">&quot; PRIMARY KEY&quot;</span>
            <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s">&quot; NOT NULL&quot;</span>
            <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span> <span class="o">+</span> <span class="s">&quot; DEFAULT &quot;</span> <span class="o">+</span> <span class="n">default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">type_</span>

        <span class="n">column_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_types</span>   <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_null</span>    <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_default</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_key</span>     <span class="o">=</span> <span class="p">[</span> <span class="n">column</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">column_list</span><span class="p">]</span>
        <span class="n">column_types_</span>  <span class="o">=</span> <span class="p">[</span>
            <span class="n">_format</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">key</span>
            <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">column_types</span><span class="p">,</span> <span class="n">column_null</span><span class="p">,</span> <span class="n">column_default</span><span class="p">,</span> <span class="n">column_key</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">column_types_</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_column"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_column">[docs]</a>    <span class="k">def</span> <span class="nf">get_column</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: &quot;&quot;&quot;</span>
        <span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">_column</span><span class="p">,)</span> <span class="o">=</span> <span class="n">sanatize_sql</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">column_vals</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">executeone</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">            SELECT </span><span class="si">%s</span><span class="s"></span>
<span class="s">            FROM </span><span class="si">%s</span><span class="s"></span>
<span class="s">            ORDER BY rowid ASC</span>
<span class="s">            &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_column</span><span class="p">,</span> <span class="n">_table</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">column_vals</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience: Converts a tablename to csv format &quot;&quot;&quot;</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">column_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">column_lbls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">exclude_columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">column_vals</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">column_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_vals</span><span class="p">)</span>
            <span class="n">column_lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tablename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="c"># remove column prefix for more compact csvs</span>

        <span class="c">#=None, column_list=[], header=&#39;&#39;, column_type=None</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">csv_table</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">make_csv_table</span><span class="p">(</span><span class="n">column_list</span><span class="p">,</span> <span class="n">column_lbls</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">csv_table</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.print_table_csv"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.print_table_csv">[docs]</a>    <span class="k">def</span> <span class="nf">print_table_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">))</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_table_csv_header"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_table_csv_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_csv_header</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">tablename</span><span class="p">):</span>
        <span class="n">column_nametypes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="n">db</span><span class="o">.</span><span class="n">get_column_types</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
        <span class="n">header_constraints</span> <span class="o">=</span> <span class="s">&#39;# CONSTRAINTS: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_constraints</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
        <span class="n">header_name</span>  <span class="o">=</span> <span class="s">&#39;# TABLENAME: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tablename</span>
        <span class="n">header_types</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">column_nametypes</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"># &#39;</span><span class="p">)</span>
        <span class="n">header_doc</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">utool</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_docstr</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">),</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"># &#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">header_doc</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">header_name</span> <span class="o">+</span> <span class="n">header_types</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">header_constraints</span>
        <span class="k">return</span> <span class="n">header</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.print_schema"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.print_schema">[docs]</a>    <span class="k">def</span> <span class="nf">print_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">get_table_csv_header</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.view_db_in_external_reader"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.view_db_in_external_reader">[docs]</a>    <span class="k">def</span> <span class="nf">view_db_in_external_reader</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">known_readers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sqlitebrowser&#39;</span><span class="p">,</span> <span class="s">&#39;sqliteman&#39;</span><span class="p">]</span>
        <span class="n">sqlite3_reader</span> <span class="o">=</span> <span class="n">known_readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sqlite3_db_fpath</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">sqlite3_reader</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">sqlite3_db_fpath</span><span class="p">)</span>
        <span class="c">#ut.cmd(sqlite3_reader, sqlite3_db_fpath)</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SQLDatabaseController.set_db_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.set_db_version">[docs]</a>    <span class="k">def</span> <span class="nf">set_db_version</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="c"># Do things properly, get the metadata_rowid (best because we want to assert anyway)</span>
        <span class="n">metadata_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;database_version&#39;</span><span class="p">]</span>
        <span class="n">params_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_key</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_key</span> <span class="ow">in</span> <span class="n">metadata_key_list</span><span class="p">)</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39;metadata_key=?&#39;</span>
        <span class="c"># list of relationships for each image</span>
        <span class="n">metadata_rowid_list</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_where</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;metadata_rowid&#39;</span><span class="p">,),</span> <span class="n">params_iter</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">unpack_scalars</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_rowid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;duplicate database_version keys in database&#39;</span>
        <span class="n">id_iter</span> <span class="o">=</span> <span class="p">((</span><span class="n">metadata_rowid</span><span class="p">,)</span> <span class="k">for</span> <span class="n">metadata_rowid</span> <span class="ow">in</span> <span class="n">metadata_rowid_list</span><span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">((</span><span class="n">_</span><span class="p">,)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">version</span><span class="p">])</span>
        <span class="n">db</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">METADATA_TABLE</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;metadata_value&#39;</span><span class="p">,),</span> <span class="n">val_list</span><span class="p">,</span> <span class="n">id_iter</span><span class="p">)</span>
</div>
    <span class="nd">@default_decorator</span>
<div class="viewcode-block" id="SQLDatabaseController.get_sql_version"><a class="viewcode-back" href="../../../ibeis.control.html#ibeis.control.SQLDatabaseControl.SQLDatabaseController.get_sql_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_version</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Conveinience &quot;&quot;&quot;</span>
        <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT sqlite_version()&#39;</span><span class="p">)</span>
        <span class="n">sql_version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] SELECT sqlite_version = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql_version</span><span class="p">,))</span>
        <span class="c"># The version number sqlite3 module. NOT the version of SQLite library.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] sqlite3.version = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">version</span><span class="p">,))</span>
        <span class="c"># The version of the SQLite library</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[sql] sqlite3.sqlite_version = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lite</span><span class="o">.</span><span class="n">sqlite_version</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">sql_version</span>


<span class="c"># LONG DOCSTRS</span>
<span class="c">#SQLDatabaseController.add_cleanly.__docstr__ = &quot;&quot;&quot;</span>
<span class="c">#uuid_list - a non-rowid column which identifies a row</span>
<span class="c">#get_rowid_from_superkey - function which does what it says</span>
<span class="c">#e.g:</span>
<span class="c">#    get_rowid_from_superkey = ibs.get_image_gids_from_uuid</span>
<span class="c">#    params_list = [(uuid.uuid4(),) for _ in range(7)]</span>
<span class="c">#    superkey_paramx = [0]</span>

<span class="c">#            params_list = [(uuid.uuid4(), 42) for _ in range(7)]</span>
<span class="c">#            superkey_paramx = [0, 1]</span>
<span class="c">#&quot;&quot;&quot;</span>

<span class="c">#SQLDatabaseController.__init__.__docstr__ = &quot;&quot;&quot;</span>
<span class="c">#            SQLite3 Documentation: http://www.sqlite.org/docs.html</span>
<span class="c">#            -------------------------------------------------------</span>
<span class="c">#            SQL INSERT: http://www.w3schools.com/sql/sql_insert.asp</span>
<span class="c">#            SQL UPDATE: http://www.w3schools.com/sql/sql_update.asp</span>
<span class="c">#            SQL DELETE: http://www.w3schools.com/sql/sql_delete.asp</span>
<span class="c">#            SQL SELECT: http://www.w3schools.com/sql/sql_select.asp</span>
<span class="c">#            -------------------------------------------------------</span>
<span class="c">#            Init the SQLite3 database connection and the execution object.</span>
<span class="c">#            If the database does not exist, it will be automatically created</span>
<span class="c">#            upon this object&#39;s instantiation.</span>
<span class="c">#            &quot;&quot;&quot;</span>
<span class="c">#&quot;&quot;&quot; Same output as shell command below</span>
<span class="c">#    &gt; sqlite3 database.sqlite3 .dump &gt; database.dump.txt</span>

<span class="c">#    If file_=sys.stdout dumps to standard out</span>

<span class="c">#    This saves the current database schema structure and data into a</span>
<span class="c">#    text dump. The entire database can be recovered from this dump</span>
<span class="c">#    file. The default will store a dump parallel to the current</span>
<span class="c">#    database file.</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#&quot;&quot;&quot; Commits staged changes to the database and saves the binary</span>
<span class="c">#    representation of the database to disk.  All staged changes can be</span>
<span class="c">#    commited one at a time or after a batch - which allows for batch</span>
<span class="c">#    error handling without comprimising the integrity of the database.</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#TODO: SEPARATE</span>
<span class="c">#Input:</span>
<span class="c">#    operation - an sql command to be executed e.g.</span>
<span class="c">#        operation = &#39;&#39;&#39;</span>
<span class="c">#        SELECT colname</span>
<span class="c">#        FROM tblname</span>
<span class="c">#        WHERE</span>
<span class="c">#        (colname_1=?, ..., colname_N=?)</span>
<span class="c">#        &#39;&#39;&#39;</span>
<span class="c">#    params_iter - a sequence of params e.g.</span>
<span class="c">#        params_iter = [(col1, ..., colN), ..., (col1, ..., colN),]</span>
<span class="c">#Output:</span>
<span class="c">#    results_iter - a sequence of data results</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#operation - parameterized SQL operation string.</span>
<span class="c">#    Parameterized prevents SQL injection attacks by using an ordered</span>
<span class="c">#    representation ( ? ) or by using an ordered, text representation</span>
<span class="c">#    name ( :value )</span>

<span class="c">#params - list of values or a dictionary of representations and</span>
<span class="c">#                corresponding values</span>
<span class="c">#    * Ordered Representation -</span>
<span class="c">#        List of values in the order the question marks appear in the</span>
<span class="c">#        sql operation string</span>
<span class="c">#    * Unordered Representation -</span>
<span class="c">#        Dictionary of (text representation name -&gt; value) in an</span>
<span class="c">#        arbirtary order that will be filled into the cooresponging</span>
<span class="c">#        slots of the sql operation string</span>
<span class="c">#&quot;&quot;&quot;</span>
<span class="c">#&quot;&quot;&quot; Creates a table in the database with some schema and constraints</span>
<span class="c">#    schema_list - list of tablename columns tuples</span>
<span class="c">#        {</span>
<span class="c">#            (column_1_name, column_1_type),</span>
<span class="c">#            (column_2_name, column_2_type),</span>
<span class="c">#            ...</span>
<span class="c">#            (column_N_name, column_N_type),</span>
<span class="c">#        }</span>
<span class="c">#    ---------------------------------------------</span>
<span class="c">#    column_n_name - string name of column heading</span>
<span class="c">#    column_n_type - NULL | INTEGER | REAL | TEXT | BLOB | NUMPY</span>
<span class="c">#        The column type can be appended with &#39; PRIMARY KEY&#39; to indicate</span>
<span class="c">#        the unique id for the tablename.  It can also specify a default</span>
<span class="c">#        value for the column with &#39; DEFAULT [VALUE]&#39;.  It can also</span>
<span class="c">#        specify &#39; NOT NULL&#39; to indicate the column cannot be empty.</span>
<span class="c">#    ---------------------------------------------</span>
<span class="c">#    The tablename will only be created if it does not exist.  Therefore,</span>
<span class="c">#    this can be done on every tablename without fear of deleting old data.</span>
<span class="c">#    ---------------------------------------------</span>
<span class="c">#    TODO: Add handling for column addition between software versions.</span>
<span class="c">#    Column deletions will not be removed from the database schema.</span>
<span class="c">#&quot;&quot;&quot;</span>
</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl --allexamples</span>
<span class="sd">        python -m ibeis.control.SQLDatabaseControl --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">ibeis 0.1.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../ibeis.html" >ibeis</a> &raquo;</li>
          <li><a href="../control.html" >ibeis.control</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>